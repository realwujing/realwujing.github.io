# grtrace 开发迭代计划（Roadmap）

配套架构文档： [GPU Ring Buffer追踪架构深度分析：从blktrace到grtrace的设计演进](./GPU%20Ring%20Buffer追踪架构深度分析：从blktrace到grtrace的设计演进.md)

语义化版本约定：

- v0.x 为快速迭代期（可能发生不兼容变更）
- v1.0 起承诺基本事件语义与文件格式的稳定性

## 里程碑总览

- v0.1 MVP：内核最小可用路径（relay 通道 + 基础事件 + 单供应商单 ring）
- v0.2 多 ring/引擎支持＋单机时钟一致性（ktime、seq）
- v0.3 事件模型稳定化（提交/完成/ctx 切换/fence 等）
- v0.4 用户态工具链（grtrace、最小分析脚本）
- v0.5 性能与开销治理（背压、采样、开关策略、热路径审计）
- v0.6 持久化格式 v1（紧凑二进制 + 元数据）
- v0.7 供应商适配（amdgpu、i915、nouveau 首批覆盖）
- v0.8 与 ftrace/perf/eBPF 联动（时间轴对齐、跨域关联）
- v0.9 稳定化（kselftest、自测基准、文档与示例）
- v1.0 基线发布（接口/格式稳定、兼容性承诺）

---

## v0.1 MVP（最小可用）

目标：跑通从驱动 hook → 内核 relay → debugfs 消费 → 简单用户态读取的闭环。

- 内核
  - [ ] 基础事件类型：提交 submit、完成 complete（fence signal）、上下文切换 ctx_switch
  - [ ] relay 通道与 per-CPU 序列号（最简实现可先单通道）
  - [ ] debugfs 控制与数据出口：/sys/kernel/debug/grtrace/
  - [ ] 单供应商单 ring 打通（推荐 i915 或 amdgpu 二选一）
- 用户态
  - [ ] 原型读出工具（最简：cat/用户态 reader 示例）
  - [ ] 最小解析脚本（事件序列 + 时间戳）
- 文档/CI
  - [ ] 启动/停止/读取使用说明（README 片段）
  - [ ] 简单 smoke test（插入 N 次提交，观察 N 次完成）
- 验收
  - [ ] Demo 展示单 ring 的提交→完成闭环，数据可读可视

## v0.2 多 ring/引擎 + 时钟一致性

- 内核
  - [ ] 多 ring/引擎（graphics/compute/copy）识别与标注
  - [ ] 全局单调时间戳与跨 CPU 一致性（ktime_get_* + per-CPU seq 方案）
  - [ ] 事件丢弃与水位（丢包计数、背压策略雏形）
- 用户态
  - [ ] ring/engine 维度的视图与过滤
- 验收
  - [ ] 同一 GPU 多 ring 同时追踪，时间顺序一致

## v0.3 事件模型稳定化

- 内核
  - [ ] 事件语义与字段冻结（submit/complete/ctx_switch/fence/bo-map 可选）
  - [ ] 版本协商（MAGIC、VERSION、feature bits）
  - [ ] 错误路径与异常事件（reset/timeout）
- 用户态
  - [ ] 版本/特性探测与兼容回退
- 验收
  - [ ] 事件 schema 审核通过，提交兼容性基线

## v0.4 工具链（grtrace）

- 用户态
  - [ ] grtrace：start/stop/status/config（debugfs/ioctl）
  - [ ] 最小可视化示例（时间线/直方图/Top-N）
- 文档
  - [ ] 快速开始、CLI 帮助、典型场景手册
- 验收
  - [ ] 一条命令完成采集，另一条生成分析素材

## v0.5 性能与开销治理

- 内核
  - [ ] 热路径剖析与优化（分支预测、缓存友好、最小化锁/原子）
  - [ ] 开关/采样/级别策略（off/normal/verbose，采样 N）
  - [ ] 大量事件压力下的退化与保护（丢弃率、背压阈值）
- 用户态
  - [ ] 采集开销报告（事件率、丢弃、平均写入时长）
- 验收
  - [ ] 在高事件率下内核无明显退化，丢弃率可控

## v0.6 持久化格式 v1

- 设计
  - [ ] 紧凑二进制格式（定长头 + 变长 payload）
  - [ ] 元数据区（GPU/driver/ring 描述、时钟源、版本、特性）
- 验收
  - [ ] v1 格式固化并出示参考解析器

## v0.7 供应商适配

- 内核
  - [ ] amdgpu：gfx/comp/copy ring hooks
  - [ ] i915：execlists/GuC 路径 hooks
  - [ ] nouveau：pushbuf 提交流程 hooks（可择期）
- 验收
  - [ ] 至少两家驱动稳定产出可解析数据

## v0.8 与系统追踪联动

- 集成
  - [ ] ftrace/perf 时间对齐与关联字段（pid/tid/ctx/engine）
  - [ ] eBPF 辅助场景（进程标注、跨域事件拼接）
- 验收
  - [ ] 能将 GPU 事件与 CPU 调度/IO 事件在同一时间轴展示

## v0.9 稳定化

- 测试
  - [ ] kselftest/内核自测用例（功能/压力/回归）
  - [ ] CI：格式校验、静态检查、风格检查
- 文档
  - [ ] 贡献指南、维护策略、FAQ、故障排查
- 验收
  - [ ] 覆盖主路径的自动化测试稳定通过

## v1.0 基线发布

- 承诺
  - [ ] 事件语义与 v1 格式稳定
  - [ ] 同 minor 版本向后兼容
- 发布物
  - [ ] 内核补丁集、用户态工具、示例与文档

---

## 按职能拆分的任务清单

- 内核（core）
  - [ ] 事件定义与 fast path
  - [ ] relay/debugfs/RCU/锁策略
  - [ ] 多 ring/engine 标注与枚举
  - [ ] 版本与特性协商
- 驱动适配（vendors）
  - [ ] amdgpu hooks
  - [ ] i915 hooks
  - [ ] nouveau hooks（可选）
- 用户态工具
  - [ ] grtrace（控制面）
  - [ ] 可视化样例（脚本/Notebook）
- 测试/CI
  - [ ] kselftest 用例
  - [ ] 压测脚本与基准
  - [ ] 风格/静态检查
- 文档
  - [ ] 架构、接口、格式说明
  - [ ] 快速开始与故障排查

## 时间线建议（示例）

- Sprint 1-2（v0.1）：MVP 闭环（单供应商单 ring）
- Sprint 3-4（v0.2-0.3）：多 ring/时钟一致性 + 事件模型冻结
- Sprint 5-6（v0.4-0.5）：工具链 + 开销治理
- Sprint 7（v0.6）：格式 v1 固化
- Sprint 8-9（v0.7-0.8）：供应商适配 + 系统联动
- Sprint 10（v0.9）：稳定化
- Sprint 11（v1.0）：发布

## 开发周期预估

- 假设
  - 两周一 Sprint；团队 2–3 人（内核/驱动/用户态），70–80% 投入
- 总体
  - 11 个 Sprint ≈ 22 周 ≈ 5.5 个月；含 20% 缓冲 ≈ 6–6.5 个月
- 里程碑分配（与上节时间线一致）
  - v0.1：2 Sprint（4 周）
  - v0.2–0.3：2 Sprint（4 周）
  - v0.4–0.5：2 Sprint（4 周）
  - v0.6：1 Sprint（2 周）
  - v0.7–0.8：2 Sprint（4 周）
  - v0.9：1 Sprint（2 周）
  - v1.0：1 Sprint（2 周）
- 其他节奏（参考）
  - 1 周一 Sprint：≈ 11 周；含 20% 缓冲 ≈ 3 个月
  - 3 周一 Sprint：≈ 33 周；含 20% 缓冲 ≈ 7.5–8 个月
  - 单人全栈（两周节奏）：在基线基础上 +60–80% → ≈ 9–10 个月
- 风险缓冲建议
  - 供应商适配、性能开销治理、系统联动不确定性较高；建议预留 2–3 个 Sprint 风险缓冲，并从 Sprint 4 起并行推进适配以降低尾部风险

## 依赖与前置

- 内核最低版本与配置：relay、debugfs、RCU、ktime
- 目标驱动版本（amdgpu/i915/nouveau）与开启的调试选项
- 构建与 CI 环境：编译器版本、静态检查工具、kselftest 框架

## 风险与缓解

- 热路径开销过高 → 采样/级别控制、批量写入、预分配、缓存友好
- 不同驱动差异大 → 事件语义抽象、分层适配、先覆盖主路径
- 时间戳/序列一致性问题 → 明确源、统一转换、一致性校验
- 数据量与磁盘压力 → 可调环形缓冲、滚动文件、阈值报警

---

更新策略：每个里程碑结束后补充“变更记录/经验教训/后续计划”，并滚动维护本路线图。
