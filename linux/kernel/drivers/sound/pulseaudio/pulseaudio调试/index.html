

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="HTML, JavaScript, Hexo, Linux, qemu, C++, namespace, git, bcc, bpf, initramfs, k8s, architect, strings, assembly, linux">
  
    <meta name="description" content="pulseaudio调试 源码下载 1git clone https:&#x2F;&#x2F;github.com&#x2F;realwujing&#x2F;pulseaudio-12.2.58.git 安装依赖 12sudo apt build-dep .sudo apt install dh-make 编译调试包 关闭编译优化 12cd pulseaudio-12.2.58vim debian&#x2F;rules 12DEB_CFLAGS_">
<meta property="og:type" content="article">
<meta property="og:title" content="pulseaudio调试">
<meta property="og:url" content="https://realwujing.github.io/linux/kernel/drivers/sound/pulseaudio/pulseaudio%E8%B0%83%E8%AF%95/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="pulseaudio调试 源码下载 1git clone https:&#x2F;&#x2F;github.com&#x2F;realwujing&#x2F;pulseaudio-12.2.58.git 安装依赖 12sudo apt build-dep .sudo apt install dh-make 编译调试包 关闭编译优化 12cd pulseaudio-12.2.58vim debian&#x2F;rules 12DEB_CFLAGS_">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-12-05T14:50:57.000Z">
<meta property="article:modified_time" content="2023-12-05T14:50:57.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="git">
<meta property="article:tag" content="strings">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>pulseaudio调试 - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="pulseaudio调试"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-05 14:50" pubdate>
          2023年12月5日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          160k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1333 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">pulseaudio调试</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="pulseaudio调试">pulseaudio调试</h1>
<h2 id="源码下载">源码下载</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/realwujing/pulseaudio-12.2.58.git<br></code></pre></td></tr></table></figure>
<h2 id="安装依赖">安装依赖</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt build-dep .<br>sudo apt install dh-make<br></code></pre></td></tr></table></figure>
<h2 id="编译调试包">编译调试包</h2>
<h3 id="关闭编译优化">关闭编译优化</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> pulseaudio-12.2.58<br>vim debian/rules<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">DEB_CFLAGS_MAINT_APPEND = -fstack-protector-strong -D_FORTITY_SOURCE=1 \<br>-z noexecstack -pie -fPIC -z lazy -g -O0<br></code></pre></td></tr></table></figure>
<h3 id="编译">编译</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/bash</span><br><br><span class="hljs-built_in">set</span> -x<br><br>dh_clean    <span class="hljs-comment"># 调用makefile中的clean命令</span><br><span class="hljs-built_in">rm</span> ../*.deb ../*.buildinfo ../*.changes ../*.dsc ../*.xz -rf    <span class="hljs-comment"># 删除 dpkg-source -b . dh_make --createorig -sy 命令生成的源码压缩包</span><br>dh_make --createorig -sy    <span class="hljs-comment"># 生成debian目录</span><br>dpkg-source -b .    <span class="hljs-comment"># 生成构建源代码包</span><br>dpkg-buildpackage -uc -us -j16   <span class="hljs-comment"># 编译制作deb包</span><br></code></pre></td></tr></table></figure>
<h3 id="安装调试包">安装调试包</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt install --reinstall ../*.deb<br></code></pre></td></tr></table></figure>
<h2 id="开始调试">开始调试</h2>
<p>停止已有的pulseaudio进程:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl --user stop pulseaudio.socket<br>systemctl --user stop pulseaudio<br></code></pre></td></tr></table></figure>
<p>查看pulseaudio参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pulseaudio --<span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">--log-level[=LEVEL]               Increase or set verbosity level<br>--log-meta[=BOOL]                 Include code location in log messages<br>--log-time[=BOOL]                 Include timestamps in log messages<br>--log-backtrace=FRAMES            Include a backtrace in log messages<br></code></pre></td></tr></table></figure>
<p>gdb pusleaudio:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">gdb /usr/bin/pusleaudio<br><span class="hljs-built_in">set</span> args --log-level=4 --log-meta=1 --log-time=1 --log-backtrace=FRAMES<br></code></pre></td></tr></table></figure>
<p>也可以不关闭已有pulseaudio进程:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ps aux | grep pulseaudio<br>gdb -p 12567<br>file /usr/bin/pulseaudio<br></code></pre></td></tr></table></figure>
<h2 id="main">main</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  main (argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>) at daemon/main.c:<span class="hljs-number">371</span><br></code></pre></td></tr></table></figure>
<h2 id="pa_daemon_conf_load">pa_daemon_conf_load</h2>
<p>/etc/pulse/daemon.conf加载流程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_daemon_conf_load (c=<span class="hljs-number">0xaaaaaaad5500</span>, filename=<span class="hljs-number">0x0</span>) at daemon/daemon-conf.c:<span class="hljs-number">603</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000aaaaaaab7204</span> in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:483<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pa_daemon_conf_load</span><span class="hljs-params">(pa_daemon_conf *c, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename)</span> &#123;<br>    <span class="hljs-type">int</span> r = <span class="hljs-number">-1</span>;<br>    FILE *f = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">channel_conf_info</span> <span class="hljs-title">ci</span>;</span><br>    pa_config_item table[] = &#123;<br>        <span class="hljs-comment">// 配置项名称，解析函数，存储值的指针，额外数据指针</span><br>        &#123; <span class="hljs-string">&quot;daemonize&quot;</span>,                  pa_config_parse_bool,     &amp;c-&gt;daemonize, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 后台运行</span><br>        &#123; <span class="hljs-string">&quot;fail&quot;</span>,                       pa_config_parse_bool,     &amp;c-&gt;fail, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 启动失败</span><br>        &#123; <span class="hljs-string">&quot;high-priority&quot;</span>,              pa_config_parse_bool,     &amp;c-&gt;high_priority, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 高优先级</span><br>        <span class="hljs-comment">// ... 其他配置项 ...</span><br>        &#123; <span class="hljs-literal">NULL</span>,                         <span class="hljs-literal">NULL</span>,                     <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 配置项数组结束标记</span><br>    &#125;;<br><br>    pa_xfree(c-&gt;config_file);<br>    c-&gt;config_file = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// 打开配置文件，根据提供的文件名或使用默认的文件名</span><br>    f = filename ?<br>        pa_fopen_cloexec(c-&gt;config_file = pa_xstrdup(filename), <span class="hljs-string">&quot;r&quot;</span>) :<br>        pa_open_config_file(DEFAULT_CONFIG_FILE, DEFAULT_CONFIG_FILE_USER, ENV_CONFIG_FILE, &amp;c-&gt;config_file);<br><br>    <span class="hljs-keyword">if</span> (!f &amp;&amp; errno != ENOENT) &#123;<br>        pa_log_warn(_(<span class="hljs-string">&quot;Failed to open configuration file: %s&quot;</span>), pa_cstrerror(errno));<br>        <span class="hljs-keyword">goto</span> finish;<br>    &#125;<br><br>    ci.default_channel_map_set = ci.default_sample_spec_set = <span class="hljs-literal">false</span>;<br>    ci.conf = c;<br><br>    <span class="hljs-comment">// 解析配置文件并应用配置项</span><br>    r = f ? pa_config_parse(c-&gt;config_file, f, table, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>) : <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (r &gt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 确保通道映射和采样规格匹配</span><br><br>        <span class="hljs-keyword">if</span> (ci.default_sample_spec_set &amp;&amp;<br>            ci.default_channel_map_set &amp;&amp;<br>            c-&gt;default_channel_map.channels != c-&gt;default_sample_spec.channels) &#123;<br>            pa_log_error(_(<span class="hljs-string">&quot;The specified default channel map has a different number of channels than the specified default number of channels.&quot;</span>));<br>            r = <span class="hljs-number">-1</span>;<br>            <span class="hljs-keyword">goto</span> finish;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ci.default_sample_spec_set)<br>            pa_channel_map_init_extend(&amp;c-&gt;default_channel_map, c-&gt;default_sample_spec.channels, PA_CHANNEL_MAP_DEFAULT);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ci.default_channel_map_set)<br>            c-&gt;default_sample_spec.channels = c-&gt;default_channel_map.channels;<br>    &#125;<br><br>finish:<br>    <span class="hljs-keyword">if</span> (f)<br>        fclose(f);<br><br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="pa_open_config_file">pa_open_config_file</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_open_config_file (global=<span class="hljs-number">0xaaaaaaabd520</span> <span class="hljs-string">&quot;/etc/pulse/daemon.conf&quot;</span>, local=<span class="hljs-number">0xaaaaaaabd510</span> <span class="hljs-string">&quot;/daemon.conf&quot;</span>, env=<span class="hljs-number">0xaaaaaaabd500</span> <span class="hljs-string">&quot;PULSE_CONFIG&quot;</span>, result=<span class="hljs-number">0xaaaaaaad5560</span>)<br>    at pulsecore/core-util.c:<span class="hljs-number">2021</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000aaaaaaab43d4</span> in <span class="hljs-title function_">pa_daemon_conf_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaad5500</span>, filename=<span class="hljs-number">0x0</span>)</span> at daemon/daemon-conf.c:710<br>#2  0x0000aaaaaaab7204 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:483<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 尝试打开配置文件。如果指定了 &quot;env&quot;，则打开指定环境变量的值。</span><br><span class="hljs-comment"> * 否则在家目录中查找文件 &quot;local&quot;，或者在全局文件系统中查找文件 &quot;global&quot;。</span><br><span class="hljs-comment"> * 如果 &quot;result&quot; 非空，则将指向新分配的包含所使用配置文件路径的缓冲区的指针存储在那里。 */</span><br>FILE *<span class="hljs-title function_">pa_open_config_file</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *global, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *local, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *env, <span class="hljs-type">char</span> **result)</span> &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *fn;<br>    FILE *f;<br><br>    <span class="hljs-comment">// 如果指定了 &quot;env&quot; 并且获取到了对应环境变量的值，则尝试打开该文件</span><br>    <span class="hljs-keyword">if</span> (env &amp;&amp; (fn = getenv(env))) &#123;<br>        <span class="hljs-keyword">if</span> ((f = pa_fopen_cloexec(fn, <span class="hljs-string">&quot;r&quot;</span>))) &#123;<br>            <span class="hljs-keyword">if</span> (result)<br>                *result = pa_xstrdup(fn);<br><br>            <span class="hljs-keyword">return</span> f;<br>        &#125;<br><br>        pa_log_warn(<span class="hljs-string">&quot;Failed to open configuration file &#x27;%s&#x27;: %s&quot;</span>, fn, pa_cstrerror(errno));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 尝试在本地目录打开文件</span><br>    <span class="hljs-keyword">if</span> (local) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *e;<br>        <span class="hljs-type">char</span> *lfn;<br>        <span class="hljs-type">char</span> *h;<br><br>        <span class="hljs-comment">// 如果设置了 &quot;PULSE_CONFIG_PATH&quot; 环境变量，则使用该路径</span><br>        <span class="hljs-keyword">if</span> ((e = getenv(<span class="hljs-string">&quot;PULSE_CONFIG_PATH&quot;</span>))) &#123;<br>            fn = lfn = pa_sprintf_malloc(<span class="hljs-string">&quot;%s&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;%s&quot;</span>, e, local);<br>            f = pa_fopen_cloexec(fn, <span class="hljs-string">&quot;r&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((h = pa_get_home_dir_malloc())) &#123;<br>            <span class="hljs-comment">// 尝试在家目录下的 .pulse 或 .config/pulse 目录打开文件</span><br>            fn = lfn = pa_sprintf_malloc(<span class="hljs-string">&quot;%s&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;.pulse&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;%s&quot;</span>, h, local);<br>            f = pa_fopen_cloexec(fn, <span class="hljs-string">&quot;r&quot;</span>);<br>            <span class="hljs-keyword">if</span> (!f) &#123;<br>                <span class="hljs-built_in">free</span>(lfn);<br>                fn = lfn = pa_sprintf_malloc(<span class="hljs-string">&quot;%s&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;.config/pulse&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;%s&quot;</span>, h, local);<br>                f = pa_fopen_cloexec(fn, <span class="hljs-string">&quot;r&quot;</span>);<br>            &#125;<br>            pa_xfree(h);<br>        &#125; <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>        <span class="hljs-comment">// 如果成功打开文件，则存储文件路径并返回文件指针</span><br>        <span class="hljs-keyword">if</span> (f) &#123;<br>            <span class="hljs-keyword">if</span> (result)<br>                *result = pa_xstrdup(fn);<br><br>            pa_xfree(lfn);<br>            <span class="hljs-keyword">return</span> f;<br>        &#125;<br><br>        <span class="hljs-comment">// 如果出错但错误码不是 ENOENT，则输出警告</span><br>        <span class="hljs-keyword">if</span> (errno != ENOENT) &#123;<br>            pa_log_warn(<span class="hljs-string">&quot;Failed to open configuration file &#x27;%s&#x27;: %s&quot;</span>, fn, pa_cstrerror(errno));<br>            pa_xfree(lfn);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br><br>        pa_xfree(lfn);<br>    &#125;<br><br>    <span class="hljs-comment">// 尝试在全局目录打开文件</span><br>    <span class="hljs-keyword">if</span> (global) &#123;<br>        <span class="hljs-type">char</span> *gfn;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> OS_IS_WIN32</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(global, PA_DEFAULT_CONFIG_DIR, <span class="hljs-built_in">strlen</span>(PA_DEFAULT_CONFIG_DIR)) == <span class="hljs-number">0</span>)<br>            gfn = pa_sprintf_malloc(<span class="hljs-string">&quot;%s&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;etc&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;pulse%s&quot;</span>,<br>                                    pa_win32_get_toplevel(<span class="hljs-literal">NULL</span>),<br>                                    global + <span class="hljs-built_in">strlen</span>(PA_DEFAULT_CONFIG_DIR));<br>        <span class="hljs-keyword">else</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        gfn = pa_xstrdup(global);<br><br>        <span class="hljs-comment">// 如果成功打开文件，则存储文件路径并返回文件指针</span><br>        <span class="hljs-keyword">if</span> ((f = pa_fopen_cloexec(gfn, <span class="hljs-string">&quot;r&quot;</span>))) &#123;<br>            <span class="hljs-keyword">if</span> (result)<br>                *result = gfn;<br>            <span class="hljs-keyword">else</span><br>                pa_xfree(gfn);<br><br>            <span class="hljs-keyword">return</span> f;<br>        &#125;<br>        pa_xfree(gfn);<br>    &#125;<br><br>    <span class="hljs-comment">// 如果无法打开文件，则设置错误码为 ENOENT 并返回 NULL</span><br>    errno = ENOENT;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="pa_config_parse">pa_config_parse</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_config_parse (filename=<span class="hljs-number">0xaaaaaaad5b20</span> <span class="hljs-string">&quot;/etc/pulse/daemon.conf&quot;</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, t=<span class="hljs-number">0xffffffffd188</span>, proplist=<span class="hljs-number">0x0</span>, use_dot_d=<span class="hljs-literal">true</span>, userdata=<span class="hljs-number">0x0</span>) at pulsecore/conf-parser.c:<span class="hljs-number">168</span>          <br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000aaaaaaab4484</span> in <span class="hljs-title function_">pa_daemon_conf_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaad5500</span>, filename=<span class="hljs-number">0x0</span>)</span> at daemon/daemon-conf.c:720                                                                                     <br>#2  0x0000aaaaaaab7204 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:483<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 通过文件并逐行解析文件 */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pa_config_parse</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, FILE *f, <span class="hljs-type">const</span> pa_config_item *t, pa_proplist *proplist, <span class="hljs-type">bool</span> use_dot_d,</span><br><span class="hljs-params">                    <span class="hljs-type">void</span> *userdata)</span> &#123;<br>    <span class="hljs-type">int</span> r = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">bool</span> do_close = !f;<br>    pa_config_parser_state state;<br><br>    <span class="hljs-comment">// 断言参数不为空</span><br>    pa_assert(filename);<br>    pa_assert(t);<br><br>    <span class="hljs-comment">// 初始化状态结构</span><br>    pa_zero(state);<br><br>    <span class="hljs-comment">// 如果未指定文件句柄，则尝试打开文件</span><br>    <span class="hljs-keyword">if</span> (!f &amp;&amp; !(f = pa_fopen_cloexec(filename, <span class="hljs-string">&quot;r&quot;</span>))) &#123;<br>        <span class="hljs-comment">// 如果错误码为 ENOENT，则记录调试信息并返回 0</span><br>        <span class="hljs-keyword">if</span> (errno == ENOENT) &#123;<br>            pa_log_debug(<span class="hljs-string">&quot;Failed to open configuration file &#x27;%s&#x27;: %s&quot;</span>, filename, pa_cstrerror(errno));<br>            r = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">goto</span> finish;<br>        &#125;<br><br>        <span class="hljs-comment">// 否则记录警告信息并返回</span><br>        pa_log_warn(<span class="hljs-string">&quot;Failed to open configuration file &#x27;%s&#x27;: %s&quot;</span>, filename, pa_cstrerror(errno));<br>        <span class="hljs-keyword">goto</span> finish;<br>    &#125;<br>    pa_log_debug(<span class="hljs-string">&quot;Parsing configuration file &#x27;%s&#x27;&quot;</span>, filename);<br><br>    <span class="hljs-comment">// 初始化状态结构</span><br>    state.filename = filename;<br>    state.item_table = t;<br>    state.userdata = userdata;<br><br>    <span class="hljs-comment">// 如果传入的 proplist 非空，则创建一个新的 proplist</span><br>    <span class="hljs-keyword">if</span> (proplist)<br>        state.proplist = pa_proplist_new();<br><br>    <span class="hljs-comment">// 逐行解析文件内容</span><br>    <span class="hljs-keyword">while</span> (!feof(f)) &#123;<br>        <span class="hljs-keyword">if</span> (!fgets(state.buf, <span class="hljs-keyword">sizeof</span>(state.buf), f)) &#123;<br>            <span class="hljs-comment">// 如果遇到文件结束，中断循环</span><br>            <span class="hljs-keyword">if</span> (feof(f))<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 否则记录警告信息并返回</span><br>            pa_log_warn(<span class="hljs-string">&quot;Failed to read configuration file &#x27;%s&#x27;: %s&quot;</span>, filename, pa_cstrerror(errno));<br>            <span class="hljs-keyword">goto</span> finish;<br>        &#125;<br><br>        state.lineno++;<br><br>        <span class="hljs-comment">// 解析当前行</span><br>        <span class="hljs-keyword">if</span> (parse_line(&amp;state) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> finish;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果传入的 proplist 非空，则更新主 proplist</span><br>    <span class="hljs-keyword">if</span> (proplist)<br>        pa_proplist_update(proplist, PA_UPDATE_REPLACE, state.proplist);<br><br>    r = <span class="hljs-number">0</span>;<br><br>finish:<br>    <span class="hljs-comment">// 释放临时 proplist</span><br>    <span class="hljs-keyword">if</span> (state.proplist)<br>        pa_proplist_free(state.proplist);<br><br>    <span class="hljs-comment">// 释放动态分配的资源</span><br>    pa_xfree(state.section);<br><br>    <span class="hljs-comment">// 如果需要关闭文件，则关闭之</span><br>    <span class="hljs-keyword">if</span> (do_close &amp;&amp; f)<br>        fclose(f);<br><br>    <span class="hljs-comment">// 如果使用了 dot_d，则在指定目录中继续解析</span><br>    <span class="hljs-keyword">if</span> (use_dot_d) &#123;<br>        <span class="hljs-comment">// 在 Windows 平台下，通过 FindFirstFile() 和 FindNextFile() 遍历目录</span><br>        <span class="hljs-comment">// 在其他平台下，通过 scandir() 遍历目录</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> OS_IS_WIN32</span><br>        <span class="hljs-comment">// Windows 平台下的处理</span><br>        <span class="hljs-comment">// ...</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>        <span class="hljs-comment">// 其他平台下的处理</span><br>        <span class="hljs-comment">// ...</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="parse_line">parse_line</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  parse_line (state=<span class="hljs-number">0xffffffffc0d8</span>) at pulsecore/conf-parser.c:<span class="hljs-number">86</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff7dad198</span> in <span class="hljs-title function_">pa_config_parse</span> <span class="hljs-params">(filename=<span class="hljs-number">0xaaaaaaad5b20</span> <span class="hljs-string">&quot;/etc/pulse/daemon.conf&quot;</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, t=<span class="hljs-number">0xffffffffd188</span>, proplist=<span class="hljs-number">0x0</span>, use_dot_d=<span class="hljs-literal">true</span>, userdata=<span class="hljs-number">0x0</span>)</span><br>    at pulsecore/conf-parser.c:208<br>#2  0x0000aaaaaaab4484 in <span class="hljs-title function_">pa_daemon_conf_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaad5500</span>, filename=<span class="hljs-number">0x0</span>)</span> at daemon/daemon-conf.c:720<br>#3  0x0000aaaaaaab7204 in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:483<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 解析变量赋值行 */</span><br><span class="hljs-comment">// static int parse_line(pa_config_parser_state *state) &#123;</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">parse_line</span><span class="hljs-params">(pa_config_parser_state *state)</span> &#123;<br>    <span class="hljs-type">char</span> *c;<br><br>    <span class="hljs-comment">// 跳过前导空格，获取 lvalue</span><br>    state-&gt;lvalue = state-&gt;buf + <span class="hljs-built_in">strspn</span>(state-&gt;buf, WHITESPACE);<br>    pa_log(<span class="hljs-string">&quot;state-&gt;lvalue:%s&quot;</span>, state-&gt;lvalue);<br><br>    <span class="hljs-comment">// 查找并截断注释部分</span><br>    <span class="hljs-keyword">if</span> ((c = <span class="hljs-built_in">strpbrk</span>(state-&gt;lvalue, COMMENTS)))<br>        *c = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 如果 lvalue 为空，则返回</span><br>    <span class="hljs-keyword">if</span> (!*state-&gt;lvalue)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 处理 .include 指令</span><br>    <span class="hljs-keyword">if</span> (pa_startswith(state-&gt;lvalue, <span class="hljs-string">&quot;.include &quot;</span>)) &#123;<br>        <span class="hljs-type">char</span> *path = <span class="hljs-literal">NULL</span>, *fn;<br>        <span class="hljs-type">int</span> r;<br><br>        <span class="hljs-comment">// 提取文件名并检查是否为绝对路径</span><br>        fn = pa_strip(state-&gt;lvalue + <span class="hljs-number">9</span>);<br>        <span class="hljs-keyword">if</span> (!pa_is_path_absolute(fn)) &#123;<br>            <span class="hljs-type">const</span> <span class="hljs-type">char</span> *k;<br>            <span class="hljs-keyword">if</span> ((k = <span class="hljs-built_in">strrchr</span>(state-&gt;filename, <span class="hljs-string">&#x27;/&#x27;</span>))) &#123;<br>                <span class="hljs-comment">// 构建文件的绝对路径</span><br>                <span class="hljs-type">char</span> *dir = pa_xstrndup(state-&gt;filename, k - state-&gt;filename);<br>                fn = path = pa_sprintf_malloc(<span class="hljs-string">&quot;%s&quot;</span> PA_PATH_SEP <span class="hljs-string">&quot;%s&quot;</span>, dir, fn);<br>                pa_xfree(dir);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 解析所指定的文件</span><br>        r = pa_config_parse(fn, <span class="hljs-literal">NULL</span>, state-&gt;item_table, state-&gt;proplist, <span class="hljs-literal">false</span>, state-&gt;userdata);<br>        pa_xfree(path);<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理节标题</span><br>    <span class="hljs-keyword">if</span> (*state-&gt;lvalue == <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<br>        <span class="hljs-type">size_t</span> k;<br><br>        k = <span class="hljs-built_in">strlen</span>(state-&gt;lvalue);<br>        pa_assert(k &gt; <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">// 检查节标题格式</span><br>        <span class="hljs-keyword">if</span> (state-&gt;lvalue[k<span class="hljs-number">-1</span>] != <span class="hljs-string">&#x27;]&#x27;</span>) &#123;<br>            pa_log(<span class="hljs-string">&quot;[%s:%u] Invalid section header.&quot;</span>, state-&gt;filename, state-&gt;lineno);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 释放之前的节标题，设置新的节标题</span><br>        pa_xfree(state-&gt;section);<br>        state-&gt;section = pa_xstrndup(state-&gt;lvalue + <span class="hljs-number">1</span>, k<span class="hljs-number">-2</span>);<br>        pa_log_debug(<span class="hljs-string">&quot;state-&gt;section:%s&quot;</span>, state-&gt;section);<br><br>        <span class="hljs-comment">// 检查是否进入 Properties 节</span><br>        <span class="hljs-keyword">if</span> (pa_streq(state-&gt;section, <span class="hljs-string">&quot;Properties&quot;</span>)) &#123;<br>            pa_log_debug(<span class="hljs-string">&quot;state-&gt;section:%s&quot;</span>, state-&gt;section);<br>            <span class="hljs-keyword">if</span> (!state-&gt;proplist) &#123;<br>                pa_log(<span class="hljs-string">&quot;[%s:%u] \&quot;Properties\&quot; section is not allowed in this file.&quot;</span>, state-&gt;filename, state-&gt;lineno);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br><br>            state-&gt;in_proplist = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span><br>            state-&gt;in_proplist = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理赋值操作</span><br>    <span class="hljs-keyword">if</span> (!(state-&gt;rvalue = <span class="hljs-built_in">strchr</span>(state-&gt;lvalue, <span class="hljs-string">&#x27;=&#x27;</span>))) &#123;<br>        pa_log(<span class="hljs-string">&quot;[%s:%u] Missing &#x27;=&#x27;.&quot;</span>, state-&gt;filename, state-&gt;lineno);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 截断 lvalue，并获取 rvalue</span><br>    *state-&gt;rvalue = <span class="hljs-number">0</span>;<br>    state-&gt;rvalue++;<br><br>    state-&gt;lvalue = pa_strip(state-&gt;lvalue);<br>    state-&gt;rvalue = pa_strip(state-&gt;rvalue);<br><br>    <span class="hljs-comment">// 根据是否在属性列表中，执行不同的赋值操作</span><br>    <span class="hljs-keyword">if</span> (state-&gt;in_proplist)<br>        <span class="hljs-keyword">return</span> proplist_assignment(state);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> normal_assignment(state);<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="proplist_assignment">proplist_assignment</h5>
<p>parse_line中有个关键函数proplist_assignment：</p>
<p>src/pulsecore/conf-parser.c:68</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 解析属性列表项。 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proplist_assignment</span><span class="hljs-params">(pa_config_parser_state *state)</span> &#123;<br>    <span class="hljs-comment">// 断言检查输入参数</span><br>    pa_assert(state);<br>    pa_assert(state-&gt;proplist);<br><br>    <span class="hljs-comment">// 使用属性列表设置键值对</span><br>    <span class="hljs-keyword">if</span> (pa_proplist_sets(state-&gt;proplist, state-&gt;lvalue, state-&gt;rvalue) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log(<span class="hljs-string">&quot;[%s:%u] Failed to parse a proplist entry: %s = %s&quot;</span>, state-&gt;filename, state-&gt;lineno, state-&gt;lvalue, state-&gt;rvalue);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="normal_assignment">normal_assignment</h5>
<p>parse_line中有个关键函数normal_assignment：</p>
<p>src/pulsecore/conf-parser.c：42</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 运行用户提供的解析器来处理赋值操作 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">normal_assignment</span><span class="hljs-params">(pa_config_parser_state *state)</span> &#123;<br>    <span class="hljs-type">const</span> pa_config_item *item;<br><br>    pa_assert(state);<br><br>    <span class="hljs-comment">// 遍历配置项表格，查找匹配的项</span><br>    <span class="hljs-keyword">for</span> (item = state-&gt;item_table; item-&gt;parse; item++) &#123;<br><br>        <span class="hljs-comment">// 如果lvalue不为空且不匹配当前行的lvalue，则继续下一个循环</span><br>        <span class="hljs-keyword">if</span> (item-&gt;lvalue &amp;&amp; !pa_streq(state-&gt;lvalue, item-&gt;lvalue))<br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">// 如果项需要指定section，但当前没有section，则继续下一个循环</span><br>        <span class="hljs-keyword">if</span> (item-&gt;section &amp;&amp; !state-&gt;section)<br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">// 如果项需要指定section且当前section不匹配项的section，则继续下一个循环</span><br>        <span class="hljs-keyword">if</span> (item-&gt;section &amp;&amp; !pa_streq(state-&gt;section, item-&gt;section))<br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">// 设置解析器的数据指针为当前项的数据</span><br>        state-&gt;data = item-&gt;data;<br><br>        <span class="hljs-comment">// 调用项的解析函数处理当前行</span><br>        <span class="hljs-keyword">return</span> item-&gt;parse(state);<br>    &#125;<br><br>    <span class="hljs-comment">// 如果没有匹配的项，则输出错误日志</span><br>    pa_log(<span class="hljs-string">&quot;[%s:%u] Unknown lvalue &#x27;%s&#x27; in section &#x27;%s&#x27;.&quot;</span>, state-&gt;filename, state-&gt;lineno, state-&gt;lvalue, pa_strna(state-&gt;section));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>item-&gt;parse</code>是个回调函数，它的参数是一个
<code>pa_config_parser_state</code> 类型的指针，该指针指向一个
<code>pa_config_item</code> 类型的结构体。</p>
<p>src/daemon/daemon-conf.c：603</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c">pa_config_item table[] = &#123;<br>    <span class="hljs-comment">// 配置项名称，解析函数，存储值的指针，额外数据指针</span><br>    &#123; <span class="hljs-string">&quot;daemonize&quot;</span>,                  pa_config_parse_bool,     &amp;c-&gt;daemonize, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;fail&quot;</span>,                       pa_config_parse_bool,     &amp;c-&gt;fail, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;high-priority&quot;</span>,              pa_config_parse_bool,     &amp;c-&gt;high_priority, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;realtime-scheduling&quot;</span>,        pa_config_parse_bool,     &amp;c-&gt;realtime_scheduling, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;disallow-module-loading&quot;</span>,    pa_config_parse_bool,     &amp;c-&gt;disallow_module_loading, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;allow-module-loading&quot;</span>,       pa_config_parse_not_bool, &amp;c-&gt;disallow_module_loading, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;disallow-exit&quot;</span>,              pa_config_parse_bool,     &amp;c-&gt;disallow_exit, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;allow-exit&quot;</span>,                 pa_config_parse_not_bool, &amp;c-&gt;disallow_exit, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;use-pid-file&quot;</span>,               pa_config_parse_bool,     &amp;c-&gt;use_pid_file, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;system-instance&quot;</span>,            pa_config_parse_bool,     &amp;c-&gt;system_instance, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_DBUS</span><br>    &#123; <span class="hljs-string">&quot;local-server-type&quot;</span>,          parse_server_type,        c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析本地服务器类型</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#123; <span class="hljs-string">&quot;no-cpu-limit&quot;</span>,               pa_config_parse_bool,     &amp;c-&gt;no_cpu_limit, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;cpu-limit&quot;</span>,                  pa_config_parse_not_bool, &amp;c-&gt;no_cpu_limit, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;disable-shm&quot;</span>,                pa_config_parse_bool,     &amp;c-&gt;disable_shm, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;enable-shm&quot;</span>,                 pa_config_parse_not_bool, &amp;c-&gt;disable_shm, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;enable-memfd&quot;</span>,               pa_config_parse_not_bool, &amp;c-&gt;disable_memfd, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;flat-volumes&quot;</span>,               pa_config_parse_bool,     &amp;c-&gt;flat_volumes, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;lock-memory&quot;</span>,                pa_config_parse_bool,     &amp;c-&gt;lock_memory, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;enable-deferred-volume&quot;</span>,     pa_config_parse_bool,     &amp;c-&gt;deferred_volume, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;exit-idle-time&quot;</span>,             pa_config_parse_int,      &amp;c-&gt;exit_idle_time, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;scache-idle-time&quot;</span>,           pa_config_parse_int,      &amp;c-&gt;scache_idle_time, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;realtime-priority&quot;</span>,          parse_rtprio,             c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析实时优先级</span><br>    &#123; <span class="hljs-string">&quot;dl-search-path&quot;</span>,             pa_config_parse_string,   &amp;c-&gt;dl_search_path, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;default-script-file&quot;</span>,        pa_config_parse_string,   &amp;c-&gt;default_script_file, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;log-target&quot;</span>,                 parse_log_target,         c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析日志目标</span><br>    &#123; <span class="hljs-string">&quot;log-level&quot;</span>,                  parse_log_level,          c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析日志级别</span><br>    &#123; <span class="hljs-string">&quot;verbose&quot;</span>,                    parse_log_level,          c, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;resample-method&quot;</span>,            parse_resample_method,    c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析重采样方法</span><br>    &#123; <span class="hljs-string">&quot;default-sample-format&quot;</span>,      parse_sample_format,      c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析默认采样格式</span><br>    &#123; <span class="hljs-string">&quot;default-sample-rate&quot;</span>,        parse_sample_rate,        c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析默认采样率</span><br>    &#123; <span class="hljs-string">&quot;alternate-sample-rate&quot;</span>,      parse_alternate_sample_rate, c, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;default-sample-channels&quot;</span>,    parse_sample_channels,    &amp;ci,  <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析默认采样通道数</span><br>    &#123; <span class="hljs-string">&quot;default-channel-map&quot;</span>,        parse_channel_map,        &amp;ci,  <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析默认通道映射</span><br>    &#123; <span class="hljs-string">&quot;default-fragments&quot;</span>,          parse_fragments,          c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析默认碎片数</span><br>    &#123; <span class="hljs-string">&quot;default-fragment-size-msec&quot;</span>, parse_fragment_size_msec, c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析默认碎片大小（毫秒）</span><br>    &#123; <span class="hljs-string">&quot;deferred-volume-safety-margin-usec&quot;</span>,<br>                                    pa_config_parse_unsigned, &amp;c-&gt;deferred_volume_safety_margin_usec, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析延迟音量安全边界（微秒）</span><br>    &#123; <span class="hljs-string">&quot;deferred-volume-extra-delay-usec&quot;</span>,<br>                                    pa_config_parse_int,      &amp;c-&gt;deferred_volume_extra_delay_usec, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析延迟音量额外延迟（微秒）</span><br>    &#123; <span class="hljs-string">&quot;nice-level&quot;</span>,                 parse_nice_level,         c, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 解析进程优先级</span><br>    &#123; <span class="hljs-string">&quot;avoid-resampling&quot;</span>,           pa_config_parse_bool,     &amp;c-&gt;avoid_resampling, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;disable-remixing&quot;</span>,           pa_config_parse_bool,     &amp;c-&gt;disable_remixing, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;enable-remixing&quot;</span>,            pa_config_parse_not_bool, &amp;c-&gt;disable_remixing, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;remixing-use-all-sink-channels&quot;</span>,<br>                                    pa_config_parse_bool,     &amp;c-&gt;remixing_use_all_sink_channels, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;disable-lfe-remixing&quot;</span>,       pa_config_parse_bool,     &amp;c-&gt;disable_lfe_remixing, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;enable-lfe-remixing&quot;</span>,        pa_config_parse_not_bool, &amp;c-&gt;disable_lfe_remixing, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;lfe-crossover-freq&quot;</span>,         pa_config_parse_unsigned, &amp;c-&gt;lfe_crossover_freq, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;load-default-script-file&quot;</span>,   pa_config_parse_bool,     &amp;c-&gt;load_default_script_file, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;shm-size-bytes&quot;</span>,             pa_config_parse_size,     &amp;c-&gt;shm_size, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;log-meta&quot;</span>,                   pa_config_parse_bool,     &amp;c-&gt;log_meta, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;log-time&quot;</span>,                   pa_config_parse_bool,     &amp;c-&gt;log_time, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;log-backtrace&quot;</span>,              pa_config_parse_unsigned, &amp;c-&gt;log_backtrace, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_SYS_RESOURCE_H</span><br>    &#123; <span class="hljs-string">&quot;rlimit-fsize&quot;</span>,               parse_rlimit,             &amp;c-&gt;rlimit_fsize, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;rlimit-data&quot;</span>,                parse_rlimit,             &amp;c-&gt;rlimit_data, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;rlimit-stack&quot;</span>,               parse_rlimit,             &amp;c-&gt;rlimit_stack, <span class="hljs-literal">NULL</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;rlimit-core&quot;</span>,                parse_rlimit,             &amp;c-&gt;rlimit_core, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_RSS</span><br>    &#123; <span class="hljs-string">&quot;rlimit-rss&quot;</span>,                 parse_rlimit,             &amp;c-&gt;rlimit_rss, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_NOFILE</span><br>    &#123; <span class="hljs-string">&quot;rlimit-nofile&quot;</span>,              parse_rlimit,             &amp;c-&gt;rlimit_nofile, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_AS</span><br>    &#123; <span class="hljs-string">&quot;rlimit-as&quot;</span>,                  parse_rlimit,             &amp;c-&gt;rlimit_as, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_NPROC</span><br>    &#123; <span class="hljs-string">&quot;rlimit-nproc&quot;</span>,               parse_rlimit,             &amp;c-&gt;rlimit_nproc, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_MEMLOCK</span><br>    &#123; <span class="hljs-string">&quot;rlimit-memlock&quot;</span>,             parse_rlimit,             &amp;c-&gt;rlimit_memlock, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_LOCKS</span><br>    &#123; <span class="hljs-string">&quot;rlimit-locks&quot;</span>,               parse_rlimit,             &amp;c-&gt;rlimit_locks, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_SIGPENDING</span><br>    &#123; <span class="hljs-string">&quot;rlimit-sigpending&quot;</span>,          parse_rlimit,             &amp;c-&gt;rlimit_sigpending, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_MSGQUEUE</span><br>    &#123; <span class="hljs-string">&quot;rlimit-msgqueue&quot;</span>,            parse_rlimit,             &amp;c-&gt;rlimit_msgqueue, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_NICE</span><br>    &#123; <span class="hljs-string">&quot;rlimit-nice&quot;</span>,                parse_rlimit,             &amp;c-&gt;rlimit_nice, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_RTPRIO</span><br>    &#123; <span class="hljs-string">&quot;rlimit-rtprio&quot;</span>,              parse_rlimit,             &amp;c-&gt;rlimit_rtprio, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_RTTIME</span><br>    &#123; <span class="hljs-string">&quot;rlimit-rttime&quot;</span>,              parse_rlimit,             &amp;c-&gt;rlimit_rttime, <span class="hljs-literal">NULL</span> &#125;,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#123; <span class="hljs-literal">NULL</span>,                         <span class="hljs-literal">NULL</span>,                     <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;, <span class="hljs-comment">// 配置项数组结束标记</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="pa_get_hw_info">pa_get_hw_info</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb)<br>489         <span class="hljs-keyword">if</span> (pa_get_hw_info(hw_info_path, card_name)) &#123;<br>(gdb) s<br>pa_get_hw_info (path=0xaaaaaaabeac8 <span class="hljs-string">&quot;/usr/share/uos-hw-config/hw_dmi_version&quot;</span>, card=0xffffffffdb28 <span class="hljs-string">&quot;&quot;</span>) at daemon/daemon-conf.c:540                                                             <br>540     bool pa_get_hw_info(const char *path, char *card) &#123;<br>(gdb) b 540<br>Breakpoint 30 at 0xaaaaaaab3674: file daemon/daemon-conf.c, line 540.<br>(gdb) bt<br><span class="hljs-comment">#0  pa_get_hw_info (path=0xaaaaaaabeac8 &quot;/usr/share/uos-hw-config/hw_dmi_version&quot;, card=0xffffffffdb28 &quot;&quot;) at daemon/daemon-conf.c:540                                                         </span><br><span class="hljs-comment">#1  0x0000aaaaaaab723c in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:489                                                                                                                            &quot;uos-PC&quot; 12:37 17-8月-23</span><br>(gdb) n<br>545         const char *state = NULL;<br>(gdb)<br>547         matched = <span class="hljs-literal">false</span>;<br>(gdb)<br>548         <span class="hljs-keyword">if</span> ((s = pa_read_line_from_file(path)) != NULL) &#123;<br>(gdb)<br>569         <span class="hljs-built_in">return</span> matched;<br>(gdb)<br>570     &#125;<br>(gdb) p matched<br><span class="hljs-variable">$10</span> = <span class="hljs-literal">false</span><br>(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from <span class="hljs-comment">#0  pa_get_hw_info (path=0xaaaaaaabeac8 &quot;/usr/share/uos-hw-config/hw_dmi_version&quot;, card=0xffffffffdb28 &quot;&quot;) at daemon/daemon-conf.c:570                                      </span><br>0x0000aaaaaaab723c <span class="hljs-keyword">in</span> main (argc=4, argv=0xffffffffdd98) at daemon/main.c:489<br>489         <span class="hljs-keyword">if</span> (pa_get_hw_info(hw_info_path, card_name)) &#123;<br>Value returned is <span class="hljs-variable">$11</span> = <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>
<p>uos
arm上没有<code>/usr/share/uos-hw-config/hw_dmi_version</code>文件，此函数返回false，故下方代码不执行：</p>
<p>src/daemon/main.c：489</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (pa_get_hw_info(hw_info_path, card_name)) &#123;<br>        pa_get_vendor_name(card_name, vendor_name);<br>        huawei_identification = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (pa_platform_load(conf, vendor_name, card_name) &lt; <span class="hljs-number">0</span>)<br>            pa_log(_(<span class="hljs-string">&quot;Failed to load platform file.&quot;</span>));<br>    &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 获取硬件信息，根据给定的路径和卡片名进行匹配</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">pa_get_hw_info</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *card)</span> &#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">bool</span> matched;<br>    <span class="hljs-type">char</span> *s;<br>    <span class="hljs-type">char</span> *r;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *state = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// 初始化匹配状态为未匹配</span><br>    matched = <span class="hljs-literal">false</span>;<br>    <br>    <span class="hljs-comment">// 从文件中读取一行信息</span><br>    <span class="hljs-keyword">if</span> ((s = pa_read_line_from_file(path)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-comment">// 逐个处理空格分隔的信息</span><br>        <span class="hljs-keyword">while</span> ((r = pa_split_spaces(s, &amp;state))) &#123;<br>            pa_log_debug(<span class="hljs-string">&quot;hw info r: %s&quot;</span>, r);<br><br>            <span class="hljs-comment">// 遍历硬件ID表格，查找匹配的板号</span><br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; id_table[i].id != <span class="hljs-number">-1</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(id_table[i].board, r) == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// 复制对应的卡片名到给定的缓冲区中</span><br>                    <span class="hljs-built_in">strncpy</span>(card, id_table[i].card, <span class="hljs-keyword">sizeof</span>(card));<br>                    <span class="hljs-comment">// 设置匹配状态为已匹配</span><br>                    matched = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 释放分隔后的字符串</span><br>            pa_xfree(r);<br><br>            <span class="hljs-comment">// 如果匹配成功，则结束循环</span><br>            <span class="hljs-keyword">if</span> (matched)<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 释放读取的行字符串</span><br>        pa_xfree(s);<br>    &#125;<br><br>    <span class="hljs-comment">// 返回匹配状态</span><br>    <span class="hljs-keyword">return</span> matched;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="pa_daemon_conf_env">pa_daemon_conf_env</h2>
<p>从环境变量中获取配置信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) n<br><span class="hljs-number">496</span>         <span class="hljs-keyword">if</span> (pa_daemon_conf_env(conf) &lt; <span class="hljs-number">0</span>)<br>(gdb) s<br><span class="hljs-title function_">pa_daemon_conf_env</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaad5500</span>)</span> at daemon/daemon-conf.c:747<br>747         <span class="hljs-title function_">pa_assert</span><span class="hljs-params">(c)</span>;<br>(gdb) bt<br>#<span class="hljs-number">0</span>  pa_daemon_conf_env (c=<span class="hljs-number">0xaaaaaaad5500</span>) at daemon/daemon-conf.c:<span class="hljs-number">747</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000aaaaaaab72b8</span> in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:496<br><span class="hljs-params">(gdb)</span> fin<br>Run till <span class="hljs-built_in">exit</span> from #0  <span class="hljs-title function_">pa_daemon_conf_env</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaad5500</span>)</span> at daemon/daemon-conf.c:758<br><span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:496<br>496         <span class="hljs-title function_">if</span> <span class="hljs-params">(pa_daemon_conf_env(conf) &lt; <span class="hljs-number">0</span>)</span><br>Value returned is $15 = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 从环境变量中获取配置信息并更新到pa_daemon_conf结构</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pa_daemon_conf_env</span><span class="hljs-params">(pa_daemon_conf *c)</span> &#123;<br>    <span class="hljs-type">char</span> *e;<br>    pa_assert(c);<br><br>    <span class="hljs-comment">// 从环境变量中获取DL搜索路径并更新到结构中</span><br>    <span class="hljs-keyword">if</span> ((e = getenv(ENV_DL_SEARCH_PATH))) &#123;<br>        pa_xfree(c-&gt;dl_search_path);<br>        c-&gt;dl_search_path = pa_xstrdup(e);<br>    &#125;<br><br>    <span class="hljs-comment">// 从环境变量中获取默认脚本文件路径并更新到结构中</span><br>    <span class="hljs-keyword">if</span> ((e = getenv(ENV_SCRIPT_FILE))) &#123;<br>        pa_xfree(c-&gt;default_script_file);<br>        c-&gt;default_script_file = pa_xstrdup(e);<br>    &#125;<br><br>    <span class="hljs-comment">// 返回0表示成功</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="pa_cmdline_parse">pa_cmdline_parse</h2>
<p>解析命令行参数并更新pa_daemon_conf结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) n<br><span class="hljs-number">499</span>         <span class="hljs-keyword">if</span> (pa_cmdline_parse(conf, argc, argv, &amp;d) &lt; <span class="hljs-number">0</span>) &#123;<br>(gdb) s<br><span class="hljs-title function_">pa_cmdline_parse</span> <span class="hljs-params">(conf=<span class="hljs-number">0xaaaaaaad5500</span>, argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>, d=<span class="hljs-number">0xffffffffda24</span>)</span> at daemon/cmdline.c:172                                                                                  <br>warning: Source file is more recent than executable.<br>172         pa_strbuf *buf = <span class="hljs-literal">NULL</span>;<br>(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from #<span class="hljs-number">0</span>  pa_cmdline_parse (conf=<span class="hljs-number">0xaaaaaaad5500</span>, argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>, d=<span class="hljs-number">0xffffffffda24</span>) at daemon/cmdline.c:<span class="hljs-number">172</span><br>main (argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>) at daemon/main.c:<span class="hljs-number">499</span><br><span class="hljs-number">499</span>         <span class="hljs-keyword">if</span> (pa_cmdline_parse(conf, argc, argv, &amp;d) &lt; <span class="hljs-number">0</span>) &#123;<br>Value returned is $<span class="hljs-number">16</span> = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 解析命令行参数并更新pa_daemon_conf结构</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pa_cmdline_parse</span><span class="hljs-params">(pa_daemon_conf *conf, <span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *<span class="hljs-type">const</span> argv[], <span class="hljs-type">int</span> *d)</span> &#123;<br>    pa_strbuf *buf = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">int</span> c;<br>    <span class="hljs-type">int</span> b;<br><br>    pa_assert(conf);<br>    pa_assert(argc &gt; <span class="hljs-number">0</span>);<br>    pa_assert(argv);<br><br>    buf = pa_strbuf_new();<br><br>    <span class="hljs-keyword">if</span> (conf-&gt;script_commands)<br>        pa_strbuf_puts(buf, conf-&gt;script_commands);<br><br>    <span class="hljs-keyword">while</span> ((c = getopt_long(argc, argv, <span class="hljs-string">&quot;L:F:ChDnp:kv&quot;</span>, long_options, <span class="hljs-literal">NULL</span>)) != <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-keyword">switch</span> (c) &#123;<br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_HELP:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;h&#x27;</span>:<br>                conf-&gt;cmd = PA_CMD_HELP;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_VERSION:<br>                conf-&gt;cmd = PA_CMD_VERSION;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_DUMP_CONF:<br>                conf-&gt;cmd = PA_CMD_DUMP_CONF;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_DUMP_MODULES:<br>                conf-&gt;cmd = PA_CMD_DUMP_MODULES;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_DUMP_RESAMPLE_METHODS:<br>                conf-&gt;cmd = PA_CMD_DUMP_RESAMPLE_METHODS;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_CLEANUP_SHM:<br>                conf-&gt;cmd = PA_CMD_CLEANUP_SHM;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;k&#x27;</span>:<br>            <span class="hljs-keyword">case</span> ARG_KILL:<br>                conf-&gt;cmd = PA_CMD_KILL;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_START:<br>                conf-&gt;cmd = PA_CMD_START;<br>                conf-&gt;daemonize = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_CHECK:<br>                conf-&gt;cmd = PA_CMD_CHECK;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_LOAD:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;L&#x27;</span>:<br>                pa_strbuf_printf(buf, <span class="hljs-string">&quot;load-module %s\n&quot;</span>, optarg);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置命令</span><br>            <span class="hljs-keyword">case</span> ARG_FILE:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;F&#x27;</span>: &#123;<br>                <span class="hljs-type">char</span> *p;<br>                pa_strbuf_printf(buf, <span class="hljs-string">&quot;.include %s\n&quot;</span>, p = pa_make_path_absolute(optarg));<br>                pa_xfree(p);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;C&#x27;</span>:<br>                pa_strbuf_puts(buf, <span class="hljs-string">&quot;load-module module-cli exit_on_eof=1\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_DAEMONIZE:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;D&#x27;</span>:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--daemonize expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;daemonize = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_FAIL:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--fail expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;fail = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>:<br>            <span class="hljs-keyword">case</span> ARG_LOG_LEVEL:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> (optarg) &#123;<br>                    <span class="hljs-keyword">if</span> (pa_daemon_conf_set_log_level(conf, optarg) &lt; <span class="hljs-number">0</span>) &#123;<br>                        pa_log(_(<span class="hljs-string">&quot;--log-level expects log level argument (either numeric in range 0..4 or one of debug, info, notice, warn, error).&quot;</span>));<br>                        <span class="hljs-keyword">goto</span> fail;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (conf-&gt;log_level &lt; PA_LOG_LEVEL_MAX<span class="hljs-number">-1</span>)<br>                        conf-&gt;log_level++;<br>                &#125;<br><br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_HIGH_PRIORITY:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--high-priority expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;high_priority = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_REALTIME:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--realtime expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;realtime_scheduling = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_DISALLOW_MODULE_LOADING:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--disallow-module-loading expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;disallow_module_loading = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_DISALLOW_EXIT:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--disallow-exit expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;disallow_exit = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_USE_PID_FILE:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--use-pid-file expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;use_pid_file = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;p&#x27;</span>:<br>            <span class="hljs-keyword">case</span> ARG_DL_SEARCH_PATH:<br>                pa_xfree(conf-&gt;dl_search_path);<br>                conf-&gt;dl_search_path = pa_xstrdup(optarg);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;n&#x27;</span>:<br>                conf-&gt;load_default_script_file = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_LOG_TARGET:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> (pa_daemon_conf_set_log_target(conf, optarg) &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> HAVE_SYSTEMD_JOURNAL</span><br>                    pa_log(_(<span class="hljs-string">&quot;Invalid log target: use either &#x27;syslog&#x27;, &#x27;journal&#x27;,&#x27;stderr&#x27; or &#x27;auto&#x27; or a valid file name &#x27;file:&lt;path&gt;&#x27;, &#x27;newfile:&lt;path&gt;&#x27;.&quot;</span>));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>                    pa_log(_(<span class="hljs-string">&quot;Invalid log target: use either &#x27;syslog&#x27;, &#x27;stderr&#x27; or &#x27;auto&#x27; or a valid file name &#x27;file:&lt;path&gt;&#x27;, &#x27;newfile:&lt;path&gt;&#x27;.&quot;</span>));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_LOG_TIME:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--log-time expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;log_time = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_LOG_META:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--log-meta expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;log_meta = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_LOG_BACKTRACE:<br>                conf-&gt;log_backtrace = (<span class="hljs-type">unsigned</span>) atoi(optarg);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_EXIT_IDLE_TIME:<br>                conf-&gt;exit_idle_time = atoi(optarg);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_SCACHE_IDLE_TIME:<br>                conf-&gt;scache_idle_time = atoi(optarg);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_RESAMPLE_METHOD:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> (pa_daemon_conf_set_resample_method(conf, optarg) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;Invalid resample method &#x27;%s&#x27;.&quot;</span>), optarg);<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_SYSTEM:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--system expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;system_instance = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_NO_CPU_LIMIT:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--no-cpu-limit expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;no_cpu_limit = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_DISABLE_SHM:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--disable-shm expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;disable_shm = !!b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>            <span class="hljs-keyword">case</span> ARG_ENABLE_MEMFD:<br>                <span class="hljs-comment">// 解析命令行参数并更新对应的配置属性</span><br>                <span class="hljs-keyword">if</span> ((b = optarg ? pa_parse_boolean(optarg) : <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log(_(<span class="hljs-string">&quot;--enable-memfd expects boolean argument&quot;</span>));<br>                    <span class="hljs-keyword">goto</span> fail;<br>                &#125;<br>                conf-&gt;disable_memfd = !b;<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-comment">// 默认情况：无效的参数，返回失败</span><br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">goto</span> fail;<br>        &#125;<br>    &#125;<br><br>    pa_xfree(conf-&gt;script_commands);<br>    conf-&gt;script_commands = pa_strbuf_to_string_free(buf);<br><br>    *d = optind;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>fail:<br>    <span class="hljs-keyword">if</span> (buf)<br>        pa_strbuf_free(buf);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="pa_ltdl_init">pa_ltdl_init</h2>
<p>初始化libtool库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_ltdl_init () at daemon/ltdl-bind-now.c:<span class="hljs-number">118</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000aaaaaaab74fc</span> in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:545<br><span class="hljs-params">(gdb)</span> fin<br>Run till <span class="hljs-built_in">exit</span> from #0  <span class="hljs-title function_">pa_ltdl_init</span> <span class="hljs-params">()</span> at daemon/ltdl-bind-now.c:118<br><span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:546<br>546         ltdl_init = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 初始化libtool库，并在需要的情况下添加BIND_NOW加载器</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">pa_ltdl_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PA_BIND_NOW</span><br>    <span class="hljs-comment">// BIND_NOW宏已定义时，声明dlopen_loader指针</span><br>    <span class="hljs-type">const</span> lt_dlvtable *dlopen_loader;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// 初始化libtool库，确保动态加载器已被初始化</span><br>    pa_assert_se(lt_dlinit() == <span class="hljs-number">0</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PA_BIND_NOW</span><br>    <span class="hljs-comment">// 如果BIND_NOW宏已定义，进行以下操作</span><br>    <span class="hljs-comment">/* Already initialised */</span><br>    <span class="hljs-keyword">if</span> (bindnow_loader)<br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// 在已加载的加载器列表中查找lt_dlopen加载器</span><br>    <span class="hljs-keyword">if</span> (!(dlopen_loader = lt_dlloader_find((<span class="hljs-type">char</span>*) <span class="hljs-string">&quot;lt_dlopen&quot;</span>))) &#123;<br>        pa_log_warn(_(<span class="hljs-string">&quot;Failed to find original lt_dlopen loader.&quot;</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 分配内存来保存新的加载器信息</span><br>    <span class="hljs-keyword">if</span> (!(bindnow_loader = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(lt_dlvtable)))) &#123;<br>        pa_log_error(_(<span class="hljs-string">&quot;Failed to allocate new dl loader.&quot;</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 复制原始加载器的信息到新的加载器中</span><br>    <span class="hljs-built_in">memcpy</span>(bindnow_loader, dlopen_loader, <span class="hljs-keyword">sizeof</span>(*bindnow_loader));<br>    bindnow_loader-&gt;name = <span class="hljs-string">&quot;bind-now-loader&quot;</span>;<br>    bindnow_loader-&gt;module_open = bind_now_open;<br>    bindnow_loader-&gt;module_close = bind_now_close;<br>    bindnow_loader-&gt;find_sym = bind_now_find_sym;<br>    bindnow_loader-&gt;priority = LT_DLLOADER_PREPEND;<br><br>    <span class="hljs-comment">// 将新的BIND_NOW加载器添加为默认的模块加载器</span><br>    <span class="hljs-keyword">if</span> (lt_dlloader_add(bindnow_loader) != <span class="hljs-number">0</span>) &#123;<br>        pa_log_warn(_(<span class="hljs-string">&quot;Failed to add bind-now-loader.&quot;</span>));<br>        <span class="hljs-built_in">free</span>(bindnow_loader);<br>        bindnow_loader = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="pa_mainloop_new">pa_mainloop_new</h2>
<p>事件循环</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) <br><span class="hljs-number">1033</span>        pa_assert_se(mainloop = pa_mainloop_new());<br>(gdb) s<br><span class="hljs-title function_">pa_mainloop_new</span> <span class="hljs-params">()</span> at pulse/mainloop.c:453<br>warning: Source file is more recent than executable.<br>453         <span class="hljs-title function_">pa_init_i18n</span><span class="hljs-params">()</span>;<br>(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from #<span class="hljs-number">0</span>  pa_mainloop_new () at pulse/mainloop.c:<span class="hljs-number">453</span><br><span class="hljs-number">0x0000aaaaaaab8a84</span> in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1033<br>1033        <span class="hljs-title function_">pa_assert_se</span><span class="hljs-params">(mainloop = pa_mainloop_new())</span>;<br>Value returned is $<span class="hljs-number">28</span> = (pa_mainloop *) <span class="hljs-number">0xaaaaaaadad60</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 创建一个新的主事件循环。*/</span><br>pa_mainloop *<span class="hljs-title function_">pa_mainloop_new</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    pa_mainloop *m;  <span class="hljs-comment">// 主事件循环结构体指针</span><br><br>    pa_init_i18n();  <span class="hljs-comment">// 初始化国际化支持</span><br><br>    <span class="hljs-comment">// 分配内存并将其初始化为零</span><br>    m = pa_xnew0(pa_mainloop, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// 创建唤醒管道，用于事件循环的通信</span><br>    <span class="hljs-keyword">if</span> (pa_pipe_cloexec(m-&gt;wakeup_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log_error(<span class="hljs-string">&quot;ERROR: cannot create wakeup pipe&quot;</span>);<br>        pa_xfree(m);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 将唤醒管道的读写端设置为非阻塞模式</span><br>    pa_make_fd_nonblock(m-&gt;wakeup_pipe[<span class="hljs-number">0</span>]);<br>    pa_make_fd_nonblock(m-&gt;wakeup_pipe[<span class="hljs-number">1</span>]);<br><br>    m-&gt;rebuild_pollfds = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 标记需要重建 pollfds</span><br><br>    <span class="hljs-comment">// 初始化事件循环 API 和用户数据</span><br>    m-&gt;api = vtable;<br>    m-&gt;api.userdata = m;<br><br>    m-&gt;state = STATE_PASSIVE;  <span class="hljs-comment">// 设置状态为被动</span><br><br>    m-&gt;poll_func_ret = <span class="hljs-number">-1</span>;  <span class="hljs-comment">// 初始化 poll_func_ret</span><br><br>    <span class="hljs-keyword">return</span> m;  <span class="hljs-comment">// 返回创建的主事件循环</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="pa_core默认参数设置">pa_core默认参数设置</h2>
<p>src/daemon/main.c：1042</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">c-&gt;default_sample_spec = conf-&gt;default_sample_spec;  <span class="hljs-comment">// 设置默认采样规格</span><br>c-&gt;alternate_sample_rate = conf-&gt;alternate_sample_rate;  <span class="hljs-comment">// 设置备用采样率</span><br>c-&gt;default_channel_map = conf-&gt;default_channel_map;  <span class="hljs-comment">// 设置默认通道映射</span><br>c-&gt;default_n_fragments = conf-&gt;default_n_fragments;  <span class="hljs-comment">// 设置默认片段数量</span><br>c-&gt;default_fragment_size_msec = conf-&gt;default_fragment_size_msec;  <span class="hljs-comment">// 设置默认片段大小（毫秒）</span><br>c-&gt;deferred_volume_safety_margin_usec = conf-&gt;deferred_volume_safety_margin_usec;  <span class="hljs-comment">// 设置延迟音量安全裕度（微秒）</span><br>c-&gt;deferred_volume_extra_delay_usec = conf-&gt;deferred_volume_extra_delay_usec;  <span class="hljs-comment">// 设置延迟音量额外延迟（微秒）</span><br>c-&gt;lfe_crossover_freq = conf-&gt;lfe_crossover_freq;  <span class="hljs-comment">// 设置低音炮分频频率</span><br>c-&gt;exit_idle_time = conf-&gt;exit_idle_time;  <span class="hljs-comment">// 设置退出空闲时间</span><br>c-&gt;scache_idle_time = conf-&gt;scache_idle_time;  <span class="hljs-comment">// 设置样本缓存空闲时间</span><br>c-&gt;resample_method = conf-&gt;resample_method;  <span class="hljs-comment">// 设置重采样方法</span><br>c-&gt;realtime_priority = conf-&gt;realtime_priority;  <span class="hljs-comment">// 设置实时优先级</span><br>c-&gt;realtime_scheduling = conf-&gt;realtime_scheduling;  <span class="hljs-comment">// 设置实时调度</span><br>c-&gt;avoid_resampling = conf-&gt;avoid_resampling;  <span class="hljs-comment">// 设置避免重采样</span><br>c-&gt;disable_remixing = conf-&gt;disable_remixing;  <span class="hljs-comment">// 设置禁用混音</span><br>c-&gt;remixing_use_all_sink_channels = conf-&gt;remixing_use_all_sink_channels;  <span class="hljs-comment">// 设置混音使用所有目标通道</span><br>c-&gt;disable_lfe_remixing = conf-&gt;disable_lfe_remixing;  <span class="hljs-comment">// 设置禁用低音炮混音</span><br>c-&gt;deferred_volume = conf-&gt;deferred_volume;  <span class="hljs-comment">// 设置延迟音量</span><br>c-&gt;running_as_daemon = conf-&gt;daemonize;  <span class="hljs-comment">// 设置作为守护进程运行</span><br>c-&gt;disallow_exit = conf-&gt;disallow_exit;  <span class="hljs-comment">// 设置禁止退出</span><br>c-&gt;flat_volumes = conf-&gt;flat_volumes;  <span class="hljs-comment">// 设置平坦音量</span><br>c-&gt;huawei_identity = huawei_identification;  <span class="hljs-comment">// 设置华为身份标识</span><br></code></pre></td></tr></table></figure>
<h2 id="pa_cpu_init">pa_cpu_init</h2>
<p>cpu特性设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) n<br><span class="hljs-number">1083</span>        pa_cpu_init(&amp;c-&gt;cpu_info);<br>(gdb) bt<br>#<span class="hljs-number">0</span>  main (argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>) at daemon/main.c:<span class="hljs-number">1083</span><br>(gdb) s<br><span class="hljs-title function_">pa_cpu_init</span> <span class="hljs-params">(cpu_info=<span class="hljs-number">0xaaaaaaae30e0</span>)</span> at pulsecore/cpu.c:25<br>warning: Source file is more recent than executable.<br>25          cpu_info-&gt;cpu_type = PA_CPU_UNDEFINED;<br>(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from #<span class="hljs-number">0</span>  pa_cpu_init (cpu_info=<span class="hljs-number">0xaaaaaaae30e0</span>) at pulsecore/cpu.c:<span class="hljs-number">25</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">pa_cpu_init</span><span class="hljs-params">(pa_cpu_info *cpu_info)</span> &#123;<br>    cpu_info-&gt;cpu_type = PA_CPU_UNDEFINED;  <span class="hljs-comment">// 初始化 CPU 类型为未定义</span><br>    <span class="hljs-comment">/* don&#x27;t force generic code, used for testing only */</span><br>    cpu_info-&gt;force_generic_code = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 不强制使用通用代码，仅用于测试</span><br><br>    <span class="hljs-comment">// 如果没有设置环境变量 &quot;PULSE_NO_SIMD&quot;</span><br>    <span class="hljs-keyword">if</span> (!getenv(<span class="hljs-string">&quot;PULSE_NO_SIMD&quot;</span>)) &#123;<br>        <span class="hljs-comment">// 尝试初始化 x86 架构的 CPU 特性</span><br>        <span class="hljs-keyword">if</span> (pa_cpu_init_x86(&amp;cpu_info-&gt;flags.x86))<br>            cpu_info-&gt;cpu_type = PA_CPU_X86;  <span class="hljs-comment">// 设置 CPU 类型为 X86</span><br>        <span class="hljs-comment">// 如果 x86 初始化失败，尝试初始化 ARM 架构的 CPU 特性</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pa_cpu_init_arm(&amp;cpu_info-&gt;flags.arm))<br>            cpu_info-&gt;cpu_type = PA_CPU_ARM;  <span class="hljs-comment">// 设置 CPU 类型为 ARM</span><br>        <span class="hljs-comment">// 初始化 ORC (Optimized Inner Loops Runtime Compiler) 特性</span><br>        pa_cpu_init_orc(*cpu_info);<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化 CPU 重映射函数</span><br>    pa_remap_func_init(cpu_info);<br>    <span class="hljs-comment">// 初始化混音函数</span><br>    pa_mix_func_init(cpu_info);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2
id="pa_daemon_conf_open_default_script_file">pa_daemon_conf_open_default_script_file</h2>
<p>default.pa加载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  pa_daemon_conf_open_default_script_file (c=0xaaaaaaad5500) at daemon/daemon-conf.c:782</span><br><span class="hljs-comment">#1  0x0000aaaaaaab9080 in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1111</span><br>(gdb) s<br>pa_open_config_file (global=0xaaaaaaabd620 <span class="hljs-string">&quot;/etc/pulse/default.pa&quot;</span>, <span class="hljs-built_in">local</span>=0xaaaaaaabd610 <span class="hljs-string">&quot;/default.pa&quot;</span>, <span class="hljs-built_in">env</span>=0xaaaaaaabd5e8 <span class="hljs-string">&quot;PULSE_SCRIPT&quot;</span>, result=0xaaaaaaad5548) at pulsecore/core-util.c:2021<br>warning: Source file is more recent than executable.<br>2021        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">env</span> &amp;&amp; (fn = getenv(<span class="hljs-built_in">env</span>))) &#123;<br>(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from <span class="hljs-comment">#0  pa_open_config_file (global=0xaaaaaaabd620 &quot;/etc/pulse/default.pa&quot;, local=0xaaaaaaabd610 &quot;/default.pa&quot;, env=0xaaaaaaabd5e8 &quot;PULSE_SCRIPT&quot;, result=0xaaaaaaad5548)</span><br>    at pulsecore/core-util.c:2021<br>0x0000aaaaaaab4884 <span class="hljs-keyword">in</span> pa_daemon_conf_open_default_script_file (c=0xaaaaaaad5500) at daemon/daemon-conf.c:782<br>782                 f = pa_open_config_file(DEFAULT_SCRIPT_FILE, DEFAULT_SCRIPT_FILE_USER, ENV_SCRIPT_FILE, &amp;c-&gt;default_script_file);<br>Value returned is <span class="hljs-variable">$36</span> = (FILE *) 0xaaaaaaad58f0<br>(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from <span class="hljs-comment">#0  0x0000aaaaaaab4884 in pa_daemon_conf_open_default_script_file (c=0xaaaaaaad5500) at daemon/daemon-conf.c:782</span><br>0x0000aaaaaaab9080 <span class="hljs-keyword">in</span> main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1111<br>1111                <span class="hljs-keyword">if</span> ((f = pa_daemon_conf_open_default_script_file(conf))) &#123;<br>Value returned is <span class="hljs-variable">$37</span> = (FILE *) 0xaaaaaaad58f0<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">FILE *<span class="hljs-title function_">pa_daemon_conf_open_default_script_file</span><span class="hljs-params">(pa_daemon_conf *c)</span> &#123;<br>    FILE *f;<br>    pa_assert(c);  <span class="hljs-comment">// 断言传入的配置参数 c 不为空</span><br><br>    <span class="hljs-comment">// 如果没有设置默认脚本文件</span><br>    <span class="hljs-keyword">if</span> (!c-&gt;default_script_file) &#123;<br>        <span class="hljs-comment">// 如果是系统实例，尝试打开默认的系统脚本文件</span><br>        <span class="hljs-keyword">if</span> (c-&gt;system_instance)<br>            f = pa_open_config_file(DEFAULT_SYSTEM_SCRIPT_FILE, <span class="hljs-literal">NULL</span>, ENV_SCRIPT_FILE, &amp;c-&gt;default_script_file);<br>        <span class="hljs-comment">// 如果不是系统实例，尝试打开默认的用户脚本文件</span><br>        <span class="hljs-keyword">else</span><br>            f = pa_open_config_file(DEFAULT_SCRIPT_FILE, DEFAULT_SCRIPT_FILE_USER, ENV_SCRIPT_FILE, &amp;c-&gt;default_script_file);<br>    &#125; <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// 如果设置了默认脚本文件，直接打开该文件</span><br>        f = pa_fopen_cloexec(c-&gt;default_script_file, <span class="hljs-string">&quot;r&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> f;  <span class="hljs-comment">// 返回打开的文件指针</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3
id="pa_cli_command_execute_line_stateful">pa_cli_command_execute_line_stateful</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><span class="hljs-params">(pa_core *c, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail, <span class="hljs-type">int</span> *ifstate)</span> &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cs;<br><br>    pa_assert(c);    <span class="hljs-comment">// 断言传入的核心参数 c 不为空</span><br>    pa_assert(s);    <span class="hljs-comment">// 断言传入的命令字符串 s 不为空</span><br>    pa_assert(buf);  <span class="hljs-comment">// 断言传入的字符串缓冲 buf 不为空</span><br><br>    cs = s + <span class="hljs-built_in">strspn</span>(s, whitespace);  <span class="hljs-comment">// 跳过字符串开头的空格字符</span><br><br>    <span class="hljs-keyword">if</span> (*cs == <span class="hljs-string">&#x27;#&#x27;</span> || !*cs)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 如果行是注释或者空行，直接返回</span><br><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*cs == <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br>        <span class="hljs-comment">// 处理以点号开头的元命令</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(cs, META_ELSE)) &#123;<br>            <span class="hljs-comment">// 处理 &quot;.else&quot; 元命令</span><br>            <span class="hljs-keyword">if</span> (!ifstate || *ifstate == IFSTATE_NONE) &#123;<br>                pa_strbuf_printf(buf, <span class="hljs-string">&quot;Meta command %s is not valid in this context\n&quot;</span>, cs);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*ifstate == IFSTATE_TRUE)<br>                *ifstate = IFSTATE_FALSE;<br>            <span class="hljs-keyword">else</span><br>                *ifstate = IFSTATE_TRUE;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(cs, META_ENDIF)) &#123;<br>            <span class="hljs-comment">// 处理 &quot;.endif&quot; 元命令</span><br>            <span class="hljs-keyword">if</span> (!ifstate || *ifstate == IFSTATE_NONE) &#123;<br>                pa_strbuf_printf(buf, <span class="hljs-string">&quot;Meta command %s is not valid in this context\n&quot;</span>, cs);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125; <span class="hljs-keyword">else</span><br>                *ifstate = IFSTATE_NONE;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 处理其他元命令</span><br>        <span class="hljs-keyword">if</span> (ifstate &amp;&amp; *ifstate == IFSTATE_FALSE)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// ...</span><br>        <span class="hljs-comment">// 处理其他元命令逻辑</span><br>        <span class="hljs-comment">// ...</span><br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 处理普通命令</span><br>        <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> command *command;<br>        <span class="hljs-type">int</span> unknown = <span class="hljs-number">1</span>;<br>        <span class="hljs-type">size_t</span> l;<br><br>        <span class="hljs-keyword">if</span> (ifstate &amp;&amp; *ifstate == IFSTATE_FALSE)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>        l = <span class="hljs-built_in">strcspn</span>(cs, whitespace);<br><br>        <span class="hljs-keyword">for</span> (command = commands; command-&gt;name; command++) &#123;<br>            <span class="hljs-comment">// 检查命令是否匹配已知命令列表</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(command-&gt;name) == l &amp;&amp; !<span class="hljs-built_in">strncmp</span>(cs, command-&gt;name, l)) &#123;<br>                <span class="hljs-type">int</span> ret;<br>                pa_tokenizer *t = pa_tokenizer_new(cs, command-&gt;args);<br>                pa_assert(t);<br>                <span class="hljs-comment">// 调用命令处理函数进行处理</span><br>                ret = command-&gt;proc(c, t, buf, fail);<br>                pa_tokenizer_free(t);<br>                unknown = <span class="hljs-number">0</span>;<br><br>                <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span> &amp;&amp; *fail)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 如果命令未知</span><br>        <span class="hljs-keyword">if</span> (unknown) &#123;<br>            pa_strbuf_printf(buf, <span class="hljs-string">&quot;Unknown command: %s\n&quot;</span>, cs);<br>            <span class="hljs-keyword">if</span> (*fail)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 返回处理结果</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="pa_cli_command">pa_cli_command</h4>
<p><code>command-&gt;proc</code>是一个函数指针：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) p <span class="hljs-built_in">command</span>-&gt;proc<br><span class="hljs-variable">$38</span> = (int (*)(pa_core *, pa_tokenizer *, pa_strbuf *, _Bool *)) 0xfffff7e4ffb0 &lt;pa_cli_command_load&gt;                                                                                          <br>(gdb) s<br>pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaaaddf90, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:422                                                               <br>422     static int pa_cli_command_load(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, bool *fail) &#123;                                                                                              <br>(gdb) bt<br><span class="hljs-comment">#0  pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaaaddf90, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:422</span><br><span class="hljs-comment">#1  0x0000fffff7e5774c in pa_cli_command_execute_line_stateful (c=0xaaaaaaae2ec0, s=0xffffffffd1c8 &quot;load-module module-device-restore&quot;, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505, </span><br>    ifstate=0xffffffffd1c0) at pulsecore/cli-command.c:2136<br><span class="hljs-comment">#2  0x0000fffff7e57a00 in pa_cli_command_execute_file_stream (c=0xaaaaaaae2ec0, f=0xaaaaaaad58f0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:2176</span><br><span class="hljs-comment">#3  0x0000aaaaaaab90ac in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1112</span><br></code></pre></td></tr></table></figure>
<h5 id="command">command</h5>
<p>src/pulsecore/cli-command.c:62</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">command</span> &#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">int</span> (*proc) (pa_core *c, pa_tokenizer*t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail);<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *help;<br>    <span class="hljs-type">unsigned</span> args;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>回调函数总览:</p>
<p>src/pulsecore/cli-command.c:82</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Prototypes for all available commands */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_exit</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_help</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_modules</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_clients</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_cards</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sinks</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sources</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_inputs</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_outputs</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_stat</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_info</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_load</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_unload</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_describe</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_volume</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_input_volume</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_output_volume</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_volume</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_mute</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_mute</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_input_mute</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_output_mute</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_default</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_default</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_kill_client</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_kill_sink_input</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_kill_source_output</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_scache_play</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_scache_remove</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_scache_list</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_scache_load</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_scache_load_dir</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_play_file</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_dump</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_list_shared_props</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_move_sink_input</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_move_source_output</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_vacuum</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_suspend_sink</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_suspend_source</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_suspend</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_log_target</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_log_level</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_log_meta</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_log_time</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_log_backtrace</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_update_sink_proplist</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_update_source_proplist</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_update_sink_input_proplist</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_update_source_output_proplist</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_card_profile</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_sink_port</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_source_port</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_port_offset</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pa_cli_command_dump_volumes</span><span class="hljs-params">(pa_core *c, pa_tokenizer *t, pa_strbuf *buf, <span class="hljs-type">bool</span> *fail)</span>;<br></code></pre></td></tr></table></figure>
<p>到此，pusleaudio整体框架基本介绍差不多了，下文会基于<code>command-&gt;proc</code>介绍<code>/usr/share/pulseaudio/alsa-mixer/profile-sets/</code>、<code>/usr/share/pulseaudio/alsa-mixer/paths/</code>部分。</p>
<h2
id="usrsharepulseaudioalsa-mixerprofile-sets">/usr/share/pulseaudio/alsa-mixer/profile-sets/</h2>
<h3 id="pa_alsa_profile_set_new">pa_alsa_profile_set_new</h3>
<p>解析profile-set</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_config_parse (filename=<span class="hljs-number">0xaaaaaab154c0</span> <span class="hljs-string">&quot;/usr/share/pulseaudio/alsa-mixer/profile-sets/default.conf&quot;</span>, f=<span class="hljs-number">0x0</span>, t=<span class="hljs-number">0xfffff2519640</span> &lt;items&gt;, proplist=<span class="hljs-number">0x0</span>, use_dot_d=<span class="hljs-literal">false</span>, <br>    userdata=<span class="hljs-number">0xaaaaaab28120</span>) at pulsecore/conf-parser.c:<span class="hljs-number">168</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24dcb04</span> in <span class="hljs-title function_">pa_alsa_profile_set_new</span> <span class="hljs-params">(fname=<span class="hljs-number">0xfffff24fa608</span> <span class="hljs-string">&quot;default.conf&quot;</span>, bonus=<span class="hljs-number">0xaaaaaaae2f68</span>)</span> at modules/alsa/alsa-mixer.c:4577<br>#2  0x0000fffff268bc14 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:849<br>#3  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#4  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#5  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#6  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#7  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#8  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#9  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#10 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#11 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#12 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#13 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs c">pa_alsa_profile_set* <span class="hljs-title function_">pa_alsa_profile_set_new</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fname, <span class="hljs-type">const</span> pa_channel_map *bonus)</span> &#123;<br>    pa_alsa_profile_set *ps; <span class="hljs-comment">// 创建一个 pa_alsa_profile_set 结构体指针，用于存储配置文件中的配置信息</span><br>    pa_alsa_profile *p; <span class="hljs-comment">// 创建一个 pa_alsa_profile 结构体指针，用于遍历配置文件中的各个音频配置</span><br>    pa_alsa_mapping *m; <span class="hljs-comment">// 创建一个 pa_alsa_mapping 结构体指针，用于遍历配置文件中的各个音频映射</span><br>    pa_alsa_decibel_fix *db_fix; <span class="hljs-comment">// 创建一个 pa_alsa_decibel_fix 结构体指针，用于遍历配置文件中的各个分贝修正</span><br>    <span class="hljs-type">char</span> *fn; <span class="hljs-comment">// 创建一个字符指针，用于存储配置文件的完整路径</span><br>    <span class="hljs-type">int</span> r; <span class="hljs-comment">// 用于存储函数返回值</span><br>    <span class="hljs-type">void</span> *state; <span class="hljs-comment">// 用于辅助遍历哈希表的状态指针</span><br><br>    <span class="hljs-comment">// 配置项数组，用于解析配置文件中的各个配置项</span><br>    <span class="hljs-type">static</span> pa_config_item items[] = &#123;<br>        <span class="hljs-comment">/* [General] */</span><br>        &#123; <span class="hljs-string">&quot;auto-profiles&quot;</span>,          pa_config_parse_bool,         <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;General&quot;</span> &#125;,<br><br>        <span class="hljs-comment">/* [Mapping ...] */</span><br>        &#123; <span class="hljs-string">&quot;device-strings&quot;</span>,         mapping_parse_device_strings, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;channel-map&quot;</span>,            mapping_parse_channel_map,    <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;paths-input&quot;</span>,            mapping_parse_paths,          <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;paths-output&quot;</span>,           mapping_parse_paths,          <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;element-input&quot;</span>,          mapping_parse_element,        <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;element-output&quot;</span>,         mapping_parse_element,        <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;direction&quot;</span>,              mapping_parse_direction,      <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;exact-channels&quot;</span>,         mapping_parse_exact_channels, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br><br>        <span class="hljs-comment">/* Shared by [Mapping ...] and [Profile ...] */</span><br>        &#123; <span class="hljs-string">&quot;description&quot;</span>,            mapping_parse_description,    <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;priority&quot;</span>,               mapping_parse_priority,       <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;fallback&quot;</span>,               mapping_parse_fallback,       <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br><br>        <span class="hljs-comment">/* [Profile ...] */</span><br>        &#123; <span class="hljs-string">&quot;input-mappings&quot;</span>,         profile_parse_mappings,       <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;output-mappings&quot;</span>,        profile_parse_mappings,       <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;skip-probe&quot;</span>,             profile_parse_skip_probe,     <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br><br>        <span class="hljs-comment">/* [DecibelFix ...] */</span><br>        &#123; <span class="hljs-string">&quot;db-values&quot;</span>,              decibel_fix_parse_db_values,  <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;,<br>        &#123; <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">// 创建一个新的 pa_alsa_profile_set 结构体，将其中的各个哈希表进行初始化</span><br>    ps = pa_xnew0(pa_alsa_profile_set, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// 初始化音频映射、音频配置、分贝修正、路径的哈希表</span><br>    ps-&gt;mappings = pa_hashmap_new_full(pa_idxset_string_hash_func, pa_idxset_string_compare_func, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">pa_free_cb_t</span>) mapping_free);<br>    ps-&gt;profiles = pa_hashmap_new_full(pa_idxset_string_hash_func, pa_idxset_string_compare_func, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">pa_free_cb_t</span>) profile_free);<br>    ps-&gt;decibel_fixes = pa_hashmap_new_full(pa_idxset_string_hash_func, pa_idxset_string_compare_func, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">pa_free_cb_t</span>) decibel_fix_free);<br>    ps-&gt;input_paths = pa_hashmap_new_full(pa_idxset_string_hash_func, pa_idxset_string_compare_func, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">pa_free_cb_t</span>) pa_alsa_path_free);<br>    ps-&gt;output_paths = pa_hashmap_new_full(pa_idxset_string_hash_func, pa_idxset_string_compare_func, <span class="hljs-literal">NULL</span>, (<span class="hljs-type">pa_free_cb_t</span>) pa_alsa_path_free);<br><br>    <span class="hljs-comment">// 初始化自定义路径的哈希表和文件夹</span><br>    ps-&gt;cust_paths = pa_hashmap_new_full(pa_idxset_string_hash_func, pa_idxset_string_compare_func, (<span class="hljs-type">pa_free_cb_t</span>) pa_xfree, (<span class="hljs-type">pa_free_cb_t</span>) pa_xfree);<br>    ps-&gt;cust_folder = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// 配置项数组中的第一个配置项与 ps 结构体中的 auto_profiles 字段关联</span><br>    items[<span class="hljs-number">0</span>].data = &amp;ps-&gt;auto_profiles;<br><br>    <span class="hljs-comment">// 如果没有提供配置文件名，则使用默认的配置文件名</span><br>    <span class="hljs-keyword">if</span> (!fname)<br>        fname = <span class="hljs-string">&quot;default.conf&quot;</span>;<br><br>    <span class="hljs-comment">// 构建配置文件的完整路径</span><br>    fn = pa_maybe_prefix_path(fname,<br>                              pa_run_from_build_tree() ? PA_SRCDIR <span class="hljs-string">&quot;/modules/alsa/mixer/profile-sets/&quot;</span> :<br>                              PA_ALSA_PROFILE_SETS_DIR);<br><br>    <span class="hljs-comment">// 解析配置文件并填充配置信息到 ps 结构体</span><br>    r = pa_config_parse(fn, <span class="hljs-literal">NULL</span>, items, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">false</span>, ps);<br>    pa_xfree(fn);<br><br>    <span class="hljs-comment">// 如果解析失败，则进行清理并返回 NULL</span><br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-comment">// 遍历音频映射并进行验证</span><br>    PA_HASHMAP_FOREACH(m, ps-&gt;mappings, state)<br>        <span class="hljs-keyword">if</span> (mapping_verify(m, bonus) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-comment">// 如果 auto_profiles 为真，则添加自动配置的音频配置</span><br>    <span class="hljs-keyword">if</span> (ps-&gt;auto_profiles)<br>        profile_set_add_auto(ps);<br><br>    <span class="hljs-comment">// 遍历音频配置并进行验证</span><br>    PA_HASHMAP_FOREACH(p, ps-&gt;profiles, state)<br>        <span class="hljs-keyword">if</span> (profile_verify(p) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-comment">// 遍历分贝修正并进行验证</span><br>    PA_HASHMAP_FOREACH(db_fix, ps-&gt;decibel_fixes, state)<br>        <span class="hljs-keyword">if</span> (decibel_fix_verify(db_fix) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-keyword">return</span> ps;<br><br>fail:<br>    <span class="hljs-comment">// 如果解析或验证过程出现错误，则释放资源并返回 NULL</span><br>    pa_alsa_profile_set_free(ps);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="pa_config_parse-1">pa_config_parse</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">src/modules/alsa/alsa-mixer.c:<span class="hljs-number">4577</span><br>src/pulsecore/conf-parser.c:<span class="hljs-number">167</span><br></code></pre></td></tr></table></figure>
<p>参见上方。</p>
<h5 id="parse_line-1">parse_line</h5>
<p>参见上方。</p>
<h6 id="proplist_assignment-1">proplist_assignment</h6>
<p>参见上方。</p>
<h6 id="normal_assignment-1">normal_assignment</h6>
<p>参见上方。</p>
<h4 id="profile_set_add_auto">profile_set_add_auto</h4>
<p>自动将适合的音频配置添加到给定的 <code>pa_alsa_profile_set</code>
中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  profile_set_add_auto (ps=<span class="hljs-number">0xaaaaaab28120</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">4306</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24dcb8c</span> in <span class="hljs-title function_">pa_alsa_profile_set_new</span> <span class="hljs-params">(fname=<span class="hljs-number">0xfffff24fa608</span> <span class="hljs-string">&quot;default.conf&quot;</span>, bonus=<span class="hljs-number">0xaaaaaaae2f68</span>)</span> at modules/alsa/alsa-mixer.c:4588                                   <br>#2  0x0000fffff268bc14 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:849                                                                 <br>#3  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>,                                                        </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#4  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#5  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#6  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#7  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#8  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#9  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#10 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#11 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>,     </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#12 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#13 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自动将适合的音频配置添加到给定的 `pa_alsa_profile_set` 中。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param ps 要操作的 pa_alsa_profile_set 结构。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">profile_set_add_auto</span><span class="hljs-params">(pa_alsa_profile_set *ps)</span> &#123;<br>    pa_alsa_mapping *m, *n;<br>    <span class="hljs-type">void</span> *m_state, *n_state;<br><br>    pa_assert(ps);<br><br>    <span class="hljs-comment">/* 在这里的顺序很重要：</span><br><span class="hljs-comment">       1) 在尝试其组合之前，先尝试单独的输入和输出，因为如果半双工测试失败，我们不必尝试全双工。</span><br><span class="hljs-comment">       2) 尝试在与该输出组合的输入组合之前，因为在测试之间不会关闭 output_pcm。</span><br><span class="hljs-comment">    */</span><br>    PA_HASHMAP_FOREACH(n, ps-&gt;mappings, n_state)<br>        profile_set_add_auto_pair(ps, <span class="hljs-literal">NULL</span>, n);<br><br>    PA_HASHMAP_FOREACH(m, ps-&gt;mappings, m_state) &#123;<br>        profile_set_add_auto_pair(ps, m, <span class="hljs-literal">NULL</span>);<br><br>        PA_HASHMAP_FOREACH(n, ps-&gt;mappings, n_state)<br>            profile_set_add_auto_pair(ps, m, n);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="profile_set_add_auto_pair">profile_set_add_auto_pair</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  profile_set_add_auto_pair (ps=<span class="hljs-number">0xaaaaaab28120</span>, m=<span class="hljs-number">0xaaaaaab28970</span>, n=<span class="hljs-number">0xaaaaaab28970</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">4262</span>                                                           <br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24dbc5c</span> in <span class="hljs-title function_">profile_set_add_auto</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>)</span> at modules/alsa/alsa-mixer.c:4326                                                                              <br>#2  0x0000fffff24dcb8c in <span class="hljs-title function_">pa_alsa_profile_set_new</span> <span class="hljs-params">(fname=<span class="hljs-number">0xfffff24fa608</span> <span class="hljs-string">&quot;default.conf&quot;</span>, bonus=<span class="hljs-number">0xaaaaaaae2f68</span>)</span> at modules/alsa/alsa-mixer.c:4588                                   <br>#3  0x0000fffff268bc14 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:849                                                                 <br>#4  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>,                                                        </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#5  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#6  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#7  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#8  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#9  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#10 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#11 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#12 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>,     </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#13 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#14 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">profile_set_add_auto_pair</span><span class="hljs-params">(</span><br><span class="hljs-params">        pa_alsa_profile_set *ps,</span><br><span class="hljs-params">        pa_alsa_mapping *m, <span class="hljs-comment">/* output */</span></span><br><span class="hljs-params">        pa_alsa_mapping *n  <span class="hljs-comment">/* input */</span>)</span> &#123;<br><br>    <span class="hljs-type">char</span> *name;<br>    pa_alsa_profile *p;<br><br>    pa_assert(ps);<br>    pa_assert(m || n);<br><br>    <span class="hljs-comment">// 如果映射为输入，不添加配对</span><br>    <span class="hljs-keyword">if</span> (m &amp;&amp; m-&gt;direction == PA_ALSA_DIRECTION_INPUT)<br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// 如果映射为输出，不添加配对</span><br>    <span class="hljs-keyword">if</span> (n &amp;&amp; n-&gt;direction == PA_ALSA_DIRECTION_OUTPUT)<br>        <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// 根据映射创建唯一配对名称</span><br>    <span class="hljs-keyword">if</span> (m &amp;&amp; n)<br>        name = pa_sprintf_malloc(<span class="hljs-string">&quot;output:%s+input:%s&quot;</span>, m-&gt;name, n-&gt;name);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m)<br>        name = pa_sprintf_malloc(<span class="hljs-string">&quot;output:%s&quot;</span>, m-&gt;name);<br>    <span class="hljs-keyword">else</span><br>        name = pa_sprintf_malloc(<span class="hljs-string">&quot;input:%s&quot;</span>, n-&gt;name);<br><br>    <span class="hljs-comment">// 如果已经存在同名的配置，不添加配对</span><br>    <span class="hljs-keyword">if</span> (pa_hashmap_get(ps-&gt;profiles, name)) &#123;<br>        pa_xfree(name);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 创建新的alsa配置文件配置</span><br>    p = pa_xnew0(pa_alsa_profile, <span class="hljs-number">1</span>);<br>    p-&gt;profile_set = ps;<br>    p-&gt;name = name;<br><br>    <span class="hljs-comment">// 处理输出映射</span><br>    <span class="hljs-keyword">if</span> (m) &#123;<br>        p-&gt;output_name = pa_xstrdup(m-&gt;name);<br>        p-&gt;output_mappings = pa_idxset_new(pa_idxset_trivial_hash_func, pa_idxset_trivial_compare_func);<br>        pa_idxset_put(p-&gt;output_mappings, m, <span class="hljs-literal">NULL</span>);<br>        p-&gt;priority += m-&gt;priority * <span class="hljs-number">100</span>;<br>        p-&gt;fallback_output = m-&gt;fallback;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理输入映射</span><br>    <span class="hljs-keyword">if</span> (n) &#123;<br>        p-&gt;input_name = pa_xstrdup(n-&gt;name);<br>        p-&gt;input_mappings = pa_idxset_new(pa_idxset_trivial_hash_func, pa_idxset_trivial_compare_func);<br>        pa_idxset_put(p-&gt;input_mappings, n, <span class="hljs-literal">NULL</span>);<br>        p-&gt;priority += n-&gt;priority;<br>        p-&gt;fallback_input = n-&gt;fallback;<br>    &#125;<br><br>    <span class="hljs-comment">// 添加新配置到哈希表</span><br>    pa_hashmap_put(ps-&gt;profiles, p-&gt;name, p);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3
id="pa_alsa_profile_set_cust_paths">pa_alsa_profile_set_cust_paths</h3>
<p>将自定义path添加到profile_set哈希映射中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">Breakpoint <span class="hljs-number">33</span>, pa_alsa_profile_set_cust_paths (ps=<span class="hljs-number">0xaaaaaab28270</span>, cust_folder=<span class="hljs-number">0xaaaaaac6a780</span> <span class="hljs-string">&quot;cust/P710&quot;</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">4747</span>                                       <br>warning: Source file is more recent than executable.<br><span class="hljs-number">4747</span>        pa_assert(ps);<br>(gdb) s<br><span class="hljs-number">4748</span>        pa_assert(cust_folder);<br>(gdb) bt<br>#<span class="hljs-number">0</span>  pa_alsa_profile_set_cust_paths (ps=<span class="hljs-number">0xaaaaaab28270</span>, cust_folder=<span class="hljs-number">0xaaaaaac6a780</span> <span class="hljs-string">&quot;cust/P710&quot;</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">4748</span>                                                  <br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff268bcd0</span> in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:868                                                                 <br>#2  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>,                                                        </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#3  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#4  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#5  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#6  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#7  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#8  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#9  0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#10 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>,     </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#11 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#12 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br><span class="hljs-params">(gdb)</span> fin<br>Run till <span class="hljs-built_in">exit</span> from #0  <span class="hljs-title function_">pa_alsa_profile_set_cust_paths</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28270</span>, cust_folder=<span class="hljs-number">0xaaaaaac6a780</span> <span class="hljs-string">&quot;cust/P710&quot;</span>)</span> at modules/alsa/alsa-mixer.c:4748                               <br><span class="hljs-params">(  <span class="hljs-number">13.293</span>|  <span class="hljs-number">11.844</span>)</span> D: [pulseaudio][modules/alsa/alsa-mixer.c:4751 <span class="hljs-title function_">pa_alsa_profile_set_cust_paths</span><span class="hljs-params">()</span>] Analyzing directory: &#x27;/usr/share/pulseaudio/alsa-mixer/paths&#x27;                <br><span class="hljs-params">(  <span class="hljs-number">13.293</span>|   <span class="hljs-number">0.000</span>)</span> D: [pulseaudio][modules/alsa/alsa-mixer.c:4755 <span class="hljs-title function_">pa_alsa_profile_set_cust_paths</span><span class="hljs-params">()</span>] open directory: &#x27;/usr/share/pulseaudio/alsa-mixer/paths/cust/P710&#x27;           <br><span class="hljs-params">(  <span class="hljs-number">13.293</span>|   <span class="hljs-number">0.000</span>)</span> W: [pulseaudio][modules/alsa/alsa-mixer.c:4758 <span class="hljs-title function_">pa_alsa_profile_set_cust_paths</span><span class="hljs-params">()</span>] Failed to open /usr/share/pulseaudio/alsa-mixer/paths/cust/P710 <br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">pa_alsa_profile_set_cust_paths</span><span class="hljs-params">(pa_alsa_profile_set *ps, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cust_folder)</span> &#123;<br><br>    DIR *dir;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">ent</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *paths_dir;<br>    <span class="hljs-type">char</span> *fn;<br>    <span class="hljs-type">char</span> *key;<br>    <span class="hljs-type">char</span> *value;<br><br>    pa_assert(ps);<br>    pa_assert(cust_folder);<br><br>    <span class="hljs-comment">// 获取默认路径目录</span><br>    paths_dir = get_default_paths_dir();<br>    pa_log_debug(<span class="hljs-string">&quot;Analyzing directory: &#x27;%s&#x27;&quot;</span>, paths_dir);<br><br>    <span class="hljs-comment">// 构建路径名称</span><br>    fn = pa_maybe_prefix_path(cust_folder, paths_dir);<br><br>    pa_log_debug(<span class="hljs-string">&quot;open directory: &#x27;%s&#x27;&quot;</span>, fn);<br><br>    <span class="hljs-comment">// 打开目录并遍历文件</span><br>    <span class="hljs-keyword">if</span> (!(dir = opendir(fn))) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;Failed to open %s&quot;</span>, fn);<br>        pa_xfree(fn);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> ((ent = readdir(dir)) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-comment">// 忽略 . 和 .. 目录</span><br>        <span class="hljs-keyword">if</span> (pa_streq(ent-&gt;d_name, <span class="hljs-string">&quot;.&quot;</span>) || pa_streq(ent-&gt;d_name, <span class="hljs-string">&quot;..&quot;</span>))<br>            <span class="hljs-keyword">continue</span>;<br>        pa_log_debug(<span class="hljs-string">&quot;Analyzing file: &#x27;%s&#x27;&quot;</span>, ent-&gt;d_name);<br><br>        <span class="hljs-comment">// 使用文件名作为键，构建完整路径作为值</span><br>        key = pa_xstrndup(ent-&gt;d_name, <span class="hljs-built_in">strlen</span>(ent-&gt;d_name));<br>        value = pa_maybe_prefix_path(key, cust_folder);<br><br>        <span class="hljs-comment">// 将路径添加到自定义路径的哈希映射中</span><br>        pa_hashmap_put(ps-&gt;cust_paths, key, value);<br>        pa_log_debug(<span class="hljs-string">&quot;ps-&gt;cust_paths file: &#x27;%s&#x27;, &#x27;%s&#x27;&quot;</span>, key, value);<br><br>    &#125;<br>    closedir(dir);<br><br>    pa_xfree(fn);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="pa_alsa_profile_set_probe">pa_alsa_profile_set_probe</h3>
<p>探测pcm是否可用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">#<span class="hljs-number">0</span>  pa_alsa_profile_set_probe (ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)<br>    at modules/alsa/alsa-mixer.c:<span class="hljs-number">4787</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff268bd10</span> in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#2  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#3  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#4  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#5  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#6  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#7  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#8  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#9  0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#10 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#11 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#12 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">pa_alsa_profile_set_probe</span><span class="hljs-params">(</span><br><span class="hljs-params">        pa_alsa_profile_set *ps,               <span class="hljs-comment">// ALSA 音频配置集合</span></span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_id,                    <span class="hljs-comment">// 设备标识符</span></span><br><span class="hljs-params">        <span class="hljs-type">const</span> pa_sample_spec *ss,               <span class="hljs-comment">// 采样规格</span></span><br><span class="hljs-params">        <span class="hljs-type">unsigned</span> default_n_fragments,           <span class="hljs-comment">// 默认分片数</span></span><br><span class="hljs-params">        <span class="hljs-type">unsigned</span> default_fragment_size_msec)</span> &#123;  <span class="hljs-comment">// 默认分片大小（毫秒）</span><br><br>    <span class="hljs-type">bool</span> found_output = <span class="hljs-literal">false</span>, found_input = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 是否找到输出和输入配置</span><br><br>    pa_alsa_profile *p, *last = <span class="hljs-literal">NULL</span>;      <span class="hljs-comment">// 当前配置和上一个配置</span><br>    pa_alsa_profile **pp, **probe_order;   <span class="hljs-comment">// 配置探测顺序数组</span><br>    pa_alsa_mapping *m;                     <span class="hljs-comment">// ALSA 映射</span><br>    pa_hashmap *broken_inputs, *broken_outputs, *used_paths;  <span class="hljs-comment">// 存储损坏输入、损坏输出和已使用路径的哈希映射</span><br>    pa_alsa_mapping *selected_fallback_input = <span class="hljs-literal">NULL</span>, *selected_fallback_output = <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">// 选定的回退输入和输出映射</span><br><br>    pa_assert(ps);           <span class="hljs-comment">// 断言配置集合存在</span><br>    pa_assert(dev_id);       <span class="hljs-comment">// 断言设备标识符存在</span><br>    pa_assert(ss);           <span class="hljs-comment">// 断言采样规格存在</span><br><br>    <span class="hljs-comment">// 创建哈希映射来存储损坏的输入、输出和已使用的路径</span><br>    broken_inputs = pa_hashmap_new(pa_idxset_trivial_hash_func, pa_idxset_trivial_compare_func);<br>    broken_outputs = pa_hashmap_new(pa_idxset_trivial_hash_func, pa_idxset_trivial_compare_func);<br>    used_paths = pa_hashmap_new(pa_idxset_trivial_hash_func, pa_idxset_trivial_compare_func);<br><br>    <span class="hljs-comment">// 创建用于指示探测顺序的 probe_order 数组</span><br>    pp = probe_order = pa_xnew0(pa_alsa_profile *, pa_hashmap_size(ps-&gt;profiles) + <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// 将配置按一定的优先级顺序添加到探测顺序中</span><br>    pp += add_profiles_to_probe(pp, ps-&gt;profiles, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>    pp += add_profiles_to_probe(pp, ps-&gt;profiles, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>    pp += add_profiles_to_probe(pp, ps-&gt;profiles, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    pp += add_profiles_to_probe(pp, ps-&gt;profiles, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// 遍历探测顺序中的配置</span><br>    <span class="hljs-keyword">for</span> (pp = probe_order; *pp; pp++) &#123;<br>        <span class="hljs-type">uint32_t</span> idx;<br>        p = *pp;<br><br>        <span class="hljs-comment">// 跳过已经找到的回退配置，但仍然探测已选的回退配置</span><br>        <span class="hljs-keyword">if</span> (found_input &amp;&amp; p-&gt;fallback_input)<br>            <span class="hljs-keyword">if</span> (selected_fallback_input == <span class="hljs-literal">NULL</span> || pa_idxset_get_by_index(p-&gt;input_mappings, <span class="hljs-number">0</span>) != selected_fallback_input)<br>                <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span> (found_output &amp;&amp; p-&gt;fallback_output)<br>            <span class="hljs-keyword">if</span> (selected_fallback_output == <span class="hljs-literal">NULL</span> || pa_idxset_get_by_index(p-&gt;output_mappings, <span class="hljs-number">0</span>) != selected_fallback_output)<br>                <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">// 跳过已经标记为支持的配置</span><br>        <span class="hljs-keyword">if</span> (!p-&gt;supported) &#123;<br>            <span class="hljs-comment">// 最终化配置探测</span><br>            profile_finalize_probing(last, p);<br>            p-&gt;supported = <span class="hljs-literal">true</span>;<br><br>            <span class="hljs-comment">// 检查输出映射是否能够打开</span><br>            <span class="hljs-keyword">if</span> (p-&gt;output_mappings) &#123;<br>                PA_IDXSET_FOREACH(m, p-&gt;output_mappings, idx) &#123;<br>                    <span class="hljs-keyword">if</span> (pa_hashmap_get(broken_outputs, m) == m) &#123;<br>                        <span class="hljs-comment">// 标记为不支持的配置</span><br>                        pa_log_debug(<span class="hljs-string">&quot;Skipping profile %s - will not be able to open output:%s&quot;</span>, p-&gt;name, m-&gt;name);<br>                        p-&gt;supported = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 检查输入映射是否能够打开</span><br>            <span class="hljs-keyword">if</span> (p-&gt;input_mappings &amp;&amp; p-&gt;supported) &#123;<br>                PA_IDXSET_FOREACH(m, p-&gt;input_mappings, idx) &#123;<br>                    <span class="hljs-keyword">if</span> (pa_hashmap_get(broken_inputs, m) == m) &#123;<br>                        <span class="hljs-comment">// 标记为不支持的配置</span><br>                        pa_log_debug(<span class="hljs-string">&quot;Skipping profile %s - will not be able to open input:%s&quot;</span>, p-&gt;name, m-&gt;name);<br>                        p-&gt;supported = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (p-&gt;supported)<br>                pa_log_debug(<span class="hljs-string">&quot;Looking at profile %s&quot;</span>, p-&gt;name);<br><br>            <span class="hljs-comment">// 检查是否可以打开所有新的映射</span><br>            <span class="hljs-keyword">if</span> (p-&gt;output_mappings &amp;&amp; p-&gt;supported)<br>                PA_IDXSET_FOREACH(m, p-&gt;output_mappings, idx) &#123;<br>                    <span class="hljs-comment">// 检查是否已经打开</span><br>                    <span class="hljs-keyword">if</span> (m-&gt;output_pcm)<br>                        <span class="hljs-keyword">continue</span>;<br><br>                    <span class="hljs-comment">// 尝试打开 PCM 设备</span><br>                    pa_log_debug(<span class="hljs-string">&quot;Checking for playback on %s (%s)&quot;</span>, m-&gt;description, m-&gt;name);<br>                    <span class="hljs-keyword">if</span> (!(m-&gt;output_pcm = mapping_open_pcm(m, ss, dev_id, m-&gt;exact_channels,<br>                                                           SND_PCM_STREAM_PLAYBACK,<br>                                                           default_n_fragments,<br>                                                           default_fragment_size_msec))) &#123;<br>                        <span class="hljs-comment">// 标记为不支持的配置</span><br>                        p-&gt;supported = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">if</span> (pa_idxset_size(p-&gt;output_mappings) == <span class="hljs-number">1</span> &amp;&amp;<br>                            ((!p-&gt;input_mappings) || pa_idxset_size(p-&gt;input_mappings) == <span class="hljs-number">0</span>)) &#123;<br>                            pa_log_debug(<span class="hljs-string">&quot;Caching failure to open output:%s&quot;</span>, m-&gt;name);<br>                            pa_hashmap_put(broken_outputs, m, m);<br>                        &#125;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (m-&gt;hw_device_index &lt; <span class="hljs-number">0</span>)<br>                        mapping_query_hw_device(m, m-&gt;output_pcm);<br>                &#125;<br><br>            <span class="hljs-comment">// 检查输入映射是否能够打开</span><br>            <span class="hljs-keyword">if</span> (p-&gt;input_mappings &amp;&amp; p-&gt;supported)<br>                PA_IDXSET_FOREACH(m, p-&gt;input_mappings, idx) &#123;<br>                    <span class="hljs-comment">// 检查是否已经打开</span><br>                    <span class="hljs-keyword">if</span> (m-&gt;input_pcm)<br>                        <span class="hljs-keyword">continue</span>;<br><br>                    <span class="hljs-comment">// 尝试打开 PCM 设备</span><br>                    pa_log_debug(<span class="hljs-string">&quot;Checking for recording on %s (%s)&quot;</span>, m-&gt;description, m-&gt;name);<br>                    <span class="hljs-keyword">if</span> (!(m-&gt;input_pcm = mapping_open_pcm(m, ss, dev_id, m-&gt;exact_channels,<br>                                                          SND_PCM_STREAM_CAPTURE,<br>                                                          default_n_fragments,<br>                                                          default_fragment_size_msec))) &#123;<br>                        <span class="hljs-comment">// 标记为不支持的配置</span><br>                        p-&gt;supported = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">if</span> (pa_idxset_size(p-&gt;input_mappings) == <span class="hljs-number">1</span> &amp;&amp;<br>                            ((!p-&gt;output_mappings) || pa_idxset_size(p-&gt;output_mappings) == <span class="hljs-number">0</span>)) &#123;<br>                            pa_log_debug(<span class="hljs-string">&quot;Caching failure to open input:%s&quot;</span>, m-&gt;name);<br>                            pa_hashmap_put(broken_inputs, m, m);<br>                        &#125;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (m-&gt;hw_device_index &lt; <span class="hljs-number">0</span>)<br>                        mapping_query_hw_device(m, m-&gt;input_pcm);<br>                &#125;<br><br>            last = p;<br><br>            <span class="hljs-keyword">if</span> (!p-&gt;supported)<br>                <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        pa_log_debug(<span class="hljs-string">&quot;Profile %s supported.&quot;</span>, p-&gt;name);<br><br>        <span class="hljs-comment">// 标记已找到输出和输入配置</span><br>        <span class="hljs-keyword">if</span> (p-&gt;output_mappings)<br>            PA_IDXSET_FOREACH(m, p-&gt;output_mappings, idx)<br>                <span class="hljs-keyword">if</span> (m-&gt;output_pcm) &#123;<br>                    found_output = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">if</span> (p-&gt;fallback_output &amp;&amp; selected_fallback_output == <span class="hljs-literal">NULL</span>) &#123;<br>                        selected_fallback_output = m;<br>                    &#125;<br>                    mapping_paths_probe(m, p, PA_ALSA_DIRECTION_OUTPUT, used_paths);<br>                &#125;<br><br>        <span class="hljs-keyword">if</span> (p-&gt;input_mappings)<br>            PA_IDXSET_FOREACH(m, p-&gt;input_mappings, idx)<br>                <span class="hljs-keyword">if</span> (m-&gt;input_pcm) &#123;<br>                    found_input = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">if</span> (p-&gt;fallback_input &amp;&amp; selected_fallback_input == <span class="hljs-literal">NULL</span>) &#123;<br>                        selected_fallback_input = m;<br>                    &#125;<br>                    mapping_paths_probe(m, p, PA_ALSA_DIRECTION_INPUT, used_paths);<br>                &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 最终化配置探测，清理资源</span><br>    profile_finalize_probing(last, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// 丢弃不支持的配置</span><br>    pa_alsa_profile_set_drop_unsupported(ps);<br><br>    <span class="hljs-comment">// 丢弃未使用的路径</span><br>    paths_drop_unused(ps-&gt;input_paths, used_paths);<br>    paths_drop_unused(ps-&gt;output_paths, used_paths);<br><br>    <span class="hljs-comment">// 释放资源</span><br>    pa_hashmap_free(broken_inputs);<br>    pa_hashmap_free(broken_outputs);<br>    pa_hashmap_free(used_paths);<br>    pa_xfree(probe_order);<br><br>    ps-&gt;probed = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 标记为已完成探测</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="add_profiles_to_probe">add_profiles_to_probe</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  add_profiles_to_probe (<span class="hljs-built_in">list</span>=<span class="hljs-number">0xaaaaaac6bd50</span>, profiles=<span class="hljs-number">0xaaaaaab292a0</span>, fallback_output=<span class="hljs-literal">false</span>, fallback_input=<span class="hljs-literal">false</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">4705</span>                           <br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24dd90c</span> in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab280c0</span>, dev_id=<span class="hljs-number">0xaaaaaab123f0</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span>       <br>    at modules/alsa/alsa-mixer.c:4809<br>#2  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f3f0</span>)</span> at modules/alsa/module-alsa-card.c:871                                                                 <br>#3  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>,                                                        </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaade630</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#4  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab036a0</span>, d=<span class="hljs-number">0xaaaaaab07190</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#5  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab036a0</span>, dev=<span class="hljs-number">0xaaaaaaadda70</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#6  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab036a0</span>, dev=<span class="hljs-number">0xaaaaaaadda70</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#7  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab036a0</span>, path=<span class="hljs-number">0xaaaaaab18aa0</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#8  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00dc0</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#9  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab01150</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#10 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab01170</span>, buf=<span class="hljs-number">0xaaaaaaadbed0</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#11 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadbed0</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>,     </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#12 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadbed0</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#13 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_profiles_to_probe</span><span class="hljs-params">(</span><br><span class="hljs-params">        pa_alsa_profile **<span class="hljs-built_in">list</span>,       <span class="hljs-comment">// 存储配置指针的列表</span></span><br><span class="hljs-params">        pa_hashmap *profiles,          <span class="hljs-comment">// ALSA 音频配置哈希映射</span></span><br><span class="hljs-params">        <span class="hljs-type">bool</span> fallback_output,          <span class="hljs-comment">// 是否是回退输出配置</span></span><br><span class="hljs-params">        <span class="hljs-type">bool</span> fallback_input)</span> &#123;         <span class="hljs-comment">// 是否是回退输入配置</span><br><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;                       <span class="hljs-comment">// 配置计数器</span><br>    <span class="hljs-type">void</span> *state;<br>    pa_alsa_profile *p;<br><br>    <span class="hljs-comment">// 遍历配置哈希映射，根据回退设置筛选配置</span><br>    PA_HASHMAP_FOREACH(p, profiles, state)<br>        <span class="hljs-keyword">if</span> (p-&gt;fallback_input == fallback_input &amp;&amp; p-&gt;fallback_output == fallback_output) &#123;<br>            *<span class="hljs-built_in">list</span> = p;                 <span class="hljs-comment">// 将符合条件的配置指针添加到列表中</span><br>            <span class="hljs-built_in">list</span>++;<br>            i++;<br>        &#125;<br>    <span class="hljs-keyword">return</span> i;                         <span class="hljs-comment">// 返回筛选出的配置数量</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="mapping_open_pcm">mapping_open_pcm</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  mapping_open_pcm (m=<span class="hljs-number">0xaaaaaab28ba0</span>, ss=<span class="hljs-number">0xaaaaaaae30fc</span>, dev_id=<span class="hljs-number">0xaaaaaab12550</span> <span class="hljs-string">&quot;0&quot;</span>, exact_channels=<span class="hljs-literal">true</span>, mode=<span class="hljs-number">1</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)<br>    at modules/alsa/alsa-mixer.c:<span class="hljs-number">4657</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24ddf28</span> in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28350</span>, dev_id=<span class="hljs-number">0xaaaaaab12550</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae30fc</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4891<br>#2  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f550</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#3  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2fd0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd690</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#4  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03800</span>, d=<span class="hljs-number">0xaaaaaab072f0</span>)</span> at modules/module-udev-detect.c:333<br>#5  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03800</span>, dev=<span class="hljs-number">0xaaaaaaaddee0</span>)</span> at modules/module-udev-detect.c:422<br>#6  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03800</span>, dev=<span class="hljs-number">0xaaaaaaaddee0</span>)</span> at modules/module-udev-detect.c:464<br>#7  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03800</span>, path=<span class="hljs-number">0xaaaaaab18c00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#8  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00f20</span>)</span> at modules/module-udev-detect.c:789<br>#9  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2fd0</span>, name=<span class="hljs-number">0xaaaaaab012b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#10 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2fd0</span>, t=<span class="hljs-number">0xaaaaaab012d0</span>, buf=<span class="hljs-number">0xaaaaaaadb270</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#11 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2fd0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadb270</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#12 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2fd0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadb270</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#13 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">snd_pcm_t</span>* <span class="hljs-title function_">mapping_open_pcm</span><span class="hljs-params">(pa_alsa_mapping *m,</span><br><span class="hljs-params">                                   <span class="hljs-type">const</span> pa_sample_spec *ss,</span><br><span class="hljs-params">                                   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_id,</span><br><span class="hljs-params">                                   <span class="hljs-type">bool</span> exact_channels,</span><br><span class="hljs-params">                                   <span class="hljs-type">int</span> mode,</span><br><span class="hljs-params">                                   <span class="hljs-type">unsigned</span> default_n_fragments,</span><br><span class="hljs-params">                                   <span class="hljs-type">unsigned</span> default_fragment_size_msec)</span> &#123;<br><br>    <span class="hljs-type">snd_pcm_t</span>* handle;<br>    pa_sample_spec try_ss = *ss;<br>    pa_channel_map try_map = m-&gt;channel_map;<br>    <span class="hljs-type">snd_pcm_uframes_t</span> try_period_size, try_buffer_size;<br><br>    <span class="hljs-comment">// 尝试使用匹配通道数的采样规格</span><br>    try_ss.channels = try_map.channels;<br><br>    <span class="hljs-comment">// 计算尝试的周期大小和缓冲区大小</span><br>    try_period_size =<br>        pa_usec_to_bytes(default_fragment_size_msec * PA_USEC_PER_MSEC, &amp;try_ss) /<br>        pa_frame_size(&amp;try_ss);<br>    try_buffer_size = default_n_fragments * try_period_size;<br><br>    <span class="hljs-comment">// 使用模板尝试打开 ALSA 设备</span><br>    handle = pa_alsa_open_by_template(<br>                              m-&gt;device_strings, dev_id, <span class="hljs-literal">NULL</span>, &amp;try_ss,<br>                              &amp;try_map, mode, &amp;try_period_size,<br>                              &amp;try_buffer_size, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, exact_channels);<br><br>    <span class="hljs-comment">// 如果成功打开设备并且通道数有变化，则更新通道映射</span><br>    <span class="hljs-keyword">if</span> (handle &amp;&amp; !exact_channels &amp;&amp; m-&gt;channel_map.channels != try_map.channels) &#123;<br>        <span class="hljs-type">char</span> buf[PA_CHANNEL_MAP_SNPRINT_MAX];<br>        pa_log_debug(<span class="hljs-string">&quot;Channel map for mapping &#x27;%s&#x27; permanently changed to &#x27;%s&#x27;&quot;</span>, m-&gt;name,<br>                     pa_channel_map_snprint(buf, <span class="hljs-keyword">sizeof</span>(buf), &amp;try_map));<br>        m-&gt;channel_map = try_map;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> handle;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="pa_alsa_open_by_template">pa_alsa_open_by_template</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_alsa_open_by_template (template=<span class="hljs-number">0xaaaaaab154c0</span>, dev_id=<span class="hljs-number">0xaaaaaab125e0</span> <span class="hljs-string">&quot;0&quot;</span>, dev=<span class="hljs-number">0x0</span>, ss=<span class="hljs-number">0xffffffffc940</span>, <span class="hljs-built_in">map</span>=<span class="hljs-number">0xffffffffc950</span>, mode=<span class="hljs-number">1</span>, period_size=<span class="hljs-number">0xffffffffc928</span>, <br>    buffer_size=<span class="hljs-number">0xffffffffc930</span>, tsched_size=<span class="hljs-number">0</span>, use_mmap=<span class="hljs-number">0x0</span>, use_tsched=<span class="hljs-number">0x0</span>, require_exact_channel_number=<span class="hljs-literal">true</span>) at modules/alsa/alsa-util.c:<span class="hljs-number">791</span><br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24dcfd0</span> in <span class="hljs-title function_">mapping_open_pcm</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab28b00</span>, ss=<span class="hljs-number">0xaaaaaaae30fc</span>, dev_id=<span class="hljs-number">0xaaaaaab125e0</span> <span class="hljs-string">&quot;0&quot;</span>, exact_channels=<span class="hljs-literal">true</span>, mode=<span class="hljs-number">1</span>, default_n_fragments=<span class="hljs-number">4</span>, </span><br><span class="hljs-params">    default_fragment_size_msec=<span class="hljs-number">25</span>)</span> at modules/alsa/alsa-mixer.c:4671<br>#2  0x0000fffff24ddf28 in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab282b0</span>, dev_id=<span class="hljs-number">0xaaaaaab125e0</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae30fc</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4891<br>#3  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f5e0</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#4  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2fd0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd9b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#5  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03890</span>, d=<span class="hljs-number">0xaaaaaab07380</span>)</span> at modules/module-udev-detect.c:333<br>#6  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03890</span>, dev=<span class="hljs-number">0xaaaaaaaddcd0</span>)</span> at modules/module-udev-detect.c:422<br>#7  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03890</span>, dev=<span class="hljs-number">0xaaaaaaaddcd0</span>)</span> at modules/module-udev-detect.c:464<br>#8  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03890</span>, path=<span class="hljs-number">0xaaaaaab18c90</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#9  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00fb0</span>)</span> at modules/module-udev-detect.c:789<br>#10 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2fd0</span>, name=<span class="hljs-number">0xaaaaaab01340</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#11 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2fd0</span>, t=<span class="hljs-number">0xaaaaaab01360</span>, buf=<span class="hljs-number">0xaaaaaaad7e70</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#12 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2fd0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaad7e70</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#13 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2fd0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaad7e70</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#14 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">snd_pcm_t</span> *<span class="hljs-title function_">pa_alsa_open_by_template</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-type">char</span> **template,</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_id,</span><br><span class="hljs-params">        <span class="hljs-type">char</span> **dev,</span><br><span class="hljs-params">        pa_sample_spec *ss,</span><br><span class="hljs-params">        pa_channel_map* <span class="hljs-built_in">map</span>,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> mode,</span><br><span class="hljs-params">        <span class="hljs-type">snd_pcm_uframes_t</span> *period_size,</span><br><span class="hljs-params">        <span class="hljs-type">snd_pcm_uframes_t</span> *buffer_size,</span><br><span class="hljs-params">        <span class="hljs-type">snd_pcm_uframes_t</span> tsched_size,</span><br><span class="hljs-params">        <span class="hljs-type">bool</span> *use_mmap,</span><br><span class="hljs-params">        <span class="hljs-type">bool</span> *use_tsched,</span><br><span class="hljs-params">        <span class="hljs-type">bool</span> require_exact_channel_number)</span> &#123;<br><br>    <span class="hljs-type">snd_pcm_t</span> *pcm_handle;<br>    <span class="hljs-type">char</span> **i;<br><br>    <span class="hljs-comment">// 遍历模板列表尝试打开 ALSA 设备</span><br>    <span class="hljs-keyword">for</span> (i = template; *i; i++) &#123;<br>        <span class="hljs-type">char</span> *d;<br><br>        <span class="hljs-comment">// 替换模板中的占位符，最终d指向了某个pcm设备，如hw0</span><br>        d = pa_replace(*i, <span class="hljs-string">&quot;%f&quot;</span>, dev_id);<br><br>        <span class="hljs-comment">// 通过设备字符串打开 ALSA 设备</span><br>        pcm_handle = pa_alsa_open_by_device_string(<br>                d,<br>                dev,<br>                ss,<br>                <span class="hljs-built_in">map</span>,<br>                mode,<br>                period_size,<br>                buffer_size,<br>                tsched_size,<br>                use_mmap,<br>                use_tsched,<br>                require_exact_channel_number);<br><br>        pa_xfree(d);<br><br>        <span class="hljs-comment">// 如果成功打开设备，则返回 PCM 句柄</span><br>        <span class="hljs-keyword">if</span> (pcm_handle)<br>            <span class="hljs-keyword">return</span> pcm_handle;<br>    &#125;<br><br>    <span class="hljs-comment">// 未能成功打开设备，返回 NULL</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h6
id="pa_alsa_open_by_device_string">pa_alsa_open_by_device_string</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  pa_alsa_open_by_device_string (device=<span class="hljs-number">0xaaaaaac6a790</span> <span class="hljs-string">&quot;hw:0&quot;</span>, dev=<span class="hljs-number">0x0</span>, ss=<span class="hljs-number">0xffffffffc940</span>, <span class="hljs-built_in">map</span>=<span class="hljs-number">0xffffffffc950</span>, mode=<span class="hljs-number">1</span>, period_size=<span class="hljs-number">0xffffffffc928</span>, buffer_size=<span class="hljs-number">0xffffffffc930</span>,  <br>    tsched_size=<span class="hljs-number">0</span>, use_mmap=<span class="hljs-number">0x0</span>, use_tsched=<span class="hljs-number">0x0</span>, require_exact_channel_number=<span class="hljs-literal">true</span>) at modules/alsa/alsa-util.c:<span class="hljs-number">686</span>                                                               <br>#<span class="hljs-number">1</span>  <span class="hljs-number">0x0000fffff24bf87c</span> in <span class="hljs-title function_">pa_alsa_open_by_template</span> <span class="hljs-params">(template=<span class="hljs-number">0xaaaaaab15330</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, dev=<span class="hljs-number">0x0</span>, ss=<span class="hljs-number">0xffffffffc940</span>, <span class="hljs-built_in">map</span>=<span class="hljs-number">0xffffffffc950</span>, mode=<span class="hljs-number">1</span>,                   </span><br><span class="hljs-params">    period_size=<span class="hljs-number">0xffffffffc928</span>, buffer_size=<span class="hljs-number">0xffffffffc930</span>, tsched_size=<span class="hljs-number">0</span>, use_mmap=<span class="hljs-number">0x0</span>, use_tsched=<span class="hljs-number">0x0</span>, require_exact_channel_number=<span class="hljs-literal">true</span>)</span> at modules/alsa/alsa-util.c:796       <br>#2  0x0000fffff24dcfd0 in <span class="hljs-title function_">mapping_open_pcm</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab28970</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, exact_channels=<span class="hljs-literal">true</span>, mode=<span class="hljs-number">1</span>, default_n_fragments=<span class="hljs-number">4</span>,                   </span><br><span class="hljs-params">    default_fragment_size_msec=<span class="hljs-number">25</span>)</span> at modules/alsa/alsa-mixer.c:4671<br>#3  0x0000fffff24ddf28 in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span>       <br>    at modules/alsa/alsa-mixer.c:4891<br>#4  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871                                                                 <br>#5  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>,                                                        </span><br><span class="hljs-params">    argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#6  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#7  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#8  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#9  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#10 0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#11 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#12 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#13 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>,     </span><br><span class="hljs-params">    ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#14 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#15 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">snd_pcm_t</span> *<span class="hljs-title function_">pa_alsa_open_by_device_string</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *device,</span><br><span class="hljs-params">        <span class="hljs-type">char</span> **dev,</span><br><span class="hljs-params">        pa_sample_spec *ss,</span><br><span class="hljs-params">        pa_channel_map* <span class="hljs-built_in">map</span>,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> mode,</span><br><span class="hljs-params">        <span class="hljs-type">snd_pcm_uframes_t</span> *period_size,</span><br><span class="hljs-params">        <span class="hljs-type">snd_pcm_uframes_t</span> *buffer_size,</span><br><span class="hljs-params">        <span class="hljs-type">snd_pcm_uframes_t</span> tsched_size,</span><br><span class="hljs-params">        <span class="hljs-type">bool</span> *use_mmap,</span><br><span class="hljs-params">        <span class="hljs-type">bool</span> *use_tsched,</span><br><span class="hljs-params">        <span class="hljs-type">bool</span> require_exact_channel_number)</span> &#123;<br><br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">char</span> *d;<br>    <span class="hljs-type">snd_pcm_t</span> *pcm_handle;<br>    <span class="hljs-type">bool</span> reformat = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">// 断言输入参数不为空</span><br>    pa_assert(device);<br>    pa_assert(ss);<br>    pa_assert(<span class="hljs-built_in">map</span>);<br><br>    d = pa_xstrdup(device);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        pa_log_debug(<span class="hljs-string">&quot;Trying %s %s SND_PCM_NO_AUTO_FORMAT ...&quot;</span>, d, reformat ? <span class="hljs-string">&quot;without&quot;</span> : <span class="hljs-string">&quot;with&quot;</span>);<br><br>        <span class="hljs-comment">// 尝试打开 ALSA 设备，此函数位于/usr/include/alsa/pcm.h</span><br>        <span class="hljs-keyword">if</span> ((err = snd_pcm_open(&amp;pcm_handle, d, mode,<br>                                SND_PCM_NONBLOCK|<br>                                SND_PCM_NO_AUTO_RESAMPLE|<br>                                SND_PCM_NO_AUTO_CHANNELS|<br>                                (reformat ? <span class="hljs-number">0</span> : SND_PCM_NO_AUTO_FORMAT))) &lt; <span class="hljs-number">0</span>) &#123;<br>            pa_log_info(<span class="hljs-string">&quot;Error opening PCM device %s: %s&quot;</span>, d, pa_alsa_strerror(err));<br>            <span class="hljs-keyword">goto</span> fail;<br>        &#125;<br><br>        pa_log_debug(<span class="hljs-string">&quot;Managed to open %s&quot;</span>, d);<br><br>        <span class="hljs-comment">// 尝试设置硬件参数</span><br>        <span class="hljs-keyword">if</span> ((err = pa_alsa_set_hw_params(<br>                     pcm_handle,<br>                     ss,<br>                     period_size,<br>                     buffer_size,<br>                     tsched_size,<br>                     use_mmap,<br>                     use_tsched,<br>                     require_exact_channel_number)) &lt; <span class="hljs-number">0</span>) &#123;<br><br>            <span class="hljs-keyword">if</span> (!reformat) &#123;<br>                reformat = <span class="hljs-literal">true</span>;<br><br>                snd_pcm_close(pcm_handle);<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 尝试通过插件打开设备</span><br>            <span class="hljs-keyword">if</span> (!pa_startswith(d, <span class="hljs-string">&quot;plug:&quot;</span>) &amp;&amp; !pa_startswith(d, <span class="hljs-string">&quot;plughw:&quot;</span>)) &#123;<br>                <span class="hljs-type">char</span> *t;<br><br>                t = pa_sprintf_malloc(<span class="hljs-string">&quot;plug:%s&quot;</span>, d);<br>                pa_xfree(d);<br>                d = t;<br><br>                reformat = <span class="hljs-literal">false</span>;<br><br>                snd_pcm_close(pcm_handle);<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            pa_log_info(<span class="hljs-string">&quot;Failed to set hardware parameters on %s: %s&quot;</span>, d, pa_alsa_strerror(err));<br>            snd_pcm_close(pcm_handle);<br><br>            <span class="hljs-keyword">goto</span> fail;<br>        &#125;<br><br>        <span class="hljs-comment">// 检查通道数是否超过最大支持数</span><br>        <span class="hljs-keyword">if</span> (ss-&gt;channels &gt; PA_CHANNELS_MAX) &#123;<br>            pa_log(<span class="hljs-string">&quot;Device %s has %u channels, but PulseAudio supports only %u channels. Unable to use the device.&quot;</span>,<br>                   d, ss-&gt;channels, PA_CHANNELS_MAX);<br>            snd_pcm_close(pcm_handle);<br>            <span class="hljs-keyword">goto</span> fail;<br>        &#125;<br><br>        <span class="hljs-comment">// 根据是否传递了 dev 参数设置设备名</span><br>        <span class="hljs-keyword">if</span> (dev)<br>            *dev = d;<br>        <span class="hljs-keyword">else</span><br>            pa_xfree(d);<br><br>        <span class="hljs-comment">// 如果通道数不匹配，进行通道映射的扩展</span><br>        <span class="hljs-keyword">if</span> (ss-&gt;channels != <span class="hljs-built_in">map</span>-&gt;channels)<br>            pa_channel_map_init_extend(<span class="hljs-built_in">map</span>, ss-&gt;channels, PA_CHANNEL_MAP_ALSA);<br><br>        <span class="hljs-keyword">return</span> pcm_handle;<br>    &#125;<br><br>fail:<br>    pa_xfree(d);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817170922.png" srcset="/img/loading.gif" lazyload
alt="snd_pcm_open" />
<figcaption aria-hidden="true">snd_pcm_open</figcaption>
</figure>
<h4 id="mapping_query_hw_device">mapping_query_hw_device</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24dd348</span> in <span class="hljs-title function_">mapping_query_hw_device</span> <span class="hljs-params">(mapping=<span class="hljs-number">0xaaaaaab2c360</span>, pcm=<span class="hljs-number">0xaaaaaacb4360</span>)</span> at modules/alsa/alsa-mixer.c:4719<br>#1  0x0000fffff24ddff4 in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4905<br>#2  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#3  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#4  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#5  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#6  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#7  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#8  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#9  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#10 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#11 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#12 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#13 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mapping_query_hw_device</span><span class="hljs-params">(pa_alsa_mapping *mapping, <span class="hljs-type">snd_pcm_t</span> *pcm)</span> &#123;<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">snd_pcm_info_t</span>* pcm_info;<br>    snd_pcm_info_alloca(&amp;pcm_info);<br><br>    <span class="hljs-comment">// 查询 PCM 设备信息</span><br>    r = snd_pcm_info(pcm, pcm_info);<br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log(<span class="hljs-string">&quot;映射 %s：snd_pcm_info() 失败 %s：&quot;</span>, mapping-&gt;name, pa_alsa_strerror(r));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* <span class="hljs-doctag">XXX:</span> 不清楚 snd_pcm_info_get_device() 在设备不由硬件支持或由多个硬件设备支持的情况下的行为。</span><br><span class="hljs-comment">     * 然而，我们只在 HDMI 设备中使用 hw_device_index，对于这些设备，返回值应始终有效，</span><br><span class="hljs-comment">     * 因此这不应该是一个重大问题。 */</span><br>    <span class="hljs-comment">// 获取硬件设备索引并设置给映射结构</span><br>    mapping-&gt;hw_device_index = snd_pcm_info_get_device(pcm_info);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="mapping_paths_probe">mapping_paths_probe</h4>
<p><code>mapping_paths_probe</code>中会处理<code>/usr/share/pulseaudio/alsa-mixer/paths/</code>，见下文。</p>
<h2
id="usrsharepulseaudioalsa-mixerpaths">/usr/share/pulseaudio/alsa-mixer/paths/</h2>
<h3 id="mapping_paths_probe-1">mapping_paths_probe</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24db120</span> in <span class="hljs-title function_">mapping_paths_probe</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c360</span>, profile=<span class="hljs-number">0xaaaaaab408a0</span>, direction=PA_ALSA_DIRECTION_INPUT, used_paths=<span class="hljs-number">0xaaaaaac6b970</span>)</span><br>    at modules/alsa/alsa-mixer.c:4116<br>#1  0x0000fffff24de19c in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4933<br>#2  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#3  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#4  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#5  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#6  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#7  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#8  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#9  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#10 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#11 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#12 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#13 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 在指定映射中探测路径 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mapping_paths_probe</span><span class="hljs-params">(pa_alsa_mapping *m, pa_alsa_profile *profile,</span><br><span class="hljs-params">                                <span class="hljs-type">pa_alsa_direction_t</span> direction, pa_hashmap *used_paths)</span> &#123;<br><br>    pa_alsa_path *p;<br>    <span class="hljs-type">void</span> *state;<br>    <span class="hljs-type">snd_pcm_t</span> *pcm_handle;<br>    pa_alsa_path_set *ps;<br>    <span class="hljs-type">snd_mixer_t</span> *mixer_handle;<br><br>    <span class="hljs-keyword">if</span> (direction == PA_ALSA_DIRECTION_OUTPUT) &#123;<br>        <span class="hljs-keyword">if</span> (m-&gt;output_path_set)<br>            <span class="hljs-keyword">return</span>; <span class="hljs-comment">/* 已经进行过探测 */</span><br>        m-&gt;output_path_set = ps = pa_alsa_path_set_new(m, direction, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> 处理 paths_dir */</span><br>        pcm_handle = m-&gt;output_pcm;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (m-&gt;input_path_set)<br>            <span class="hljs-keyword">return</span>; <span class="hljs-comment">/* 已经进行过探测 */</span><br>        m-&gt;input_path_set = ps = pa_alsa_path_set_new(m, direction, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> 处理 paths_dir */</span><br>        pcm_handle = m-&gt;input_pcm;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!ps)<br>        <span class="hljs-keyword">return</span>; <span class="hljs-comment">/* 没有可用的路径 */</span><br><br>    pa_assert(pcm_handle);<br><br>    mixer_handle = pa_alsa_open_mixer_for_pcm(pcm_handle, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (!mixer_handle) &#123;<br>        <span class="hljs-comment">/* 无法打开混音器，移除所有路径 */</span><br>        pa_hashmap_remove_all(ps-&gt;paths);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* 对于每个路径，进行探测并更新 */</span><br>    PA_HASHMAP_FOREACH(p, ps-&gt;paths, state) &#123;<br>        <span class="hljs-keyword">if</span> (p-&gt;autodetect_eld_device)<br>            p-&gt;eld_device = m-&gt;hw_device_index;<br><br>        <span class="hljs-keyword">if</span> (pa_alsa_path_probe(p, m, mixer_handle, m-&gt;profile_set-&gt;ignore_dB) &lt; <span class="hljs-number">0</span>)<br>            pa_hashmap_remove(ps-&gt;paths, p);<br>    &#125;<br><br>    <span class="hljs-comment">/* 精简路径集合 */</span><br>    path_set_condense(ps, mixer_handle);<br>    path_set_make_path_descriptions_unique(ps);<br><br>    <span class="hljs-keyword">if</span> (mixer_handle)<br>        snd_mixer_close(mixer_handle);<br><br>    <span class="hljs-comment">/* 将已使用的路径添加到哈希表中 */</span><br>    PA_HASHMAP_FOREACH(p, ps-&gt;paths, state)<br>        pa_hashmap_put(used_paths, p, p);<br><br>    pa_log_debug(<span class="hljs-string">&quot;可用的混音器路径（整理后）：&quot;</span>);<br>    pa_alsa_path_set_dump(ps);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="pa_alsa_path_set_new">pa_alsa_path_set_new</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24d78c4</span> in <span class="hljs-title function_">pa_alsa_path_set_new</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c4b0</span>, direction=PA_ALSA_DIRECTION_INPUT, paths_dir=<span class="hljs-number">0x0</span>)</span> at modules/alsa/alsa-mixer.c:3184<br>#1  0x0000fffff24db1a0 in <span class="hljs-title function_">mapping_paths_probe</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c4b0</span>, profile=<span class="hljs-number">0xaaaaaab409f0</span>, direction=PA_ALSA_DIRECTION_INPUT, used_paths=<span class="hljs-number">0xaaaaaac6bac0</span>)</span><br>    at modules/alsa/alsa-mixer.c:4132<br>#2  0x0000fffff24de19c in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28270</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4933<br>#3  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#4  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#5  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#6  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#7  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#8  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#9  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#10 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#11 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#12 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#13 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#14 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">ptype p<br>type = <span class="hljs-keyword">struct</span> pa_alsa_path &#123;<br>    <span class="hljs-type">pa_alsa_direction_t</span> direction;           <span class="hljs-comment">/**&lt; ALSA 路径的方向，输入还是输出 */</span><br>    pa_device_port *port;                   <span class="hljs-comment">/**&lt; 设备端口指针 */</span><br>    <span class="hljs-type">char</span> *name;                              <span class="hljs-comment">/**&lt; 路径的名称 */</span><br>    <span class="hljs-type">char</span> *description_key;                   <span class="hljs-comment">/**&lt; 描述的键 */</span><br>    <span class="hljs-type">char</span> *description;                       <span class="hljs-comment">/**&lt; 描述 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> priority;                   <span class="hljs-comment">/**&lt; 优先级 */</span><br>    <span class="hljs-type">_Bool</span> autodetect_eld_device;             <span class="hljs-comment">/**&lt; 自动检测 ELD 设备标志 */</span><br>    <span class="hljs-type">int</span> eld_device;                          <span class="hljs-comment">/**&lt; ELD 设备索引 */</span><br>    pa_proplist *proplist;                   <span class="hljs-comment">/**&lt; 属性列表指针 */</span><br>    <span class="hljs-type">_Bool</span> probed : <span class="hljs-number">1</span>;                        <span class="hljs-comment">/**&lt; 是否已经探测 */</span><br>    <span class="hljs-type">_Bool</span> supported : <span class="hljs-number">1</span>;                     <span class="hljs-comment">/**&lt; 是否支持 */</span><br>    <span class="hljs-type">_Bool</span> has_mute : <span class="hljs-number">1</span>;                      <span class="hljs-comment">/**&lt; 是否有静音控制 */</span><br>    <span class="hljs-type">_Bool</span> has_volume : <span class="hljs-number">1</span>;                    <span class="hljs-comment">/**&lt; 是否有音量控制 */</span><br>    <span class="hljs-type">_Bool</span> has_dB : <span class="hljs-number">1</span>;                        <span class="hljs-comment">/**&lt; 是否支持分贝控制 */</span><br>    <span class="hljs-type">_Bool</span> mute_during_activation : <span class="hljs-number">1</span>;        <span class="hljs-comment">/**&lt; 激活时是否静音 */</span><br>    <span class="hljs-type">_Bool</span> has_req_any : <span class="hljs-number">1</span>;                   <span class="hljs-comment">/**&lt; 是否有 required-any 属性 */</span><br>    <span class="hljs-type">_Bool</span> req_any_present : <span class="hljs-number">1</span>;               <span class="hljs-comment">/**&lt; 是否存在 required-any 属性 */</span><br>    <span class="hljs-type">_Bool</span> customized : <span class="hljs-number">1</span>;                    <span class="hljs-comment">/**&lt; 是否自定义 */</span><br>    <span class="hljs-type">long</span> min_volume;                         <span class="hljs-comment">/**&lt; 最小音量值 */</span><br>    <span class="hljs-type">long</span> max_volume;                         <span class="hljs-comment">/**&lt; 最大音量值 */</span><br>    <span class="hljs-type">double</span> min_dB;                           <span class="hljs-comment">/**&lt; 最小分贝值 */</span><br>    <span class="hljs-type">double</span> max_dB;                           <span class="hljs-comment">/**&lt; 最大分贝值 */</span><br>    pa_alsa_element *last_element;           <span class="hljs-comment">/**&lt; 最后一个元素指针 */</span><br>    pa_alsa_option *last_option;             <span class="hljs-comment">/**&lt; 最后一个选项指针 */</span><br>    pa_alsa_setting *last_setting;           <span class="hljs-comment">/**&lt; 最后一个设置指针 */</span><br>    pa_alsa_jack *last_jack;                 <span class="hljs-comment">/**&lt; 最后一个插孔指针 */</span><br>    pa_alsa_element *elements;               <span class="hljs-comment">/**&lt; 元素链表指针 */</span><br>    pa_alsa_setting *settings;               <span class="hljs-comment">/**&lt; 设置链表指针 */</span><br>    pa_alsa_jack *jacks;                     <span class="hljs-comment">/**&lt; 插孔链表指针 */</span><br>&#125; *<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 创建一个新的 ALSA 路径集 */</span><br>pa_alsa_path_set *<span class="hljs-title function_">pa_alsa_path_set_new</span><span class="hljs-params">(pa_alsa_mapping *m, <span class="hljs-type">pa_alsa_direction_t</span> direction, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *paths_dir)</span> &#123;<br>    pa_alsa_path_set *ps;<br>    <span class="hljs-type">char</span> **pn = <span class="hljs-literal">NULL</span>, **en = <span class="hljs-literal">NULL</span>, **ie;<br>    pa_alsa_decibel_fix *db_fix;<br>    <span class="hljs-type">void</span> *state, *state2;<br><br>    pa_assert(m);<br>    pa_assert(m-&gt;profile_set);<br>    pa_assert(m-&gt;profile_set-&gt;decibel_fixes);<br>    pa_assert(direction == PA_ALSA_DIRECTION_OUTPUT || direction == PA_ALSA_DIRECTION_INPUT);<br><br>    <span class="hljs-keyword">if</span> (m-&gt;direction != PA_ALSA_DIRECTION_ANY &amp;&amp; m-&gt;direction != direction)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    ps = pa_xnew0(pa_alsa_path_set, <span class="hljs-number">1</span>);<br>    ps-&gt;direction = direction;<br>    ps-&gt;paths = pa_hashmap_new(pa_idxset_trivial_hash_func, pa_idxset_trivial_compare_func);<br><br>    <span class="hljs-keyword">if</span> (direction == PA_ALSA_DIRECTION_OUTPUT)<br>        pn = m-&gt;output_path_names;<br>    <span class="hljs-keyword">else</span><br>        pn = m-&gt;input_path_names;<br><br>    <span class="hljs-keyword">if</span> (pn) &#123;<br>        <span class="hljs-type">char</span> **in;<br><br>        <span class="hljs-keyword">for</span> (in = pn; *in; in++) &#123;<br>            pa_alsa_path *p = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-type">bool</span> duplicate = <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">char</span> **kn;<br><br>            <span class="hljs-keyword">for</span> (kn = pn; kn &lt; in; kn++)<br>                <span class="hljs-keyword">if</span> (pa_streq(*kn, *in)) &#123;<br>                    duplicate = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br><br>            <span class="hljs-comment">// 去重，算法时间复杂度为 O(n^2)，存在优化空间</span><br>            <span class="hljs-keyword">if</span> (duplicate)<br>                <span class="hljs-keyword">continue</span>;<br><br>            p = profile_set_get_path(m-&gt;profile_set, *in);<br><br>            <span class="hljs-keyword">if</span> (p &amp;&amp; p-&gt;direction != direction) &#123;<br>                pa_log(<span class="hljs-string">&quot;配置错误：路径 %s 既被用作输入路径又被用作输出路径。&quot;</span>, p-&gt;name);<br>                <span class="hljs-keyword">goto</span> fail;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!p) &#123;<br>                <span class="hljs-type">char</span> *fn = pa_sprintf_malloc(<span class="hljs-string">&quot;%s.conf&quot;</span>, *in);<br>                p = pa_alsa_path_new(m-&gt;profile_set, paths_dir, fn, direction);<br>                pa_xfree(fn);<br>                <span class="hljs-keyword">if</span> (p)<br>                    profile_set_add_path(m-&gt;profile_set, p);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (p)<br>                pa_hashmap_put(ps-&gt;paths, p, p);<br>        &#125;<br><br>        <span class="hljs-keyword">goto</span> finish;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (direction == PA_ALSA_DIRECTION_OUTPUT)<br>        en = m-&gt;output_element;<br>    <span class="hljs-keyword">else</span><br>        en = m-&gt;input_element;<br><br>    <span class="hljs-keyword">if</span> (!en)<br>        <span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-keyword">for</span> (ie = en; *ie; ie++) &#123;<br>        <span class="hljs-type">char</span> **je;<br>        pa_alsa_path *p;<br><br>        p = pa_alsa_path_synthesize(*ie, direction);<br><br>        <span class="hljs-comment">/* 标记其他已传递的元素为 required-absent */</span><br>        <span class="hljs-keyword">for</span> (je = en; *je; je++) &#123;<br>            pa_alsa_element *e;<br><br>            <span class="hljs-keyword">if</span> (je == ie)<br>                <span class="hljs-keyword">continue</span>;<br><br>            e = pa_xnew0(pa_alsa_element, <span class="hljs-number">1</span>);<br>            e-&gt;path = p;<br>            e-&gt;alsa_name = pa_xstrdup(*je);<br>            e-&gt;direction = direction;<br>            e-&gt;required_absent = PA_ALSA_REQUIRED_ANY;<br>            e-&gt;volume_limit = <span class="hljs-number">-1</span>;<br><br>            PA_LLIST_INSERT_AFTER(pa_alsa_element, p-&gt;elements, p-&gt;last_element, e);<br>            p-&gt;last_element = e;<br>        &#125;<br><br>        pa_hashmap_put(ps-&gt;paths, *ie, p);<br>    &#125;<br><br>finish:<br>    <span class="hljs-comment">/* 将分贝修复分配给元素 */</span><br>    PA_HASHMAP_FOREACH(db_fix, m-&gt;profile_set-&gt;decibel_fixes, state) &#123;<br>        pa_alsa_path *p;<br><br>        PA_HASHMAP_FOREACH(p, ps-&gt;paths, state2) &#123;<br>            pa_alsa_element *e;<br><br>            PA_LLIST_FOREACH(e, p-&gt;elements) &#123;<br>                <span class="hljs-keyword">if</span> (e-&gt;volume_use != PA_ALSA_VOLUME_IGNORE &amp;&amp; pa_streq(db_fix-&gt;name, e-&gt;alsa_name)) &#123;<br>                    <span class="hljs-comment">/* 包含 dB 修复的配置集可能会在元素之前被释放，所以我们必须复制 dB 修复对象。 */</span><br>                    e-&gt;db_fix = pa_xnewdup(pa_alsa_decibel_fix, db_fix, <span class="hljs-number">1</span>);<br>                    e-&gt;db_fix-&gt;profile_set = <span class="hljs-literal">NULL</span>;<br>                    e-&gt;db_fix-&gt;name = pa_xstrdup(db_fix-&gt;name);<br>                    e-&gt;db_fix-&gt;db_values = pa_xmemdup(db_fix-&gt;db_values, (db_fix-&gt;max_step - db_fix-&gt;min_step + <span class="hljs-number">1</span>) * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ps;<br><br>fail:<br>    <span class="hljs-keyword">if</span> (ps)<br>        pa_alsa_path_set_free(ps);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) p *pn@<span class="hljs-number">15</span><br>$<span class="hljs-number">48</span> =   &#123;[<span class="hljs-number">0</span>] = <span class="hljs-number">0xaaaaaab2caf0</span> <span class="hljs-string">&quot;analog-input-front-mic&quot;</span>,<br>  [<span class="hljs-number">1</span>] = <span class="hljs-number">0xaaaaaab2cad0</span> <span class="hljs-string">&quot;analog-input-rear-mic&quot;</span>,<br>  [<span class="hljs-number">2</span>] = <span class="hljs-number">0xaaaaaab2cb10</span> <span class="hljs-string">&quot;analog-input-internal-mic&quot;</span>,<br>  [<span class="hljs-number">3</span>] = <span class="hljs-number">0xaaaaaab2cab0</span> <span class="hljs-string">&quot;analog-input-dock-mic&quot;</span>,<br>  [<span class="hljs-number">4</span>] = <span class="hljs-number">0xaaaaaab2c470</span> <span class="hljs-string">&quot;analog-input&quot;</span>,<br>  [<span class="hljs-number">5</span>] = <span class="hljs-number">0xaaaaaab2cb40</span> <span class="hljs-string">&quot;analog-input-mic&quot;</span>,<br>  [<span class="hljs-number">6</span>] = <span class="hljs-number">0xaaaaaab2cb60</span> <span class="hljs-string">&quot;analog-input-linein&quot;</span>,<br>  [<span class="hljs-number">7</span>] = <span class="hljs-number">0xaaaaaab2cb80</span> <span class="hljs-string">&quot;analog-input-aux&quot;</span>,<br>  [<span class="hljs-number">8</span>] = <span class="hljs-number">0xaaaaaab2cc30</span> <span class="hljs-string">&quot;analog-input-video&quot;</span>,<br>  [<span class="hljs-number">9</span>] = <span class="hljs-number">0xaaaaaab2cc50</span> <span class="hljs-string">&quot;analog-input-tvtuner&quot;</span>,<br>  [<span class="hljs-number">10</span>] = <span class="hljs-number">0xaaaaaab2cc70</span> <span class="hljs-string">&quot;analog-input-fm&quot;</span>,<br>  [<span class="hljs-number">11</span>] = <span class="hljs-number">0xaaaaaab2cc90</span> <span class="hljs-string">&quot;analog-input-mic-line&quot;</span>,<br>  [<span class="hljs-number">12</span>] = <span class="hljs-number">0xaaaaaab2ccb0</span> <span class="hljs-string">&quot;analog-input-headphone-mic&quot;</span>,<br>  [<span class="hljs-number">13</span>] = <span class="hljs-number">0xaaaaaab2cce0</span> <span class="hljs-string">&quot;analog-input-headset-mic&quot;</span>,<br>  [<span class="hljs-number">14</span>] = <span class="hljs-number">0x0</span>&#125;<br>(gdb) p *in@<span class="hljs-number">15</span>                                                                                                                                                                    <br>$<span class="hljs-number">49</span> =   &#123;[<span class="hljs-number">0</span>] = <span class="hljs-number">0xaaaaaab2caf0</span> <span class="hljs-string">&quot;analog-input-front-mic&quot;</span>,<br>  [<span class="hljs-number">1</span>] = <span class="hljs-number">0xaaaaaab2cad0</span> <span class="hljs-string">&quot;analog-input-rear-mic&quot;</span>,<br>  [<span class="hljs-number">2</span>] = <span class="hljs-number">0xaaaaaab2cb10</span> <span class="hljs-string">&quot;analog-input-internal-mic&quot;</span>,<br>  [<span class="hljs-number">3</span>] = <span class="hljs-number">0xaaaaaab2cab0</span> <span class="hljs-string">&quot;analog-input-dock-mic&quot;</span>,<br>  [<span class="hljs-number">4</span>] = <span class="hljs-number">0xaaaaaab2c470</span> <span class="hljs-string">&quot;analog-input&quot;</span>,<br>  [<span class="hljs-number">5</span>] = <span class="hljs-number">0xaaaaaab2cb40</span> <span class="hljs-string">&quot;analog-input-mic&quot;</span>,<br>  [<span class="hljs-number">6</span>] = <span class="hljs-number">0xaaaaaab2cb60</span> <span class="hljs-string">&quot;analog-input-linein&quot;</span>,<br>  [<span class="hljs-number">7</span>] = <span class="hljs-number">0xaaaaaab2cb80</span> <span class="hljs-string">&quot;analog-input-aux&quot;</span>,<br>  [<span class="hljs-number">8</span>] = <span class="hljs-number">0xaaaaaab2cc30</span> <span class="hljs-string">&quot;analog-input-video&quot;</span>,<br>  [<span class="hljs-number">9</span>] = <span class="hljs-number">0xaaaaaab2cc50</span> <span class="hljs-string">&quot;analog-input-tvtuner&quot;</span>,<br>  [<span class="hljs-number">10</span>] = <span class="hljs-number">0xaaaaaab2cc70</span> <span class="hljs-string">&quot;analog-input-fm&quot;</span>,<br>  [<span class="hljs-number">11</span>] = <span class="hljs-number">0xaaaaaab2cc90</span> <span class="hljs-string">&quot;analog-input-mic-line&quot;</span>,<br>  [<span class="hljs-number">12</span>] = <span class="hljs-number">0xaaaaaab2ccb0</span> <span class="hljs-string">&quot;analog-input-headphone-mic&quot;</span>,<br>  [<span class="hljs-number">13</span>] = <span class="hljs-number">0xaaaaaab2cce0</span> <span class="hljs-string">&quot;analog-input-headset-mic&quot;</span>,<br>  [<span class="hljs-number">14</span>] = <span class="hljs-number">0x0</span>&#125;<br>(gdb) p *kn@<span class="hljs-number">15</span>                                                                                                                                                                    <br>$<span class="hljs-number">50</span> =   &#123;[<span class="hljs-number">0</span>] = <span class="hljs-number">0xaaaaaab2caf0</span> <span class="hljs-string">&quot;analog-input-front-mic&quot;</span>,<br>  [<span class="hljs-number">1</span>] = <span class="hljs-number">0xaaaaaab2cad0</span> <span class="hljs-string">&quot;analog-input-rear-mic&quot;</span>,<br>  [<span class="hljs-number">2</span>] = <span class="hljs-number">0xaaaaaab2cb10</span> <span class="hljs-string">&quot;analog-input-internal-mic&quot;</span>,<br>  [<span class="hljs-number">3</span>] = <span class="hljs-number">0xaaaaaab2cab0</span> <span class="hljs-string">&quot;analog-input-dock-mic&quot;</span>,<br>  [<span class="hljs-number">4</span>] = <span class="hljs-number">0xaaaaaab2c470</span> <span class="hljs-string">&quot;analog-input&quot;</span>,<br>  [<span class="hljs-number">5</span>] = <span class="hljs-number">0xaaaaaab2cb40</span> <span class="hljs-string">&quot;analog-input-mic&quot;</span>,<br>  [<span class="hljs-number">6</span>] = <span class="hljs-number">0xaaaaaab2cb60</span> <span class="hljs-string">&quot;analog-input-linein&quot;</span>,<br>  [<span class="hljs-number">7</span>] = <span class="hljs-number">0xaaaaaab2cb80</span> <span class="hljs-string">&quot;analog-input-aux&quot;</span>,<br>  [<span class="hljs-number">8</span>] = <span class="hljs-number">0xaaaaaab2cc30</span> <span class="hljs-string">&quot;analog-input-video&quot;</span>,<br>  [<span class="hljs-number">9</span>] = <span class="hljs-number">0xaaaaaab2cc50</span> <span class="hljs-string">&quot;analog-input-tvtuner&quot;</span>,<br>  [<span class="hljs-number">10</span>] = <span class="hljs-number">0xaaaaaab2cc70</span> <span class="hljs-string">&quot;analog-input-fm&quot;</span>,<br>  [<span class="hljs-number">11</span>] = <span class="hljs-number">0xaaaaaab2cc90</span> <span class="hljs-string">&quot;analog-input-mic-line&quot;</span>,<br>  [<span class="hljs-number">12</span>] = <span class="hljs-number">0xaaaaaab2ccb0</span> <span class="hljs-string">&quot;analog-input-headphone-mic&quot;</span>,<br>  [<span class="hljs-number">13</span>] = <span class="hljs-number">0xaaaaaab2cce0</span> <span class="hljs-string">&quot;analog-input-headset-mic&quot;</span>,<br>  [<span class="hljs-number">14</span>] = <span class="hljs-number">0x0</span>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="profile_set_get_path">profile_set_get_path</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  0x0000fffff7dbce30 in pa_hashmap_get (h=0xaaaaaab29cd0, key=0xaaaaaab2caf0) at pulsecore/hashmap.c:180                                                                        </span><br><span class="hljs-comment">#1  0x0000fffff24d7654 in profile_set_get_path (ps=0xaaaaaab28270, path_name=0xaaaaaab2caf0 &quot;analog-input-front-mic&quot;) at modules/alsa/alsa-mixer.c:3163                           </span><br><span class="hljs-comment">#2  0x0000fffff24d7bc8 in pa_alsa_path_set_new (m=0xaaaaaab2c4b0, direction=PA_ALSA_DIRECTION_INPUT, paths_dir=0x0) at modules/alsa/alsa-mixer.c:3224                             </span><br><span class="hljs-comment">#3  0x0000fffff24db1a0 in mapping_paths_probe (m=0xaaaaaab2c4b0, profile=0xaaaaaab409f0, direction=PA_ALSA_DIRECTION_INPUT, used_paths=0xaaaaaac6bac0)                            </span><br>    at modules/alsa/alsa-mixer.c:4132<br><span class="hljs-comment">#4  0x0000fffff24de19c in pa_alsa_profile_set_probe (ps=0xaaaaaab28270, dev_id=0xaaaaaab12450 &quot;0&quot;, ss=0xaaaaaaae2fec, default_n_fragments=4, default_fragment_size_msec=25)       </span><br>    at modules/alsa/alsa-mixer.c:4933<br><span class="hljs-comment">#5  0x0000fffff268bd10 in module_alsa_card_LTX_pa__init (m=0xaaaaaab0f450) at modules/alsa/module-alsa-card.c:871                                                                 </span><br><span class="hljs-comment">#6  0x0000fffff7e67104 in pa_module_load</span><br>    (module=0xffffffffcd90, c=0xaaaaaaae2ec0, name=0xfffff26a4d98 <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=0xaaaaaaadd8b0 <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...) at pulsecore/module.c:187        <br><span class="hljs-comment">#7  0x0000fffff26a2d9c in verify_access (u=0xaaaaaab03700, d=0xaaaaaab071f0) at modules/module-udev-detect.c:333                                                                  </span><br><span class="hljs-comment">#8  0x0000fffff26a32fc in card_changed (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:422                                                                 </span><br><span class="hljs-comment">#9  0x0000fffff26a36bc in process_device (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:464                                                               </span><br><span class="hljs-comment">#10 0x0000fffff26a373c in process_path (u=0xaaaaaab03700, path=0xaaaaaab18b00 &quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;) at modules/module-udev-detect.c:481                </span><br><span class="hljs-comment">#11 0x0000fffff26a46ac in module_udev_detect_LTX_pa__init (m=0xaaaaaab00e20) at modules/module-udev-detect.c:789                                                                  </span><br><span class="hljs-comment">#12 0x0000fffff7e67104 in pa_module_load (module=0xffffffffcfe8, c=0xaaaaaaae2ec0, name=0xaaaaaab011b0 &quot;module-udev-detect&quot;, argument=0x0) at pulsecore/module.c:187              </span><br><span class="hljs-comment">#13 0x0000fffff7e50170 in pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaab011d0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:437                        </span><br><span class="hljs-comment">#14 0x0000fffff7e5774c in pa_cli_command_execute_line_stateful</span><br>    (c=0xaaaaaaae2ec0, s=0xffffffffd1c8 <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505, ifstate=0xffffffffd1c0) at pulsecore/cli-command.c:2136        <br><span class="hljs-comment">#15 0x0000fffff7e57a00 in pa_cli_command_execute_file_stream (c=0xaaaaaaae2ec0, f=0xaaaaaaad58f0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:2176        </span><br><span class="hljs-comment">#16 0x0000aaaaaaab90ac in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1112</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 从配置文件中获取 ALSA 路径对象 */</span><br><span class="hljs-type">static</span> pa_alsa_path *<span class="hljs-title function_">profile_set_get_path</span><span class="hljs-params">(pa_alsa_profile_set *ps, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *path_name)</span> &#123;<br>    pa_alsa_path *path;<br><br>    pa_assert(ps);            <span class="hljs-comment">/**&lt; 断言：确保 pa_alsa_profile_set 对象不为空 */</span><br>    pa_assert(path_name);     <span class="hljs-comment">/**&lt; 断言：确保路径名称不为空 */</span><br><br>    <span class="hljs-comment">/* 从输出路径哈希映射中查找路径对象 */</span><br>    <span class="hljs-keyword">if</span> ((path = pa_hashmap_get(ps-&gt;output_paths, path_name)))<br>        <span class="hljs-keyword">return</span> path;<br><br>    <span class="hljs-comment">/* 从输入路径哈希映射中查找路径对象 */</span><br>    <span class="hljs-keyword">return</span> pa_hashmap_get(ps-&gt;input_paths, path_name);<br>&#125;<br></code></pre></td></tr></table></figure>
<h6 id="pa_alsa_path_new">pa_alsa_path_new</h6>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  0x0000fffff24d5214 in pa_alsa_path_new (ps=0xaaaaaab28270, paths_dir=0x0, fname=0xaaaaaacb0c90 &quot;analog-input-front-mic.conf&quot;, direction=PA_ALSA_DIRECTION_INPUT)</span><br>    at modules/alsa/alsa-mixer.c:2665<br><span class="hljs-comment">#1  0x0000fffff24d7c60 in pa_alsa_path_set_new (m=0xaaaaaab2c4b0, direction=PA_ALSA_DIRECTION_INPUT, paths_dir=0x0) at modules/alsa/alsa-mixer.c:3233</span><br><span class="hljs-comment">#2  0x0000fffff24db1a0 in mapping_paths_probe (m=0xaaaaaab2c4b0, profile=0xaaaaaab409f0, direction=PA_ALSA_DIRECTION_INPUT, used_paths=0xaaaaaac6bac0)</span><br>    at modules/alsa/alsa-mixer.c:4132<br><span class="hljs-comment">#3  0x0000fffff24de19c in pa_alsa_profile_set_probe (ps=0xaaaaaab28270, dev_id=0xaaaaaab12450 &quot;0&quot;, ss=0xaaaaaaae2fec, default_n_fragments=4, default_fragment_size_msec=25)</span><br>    at modules/alsa/alsa-mixer.c:4933<br><span class="hljs-comment">#4  0x0000fffff268bd10 in module_alsa_card_LTX_pa__init (m=0xaaaaaab0f450) at modules/alsa/module-alsa-card.c:871</span><br><span class="hljs-comment">#5  0x0000fffff7e67104 in pa_module_load</span><br>    (module=0xffffffffcd90, c=0xaaaaaaae2ec0, name=0xfffff26a4d98 <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=0xaaaaaaadd8b0 <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...) at pulsecore/module.c:187<br><span class="hljs-comment">#6  0x0000fffff26a2d9c in verify_access (u=0xaaaaaab03700, d=0xaaaaaab071f0) at modules/module-udev-detect.c:333</span><br><span class="hljs-comment">#7  0x0000fffff26a32fc in card_changed (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:422</span><br><span class="hljs-comment">#8  0x0000fffff26a36bc in process_device (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:464</span><br><span class="hljs-comment">#9  0x0000fffff26a373c in process_path (u=0xaaaaaab03700, path=0xaaaaaab18b00 &quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;) at modules/module-udev-detect.c:481</span><br><span class="hljs-comment">#10 0x0000fffff26a46ac in module_udev_detect_LTX_pa__init (m=0xaaaaaab00e20) at modules/module-udev-detect.c:789</span><br><span class="hljs-comment">#11 0x0000fffff7e67104 in pa_module_load (module=0xffffffffcfe8, c=0xaaaaaaae2ec0, name=0xaaaaaab011b0 &quot;module-udev-detect&quot;, argument=0x0) at pulsecore/module.c:187</span><br><span class="hljs-comment">#12 0x0000fffff7e50170 in pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaab011d0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:437</span><br><span class="hljs-comment">#13 0x0000fffff7e5774c in pa_cli_command_execute_line_stateful</span><br>    (c=0xaaaaaaae2ec0, s=0xffffffffd1c8 <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505, ifstate=0xffffffffd1c0) at pulsecore/cli-command.c:2136<br><span class="hljs-comment">#14 0x0000fffff7e57a00 in pa_cli_command_execute_file_stream (c=0xaaaaaaae2ec0, f=0xaaaaaaad58f0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:2176</span><br><span class="hljs-comment">#15 0x0000aaaaaaab90ac in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1112</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建新的 ALSA 路径对象。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param ps               pa_alsa_profile_set 对象</span><br><span class="hljs-comment"> * @param paths_dir        路径配置文件所在的目录</span><br><span class="hljs-comment"> * @param fname            路径配置文件的文件名</span><br><span class="hljs-comment"> * @param direction        路径方向（输入或输出）</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return                 新创建的 pa_alsa_path 对象，如果出错则返回 NULL</span><br><span class="hljs-comment"> */</span><br>pa_alsa_path* <span class="hljs-title function_">pa_alsa_path_new</span><span class="hljs-params">(<span class="hljs-type">const</span> pa_alsa_profile_set *ps, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *paths_dir, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *fname, <span class="hljs-type">pa_alsa_direction_t</span> direction)</span> &#123;<br>    pa_alsa_path *p;<br>    <span class="hljs-type">char</span> *fn;<br>    <span class="hljs-type">char</span> *cust_fn = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *n;<br>    <span class="hljs-type">bool</span> mute_during_activation = <span class="hljs-literal">false</span>;<br><br>    pa_config_item items[] = &#123;<br>        <span class="hljs-comment">/* [General] */</span><br>        &#123; <span class="hljs-string">&quot;priority&quot;</span>,            pa_config_parse_unsigned,          <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;General&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;description-key&quot;</span>,     pa_config_parse_string,            <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;General&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;description&quot;</span>,         pa_config_parse_string,            <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;General&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;mute-during-activation&quot;</span>, pa_config_parse_bool,           <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;General&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;eld-device&quot;</span>,          parse_eld_device,                  <span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;General&quot;</span> &#125;,<br>        <span class="hljs-comment">/* ... 其他选项 ... */</span><br>        &#123; <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125;<br>    &#125;;<br><br>    pa_assert(fname);<br><br>    p = pa_xnew0(pa_alsa_path, <span class="hljs-number">1</span>);<br>    n = pa_path_get_filename(fname);<br>    p-&gt;name = pa_xstrndup(n, <span class="hljs-built_in">strcspn</span>(n, <span class="hljs-string">&quot;.&quot;</span>));<br>    p-&gt;proplist = pa_proplist_new();<br>    p-&gt;direction = direction;<br>    p-&gt;eld_device = <span class="hljs-number">-1</span>;<br><br>    items[<span class="hljs-number">0</span>].data = &amp;p-&gt;priority;<br>    items[<span class="hljs-number">1</span>].data = &amp;p-&gt;description_key;<br>    items[<span class="hljs-number">2</span>].data = &amp;p-&gt;description;<br>    items[<span class="hljs-number">3</span>].data = &amp;mute_during_activation;<br><br>    <span class="hljs-keyword">if</span> (!paths_dir)<br>        paths_dir = get_default_paths_dir();<br><br>    <span class="hljs-comment">/* 如果 fname 在自定义文件夹中，则加载自定义文件名 */</span><br>    <span class="hljs-keyword">if</span> (ps &amp;&amp; ps-&gt;cust_folder)<br>        cust_fn = pa_alsa_get_cust_filename(ps-&gt;cust_paths, fname);<br><br>    <span class="hljs-keyword">if</span> (cust_fn) &#123;<br>        fn = pa_maybe_prefix_path(cust_fn, paths_dir);<br>        p-&gt;customized = <span class="hljs-literal">true</span>;<br>        pa_xfree(cust_fn);<br>    &#125; <span class="hljs-keyword">else</span><br>        fn = pa_maybe_prefix_path(fname, paths_dir);<br><br>    pa_log_info(<span class="hljs-string">&quot;Loading path config: %s,%s,%s,%s&quot;</span>, fn, fname, n, p-&gt;name);<br><br>    r = pa_config_parse(fn, <span class="hljs-literal">NULL</span>, items, p-&gt;proplist, <span class="hljs-literal">false</span>, p);<br>    pa_xfree(fn);<br><br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> fail;<br><br>    p-&gt;mute_during_activation = mute_during_activation;<br><br>    <span class="hljs-keyword">if</span> (path_verify(p) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">goto</span> fail;<br><br>    <span class="hljs-keyword">return</span> p;<br><br>fail:<br>    pa_alsa_path_free(p);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这个函数中的主要函数<code>pa_config_parse</code>解读参见上方。</p>
<p><img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817180909.png" srcset="/img/loading.gif" lazyload
alt="20230817180909" /> <img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817181046.png" srcset="/img/loading.gif" lazyload
alt="20230817181046" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x0000fffff24d7c60</span> in <span class="hljs-title function_">pa_alsa_path_set_new</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c4b0</span>, direction=PA_ALSA_DIRECTION_INPUT, paths_dir=<span class="hljs-number">0x0</span>)</span> at modules/alsa/alsa-mixer.c:3233                                 <br>3233                    p = pa_alsa_path_new(m-&gt;profile_set, paths_dir, fn, direction);<br>Value returned is $<span class="hljs-number">57</span> = (pa_alsa_path *) <span class="hljs-number">0xaaaaaacb3a80</span><br>(gdb) p *p                                                                                                                                                                        <br>Cannot access memory at address <span class="hljs-number">0x0</span><br>(gdb) n<br><span class="hljs-number">3234</span>                    pa_xfree(fn);<br>(gdb) p *p<br>$<span class="hljs-number">58</span> = &#123;<br>  direction = PA_ALSA_DIRECTION_INPUT,<br>  port = <span class="hljs-number">0x0</span>,<br>  name = <span class="hljs-number">0xaaaaaacb3c60</span> <span class="hljs-string">&quot;analog-input-front-mic&quot;</span>,<br>  description_key = <span class="hljs-number">0xaaaaaac6ab50</span> <span class="hljs-string">&quot;analog-input-microphone-front&quot;</span>,<br>  description = <span class="hljs-number">0xaaaaaacb4bd0</span> <span class="hljs-string">&quot;前麦克风&quot;</span>,<br>  priority = <span class="hljs-number">85</span>,<br>  autodetect_eld_device = <span class="hljs-literal">false</span>,<br>  eld_device = <span class="hljs-number">-1</span>,<br>  proplist = <span class="hljs-number">0xaaaaaacb46f0</span>,<br>  probed = <span class="hljs-literal">false</span>,<br>  supported = <span class="hljs-literal">false</span>,<br>  has_mute = <span class="hljs-literal">false</span>,<br>  has_volume = <span class="hljs-literal">false</span>,<br>  has_dB = <span class="hljs-literal">false</span>,<br>  mute_during_activation = <span class="hljs-literal">false</span>,<br>  has_req_any = <span class="hljs-literal">true</span>,<br>  req_any_present = <span class="hljs-literal">false</span>,<br>  customized = <span class="hljs-literal">false</span>,<br>  min_volume = <span class="hljs-number">0</span>,<br>  max_volume = <span class="hljs-number">0</span>,<br>  min_dB = <span class="hljs-number">0</span>,<br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-keyword">continue</span> without paging--<br>  max_dB = <span class="hljs-number">0</span>, <br>  last_element = <span class="hljs-number">0xaaaaaacc2bf0</span>, <br>  last_option = <span class="hljs-number">0xaaaaaacc34b0</span>, <br>  last_setting = <span class="hljs-number">0x0</span>, <br>  last_jack = <span class="hljs-number">0xaaaaaacb36f0</span>, <br>  elements = <span class="hljs-number">0xaaaaaacb5f80</span>, <br>  settings = <span class="hljs-number">0x0</span>, <br>  jacks = <span class="hljs-number">0xaaaaaacb3c80</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="profile_set_add_path">profile_set_add_path</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) n<br><span class="hljs-number">3235</span>                    <span class="hljs-keyword">if</span> (p)<br>(gdb)<br><span class="hljs-number">3236</span>                        profile_set_add_path(m-&gt;profile_set, p);<br>(gdb) s<br><span class="hljs-title function_">profile_set_add_path</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28270</span>, path=<span class="hljs-number">0xaaaaaacb3a80</span>)</span> at modules/alsa/alsa-mixer.c:3167                                                                                   <br>3167        <span class="hljs-title function_">pa_assert</span><span class="hljs-params">(ps)</span>;<br>(gdb) bt<br>#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24d7674</span> in <span class="hljs-title function_">profile_set_add_path</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28270</span>, path=<span class="hljs-number">0xaaaaaacb3a80</span>)</span> at modules/alsa/alsa-mixer.c:3167                                                         <br>#1  0x0000fffff24d7c88 in <span class="hljs-title function_">pa_alsa_path_set_new</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c4b0</span>, direction=PA_ALSA_DIRECTION_INPUT, paths_dir=<span class="hljs-number">0x0</span>)</span> at modules/alsa/alsa-mixer.c:3236                             <br>#2  0x0000fffff24db1a0 in <span class="hljs-title function_">mapping_paths_probe</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c4b0</span>, profile=<span class="hljs-number">0xaaaaaab409f0</span>, direction=PA_ALSA_DIRECTION_INPUT, used_paths=<span class="hljs-number">0xaaaaaac6bac0</span>)</span>                            <br>    at modules/alsa/alsa-mixer.c:4132<br>#3  0x0000fffff24de19c in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28270</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span>       <br>    at modules/alsa/alsa-mixer.c:4933<br>#4  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871                                                                 <br>#5  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187        <br>#6  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#7  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#8  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#9  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#10 0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#11 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#12 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#13 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136        <br>#14 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#15 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 向 ALSA 配置文件集合中添加路径对象。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param ps     pa_alsa_profile_set 对象</span><br><span class="hljs-comment"> * @param path   要添加的 pa_alsa_path 对象</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">profile_set_add_path</span><span class="hljs-params">(pa_alsa_profile_set *ps, pa_alsa_path *path)</span> &#123;<br>    pa_assert(ps);<br>    pa_assert(path);<br><br>    <span class="hljs-keyword">switch</span> (path-&gt;direction) &#123;<br>        <span class="hljs-keyword">case</span> PA_ALSA_DIRECTION_OUTPUT:<br>            pa_assert_se(pa_hashmap_put(ps-&gt;output_paths, path-&gt;name, path) &gt;= <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> PA_ALSA_DIRECTION_INPUT:<br>            pa_assert_se(pa_hashmap_put(ps-&gt;input_paths, path-&gt;name, path) &gt;= <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">default</span>:<br>            pa_assert_not_reached();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="pa_alsa_path_synthesize">pa_alsa_path_synthesize</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">pa_alsa_direction</span> &#123;</span><br>    PA_ALSA_DIRECTION_ANY,    <span class="hljs-comment">/* 任意方向 */</span><br>    PA_ALSA_DIRECTION_OUTPUT, <span class="hljs-comment">/* 输出方向，从设备流向外部 */</span><br>    PA_ALSA_DIRECTION_INPUT   <span class="hljs-comment">/* 输入方向，从外部流向设备 */</span><br>&#125; <span class="hljs-type">pa_alsa_direction_t</span>;        <span class="hljs-comment">/* ALSA方向的枚举类型 */</span><br></code></pre></td></tr></table></figure>
<p>src/modules/alsa/alsa-mixer.c：3247-3253：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (direction == PA_ALSA_DIRECTION_OUTPUT)<br>        en = m-&gt;output_element;<br>    <span class="hljs-keyword">else</span><br>        en = m-&gt;input_element;<br><br>    <span class="hljs-keyword">if</span> (!en)<br>        <span class="hljs-keyword">goto</span> fail;<br></code></pre></td></tr></table></figure>
<p>3247-3253行决定<code>pa_alsa_path_synthesize</code>函数是否被调用：</p>
<p>src/modules/alsa/alsa-mixer.c：3259
src/modules/alsa/alsa-mixer.c：2765</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 合成一个虚拟的 ALSA 路径对象。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param element    要合成的元素名称</span><br><span class="hljs-comment"> * @param direction  路径的方向（输入或输出）</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @return 生成的 pa_alsa_path 对象</span><br><span class="hljs-comment"> */</span><br>pa_alsa_path *<span class="hljs-title function_">pa_alsa_path_synthesize</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *element, <span class="hljs-type">pa_alsa_direction_t</span> direction)</span> &#123;<br>    pa_alsa_path *p;<br>    pa_alsa_element *e;<br><br>    pa_assert(element);<br><br>    <span class="hljs-comment">// 创建新的 pa_alsa_path 对象</span><br>    p = pa_xnew0(pa_alsa_path, <span class="hljs-number">1</span>);<br>    p-&gt;name = pa_xstrdup(element);<br>    p-&gt;direction = direction;<br>    p-&gt;proplist = pa_proplist_new();<br><br>    <span class="hljs-comment">// 创建新的 pa_alsa_element 对象，并添加到路径中</span><br>    e = pa_xnew0(pa_alsa_element, <span class="hljs-number">1</span>);<br>    e-&gt;path = p;<br>    e-&gt;alsa_name = pa_xstrdup(element);<br>    e-&gt;direction = direction;<br>    e-&gt;volume_limit = <span class="hljs-number">-1</span>;<br><br>    e-&gt;switch_use = PA_ALSA_SWITCH_MUTE;<br>    e-&gt;volume_use = PA_ALSA_VOLUME_MERGE;<br><br>    PA_LLIST_PREPEND(pa_alsa_element, p-&gt;elements, e);<br>    p-&gt;last_element = e;<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="pa_alsa_open_mixer_for_pcm">pa_alsa_open_mixer_for_pcm</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) s<br><span class="hljs-title function_">pa_alsa_open_mixer_for_pcm</span> <span class="hljs-params">(pcm=<span class="hljs-number">0xaaaaaacb4360</span>, ctl_device=<span class="hljs-number">0x0</span>)</span> at modules/alsa/alsa-util.c:1638                                                                                  <br>warning: Source file is more recent than executable.<br>1638    <span class="hljs-type">snd_mixer_t</span> *<span class="hljs-title function_">pa_alsa_open_mixer_for_pcm</span><span class="hljs-params">(<span class="hljs-type">snd_pcm_t</span> *pcm, <span class="hljs-type">char</span> **ctl_device)</span> &#123;<br>(gdb) bt<br>#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24c2dec</span> in <span class="hljs-title function_">pa_alsa_open_mixer_for_pcm</span> <span class="hljs-params">(pcm=<span class="hljs-number">0xaaaaaacb4360</span>, ctl_device=<span class="hljs-number">0x0</span>)</span> at modules/alsa/alsa-util.c:1638                                                        <br>#1  0x0000fffff24db238 in <span class="hljs-title function_">mapping_paths_probe</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c360</span>, profile=<span class="hljs-number">0xaaaaaab408a0</span>, direction=PA_ALSA_DIRECTION_INPUT, used_paths=<span class="hljs-number">0xaaaaaac6b970</span>)</span>                            <br>    at modules/alsa/alsa-mixer.c:4141<br>#2  0x0000fffff24de19c in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span>       <br>    at modules/alsa/alsa-mixer.c:4933<br>#3  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871                                                                 <br>#4  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187        <br>#5  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333                                                                  <br>#6  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422                                                                 <br>#7  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464                                                               <br>#8  0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481                <br>#9  0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789                                                                  <br>#10 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187              <br>#11 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437                        <br>#12 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136        <br>#13 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176        <br>#14 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">snd_mixer_t</span> *<span class="hljs-title function_">pa_alsa_open_mixer_for_pcm</span><span class="hljs-params">(<span class="hljs-type">snd_pcm_t</span> *pcm, <span class="hljs-type">char</span> **ctl_device)</span> &#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">snd_mixer_t</span> *m;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev;<br>    <span class="hljs-type">snd_pcm_info_t</span>* info;<br>    snd_pcm_info_alloca(&amp;info);<br><br>    pa_assert(pcm);<br><br>    <span class="hljs-comment">// 尝试通过名称打开混音器</span><br>    <span class="hljs-keyword">if</span> ((err = snd_mixer_open(&amp;m, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log(<span class="hljs-string">&quot;Error opening mixer: %s&quot;</span>, pa_alsa_strerror(err));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 首先，尝试使用名称</span><br>    <span class="hljs-keyword">if</span> ((dev = snd_pcm_name(pcm)))<br>        <span class="hljs-keyword">if</span> (prepare_mixer(m, dev) &gt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (ctl_device)<br>                *ctl_device = pa_xstrdup(dev);<br><br>            <span class="hljs-keyword">return</span> m;<br>        &#125;<br><br>    <span class="hljs-comment">// 然后，尝试使用卡索引</span><br>    <span class="hljs-keyword">if</span> (snd_pcm_info(pcm, info) &gt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">char</span> *md;<br>        <span class="hljs-type">int</span> card_idx;<br><br>        <span class="hljs-keyword">if</span> ((card_idx = snd_pcm_info_get_card(info)) &gt;= <span class="hljs-number">0</span>) &#123;<br><br>            md = pa_sprintf_malloc(<span class="hljs-string">&quot;hw:%i&quot;</span>, card_idx);<br><br>            <span class="hljs-keyword">if</span> (!dev || !pa_streq(dev, md))<br>                <span class="hljs-keyword">if</span> (prepare_mixer(m, md) &gt;= <span class="hljs-number">0</span>) &#123;<br><br>                    <span class="hljs-keyword">if</span> (ctl_device)<br>                        *ctl_device = md;<br>                    <span class="hljs-keyword">else</span><br>                        pa_xfree(md);<br><br>                    <span class="hljs-keyword">return</span> m;<br>                &#125;<br><br>            pa_xfree(md);<br>        &#125;<br>    &#125;<br><br>    snd_mixer_close(m);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817184204.png" srcset="/img/loading.gif" lazyload
alt="20230817184204" /> <img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817184248.png" srcset="/img/loading.gif" lazyload
alt="20230817184248" /> <img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817184347.png" srcset="/img/loading.gif" lazyload
alt="20230817184347" /></p>
<h6 id="prepare_mixer">prepare_mixer</h6>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">1654            <span class="hljs-keyword">if</span> (prepare_mixer(m, dev) &gt;= 0) &#123;<br>(gdb) s<br>prepare_mixer (mixer=0xaaaaaad5f180, dev=0xaaaaaacb40d0 <span class="hljs-string">&quot;hw:0&quot;</span>) at modules/alsa/alsa-util.c:1569<br>1569    static int prepare_mixer(snd_mixer_t *mixer, const char *dev) &#123;<br>(gdb) info args <br>mixer = 0xaaaaaad5f180<br>dev = 0xaaaaaacb40d0 <span class="hljs-string">&quot;hw:0&quot;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 准备混音器 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">prepare_mixer</span><span class="hljs-params">(<span class="hljs-type">snd_mixer_t</span> *mixer, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev)</span> &#123;<br>    <span class="hljs-type">int</span> err;<br>    <span class="hljs-type">snd_mixer_class_t</span> *<span class="hljs-class"><span class="hljs-keyword">class</span>;</span><br><br>    pa_assert(mixer); <span class="hljs-comment">/* 断言 mixer 不为 NULL */</span><br>    pa_assert(dev); <span class="hljs-comment">/* 断言 dev 不为 NULL */</span><br><br>    <span class="hljs-comment">/* 尝试将混音器附加到指定的设备 */</span><br>    <span class="hljs-keyword">if</span> ((err = snd_mixer_attach(mixer, dev)) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log_info(<span class="hljs-string">&quot;无法附加到混音器 %s: %s&quot;</span>, dev, pa_alsa_strerror(err));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* 分配混音器类并设置相关参数 */</span><br>    <span class="hljs-keyword">if</span> (snd_mixer_class_malloc(&amp;class)) &#123;<br>        pa_log_info(<span class="hljs-string">&quot;为 %s 分配混音器类失败&quot;</span>, dev);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    snd_mixer_class_set_event(class, mixer_class_event);<br>    snd_mixer_class_set_compare(class, mixer_class_compare);<br>    <span class="hljs-keyword">if</span> ((err = snd_mixer_class_register(class, mixer)) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log_info(<span class="hljs-string">&quot;无法为 %s 注册混音器类: %s&quot;</span>, dev, pa_alsa_strerror(err));<br>        snd_mixer_class_free(class);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-comment">/* 从这里开始，混音器类将由 alsa 在 snd_mixer_close/free 时释放。 */</span><br><br>    <span class="hljs-comment">/* 注册混音器 */</span><br>    <span class="hljs-keyword">if</span> ((err = snd_mixer_selem_register(mixer, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;无法注册混音器: %s&quot;</span>, pa_alsa_strerror(err));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* 加载混音器 */</span><br>    <span class="hljs-keyword">if</span> ((err = snd_mixer_load(mixer)) &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;无法加载混音器: %s&quot;</span>, pa_alsa_strerror(err));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    pa_log_info(<span class="hljs-string">&quot;成功附加到混音器 &#x27;%s&#x27;&quot;</span>, dev);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="pa_alsa_path_probe">pa_alsa_path_probe</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  0x0000fffff24d6144 in pa_alsa_path_probe (p=0xaaaaaacb3dd0, mapping=0xaaaaaab2c360, m=0xaaaaaad5f180, ignore_dB=false) at modules/alsa/alsa-mixer.c:2922</span><br><span class="hljs-comment">#1  0x0000fffff24db2c0 in mapping_paths_probe (m=0xaaaaaab2c360, profile=0xaaaaaab408a0, direction=PA_ALSA_DIRECTION_INPUT, used_paths=0xaaaaaac6b970)</span><br>    at modules/alsa/alsa-mixer.c:4152<br><span class="hljs-comment">#2  0x0000fffff24de19c in pa_alsa_profile_set_probe (ps=0xaaaaaab28120, dev_id=0xaaaaaab12450 &quot;0&quot;, ss=0xaaaaaaae2fec, default_n_fragments=4, default_fragment_size_msec=25)</span><br>    at modules/alsa/alsa-mixer.c:4933<br><span class="hljs-comment">#3  0x0000fffff268bd10 in module_alsa_card_LTX_pa__init (m=0xaaaaaab0f450) at modules/alsa/module-alsa-card.c:871</span><br><span class="hljs-comment">#4  0x0000fffff7e67104 in pa_module_load</span><br>    (module=0xffffffffcd90, c=0xaaaaaaae2ec0, name=0xfffff26a4d98 <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=0xaaaaaaadd8b0 <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...) at pulsecore/module.c:187<br><span class="hljs-comment">#5  0x0000fffff26a2d9c in verify_access (u=0xaaaaaab03700, d=0xaaaaaab071f0) at modules/module-udev-detect.c:333</span><br><span class="hljs-comment">#6  0x0000fffff26a32fc in card_changed (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:422</span><br><span class="hljs-comment">#7  0x0000fffff26a36bc in process_device (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:464</span><br><span class="hljs-comment">#8  0x0000fffff26a373c in process_path (u=0xaaaaaab03700, path=0xaaaaaab18b00 &quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;) at modules/module-udev-detect.c:481</span><br><span class="hljs-comment">#9  0x0000fffff26a46ac in module_udev_detect_LTX_pa__init (m=0xaaaaaab00e20) at modules/module-udev-detect.c:789</span><br><span class="hljs-comment">#10 0x0000fffff7e67104 in pa_module_load (module=0xffffffffcfe8, c=0xaaaaaaae2ec0, name=0xaaaaaab011b0 &quot;module-udev-detect&quot;, argument=0x0) at pulsecore/module.c:187</span><br><span class="hljs-comment">#11 0x0000fffff7e50170 in pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaab011d0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:437</span><br><span class="hljs-comment">#12 0x0000fffff7e5774c in pa_cli_command_execute_line_stateful</span><br>    (c=0xaaaaaaae2ec0, s=0xffffffffd1c8 <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505, ifstate=0xffffffffd1c0) at pulsecore/cli-command.c:2136<br><span class="hljs-comment">#13 0x0000fffff7e57a00 in pa_cli_command_execute_file_stream (c=0xaaaaaaae2ec0, f=0xaaaaaaad58f0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:2176</span><br><span class="hljs-comment">#14 0x0000aaaaaaab90ac in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1112</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pa_alsa_path_probe</span><span class="hljs-params">(pa_alsa_path *p, pa_alsa_mapping *mapping, <span class="hljs-type">snd_mixer_t</span> *m, <span class="hljs-type">bool</span> ignore_dB)</span> &#123;<br>    pa_alsa_element *e;<br>    pa_alsa_jack *j;<br>    <span class="hljs-type">double</span> min_dB[PA_CHANNEL_POSITION_MAX], max_dB[PA_CHANNEL_POSITION_MAX];<br>    <span class="hljs-type">pa_channel_position_t</span> t;<br>    <span class="hljs-type">pa_channel_position_mask_t</span> path_volume_channels = <span class="hljs-number">0</span>;<br><br>    pa_assert(p);<br>    pa_assert(m);<br><br>    <span class="hljs-comment">// 如果路径已经被探测过，返回已知的支持状态</span><br>    <span class="hljs-keyword">if</span> (p-&gt;probed)<br>        <span class="hljs-keyword">return</span> p-&gt;supported ? <span class="hljs-number">0</span> : <span class="hljs-number">-1</span>;<br>    p-&gt;probed = <span class="hljs-literal">true</span>;<br><br>    pa_zero(min_dB);<br>    pa_zero(max_dB);<br><br>    pa_log_debug(<span class="hljs-string">&quot;Probing path &#x27;%s&#x27;&quot;</span>, p-&gt;name);<br><br>    <span class="hljs-comment">// 为路径中的每个插孔进行探测</span><br>    PA_LLIST_FOREACH(j, p-&gt;jacks) &#123;<br>        <span class="hljs-keyword">if</span> (jack_probe(j, mapping, m) &lt; <span class="hljs-number">0</span>) &#123;<br>            p-&gt;supported = <span class="hljs-literal">false</span>;<br>            pa_log_debug(<span class="hljs-string">&quot;Probe of jack &#x27;%s&#x27; failed.&quot;</span>, j-&gt;alsa_name);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        pa_log_debug(<span class="hljs-string">&quot;Probe of jack &#x27;%s&#x27; succeeded (%s)&quot;</span>, j-&gt;alsa_name, j-&gt;has_control ? <span class="hljs-string">&quot;found!&quot;</span> : <span class="hljs-string">&quot;not found&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 为路径中的每个元素进行探测</span><br>    PA_LLIST_FOREACH(e, p-&gt;elements) &#123;<br>        <span class="hljs-keyword">if</span> (element_probe(e, m) &lt; <span class="hljs-number">0</span>) &#123;<br>            p-&gt;supported = <span class="hljs-literal">false</span>;<br>            pa_log_debug(<span class="hljs-string">&quot;Probe of element &#x27;%s&#x27; failed.&quot;</span>, e-&gt;alsa_name);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        pa_log_debug(<span class="hljs-string">&quot;Probe of element &#x27;%s&#x27; succeeded (volume=%d, switch=%d, enumeration=%d).&quot;</span>, e-&gt;alsa_name, e-&gt;volume_use, e-&gt;switch_use, e-&gt;enumeration_use);<br><br>        <span class="hljs-comment">// 如果忽略 dB，将标志设为 false</span><br>        <span class="hljs-keyword">if</span> (ignore_dB)<br>            e-&gt;has_dB = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 处理合并音量的情况</span><br>        <span class="hljs-keyword">if</span> (e-&gt;volume_use == PA_ALSA_VOLUME_MERGE) &#123;<br>            <span class="hljs-comment">// 如果路径中没有音量元素，设置音量范围</span><br>            <span class="hljs-keyword">if</span> (!p-&gt;has_volume) &#123;<br>                p-&gt;min_volume = e-&gt;min_volume;<br>                p-&gt;max_volume = e-&gt;max_volume;<br>            &#125;<br><br>            <span class="hljs-comment">// 如果元素具有 dB 信息</span><br>            <span class="hljs-keyword">if</span> (e-&gt;has_dB) &#123;<br>                <span class="hljs-keyword">if</span> (!p-&gt;has_volume) &#123;<br>                    <span class="hljs-keyword">for</span> (t = <span class="hljs-number">0</span>; t &lt; PA_CHANNEL_POSITION_MAX; t++) &#123;<br>                        <span class="hljs-keyword">if</span> (PA_CHANNEL_POSITION_MASK(t) &amp; e-&gt;merged_mask) &#123;<br>                            min_dB[t] = e-&gt;min_dB;<br>                            max_dB[t] = e-&gt;max_dB;<br>                            path_volume_channels |= PA_CHANNEL_POSITION_MASK(t);<br>                        &#125;<br>                    &#125;<br>                    p-&gt;has_dB = <span class="hljs-literal">true</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (p-&gt;has_dB) &#123;<br>                        <span class="hljs-keyword">for</span> (t = <span class="hljs-number">0</span>; t &lt; PA_CHANNEL_POSITION_MAX; t++) &#123;<br>                            <span class="hljs-keyword">if</span> (PA_CHANNEL_POSITION_MASK(t) &amp; e-&gt;merged_mask) &#123;<br>                                min_dB[t] += e-&gt;min_dB;<br>                                max_dB[t] += e-&gt;max_dB;<br>                                path_volume_channels |= PA_CHANNEL_POSITION_MASK(t);<br>                            &#125;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">// 前面有一个不能进行 dB 音量的元素</span><br>                        e-&gt;volume_use = PA_ALSA_VOLUME_ZERO;<br>                        pa_log_info(<span class="hljs-string">&quot;Zeroing volume of &#x27;%s&#x27; on path &#x27;%s&#x27;&quot;</span>, e-&gt;alsa_name, p-&gt;name);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p-&gt;has_volume) &#123;<br>                <span class="hljs-comment">// 无法使用音量，将其标志为忽略</span><br>                e-&gt;volume_use = PA_ALSA_VOLUME_IGNORE;<br>                pa_log_info(<span class="hljs-string">&quot;Ignoring volume of &#x27;%s&#x27; on path &#x27;%s&#x27; (missing dB info)&quot;</span>, e-&gt;alsa_name, p-&gt;name);<br>            &#125;<br>            p-&gt;has_volume = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (e-&gt;switch_use == PA_ALSA_SWITCH_MUTE)<br>            p-&gt;has_mute = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果需要，检查 required-any 元素是否存在</span><br>    <span class="hljs-keyword">if</span> (p-&gt;has_req_any &amp;&amp; !p-&gt;req_any_present) &#123;<br>        p-&gt;supported = <span class="hljs-literal">false</span>;<br>        pa_log_debug(<span class="hljs-string">&quot;Skipping path &#x27;%s&#x27;, none of required-any elements preset.&quot;</span>, p-&gt;name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    path_drop_unsupported(p);<br>    path_make_options_unique(p);<br>    path_create_settings(p);<br><br>    p-&gt;supported = <span class="hljs-literal">true</span>;<br><br>    p-&gt;min_dB = INFINITY;<br>    p-&gt;max_dB = -INFINITY;<br><br>    <span class="hljs-keyword">for</span> (t = <span class="hljs-number">0</span>; t &lt; PA_CHANNEL_POSITION_MAX; t++) &#123;<br>        <span class="hljs-keyword">if</span> (path_volume_channels &amp; PA_CHANNEL_POSITION_MASK(t)) &#123;<br>            <span class="hljs-keyword">if</span> (p-&gt;min_dB &gt; min_dB[t])<br>                p-&gt;min_dB = min_dB[t];<br><br>            <span class="hljs-keyword">if</span> (p-&gt;max_dB &lt; max_dB[t])<br>                p-&gt;max_dB = max_dB[t];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="jack_probe">jack_probe</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  0x0000fffff24d1b38 in jack_probe (j=0xaaaaaacb4040, mapping=0xaaaaaab2c360, m=0xaaaaaad5f180) at modules/alsa/alsa-mixer.c:1849</span><br><span class="hljs-comment">#1  0x0000fffff24d62e4 in pa_alsa_path_probe (p=0xaaaaaacb3dd0, mapping=0xaaaaaab2c360, m=0xaaaaaad5f180, ignore_dB=false) at modules/alsa/alsa-mixer.c:2942</span><br><span class="hljs-comment">#2  0x0000fffff24db2c0 in mapping_paths_probe (m=0xaaaaaab2c360, profile=0xaaaaaab408a0, direction=PA_ALSA_DIRECTION_INPUT, used_paths=0xaaaaaac6b970)</span><br>    at modules/alsa/alsa-mixer.c:4152<br><span class="hljs-comment">#3  0x0000fffff24de19c in pa_alsa_profile_set_probe (ps=0xaaaaaab28120, dev_id=0xaaaaaab12450 &quot;0&quot;, ss=0xaaaaaaae2fec, default_n_fragments=4, default_fragment_size_msec=25)</span><br>    at modules/alsa/alsa-mixer.c:4933<br><span class="hljs-comment">#4  0x0000fffff268bd10 in module_alsa_card_LTX_pa__init (m=0xaaaaaab0f450) at modules/alsa/module-alsa-card.c:871</span><br><span class="hljs-comment">#5  0x0000fffff7e67104 in pa_module_load</span><br>    (module=0xffffffffcd90, c=0xaaaaaaae2ec0, name=0xfffff26a4d98 <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=0xaaaaaaadd8b0 <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...) at pulsecore/module.c:187<br><span class="hljs-comment">#6  0x0000fffff26a2d9c in verify_access (u=0xaaaaaab03700, d=0xaaaaaab071f0) at modules/module-udev-detect.c:333</span><br><span class="hljs-comment">#7  0x0000fffff26a32fc in card_changed (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:422</span><br><span class="hljs-comment">#8  0x0000fffff26a36bc in process_device (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:464</span><br><span class="hljs-comment">#9  0x0000fffff26a373c in process_path (u=0xaaaaaab03700, path=0xaaaaaab18b00 &quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;) at modules/module-udev-detect.c:481</span><br><span class="hljs-comment">#10 0x0000fffff26a46ac in module_udev_detect_LTX_pa__init (m=0xaaaaaab00e20) at modules/module-udev-detect.c:789</span><br><span class="hljs-comment">#11 0x0000fffff7e67104 in pa_module_load (module=0xffffffffcfe8, c=0xaaaaaaae2ec0, name=0xaaaaaab011b0 &quot;module-udev-detect&quot;, argument=0x0) at pulsecore/module.c:187</span><br><span class="hljs-comment">#12 0x0000fffff7e50170 in pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaab011d0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:437</span><br><span class="hljs-comment">#13 0x0000fffff7e5774c in pa_cli_command_execute_line_stateful</span><br>    (c=0xaaaaaaae2ec0, s=0xffffffffd1c8 <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505, ifstate=0xffffffffd1c0) at pulsecore/cli-command.c:2136<br><span class="hljs-comment">#14 0x0000fffff7e57a00 in pa_cli_command_execute_file_stream (c=0xaaaaaaae2ec0, f=0xaaaaaaad58f0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:2176</span><br><span class="hljs-comment">#15 0x0000aaaaaaab90ac in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1112</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 检测是否存在控制选项 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">jack_probe</span><span class="hljs-params">(pa_alsa_jack *j, pa_alsa_mapping *mapping, <span class="hljs-type">snd_mixer_t</span> *m)</span> &#123;<br>    <span class="hljs-type">bool</span> has_control;<br><br>    pa_assert(j);<br>    pa_assert(j-&gt;path);<br><br>    <span class="hljs-comment">/* 如果将 pcm 附加到名称中 */</span><br>    <span class="hljs-keyword">if</span> (j-&gt;append_pcm_to_name) &#123;<br>        <span class="hljs-type">char</span> *new_name;<br><br>        <span class="hljs-keyword">if</span> (!mapping) &#123;<br>            <span class="hljs-comment">/* 这也可以作为断言，因为这不应该发生。在撰写本文时，当 module-alsa-sink/source 合成路径时，映射只能为 NULL，而那些合成的路径永远不会有任何插孔，因此不应该调用 jack_probe() 以 NULL 映射。 */</span><br>            pa_log(<span class="hljs-string">&quot;插孔 %s: append_pcm_to_name 已设置，但映射为 NULL。无法使用此插孔。&quot;</span>, j-&gt;name);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        new_name = pa_sprintf_malloc(<span class="hljs-string">&quot;%s,pcm=%i Jack&quot;</span>, j-&gt;name, mapping-&gt;hw_device_index);<br>        pa_xfree(j-&gt;alsa_name);<br>        j-&gt;alsa_name = new_name;<br>        j-&gt;append_pcm_to_name = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* 查找是否有控制选项 */</span><br>    has_control = pa_alsa_mixer_find(m, j-&gt;alsa_name, <span class="hljs-number">0</span>) != <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    内部基于ucm设备的控制选项,故此函数啥都没干</span><br><span class="hljs-comment">    **/</span><br>    pa_alsa_jack_set_has_control(j, has_control);<br><br>    <span class="hljs-comment">/* 如果存在控制选项 */</span><br>    <span class="hljs-keyword">if</span> (j-&gt;has_control) &#123;<br>        <span class="hljs-keyword">if</span> (j-&gt;required_absent != PA_ALSA_REQUIRED_IGNORE)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        <span class="hljs-keyword">if</span> (j-&gt;required_any != PA_ALSA_REQUIRED_IGNORE)<br>            j-&gt;path-&gt;req_any_present = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">/* 如果不存在控制选项 */</span><br>        <span class="hljs-keyword">if</span> (j-&gt;required != PA_ALSA_REQUIRED_IGNORE)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) p *j<br><span class="hljs-variable">$71</span> = &#123;<br>  path = 0xaaaaaacb3dd0, <br>  next = 0xaaaaaacb3a20, <br>  prev = 0x0, <br>  name = 0xaaaaaacb3f20 <span class="hljs-string">&quot;Front Mic&quot;</span>, <br>  alsa_name = 0xaaaaaacb3fd0 <span class="hljs-string">&quot;Front Mic Jack&quot;</span>, <br>  has_control = <span class="hljs-literal">false</span>, <br>  plugged_in = <span class="hljs-literal">false</span>, <br>  melem = 0x0, <br>  state_unplugged = PA_AVAILABLE_NO, <br>  state_plugged = PA_AVAILABLE_YES, <br>  required = PA_ALSA_REQUIRED_IGNORE, <br>  required_any = PA_ALSA_REQUIRED_ANY, <br>  required_absent = PA_ALSA_REQUIRED_IGNORE, <br>  ucm_devices = 0xaaaaaac6e120, <br>  ucm_hw_mute_devices = 0xaaaaaac6c870, <br>  append_pcm_to_name = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) p *j-&gt;path<br>$<span class="hljs-number">72</span> = &#123;<br>  direction = PA_ALSA_DIRECTION_INPUT,<br>  port = <span class="hljs-number">0x0</span>,<br>  name = <span class="hljs-number">0xaaaaaacb3fb0</span> <span class="hljs-string">&quot;analog-input-front-mic&quot;</span>,<br>  description_key = <span class="hljs-number">0xaaaaaac6aa00</span> <span class="hljs-string">&quot;analog-input-microphone-front&quot;</span>,<br>  description = <span class="hljs-number">0xaaaaaacb4f20</span> <span class="hljs-string">&quot;前麦克风&quot;</span>,<br>  priority = <span class="hljs-number">85</span>,<br>  autodetect_eld_device = <span class="hljs-literal">false</span>,<br>  eld_device = <span class="hljs-number">-1</span>,<br>  proplist = <span class="hljs-number">0xaaaaaacb4a40</span>,<br>  probed = <span class="hljs-literal">true</span>,<br>  supported = <span class="hljs-literal">false</span>,<br>  has_mute = <span class="hljs-literal">false</span>,<br>  has_volume = <span class="hljs-literal">false</span>,<br>  has_dB = <span class="hljs-literal">false</span>,<br>  mute_during_activation = <span class="hljs-literal">false</span>,<br>  has_req_any = <span class="hljs-literal">true</span>,<br>  req_any_present = <span class="hljs-literal">false</span>,<br>  customized = <span class="hljs-literal">false</span>,<br>  min_volume = <span class="hljs-number">0</span>,<br>  max_volume = <span class="hljs-number">0</span>,<br>  min_dB = <span class="hljs-number">0</span>,<br>  max_dB = <span class="hljs-number">0</span>,<br>  last_element = <span class="hljs-number">0xaaaaaacc2f40</span>,<br>  last_option = <span class="hljs-number">0xaaaaaacc3800</span>,<br>--Type &lt;RET&gt; <span class="hljs-keyword">for</span> more, q to quit, c to <span class="hljs-keyword">continue</span> without paging--<br></code></pre></td></tr></table></figure>
<p>在vim命令模式下使用<code>:echo expand('%:p')</code>显示当前文件的绝对路径：
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20230817190632.png" srcset="/img/loading.gif" lazyload
alt="20230817190632" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) fin<br>Run till <span class="hljs-built_in">exit</span> from #<span class="hljs-number">0</span>  jack_probe (j=<span class="hljs-number">0xaaaaaacb4040</span>, mapping=<span class="hljs-number">0xaaaaaab2c360</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">1850</span><br>pa_alsa_path_probe (p=<span class="hljs-number">0xaaaaaacb3dd0</span>, mapping=<span class="hljs-number">0xaaaaaab2c360</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>, ignore_dB=<span class="hljs-literal">false</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">2942</span><br><span class="hljs-number">2942</span>            <span class="hljs-keyword">if</span> (jack_probe(j, mapping, m) &lt; <span class="hljs-number">0</span>) &#123;<br>Value returned is $<span class="hljs-number">73</span> = <span class="hljs-number">0</span><br>(gdb) until <span class="hljs-number">2951</span><br>(<span class="hljs-number">2323.588</span>| <span class="hljs-number">696.589</span>) D: [pulseaudio][modules/alsa/alsa-mixer.c:<span class="hljs-number">2947</span> pa_alsa_path_probe()] Probe of jack <span class="hljs-string">&#x27;Front Mic Jack&#x27;</span> succeeded (found!)<br>(<span class="hljs-number">2323.588</span>|   <span class="hljs-number">0.000</span>) D: [pulseaudio][modules/alsa/alsa-mixer.c:<span class="hljs-number">2947</span> pa_alsa_path_probe()] Probe of jack <span class="hljs-string">&#x27;Front Mic - Input Jack&#x27;</span> succeeded (not found)<br>(<span class="hljs-number">2323.588</span>|   <span class="hljs-number">0.000</span>) D: [pulseaudio][modules/alsa/alsa-mixer.c:<span class="hljs-number">2947</span> pa_alsa_path_probe()] Probe of jack <span class="hljs-string">&#x27;Front Mic Phantom Jack&#x27;</span> succeeded (not found)<br>(<span class="hljs-number">2323.588</span>|   <span class="hljs-number">0.000</span>) D: [pulseaudio][modules/alsa/alsa-mixer.c:<span class="hljs-number">2947</span> pa_alsa_path_probe()] Probe of jack <span class="hljs-string">&#x27;Front Line Out Front Jack&#x27;</span> succeeded (not found)<br>pa_alsa_path_probe (p=<span class="hljs-number">0xaaaaaacb3dd0</span>, mapping=<span class="hljs-number">0xaaaaaab2c360</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>, ignore_dB=<span class="hljs-literal">false</span>) at modules/alsa/alsa-mixer.c:<span class="hljs-number">2951</span><br><span class="hljs-number">2951</span>            <span class="hljs-keyword">if</span> (element_probe(e, m) &lt; <span class="hljs-number">0</span>) &#123;<br></code></pre></td></tr></table></figure>
<h5 id="element_probe">element_probe</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">(gdb) bt<br><span class="hljs-comment">#0  0x0000fffff24d1654 in element_probe (e=0xaaaaaacb62d0, m=0xaaaaaad5f180) at modules/alsa/alsa-mixer.c:1760</span><br><span class="hljs-comment">#1  0x0000fffff24d63c0 in pa_alsa_path_probe (p=0xaaaaaacb3dd0, mapping=0xaaaaaab2c360, m=0xaaaaaad5f180, ignore_dB=false) at modules/alsa/alsa-mixer.c:2951</span><br><span class="hljs-comment">#2  0x0000fffff24db2c0 in mapping_paths_probe (m=0xaaaaaab2c360, profile=0xaaaaaab408a0, direction=PA_ALSA_DIRECTION_INPUT, used_paths=0xaaaaaac6b970)</span><br>    at modules/alsa/alsa-mixer.c:4152<br><span class="hljs-comment">#3  0x0000fffff24de19c in pa_alsa_profile_set_probe (ps=0xaaaaaab28120, dev_id=0xaaaaaab12450 &quot;0&quot;, ss=0xaaaaaaae2fec, default_n_fragments=4, default_fragment_size_msec=25)</span><br>    at modules/alsa/alsa-mixer.c:4933<br><span class="hljs-comment">#4  0x0000fffff268bd10 in module_alsa_card_LTX_pa__init (m=0xaaaaaab0f450) at modules/alsa/module-alsa-card.c:871</span><br><span class="hljs-comment">#5  0x0000fffff7e67104 in pa_module_load</span><br>    (module=0xffffffffcd90, c=0xaaaaaaae2ec0, name=0xfffff26a4d98 <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=0xaaaaaaadd8b0 <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...) at pulsecore/module.c:187<br><span class="hljs-comment">#6  0x0000fffff26a2d9c in verify_access (u=0xaaaaaab03700, d=0xaaaaaab071f0) at modules/module-udev-detect.c:333</span><br><span class="hljs-comment">#7  0x0000fffff26a32fc in card_changed (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:422</span><br><span class="hljs-comment">#8  0x0000fffff26a36bc in process_device (u=0xaaaaaab03700, dev=0xaaaaaaaddc50) at modules/module-udev-detect.c:464</span><br><span class="hljs-comment">#9  0x0000fffff26a373c in process_path (u=0xaaaaaab03700, path=0xaaaaaab18b00 &quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;) at modules/module-udev-detect.c:481</span><br><span class="hljs-comment">#10 0x0000fffff26a46ac in module_udev_detect_LTX_pa__init (m=0xaaaaaab00e20) at modules/module-udev-detect.c:789</span><br><span class="hljs-comment">#11 0x0000fffff7e67104 in pa_module_load (module=0xffffffffcfe8, c=0xaaaaaaae2ec0, name=0xaaaaaab011b0 &quot;module-udev-detect&quot;, argument=0x0) at pulsecore/module.c:187</span><br><span class="hljs-comment">#12 0x0000fffff7e50170 in pa_cli_command_load (c=0xaaaaaaae2ec0, t=0xaaaaaab011d0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:437</span><br><span class="hljs-comment">#13 0x0000fffff7e5774c in pa_cli_command_execute_line_stateful</span><br>    (c=0xaaaaaaae2ec0, s=0xffffffffd1c8 <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505, ifstate=0xffffffffd1c0) at pulsecore/cli-command.c:2136<br><span class="hljs-comment">#14 0x0000fffff7e57a00 in pa_cli_command_execute_file_stream (c=0xaaaaaaae2ec0, f=0xaaaaaaad58f0, buf=0xaaaaaaadaf60, fail=0xaaaaaaad5505) at pulsecore/cli-command.c:2176</span><br><span class="hljs-comment">#15 0x0000aaaaaaab90ac in main (argc=4, argv=0xffffffffdd98) at daemon/main.c:1112</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 探测音频元素 */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">element_probe</span><span class="hljs-params">(pa_alsa_element *e, <span class="hljs-type">snd_mixer_t</span> *m)</span> &#123;<br>    <span class="hljs-type">snd_mixer_selem_id_t</span> *sid;<br>    <span class="hljs-type">snd_mixer_elem_t</span> *me;<br><br>    pa_assert(m);<br>    pa_assert(e);<br>    pa_assert(e-&gt;path);<br><br>    SELEM_INIT(sid, e-&gt;alsa_name);<br><br>    <span class="hljs-comment">// 用于在混音器中查找特定的音频元素，以便进行音量、开关等控制</span><br>    <span class="hljs-keyword">if</span> (!(me = snd_mixer_find_selem(m, sid))) &#123;<br><br>        <span class="hljs-keyword">if</span> (e-&gt;required != PA_ALSA_REQUIRED_IGNORE)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>        e-&gt;switch_use = PA_ALSA_SWITCH_IGNORE;<br>        e-&gt;volume_use = PA_ALSA_VOLUME_IGNORE;<br>        e-&gt;enumeration_use = PA_ALSA_ENUMERATION_IGNORE;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (e-&gt;switch_use != PA_ALSA_SWITCH_IGNORE) &#123;<br>        <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT) &#123;<br><br>            <span class="hljs-comment">// 检查给定的音频元素是否具有可用的播放开关</span><br>            <span class="hljs-keyword">if</span> (!snd_mixer_selem_has_playback_switch(me)) &#123;<br>                <span class="hljs-comment">// snd_mixer_selem_has_capture_switch 检查给定的音频元素是否具有可用的捕获开关（录音开关）</span><br>                <span class="hljs-keyword">if</span> (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_capture_switch(me))<br>                    e-&gt;direction = PA_ALSA_DIRECTION_INPUT;<br>                <span class="hljs-keyword">else</span><br>                    e-&gt;switch_use = PA_ALSA_SWITCH_IGNORE;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br><br>            <span class="hljs-keyword">if</span> (!snd_mixer_selem_has_capture_switch(me)) &#123;<br>                <span class="hljs-keyword">if</span> (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_playback_switch(me))<br>                    e-&gt;direction = PA_ALSA_DIRECTION_OUTPUT;<br>                <span class="hljs-keyword">else</span><br>                    e-&gt;switch_use = PA_ALSA_SWITCH_IGNORE;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (e-&gt;switch_use != PA_ALSA_SWITCH_IGNORE)<br>            e-&gt;direction_try_other = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!element_probe_volume(e, me))<br>        e-&gt;volume_use = PA_ALSA_VOLUME_IGNORE;<br><br>    <span class="hljs-keyword">if</span> (e-&gt;switch_use == PA_ALSA_SWITCH_SELECT) &#123;<br>        pa_alsa_option *o;<br><br>        PA_LLIST_FOREACH(o, e-&gt;options)<br>            o-&gt;alsa_idx = pa_streq(o-&gt;alsa_name, <span class="hljs-string">&quot;on&quot;</span>) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e-&gt;enumeration_use == PA_ALSA_ENUMERATION_SELECT) &#123;<br>        <span class="hljs-type">int</span> n;<br>        pa_alsa_option *o;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">        snd_mixer_selem_get_enum_items</span><br><span class="hljs-comment">        函数用于获取音频混音器元素（也称为音量控制器）的枚举选项数量。</span><br><span class="hljs-comment">        在音频控制中，有些元素可能是离散的，即它们只能在一组预定义选项中进行选择，例如音频输入源或音效设置。</span><br><span class="hljs-comment">        这个函数可以用来查询元素的枚举选项数量，以便在对应的设置中做出适当的选择。</span><br><span class="hljs-comment">        **/</span><br>        <span class="hljs-keyword">if</span> ((n = snd_mixer_selem_get_enum_items(me)) &lt; <span class="hljs-number">0</span>) &#123;<br>            pa_log(<span class="hljs-string">&quot;snd_mixer_selem_get_enum_items() 失败：%s&quot;</span>, pa_alsa_strerror(n));<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        PA_LLIST_FOREACH(o, e-&gt;options) &#123;<br>            <span class="hljs-type">int</span> i;<br><br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>                <span class="hljs-type">char</span> buf[<span class="hljs-number">128</span>];<br><br>                <span class="hljs-comment">// snd_mixer_selem_get_enum_item_name 用于获取混音器元素的不同枚举选项的可读名称，以便在用户界面中显示给用户选择</span><br>                <span class="hljs-keyword">if</span> (snd_mixer_selem_get_enum_item_name(me, i, <span class="hljs-keyword">sizeof</span>(buf), buf) &lt; <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">continue</span>;<br><br>                <span class="hljs-keyword">if</span> (!pa_streq(buf, o-&gt;alsa_name))<br>                    <span class="hljs-keyword">continue</span>;<br><br>                o-&gt;alsa_idx = i;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (check_required(e, me) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">ptype e<br>type = <span class="hljs-keyword">struct</span> pa_alsa_element &#123;<br>    pa_alsa_path *path;                  <span class="hljs-comment">/* 所属的音频路径 */</span><br>    pa_alsa_element *next;               <span class="hljs-comment">/* 下一个音频元素 */</span><br>    pa_alsa_element *prev;               <span class="hljs-comment">/* 上一个音频元素 */</span><br>    <span class="hljs-type">char</span> *alsa_name;                     <span class="hljs-comment">/* ALSA元素名 */</span><br>    <span class="hljs-type">pa_alsa_direction_t</span> direction;       <span class="hljs-comment">/* 方向 */</span><br>    <span class="hljs-type">pa_alsa_switch_use_t</span> switch_use;     <span class="hljs-comment">/* 开关使用方式 */</span><br>    <span class="hljs-type">pa_alsa_volume_use_t</span> volume_use;     <span class="hljs-comment">/* 音量使用方式 */</span><br>    <span class="hljs-type">pa_alsa_enumeration_use_t</span> enumeration_use; <span class="hljs-comment">/* 枚举使用方式 */</span><br>    <span class="hljs-type">pa_alsa_required_t</span> required;         <span class="hljs-comment">/* 必须存在 */</span><br>    <span class="hljs-type">pa_alsa_required_t</span> required_any;     <span class="hljs-comment">/* 任意必须存在 */</span><br>    <span class="hljs-type">pa_alsa_required_t</span> required_absent;  <span class="hljs-comment">/* 必须缺失 */</span><br>    <span class="hljs-type">long</span> constant_volume;                <span class="hljs-comment">/* 固定音量 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> override_map;           <span class="hljs-comment">/* 覆盖映射 */</span><br>    <span class="hljs-type">_Bool</span> direction_try_other : <span class="hljs-number">1</span>;       <span class="hljs-comment">/* 尝试其他方向 */</span><br>    <span class="hljs-type">_Bool</span> has_dB : <span class="hljs-number">1</span>;                    <span class="hljs-comment">/* 是否有分贝控制 */</span><br>    <span class="hljs-type">long</span> min_volume;                     <span class="hljs-comment">/* 最小音量 */</span><br>    <span class="hljs-type">long</span> max_volume;                     <span class="hljs-comment">/* 最大音量 */</span><br>    <span class="hljs-type">long</span> volume_limit;                   <span class="hljs-comment">/* 音量限制 */</span><br>    <span class="hljs-type">double</span> min_dB;                       <span class="hljs-comment">/* 最小分贝 */</span><br>    <span class="hljs-type">double</span> max_dB;                       <span class="hljs-comment">/* 最大分贝 */</span><br>    <span class="hljs-type">pa_channel_position_mask_t</span> masks[<span class="hljs-number">32</span>][<span class="hljs-number">8</span>]; <span class="hljs-comment">/* 通道掩码 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n_channels;             <span class="hljs-comment">/* 通道数 */</span><br>    <span class="hljs-type">pa_channel_position_mask_t</span> merged_mask; <span class="hljs-comment">/* 合并后的通道掩码 */</span><br>    pa_alsa_option *options;             <span class="hljs-comment">/* 选项 */</span><br>    pa_alsa_decibel_fix *db_fix;         <span class="hljs-comment">/* 分贝修正 */</span><br>&#125; *<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) p *e<br>$<span class="hljs-number">78</span> = &#123;         <br>  path = <span class="hljs-number">0xaaaaaacb3dd0</span>,                                        <br>  next = <span class="hljs-number">0xaaaaaacb6b70</span>,<br>  prev = <span class="hljs-number">0x0</span>,<br>  alsa_name = <span class="hljs-number">0xaaaaaacb3db0</span> <span class="hljs-string">&quot;Capture&quot;</span>,<br>  direction = PA_ALSA_DIRECTION_INPUT,<br>  switch_use = PA_ALSA_SWITCH_MUTE,<br>  volume_use = PA_ALSA_VOLUME_MERGE,<br>  enumeration_use = PA_ALSA_ENUMERATION_IGNORE,<br>  required = PA_ALSA_REQUIRED_IGNORE,<br>  required_any = PA_ALSA_REQUIRED_IGNORE,<br>  required_absent = PA_ALSA_REQUIRED_IGNORE,<br>  constant_volume = <span class="hljs-number">0</span>,<br>  override_map = <span class="hljs-number">3</span>,<br>  direction_try_other = <span class="hljs-literal">false</span>,<br>  has_dB = <span class="hljs-literal">false</span>,<br>  min_volume = <span class="hljs-number">0</span>,<br>  max_volume = <span class="hljs-number">0</span>,<br>  volume_limit = <span class="hljs-number">-1</span>,<br>  min_dB = <span class="hljs-number">0</span>,<br>  max_dB = <span class="hljs-number">0</span>,<br>  masks =     &#123;[<span class="hljs-number">0</span>] =       &#123;[<span class="hljs-number">0</span>] = <span class="hljs-number">2251799813685247</span>,<br>      [<span class="hljs-number">1</span>] = <span class="hljs-number">316659348800802</span>,<br>      [<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">6</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">7</span>] = <span class="hljs-number">0</span>&#125;,<br>    [<span class="hljs-number">1</span>] =       &#123;[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">1</span>] = <span class="hljs-number">633318697601604</span>,<br>      [<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">6</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">7</span>] = <span class="hljs-number">0</span>&#125;,<br>    [<span class="hljs-number">2</span>] =       &#123;[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">6</span>] = <span class="hljs-number">0</span>,<br>      [<span class="hljs-number">7</span>] = <span class="hljs-number">0</span>&#125; &lt;repeats <span class="hljs-number">30</span> times&gt;&#125;,<br>  n_channels = <span class="hljs-number">0</span>,<br>  merged_mask = <span class="hljs-number">0</span>,<br>  options = <span class="hljs-number">0x0</span>,<br>  db_fix = <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) p *m<br>$<span class="hljs-number">79</span> = &#123;<br>  slaves = &#123;<br>    next = <span class="hljs-number">0xaaaaaad5f1f8</span>, <br>    prev = <span class="hljs-number">0xaaaaaad5f1f8</span><br>  &#125;, <br>  classes = &#123;<br>    next = <span class="hljs-number">0xaaaaaad5f520</span>, <br>    prev = <span class="hljs-number">0xaaaaaad5fe20</span><br>  &#125;, <br>  elems = &#123;<br>    next = <span class="hljs-number">0xaaaaaad763e8</span>, <br>    prev = <span class="hljs-number">0xaaaaaad82028</span><br>  &#125;, <br>  pelems = <span class="hljs-number">0xaaaaaacad310</span>, <br>  count = <span class="hljs-number">29</span>, <br>  alloc = <span class="hljs-number">32</span>, <br>  events = <span class="hljs-number">65</span>, <br>  callback = <span class="hljs-number">0x0</span>, <br>  callback_private = <span class="hljs-number">0x0</span>, <br>  compare = <span class="hljs-number">0xfffff2563e10</span> &lt;snd_mixer_compare_default&gt;<br>&#125;<br></code></pre></td></tr></table></figure>
<h6 id="element_probe_volume">element_probe_volume</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">(gdb) bt<br>#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24d06bc</span> in <span class="hljs-title function_">element_probe_volume</span> <span class="hljs-params">(e=<span class="hljs-number">0xaaaaaacb62d0</span>, me=<span class="hljs-number">0xaaaaaad7f6b0</span>)</span> at modules/alsa/alsa-mixer.c:1543<br>#1  0x0000fffff24d1944 in <span class="hljs-title function_">element_probe</span> <span class="hljs-params">(e=<span class="hljs-number">0xaaaaaacb62d0</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>)</span> at modules/alsa/alsa-mixer.c:1806<br>#2  0x0000fffff24d63c0 in <span class="hljs-title function_">pa_alsa_path_probe</span> <span class="hljs-params">(p=<span class="hljs-number">0xaaaaaacb3dd0</span>, mapping=<span class="hljs-number">0xaaaaaab2c360</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>, ignore_dB=<span class="hljs-literal">false</span>)</span> at modules/alsa/alsa-mixer.c:2951<br>#3  0x0000fffff24db2c0 in <span class="hljs-title function_">mapping_paths_probe</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c360</span>, profile=<span class="hljs-number">0xaaaaaab408a0</span>, direction=PA_ALSA_DIRECTION_INPUT, used_paths=<span class="hljs-number">0xaaaaaac6b970</span>)</span><br>    at modules/alsa/alsa-mixer.c:4152<br>#4  0x0000fffff24de19c in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4933<br>#5  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#6  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#7  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#8  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#9  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#10 0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#11 0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#12 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#13 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#14 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#15 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#16 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">element_probe_volume</span><span class="hljs-params">(pa_alsa_element *e, <span class="hljs-type">snd_mixer_elem_t</span> *me)</span> &#123;<br>    <span class="hljs-comment">// 初始化变量</span><br>    <span class="hljs-type">long</span> min_dB = <span class="hljs-number">0</span>, max_dB = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> r;<br>    <span class="hljs-type">bool</span> is_mono;<br>    <span class="hljs-type">pa_channel_position_t</span> p;<br><br>    <span class="hljs-comment">// 根据方向检查音量支持情况</span><br>    <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT) &#123;<br>        <span class="hljs-comment">// 检查指定的混音器元素（音频通道或控制）是否支持播放音量控制</span><br>        <span class="hljs-keyword">if</span> (!snd_mixer_selem_has_playback_volume(me)) &#123;<br>            <span class="hljs-keyword">if</span> (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_capture_volume(me))<br>                e-&gt;direction = PA_ALSA_DIRECTION_INPUT;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!snd_mixer_selem_has_capture_volume(me)) &#123;<br>            <span class="hljs-keyword">if</span> (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_playback_volume(me))<br>                e-&gt;direction = PA_ALSA_DIRECTION_OUTPUT;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    e-&gt;direction_try_other = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">// 获取指定的混音器元素（音频通道或控制）的播放音量范围</span><br>    <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT)<br>        r = snd_mixer_selem_get_playback_volume_range(me, &amp;e-&gt;min_volume, &amp;e-&gt;max_volume);<br>    <span class="hljs-keyword">else</span><br>        r = snd_mixer_selem_get_capture_volume_range(me, &amp;e-&gt;min_volume, &amp;e-&gt;max_volume);<br><br>    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;Failed to get volume range of %s: %s&quot;</span>, e-&gt;alsa_name, pa_alsa_strerror(r));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查音量范围的合法性</span><br>    <span class="hljs-keyword">if</span> (e-&gt;min_volume &gt;= e-&gt;max_volume) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;Your kernel driver is broken: it reports a volume range from %li to %li which makes no sense.&quot;</span>,<br>                    e-&gt;min_volume, e-&gt;max_volume);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (e-&gt;volume_use == PA_ALSA_VOLUME_CONSTANT &amp;&amp; (e-&gt;min_volume &gt; e-&gt;constant_volume || e-&gt;max_volume &lt; e-&gt;constant_volume)) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;Constant volume %li configured for element %s, but the available range is from %li to %li.&quot;</span>,<br>                    e-&gt;constant_volume, e-&gt;alsa_name, e-&gt;min_volume, e-&gt;max_volume);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查是否需要修正 dB 范围</span><br>    <span class="hljs-keyword">if</span> (e-&gt;db_fix &amp;&amp; ((e-&gt;min_volume &gt; e-&gt;db_fix-&gt;min_step) || (e-&gt;max_volume &lt; e-&gt;db_fix-&gt;max_step))) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;The step range of the decibel fix for element %s (%li-%li) doesn&#x27;t fit to the &quot;</span><br>                    <span class="hljs-string">&quot;real hardware range (%li-%li). Disabling the decibel fix.&quot;</span>, e-&gt;alsa_name,<br>                    e-&gt;db_fix-&gt;min_step, e-&gt;db_fix-&gt;max_step, e-&gt;min_volume, e-&gt;max_volume);<br><br>        decibel_fix_free(e-&gt;db_fix);<br>        e-&gt;db_fix = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 确定是否支持 dB 范围，如果支持则获取 dB 范围</span><br>    <span class="hljs-keyword">if</span> (e-&gt;db_fix) &#123;<br>        e-&gt;has_dB = <span class="hljs-literal">true</span>;<br>        e-&gt;min_volume = e-&gt;db_fix-&gt;min_step;<br>        e-&gt;max_volume = e-&gt;db_fix-&gt;max_step;<br>        min_dB = e-&gt;db_fix-&gt;db_values[<span class="hljs-number">0</span>];<br>        max_dB = e-&gt;db_fix-&gt;db_values[e-&gt;db_fix-&gt;max_step - e-&gt;db_fix-&gt;min_step];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT)<br>        e-&gt;has_dB = snd_mixer_selem_get_playback_dB_range(me, &amp;min_dB, &amp;max_dB) &gt;= <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">else</span><br>        e-&gt;has_dB = snd_mixer_selem_get_capture_dB_range(me, &amp;min_dB, &amp;max_dB) &gt;= <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 检查核心驱动返回的限制是否与 _get_*_dB_range() 和 _ask_*_vol_dB() 一致</span><br>    <span class="hljs-keyword">if</span> (e-&gt;has_dB &amp;&amp; !e-&gt;db_fix) &#123;<br>        <span class="hljs-type">long</span> min_dB_checked = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">long</span> max_dB_checked = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">if</span> (element_ask_vol_dB(me, e-&gt;direction, e-&gt;min_volume, &amp;min_dB_checked) &lt; <span class="hljs-number">0</span>) &#123;<br>            pa_log_warn(<span class="hljs-string">&quot;Failed to query the dB value for %s at volume level %li&quot;</span>, e-&gt;alsa_name, e-&gt;min_volume);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (element_ask_vol_dB(me, e-&gt;direction, e-&gt;max_volume, &amp;max_dB_checked) &lt; <span class="hljs-number">0</span>) &#123;<br>            pa_log_warn(<span class="hljs-string">&quot;Failed to query the dB value for %s at volume level %li&quot;</span>, e-&gt;alsa_name, e-&gt;max_volume);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (min_dB != min_dB_checked || max_dB != max_dB_checked) &#123;<br>            pa_log_warn(<span class="hljs-string">&quot;Your kernel driver is broken: the reported dB range for %s (from %0.2f dB to %0.2f dB) &quot;</span><br>                        <span class="hljs-string">&quot;doesn&#x27;t match the dB values at minimum and maximum volume levels: %0.2f dB at level %li, &quot;</span><br>                        <span class="hljs-string">&quot;%0.2f dB at level %li.&quot;</span>, e-&gt;alsa_name, min_dB / <span class="hljs-number">100.0</span>, max_dB / <span class="hljs-number">100.0</span>,<br>                        min_dB_checked / <span class="hljs-number">100.0</span>, e-&gt;min_volume, max_dB_checked / <span class="hljs-number">100.0</span>, e-&gt;max_volume);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 确定是否支持 dB 范围，并设置最小和最大 dB 值</span><br>    <span class="hljs-keyword">if</span> (e-&gt;has_dB) &#123;<br>        e-&gt;min_dB = ((<span class="hljs-type">double</span>) min_dB) / <span class="hljs-number">100.0</span>;<br>        e-&gt;max_dB = ((<span class="hljs-type">double</span>) max_dB) / <span class="hljs-number">100.0</span>;<br><br>        <span class="hljs-keyword">if</span> (min_dB &gt;= max_dB) &#123;<br>            pa_assert(!e-&gt;db_fix);<br>            pa_log_warn(<span class="hljs-string">&quot;Your kernel driver is broken: it reports a volume range from %0.2f dB to %0.2f dB which makes no sense.&quot;</span>,<br>                        e-&gt;min_dB, e-&gt;max_dB);<br>            e-&gt;has_dB = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查和设置音量限制</span><br>    <span class="hljs-keyword">if</span> (e-&gt;volume_limit &gt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (e-&gt;volume_limit &lt;= e-&gt;min_volume || e-&gt;volume_limit &gt; e-&gt;max_volume)<br>            pa_log_warn(<span class="hljs-string">&quot;Volume limit for element %s of path %s is invalid: %li isn&#x27;t within the valid range &quot;</span><br>                        <span class="hljs-string">&quot;%li-%li. The volume limit is ignored.&quot;</span>,<br>                        e-&gt;alsa_name, e-&gt;path-&gt;name, e-&gt;volume_limit, e-&gt;min_volume + <span class="hljs-number">1</span>, e-&gt;max_volume);<br>        <span class="hljs-keyword">else</span> &#123;<br>            e-&gt;max_volume = e-&gt;volume_limit;<br><br>            <span class="hljs-keyword">if</span> (e-&gt;has_dB) &#123;<br>                <span class="hljs-keyword">if</span> (e-&gt;db_fix) &#123;<br>                    e-&gt;db_fix-&gt;max_step = e-&gt;max_volume;<br>                    e-&gt;max_dB = ((<span class="hljs-type">double</span>) e-&gt;db_fix-&gt;db_values[e-&gt;db_fix-&gt;max_step - e-&gt;db_fix-&gt;min_step]) / <span class="hljs-number">100.0</span>;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (element_ask_vol_dB(me, e-&gt;direction, e-&gt;max_volume, &amp;max_dB) &lt; <span class="hljs-number">0</span>) &#123;<br>                    pa_log_warn(<span class="hljs-string">&quot;Failed to get dB value of %s: %s&quot;</span>, e-&gt;alsa_name, pa_alsa_strerror(r));<br>                    e-&gt;has_dB = <span class="hljs-literal">false</span>;<br>                &#125; <span class="hljs-keyword">else</span><br>                    e-&gt;max_dB = ((<span class="hljs-type">double</span>) max_dB) / <span class="hljs-number">100.0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查单声道情况</span><br>    <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT)<br>        is_mono = snd_mixer_selem_is_playback_mono(me) &gt; <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">else</span><br>        is_mono = snd_mixer_selem_is_capture_mono(me) &gt; <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 处理单声道情况</span><br>    <span class="hljs-keyword">if</span> (is_mono) &#123;<br>        e-&gt;n_channels = <span class="hljs-number">1</span>;<br><br>        <span class="hljs-comment">// 检查和处理单声道的覆盖映射</span><br>        <span class="hljs-keyword">if</span> ((e-&gt;override_map &amp; (<span class="hljs-number">1</span> &lt;&lt; (e-&gt;n_channels<span class="hljs-number">-1</span>))) &amp;&amp; e-&gt;masks[SND_MIXER_SCHN_MONO][e-&gt;n_channels<span class="hljs-number">-1</span>] == <span class="hljs-number">0</span>) &#123;<br>            pa_log_warn(<span class="hljs-string">&quot;Override map for mono element %s is invalid, ignoring override map&quot;</span>, e-&gt;path-&gt;name);<br>            e-&gt;override_map &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; (e-&gt;n_channels<span class="hljs-number">-1</span>));<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!(e-&gt;override_map &amp; (<span class="hljs-number">1</span> &lt;&lt; (e-&gt;n_channels<span class="hljs-number">-1</span>)))) &#123;<br>            <span class="hljs-keyword">for</span> (p = PA_CHANNEL_POSITION_FRONT_LEFT; p &lt; PA_CHANNEL_POSITION_MAX; p++) &#123;<br>                <span class="hljs-keyword">if</span> (alsa_channel_ids[p] == SND_MIXER_SCHN_UNKNOWN)<br>                    <span class="hljs-keyword">continue</span>;<br>                e-&gt;masks[alsa_channel_ids[p]][e-&gt;n_channels<span class="hljs-number">-1</span>] = <span class="hljs-number">0</span>;<br>            &#125;<br>            e-&gt;masks[SND_MIXER_SCHN_MONO][e-&gt;n_channels<span class="hljs-number">-1</span>] = PA_CHANNEL_POSITION_MASK_ALL;<br>        &#125;<br>        e-&gt;merged_mask = e-&gt;masks[SND_MIXER_SCHN_MONO][e-&gt;n_channels<span class="hljs-number">-1</span>];<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理多声道情况</span><br>    e-&gt;n_channels = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (p = PA_CHANNEL_POSITION_FRONT_LEFT; p &lt; PA_CHANNEL_POSITION_MAX; p++) &#123;<br>        <span class="hljs-keyword">if</span> (alsa_channel_ids[p] == SND_MIXER_SCHN_UNKNOWN)<br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT)<br>            e-&gt;n_channels += snd_mixer_selem_has_playback_channel(me, alsa_channel_ids[p]) &gt; <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">else</span><br>            e-&gt;n_channels += snd_mixer_selem_has_capture_channel(me, alsa_channel_ids[p]) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查声道数是否合法</span><br>    <span class="hljs-keyword">if</span> (e-&gt;n_channels &lt;= <span class="hljs-number">0</span>) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;Volume element %s with no channels?&quot;</span>, e-&gt;alsa_name);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e-&gt;n_channels &gt; POSITION_MASK_CHANNELS) &#123;<br>        pa_log_warn(<span class="hljs-string">&quot;Volume element %s has %u channels. That&#x27;s too much! I can&#x27;t handle that!&quot;</span>, e-&gt;alsa_name, e-&gt;n_channels);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>retry:<br>    <span class="hljs-comment">// 处理声道覆盖映射</span><br>    <span class="hljs-keyword">if</span> (!(e-&gt;override_map &amp; (<span class="hljs-number">1</span> &lt;&lt; (e-&gt;n_channels<span class="hljs-number">-1</span>)))) &#123;<br>        <span class="hljs-keyword">for</span> (p = PA_CHANNEL_POSITION_FRONT_LEFT; p &lt; PA_CHANNEL_POSITION_MAX; p++) &#123;<br>            <span class="hljs-type">bool</span> has_channel;<br><br>            <span class="hljs-keyword">if</span> (alsa_channel_ids[p] == SND_MIXER_SCHN_UNKNOWN)<br>                <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT)<br>                has_channel = snd_mixer_selem_has_playback_channel(me, alsa_channel_ids[p]) &gt; <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">else</span><br>                has_channel = snd_mixer_selem_has_capture_channel(me, alsa_channel_ids[p]) &gt; <span class="hljs-number">0</span>;<br><br>            e-&gt;masks[alsa_channel_ids[p]][e-&gt;n_channels<span class="hljs-number">-1</span>] = has_channel ? PA_CHANNEL_POSITION_MASK(p) : <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    e-&gt;merged_mask = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (p = PA_CHANNEL_POSITION_FRONT_LEFT; p &lt; PA_CHANNEL_POSITION_MAX; p++) &#123;<br>        <span class="hljs-keyword">if</span> (alsa_channel_ids[p] == SND_MIXER_SCHN_UNKNOWN)<br>            <span class="hljs-keyword">continue</span>;<br><br>        e-&gt;merged_mask |= e-&gt;masks[alsa_channel_ids[p]][e-&gt;n_channels<span class="hljs-number">-1</span>];<br>    &#125;<br><br>    <span class="hljs-comment">// 处理无效的声道覆盖映射</span><br>    <span class="hljs-keyword">if</span> (e-&gt;merged_mask == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!(e-&gt;override_map &amp; (<span class="hljs-number">1</span> &lt;&lt; (e-&gt;n_channels<span class="hljs-number">-1</span>)))) &#123;<br>            pa_log_warn(<span class="hljs-string">&quot;Channel map for element %s is invalid&quot;</span>, e-&gt;path-&gt;name);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        pa_log_warn(<span class="hljs-string">&quot;Override map for element %s has empty result, ignoring override map&quot;</span>, e-&gt;path-&gt;name);<br>        e-&gt;override_map &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; (e-&gt;n_channels<span class="hljs-number">-1</span>));<br>        <span class="hljs-keyword">goto</span> retry;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h6 id="check_required">check_required</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">#<span class="hljs-number">0</span>  <span class="hljs-number">0x0000fffff24cffa0</span> in <span class="hljs-title function_">check_required</span> <span class="hljs-params">(e=<span class="hljs-number">0xaaaaaacb62d0</span>, me=<span class="hljs-number">0xaaaaaad7f6b0</span>)</span> at modules/alsa/alsa-mixer.c:1458<br>#1  0x0000fffff24d1adc in <span class="hljs-title function_">element_probe</span> <span class="hljs-params">(e=<span class="hljs-number">0xaaaaaacb62d0</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>)</span> at modules/alsa/alsa-mixer.c:1840<br>#2  0x0000fffff24d63c0 in <span class="hljs-title function_">pa_alsa_path_probe</span> <span class="hljs-params">(p=<span class="hljs-number">0xaaaaaacb3dd0</span>, mapping=<span class="hljs-number">0xaaaaaab2c360</span>, m=<span class="hljs-number">0xaaaaaad5f180</span>, ignore_dB=<span class="hljs-literal">false</span>)</span> at modules/alsa/alsa-mixer.c:2951<br>#3  0x0000fffff24db2c0 in <span class="hljs-title function_">mapping_paths_probe</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab2c360</span>, profile=<span class="hljs-number">0xaaaaaab408a0</span>, direction=PA_ALSA_DIRECTION_INPUT, used_paths=<span class="hljs-number">0xaaaaaac6b970</span>)</span><br>    at modules/alsa/alsa-mixer.c:4152<br>#4  0x0000fffff24de19c in <span class="hljs-title function_">pa_alsa_profile_set_probe</span> <span class="hljs-params">(ps=<span class="hljs-number">0xaaaaaab28120</span>, dev_id=<span class="hljs-number">0xaaaaaab12450</span> <span class="hljs-string">&quot;0&quot;</span>, ss=<span class="hljs-number">0xaaaaaaae2fec</span>, default_n_fragments=<span class="hljs-number">4</span>, default_fragment_size_msec=<span class="hljs-number">25</span>)</span><br>    at modules/alsa/alsa-mixer.c:4933<br>#5  0x0000fffff268bd10 in <span class="hljs-title function_">module_alsa_card_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab0f450</span>)</span> at modules/alsa/module-alsa-card.c:871<br>#6  0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span><br>    <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcd90</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xfffff26a4d98</span> <span class="hljs-string">&quot;module-alsa-card&quot;</span>, argument=<span class="hljs-number">0xaaaaaaadd8b0</span> <span class="hljs-string">&quot;device_id=\&quot;0\&quot; name=\&quot;platform-PHYT0006_00\&quot; card_name=\&quot;alsa_card.platform-PHYT0006_00\&quot; namereg_fail=false tsched=yes fixed_latency_range=no ignore_dB=no deferred_volume=yes use_ucm=yes card_properties=\&quot;&quot;</span>...)</span> at pulsecore/module.c:187<br>#7  0x0000fffff26a2d9c in <span class="hljs-title function_">verify_access</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, d=<span class="hljs-number">0xaaaaaab071f0</span>)</span> at modules/module-udev-detect.c:333<br>#8  0x0000fffff26a32fc in <span class="hljs-title function_">card_changed</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:422<br>#9  0x0000fffff26a36bc in <span class="hljs-title function_">process_device</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, dev=<span class="hljs-number">0xaaaaaaaddc50</span>)</span> at modules/module-udev-detect.c:464<br>#10 0x0000fffff26a373c in <span class="hljs-title function_">process_path</span> <span class="hljs-params">(u=<span class="hljs-number">0xaaaaaab03700</span>, path=<span class="hljs-number">0xaaaaaab18b00</span> <span class="hljs-string">&quot;/sys/devices/platform/PHYT0006:00/sound/card0&quot;</span>)</span> at modules/module-udev-detect.c:481<br>#11 0x0000fffff26a46ac in <span class="hljs-title function_">module_udev_detect_LTX_pa__init</span> <span class="hljs-params">(m=<span class="hljs-number">0xaaaaaab00e20</span>)</span> at modules/module-udev-detect.c:789<br>#12 0x0000fffff7e67104 in <span class="hljs-title function_">pa_module_load</span> <span class="hljs-params">(module=<span class="hljs-number">0xffffffffcfe8</span>, c=<span class="hljs-number">0xaaaaaaae2ec0</span>, name=<span class="hljs-number">0xaaaaaab011b0</span> <span class="hljs-string">&quot;module-udev-detect&quot;</span>, argument=<span class="hljs-number">0x0</span>)</span> at pulsecore/module.c:187<br>#13 0x0000fffff7e50170 in <span class="hljs-title function_">pa_cli_command_load</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, t=<span class="hljs-number">0xaaaaaab011d0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:437<br>#14 0x0000fffff7e5774c in <span class="hljs-title function_">pa_cli_command_execute_line_stateful</span><br>    <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, s=<span class="hljs-number">0xffffffffd1c8</span> <span class="hljs-string">&quot;load-module module-udev-detect&quot;</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>, ifstate=<span class="hljs-number">0xffffffffd1c0</span>)</span> at pulsecore/cli-command.c:2136<br>#15 0x0000fffff7e57a00 in <span class="hljs-title function_">pa_cli_command_execute_file_stream</span> <span class="hljs-params">(c=<span class="hljs-number">0xaaaaaaae2ec0</span>, f=<span class="hljs-number">0xaaaaaaad58f0</span>, buf=<span class="hljs-number">0xaaaaaaadaf60</span>, fail=<span class="hljs-number">0xaaaaaaad5505</span>)</span> at pulsecore/cli-command.c:2176<br>#16 0x0000aaaaaaab90ac in <span class="hljs-title function_">main</span> <span class="hljs-params">(argc=<span class="hljs-number">4</span>, argv=<span class="hljs-number">0xffffffffdd98</span>)</span> at daemon/main.c:1112<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_required</span><span class="hljs-params">(pa_alsa_element *e, <span class="hljs-type">snd_mixer_elem_t</span> *me)</span> &#123;<br>    <span class="hljs-comment">// 检查参数是否有效</span><br>    pa_assert(e);<br>    pa_assert(me);<br><br>    <span class="hljs-comment">// 根据音频元素的方向和属性，检查是否存在开关</span><br>    <span class="hljs-type">bool</span> has_switch;<br>    <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT) &#123;<br>        has_switch =<br>            snd_mixer_selem_has_playback_switch(me) ||<br>            (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_capture_switch(me));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        has_switch =<br>            snd_mixer_selem_has_capture_switch(me) ||<br>            (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_playback_switch(me));<br>    &#125;<br><br>    <span class="hljs-comment">// 根据音频元素的方向和属性，检查是否存在音量控制</span><br>    <span class="hljs-type">bool</span> has_volume;<br>    <span class="hljs-keyword">if</span> (e-&gt;direction == PA_ALSA_DIRECTION_OUTPUT) &#123;<br>        has_volume =<br>            snd_mixer_selem_has_playback_volume(me) ||<br>            (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_capture_volume(me));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        has_volume =<br>            snd_mixer_selem_has_capture_volume(me) ||<br>            (e-&gt;direction_try_other &amp;&amp; snd_mixer_selem_has_playback_volume(me));<br>    &#125;<br><br>    <span class="hljs-comment">// 检查音频元素是否是枚举类型</span><br>    <span class="hljs-type">bool</span> has_enumeration = snd_mixer_selem_is_enumerated(me);<br><br>    <span class="hljs-comment">// 根据音频元素的各种属性，进行不同的检查</span><br>    <span class="hljs-keyword">if</span> ((e-&gt;required == PA_ALSA_REQUIRED_SWITCH &amp;&amp; !has_switch) ||<br>        (e-&gt;required == PA_ALSA_REQUIRED_VOLUME &amp;&amp; !has_volume) ||<br>        (e-&gt;required == PA_ALSA_REQUIRED_ENUMERATION &amp;&amp; !has_enumeration))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">if</span> (e-&gt;required == PA_ALSA_REQUIRED_ANY &amp;&amp; !(has_switch || has_volume || has_enumeration))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">if</span> ((e-&gt;required_absent == PA_ALSA_REQUIRED_SWITCH &amp;&amp; has_switch) ||<br>        (e-&gt;required_absent == PA_ALSA_REQUIRED_VOLUME &amp;&amp; has_volume) ||<br>        (e-&gt;required_absent == PA_ALSA_REQUIRED_ENUMERATION &amp;&amp; has_enumeration))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-keyword">if</span> (e-&gt;required_absent == PA_ALSA_REQUIRED_ANY &amp;&amp; (has_switch || has_volume || has_enumeration))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-comment">// 根据音频元素的属性，更新 path 结构体的 req_any_present 属性</span><br>    <span class="hljs-keyword">if</span> (e-&gt;required_any != PA_ALSA_REQUIRED_IGNORE) &#123;<br>        <span class="hljs-keyword">switch</span> (e-&gt;required_any) &#123;<br>            <span class="hljs-keyword">case</span> PA_ALSA_REQUIRED_VOLUME:<br>                e-&gt;path-&gt;req_any_present |= (e-&gt;volume_use != PA_ALSA_VOLUME_IGNORE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> PA_ALSA_REQUIRED_SWITCH:<br>                e-&gt;path-&gt;req_any_present |= (e-&gt;switch_use != PA_ALSA_SWITCH_IGNORE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> PA_ALSA_REQUIRED_ENUMERATION:<br>                e-&gt;path-&gt;req_any_present |= (e-&gt;enumeration_use != PA_ALSA_ENUMERATION_IGNORE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> PA_ALSA_REQUIRED_ANY:<br>                e-&gt;path-&gt;req_any_present |=<br>                    (e-&gt;volume_use != PA_ALSA_VOLUME_IGNORE) ||<br>                    (e-&gt;switch_use != PA_ALSA_SWITCH_IGNORE) ||<br>                    (e-&gt;enumeration_use != PA_ALSA_ENUMERATION_IGNORE);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                pa_assert_not_reached();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果音频元素的 enumeration_use 属性为 PA_ALSA_ENUMERATION_SELECT</span><br>    <span class="hljs-comment">// 则检查每个选项是否满足要求，并更新 req_any_present 属性</span><br>    <span class="hljs-keyword">if</span> (e-&gt;enumeration_use == PA_ALSA_ENUMERATION_SELECT) &#123;<br>        pa_alsa_option *o;<br>        PA_LLIST_FOREACH(o, e-&gt;options) &#123;<br>            e-&gt;path-&gt;req_any_present |= (o-&gt;required_any != PA_ALSA_REQUIRED_IGNORE) &amp;&amp;<br>                (o-&gt;alsa_idx &gt;= <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (o-&gt;required != PA_ALSA_REQUIRED_IGNORE &amp;&amp; o-&gt;alsa_idx &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            <span class="hljs-keyword">if</span> (o-&gt;required_absent != PA_ALSA_REQUIRED_IGNORE &amp;&amp; o-&gt;alsa_idx &gt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 返回检查结果，如果满足要求返回 0，否则返回 -1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="关键断点">关键断点</h2>
<p>断点保存：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">save breakpoints pulseaudio.bk<br></code></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs text">break src/modules/alsa/alsa-mixer.c:3184<br>disable $bpnum<br>break src/modules/alsa/module-alsa-card.c:849<br>disable $bpnum<br>break src/modules/alsa/module-alsa-card.c:868<br>disable $bpnum<br>break src/modules/alsa/module-alsa-card.c:871<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4520<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4577<br>disable $bpnum<br>break src/pulsecore/conf-parser.c:167<br>disable $bpnum<br>break src/pulsecore/conf-parser.c:208<br>disable $bpnum<br>break src/pulsecore/conf-parser.c:83<br>disable $bpnum<br>break src/pulsecore/conf-parser.c:157<br>disable $bpnum<br>break src/pulsecore/conf-parser.c:42<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4782<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4890<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4701<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4833<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4867<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4651<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4881<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4719<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4923<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4115<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4127<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4141<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4156<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:3478<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4588<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4605<br>disable $bpnum<br>break main<br>disable $bpnum<br>break /home/uos/code/pulseaudio-12.2.58/src/daemon/daemon-conf.c:710<br>disable $bpnum<br>break /home/uos/code/pulseaudio-12.2.58/src/daemon/daemon-conf.c:540<br>disable $bpnum<br>break src/pulsecore/cli-command.c:2187<br>disable $bpnum<br>break src/pulsecore/cli-command.c:2136<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:4738<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:3184<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:3255<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:3284<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:1872<br>disable $bpnum<br>break /home/uos/code/pulseaudio-12.2.58/src/modules/alsa/alsa-mixer.c:151<br>disable $bpnum<br>break src/modules/alsa/alsa-ucm.c:1816<br>disable $bpnum<br>break src/modules/alsa/alsa-mixer.c:3015<br>disable $bpnum<br></code></pre></td></tr></table></figure>
<p>使用gdb info breakpoints查看当前断点，可以看到行号、函数名：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">i b<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c">Num     Type           Disp Enb Address            What                                                                                                                            <br><span class="hljs-number">1</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff24d78c4</span> in pa_alsa_path_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">3184</span>                                                                       <br><span class="hljs-number">2</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff268bbfc</span> in module_alsa_card_LTX_pa__init at modules/alsa/module-alsa-card.c:<span class="hljs-number">849</span>                                                         <br><span class="hljs-number">3</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff268bcb0</span> in module_alsa_card_LTX_pa__init at modules/alsa/module-alsa-card.c:<span class="hljs-number">868</span>                                                         <br><span class="hljs-number">4</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff268bcd0</span> in module_alsa_card_LTX_pa__init at modules/alsa/module-alsa-card.c:<span class="hljs-number">871</span>                                                         <br><span class="hljs-number">5</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff24dc94c</span> in pa_alsa_profile_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">4520</span>                                                                   <br><span class="hljs-number">6</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff24dcae4</span> in pa_alsa_profile_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">4577</span>                                                                   <br><span class="hljs-number">7</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff7dacf08</span> in pa_config_parse at pulsecore/conf-parser.c:<span class="hljs-number">168</span>                                                                               <br><span class="hljs-number">8</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff7dad190</span> in pa_config_parse at pulsecore/conf-parser.c:<span class="hljs-number">208</span>                                                                              <br><span class="hljs-number">9</span>       breakpoint     keep n   <span class="hljs-number">0x0000fffff7dac9e0</span> in parse_line at pulsecore/conf-parser.c:<span class="hljs-number">86</span>                                                                                    <br><span class="hljs-number">10</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff7dace98</span> in parse_line at pulsecore/conf-parser.c:<span class="hljs-number">157</span>                                                                                   <br><span class="hljs-number">11</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff7dac698</span> in normal_assignment at pulsecore/conf-parser.c:<span class="hljs-number">45</span>                                                                              <br><span class="hljs-number">12</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dd714</span> in pa_alsa_profile_set_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4787</span>                                                                 <br><span class="hljs-number">13</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24ddebc</span> in pa_alsa_profile_set_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4890</span>                                                                 <br><span class="hljs-number">14</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dd250</span> in add_profiles_to_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4705</span>                                                                     <br><span class="hljs-number">15</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24ddad0</span> in pa_alsa_profile_set_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4833</span>                                                                 <br><span class="hljs-number">16</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24ddd40</span> in pa_alsa_profile_set_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4867</span>                                                                 <br><span class="hljs-number">17</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dced8</span> in mapping_open_pcm at modules/alsa/alsa-mixer.c:<span class="hljs-number">4657</span>                                                                          <br><span class="hljs-number">18</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dde28</span> in pa_alsa_profile_set_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4881</span>                                                                 <br><span class="hljs-number">19</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dd348</span> in mapping_query_hw_device at modules/alsa/alsa-mixer.c:<span class="hljs-number">4719</span>                                                                   <br><span class="hljs-number">20</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24de0e8</span> in pa_alsa_profile_set_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4923</span>                                                                 <br><span class="hljs-number">21</span>      breakpoint     keep y   <span class="hljs-number">0x0000fffff24db120</span> in mapping_paths_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4116</span>                                                                       <br><span class="hljs-number">22</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24db150</span> in mapping_paths_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4127</span>                                                                       <br><span class="hljs-number">23</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24db22c</span> in mapping_paths_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4141</span>                                                                       <br><span class="hljs-number">24</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24db2fc</span> in mapping_paths_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4156</span>                                                                       <br><span class="hljs-number">25</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24d8bb8</span> in path_set_condense at modules/alsa/alsa-mixer.c:<span class="hljs-number">3478</span>                                                                         <br><span class="hljs-number">26</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dcb84</span> in pa_alsa_profile_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">4588</span>                                                                   <br><span class="hljs-number">27</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dcc9c</span> in profile_finalize_probing at modules/alsa/alsa-mixer.c:<span class="hljs-number">4605</span>                                                                  <br><span class="hljs-number">28</span>      breakpoint     keep n   <span class="hljs-number">0x0000aaaaaaab6fd8</span> in main at daemon/main.c:<span class="hljs-number">371</span>                                  <br><span class="hljs-number">29</span>      breakpoint     keep n   <span class="hljs-number">0x0000aaaaaaab43ac</span> in pa_daemon_conf_load at daemon/daemon-conf.c:<span class="hljs-number">710</span>                                                                             <br><span class="hljs-number">30</span>      breakpoint     keep n   <span class="hljs-number">0x0000aaaaaaab3674</span> in pa_get_hw_info at daemon/daemon-conf.c:<span class="hljs-number">540</span>                                                                                   <br><span class="hljs-number">31</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff7e57a88</span> in pa_cli_command_execute_file at pulsecore/cli-command.c:<span class="hljs-number">2187</span>                                                                 <br><span class="hljs-number">32</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff7e57730</span> in pa_cli_command_execute_line_stateful at pulsecore/cli-command.c:<span class="hljs-number">2136</span>                                                        <br><span class="hljs-number">33</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dd458</span> in pa_alsa_profile_set_cust_paths at modules/alsa/alsa-mixer.c:<span class="hljs-number">4747</span>                                                            <br><span class="hljs-number">34</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24d78c4</span> in pa_alsa_path_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">3184</span>                                                                      <br><span class="hljs-number">35</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24d7d04</span> in pa_alsa_path_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">3255</span>                                                                      <br><span class="hljs-number">37</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24d7f28</span> in pa_alsa_path_set_new at modules/alsa/alsa-mixer.c:<span class="hljs-number">3284</span>                                                                      <br><span class="hljs-number">38</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24d1cc0</span> in jack_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">1872</span>                                                                                <br><span class="hljs-number">39</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24ca6b8</span> in pa_alsa_jack_set_has_control at modules/alsa/alsa-mixer.c:<span class="hljs-number">151</span>                                                               <br><span class="hljs-number">40</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24c9c70</span> in pa_alsa_ucm_device_update_available at modules/alsa/alsa-ucm.c:<span class="hljs-number">1817</span>                                                         <br><span class="hljs-number">41</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24d67f0</span> in pa_alsa_path_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">3015</span>                                                                        <br><span class="hljs-number">42</span>      breakpoint     keep n   <span class="hljs-number">0x0000aaaaaaab393c</span> in pa_daemon_conf_load at daemon/daemon-conf.c:<span class="hljs-number">603</span>                                                                             <br><span class="hljs-number">44</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff7dac9e0</span> in parse_line at pulsecore/conf-parser.c:<span class="hljs-number">86</span>                                                                                    <br><span class="hljs-number">45</span>      breakpoint     keep n   <span class="hljs-number">0x0000aaaaaaab3674</span> in pa_get_hw_info at daemon/daemon-conf.c:<span class="hljs-number">540</span>                                          <br><span class="hljs-number">46</span>      breakpoint     keep n   <span class="hljs-number">0x0000aaaaaaab5f3c</span> in pa_ltdl_init at daemon/ltdl-bind-now.c:<span class="hljs-number">118</span><br><span class="hljs-number">47</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dbb30</span> in profile_set_add_auto at modules/alsa/alsa-mixer.c:<span class="hljs-number">4306</span><br><span class="hljs-number">49</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dd250</span> in add_profiles_to_probe at modules/alsa/alsa-mixer.c:<span class="hljs-number">4705</span><br><span class="hljs-number">50</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24dced8</span> in mapping_open_pcm at modules/alsa/alsa-mixer.c:<span class="hljs-number">4657</span><br><span class="hljs-number">51</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24bf814</span> in pa_alsa_open_by_template at modules/alsa/alsa-util.c:<span class="hljs-number">791</span><br><span class="hljs-number">52</span>      breakpoint     keep n   <span class="hljs-number">0x0000fffff24bf39c</span> in pa_alsa_open_by_device_string at modules/alsa/alsa-util.c:<span class="hljs-number">686</span><br></code></pre></td></tr></table></figure>
<p>断点恢复：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> pulseaudio.bk<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/" class="category-chain-item">kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/drivers/" class="category-chain-item">drivers</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/drivers/sound/" class="category-chain-item">sound</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/drivers/sound/pulseaudio/" class="category-chain-item">pulseaudio</a>
  
  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/git/">#git</a>
      
        <a href="/tags/strings/">#strings</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>pulseaudio调试</div>
      <div>https://realwujing.github.io/linux/kernel/drivers/sound/pulseaudio/pulseaudio调试/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/linux/kernel/drivers/sound/pulseaudio/pulseaudio/" title="pulseaudio">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">pulseaudio</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/kernel/drivers/sound/pulseaudio/pa_alsa_profile_set_new/" title="pa_alsa_profile_set_new">
                        <span class="hidden-mobile">pa_alsa_profile_set_new</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'd01c1ac2af674adbcca13dd7083f19a4'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
