# Linux 4.19 å†…æ ¸ Tickless æœºåˆ¶ä¸ RCU Stall é—®é¢˜åˆ†ææ€»ç»“

## é—®é¢˜æè¿°

### 1. å†…æ ¸ç‰ˆæœ¬åŠç¯å¢ƒä¿¡æ¯

```bash
uname -a
```

ç»“æœï¼š

```
Linux gzinf-kunpeng-55e235e17e57 4.19.90-2102.2.0.0068.ctl2.aarch64 #1 SMP Tue Aug 22 10:53:53 UTC 2023 aarch64 aarch64 aarch64 GNU/Linux
```

---

### 2. å†…æ ¸å¯åŠ¨å‚æ•°

```bash
cat /proc/cmdline
```

ç»“æœï¼š

```
BOOT_IMAGE=(hd0,3)/vmlinuz-4.19.90-2102.2.0.0068.ctl2.aarch64 root=UUID=216fa54f-9345-4f9a-8fe2-dc3a44db7775 ro console=tty0 pci=realloc pciehp.pciehp_force=1 biosdevname=0 net.ifnames-0 console=ttyS0,115200n8 crashkernel=1024M,high smmu.bypassdev=0x1000:0x17 smmu.bypassdev=0x1000:0x15 video=efifb:off
```

---

### 3. å†…æ ¸é…ç½®ç›¸å…³

```bash
grep -E "CONFIG_HZ|CONFIG_HIGH_RES_TIMERS|CONFIG_NO_HZ" /boot/config-$(uname -r)
```

ç»“æœï¼š

```
# CONFIG_HZ_PERIODIC is not set
CONFIG_HIGH_RES_TIMERS=y
# CONFIG_HZ_100 is not set
CONFIG_HZ_250=y
# CONFIG_HZ_300 is not set
# CONFIG_HZ_1000 is not set
CONFIG_HZ=250
CONFIG_NO_HZ_COMMON=y
# CONFIG_NO_HZ_IDLE is not set
CONFIG_NO_HZ_FULL=y
CONFIG_NO_HZ=y
```

---

### 4. å½“å‰æ—¶é’Ÿæº

```bash
cat /sys/devices/system/clocksource/clocksource0/current_clocksource
```

ç»“æœï¼š

```
arch_sys_counter
```

---

### 5. CPU Tickless çŠ¶æ€

```bash
grep 'tick_stopped' /proc/timer_list
```

éƒ¨åˆ†ç»“æœï¼ˆéƒ¨åˆ†æˆªå–ï¼‰ï¼š

```
.tick_stopped   : 1
.tick_stopped   : 1
...
.tick_stopped   : 0
.tick_stopped   : 1
...
```

è¯´æ˜æœ‰äº› CPU å·²è¿›å…¥ ticklessï¼ˆtick\_stopped:1ï¼‰ï¼Œéƒ¨åˆ†å°šæœªåœæ­¢è°ƒåº¦ tickã€‚

* é€šè¿‡ `CONFIG_NO_HZ` åŠ `CONFIG_NO_HZ_FULL` å¯ç”¨ï¼Œæ”¯æŒåœ¨ CPU ç©ºé—²æ—¶å…³é—­å‘¨æœŸè°ƒåº¦ tickï¼Œå‡å°‘æ— ç”¨ä¸­æ–­ï¼Œæé«˜èƒ½æ•ˆã€‚
* **CPU idle æˆ–è¿è¡Œéå†…æ ¸æ€ä»»åŠ¡æ—¶ï¼Œè°ƒåº¦ tick ä¼šåœæ­¢ï¼ˆticklessï¼‰ï¼Œåªä¿ç•™å¿…è¦å®šæ—¶å™¨ã€‚**
* å¿…è¦ä¿ç•™çš„å®šæ—¶å™¨ä¸»è¦åŒ…æ‹¬ï¼š

  * **hrtimer**ï¼šç”¨äºé«˜ç²¾åº¦å®šæ—¶ä»»åŠ¡ã€‚
  * **RCU å®šæ—¶å™¨**ï¼šä¿éšœå†…æ ¸åŒæ­¥å’Œå›è°ƒæœºåˆ¶ã€‚
  * **watchdog å®šæ—¶å™¨**ï¼šç³»ç»Ÿçœ‹é—¨ç‹—ï¼Œé˜²æ­¢æ­»é”ã€‚

---

### 6. æŸ¥çœ‹å®šæ—¶å™¨è¯¦ç»†çŠ¶æ€ï¼ˆCPU0ä¸ºä¾‹ï¼‰

```bash
cat /proc/timer_list | grep -A10 'cpu: 0'
```

éƒ¨åˆ†ç»“æœï¼š

```
cpu: 0
 clock 0:
  .base:       0000000059048cdc
  .index:      0
  .resolution: 1 nsecs
  .get_time:   ktime_get
  .offset:     0 nsecs
active timers:
 #0: <00000000410c4969>, tick_sched_timer, S:01
 # expires at 9855148276000000-9855148276000000 nsecs [in 97383564 to 97383564 nsecs]
 #1: <00000000e2898855>, kvm_bg_timer_expire, S:01
```

å…¶ä¸­ `tick_sched_timer` æ˜¯ä¼ ç»Ÿè°ƒåº¦å‘¨æœŸä¸­æ–­ã€‚

---

### 7. ç°è±¡ä¸é—®é¢˜

* CPU idle åè¿›å…¥ ticklessï¼Œ`.tick_stopped` ä¸º 1ã€‚
* ä½†å‡ºç° RCU stall å’Œ rcu\_sched è¢«é¥¿æ­»60ç§’ï¼Œç”šè‡³ rcu hard lockupã€‚
* è¯¥ç°è±¡å¯èƒ½ç”±æ·±åº¦ç¡çœ å¯¼è‡´æ—¶é’Ÿæºæš‚åœæˆ–å¤±æ•ˆï¼Œhrtimer æ— æ³•è§¦å‘è½¯ä¸­æ–­ã€‚
* å¯¼è‡´ RCU è½¯ä¸­æ–­å¾—ä¸åˆ°æ‰§è¡Œï¼Œå†…æ ¸åŒæ­¥å—é˜»ã€‚

---

### 8. å…³é—­ tickless è¯•éªŒï¼ˆä¸´æ—¶ï¼‰

* åœ¨ grub å¯åŠ¨å‚æ•°æ·»åŠ  `nohz=off`
* è¿è¡Œåï¼Œ`/proc/timer_list` ä¸­ `.tick_stopped` åº”å…¨ä¸º 0ï¼Œè¡¨ç¤ºè°ƒåº¦ tick ä¸è¢«åœæ­¢ã€‚
* æ£€æŸ¥ç³»ç»Ÿç¨³å®šæ€§ï¼Œè‹¥æ—  RCU stallï¼Œè¯´æ˜ tickless ç›¸å…³å¯¼è‡´é—®é¢˜ã€‚

---

### 9. ä¼ ç»Ÿæ—¶é’Ÿä¸­æ–­ä¸é«˜ç²¾åº¦å®šæ—¶å™¨ï¼ˆhrtimerï¼‰é…åˆ

* `sched tick` ä»¥å›ºå®šé¢‘ç‡äº§ç”Ÿè°ƒåº¦ä¸­æ–­ï¼Œé©±åŠ¨è½¯ä¸­æ–­æ‰§è¡Œ RCUã€è°ƒåº¦ç­‰ã€‚
* `hrtimer` ç”¨äº tickless æ¨¡å¼æ›¿ä»£ä¼ ç»Ÿ tickï¼Œç²¾å‡†è°ƒåº¦å®šæ—¶ä»»åŠ¡ã€‚
* ä¸¤è€…ç»“åˆï¼Œåœ¨ idle åŠç”¨æˆ·æ€è¿è¡Œæ—¶é™ä½ä¸­æ–­é¢‘ç‡ï¼ŒèŠ‚çœåŠŸè€—ã€‚
* ä½†è‹¥ç¡¬ä»¶æ—¶é’Ÿæºå¼‚å¸¸æˆ–æ·±åº¦ç¡çœ å½±å“ hrtimerï¼Œè½¯ä¸­æ–­æ— æ³•åŠæ—¶è§¦å‘ï¼Œå¯¼è‡´ RCU stallã€‚

---

#### å…³äº hrtimer ä¸ä¼ ç»Ÿè°ƒåº¦ timerï¼ˆsched\_timerï¼‰çš„å…³ç³»

* **hrtimerï¼ˆé«˜ç²¾åº¦å®šæ—¶å™¨ï¼‰** å¯ç”¨åï¼Œ
  å®ƒä¼š **ä»£æ›¿ä¼ ç»Ÿçš„ä½ç²¾åº¦å‘¨æœŸå®šæ—¶å™¨ï¼ˆå¦‚ jiffies-based timerï¼‰æ¥è°ƒåº¦é«˜ç²¾åº¦ä»»åŠ¡**ï¼Œ
  ä¾‹å¦‚ç²¾ç¡®çš„è¶…æ—¶å’Œå»¶æ—¶éœ€æ±‚ã€‚

* ä½†æ˜¯ï¼Œ**sched\_timerï¼ˆè°ƒåº¦å‘¨æœŸ timerï¼‰å¹¶ä¸ä¼šå®Œå…¨è¢«ç§»é™¤**ï¼Œ
  å®ƒä¾ç„¶ä¿ç•™ç€è°ƒåº¦å™¨åŸºæœ¬çš„è°ƒåº¦èŠ‚å¥æ§åˆ¶ä½œç”¨ï¼Œ
  ç‰¹åˆ«æ˜¯åœ¨é tickless æ¨¡å¼æˆ– CPU æ´»è·ƒçŠ¶æ€ä¸‹çš„è°ƒåº¦å‘¨æœŸç»´æŠ¤ã€‚

* åœ¨ **tickless æ¨¡å¼ä¸‹ï¼ˆNO\_HZï¼‰**ï¼Œsched\_timer å¯èƒ½ä¼šè¢«åœæ­¢ï¼ˆtick\_stopped=1ï¼‰ï¼Œ
  ä½†å®ƒä»ä½œä¸ºâ€œå¤‡èƒâ€å­˜åœ¨äºå†…æ ¸ä¸­ï¼Œæ–¹ä¾¿æ¢å¤è°ƒåº¦ tickï¼Œ
  ä»¥åŠå¤„ç†æŸäº›å¿…é¡»ä¾èµ–ä¼ ç»Ÿå‘¨æœŸ tick çš„åŠŸèƒ½ã€‚

* hrtimer å’Œ sched\_timer æ˜¯ **ååŒå·¥ä½œçš„**ï¼Œ
  ä¿è¯è°ƒåº¦çš„å‡†ç¡®æ€§å’Œç³»ç»Ÿå“åº”çš„çµæ´»æ€§ã€‚

---

## â±ï¸ hrtimer ä¸ä¼ ç»Ÿ tick å®šæ—¶å™¨çš„ååŒæœºåˆ¶ï¼ˆæ ¸å¿ƒè®²è§£ï¼‰

### âœ… **ä¸€ã€ä¼ ç»Ÿä½ç²¾åº¦å®šæ—¶å™¨æœºåˆ¶ï¼ˆtimer wheelï¼‰**

* ä¾èµ– **å‘¨æœŸæ€§ tick ä¸­æ–­** é©±åŠ¨ï¼ˆæ¥æºäº CONFIG\_HZ è®¾ç½®ï¼‰ã€‚
* æ¯æ¬¡ tick ä¼šæ¨è¿› `jiffies`ï¼Œå¹¶æ‰«æå½“å‰ slot è§¦å‘ callbackã€‚
* ç‰¹ç‚¹ï¼š**ç²’åº¦è¾ƒç²—ï¼ˆ4msï¼‰ã€å»¶è¿Ÿé«˜ã€æ•ˆç‡é«˜ï¼ˆé€‚åˆå¤§æ‰¹ä»»åŠ¡ï¼‰**ã€‚

---

### âœ… **äºŒã€é«˜ç²¾åº¦å®šæ—¶å™¨ hrtimer çš„å¼•å…¥**

* ç”±æ¯ä¸ª CPU çš„ `hrtimer_cpu_base` ç®¡ç†ï¼Œç”¨çº¢é»‘æ ‘å­˜å‚¨ã€‚
* å¯ä»¥ç²¾ç¡®åˆ°çº³ç§’çº§çš„å®šæ—¶ä¸­æ–­ã€‚
* å®šæ—¶å™¨ç¡¬ä»¶åªèƒ½åŒæ—¶æœåŠ¡ä¸€ä¸ª timeout â†’ é€‰æ‹©æœ€æ—©çš„ hrtimer äº‹ä»¶ä½œä¸ºå®šæ—¶è§¦å‘ç‚¹ã€‚

---

### âœ… **ä¸‰ã€hrtimer å¦‚ä½•æ¨¡æ‹Ÿâ€œtickâ€ä»¥ååŒå·¥ä½œï¼Ÿ**

> hrtimer æ›¿ä»£äº†éƒ¨åˆ†ä¼ ç»Ÿ timerï¼Œä½†ä»ä¿ç•™äº† tick çš„å‘¨æœŸæ€§è§’è‰²ï¼š`sched_timer`ã€‚

#### 1. **sched\_timer æ˜¯ä¸€ä¸ªå‘¨æœŸæ€§çš„ hrtimerï¼Œç”¨äºæ¨¡æ‹Ÿæ¯ä¸ª tick**

* å…¶è¶…æ—¶å€¼è®¾ç½®ä¸º `1 / CONFIG_HZ = 4ms`ã€‚
* è§¦å‘åä¼šï¼š

  * è°ƒç”¨ `update_process_times()`ï¼Œé©±åŠ¨è°ƒåº¦å™¨ã€è¿›ç¨‹ç»Ÿè®¡ç­‰ã€‚
  * `update_wall_time()`ï¼Œé©±åŠ¨æ—¶é’Ÿæ›´æ–°ã€‚
  * ç„¶å **å†æ¬¡æ’å…¥ä¸‹ä¸€ä¸ª tick çš„ hrtimer**ï¼ˆå³å‘¨æœŸæ€§é‡æ’ï¼‰ã€‚

#### 2. **å¦‚æœç³»ç»Ÿç©ºé—²ï¼Œå¯ä»¥å…³é—­ tickï¼ˆtickless æ¨¡å¼ï¼‰**

* åœ¨ä½ ç³»ç»Ÿä¸­ï¼Œå¤§é‡ `.tick_stopped: 1` â†’ å¤šæ ¸å·²å¯ç”¨ **åŠ¨æ€ tick åœæ­¢**ï¼ˆNOHZï¼‰ã€‚
* ç³»ç»Ÿä¼šåˆ¤æ–­æœªæ¥æ˜¯å¦æœ‰è¿‘æœŸä»»åŠ¡è¦åšï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¸è®¾ç½®ä¸‹ä¸€ä¸ª sched\_timerã€‚
* ç­‰åˆ°ä¸‹ä¸€ä¸ªæ˜ç¡®äº‹ä»¶ï¼ˆæ¯”å¦‚ hrtimer æˆ–å”¤é†’ï¼‰å†å¯åŠ¨ tickã€‚

#### 3. **å¦‚æœæœ‰ hrtimer åˆ°æœŸæ—¶é—´æ›´æ—©ï¼Œsched\_timer ä¼šè¢«æ¨å**

* hrtimer çš„çº¢é»‘æ ‘ä¸­è°ƒåº¦çš„æ˜¯â€œæœ€æ—©åˆ°æœŸæ—¶é—´â€çš„äº‹ä»¶ã€‚
* æ¯”å¦‚ç”¨æˆ·è®¾å®šçš„ 2ms è¶…æ—¶ä»»åŠ¡ä¼šæŠ¢å åŸæœ¬çš„ sched\_timer è®¾ç½®ã€‚

---

### âœ… **å››ã€ååŒæœºåˆ¶å°ç»“ï¼š**

| ç±»å‹                       | é©±åŠ¨æ¥æº               | ç²¾åº¦              | åº”ç”¨åœºæ™¯              |
| ------------------------ | ------------------ | --------------- | ----------------- |
| `jiffies` / `timer_list` | å‘¨æœŸ tickï¼ˆä½ç²¾åº¦ï¼‰       | æ¯«ç§’çº§ï¼ˆCONFIG\_HZï¼‰ | å¤§é‡ä»»åŠ¡ï¼Œæ€§èƒ½å‹å¥½         |
| `sched_timer`            | hrtimer é©±åŠ¨çš„æ¨¡æ‹Ÿ tick | çº³ç§’çº§ï¼Œä½†å‘¨æœŸæ€§ä¸º 4ms   | è°ƒåº¦ã€ç»Ÿè®¡ã€timekeeping |
| å…¶ä»– `hrtimer`             | ç‹¬ç«‹è®¾ç½®ã€å•æ¬¡/å‘¨æœŸä»»åŠ¡       | çº³ç§’çº§             | ç¡çœ å”¤é†’ã€å®šæ—¶å™¨ç²¾ç¡®å”¤é†’      |

å½“å‰ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯ï¼š

* åœ¨ä¸éœ€è¦æ—¶**åœæ‰ tick ä¸­æ–­**ï¼ˆçœç”µã€å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼›
* ä¾èµ– `hrtimer` ç®¡ç†æ‰€æœ‰ timerï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿ tickï¼›
* ä¿ç•™ `CONFIG_HZ=250`ï¼Œtick æ¨¡æ‹Ÿå‘¨æœŸä¸º 4msï¼Œç”¨äº fallback è·¯å¾„ã€‚

---

## é‚£å½“å‰çš„é…ç½®ä¸‹cpu idleçŠ¶æ€é»˜è®¤ä¼šè¿›å…¥ticklessï¼Ÿ

æ˜¯çš„ï¼Œæ ¹æ®æä¾›çš„å†…æ ¸é…ç½®å’Œç³»ç»Ÿä¿¡æ¯ï¼Œ**å½“å‰ CPU åœ¨ idle çŠ¶æ€ä¸‹é»˜è®¤ç¡®å®ä¼šè¿›å…¥ tickless æ¨¡å¼ï¼ˆå³åœæ­¢å‘¨æœŸæ€§ tick ä¸­æ–­ï¼‰**ã€‚ä¸‹é¢æ˜¯åˆ†æä¾æ®ï¼š

---

### âœ… ä¸€ã€é…ç½®é¡¹åˆ†æ

```bash
CONFIG_NO_HZ_COMMON=y
CONFIG_NO_HZ_FULL=y
CONFIG_NO_HZ=y
# CONFIG_NO_HZ_IDLE is not set
```

* `CONFIG_NO_HZ=y`ï¼šè¯´æ˜å¯ç”¨äº† tickless æ”¯æŒï¼›
* `CONFIG_NO_HZ_COMMON=y`ï¼šæ˜¯ `NO_HZ_IDLE` å’Œ `NO_HZ_FULL` çš„å…¬å…±åŸºç¡€ï¼›
* `CONFIG_NO_HZ_FULL=y`ï¼šè¡¨ç¤ºç³»ç»Ÿ**å¯ç”¨äº†å®Œæ•´ tickless æ¨¡å¼**ï¼ˆNO\_HZ\_FULLï¼‰ï¼Œç”¨äºç”¨æˆ·æ€ï¼›
* `# CONFIG_NO_HZ_IDLE is not set`ï¼šè¡¨ç¤º**æ²¡æœ‰ä½¿ç”¨ idle ä¸“ç”¨ tickless æ¨¡å¼**ï¼Œå› ä¸ºè¢« `FULL` æ›¿ä»£ã€‚

> âœ… `NO_HZ_IDLE` æ˜¯ä¸ºäº† idle çŠ¶æ€å‡å°‘ tickï¼›
>
> âœ… `NO_HZ_FULL` æ˜¯ä¸ºäº†ç”¨æˆ·æ€ä¹Ÿèƒ½åœ tickï¼Œæ›´å½»åº•ã€‚

---

### âœ… äºŒã€å®é™…è¿è¡ŒçŠ¶æ€

```bash
.tick_stopped : 1  â† ä»£è¡¨è¯¥ CPU åœæ­¢ tickï¼ˆticklessï¼‰
```

è¿™è¡¨æ˜å¤§å¤šæ•° CPU å·²ç»**å®é™…å¤„äº tickless çŠ¶æ€**ã€‚

è€Œ `.tick_stopped : 0` çš„å‡ ä¸ª CPU å¯èƒ½å½“å‰æ­£åœ¨å†…æ ¸æ€ï¼Œæˆ–è€…è¿è¡Œç€å†…æ ¸çº¿ç¨‹ï¼ˆå¦‚ ksoftirqdã€rcuã€kworkerï¼‰ï¼Œéœ€è¦ä¿ç•™è°ƒåº¦ tickã€‚

---

### âœ… ä¸‰ã€CPU idle é»˜è®¤è¡Œä¸ºï¼ˆNO\_HZ\_FULL ä¸‹ï¼‰

> âœ… **åœ¨ NO\_HZ\_FULL æ¨¡å¼ä¸‹ï¼Œéå†…æ ¸æ€ã€idle CPU ä¼šè‡ªåŠ¨åœæ‰è°ƒåº¦ tick**ï¼Œåªä¿ç•™å¿…è¦çš„å®šæ—¶å™¨ï¼ˆå¦‚ hrtimerã€RCUã€watchdogï¼‰ã€‚

é™¤éï¼š

1. æ­£åœ¨è¿è¡Œå†…æ ¸çº¿ç¨‹
2. å‘ç”Ÿé¢‘ç¹ä¸­æ–­
3. æœ‰ `isolcpus` æ²¡è®¾ç½®å¯¼è‡´ä¸å…è®¸ full tickless

---

### âœ… å››ã€æ€»ç»“

| æ¡ç›®                       | å½“å‰é…ç½®æ˜¯å¦æ»¡è¶³                   |
| ------------------------ | -------------------------- |
| `CONFIG_NO_HZ_FULL`      | âœ… å¯ç”¨                       |
| `sched_tick` æ˜¯å¦é»˜è®¤å…³é—­      | âœ… åœ¨ idle CPU å’Œç”¨æˆ·æ€ CPU é»˜è®¤å…³é—­ |
| `.tick_stopped=1` å¤šæ•° CPU | âœ… æ˜¯                        |
| idle æ˜¯å¦é»˜è®¤è¿›å…¥ tickless     | âœ… æ˜¯ï¼ˆåªä¿ç•™ hrtimer/RCUï¼‰       |

---

å¦‚éœ€è¿›ä¸€æ­¥éªŒè¯ï¼Œå¯ä»¥è¿è¡Œï¼š

```bash
cat /proc/timer_list | grep -A10 'cpu: 0'
```

è§‚å¯Ÿæ˜¯å¦åªæœ‰æå°‘æ•°å®šæ—¶å™¨ï¼ˆå¦‚ `tick_sched_timer` å’Œ `rcu`ï¼‰åœ¨æ´»åŠ¨ï¼Œè¯´æ˜ CPU æ­£åœ¨è¿è¡Œäº tickless çŠ¶æ€ã€‚

---

## å½“å‰çš„ç³»ç»Ÿåœ¨è°ƒåº¦å™¨é€‰ä¸­idleæ—¶ï¼Œä¹Ÿä¼šè¿›å…¥tickless?

**å½“å‰ç³»ç»Ÿåœ¨è°ƒåº¦å™¨é€‰ä¸­ idle ä»»åŠ¡æ—¶ï¼Œä¼šè‡ªåŠ¨è¿›å…¥ tickless æ¨¡å¼**ï¼ˆä¹Ÿç§°ä¸º *idle tickless*ï¼‰ã€‚

---

### ğŸ” ä¾æ®å¦‚ä¸‹

#### âœ… å½“å‰çš„å†…æ ¸é…ç½®ï¼ˆæ¥è‡ª `/boot/config-$(uname -r)`ï¼‰

```bash
CONFIG_NO_HZ_COMMON=y
# CONFIG_NO_HZ_IDLE is not set
CONFIG_NO_HZ_FULL=y
CONFIG_NO_HZ=y
```

è¿™è¯´æ˜ï¼š

* ç³»ç»Ÿå¯ç”¨äº† `NO_HZ_FULL` æ¨¡å¼ï¼›
* `NO_HZ_IDLE` è™½æœªå•ç‹¬å¯ç”¨ï¼Œä½† `NO_HZ_FULL` åŒ…å«äº†å¯¹ idle tickless çš„æ”¯æŒï¼›
* **åªè¦æŸä¸ª CPU æ²¡æœ‰è¢« `nohz_full=` å‚æ•°éš”ç¦»å‡ºå»ï¼Œå®ƒå°±é»˜è®¤å·¥ä½œåœ¨ idle tickless æ¨¡å¼**ã€‚

---

### ğŸ§  å†…æ ¸é€»è¾‘è¯´æ˜

å†…æ ¸ä¸­ tickless æ”¯æŒä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

| æ¨¡å¼               | å¯åŠ¨æ¡ä»¶                      | åº”ç”¨èŒƒå›´                 |
| ---------------- | ------------------------- | -------------------- |
| **NO\_HZ\_IDLE** | é»˜è®¤å¯¹æ‰€æœ‰ CPU å¯ç”¨              | CPU è¿›å…¥ idle æ—¶åœæ­¢ tick |
| **NO\_HZ\_FULL** | éœ€è¦é…ç½® `nohz_full=` å¹¶éš”ç¦» CPU | CPU åœ¨ç”¨æˆ·æ€æ—¶ä¹Ÿå¯åœ tick    |

ä½ çš„å†…æ ¸é…ç½®ä¸­å¯ç”¨äº† `NO_HZ_FULL`ï¼Œåˆ™è¯´æ˜ï¼š

* **æ²¡æœ‰è¢«éš”ç¦»çš„ CPU é»˜è®¤è¿è¡Œåœ¨ idle tickless æ¨¡å¼ï¼ˆä¸ `NO_HZ_IDLE` è¡Œä¸ºä¸€è‡´ï¼‰**ï¼›
* è¢«éš”ç¦»çš„ CPUï¼ˆé€šè¿‡å†…æ ¸å‘½ä»¤è¡Œ `nohz_full=` é…ç½®ï¼‰åˆ™æ”¯æŒç”¨æˆ·æ€åœ tickã€‚

---

### âœ… ä¸¾ä¸ªä¾‹å­

ä¹‹å‰è¿è¡Œçš„ï¼š

```bash
cat /proc/timer_list | grep 'tick_stopped'
```

è¾“å‡ºä¸­å¤§å¤šæ•° CPU æ˜¯ï¼š

```
.tick_stopped : 1
```

è¯´æ˜å½“å‰è¿™äº› CPU å·²ç»è¿›å…¥ tickless çŠ¶æ€ï¼Œè€Œè¿™åœ¨æ²¡æœ‰ `nohz_full=` å‚æ•°çš„æƒ…å†µä¸‹ï¼Œé€šå¸¸å°±æ˜¯å› ä¸ºè¿™äº› CPU å½“å‰ idleï¼Œè°ƒåº¦å™¨é€‰æ‹©äº† idle ä»»åŠ¡ã€‚

---

### âœ… ç»“è®º

> **æ˜¯çš„ï¼Œç³»ç»Ÿä¸­æœªè¢« `nohz_full` éš”ç¦»çš„ CPUï¼Œåªè¦è°ƒåº¦å™¨é€‰æ‹©äº† idle ä»»åŠ¡ï¼ˆå³è¿›å…¥ç©ºé—²ï¼‰ï¼Œå°±ä¼šè‡ªåŠ¨åœæ­¢è°ƒåº¦ç”¨ tickï¼Œè¿›å…¥ tickless æ¨¡å¼ã€‚**

è¿™æ­£æ˜¯ idle tickless çš„æ ‡å‡†è¡Œä¸ºã€‚

å¦‚éœ€è¿›ä¸€æ­¥åˆ†æå“ªäº› CPU è¢« nohz\_full éš”ç¦»ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š

```bash
cat /sys/devices/system/cpu/nohz_full
```

æˆ–è€…ç¡®è®¤å†…æ ¸å¯åŠ¨å‚æ•°æ˜¯å¦åŒ…å«ï¼š

```bash
nohz_full=1-15  # ä¸¾ä¾‹
```

## åªä¿ç•™å¿…è¦çš„å®šæ—¶å™¨ï¼ˆå¦‚ hrtimerã€RCUã€watchdogï¼‰ï¼Œè¿™ä¸‰ç§ä¿ç•™çš„å®šæ—¶å™¨è®²ä¸€ä¸‹ï¼Ÿ

åœ¨ `NO_HZ_FULL` æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿå°½é‡åœæ‰å‘¨æœŸæ€§è°ƒåº¦ tickï¼Œä½†ä»**å¿…é¡»ä¿ç•™å°‘é‡å…³é”®å®šæ—¶å™¨**ï¼Œä»¥ä¿éšœå†…æ ¸åŸºæœ¬åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚ä½ æåˆ°çš„ `hrtimer`ã€`RCU`ã€`watchdog` æ˜¯å…¸å‹çš„ä¸‰ç§**ä¸èƒ½çœç•¥**çš„å®šæ—¶å™¨ï¼Œä¸‹é¢åˆ†åˆ«è®²æ¸…æ¥šå®ƒä»¬çš„ä½œç”¨å’Œè¿è¡Œæœºåˆ¶ï¼š

---

### â‘  **hrtimerï¼ˆé«˜ç²¾åº¦å®šæ—¶å™¨ï¼‰**

#### ğŸ”¹ ä½œç”¨

* ç”¨äºæ›¿ä»£æ—§çš„ `timer_list`ï¼Œæä¾›çº³ç§’çº§å®šæ—¶ç²¾åº¦ã€‚
* æ”¯æ’‘å‘¨æœŸæ€§ä»»åŠ¡ï¼ˆå¦‚ `sched_tick`ï¼‰ã€å•æ¬¡å®šæ—¶å™¨ã€å»¶è¿Ÿå”¤é†’ç­‰åŠŸèƒ½ã€‚
* æ˜¯ tickless æ¨¡å¼ä¸­**æœ€æ ¸å¿ƒçš„å®šæ—¶å™¨æ¡†æ¶**ï¼Œç”¨äºè°ƒåº¦ç²¾åº¦æ›´é«˜çš„äº‹ä»¶ã€‚

#### ğŸ”¹ ç‰¹ç‚¹

* æ¯ä¸ª CPU æœ‰ç‹¬ç«‹çš„ `hrtimer_cpu_base`ã€‚
* ä½¿ç”¨çº¢é»‘æ ‘ç®¡ç†å®šæ—¶å™¨ï¼ŒæŒ‰æ—¶é—´æ’åºï¼Œä¼˜å…ˆè§¦å‘æœ€è¿‘çš„å®šæ—¶å™¨ã€‚
* ç¡¬ä»¶å±‚é€šè¿‡ `clockevent` è®¾ç½®å”¤é†’æ—¶é—´ã€‚

#### ğŸ”¹ ä¸¾ä¾‹

* ç¡çœ ä¸­çš„è¿›ç¨‹è®¾ç½®äº† `nanosleep()` æˆ– `clock_nanosleep()`ã€‚
* ç”¨æˆ·æ€è¿è¡Œæ—¶éœ€è¦å‘¨æœŸæ€§å”¤é†’ï¼Œå¦‚ perf samplingã€å‘¨æœŸ timerfdã€‚
* æ›¿ä»£ `sched_tick`ï¼Œç²¾ç¡®æ§åˆ¶é‡æ–°è°ƒåº¦æ—¶é—´ç‚¹ã€‚

---

### â‘¡ **RCUï¼ˆRead-Copy Updateï¼‰å®šæ—¶å™¨**

#### ğŸ”¹ ä½œç”¨

* ç¡®ä¿å¹¶å‘è¯»å†™æƒ…å†µä¸‹å†…æ ¸æ•°æ®ç»“æ„çš„ä¸€è‡´æ€§ã€‚
* åœ¨å†™æ“ä½œæ—¶ï¼ŒRCU éœ€è¦ç­‰å¾…æ‰€æœ‰ CPU ç»è¿‡ä¸€ä¸ª *â€œRCU grace periodâ€*ï¼Œå³æ‰€æœ‰æ—§ç‰ˆæœ¬è¯»æ“ä½œå®Œæˆä¹‹åï¼Œæ‰èƒ½é‡Šæ”¾æ—§æ•°æ®ã€‚

#### ğŸ”¹ tickless ä¸‹çš„éš¾ç‚¹

* å¦‚æœä¸€ä¸ª CPU ä¸€ç›´åœ¨ç”¨æˆ·æ€ã€æ— ä¸­æ–­ã€æ— è°ƒåº¦ï¼ŒRCU å°±**æ— æ³•ç¡®è®¤å®ƒæ˜¯å¦å·²ç»å®Œæˆäº†è¯»æ“ä½œ**ã€‚
* æ‰€ä»¥ï¼Œå³ä½¿åœ¨ `NO_HZ_FULL` æ¨¡å¼ä¸‹ï¼ŒRCU ä¹Ÿå¿…é¡»è®¾ç½®**å‘¨æœŸæ€§å®šæ—¶å™¨**ï¼Œé€‚æ—¶æ£€æŸ¥ CPU æ˜¯å¦â€œQuiescentâ€ï¼ˆå®‰é™æ€ï¼‰ã€‚

#### ğŸ”¹ æŠ€æœ¯æ‰‹æ®µ

* ä½¿ç”¨ **RCU callback timer** å’Œ `rcu_sched_clock_irq()` æ¥ä¸»åŠ¨è§¦å‘æ£€æŸ¥ã€‚
* æˆ–è€…åœ¨ kernel exit to user æ¨¡å¼ä¸‹è°ƒç”¨ `rcu_user_exit()` è®© RCU çŸ¥é“å¯ä»¥æ¨è¿› grace periodã€‚

---

### â‘¢ **watchdogï¼ˆçœ‹é—¨ç‹—å®šæ—¶å™¨ï¼‰**

#### ğŸ”¹ ä½œç”¨

* æ£€æµ‹ CPU æ˜¯å¦å¡æ­»æˆ–é•¿æ—¶é—´æ— å“åº”ã€‚
* å¸¸ç”¨äºè½¯é”æ­»ï¼ˆsoft lockupï¼‰ã€ç¡¬é”æ­»ï¼ˆhard lockupï¼‰ç­‰ bug çš„è‡ªåŠ¨è§¦å‘æ£€æµ‹ã€‚

#### ğŸ”¹ ç‰¹ç‚¹

* å®šæ—¶å™¨å‘¨æœŸæ€§è§¦å‘ watchdog æ£€æŸ¥å‡½æ•°ï¼ˆå¦‚ `watchdog_timer_fn()`ï¼‰ã€‚
* æ£€æŸ¥å½“å‰ CPU çš„è°ƒåº¦å™¨å¿ƒè·³ã€è½¯ä¸­æ–­ç­‰æ´»åŠ¨è¿¹è±¡ã€‚
* å¦‚æœå‘ç°æŸä¸ª CPU é•¿æ—¶é—´æ²¡æœ‰å“åº”ï¼ˆå¦‚ N ç§’æ— è°ƒåº¦ï¼‰ï¼Œå°±è§¦å‘ BUG/WARNINGã€‚

#### ğŸ”¹ åœ¨ NO\_HZ\_FULL æ¨¡å¼ä¸­

* æŸäº› watchdog åŠŸèƒ½ä¼šä¸»åŠ¨åœ¨ç”¨æˆ·æ€æš‚åœï¼›
* ä½† CPU ä¸€æ—¦è¿›å…¥å†…æ ¸æ€æˆ–ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œwatchdog ä¼šç»§ç»­è¿ä½œï¼›
* å¯ä»¥é€šè¿‡ `watchdog_thresh` é…ç½®è¶…æ—¶æ—¶é—´ã€‚

---

### âœ… æ€»ç»“è¡¨

| å®šæ—¶å™¨      | ç”¨é€”                          | æ˜¯å¦æ¯ CPU ä¿ç•™ | æ˜¯å¦ä¾èµ– hrtimer | ä¸ tickless çš„å…³ç³»                   |
| -------- | --------------------------- | ---------- | ------------ | -------------------------------- |
| hrtimer  | çº³ç§’çº§é€šç”¨å®šæ—¶å™¨ï¼Œæ”¯æ’‘æ‰€æœ‰å»¶æ—¶/å‘¨æœŸäº‹ä»¶        | æ˜¯          | æœ¬èº«å°±æ˜¯         | Tickless çš„æ ¸å¿ƒï¼Œæ›¿ä»£ tick             |
| RCU      | ç®¡ç†å†…æ ¸å¹¶å‘æ•°æ®ä¸€è‡´æ€§ï¼Œæ¨è¿› grace period | æ˜¯          | æ˜¯            | ä¸ºæ¨è¿› RCU çŠ¶æ€ï¼Œtickless ä¸­å¿…é¡»ä¿ç•™        |
| watchdog | é˜²æ­¢è½¯/ç¡¬æ­»é”ï¼Œä¿éšœå†…æ ¸å¯é æ€§             | æ˜¯          | æ˜¯            | Tickless ä¸­ watchdog ä¼šé€‚åº¦æ”¾å®½ä½†ä¿ç•™ç›‘æ§èƒ½åŠ› |

---

## ticklessä¸‹çš„rcuä¼šæ³¨å†Œè‡ªå·±çš„htimerå®šæ—¶å™¨ï¼Œè¿™æ—¶å€™æ€ä¹ˆä¸èµ·ä½œç”¨äº†ï¼Ÿ

å¾ˆå¥½çš„é—®é¢˜ï¼æ—¢ç„¶ **tickless æ¨¡å¼ä¸‹ RCU ä¼šæ³¨å†Œè‡ªå·±çš„ hrtimer å®šæ—¶å™¨**ï¼Œç†è®ºä¸Šå®ƒåº”è¯¥å¯ä»¥ç‹¬ç«‹é©±åŠ¨ RCU ä»»åŠ¡çš„è§¦å‘ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç° RCU stall å’Œ `rcu_sched` è¢«é¥¿æ­»çš„æƒ…å†µå‘¢ï¼Ÿ

---

### æ ¸å¿ƒç‚¹ï¼šRCU çš„ hrtimer ä¸ºä»€ä¹ˆä¸èµ·ä½œç”¨ï¼Ÿ

#### 1. **hrtimer ä¾èµ–åº•å±‚æ—¶é’Ÿäº‹ä»¶é©±åŠ¨ï¼Œä½† tickless æ¨¡å¼ä¸‹æœ‰å¯èƒ½ ClockEvent è®¾å¤‡è¿›å…¥åœé¡¿çŠ¶æ€**

* åœ¨ tickless idle æ¨¡å¼ï¼Œå†…æ ¸ä¼šå°è¯•å…³é—­å‘¨æœŸæ€§ tickï¼Œåº•å±‚ ClockEvent ç¡¬ä»¶å¯èƒ½ä¹Ÿè¿›å…¥â€œåœæ­¢â€æˆ–â€œå•æ¬¡è§¦å‘â€æ¨¡å¼ã€‚
* å¦‚æœç¡¬ä»¶å®šæ—¶å™¨ï¼ˆClockEvent deviceï¼‰æ²¡æœ‰æ­£å¸¸è®¾ç½®ä¸‹ä¸€æ¬¡è¶…æ—¶ï¼ˆä¾‹å¦‚ï¼Œæ—¶é’Ÿäº‹ä»¶åœæ­¢æˆ–è®¾ç½®å¤±è´¥ï¼‰ï¼Œhrtimer çš„è¶…æ—¶å›è°ƒå°±ä¸ä¼šè¢«ç¡¬ä»¶è§¦å‘ï¼Œè½¯ä¸­æ–­ä¸ä¼šè¢«æ¿€æ´»ï¼Œå¯¼è‡´ RCU å®šæ—¶ä»»åŠ¡æ— æ³•è¢«æ‰§è¡Œã€‚

#### 2. **hrtimer çš„è§¦å‘ä¾èµ–äº CPU ä¸æ˜¯å¤„äºæ·±åº¦ç¡çœ ä¸”ç¡¬ä»¶å®šæ—¶å™¨æ­£å¸¸å·¥ä½œ**

* CPU å¦‚æœå¤„äºè¾ƒæ·±çš„ idle çŠ¶æ€ï¼ˆå¦‚ C3ã€C6 ç­‰ï¼‰ï¼Œç¡¬ä»¶å®šæ—¶å™¨å¯èƒ½è¢«å±è”½æˆ–è€…ä¸ç²¾å‡†ï¼Œå¯¼è‡´ hrtimer è§¦å‘å»¶è¿Ÿæˆ–ä¸¢å¤±ã€‚
* å› ä¸º tickless idle è®© CPU å°½å¯èƒ½çœç”µï¼Œéƒ¨åˆ†æ·±åº¦ç¡çœ æ¨¡å¼å¯¹å®šæ—¶å™¨æœ‰å½±å“ã€‚

#### 3. **å†…æ ¸ä¸­ RCU hrtimer å®šæ—¶å™¨ç®¡ç†å¯èƒ½è¢«é•¿æ—¶é—´å»¶è¿Ÿ**

* RCU çš„ hrtimer è§¦å‘åä¼šäº§ç”Ÿè½¯ä¸­æ–­ï¼Œé©±åŠ¨ RCU ä»»åŠ¡æ‰§è¡Œã€‚
* è½¯ä¸­æ–­å¤„ç†ä¾èµ–å†…æ ¸çš„è°ƒåº¦æœºåˆ¶ï¼Œå¦‚æœè½¯ä¸­æ–­å¤„ç†è¢«é•¿æ—¶é—´é˜»å¡ï¼ˆå¦‚é«˜ä¸­æ–­ä¸Šä¸‹æ–‡ã€é”ç«äº‰ï¼‰ï¼Œä»»åŠ¡ä¾ç„¶å¾—ä¸åˆ°æ‰§è¡Œã€‚

#### 4. **ç«äº‰ä¸ä¼˜å…ˆçº§**

* å…¶ä»–æ›´é«˜ä¼˜å…ˆçº§çš„ç¡¬ä»¶ä¸­æ–­æˆ–è½¯ä¸­æ–­æŠ¢å ï¼Œå¯¼è‡´ RCU hrtimer è½¯ä¸­æ–­å»¶è¿Ÿã€‚
* RCU hrtimer è¶…æ—¶åç”Ÿæˆè½¯ä¸­æ–­ï¼Œä½†è½¯ä¸­æ–­è°ƒåº¦ä¼˜å…ˆçº§ä¸å¤Ÿé«˜ï¼Œé•¿æ—¶é—´ç§¯å‹ã€‚

---

### ç³»ç»Ÿä¸­çš„å¯èƒ½å…·ä½“è¡¨ç°

* CPU è¿›å…¥ tickless idleï¼Œç¡¬ä»¶ ClockEvent åœæ­¢å‘¨æœŸæ€§ tick ä»¥çœç”µã€‚
* RCU æ³¨å†Œçš„ hrtimer ä¾èµ–è¯¥ ClockEvent æ¥è®¾ç½®è¶…æ—¶è§¦å‘ï¼Œä½† ClockEvent è¢«åœç”¨æˆ–è§¦å‘å»¶è¿Ÿã€‚
* å› æ­¤ï¼Œå°½ç®¡ RCU å®šæ—¶å™¨å­˜åœ¨ï¼Œåº•å±‚ç¡¬ä»¶æˆ–è½¯ä¸­æ–­æœºåˆ¶æ²¡æœ‰åŠæ—¶è§¦å‘å¯¹åº”å›è°ƒã€‚
* å¯¼è‡´ RCU ä»»åŠ¡æœªè¢«è°ƒåº¦ï¼Œæœ€ç»ˆè¢«åˆ¤å®šä¸º `rcu_sched` stall å’Œ hard lockupã€‚

---

### ç»“è®º

**RCU çš„ hrtimer èµ·ä½œç”¨çš„å‰ææ˜¯åº•å±‚æ—¶é’Ÿäº‹ä»¶å’Œè½¯ä¸­æ–­æœºåˆ¶æ­£å¸¸å·¥ä½œã€‚tickless idle æ¨¡å¼ä¸‹ï¼Œå¦‚æœ ClockEvent è®¾å¤‡åœæ­¢æˆ–è½¯ä¸­æ–­å¤„ç†è¢«é˜»å¡ï¼Œhrtimer å°±â€œçœ‹èµ·æ¥â€ä¸èµ·ä½œç”¨äº†ã€‚**

### More

```c
1450 /*
1451  * This code is invoked when a CPU goes idle, at which point we want
1452  * to have the CPU do everything required for RCU so that it can enter
1453  * the energy-efficient dyntick-idle mode.  This is handled by a
1454  * state machine implemented by rcu_prepare_for_idle() below.
1455  *
1456  * The following three proprocessor symbols control this state machine:
1457  *
1458  * RCU_IDLE_GP_DELAY gives the number of jiffies that a CPU is permitted
1459  *  to sleep in dyntick-idle mode with RCU callbacks pending.  This
1460  *  is sized to be roughly one RCU grace period.  Those energy-efficiency
1461  *  benchmarkers who might otherwise be tempted to set this to a large
1462  *  number, be warned: Setting RCU_IDLE_GP_DELAY too high can hang your
1463  *  system.  And if you are -that- concerned about energy efficiency,
1464  *  just power the system down and be done with it!
1465  * RCU_IDLE_LAZY_GP_DELAY gives the number of jiffies that a CPU is
1466  *  permitted to sleep in dyntick-idle mode with only lazy RCU
1467  *  callbacks pending.  Setting this too high can OOM your system.
1468  *
1469  * The values below work well in practice.  If future workloads require
1470  * adjustment, they can be converted into kernel config parameters, though
1471  * making the state machine smarter might be a better option.
1472  */
1473 #define RCU_IDLE_GP_DELAY 4     /* Roughly one grace period. */
1474 #define RCU_IDLE_LAZY_GP_DELAY (6 * HZ) /* Roughly six seconds. */
1475
1476 static int rcu_idle_gp_delay = RCU_IDLE_GP_DELAY;
1477 module_param(rcu_idle_gp_delay, int, 0644);
1478 static int rcu_idle_lazy_gp_delay = RCU_IDLE_LAZY_GP_DELAY;
1479 module_param(rcu_idle_lazy_gp_delay, int, 0644);
```

![rcu_needs_cpu](https://cdn.jsdelivr.net/gh/realwujing/picture-bed/rcu_needs_cpu.png)
