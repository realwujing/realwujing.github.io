

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="HTML, JavaScript, Hexo, Linux, qemu, C++, namespace, git, bcc, bpf, initramfs, k8s, architect, strings, assembly, linux">
  
    <meta name="description" content="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0  Linux 虚拟网络设备 veth-pair 详解，看这一篇就够了  测试环境 1TlRZMmFEVTFRMGMxV1hrMk5YQmhkelZ3TmpJMWNEWkZOWEpYVE">
<meta property="og:type" content="article">
<meta property="og:title" content="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0">
<meta property="og:url" content="https://realwujing.github.io/linux/kernel/net/bugs/ovs-veth-peer/ovs%20veth%20peer%20Soft%20Lockup%20on%20netdev_pick_tx%20due%20to%20zero%20real_num_tx_queues%20When%20Executing%20ip%20link%20del%20veth0/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0  Linux 虚拟网络设备 veth-pair 详解，看这一篇就够了  测试环境 1TlRZMmFEVTFRMGMxV1hrMk5YQmhkelZ3TmpJMWNEWkZOWEpYVE">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-28T21:53:17.000Z">
<meta property="article:modified_time" content="2025-03-28T21:53:17.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="qemu">
<meta property="article:tag" content="git">
<meta property="article:tag" content="bpf">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="HTML">
<meta property="article:tag" content="namespace">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0 - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-28 21:53" pubdate>
          2025年3月28日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          62k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          518 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0</h1>
            
            
              <div class="markdown-body">
                
                <h1
id="ovs-veth-peer-soft-lockup-on-netdev_pick_tx-due-to-zero-real_num_tx_queues-when-executing-ip-link-del-veth0">ovs
veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues
When Executing ip link del veth0</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bakari/p/10613710.html">Linux
虚拟网络设备 veth-pair 详解，看这一篇就够了</a></li>
</ul>
<h2 id="测试环境">测试环境</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">TlRZMmFEVTFRMGMxV1hrMk5YQmhkelZ3TmpJMWNEWkZOWEpYVERaTEsxWTFja3RtTmxsRFlVTm5iM2xOUkVsNU5XSnRNRXhsVjBaeVQyRmphV1ZUTm10VE0yOTBURmhzZERVMGREWk1VekUxWW1WbFRrTTBkMUZXYjNoTVpXRXhhU3RwZG14VFFYaE5RelI1VGtSWmRVMVVSVEpNYWtWTFEyMDVla3hYVW14alIzaDJaVkZ2UzAxVVFteE9hazVzVGpKVmVFMVJiMHRqTTFacllubEJkR04zYjB0TlZFRjFUbXBOZFUxcE5IaE5VVzlMVFZSQmRVNXFUWFZOYVRSNFRXZHZTMDFVUVhWT2FrMTFUV2swZUUxM2IwdGpNMDV2U1VoT2JGa3pWbmxhVlVGNFRVTTBNazE1TkhsTWFrVjRTVU14ZDBsRVJYZE5SRUYz<br></code></pre></td></tr></table></figure>
<h3 id="复现步骤">复现步骤</h3>
<p>在13设备上复现了一下，创建完网桥，网桥上的流量越大复现概率越高：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ovs-vsctl add-br os_manage1<br>ovs-vsctl add-port os_manage1 bond0.151<br>ip <span class="hljs-built_in">link</span> add name veth0 <span class="hljs-built_in">type</span> veth peer name veth1<br>ovs-vsctl add-port os_manage1 veth0<br>ip <span class="hljs-built_in">link</span> del veth0<br>ovs-vsctl del-port os_manage1 veth0<br></code></pre></td></tr></table></figure>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/openvswitch_dmesg.png" srcset="/img/loading.gif" lazyload
alt="openvswitch_dmesg" />
<figcaption aria-hidden="true">openvswitch_dmesg</figcaption>
</figure>
<h3
id="本地搭建虚拟机狗酱轻量级复现环境">本地搭建虚拟机狗酱轻量级复现环境</h3>
<p>参考复现脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start openvswitch<br>ovs-vsctl add-br os_manage<br>ip <span class="hljs-built_in">link</span> add name veth0 <span class="hljs-built_in">type</span> veth peer name veth1<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth0 up<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth1 up<br>ovs-vsctl del-port os_manage veth0<br>ovs-vsctl add-port os_manage veth0<br>ovs-vsctl show<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> os_manage up<br>ip addr add 192.168.10.1/24 dev veth0<br>ip addr add 192.168.10.2/24 dev veth1<br>ip addr show veth0<br>ip addr show veth1<br>ping 192.168.10.1 -I 192.168.10.2<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ip <span class="hljs-built_in">link</span> del veth0<br></code></pre></td></tr></table></figure>
<p>在本地搭建的虚拟机上无法复现此bug，但是可以用来调试获取关键路径堆栈。</p>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/vm_ip_link_del_veth0.png" srcset="/img/loading.gif" lazyload
alt="vm_ip_link_del_veth0" />
<figcaption aria-hidden="true">vm_ip_link_del_veth0</figcaption>
</figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd record -p function_graph -g veth_dellink ip <span class="hljs-built_in">link</span> del veth0<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd report &gt; vm_ip_link_del_veth0.log<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim vm_ip_link_del_veth0.log<br><br>CPU 0 is empty<br>CPU 1 is empty<br>CPU 2 is empty<br>CPU 3 is empty<br>CPU 4 is empty<br>CPU 5 is empty<br>CPU 7 is empty<br>cpus=8<br>              ip-2541  [006]  5230.491361: funcgraph_entry:                   |  <span class="hljs-function"><span class="hljs-title">veth_dellink</span></span>() &#123;<br>              ip-2541  [006]  5230.491883: funcgraph_entry:                   |    <span class="hljs-function"><span class="hljs-title">unregister_netdevice_queue</span></span>() &#123;<br>              ip-2541  [006]  5230.491914: funcgraph_entry:                   |      <span class="hljs-function"><span class="hljs-title">rtnl_is_locked</span></span>() &#123;<br>              ip-2541  [006]  5230.491916: funcgraph_entry:      + 56.464 us  |        mutex_is_locked();<br>              ip-2541  [006]  5230.492126: funcgraph_exit:       ! 212.400 us |      &#125;<br>              ip-2541  [006]  5230.492173: funcgraph_exit:       ! 291.680 us |    &#125;<br>              ip-2541  [006]  5230.492182: funcgraph_entry:                   |    <span class="hljs-function"><span class="hljs-title">unregister_netdevice_queue</span></span>() &#123;<br>              ip-2541  [006]  5230.492184: funcgraph_entry:                   |      <span class="hljs-function"><span class="hljs-title">rtnl_is_locked</span></span>() &#123;<br>              ip-2541  [006]  5230.492185: funcgraph_entry:        1.456 us   |        mutex_is_locked();<br>              ip-2541  [006]  5230.492188: funcgraph_exit:         4.496 us   |      &#125;<br>              ip-2541  [006]  5230.492190: funcgraph_exit:         7.936 us   |    &#125;<br>              ip-2541  [006]  5230.492200: funcgraph_exit:       <span class="hljs-comment"># 1227.888 us |  &#125;</span><br><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd list -f | grep rtnl_dellink<br>rtnl_dellinkprop<br>rtnl_dellink<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd record -p function_graph -g rtnl_dellink ip <span class="hljs-built_in">link</span> del veth0<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd report &gt; vm_ip_link_del_veth0_rtnl_dellink.log<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd record -p function_graph ping 192.168.10.1 -I 192.168.10.2<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd report &gt; vm_ping.log<br></code></pre></td></tr></table></figure>
<h2 id="根因定位">根因定位</h2>
<p>配置 Linux 内核在检测到任务挂起（hung task）或软锁死（soft
lockup）时触发系统崩溃（panic）:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sysctl -w kernel.hung_task_panic=1<br>sysctl -w kernel.softlockup_panic=1<br></code></pre></td></tr></table></figure>
<h3 id="vmcore-dmesg.txt">vmcore-dmesg.txt</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs bash">[ 4393.873711] watchdog: BUG: soft lockup - CPU<span class="hljs-comment">#21 stuck for 12s! [swapper/21:0]</span><br>[ 4393.882198] Modules linked <span class="hljs-keyword">in</span>: nft_nat nft_masq nft_counter nft_chain_nat vhost_net vhost vhost_iotlb tap xt_TPROXY nf_tproxy_ipv6 nf_tproxy_ipv4 cls_bpf vxlan ip6_udp_tunnel udp_tunnel veth xt_nat xt_socket nf_socket_ipv4 nf_socket_ipv6 ip6table_raw iptable_raw xt_CT nbd rbd ceph libceph dns_resolver ip6t_REJECT nf_reject_ipv6 xt_mark xt_set ip_set_hash_ipportnet ip_set_hash_ipportip ip_set_hash_ipport ip_set_hash_ip ip_set_bitmap_port ip_vs_rr ip_set ip_vs nf_tables dummy xt_comment binfmt_misc nf_conntrack_netlink nfnetlink xt_addrtype xt_CHECKSUM xt_MASQUERADE xt_conntrack ipt_REJECT nf_reject_ipv4 ip6table_mangle ip6table_nat iptable_mangle iptable_nat ebtable_filter ebtables ip6table_filter ip6_tables iptable_filter ip_tables tun sch_ingress bonding rfkill 8021q garp mrp openvswitch nsh nf_conncount nf_nat rpcrdma rdma_ucm ib_srpt ib_isert iscsi_target_mod sunrpc target_core_mod ib_iser rdma_cm iw_cm ib_cm libiscsi scsi_transport_iscsi hns_roce_hw_v2 ib_uverbs ib_core<br>[ 4393.882270]  ipmi_ssif realtek ses hibmc_drm enclosure hclge hisi_sas_v3_hw drm_vram_helper vfat fat acpi_ipmi ipmi_si hns3 hisi_sas_main drm_ttm_helper hnae3 libsas hinic nvme ipmi_devintf i2c_designware_platform ttm scsi_transport_sas host_edma_drv sg nvme_core ipmi_msghandler i2c_designware_core hisi_uncore_hha_pmu hisi_uncore_ddrc_pmu hisi_uncore_l3c_pmu hisi_uncore_pmu ext4 mbcache jbd2 sch_fq_codel overlay br_netfilter bridge stp llc nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 fuse xfs libcrc32c dm_multipath sd_mod t10_pi ghash_ce sha2_ce ahci sha256_arm64 libahci sha1_ce sbsa_gwdt libata megaraid_sas nfit libnvdimm dm_mirror dm_region_hash dm_log dm_mod aes_ce_blk crypto_simd cryptd aes_ce_cipher<br>[ 4394.041268] CPU: 21 PID: 0 Comm: swapper/21 Kdump: loaded Not tainted 5.10.0-136.12.0.88.ctl3.aarch64 <span class="hljs-comment">#1</span><br>[ 4394.052208] Hardware name: Huawei TaiShan 2280 V2/BC82AMDDA, BIOS 1.70 01/07/2021<br>[ 4394.061192] pstate: 60400009 (nZCv daif +PAN -UAO -TCO BTYPE=--)<br>[ 4394.068702] pc : netdev_pick_tx+0x27c/0x294<br>[ 4394.074385] lr : netdev_pick_tx+0xe8/0x294<br>[ 4394.079977] sp : ffff800012ab3540<br>[ 4394.084788] x29: ffff800012ab3540 x28: ffff800012ab3b90<br>[ 4394.091580] x27: ffff0021428bca00 x26: 0000000000000000<br>[ 4394.098377] x25: 0000000000000000 x24: 00000000ffffffff<br>[ 4394.105161] x23: 0000000000000000 x22: ffff20222543e000<br>[ 4394.111937] x21: ffff0021428bca00 x20: 0000000000000000<br>[ 4394.118713] x19: ffff20222543e000 x18: 0000000000000000<br>[ 4394.125479] x17: 0000000000000000 x16: 0000000000000000<br>[ 4394.132243] x15: 0000000000000001 x14: 0000000000004788<br>[ 4394.138998] x13: 000000000000a888 x12: 000000000000ca88<br>[ 4394.145741] x11: ffff800012ab3720 x10: 0000000000000188<br>[ 4394.152482] x9 : ffff800010adc558 x8 : ffff0020b064da10<br>[ 4394.159232] x7 : 0000000000000000 x6 : 00000069c6f1b488<br>[ 4394.165972] x5 : 0000000000000000 x4 : 0000000000000000<br>[ 4394.172693] x3 : 0000000000000000 x2 : 0000000000000000<br>[ 4394.179414] x1 : ffff0021428bca00 x0 : 0000000000000000<br>[ 4394.186133] Call trace:<br>[ 4394.189985]  netdev_pick_tx+0x27c/0x294<br>[ 4394.195220]  netdev_core_pick_tx+0xdc/0x10c<br>[ 4394.200796]  __dev_queue_xmit+0x104/0xac0<br>[ 4394.206192]  dev_queue_xmit+0x1c/0x30<br>[ 4394.211251]  ovs_vport_send+0xac/0x180 [openvswitch]<br>[ 4394.217599]  do_output+0x60/0x160 [openvswitch]<br>[ 4394.223509]  do_execute_actions+0x868/0x880 [openvswitch]<br>[ 4394.230277]  ovs_execute_actions+0x64/0xe0 [openvswitch]<br>[ 4394.236959]  ovs_dp_process_packet+0x9c/0x1e4 [openvswitch]<br>[ 4394.243899]  ovs_vport_receive+0x7c/0xec [openvswitch]<br>[ 4394.250412]  netdev_port_receive+0xbc/0x17c [openvswitch]<br>[ 4394.257183]  netdev_frame_hook+0x2c/0x44 [openvswitch]<br>[ 4394.263673]  __netif_receive_skb_core+0x294/0xdd4<br>[ 4394.269708]  __netif_receive_skb_list_core+0xa4/0x290<br>[ 4394.276067]  __netif_receive_skb_list+0x120/0x1a0<br>[ 4394.282053]  netif_receive_skb_list_internal+0xe4/0x1f0<br>[ 4394.288538]  napi_complete_done+0x70/0x1f0<br>[ 4394.293897]  hns3_nic_common_poll+0x104/0x220 [hns3]<br>[ 4394.300093]  napi_poll+0xcc/0x264<br>[ 4394.304618]  net_rx_action+0xd4/0x21c<br>[ 4394.309463]  __do_softirq+0x130/0x358<br>[ 4394.314284]  irq_exit+0x11c/0x13c<br>[ 4394.318740]  __handle_domain_irq+0x88/0xf0<br>[ 4394.323954]  gic_handle_irq+0x78/0x2c0<br>[ 4394.328804]  el1_irq+0xb8/0x140<br>[ 4394.333029]  arch_cpu_idle+0x18/0x40<br>[ 4394.337667]  default_idle_call+0x5c/0x1c0<br>[ 4394.342723]  cpuidle_idle_call+0x174/0x1b0<br>[ 4394.347853]  do_idle+0xc8/0x160<br>[ 4394.352025]  cpu_startup_entry+0x30/0xfc<br>[ 4394.356986]  secondary_start_kernel+0x158/0x1ec<br>[ 4394.362556] Kernel panic - not syncing: softlockup: hung tasks<br>[ 4394.369422] CPU: 21 PID: 0 Comm: swapper/21 Kdump: loaded Tainted: G             L    5.10.0-136.12.0.88.ctl3.aarch64 <span class="hljs-comment">#1</span><br>[ 4394.381711] Hardware name: Huawei TaiShan 2280 V2/BC82AMDDA, BIOS 1.70 01/07/2021<br>[ 4394.390268] Call trace:<br>[ 4394.393809]  dump_backtrace+0x0/0x1e4<br>[ 4394.398565]  show_stack+0x20/0x2c<br>[ 4394.402976]  dump_stack+0xd8/0x140<br>[ 4394.407475]  panic+0x168/0x390<br>[ 4394.411630]  watchdog_timer_fn+0x230/0x290<br>[ 4394.416825]  __run_hrtimer+0x98/0x2a0<br>[ 4394.421586]  __hrtimer_run_queues+0xb0/0x134<br>[ 4394.426953]  hrtimer_interrupt+0x13c/0x3c0<br>[ 4394.432151]  arch_timer_handler_phys+0x3c/0x50<br>[ 4394.437700]  handle_percpu_devid_irq+0x90/0x1f4<br>[ 4394.443336]  __handle_domain_irq+0x84/0xf0<br>[ 4394.448538]  gic_handle_irq+0x78/0x2c0<br>[ 4394.453397]  el1_irq+0xb8/0x140<br>[ 4394.457661]  netdev_pick_tx+0x27c/0x294<br>[ 4394.462625]  netdev_core_pick_tx+0xdc/0x10c<br>[ 4394.467920]  __dev_queue_xmit+0x104/0xac0<br>[ 4394.473034]  dev_queue_xmit+0x1c/0x30<br>[ 4394.477810]  ovs_vport_send+0xac/0x180 [openvswitch]<br>[ 4394.483885]  do_output+0x60/0x160 [openvswitch]<br>[ 4394.489517]  do_execute_actions+0x868/0x880 [openvswitch]<br>[ 4394.496018]  ovs_execute_actions+0x64/0xe0 [openvswitch]<br>[ 4394.502428]  ovs_dp_process_packet+0x9c/0x1e4 [openvswitch]<br>[ 4394.509102]  ovs_vport_receive+0x7c/0xec [openvswitch]<br>[ 4394.515344]  netdev_port_receive+0xbc/0x17c [openvswitch]<br>[ 4394.521845]  netdev_frame_hook+0x2c/0x44 [openvswitch]<br>[ 4394.528091]  __netif_receive_skb_core+0x294/0xdd4<br>[ 4394.533904]  __netif_receive_skb_list_core+0xa4/0x290<br>[ 4394.540061]  __netif_receive_skb_list+0x120/0x1a0<br>[ 4394.545867]  netif_receive_skb_list_internal+0xe4/0x1f0<br>[ 4394.552192]  napi_complete_done+0x70/0x1f0<br>[ 4394.557407]  hns3_nic_common_poll+0x104/0x220 [hns3]<br>[ 4394.563478]  napi_poll+0xcc/0x264<br>[ 4394.567904]  net_rx_action+0xd4/0x21c<br>[ 4394.572679]  __do_softirq+0x130/0x358<br>[ 4394.577453]  irq_exit+0x11c/0x13c<br>[ 4394.581875]  __handle_domain_irq+0x88/0xf0<br>[ 4394.587084]  gic_handle_irq+0x78/0x2c0<br>[ 4394.591944]  el1_irq+0xb8/0x140<br>[ 4394.596199]  arch_cpu_idle+0x18/0x40<br>[ 4394.600884]  default_idle_call+0x5c/0x1c0<br>[ 4394.606007]  cpuidle_idle_call+0x174/0x1b0<br>[ 4394.611213]  do_idle+0xc8/0x160<br>[ 4394.615465]  cpu_startup_entry+0x30/0xfc<br>[ 4394.620490]  secondary_start_kernel+0x158/0x1ec<br>[ 4394.626146] SMP: stopping secondary CPUs<br>[ 4394.632839] Starting crashdump kernel...<br>[ 4394.637846] Bye!<br></code></pre></td></tr></table></figure>
<h3 id="crash">crash</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvm-10e63e2e11 127.0.0.1-2025-02-27-18:19:00]<span class="hljs-comment"># ip a | grep -i 10.63.2.11</span><br>    inet 10.63.2.11/21 brd 10.63.7.255 scope global noprefixroute os_manage<br>[root@kvm-10e63e2e11 127.0.0.1-2025-02-27-18:19:00]<span class="hljs-comment">#</span><br>[root@kvm-10e63e2e11 127.0.0.1-2025-02-27-18:19:00]<span class="hljs-comment"># pwd</span><br>/var/crash/127.0.0.1-2025-02-27-18:19:00<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash /lib/debug/lib/modules/5.10.0-136.12.0.88.ctl3.aarch64/vmlinux vmcore<br></code></pre></td></tr></table></figure>
<h4 id="sys">sys</h4>
<p>sys查看panic原因： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; sys<br>      KERNEL: /lib/debug/lib/modules/5.10.0-136.12.0.88.ctl3.aarch64/vmlinux  [TAINTED]<br>    DUMPFILE: vmcore  [PARTIAL DUMP]<br>        CPUS: 96<br>        DATE: Thu Feb 27 18:17:42 CST 2025<br>      UPTIME: 01:13:14<br>LOAD AVERAGE: 24.54, 10.38, 8.03<br>       TASKS: 10764<br>    NODENAME: kvm-10e63e2e11<br>     RELEASE: 5.10.0-136.12.0.88.ctl3.aarch64<br>     VERSION: <span class="hljs-comment">#1 SMP Fri Jul 28 07:11:01 UTC 2023</span><br>     MACHINE: aarch64  (unknown Mhz)<br>      MEMORY: 192 GB<br>       PANIC: <span class="hljs-string">&quot;Kernel panic - not syncing: softlockup: hung tasks&quot;</span><br></code></pre></td></tr></table></figure></p>
<h4 id="bt">bt</h4>
<h5 id="bt-1">bt</h5>
<p>bt 查看堆栈回溯： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt<br>PID: 0        TASK: ffff00208d452680  CPU: 21   COMMAND: <span class="hljs-string">&quot;swapper/21&quot;</span><br> <span class="hljs-comment">#0 [ffff800012ab2f60] __crash_kexec at ffff8000101aafa0</span><br> <span class="hljs-comment">#1 [ffff800012ab30f0] panic at ffff800010cd72bc</span><br> <span class="hljs-comment">#2 [ffff800012ab31d0] watchdog_timer_fn at ffff8000101f25ac</span><br> <span class="hljs-comment">#3 [ffff800012ab3220] __run_hrtimer at ffff80001017d314</span><br> <span class="hljs-comment">#4 [ffff800012ab3270] __hrtimer_run_queues at ffff80001017d5cc</span><br> <span class="hljs-comment">#5 [ffff800012ab32d0] hrtimer_interrupt at ffff80001017dc18</span><br> <span class="hljs-comment">#6 [ffff800012ab3340] arch_timer_handler_phys at ffff800010a5ec88</span><br> <span class="hljs-comment">#7 [ffff800012ab3350] handle_percpu_devid_irq at ffff80001015011c</span><br> <span class="hljs-comment">#8 [ffff800012ab3380] __handle_domain_irq at ffff800010146fb0</span><br> <span class="hljs-comment">#9 [ffff800012ab33c0] gic_handle_irq at ffff800010010124</span><br><span class="hljs-comment">#10 [ffff800012ab3520] el1_irq at ffff800010012374</span><br><span class="hljs-comment">#11 [ffff800012ab3540] netdev_pick_tx at ffff800010adc6e8</span><br><span class="hljs-comment">#12 [ffff800012ab3590] netdev_core_pick_tx at ffff800010ae675c</span><br><span class="hljs-comment">#13 [ffff800012ab35c0] __dev_queue_xmit at ffff800010ae6890</span><br><span class="hljs-comment">#14 [ffff800012ab3630] dev_queue_xmit at ffff800010ae7268</span><br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send at ffff8000098f95b8 [openvswitch]</span><br><span class="hljs-comment">#16 [ffff800012ab3670] do_output at ffff8000098e47fc [openvswitch]</span><br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions at ffff8000098e66b4 [openvswitch]</span><br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions at ffff8000098e6b00 [openvswitch]</span><br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet at ffff8000098eaba8 [openvswitch]</span><br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive at ffff8000098f949c [openvswitch]</span><br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive at ffff8000098fa03c [openvswitch]</span><br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook at ffff8000098fa128 [openvswitch]</span><br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core at ffff800010ae77f0</span><br><span class="hljs-comment">#24 [ffff800012ab3bd0] __netif_receive_skb_list_core at ffff800010ae88d0</span><br><span class="hljs-comment">#25 [ffff800012ab3c60] __netif_receive_skb_list at ffff800010ae8bdc</span><br><span class="hljs-comment">#26 [ffff800012ab3cc0] netif_receive_skb_list_internal at ffff800010ae8d40</span><br><span class="hljs-comment">#27 [ffff800012ab3d40] napi_complete_done at ffff800010ae9aec</span><br><span class="hljs-comment">#28 [ffff800012ab3d70] hns3_nic_common_poll at ffff800009be7350 [hns3]</span><br><span class="hljs-comment">#29 [ffff800012ab3e10] napi_poll at ffff800010ae9d38</span><br><span class="hljs-comment">#30 [ffff800012ab3e50] net_rx_action at ffff800010ae9fa4</span><br><span class="hljs-comment">#31 [ffff800012ab3ed0] __do_softirq at ffff80001001075c</span><br><span class="hljs-comment">#32 [ffff800012ab3f70] irq_exit at ffff8000100b06cc</span><br><span class="hljs-comment">#33 [ffff800012ab3f90] __handle_domain_irq at ffff800010146fb4</span><br><span class="hljs-comment">#34 [ffff800012ab3fd0] gic_handle_irq at ffff800010010124</span><br>--- &lt;IRQ stack&gt; ---<br><span class="hljs-comment">#35 [ffff800013093f00] el1_irq at ffff800010012374</span><br><span class="hljs-comment">#36 [ffff800013093f20] arch_cpu_idle at ffff800010cedb84</span><br><span class="hljs-comment">#37 [ffff800013093f30] default_idle_call at ffff800010cf9c58</span><br><span class="hljs-comment">#38 [ffff800013093f50] cpuidle_idle_call at ffff8000100f7850</span><br><span class="hljs-comment">#39 [ffff800013093f90] do_idle at ffff8000100f7954</span><br><span class="hljs-comment">#40 [ffff800013093fc0] cpu_startup_entry at ffff8000100f7bc0</span><br><span class="hljs-comment">#41 [ffff800013093fe0] secondary_start_kernel at ffff80001002a498</span><br></code></pre></td></tr></table></figure></p>
<h5 id="bt--sx">bt -sx</h5>
<p>bt -sx:</p>
<ul>
<li><strong><code>bt</code></strong>：在 <code>crash</code>
工具中，显示当前任务的调用栈（函数调用顺序）。</li>
<li><strong><code>-s</code></strong>：把地址变成函数名，方便看。</li>
<li><strong><code>-x</code></strong>：用十六进制显示地址。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -sx<br>PID: 0        TASK: ffff00208d452680  CPU: 21   COMMAND: <span class="hljs-string">&quot;swapper/21&quot;</span><br> <span class="hljs-comment">#0 [ffff800012ab2f60] __crash_kexec+0x110 at ffff8000101aafa0</span><br> <span class="hljs-comment">#1 [ffff800012ab30f0] panic+0x17c at ffff800010cd72bc</span><br> <span class="hljs-comment">#2 [ffff800012ab31d0] watchdog_timer_fn+0x22c at ffff8000101f25ac</span><br> <span class="hljs-comment">#3 [ffff800012ab3220] __run_hrtimer+0x94 at ffff80001017d314</span><br> <span class="hljs-comment">#4 [ffff800012ab3270] __hrtimer_run_queues+0xac at ffff80001017d5cc</span><br> <span class="hljs-comment">#5 [ffff800012ab32d0] hrtimer_interrupt+0x138 at ffff80001017dc18</span><br> <span class="hljs-comment">#6 [ffff800012ab3340] arch_timer_handler_phys+0x38 at ffff800010a5ec88</span><br> <span class="hljs-comment">#7 [ffff800012ab3350] handle_percpu_devid_irq+0x8c at ffff80001015011c</span><br> <span class="hljs-comment">#8 [ffff800012ab3380] __handle_domain_irq+0x80 at ffff800010146fb0</span><br> <span class="hljs-comment">#9 [ffff800012ab33c0] gic_handle_irq+0x74 at ffff800010010124</span><br><span class="hljs-comment">#10 [ffff800012ab3520] el1_irq+0xb4 at ffff800010012374</span><br><span class="hljs-comment">#11 [ffff800012ab3540] netdev_pick_tx+0x278 at ffff800010adc6e8</span><br><span class="hljs-comment">#12 [ffff800012ab3590] netdev_core_pick_tx+0xd8 at ffff800010ae675c</span><br><span class="hljs-comment">#13 [ffff800012ab35c0] __dev_queue_xmit+0x100 at ffff800010ae6890</span><br><span class="hljs-comment">#14 [ffff800012ab3630] dev_queue_xmit+0x18 at ffff800010ae7268</span><br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send+0xa8 at ffff8000098f95b8 [openvswitch]</span><br><span class="hljs-comment">#16 [ffff800012ab3670] do_output+0x5c at ffff8000098e47fc [openvswitch]</span><br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions+0x864 at ffff8000098e66b4 [openvswitch]</span><br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions+0x60 at ffff8000098e6b00 [openvswitch]</span><br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet+0x98 at ffff8000098eaba8 [openvswitch]</span><br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive+0x78 at ffff8000098f949c [openvswitch]</span><br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive+0xb8 at ffff8000098fa03c [openvswitch]</span><br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook+0x28 at ffff8000098fa128 [openvswitch]</span><br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core+0x290 at ffff800010ae77f0</span><br><span class="hljs-comment">#24 [ffff800012ab3bd0] __netif_receive_skb_list_core+0xa0 at ffff800010ae88d0</span><br><span class="hljs-comment">#25 [ffff800012ab3c60] __netif_receive_skb_list+0x11c at ffff800010ae8bdc</span><br><span class="hljs-comment">#26 [ffff800012ab3cc0] netif_receive_skb_list_internal+0xe0 at ffff800010ae8d40</span><br><span class="hljs-comment">#27 [ffff800012ab3d40] napi_complete_done+0x6c at ffff800010ae9aec</span><br><span class="hljs-comment">#28 [ffff800012ab3d70] hns3_nic_common_poll+0x100 at ffff800009be7350 [hns3]</span><br><span class="hljs-comment">#29 [ffff800012ab3e10] napi_poll+0xc8 at ffff800010ae9d38</span><br><span class="hljs-comment">#30 [ffff800012ab3e50] net_rx_action+0xd0 at ffff800010ae9fa4</span><br><span class="hljs-comment">#31 [ffff800012ab3ed0] __do_softirq+0x12c at ffff80001001075c</span><br><span class="hljs-comment">#32 [ffff800012ab3f70] irq_exit+0x118 at ffff8000100b06cc</span><br><span class="hljs-comment">#33 [ffff800012ab3f90] __handle_domain_irq+0x84 at ffff800010146fb4</span><br><span class="hljs-comment">#34 [ffff800012ab3fd0] gic_handle_irq+0x74 at ffff800010010124</span><br>--- &lt;IRQ stack&gt; ---<br><span class="hljs-comment">#35 [ffff800013093f00] el1_irq+0xb4 at ffff800010012374</span><br><span class="hljs-comment">#36 [ffff800013093f20] arch_cpu_idle+0x14 at ffff800010cedb84</span><br><span class="hljs-comment">#37 [ffff800013093f30] default_idle_call+0x58 at ffff800010cf9c58</span><br><span class="hljs-comment">#38 [ffff800013093f50] cpuidle_idle_call+0x170 at ffff8000100f7850</span><br><span class="hljs-comment">#39 [ffff800013093f90] do_idle+0xc4 at ffff8000100f7954</span><br><span class="hljs-comment">#40 [ffff800013093fc0] cpu_startup_entry+0x2c at ffff8000100f7bc0</span><br><span class="hljs-comment">#41 [ffff800013093fe0] secondary_start_kernel+0x154 at ffff80001002a498</span><br></code></pre></td></tr></table></figure>
<h5 id="bt--slx">bt -slx</h5>
<p>bt -slx: - <strong><code>bt</code></strong>：在 <code>crash</code>
工具中，显示调用栈（函数调用顺序）。 -
<strong><code>-s</code></strong>：显示函数名（符号化）。 -
<strong><code>-l</code></strong>：显示源代码文件名和行号（如果有调试信息）。
- <strong><code>-x</code></strong>：用十六进制显示地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -slx<br>PID: 0        TASK: ffff00208d452680  CPU: 21   COMMAND: <span class="hljs-string">&quot;swapper/21&quot;</span><br> <span class="hljs-comment">#0 [ffff800012ab2f60] __crash_kexec+0x110 at ffff8000101aafa0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/kexec.h: 52<br> <span class="hljs-comment">#1 [ffff800012ab30f0] panic+0x17c at ffff800010cd72bc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/panic.c: 251<br> <span class="hljs-comment">#2 [ffff800012ab31d0] watchdog_timer_fn+0x22c at ffff8000101f25ac</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/watchdog.c: 448<br> <span class="hljs-comment">#3 [ffff800012ab3220] __run_hrtimer+0x94 at ffff80001017d314</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/time/hrtimer.c: 1583<br> <span class="hljs-comment">#4 [ffff800012ab3270] __hrtimer_run_queues+0xac at ffff80001017d5cc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/time/hrtimer.c: 1647<br> <span class="hljs-comment">#5 [ffff800012ab32d0] hrtimer_interrupt+0x138 at ffff80001017dc18</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/time/hrtimer.c: 1709<br> <span class="hljs-comment">#6 [ffff800012ab3340] arch_timer_handler_phys+0x38 at ffff800010a5ec88</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/drivers/clocksource/arm_arch_timer.c: 647<br> <span class="hljs-comment">#7 [ffff800012ab3350] handle_percpu_devid_irq+0x8c at ffff80001015011c</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/irq/chip.c: 933<br> <span class="hljs-comment">#8 [ffff800012ab3380] __handle_domain_irq+0x80 at ffff800010146fb0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/irqdesc.h: 153<br> <span class="hljs-comment">#9 [ffff800012ab33c0] gic_handle_irq+0x74 at ffff800010010124</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/irqdesc.h: 171<br><span class="hljs-comment">#10 [ffff800012ab3520] el1_irq+0xb4 at ffff800010012374</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/arch/arm64/kernel/entry.S: 672<br><span class="hljs-comment">#11 [ffff800012ab3540] netdev_pick_tx+0x278 at ffff800010adc6e8</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/jump_label.h: 21<br><span class="hljs-comment">#12 [ffff800012ab3590] netdev_core_pick_tx+0xd8 at ffff800010ae675c</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4057<br><span class="hljs-comment">#13 [ffff800012ab35c0] __dev_queue_xmit+0x100 at ffff800010ae6890</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4132<br><span class="hljs-comment">#14 [ffff800012ab3630] dev_queue_xmit+0x18 at ffff800010ae7268</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4205<br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send+0xa8 at ffff8000098f95b8 [openvswitch]</span><br><span class="hljs-comment">#16 [ffff800012ab3670] do_output+0x5c at ffff8000098e47fc [openvswitch]</span><br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions+0x864 at ffff8000098e66b4 [openvswitch]</span><br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions+0x60 at ffff8000098e6b00 [openvswitch]</span><br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet+0x98 at ffff8000098eaba8 [openvswitch]</span><br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive+0x78 at ffff8000098f949c [openvswitch]</span><br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive+0xb8 at ffff8000098fa03c [openvswitch]</span><br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook+0x28 at ffff8000098fa128 [openvswitch]</span><br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core+0x290 at ffff800010ae77f0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5260<br><span class="hljs-comment">#24 [ffff800012ab3bd0] __netif_receive_skb_list_core+0xa0 at ffff800010ae88d0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5442<br><span class="hljs-comment">#25 [ffff800012ab3c60] __netif_receive_skb_list+0x11c at ffff800010ae8bdc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5509<br><span class="hljs-comment">#26 [ffff800012ab3cc0] netif_receive_skb_list_internal+0xe0 at ffff800010ae8d40</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5619<br><span class="hljs-comment">#27 [ffff800012ab3d40] napi_complete_done+0x6c at ffff800010ae9aec</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5773<br><span class="hljs-comment">#28 [ffff800012ab3d70] hns3_nic_common_poll+0x100 at ffff800009be7350 [hns3]</span><br><span class="hljs-comment">#29 [ffff800012ab3e10] napi_poll+0xc8 at ffff800010ae9d38</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 6837<br><span class="hljs-comment">#30 [ffff800012ab3e50] net_rx_action+0xd0 at ffff800010ae9fa4</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 6907<br><span class="hljs-comment">#31 [ffff800012ab3ed0] __do_softirq+0x12c at ffff80001001075c</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/softirq.c: 298<br><span class="hljs-comment">#32 [ffff800012ab3f70] irq_exit+0x118 at ffff8000100b06cc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/interrupt.h: 550<br><span class="hljs-comment">#33 [ffff800012ab3f90] __handle_domain_irq+0x84 at ffff800010146fb4</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/irq/irqdesc.c: 692<br><span class="hljs-comment">#34 [ffff800012ab3fd0] gic_handle_irq+0x74 at ffff800010010124</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/irqdesc.h: 171<br>--- &lt;IRQ stack&gt; ---<br><span class="hljs-comment">#35 [ffff800013093f00] el1_irq+0xb4 at ffff800010012374</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/arch/arm64/kernel/entry.S: 672<br><span class="hljs-comment">#36 [ffff800013093f20] arch_cpu_idle+0x14 at ffff800010cedb84</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/irqflags.h: 37<br><span class="hljs-comment">#37 [ffff800013093f30] default_idle_call+0x58 at ffff800010cf9c58</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 112<br><span class="hljs-comment">#38 [ffff800013093f50] cpuidle_idle_call+0x170 at ffff8000100f7850</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 194<br><span class="hljs-comment">#39 [ffff800013093f90] do_idle+0xc4 at ffff8000100f7954</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 300<br><span class="hljs-comment">#40 [ffff800013093fc0] cpu_startup_entry+0x2c at ffff8000100f7bc0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 396<br><span class="hljs-comment">#41 [ffff800013093fe0] secondary_start_kernel+0x154 at ffff80001002a498</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/arch/arm64/kernel/smp.c: 281<br></code></pre></td></tr></table></figure>
<h4 id="dis">dis</h4>
<p>本次debug运气十分不错，vmcore-dmesg.txt中的<code>pc : netdev_pick_tx+0x27c/0x294</code>居然与反汇编vmcore中netdev_pick_tx+0x27c能对上，最近遇到过多次对不上的情况，抽空分析。</p>
<h5 id="dis--flx">dis -flx</h5>
<p>vmcore-dmesg.txt中pc :
netdev_pick_tx+0x27c/0x294，在crash中dis反汇编查看相关源码、汇编：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -flx netdev_pick_tx | grep 0x27c -C5<br>0xffff800010adc6e0 &lt;netdev_pick_tx+0x270&gt;:      csel    x19, x2, x0, ne  // ne = any<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/jump_label.h: 21<br>0xffff800010adc6e4 &lt;netdev_pick_tx+0x274&gt;:      b       0xffff800010adc544 &lt;netdev_pick_tx+0xd4&gt;<br>0xffff800010adc6e8 &lt;netdev_pick_tx+0x278&gt;:      b       0xffff800010adc4cc &lt;netdev_pick_tx+0x5c&gt;<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 3190<br>0xffff800010adc6ec &lt;netdev_pick_tx+0x27c&gt;:      sub     w2, w2, w25     <span class="hljs-comment"># // 减法操作：w2 = w2 - w25，结果存储在w2中</span><br>0xffff800010adc6f0 &lt;netdev_pick_tx+0x280&gt;:      b       0xffff800010adc598 &lt;netdev_pick_tx+0x128&gt;<br>0xffff800010adc6f4 &lt;netdev_pick_tx+0x284&gt;:      stp     x25, x26, [sp, <span class="hljs-comment">#64]</span><br>0xffff800010adc6f8 &lt;netdev_pick_tx+0x288&gt;:      b       0xffff800010adc4d0 &lt;netdev_pick_tx+0x60&gt;<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 3188<br>0xffff800010adc6fc &lt;netdev_pick_tx+0x28c&gt;:      sub     w2, w2, w20<br></code></pre></td></tr></table></figure>
<p><code>dis -flx netdev_pick_tx | grep 0x27c -C5</code>
的含义和作用：</p>
<ol type="1">
<li><p><strong><code>dis -flx netdev_pick_tx</code></strong>:</p>
<ul>
<li><code>dis</code> 是 <code>crash</code>
工具中的一个命令，用于反汇编（disassemble）指定的函数或地址，展示底层的机器指令。</li>
<li><code>-f</code>：显示函数的完整反汇编内容（而不是只显示部分）。</li>
<li><code>-l</code>：在反汇编中包含源代码行号和对应的文件名（如果调试信息可用）。</li>
<li><code>-x</code>：以十六进制格式显示地址和指令。</li>
<li><code>netdev_pick_tx</code>：这是要反汇编的目标函数名，在这里是一个Linux内核函数，位于网络子系统中（<code>net/core/dev.c</code>），通常用于选择网络设备的传输队列。</li>
</ul>
<p><strong>作用</strong>：这条命令会输出 <code>netdev_pick_tx</code>
函数的汇编代码，带有地址、指令、源文件名和行号信息。</p></li>
<li><p><strong><code>|</code></strong>:</p>
<ul>
<li>管道符，将 <code>dis</code> 命令的输出传递给后面的 <code>grep</code>
命令进行过滤。</li>
</ul></li>
<li><p><strong><code>grep 0x27c -C5</code></strong>:</p>
<ul>
<li><code>grep</code>：Linux中的文本过滤工具，用于搜索匹配指定模式的行。</li>
<li><code>0x27c</code>：这里是要搜索的模式，即查找包含
<code>0x27c</code> 的行。<code>0x27c</code> 是
<code>netdev_pick_tx</code>
函数中的一个偏移量（offset），表示从函数起始地址开始的某个位置。</li>
<li><code>-C5</code>：上下文选项，表示在匹配行前后各显示5行（Context，5
lines before and after）。</li>
</ul>
<p><strong>作用</strong>：从 <code>dis</code> 的输出中，找到包含
<code>0x27c</code>
的那一行，并显示它周围的5行代码，以便查看上下文。</p></li>
</ol>
<p>vmcore-dmesg.txt中提取到x2、x20寄存器： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">x2 : 0000000000000000<br>x25: 0000000000000000<br></code></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim net/core/dev.c +3190</span><br><br> <span class="hljs-number">3164</span> <span class="hljs-type">static</span> u16 <span class="hljs-title function_">skb_tx_hash</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *dev,</span><br><span class="hljs-params"> <span class="hljs-number">3165</span>                <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *sb_dev,</span><br><span class="hljs-params"> <span class="hljs-number">3166</span>                <span class="hljs-keyword">struct</span> sk_buff *skb)</span><br> 3167 &#123;<br> <span class="hljs-number">3168</span>     u32 hash;<br> <span class="hljs-number">3169</span>     u16 qoffset = <span class="hljs-number">0</span>;<br> <span class="hljs-number">3170</span>     u16 qcount = dev-&gt;real_num_tx_queues;<br> <span class="hljs-number">3171</span><br> <span class="hljs-number">3172</span>     <span class="hljs-keyword">if</span> (dev-&gt;num_tc) &#123;<br> <span class="hljs-number">3173</span>         u8 tc = netdev_get_prio_tc_map(dev, skb-&gt;priority);<br> <span class="hljs-number">3174</span><br> <span class="hljs-number">3175</span>         qoffset = sb_dev-&gt;tc_to_txq[tc].offset;<br> <span class="hljs-number">3176</span>         qcount = sb_dev-&gt;tc_to_txq[tc].count;<br> <span class="hljs-number">3177</span>         <span class="hljs-keyword">if</span> (unlikely(!qcount)) &#123;<br> <span class="hljs-number">3178</span>             net_warn_ratelimited(<span class="hljs-string">&quot;%s: invalid qcount, qoffset %u for tc %u\n&quot;</span>,<br> <span class="hljs-number">3179</span>                          sb_dev-&gt;name, qoffset, tc);<br> <span class="hljs-number">3180</span>             qoffset = <span class="hljs-number">0</span>;<br> <span class="hljs-number">3181</span>             qcount = dev-&gt;real_num_tx_queues;<br> <span class="hljs-number">3182</span>         &#125;<br> <span class="hljs-number">3183</span>     &#125;<br> <span class="hljs-number">3184</span><br> <span class="hljs-number">3185</span>     <span class="hljs-keyword">if</span> (skb_rx_queue_recorded(skb)) &#123;<br> <span class="hljs-number">3186</span>         hash = skb_get_rx_queue(skb);<br> <span class="hljs-number">3187</span>         <span class="hljs-keyword">if</span> (hash &gt;= qoffset)<br> <span class="hljs-number">3188</span>             hash -= qoffset;<br> <span class="hljs-number">3189</span>         <span class="hljs-keyword">while</span> (unlikely(hash &gt;= qcount))<br> <span class="hljs-number">3190</span>             hash -= qcount;<br> <span class="hljs-number">3191</span>         <span class="hljs-keyword">return</span> hash + qoffset;<br> <span class="hljs-number">3192</span>     &#125;<br> <span class="hljs-number">3193</span><br> <span class="hljs-number">3194</span>     <span class="hljs-keyword">return</span> (u16) reciprocal_scale(skb_get_hash(skb), qcount) + qoffset;<br> <span class="hljs-number">3195</span> &#125;<br></code></pre></td></tr></table></figure>
<p>从反汇编结果来看, 3910行的hash = 0、qcount =
0，3189行这里的while会陷入死循环。内核态代码默认不会抢占，即使被中断打断了也会返回原处继续执行，这里的确会触发soft
lockup。</p>
<p>进一步使用dis -flx netdev_pick_tx查看netdev_pick_tx函数入参：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -flx netdev_pick_tx | <span class="hljs-built_in">head</span> -n20<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4833<br>0xffff800010adc470 &lt;netdev_pick_tx&gt;:    mov     x9, x30<br>0xffff800010adc474 &lt;netdev_pick_tx+0x4&gt;:        nop<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4013<br>0xffff800010adc478 &lt;netdev_pick_tx+0x8&gt;:        paciasp<br>0xffff800010adc47c &lt;netdev_pick_tx+0xc&gt;:        stp     x29, x30, [sp, <span class="hljs-comment">#-80]!</span><br>0xffff800010adc480 &lt;netdev_pick_tx+0x10&gt;:       mov     x29, sp<br>0xffff800010adc484 &lt;netdev_pick_tx+0x14&gt;:       stp     x19, x20, [sp, <span class="hljs-comment">#16]</span><br>0xffff800010adc488 &lt;netdev_pick_tx+0x18&gt;:       mov     x19, x2<br>0xffff800010adc48c &lt;netdev_pick_tx+0x1c&gt;:       stp     x21, x22, [sp, <span class="hljs-comment">#32]</span><br>0xffff800010adc490 &lt;netdev_pick_tx+0x20&gt;:       mov     x21, x1<br>0xffff800010adc494 &lt;netdev_pick_tx+0x24&gt;:       mov     x22, x0<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4014<br>0xffff800010adc498 &lt;netdev_pick_tx+0x28&gt;:       stp     x23, x24, [sp, <span class="hljs-comment">#48]</span><br>0xffff800010adc49c &lt;netdev_pick_tx+0x2c&gt;:       ldr     x23, [x1, <span class="hljs-comment">#24]</span><br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/net/sock.h: 1845<br>0xffff800010adc4a0 &lt;netdev_pick_tx+0x30&gt;:       cbz     x23, 0xffff800010adc6d8 &lt;netdev_pick_tx+0x268&gt;<br>0xffff800010adc4a4 &lt;netdev_pick_tx+0x34&gt;:       ldrh    w0, [x23, <span class="hljs-comment">#120]</span><br>0xffff800010adc4a8 &lt;netdev_pick_tx+0x38&gt;:       mov     w1, <span class="hljs-comment">#0xffff                     // #65535</span><br>0xffff800010adc4ac &lt;netdev_pick_tx+0x3c&gt;:       cmp     w0, w1<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">0xffff800010adc494 &lt;netdev_pick_tx+0x24&gt;:       mov     x22, x0    // x0（第一个参数）保存到 x22<br>0xffff800010adc490 &lt;netdev_pick_tx+0x20&gt;:       mov     x21, x1    // x1（第二个参数）保存到 x21<br>0xffff800010adc488 &lt;netdev_pick_tx+0x18&gt;:       mov     x19, x2    // x2（第三个参数）保存到 x19<br></code></pre></td></tr></table></figure>
<ul>
<li>在ARM64架构中，<code>x0</code> 到 <code>x30</code>
是64位的通用寄存器，用于存储数据和地址。</li>
<li><code>mov</code> 指令用于将一个寄存器的值复制到另一个寄存器。</li>
<li>在函数调用中，<code>x0</code> 到 <code>x7</code>
通常用于传递函数参数，<code>x19</code> 到 <code>x28</code>
是临时寄存器，通常用于保存中间结果。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">x22: ffff20222543e000<br>x21: ffff0021428bca00<br>x19: ffff20222543e000<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim -t netdev_pick_tx</span><br><br> <span class="hljs-number">4011</span> u16 <span class="hljs-title function_">netdev_pick_tx</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev, <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params"> <span class="hljs-number">4012</span>              <span class="hljs-keyword">struct</span> net_device *sb_dev)</span><br> 4013 &#123;<br> <span class="hljs-number">4014</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span> =</span> skb-&gt;sk;<br> <span class="hljs-number">4015</span>     <span class="hljs-type">int</span> queue_index = sk_tx_queue_get(sk);<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct net_device ffff20222543e000 | <span class="hljs-built_in">head</span> -n10<br>struct net_device &#123;<br>  name = <span class="hljs-string">&quot;veth685086fa\000\000\000&quot;</span>,       <span class="hljs-comment"># 网络设备名称，这里是 &quot;veth685086fa&quot;（虚拟以太网设备）</span><br>  name_node = 0xffff2034b6d41500,          <span class="hljs-comment"># 指向名称节点的指针，可能用于设备管理链表</span><br>  ifalias = 0x0,                           <span class="hljs-comment"># 设备别名，这里为空（NULL）</span><br>  mem_end = 0,                             <span class="hljs-comment"># 内存映射结束地址，未使用为 0</span><br>  mem_start = 0,                           <span class="hljs-comment"># 内存映射起始地址，未使用为 0</span><br>  base_addr = 0,                           <span class="hljs-comment"># 设备基地址（I/O 地址），未使用为 0</span><br>  irq = 0,                                 <span class="hljs-comment"># 中断号，未分配为 0</span><br>  state = 14,                              <span class="hljs-comment"># 设备状态，14 是十进制，可能是位掩码（如 UP | LINK）</span><br>  dev_list = &#123;                             <span class="hljs-comment"># 设备链表的起始部分（未完全显示）</span><br></code></pre></td></tr></table></figure>
<ul>
<li><strong><code>struct net_device</code></strong>：在
<code>crash</code> 工具中，用于显示 <code>net_device</code>
结构体的内容。<code>net_device</code> 是 Linux
内核中表示网络设备的结构体。</li>
<li><strong><code>ffff20222543e000</code></strong>：这是内存地址，表示要查看的特定
<code>net_device</code> 实例的起始地址。</li>
<li><strong><code>| head -n10</code></strong>：将输出限制为前 10
行。</li>
</ul>
<p>简单含义: - 这是一个 <code>net_device</code>
结构体实例，描述了一个网络设备。 -
<strong><code>name</code></strong>：设备名叫
<code>veth685086fa</code>，表示这是一个虚拟以太网设备（veth，常用于容器网络）。
- <strong><code>state = 14</code></strong>：状态值为
14，可能表示设备已启用（UP）并处于某种状态（需查具体位定义）。 -
其他字段如 <code>mem_end</code>, <code>mem_start</code>,
<code>base_addr</code>, <code>irq</code> 都是
0，说明这个虚拟设备没有物理硬件资源。 -
<strong><code>dev_list</code></strong>：设备链表的一部分，可能链接到系统中其他网络设备。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct net_device ffff20222543e000 | grep tx_queues<br>  num_tx_queues = 1,        <span class="hljs-comment"># 传输队列的数量，设置为 1</span><br>  real_num_tx_queues = 0,   <span class="hljs-comment"># 实际使用的传输队列数量，为 0</span><br></code></pre></td></tr></table></figure>
<p>在内核源码中查找<code>real_num_tx_queues = 0</code>:
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"> grep <span class="hljs-string">&quot;real_num_tx_queues = 0&quot;</span> . -inr --include=*.c<br>./net/core/net-sysfs.c:1809:    dev-&gt;real_num_tx_queues = 0;<br></code></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim net/core/net-sysfs.c +1809</span><br><br><span class="hljs-number">1796</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">remove_queue_kobjects</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev)</span><br>1797 &#123;<br><span class="hljs-number">1798</span>     <span class="hljs-type">int</span> real_rx = <span class="hljs-number">0</span>, real_tx = <span class="hljs-number">0</span>;<br><span class="hljs-number">1799</span><br><span class="hljs-number">1800</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-number">1801</span>     real_rx = dev-&gt;real_num_rx_queues;<br><span class="hljs-number">1802</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">1803</span>     real_tx = dev-&gt;real_num_tx_queues;<br><span class="hljs-number">1804</span><br><span class="hljs-number">1805</span>     net_rx_queue_update_kobjects(dev, real_rx, <span class="hljs-number">0</span>);<br><span class="hljs-number">1806</span>     netdev_queue_update_kobjects(dev, real_tx, <span class="hljs-number">0</span>);<br><span class="hljs-number">1807</span><br><span class="hljs-number">1808</span>     dev-&gt;real_num_rx_queues = <span class="hljs-number">0</span>;<br><span class="hljs-number">1809</span>     dev-&gt;real_num_tx_queues = <span class="hljs-number">0</span>;<br><span class="hljs-number">1810</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-number">1811</span>     kset_unregister(dev-&gt;queues_kset);<br><span class="hljs-number">1812</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">1813</span> &#125;<br></code></pre></td></tr></table></figure>
<h3 id="自定义日志风格">自定义日志风格</h3>
<p>当前内核函数<code>WARN</code>每次都会调用dump_stack，不够灵活，日志输出太多容易触发hung
task，造成机器异常卡顿，不利于问题分析。</p>
<p>在include/linux/printk.h最后面添加自定义日志风格： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/include/linux/printk.h b/include/linux/printk.h<br>index <span class="hljs-number">7</span>d787f91db92.<span class="hljs-number">.0</span>dcb9eb4d03e <span class="hljs-number">100644</span><br>--- a/include/linux/printk.h<br>+++ b/include/linux/printk.h<br>@@ <span class="hljs-number">-672</span>,<span class="hljs-number">4</span> +<span class="hljs-number">672</span>,<span class="hljs-number">17</span> @@ <span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">print_hex_dump_debug</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *prefix_str, <span class="hljs-type">int</span> prefix_type,</span><br><span class="hljs-params"> #define print_hex_dump_bytes(prefix_str, prefix_type, buf, len)        \</span><br><span class="hljs-params">        print_hex_dump_debug(prefix_str, prefix_type, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, buf, len, <span class="hljs-literal">true</span>)</span><br><span class="hljs-params"></span><br><span class="hljs-params">+<span class="hljs-comment">// 自定义 MY_WARN 宏</span></span><br><span class="hljs-params">+#define MY_WARN(condition, dump_stack_flag, tag, fmt, ...)                     \</span><br><span class="hljs-params">+       <span class="hljs-keyword">do</span> &#123;                                                                   \</span><br><span class="hljs-params">+               <span class="hljs-keyword">if</span> (condition) &#123;                                               \</span><br><span class="hljs-params">+                       printk(KERN_WARNING                                    \</span><br><span class="hljs-params">+                              <span class="hljs-string">&quot;WARNING: [%s] [%s:%d %s] &quot;</span> fmt, \</span><br><span class="hljs-params">+                              tag, __FILE__, __LINE__, __func__,              \</span><br><span class="hljs-params">+                              ##__VA_ARGS__);                                 \</span><br><span class="hljs-params">+                       <span class="hljs-keyword">if</span> (dump_stack_flag)                                   \</span><br><span class="hljs-params">+                               dump_stack();                                  \</span><br><span class="hljs-params">+               &#125;                                                              \</span><br><span class="hljs-params">+       &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)</span><br><span class="hljs-params">+</span><br><span class="hljs-params"> #endif</span><br></code></pre></td></tr></table></figure></p>
<p>这是一个 Git 补丁（diff），在 Linux 内核头文件
<code>include/linux/printk.h</code> 中添加了一个自定义宏
<code>MY_WARN</code>。以下是最简单解释：</p>
<h4 id="改动位置">改动位置</h4>
<ul>
<li>文件：<code>include/linux/printk.h</code></li>
<li>位置：在文件末尾（第 672 行后）添加新代码。</li>
</ul>
<h4 id="新增内容">新增内容</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MY_WARN(condition, dump_stack_flag, tag, fmt, ...)                     \</span><br><span class="hljs-meta">    do &#123;                                                                   \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (condition) &#123;                                               \</span><br><span class="hljs-meta">            printk(KERN_WARNING                                        \</span><br><span class="hljs-meta">                   <span class="hljs-string">&quot;WARNING: [%s] [%s:%d %s] &quot;</span> fmt, \</span><br><span class="hljs-meta">                   tag, __FILE__, __LINE__, __func__,                  \</span><br><span class="hljs-meta">                   ##__VA_ARGS__);                                     \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (dump_stack_flag)                                       \</span><br><span class="hljs-meta">                dump_stack();                                          \</span><br><span class="hljs-meta">        &#125;                                                              \</span><br><span class="hljs-meta">    &#125; while (0)</span><br></code></pre></td></tr></table></figure>
<h4 id="简单解释">简单解释</h4>
<ul>
<li><strong><code>MY_WARN</code></strong>：一个新定义的宏，用于打印警告信息。</li>
<li><strong>参数</strong>：
<ul>
<li><code>condition</code>：条件，如果为真则触发警告。</li>
<li><code>dump_stack_flag</code>：是否打印调用栈（1 = 是，0 =
否）。</li>
<li><code>tag</code>：自定义标签，标记警告来源。</li>
<li><code>fmt, ...</code>：格式化字符串和参数，类似
<code>printf</code>。</li>
</ul></li>
<li><strong>功能</strong>：
<ol type="1">
<li>如果 <code>condition</code> 为真，用 <code>printk</code>
打印一条警告信息（级别 <code>KERN_WARNING</code>）。</li>
<li>警告内容包括：标签、文件名、行号、函数名，再加上自定义消息。</li>
<li>如果 <code>dump_stack_flag</code> 为真，调用
<code>dump_stack()</code> 打印调用栈。</li>
</ol></li>
<li><strong>用法示例</strong>： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">MY_WARN(x &gt; <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;x is %d&quot;</span>, x);<br></code></pre></td></tr></table></figure>
输出可能像：<code>WARNING: [test] [file.c:123 func] x is 5</code>，并附上调用栈。</li>
</ul>
<h5 id="用途">用途</h5>
<ul>
<li>在内核开发中，用于调试或记录异常情况，比直接用 <code>printk</code>
更方便，能自动包含上下文信息。</li>
</ul>
<h3 id="在skb_tx_hash中增加日志">在skb_tx_hash中增加日志</h3>
<p>下方<code>if (hash == 0 &amp;&amp; qcount == 0)</code>处代码尝试修复此次soft
lockup问题，编译出内核测试包后，实测有效。</p>
<p>之前物理机器在机房，无法过去，soft lockup
bmc串口也上不去机器，ssh也不通。采用简版修复方案后机器不再soft
lockup，后续调试工作就好展开了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/net/core/dev.c b/net/core/dev.c<br>index <span class="hljs-number">4</span>d3851278303..f5991595b2d1 <span class="hljs-number">100644</span><br>--- a/net/core/dev.c<br>+++ b/net/core/dev.c<br>@@ <span class="hljs-number">-3186</span>,<span class="hljs-number">8</span> +<span class="hljs-number">3213</span>,<span class="hljs-number">23</span> @@ <span class="hljs-type">static</span> u16 <span class="hljs-title function_">skb_tx_hash</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *dev,</span><br><span class="hljs-params"> 		hash = skb_get_rx_queue(skb);</span><br><span class="hljs-params"> 		<span class="hljs-keyword">if</span> (hash &gt;= qoffset)</span><br><span class="hljs-params"> 			hash -= qoffset;</span><br><span class="hljs-params">-		<span class="hljs-keyword">while</span> (unlikely(hash &gt;= qcount))</span><br><span class="hljs-params">+</span><br><span class="hljs-params">+		<span class="hljs-keyword">while</span> (unlikely(hash &gt;= qcount)) &#123;</span><br><span class="hljs-params">+			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;</span><br><span class="hljs-params">+				MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,</span><br><span class="hljs-params">+					<span class="hljs-string">&quot;dev-&gt;name:%s sb_dev-&gt;name:%s qconut:%hd hash:%u\n&quot;</span>,</span><br><span class="hljs-params">+					dev-&gt;name, sb_dev-&gt;name, qcount, hash);</span><br><span class="hljs-params">+			&#125;</span><br><span class="hljs-params">+</span><br><span class="hljs-params"> 			hash -= qcount;</span><br><span class="hljs-params">+</span><br><span class="hljs-params">+			<span class="hljs-keyword">if</span> (hash == <span class="hljs-number">0</span> &amp;&amp; qcount == <span class="hljs-number">0</span>) &#123;</span><br><span class="hljs-params">+				MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,</span><br><span class="hljs-params">+					<span class="hljs-string">&quot;dev-&gt;name:%s sb_dev-&gt;name:%s qconut:%hd hash:%u\n&quot;</span>,</span><br><span class="hljs-params">+					dev-&gt;name, sb_dev-&gt;name, qcount, hash);</span><br><span class="hljs-params">+				<span class="hljs-keyword">break</span>;</span><br><span class="hljs-params">+			&#125;</span><br><span class="hljs-params">+		&#125;</span><br><span class="hljs-params"> 		<span class="hljs-keyword">return</span> hash + qoffset;</span><br><span class="hljs-params"> 	&#125;</span><br><span class="hljs-params"></span><br></code></pre></td></tr></table></figure>
<h3
id="在remove_queue_kobjects中增加日志">在remove_queue_kobjects中增加日志</h3>
<p>当前机器已不再soft
lockup，此处增加dump_stack获取堆栈不是很有必要，完全可以用bpftrace代替。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/net/core/net-sysfs.c b/net/core/net-sysfs.c<br>index <span class="hljs-number">989b</span>3f7ee85f..d51d70f30fb1 <span class="hljs-number">100644</span><br>--- a/net/core/net-sysfs.c<br>+++ b/net/core/net-sysfs.c<br>@@ <span class="hljs-number">-1805</span>,<span class="hljs-number">6</span> +<span class="hljs-number">1805</span>,<span class="hljs-number">13</span> @@ <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">remove_queue_kobjects</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev)</span><br>        <span class="hljs-title function_">net_rx_queue_update_kobjects</span><span class="hljs-params">(dev, real_rx, <span class="hljs-number">0</span>)</span>;<br>        netdev_queue_update_kobjects(dev, real_tx, <span class="hljs-number">0</span>);<br><br>+       <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br>+               MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>, <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span><br>+                       <span class="hljs-string">&quot;dev-&gt;real_num_rx_queues: %d, dev-&gt;real_num_tx_queues:%d\n&quot;</span>,<br>+                       dev-&gt;name, dev-&gt;real_num_rx_queues,<br>+                       dev-&gt;real_num_tx_queues);<br>+       &#125;<br>+<br>        dev-&gt;real_num_rx_queues = <span class="hljs-number">0</span>;<br>        dev-&gt;real_num_tx_queues = <span class="hljs-number">0</span>;<br> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br></code></pre></td></tr></table></figure>
<p>在netdev_unregister_kobject中添加dump_stack，观察到相关堆栈：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1456</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: WARNING: [veth_peer_soft_lockup] [net/core/net-sysfs.c:<span class="hljs-number">1809</span> remove_queue_kobjects] dev veth interface name:veth1, dev-&gt;real_num_rx_queues: <span class="hljs-number">1</span>, dev-&gt;real_num_tx_queues:<span class="hljs-number">1</span><br><span class="hljs-number">1457</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: CPU: <span class="hljs-number">3</span> PID: <span class="hljs-number">4059</span> Comm: ip Not tainted <span class="hljs-number">5.10</span><span class="hljs-number">.0</span><span class="hljs-number">-136.12</span><span class="hljs-number">.0</span><span class="hljs-number">.88</span><span class="hljs-number">.067</span>a2cf1de16.ctl3.aarch64 #<span class="hljs-number">1</span><br><span class="hljs-number">1458</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: Hardware name: QEMU QEMU Virtual Machine, BIOS <span class="hljs-number">2024.02</span><span class="hljs-number">-2u</span>buntu0<span class="hljs-number">.1</span> <span class="hljs-number">10</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2024</span><br><span class="hljs-number">1459</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: Call trace:<br><span class="hljs-number">1460</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x1e4</span><br><span class="hljs-number">1461</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  show_stack+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x2c</span><br><span class="hljs-number">1462</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  dump_stack+<span class="hljs-number">0xd8</span>/<span class="hljs-number">0x140</span><br><span class="hljs-number">1463</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netdev_unregister_kobject+<span class="hljs-number">0xf4</span>/<span class="hljs-number">0x100</span><br><span class="hljs-number">1464</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  unregister_netdevice_many+<span class="hljs-number">0x2c8</span>/<span class="hljs-number">0x4c0</span><br><span class="hljs-number">1465</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  rtnl_dellink+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x34c</span><br><span class="hljs-number">1466</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  rtnetlink_rcv_msg+<span class="hljs-number">0x124</span>/<span class="hljs-number">0x360</span><br><span class="hljs-number">1467</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_rcv_skb+<span class="hljs-number">0x64</span>/<span class="hljs-number">0x130</span><br><span class="hljs-number">1468</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  rtnetlink_rcv+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x30</span><br><span class="hljs-number">1469</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_unicast_kernel+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x120</span><br><span class="hljs-number">1470</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_unicast+<span class="hljs-number">0x110</span>/<span class="hljs-number">0x194</span><br><span class="hljs-number">1471</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_sendmsg+<span class="hljs-number">0x37c</span>/<span class="hljs-number">0x420</span><br><span class="hljs-number">1472</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  sock_sendmsg+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x70</span><br><span class="hljs-number">1473</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  ____sys_sendmsg+<span class="hljs-number">0x274</span>/<span class="hljs-number">0x2b0</span><br><span class="hljs-number">1474</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  ___sys_sendmsg+<span class="hljs-number">0x84</span>/<span class="hljs-number">0xd0</span><br><span class="hljs-number">1475</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  __sys_sendmsg+<span class="hljs-number">0x70</span>/<span class="hljs-number">0xd0</span><br><span class="hljs-number">1476</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  __arm64_sys_sendmsg+<span class="hljs-number">0x2c</span>/<span class="hljs-number">0x40</span><br><span class="hljs-number">1477</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  invoke_syscall+<span class="hljs-number">0x50</span>/<span class="hljs-number">0x11c</span><br><span class="hljs-number">1478</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_svc_common.constprop<span class="hljs-number">.0</span>+<span class="hljs-number">0x158</span>/<span class="hljs-number">0x164</span><br><span class="hljs-number">1479</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  do_el0_svc+<span class="hljs-number">0x2c</span>/<span class="hljs-number">0x9c</span><br><span class="hljs-number">1480</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_svc+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x30</span><br><span class="hljs-number">1481</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_sync_handler+<span class="hljs-number">0xb0</span>/<span class="hljs-number">0xb4</span><br><span class="hljs-number">1482</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_sync+<span class="hljs-number">0x160</span>/<span class="hljs-number">0x180</span><br></code></pre></td></tr></table></figure>
<h3 id="unregister_netdevice_many">unregister_netdevice_many</h3>
<p>在搭建的虚拟机测试环境中一直没有复现此问题，但是此问题在鲲鹏920上必现。就去阅读了<code>rtnl_dellink</code>、<code>unregister_netdevice_many</code>等函数，有点怀疑这个问题跟rcu有一定关系，<code>unregister_netdevice_many</code>中两次调用<code>synchronize_net</code>，<code>ip link del veth0</code>命令执行后走到函数unregister_netdevice_many后大概会挂rcu回调。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">10814</span> <span class="hljs-type">void</span> <span class="hljs-title function_">unregister_netdevice_many</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *head)</span><br>10815 &#123;<br><span class="hljs-number">10816</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span> *<span class="hljs-title">dev</span>, *<span class="hljs-title">tmp</span>;</span><br><span class="hljs-number">10817</span>     LIST_HEAD(close_head);<br><span class="hljs-number">10818</span><br><span class="hljs-number">10819</span>     BUG_ON(dev_boot_phase);<br><span class="hljs-number">10820</span>     ASSERT_RTNL();<br><span class="hljs-number">10821</span><br><span class="hljs-number">10822</span>     <span class="hljs-keyword">if</span> (list_empty(head))<br><span class="hljs-number">10823</span>         <span class="hljs-keyword">return</span>;<br><span class="hljs-number">10824</span><br><span class="hljs-number">10825</span>     list_for_each_entry_safe(dev, tmp, head, unreg_list) &#123;<br><span class="hljs-number">10826</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">10827</span>             MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,<br><span class="hljs-number">10828</span> +-----  <span class="hljs-number">4</span> lines: <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">10832</span>         &#125;<br><span class="hljs-number">10833</span><br><span class="hljs-number">10834</span>         <span class="hljs-comment">/* Some devices call without registering</span><br><span class="hljs-comment">10835          * for initialization unwind. Remove those</span><br><span class="hljs-comment">10836          * devices and proceed with the remaining.</span><br><span class="hljs-comment">10837          */</span><br><span class="hljs-number">10838</span>         <span class="hljs-keyword">if</span> (dev-&gt;reg_state == NETREG_UNINITIALIZED) &#123;<br><span class="hljs-number">10839</span>             pr_debug(<span class="hljs-string">&quot;unregister_netdevice: device %s/%p never was registered\n&quot;</span>,<br><span class="hljs-number">10840</span>                  dev-&gt;name, dev);<br><span class="hljs-number">10841</span><br><span class="hljs-number">10842</span>             WARN_ON(<span class="hljs-number">1</span>);<br><span class="hljs-number">10843</span>             list_del(&amp;dev-&gt;unreg_list);<br><span class="hljs-number">10844</span>             <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">10845</span>         &#125;<br><span class="hljs-number">10846</span>         dev-&gt;dismantle = <span class="hljs-literal">true</span>;<br><span class="hljs-number">10847</span>         BUG_ON(dev-&gt;reg_state != NETREG_REGISTERED);<br><span class="hljs-number">10848</span>     &#125;<br><span class="hljs-number">10849</span><br><span class="hljs-number">10850</span>     <span class="hljs-comment">/* If device is running, close it first. */</span><br><span class="hljs-number">10851</span>     list_for_each_entry(dev, head, unreg_list)<br><span class="hljs-number">10852</span>         list_add_tail(&amp;dev-&gt;close_list, &amp;close_head);<br><span class="hljs-number">10853</span>     dev_close_many(&amp;close_head, <span class="hljs-literal">true</span>);<br><span class="hljs-number">10854</span><br><span class="hljs-number">10855</span>     list_for_each_entry(dev, head, unreg_list) &#123;<br><span class="hljs-number">10856</span>         <span class="hljs-comment">/* And unlink it from device chain. */</span><br><span class="hljs-number">10857</span>         unlist_netdevice(dev);<br><span class="hljs-number">10858</span><br><span class="hljs-number">10859</span>         dev-&gt;reg_state = NETREG_UNREGISTERING;<br><span class="hljs-number">10860</span>     &#125;<br><span class="hljs-number">10861</span>     flush_all_backlogs();<br><span class="hljs-number">10862</span><br><span class="hljs-number">10863</span>     synchronize_net();<br><span class="hljs-number">10864</span><br><span class="hljs-number">10865</span>     list_for_each_entry(dev, head, unreg_list) &#123;<br><span class="hljs-number">10866</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">10867</span>             MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,<br><span class="hljs-number">10868</span> +-----  <span class="hljs-number">4</span> lines: <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span>------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">10872</span>         &#125;<br><span class="hljs-number">10873</span><br><span class="hljs-number">10874</span>         <span class="hljs-keyword">struct</span> sk_buff *skb = <span class="hljs-literal">NULL</span>;<br><span class="hljs-number">10875</span><br><span class="hljs-number">10876</span>         <span class="hljs-comment">/* Shutdown queueing discipline. */</span><br><span class="hljs-number">10877</span>         dev_shutdown(dev);<br><span class="hljs-number">10878</span><br><span class="hljs-number">10879</span>         dev_xdp_uninstall(dev);<br><span class="hljs-number">10880</span><br><span class="hljs-number">10881</span>         <span class="hljs-comment">/* Notify protocols, that we are about to destroy</span><br><span class="hljs-comment">10882          * this device. They should clean all the things.</span><br><span class="hljs-comment">10883          */</span><br><span class="hljs-number">10884</span>         call_netdevice_notifiers(NETDEV_UNREGISTER, dev);<br><span class="hljs-number">10885</span><br><span class="hljs-number">10886</span>         <span class="hljs-keyword">if</span> (!dev-&gt;rtnl_link_ops ||<br><span class="hljs-number">10887</span>             dev-&gt;rtnl_link_state == RTNL_LINK_INITIALIZED)<br><span class="hljs-number">10888</span>             skb = rtmsg_ifinfo_build_skb(RTM_DELLINK, dev, ~<span class="hljs-number">0U</span>, <span class="hljs-number">0</span>,<br><span class="hljs-number">10889</span>                              GFP_KERNEL, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><span class="hljs-number">10890</span><br><span class="hljs-number">10891</span>         <span class="hljs-comment">/*</span><br><span class="hljs-comment">10892          *  Flush the unicast and multicast chains</span><br><span class="hljs-comment">10893          */</span><br><span class="hljs-number">10894</span>         dev_uc_flush(dev);<br><span class="hljs-number">10895</span>         dev_mc_flush(dev);<br><span class="hljs-number">10896</span><br><span class="hljs-number">10897</span>         netdev_name_node_alt_flush(dev);<br><span class="hljs-number">10898</span>         netdev_name_node_free(dev-&gt;name_node);<br><span class="hljs-number">10899</span><br><span class="hljs-number">10900</span>         <span class="hljs-keyword">if</span> (dev-&gt;netdev_ops-&gt;ndo_uninit)<br><span class="hljs-number">10901</span>             dev-&gt;netdev_ops-&gt;ndo_uninit(dev);<br><span class="hljs-number">10902</span><br><span class="hljs-number">10903</span>         <span class="hljs-keyword">if</span> (skb)<br><span class="hljs-number">10904</span>             rtmsg_ifinfo_send(skb, dev, GFP_KERNEL);<br><span class="hljs-number">10905</span><br><span class="hljs-number">10906</span>         <span class="hljs-comment">/* Notifier chain MUST detach us all upper devices. */</span><br><span class="hljs-number">10907</span>         WARN_ON(netdev_has_any_upper_dev(dev));<br><span class="hljs-number">10908</span>         WARN_ON(netdev_has_any_lower_dev(dev));<br><span class="hljs-number">10909</span><br><span class="hljs-number">10910</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">10911</span>             MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,<br><span class="hljs-number">10912</span> +-----  <span class="hljs-number">4</span> lines: <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span>------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">10916</span>         &#125;<br><span class="hljs-number">10917</span><br><span class="hljs-number">10918</span>         <span class="hljs-comment">/* Remove entries from kobject tree */</span><br><span class="hljs-number">10919</span>         netdev_unregister_kobject(dev);<br><span class="hljs-number">10920</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_XPS</span><br><span class="hljs-number">10921</span>         <span class="hljs-comment">/* Remove XPS queueing entries */</span><br><span class="hljs-number">10922</span>         netif_reset_xps_queues_gt(dev, <span class="hljs-number">0</span>);<br><span class="hljs-number">10923</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">10924</span>         cond_resched();<br><span class="hljs-number">10925</span>     &#125;<br><span class="hljs-number">10926</span><br><span class="hljs-number">10927</span>     synchronize_net();<br><span class="hljs-number">10928</span><br><span class="hljs-number">10929</span>     list_for_each_entry(dev, head, unreg_list) &#123;<br><span class="hljs-number">10930</span>         dev_put(dev);<br><span class="hljs-number">10931</span>         net_set_todo(dev);<br><span class="hljs-number">10932</span>     &#125;<br><span class="hljs-number">10933</span><br><span class="hljs-number">10934</span>     list_del(head);<br><span class="hljs-number">10935</span> &#125;<br><span class="hljs-number">10936</span> EXPORT_SYMBOL(unregister_netdevice_many);<br></code></pre></td></tr></table></figure>
<h3 id="synchronize_net">synchronize_net</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">10763</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment">10764  *  synchronize_net -  Synchronize with packet receive processing    // 与数据包接收处理同步</span><br><span class="hljs-comment">10765  *</span><br><span class="hljs-comment">10766  *  Wait for packets currently being received to be done.           // 等待当前正在接收的数据包处理完成</span><br><span class="hljs-comment">10767  *  Does not block later packets from starting.                    // 不阻止后续数据包开始处理</span><br><span class="hljs-comment">10768  */</span><br><span class="hljs-number">10769</span> <span class="hljs-type">void</span> <span class="hljs-title function_">synchronize_net</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>                                        <span class="hljs-comment">// 定义 synchronize_net 函数</span><br>10770 &#123;<br><span class="hljs-number">10771</span>     might_sleep();                                               <span class="hljs-comment">// 可能引起睡眠（调度）</span><br><span class="hljs-number">10772</span>     <span class="hljs-keyword">if</span> (rtnl_is_locked())                                        <span class="hljs-comment">// 如果 rtnl 锁已被锁定</span><br><span class="hljs-number">10773</span>         synchronize_rcu_expedited();                             <span class="hljs-comment">// 调用加速的 RCU 同步函数</span><br><span class="hljs-number">10774</span>     <span class="hljs-keyword">else</span>                                                         <span class="hljs-comment">// 否则</span><br><span class="hljs-number">10775</span>         synchronize_rcu();                                       <span class="hljs-comment">// 调用普通的 RCU 同步函数</span><br><span class="hljs-number">10776</span> &#125;<br><span class="hljs-number">10777</span> EXPORT_SYMBOL(synchronize_net);                                  <span class="hljs-comment">// 导出 synchronize_net 符号供模块使用</span><br></code></pre></td></tr></table></figure>
<p>在 Linux 内核中，<code>synchronize_rcu()</code> 和
<code>synchronize_rcu_expedited()</code> 都是用于 RCU (Read-Copy-Update)
同步的函数，但它们在实现方式和使用场景上有显著区别。以下是两者的详细对比：</p>
<h4 id="定义与功能">1. <strong>定义与功能</strong></h4>
<ul>
<li><strong><code>synchronize_rcu()</code></strong> 这是一个标准的 RCU
同步函数。它会等待所有现有的 RCU 读端临界区（read-side critical
sections）完成，即等待所有 CPU 上正在使用 RCU
保护数据的读操作结束，然后才会返回。
<ul>
<li>它是“非侵入式”的，依赖于正常的调度和上下文切换来完成同步。</li>
</ul></li>
<li><strong><code>synchronize_rcu_expedited()</code></strong>
这是一个加速版本的 RCU 同步函数。与 <code>synchronize_rcu()</code>
类似，它也等待所有 RCU
读端临界区完成，但它会主动采取措施加快这个过程，而不是被动等待。
<ul>
<li>它是“侵入式”的，会强制触发调度或中断，以尽快完成同步。</li>
</ul></li>
</ul>
<hr />
<h4 id="实现机制">2. <strong>实现机制</strong></h4>
<ul>
<li><strong><code>synchronize_rcu()</code></strong>
<ul>
<li>依赖内核的自然调度（如上下文切换、时钟滴答等）来检测 RCU
的宽限期（grace period）结束。</li>
<li>通常会等待一个完整的宽限期，这可能需要较长时间，具体取决于系统的负载和调度情况。</li>
</ul></li>
<li><strong><code>synchronize_rcu_expedited()</code></strong>
<ul>
<li>通过发送 IPI (Inter-Processor Interrupt，处理器间中断) 到所有
CPU，强制每个 CPU 检查并退出当前的 RCU 读端临界区。</li>
<li>不依赖自然调度，而是主动干预系统运行，从而显著缩短宽限期的等待时间。</li>
</ul></li>
</ul>
<hr />
<h4 id="性能与开销">3. <strong>性能与开销</strong></h4>
<ul>
<li><strong><code>synchronize_rcu()</code></strong>
<ul>
<li>开销较低，因为它不主动干扰系统的运行，只是被动等待。</li>
<li>但完成时间较长，尤其在系统负载较低或 CPU 很少切换上下文时。</li>
</ul></li>
<li><strong><code>synchronize_rcu_expedited()</code></strong>
<ul>
<li>开销较高，因为它会触发 IPI 和强制调度，可能干扰正在运行的任务。</li>
<li>完成时间短，适合需要快速同步的场景。</li>
</ul></li>
</ul>
<hr />
<h4 id="使用场景">4. <strong>使用场景</strong></h4>
<ul>
<li><strong><code>synchronize_rcu()</code></strong>
<ul>
<li>适用于对延迟不敏感的场景。</li>
<li>常见于不需要立即释放资源或对性能影响要求较低的代码路径。</li>
<li>例如，普通的内核模块卸载或资源清理。</li>
</ul></li>
<li><strong><code>synchronize_rcu_expedited()</code></strong>
<ul>
<li>适用于对延迟敏感的场景。</li>
<li>常见于需要快速完成同步的代码路径，例如网络子系统中频繁更新的数据结构（如路由表）或锁竞争较高的环境（如
RTNL 锁被持有时）。</li>
<li>在你的代码示例中，当 <code>rtnl_is_locked()</code> 为真时，使用
<code>synchronize_rcu_expedited()</code>，表明这是一个需要快速同步的场景。</li>
</ul></li>
</ul>
<hr />
<h4 id="典型区别总结">5. <strong>典型区别总结</strong></h4>
<table>

<thead>
<tr class="header">
<th>特性</th>
<th><code>synchronize_rcu()</code></th>
<th><code>synchronize_rcu_expedited()</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>同步速度</strong></td>
<td>较慢</td>
<td>较快</td>
</tr>
<tr class="even">
<td><strong>系统开销</strong></td>
<td>低</td>
<td>高</td>
</tr>
<tr class="odd">
<td><strong>实现方式</strong></td>
<td>被动等待宽限期</td>
<td>主动触发 IPI 和调度</td>
</tr>
<tr class="even">
<td><strong>适用场景</strong></td>
<td>延迟不敏感</td>
<td>延迟敏感</td>
</tr>
<tr class="odd">
<td><strong>侵入性</strong></td>
<td>非侵入式</td>
<td>侵入式</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="在你的代码中的上下文">6.
<strong>在你的代码中的上下文</strong></h4>
<p>在你提供的代码中： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (rtnl_is_locked())<br>    synchronize_rcu_expedited();<br><span class="hljs-keyword">else</span><br>    synchronize_rcu();<br></code></pre></td></tr></table></figure> - 当 RTNL
锁被持有时（<code>rtnl_is_locked()</code> 为真），使用
<code>synchronize_rcu_expedited()</code>，因为这通常意味着当前处于一个关键路径（如网络配置更改），需要尽快完成同步以减少锁的持有时间。
- 当 RTNL 锁未被持有时，使用
<code>synchronize_rcu()</code>，因为此时对同步的实时性要求较低，可以接受更长的等待时间以降低系统开销。</p>
<h3 id="openvswitch">openvswitch</h3>
<p>当前基本上可以推断出跟rcu静默期有关，是否有某个skb在静默期期间处理出错？</p>
<p>回头再去看看vmcore-dmesg.txt中有关openvswitch相关栈：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">[ <span class="hljs-number">4394.186133</span>] Call trace:                                    <span class="hljs-comment">// 调用栈跟踪</span><br>[ <span class="hljs-number">4394.189985</span>]  netdev_pick_tx+<span class="hljs-number">0x27c</span>/<span class="hljs-number">0x294</span>                   <span class="hljs-comment">// 选择网络设备传输队列的函数（偏移0x27c，总大小0x294）</span><br>[ <span class="hljs-number">4394.195220</span>]  netdev_core_pick_tx+<span class="hljs-number">0xdc</span>/<span class="hljs-number">0x10c</span>               <span class="hljs-comment">// 核心网络设备选择传输队列的函数</span><br>[ <span class="hljs-number">4394.200796</span>]  __dev_queue_xmit+<span class="hljs-number">0x104</span>/<span class="hljs-number">0xac0</span>                 <span class="hljs-comment">// 将数据包放入设备传输队列的核心函数</span><br>[ <span class="hljs-number">4394.206192</span>]  dev_queue_xmit+<span class="hljs-number">0x1c</span>/<span class="hljs-number">0x30</span>                     <span class="hljs-comment">// 设备传输队列的封装函数</span><br>[ <span class="hljs-number">4394.211251</span>]  ovs_vport_send+<span class="hljs-number">0xac</span>/<span class="hljs-number">0x180</span> [openvswitch]      <span class="hljs-comment">// Open vSwitch 虚拟端口发送数据包的函数</span><br>[ <span class="hljs-number">4394.217599</span>]  do_output+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x160</span> [openvswitch]           <span class="hljs-comment">// Open vSwitch 执行输出操作的函数</span><br>[ <span class="hljs-number">4394.223509</span>]  do_execute_actions+<span class="hljs-number">0x868</span>/<span class="hljs-number">0x880</span> [openvswitch] <span class="hljs-comment">// Open vSwitch 执行流表动作的函数</span><br>[ <span class="hljs-number">4394.230277</span>]  ovs_execute_actions+<span class="hljs-number">0x64</span>/<span class="hljs-number">0xe0</span> [openvswitch]  <span class="hljs-comment">// Open vSwitch 处理动作的封装函数</span><br>[ <span class="hljs-number">4394.236959</span>]  ovs_dp_process_packet+<span class="hljs-number">0x9c</span>/<span class="hljs-number">0x1e4</span> [openvswitch] <span class="hljs-comment">// Open vSwitch 数据平面处理数据包的函数</span><br>[ <span class="hljs-number">4394.243899</span>]  ovs_vport_receive+<span class="hljs-number">0x7c</span>/<span class="hljs-number">0xec</span> [openvswitch]    <span class="hljs-comment">// Open vSwitch 虚拟端口接收数据包的函数</span><br>[ <span class="hljs-number">4394.250412</span>]  netdev_port_receive+<span class="hljs-number">0xbc</span>/<span class="hljs-number">0x17c</span> [openvswitch] <span class="hljs-comment">// Open vSwitch 网络设备端口接收数据包的函数</span><br>[ <span class="hljs-number">4394.257183</span>]  netdev_frame_hook+<span class="hljs-number">0x2c</span>/<span class="hljs-number">0x44</span> [openvswitch]    <span class="hljs-comment">// Open vSwitch 网络设备帧处理钩子函数</span><br>[ <span class="hljs-number">4394.263673</span>]  __netif_receive_skb_core+<span class="hljs-number">0x294</span>/<span class="hljs-number">0xdd4</span>         <span class="hljs-comment">// 核心网络接口接收数据帧的函数</span><br>[ <span class="hljs-number">4394.269708</span>]  __netif_receive_skb_list_core+<span class="hljs-number">0xa4</span>/<span class="hljs-number">0x290</span>     <span class="hljs-comment">// 批量接收数据帧的核心函数</span><br>[ <span class="hljs-number">4394.276067</span>]  __netif_receive_skb_list+<span class="hljs-number">0x120</span>/<span class="hljs-number">0x1a0</span>         <span class="hljs-comment">// 批量接收数据帧的封装函数</span><br>[ <span class="hljs-number">4394.282053</span>]  netif_receive_skb_list_internal+<span class="hljs-number">0xe4</span>/<span class="hljs-number">0x1f0</span>   <span class="hljs-comment">// 内部批量接收数据帧的函数</span><br>[ <span class="hljs-number">4394.288538</span>]  napi_complete_done+<span class="hljs-number">0x70</span>/<span class="hljs-number">0x1f0</span>                <span class="hljs-comment">// NAPI（网络轮询）完成处理的函数</span><br>[ <span class="hljs-number">4394.293897</span>]  hns3_nic_common_poll+<span class="hljs-number">0x104</span>/<span class="hljs-number">0x220</span> [hns3]      <span class="hljs-comment">// HNS3 网卡驱动的通用轮询函数（华为自研网卡）</span><br>[ <span class="hljs-number">4394.300093</span>]  napi_poll+<span class="hljs-number">0xcc</span>/<span class="hljs-number">0x264</span>                         <span class="hljs-comment">// NAPI 轮询处理函数</span><br>[ <span class="hljs-number">4394.304618</span>]  net_rx_action+<span class="hljs-number">0xd4</span>/<span class="hljs-number">0x21c</span>                     <span class="hljs-comment">// 网络接收软中断处理函数</span><br>[ <span class="hljs-number">4394.309463</span>]  __do_softirq+<span class="hljs-number">0x130</span>/<span class="hljs-number">0x358</span>                     <span class="hljs-comment">// 执行软中断的核心函数</span><br>[ <span class="hljs-number">4394.314284</span>]  irq_exit+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x13c</span>                         <span class="hljs-comment">// 退出中断处理的函数</span><br>[ <span class="hljs-number">4394.318740</span>]  __handle_domain_irq+<span class="hljs-number">0x88</span>/<span class="hljs-number">0xf0</span>                <span class="hljs-comment">// 处理域中断的函数</span><br>[ <span class="hljs-number">4394.323954</span>]  gic_handle_irq+<span class="hljs-number">0x78</span>/<span class="hljs-number">0x2c0</span>                    <span class="hljs-comment">// GIC（通用中断控制器）处理中断的函数</span><br>[ <span class="hljs-number">4394.328804</span>]  el1_irq+<span class="hljs-number">0xb8</span>/<span class="hljs-number">0x140</span>                           <span class="hljs-comment">// ARM64 异常级别1（EL1）中断处理函数</span><br>[ <span class="hljs-number">4394.333029</span>]  arch_cpu_idle+<span class="hljs-number">0x18</span>/<span class="hljs-number">0x40</span>                      <span class="hljs-comment">// CPU 空闲状态的架构特定函数</span><br>[ <span class="hljs-number">4394.337667</span>]  default_idle_call+<span class="hljs-number">0x5c</span>/<span class="hljs-number">0x1c0</span>                 <span class="hljs-comment">// 默认的 CPU 空闲调用函数</span><br>[ <span class="hljs-number">4394.342723</span>]  cpuidle_idle_call+<span class="hljs-number">0x174</span>/<span class="hljs-number">0x1b0</span>                <span class="hljs-comment">// CPU 空闲状态管理函数</span><br>[ <span class="hljs-number">4394.347853</span>]  do_idle+<span class="hljs-number">0xc8</span>/<span class="hljs-number">0x160</span>                           <span class="hljs-comment">// 执行 CPU 空闲状态的函数</span><br>[ <span class="hljs-number">4394.352025</span>]  cpu_startup_entry+<span class="hljs-number">0x30</span>/<span class="hljs-number">0xfc</span>                  <span class="hljs-comment">// CPU 启动入口函数</span><br>[ <span class="hljs-number">4394.356986</span>]  secondary_start_kernel+<span class="hljs-number">0x158</span>/<span class="hljs-number">0x1ec</span>           <span class="hljs-comment">// 次级 CPU 启动内核的函数</span><br></code></pre></td></tr></table></figure>
<h4 id="dis--lsx">dis -lsx</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -lsx ovs_vport_send+0xac<br>dis: openvswitch: module <span class="hljs-built_in">source</span> code is not available<br></code></pre></td></tr></table></figure>
<p>仅加载openvswitch.ko，注意使用绝对路径： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; mod -s openvswitch /lib/debug/lib/modules/5.10.0-136.12.0.88.ctl3.aarch64/kernel/net/openvswitch/openvswitch.ko-5.10.0-136.12.0.88.ctl3.aarch64.debug<br>     MODULE       NAME                           BASE           SIZE  OBJECT FILE<br>ffff800009905000  openvswitch              ffff8000098e4000   163840  /lib/debug/lib/modules/5.10.0-136.12.0.88.ctl3.aarch64/kernel/net/openvswitch/openvswitch.ko-5.10.0-136.12.0.88.ctl3.aarch64.debug<br></code></pre></td></tr></table></figure></p>
<p>再次执行<code>dis -lsx ovs_vport_send+0xac</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -lsx ovs_vport_send+0xac<br>FILE: net/openvswitch/vport.c<br>LINE: 508<br><br>  503           &#125;<br>  504<br>  505           skb-&gt;dev = vport-&gt;dev;<br>  506           skb-&gt;tstamp = 0;<br>  507           vport-&gt;ops-&gt;send(skb);<br>* 508           <span class="hljs-built_in">return</span>;<br>  509<br>  510   drop:<br>  511           kfree_skb(skb);<br>  512   &#125;<br></code></pre></td></tr></table></figure>
<p>简单解释 <code>dis -lsx ovs_vport_send+0xac</code>
的含义及其输出：</p>
<hr />
<h5 id="命令分解">命令分解</h5>
<ul>
<li><strong><code>dis</code></strong>：这是 <code>crash</code>
调试工具中的反汇编命令，用于将机器代码转换为汇编指令。</li>
<li><strong><code>-lsx</code></strong>：
<ul>
<li><strong><code>-l</code></strong>：显示源代码行号和文件名（如果有调试信息）。</li>
<li><strong><code>-s</code></strong>：在输出中嵌入对应的源代码。</li>
<li><strong><code>-x</code></strong>：以十六进制格式显示地址和指令。</li>
</ul></li>
<li><strong><code>ovs_vport_send+0xac</code></strong>：指定反汇编的目标地址，即函数
<code>ovs_vport_send</code> 的起始地址加上偏移量
<code>0xac</code>。</li>
</ul>
<p><strong>作用</strong>：这个命令会反汇编 <code>ovs_vport_send</code>
函数在偏移 <code>0xac</code> 处的代码，并展示对应的源代码和上下文。</p>
<hr />
<h5 id="输出解释">输出解释</h5>
<ul>
<li><strong><code>FILE: net/openvswitch/vport.c</code></strong>：表明代码来自
Open vSwitch 模块的源文件 <code>vport.c</code>。</li>
<li><strong><code>LINE: 508</code></strong>：偏移 <code>0xac</code>
对应的源代码行号是 508。</li>
<li><strong>源代码片段</strong>：
<ul>
<li>第 505 行：将 <code>vport-&gt;dev</code> 赋值给
<code>skb-&gt;dev</code>，设置数据包的设备。</li>
<li>第 506 行：将数据包的时间戳清零。</li>
<li>第 507 行：调用
<code>vport-&gt;ops-&gt;send(skb)</code>，通过虚拟端口的操作函数发送数据包。</li>
<li>**第 508 行（标有 *）**：<code>return;</code>
表示函数在此返回。这是偏移 <code>0xac</code>
对应的位置，可能是函数的正常退出点。</li>
<li>第 510-511 行：<code>drop</code> 标签和 <code>kfree_skb(skb)</code>
表示丢弃数据包的路径（如果执行流跳到这里）。</li>
</ul></li>
</ul>
<hr />
<h5 id="简单总结">简单总结</h5>
<p><code>dis -lsx ovs_vport_send+0xac</code> 的作用是： - 查看
<code>ovs_vport_send</code> 函数在偏移 <code>0xac</code> 处的指令。 -
输出显示这对应于 <code>net/openvswitch/vport.c</code> 第 508 行的
<code>return;</code> 语句，表明这是函数成功发送数据包后的返回点。 -
上下文代码展示了发送数据包前的准备工作（505-507
行）和可能的错误处理路径（510-511 行）。</p>
<h4 id="bt--l">bt -l</h4>
<p>进一步使用<code>bt -l</code>确定源码位置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -l | grep openvswitch -A1<br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send at ffff8000098f95b8 [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/vport.c: 507<br><span class="hljs-comment">#16 [ffff800012ab3670] do_output at ffff8000098e47fc [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/actions.c: 928<br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions at ffff8000098e66b4 [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/actions.c: 1291<br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions at ffff8000098e6b00 [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/actions.c: 1591<br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet at ffff8000098eaba8 [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/datapath.c: 254<br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive at ffff8000098f949c [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/vport.c: 452<br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive at ffff8000098fa03c [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/vport-netdev.c: 51<br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook at ffff8000098fa128 [openvswitch]</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/openvswitch/vport-netdev.c: 65<br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core at ffff800010ae77f0</span><br></code></pre></td></tr></table></figure>
<h4 id="ovs_vport_send">ovs_vport_send</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim vim net/openvswitch/vport.c +507</span><br><br><span class="hljs-number">473</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ovs_vport_send</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vport *vport, <span class="hljs-keyword">struct</span> sk_buff *skb, u8 mac_proto)</span><br>474 &#123;<br><span class="hljs-number">475</span>     <span class="hljs-type">int</span> mtu = vport-&gt;dev-&gt;mtu;<br><span class="hljs-number">476</span><br><span class="hljs-number">477</span>     <span class="hljs-keyword">switch</span> (vport-&gt;dev-&gt;type) &#123;<br><span class="hljs-number">478</span>     <span class="hljs-keyword">case</span> ARPHRD_NONE:<br><span class="hljs-number">479</span>         <span class="hljs-keyword">if</span> (mac_proto == MAC_PROTO_ETHERNET) &#123;<br><span class="hljs-number">480</span>             skb_reset_network_header(skb);<br><span class="hljs-number">481</span>             skb_reset_mac_len(skb);<br><span class="hljs-number">482</span>             skb-&gt;protocol = htons(ETH_P_TEB);<br><span class="hljs-number">483</span>         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mac_proto != MAC_PROTO_NONE) &#123;<br><span class="hljs-number">484</span>             WARN_ON_ONCE(<span class="hljs-number">1</span>);<br><span class="hljs-number">485</span>             <span class="hljs-keyword">goto</span> drop;<br><span class="hljs-number">486</span>         &#125;<br><span class="hljs-number">487</span>         <span class="hljs-keyword">break</span>;<br><span class="hljs-number">488</span>     <span class="hljs-keyword">case</span> ARPHRD_ETHER:<br><span class="hljs-number">489</span>         <span class="hljs-keyword">if</span> (mac_proto != MAC_PROTO_ETHERNET)<br><span class="hljs-number">490</span>             <span class="hljs-keyword">goto</span> drop;<br><span class="hljs-number">491</span>         <span class="hljs-keyword">break</span>;<br><span class="hljs-number">492</span>     <span class="hljs-keyword">default</span>:<br><span class="hljs-number">493</span>         <span class="hljs-keyword">goto</span> drop;<br><span class="hljs-number">494</span>     &#125;<br><span class="hljs-number">495</span><br><span class="hljs-number">496</span>     <span class="hljs-keyword">if</span> (unlikely(packet_length(skb, vport-&gt;dev) &gt; mtu &amp;&amp;<br><span class="hljs-number">497</span>              !skb_is_gso(skb))) &#123;<br><span class="hljs-number">498</span>         net_warn_ratelimited(<span class="hljs-string">&quot;%s: dropped over-mtu packet: %d &gt; %d\n&quot;</span>,<br><span class="hljs-number">499</span> +-----  <span class="hljs-number">2</span> lines: vport-&gt;dev-&gt;name,-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">501</span>         vport-&gt;dev-&gt;stats.tx_errors++;<br><span class="hljs-number">502</span>         <span class="hljs-keyword">goto</span> drop;<br><span class="hljs-number">503</span>     &#125;<br><span class="hljs-number">504</span><br><span class="hljs-number">505</span>     skb-&gt;dev = vport-&gt;dev;<br><span class="hljs-number">506</span>     skb-&gt;tstamp = <span class="hljs-number">0</span>;<br><span class="hljs-number">507</span>     vport-&gt;ops-&gt;send(skb);<br><span class="hljs-number">508</span>     <span class="hljs-keyword">return</span>;<br><span class="hljs-number">509</span><br><span class="hljs-number">510</span> drop:<br><span class="hljs-number">511</span>     kfree_skb(skb);<br><span class="hljs-number">512</span> &#125;<br></code></pre></td></tr></table></figure>
<h4 id="do_output">do_output</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">910</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_output</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> datapath *dp, <span class="hljs-keyword">struct</span> sk_buff *skb, <span class="hljs-type">int</span> out_port,  <span class="hljs-comment">// 定义静态函数 do_output，处理数据包输出，参数包括数据路径、数据包、输出端口和流键</span></span><br><span class="hljs-params"><span class="hljs-number">911</span>               <span class="hljs-keyword">struct</span> sw_flow_key *key)</span>                                        <span class="hljs-comment">// 流键参数，用于标识数据流</span><br>912 &#123;<br><span class="hljs-number">913</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vport</span> *<span class="hljs-title">vport</span> =</span> ovs_vport_rcu(dp, out_port);                        <span class="hljs-comment">// 获取输出端口对应的虚拟端口（vport），使用 RCU 安全访问</span><br><span class="hljs-number">915</span>     <span class="hljs-keyword">if</span> (likely(vport)) &#123;                                                      <span class="hljs-comment">// 如果虚拟端口存在（likely 表示大概率成立）</span><br><span class="hljs-number">916</span>         u16 mru = OVS_CB(skb)-&gt;mru;                                           <span class="hljs-comment">// 从数据包的控制块中获取最大接收单元（MRU）</span><br><span class="hljs-number">917</span>         u32 cutlen = OVS_CB(skb)-&gt;cutlen;                                     <span class="hljs-comment">// 从数据包的控制块中获取裁剪长度（cutlen）</span><br><span class="hljs-number">919</span>         <span class="hljs-keyword">if</span> (unlikely(cutlen &gt; <span class="hljs-number">0</span>)) &#123;                                           <span class="hljs-comment">// 如果裁剪长度大于 0（unlikely 表示小概率事件）</span><br><span class="hljs-number">920</span>             <span class="hljs-keyword">if</span> (skb-&gt;len - cutlen &gt; ovs_mac_header_len(key))                  <span class="hljs-comment">// 如果数据包长度减去裁剪长度仍大于 MAC 头部长度</span><br><span class="hljs-number">921</span>                 pskb_trim(skb, skb-&gt;len - cutlen);                           <span class="hljs-comment">// 裁剪数据包到指定长度（去掉 cutlen 部分）</span><br><span class="hljs-number">922</span>             <span class="hljs-keyword">else</span>                                                              <span class="hljs-comment">// 否则（裁剪后长度不足 MAC 头部长度）</span><br><span class="hljs-number">923</span>                 pskb_trim(skb, ovs_mac_header_len(key));                      <span class="hljs-comment">// 裁剪数据包到 MAC 头部长度</span><br><span class="hljs-number">924</span>         &#125;<br><span class="hljs-number">926</span>         <span class="hljs-keyword">if</span> (likely(!mru ||                                                    <span class="hljs-comment">// 如果 MRU 为 0 或</span><br><span class="hljs-number">927</span>                    (skb-&gt;len &lt;= mru + vport-&gt;dev-&gt;hard_header_len))) &#123;        <span class="hljs-comment">// 数据包长度小于等于 MRU 加上设备头部长度（likely 表示大概率成立）</span><br><span class="hljs-number">928</span>             ovs_vport_send(vport, skb, ovs_key_mac_proto(key));               <span class="hljs-comment">// 通过虚拟端口发送数据包，使用流键中的 MAC 协议</span><br><span class="hljs-number">929</span>         &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mru &lt;= vport-&gt;dev-&gt;mtu) &#123;                                  <span class="hljs-comment">// 如果 MRU 不为 0 且小于等于设备的最大传输单元（MTU）</span><br><span class="hljs-number">930</span>             <span class="hljs-keyword">struct</span> net *net = read_pnet(&amp;dp-&gt;net);                            <span class="hljs-comment">// 获取数据路径的网络命名空间</span><br><span class="hljs-number">932</span>             ovs_fragment(net, vport, skb, mru, key);                          <span class="hljs-comment">// 对数据包进行分片处理</span><br><span class="hljs-number">933</span>         &#125; <span class="hljs-keyword">else</span> &#123;                                                              <span class="hljs-comment">// 如果 MRU 超过 MTU</span><br><span class="hljs-number">934</span>             kfree_skb(skb);                                                   <span class="hljs-comment">// 释放数据包内存</span><br><span class="hljs-number">935</span>         &#125;<br><span class="hljs-number">936</span>     &#125; <span class="hljs-keyword">else</span> &#123;                                                                  <span class="hljs-comment">// 如果虚拟端口不存在</span><br><span class="hljs-number">937</span>         kfree_skb(skb);                                                       <span class="hljs-comment">// 释放数据包内存</span><br><span class="hljs-number">938</span>     &#125;<br><span class="hljs-number">939</span> &#125;<br></code></pre></td></tr></table></figure>
<h4 id="代码修复">代码修复</h4>
<p>修复这个bug后尝试在上游社区找找有没有类似问题，结果发现上游2天前才修复。</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://lkml.org/lkml/2025/3/17/1299"
class="uri">https://lkml.org/lkml/2025/3/17/1299</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://lore.kernel.org/bpf/20250317154537.3633540-3-florian.fainelli@broadcom.com/T/"
class="uri">https://lore.kernel.org/bpf/20250317154537.3633540-3-florian.fainelli@broadcom.com/T/</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://lore.kernel.org/bpf/20250317154537.3633540-1-florian.fainelli@broadcom.com/"
class="uri">https://lore.kernel.org/bpf/20250317154537.3633540-1-florian.fainelli@broadcom.com/</a></p></li>
</ul>
<p>这里合入上游修复代码更妥当，虽然写法差不多: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">b4 am -o - 20250317154537.3633540-1-florian.fainelli@broadcom.com | git am -3<br></code></pre></td></tr></table></figure></p>
<h5 id="net-openvswitch-fix-race-on-port-output">net: openvswitch: fix
race on port output</h5>
<p>以下是 diff 文件中关键改动点添加中文注释后的结果：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/net/core/dev.c b/net/core/dev.c</span><br><span class="hljs-comment">index 4d3851278303..3243e5992d99 100644</span><br><span class="hljs-comment">--- a/net/core/dev.c</span><br><span class="hljs-comment">+++ b/net/core/dev.c</span><br><span class="hljs-meta">@@ -3183,6 +3183,7 @@</span> static u16 skb_tx_hash(const struct net_device *dev,<br>        &#125;<br><br>        if (skb_rx_queue_recorded(skb)) &#123;<br><span class="hljs-addition">+               WARN_ON_ONCE(qcount == 0);  // 增加警告：如果队列计数为 0，则触发一次性警告，提示潜在问题</span><br>                hash = skb_get_rx_queue(skb);<br>                if (hash &gt;= qoffset)<br>                        hash -= qoffset;<br><span class="hljs-comment">diff --git a/net/openvswitch/actions.c b/net/openvswitch/actions.c</span><br><span class="hljs-comment">index 80fee9d118ee..a66b826e6711 100644</span><br><span class="hljs-comment">--- a/net/openvswitch/actions.c</span><br><span class="hljs-comment">+++ b/net/openvswitch/actions.c</span><br><span class="hljs-meta">@@ -912,7 +912,7 @@</span> static void do_output(struct datapath *dp, struct sk_buff *skb, int out_port,<br> &#123;<br>        struct vport *vport = ovs_vport_rcu(dp, out_port);<br><br><span class="hljs-deletion">-       if (likely(vport)) &#123;</span><br><span class="hljs-addition">+       if (likely(vport &amp;&amp; netif_carrier_ok(vport-&gt;dev))) &#123;  // 修改条件：不仅检查 vport 是否存在，还要确保设备载波状态正常</span><br>                u16 mru = OVS_CB(skb)-&gt;mru;<br>                u32 cutlen = OVS_CB(skb)-&gt;cutlen;<br></code></pre></td></tr></table></figure>
<h6 id="注释说明">注释说明：</h6>
<ol type="1">
<li><strong>net/core/dev.c 中的改动</strong>：
<ul>
<li>在 <code>+ WARN_ON_ONCE(qcount == 0);</code>
处添加注释，说明这是一个警告机制，用于在队列计数为 0
时提醒开发者可能存在异常情况，且警告只触发一次。</li>
</ul></li>
<li><strong>net/openvswitch/actions.c 中的改动</strong>：
<ul>
<li>在
<code>+ if (likely(vport &amp;&amp; netif_carrier_ok(vport-&gt;dev)))</code>
处添加注释，说明改动增强了条件检查，不仅要求虚拟端口存在，还要求设备载波状态（carrier）正常，以确保数据包只在网络接口可用时发送。</li>
</ul></li>
</ol>
<h5
id="openvswitch-fix-lockup-on-tx-to-unregistering-netdev-with-carrier">openvswitch:
fix lockup on tx to unregistering netdev with carrier</h5>
<p>以下是 diff 文件中关键改动点添加中文注释后的结果：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/net/openvswitch/actions.c b/net/openvswitch/actions.c</span><br><span class="hljs-comment">index a66b826e6711..a02ea493c269 100644</span><br><span class="hljs-comment">--- a/net/openvswitch/actions.c</span><br><span class="hljs-comment">+++ b/net/openvswitch/actions.c</span><br><span class="hljs-meta">@@ -912,7 +912,9 @@</span> static void do_output(struct datapath *dp, struct sk_buff *skb, int out_port,<br> &#123;<br>        struct vport *vport = ovs_vport_rcu(dp, out_port);<br><br><span class="hljs-deletion">-       if (likely(vport &amp;&amp; netif_carrier_ok(vport-&gt;dev))) &#123;</span><br><span class="hljs-addition">+       if (likely(vport &amp;&amp;                           // 修改条件：检查 vport 是否存在</span><br><span class="hljs-addition">+                  netif_running(vport-&gt;dev) &amp;&amp;       // 增加检查：确保设备处于运行状态</span><br><span class="hljs-addition">+                  netif_carrier_ok(vport-&gt;dev))) &#123;   // 保留检查：确保设备载波状态正常</span><br>                u16 mru = OVS_CB(skb)-&gt;mru;<br>                u32 cutlen = OVS_CB(skb)-&gt;cutlen;<br></code></pre></td></tr></table></figure>
<h6 id="注释说明-1">注释说明：</h6>
<ul>
<li>在
<code>+ if (likely(vport &amp;&amp; netif_running(vport-&gt;dev) &amp;&amp; netif_carrier_ok(vport-&gt;dev)))</code>
处添加注释，说明此次改动增强了条件判断：
<ol type="1">
<li><code>vport</code>：保留原有检查，确保虚拟端口存在。</li>
<li><code>netif_running(vport-&gt;dev)</code>：新增检查，确保设备处于运行状态（即网络接口已启用）。</li>
<li><code>netif_carrier_ok(vport-&gt;dev)</code>：保留原有检查，确保设备载波状态正常（即物理链接可用）。</li>
</ol></li>
</ul>
<p>这些条件共同确保数据包只在虚拟端口存在且网络接口完全可用时进行处理，提升了代码的健壮性。</p>
<h5 id="netif_carrier_ok">netif_carrier_ok</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">4080</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment">4081  *  netif_carrier_ok - test if carrier present                    // 测试设备是否具有载波</span><br><span class="hljs-comment">4082  *  @dev: network device                                         // 参数：网络设备</span><br><span class="hljs-comment">4083  *</span><br><span class="hljs-comment">4084  * Check if carrier is present on device                        // 检查设备上是否存在载波</span><br><span class="hljs-comment">4085  */</span><br><span class="hljs-number">4086</span> <span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">netif_carrier_ok</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *dev)</span>  <span class="hljs-comment">// 定义内联函数：检查网络设备的载波状态，参数为网络设备结构体指针</span><br>4087 &#123;<br><span class="hljs-number">4088</span>     <span class="hljs-keyword">return</span> !test_bit(__LINK_STATE_NOCARRIER, &amp;dev-&gt;state);         <span class="hljs-comment">// 返回值：检查设备状态中是否未设置 NOCARRIER 位，若未设置则返回 true，表示载波存在</span><br><span class="hljs-number">4089</span> &#125;<br></code></pre></td></tr></table></figure>
<h6 id="载波是啥">载波是啥？</h6>
<p>在计算机网络和通信领域，“载波”（carrier）通常指的是物理层中用于传输数据的信号状态，具体来说，它与网络设备的物理连接状态有关。在你提供的代码上下文（<code>netif_carrier_ok</code>
函数）中，“载波”是指网络接口（如网卡）的物理链路是否正常工作。</p>
<h6 id="通俗解释">通俗解释</h6>
<p>想象一下，网络设备就像一台收音机，而“载波”就像是收音机接收到的无线电信号。如果收音机能接收到稳定的信号（载波存在），说明它可以正常工作；如果信号断了（没有载波），就没法接收数据了。在网络中，“载波”表示网线、光纤或其他物理介质是否正常连接并能传输数据。</p>
<h6 id="技术定义">技术定义</h6>
<p>在以太网等网络技术中，载波通常与以下概念相关： 1.
<strong>物理层信号</strong>：载波是网络设备检测到的物理信号，比如电信号（通过网线）或光信号（通过光纤）。如果设备能检测到这些信号，说明物理链路是通的。
2. <strong>链路状态</strong>：在 Linux
内核中，<code>netif_carrier_ok</code> 函数通过检查设备的
<code>state</code>（状态位）中的 <code>__LINK_STATE_NOCARRIER</code>
位来判断载波是否存在。如果这个位被置位（值为 1），表示“没有载波”（no
carrier），即物理链路断开；如果未置位（值为 0），表示“载波正常”（carrier
OK），链路是连通的。</p>
<h6 id="在代码中的含义">在代码中的含义</h6>
<p>在你提供的代码： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">return</span> !test_bit(__LINK_STATE_NOCARRIER, &amp;dev-&gt;state);<br></code></pre></td></tr></table></figure> - <code>__LINK_STATE_NOCARRIER</code>
是一个标志位，表示“无载波状态”。 - <code>test_bit</code>
检查这个标志位是否被置位。 - <code>!</code> 取反逻辑：如果
<code>__LINK_STATE_NOCARRIER</code> 是 0（未置位），函数返回
<code>true</code>，表示载波存在；如果置位，返回
<code>false</code>，表示载波丢失。</p>
<h6 id="现实例子">现实例子</h6>
<ol type="1">
<li><strong>载波存在</strong>：你把网线插进电脑，网卡灯亮起，网络正常工作，说明载波检测正常。</li>
<li><strong>载波丢失</strong>：网线被拔掉，或者交换机断电，网卡检测不到信号，载波状态变为“无载波”。</li>
</ol>
<h6 id="为什么重要">为什么重要？</h6>
<p>在网络编程（如 Open vSwitch 或 Linux
内核网络栈）中，检查载波状态可以避免向不可用的网络接口发送数据。比如，在前面的
<code>do_output</code> 函数中，增加了 <code>netif_carrier_ok</code>
检查，确保只有在链路正常时才处理数据包，从而提高效率和稳定性。</p>
<h2
id="httpslkml.orglkml20253171299">https://lkml.org/lkml/2025/3/17/1299</h2>
<p>这封邮件是关于Linux内核的一个补丁，标题为“[PATCH stable 5.4 1/2] net:
openvswitch: fix race on port output”，由Florian
Fainelli提交，日期为2025年3月17日。补丁针对的是Linux内核5.4版本中的一个问题，具体是一个与Open
vSwitch（开源虚拟交换机）相关的竞争条件（race
condition），可能会导致CPU陷入无限循环。</p>
<h3 id="问题背景">问题背景</h3>
<p>补丁描述了一个特定的网络配置场景和测试步骤，可能触发内核中的问题。以下是场景和问题的中文解释：</p>
<h4 id="测试环境配置">测试环境配置：</h4>
<ol type="1">
<li>在一台机器上创建一个Open
vSwitch实例，包含一个网桥（bridge）和默认的流量规则。</li>
<li>创建两个网络命名空间（network
namespaces），分别命名为“server”和“client”。</li>
<li>在网桥上添加两个Open
vSwitch接口，分别命名为“server”和“client”。</li>
<li>为每个Open
vSwitch接口创建一对veth（虚拟以太网设备），名称与接口对应，并配置32个接收（rx）和发送（tx）队列。</li>
<li>将veth对的另一端分别移动到对应的网络命名空间中。</li>
<li>在每个命名空间内的veth接口上分配IP地址（需在同一子网内）。</li>
<li>在“server”命名空间中启动一个HTTP服务器。</li>
<li>测试“client”命名空间中的客户端是否能访问“server”中的HTTP服务器。</li>
</ol>
<h4 id="触发问题的步骤">触发问题的步骤：</h4>
<ol type="1">
<li>从“client”端向HTTP服务器发送大量并行请求（大约3000个curl请求即可）。</li>
<li>在发送请求的同时，删除“client”网络命名空间（仅删除命名空间，不删除接口或停止服务器）。</li>
</ol>
<p>按照上述步骤操作时，有一定概率会导致主机的某个CPU陷入无限循环，并可能输出类似“kernel
CPU stuck”之类的错误信息。如果没有触发问题，可以重复尝试。</p>
<h4 id="问题的根本原因">问题的根本原因：</h4>
<p>问题的核心是一个竞争条件，发生在网络命名空间删除和数据包处理之间。以下是事件发生的详细序列：
1.
删除网络命名空间时，会调用<code>unregister_netdevice_many_notify</code>函数。
2.
该函数首先将veth设备两端的注册状态设置为<code>NETREG_UNREGISTERING</code>，然后执行<code>synchronize_net</code>同步操作。
3.
接着调用<code>call_netdevice_notifiers</code>，通知设备状态为<code>NETDEV_UNREGISTER</code>。
4. Open
vSwitch的<code>dp_device_event</code>函数处理这一通知，并调用<code>ovs_netdev_detach_dev</code>（如果设备关联了vport，即Open
vSwitch的虚拟端口）。 5.
<code>ovs_netdev_detach_dev</code>会移除设备的接收处理程序（rx_handlers），但不会阻止数据包继续发送到该设备。
6.
<code>dp_device_event</code>将vport的删除操作放入后台任务队列中，因为此时无法直接获取所需的<code>ovs_lock</code>锁。
7.
<code>unregister_netdevice_many_notify</code>继续执行，调用<code>netdev_unregister_kobject</code>，将设备的<code>real_num_tx_queues</code>（实际发送队列数）设置为0。
8. 后台任务随后删除vport（但这部分细节与问题无关）。 9.
在步骤7之后、步骤9之前，如果有数据包被发送到尚未删除的vport，数据包会被转发到<code>dev_queue_xmit</code>流程，尽管设备正在注销。</p>
<p>在<code>dev_queue_xmit</code>中，调用了<code>skb_tx_hash</code>函数来选择发送队列。如果数据包记录了接收队列（rx_queue），而设备的<code>real_num_tx_queues</code>为0，<code>skb_tx_hash</code>中的一个while循环会变成无限循环，导致CPU卡死。</p>
<h3 id="补丁的解决方案">补丁的解决方案</h3>
<p>为了解决这个问题，补丁做了以下两点修改： 1.
<strong>更新<code>do_output</code>函数</strong>：将没有载波（carrier）的设备视为已不存在的设备（类似于步骤9完成后应有的状态），从而避免将数据包发送到正在注销的设备。
2.
<strong>在<code>skb_tx_hash</code>中添加警告</strong>：如果检测到将要进入无限循环的情况，提前发出警告，便于调试和发现问题。</p>
<h3 id="总结">总结</h3>
<p>这个补丁修复了一个由于网络命名空间删除和数据包处理之间的竞争条件导致的内核问题。通过调整Open
vSwitch的输出逻辑和添加防护措施，避免了CPU陷入无限循环的风险。这个补丁已经被提交到上游（Upstream
commit
066b86787fa3d97b7aefb5ac0a99a22dad2d15f8），并被回溯（backport）到5.4版本的稳定内核分支。</p>
<p>这是一个非常有趣且技术性很强的问题！你在邮件中提到的补丁（[PATCH
stable 5.4 1/2] net: openvswitch: fix race on port
output）揭示了一个复杂的竞争条件（race condition），涉及到 Linux
内核网络栈、Open vSwitch (OVS) 和
RCU（Read-Copy-Update）机制的交互。你的疑问集中在“为什么在
<code>synchronize_net</code>（使用了 RCU
同步）之后仍然会出现问题”，这是一个值得深入探讨的地方。让我们逐步分析问题，并解答你的疑惑。</p>
<hr />
<h2
id="synchronize_net-已经提供了-rcu-同步为什么步骤-7设置-real_num_tx_queues-0之后步骤-9vport-删除完成之前还会出错"><code>synchronize_net</code>
已经提供了 RCU 同步，为什么步骤 7（设置
<code>real_num_tx_queues = 0</code>）之后、步骤 9（vport
删除完成）之前还会出错？</h2>
<hr />
<h3 id="rcu-和-synchronize_net-的作用">RCU 和
<code>synchronize_net</code> 的作用</h3>
<p><code>synchronize_net</code> 是 Linux
网络子系统中常用的同步原语，它基于 RCU，确保在某个点之后，所有使用 RCU
保护的读端 critical section 都已完成。具体来说： - <strong>RCU
读端</strong>：通过 <code>rcu_read_lock()</code> 和
<code>rcu_read_unlock()</code>
保护的代码段，通常用于访问网络设备的数据结构（如 <code>net_device</code>
或 OVS 的 vport）。 - <strong>RCU 写端</strong>：通过
<code>synchronize_rcu()</code>（在网络中表现为
<code>synchronize_net</code>）等待所有读端完成，然后执行后续修改。</p>
<p>在补丁描述的流程中： 1. <code>unregister_netdevice_many_notify</code>
调用 <code>synchronize_net</code>，目的是确保所有正在访问设备（如 veth
或 vport）的 RCU 读端都完成后，才继续执行后续操作（如通知设备注销）。 2.
理论上，<code>synchronize_net</code> 完成后，不应该有任何代码还在通过
RCU 访问已标记为 <code>NETREG_UNREGISTERING</code> 的设备。</p>
<p>但问题出在：<strong>数据包的发送路径并不完全受 RCU
的保护</strong>，或者说，OVS
的设计中存在一个窗口期，导致数据包处理和设备注销的逻辑未能完全同步。</p>
<hr />
<h3
id="问题的根本原因窗口期和数据包路径">问题的根本原因：窗口期和数据包路径</h3>
<p>仔细看看事件序列，分析为何 <code>synchronize_net</code>
未能阻止问题：</p>
<h4 id="事件序列简化版">事件序列（简化版）</h4>
<ol type="1">
<li><strong>命名空间删除触发注销</strong>：
<ul>
<li>调用 <code>unregister_netdevice_many_notify</code>，将 veth
设备的状态设为 <code>NETREG_UNREGISTERING</code>。</li>
<li>执行 <code>synchronize_net</code>，等待 RCU 宽限期（grace
period）结束。</li>
</ul></li>
<li><strong>通知和 OVS 处理</strong>：
<ul>
<li><code>call_netdevice_notifiers</code> 触发
<code>NETDEV_UNREGISTER</code> 事件。</li>
<li>OVS 的 <code>dp_device_event</code> 处理此事件，调用
<code>ovs_netdev_detach_dev</code>，移除 veth
的接收处理程序（rx_handlers），但 vport
的删除被放入后台任务队列（因为无法立即获取
<code>ovs_lock</code>）。</li>
</ul></li>
<li><strong>设备状态变更</strong>：
<ul>
<li><code>netdev_unregister_kobject</code> 将
<code>real_num_tx_queues</code> 设为
0，表示设备不再有有效的发送队列。</li>
</ul></li>
<li><strong>数据包发送的竞争</strong>：
<ul>
<li>在 vport 尚未从后台任务中完全删除之前，数据包仍可能通过 OVS
的数据路径（datapath）被转发到 veth 设备。</li>
<li>数据包进入 <code>dev_queue_xmit</code>，调用
<code>skb_tx_hash</code>。</li>
</ul></li>
<li><strong>无限循环</strong>：
<ul>
<li><code>skb_tx_hash</code> 检查到
<code>skb_rx_queue_recorded(skb)</code>
为真（数据包记录了接收队列号），但 <code>real_num_tx_queues</code> 为
0，导致队列选择逻辑中的循环无法退出。</li>
</ul></li>
</ol>
<h4 id="关键点为什么-synchronize_net-没挡住">关键点：为什么
<code>synchronize_net</code> 没挡住？</h4>
<ul>
<li><strong><code>synchronize_net</code> 的作用范围</strong>：
<ul>
<li>它只保证在调用点之后，RCU 保护的读端（如通过
<code>rcu_dereference</code> 访问 <code>net_device</code>
的代码）不再看到旧数据。</li>
<li>但它无法阻止非 RCU 保护的逻辑继续运行，比如 OVS
数据路径中正在处理的数据包。</li>
</ul></li>
<li><strong>OVS 数据路径的异步性</strong>：
<ul>
<li>OVS 的数据包处理（datapath）是高度并行的，通常由内核线程（如
<code>ovs-vswitchd</code> 或内核中的流表处理逻辑）驱动。</li>
<li>当 vport 仍在流表中（未被后台任务删除）时，数据包可能被转发到对应的
veth 设备，即使该设备已被标记为注销。</li>
<li><code>synchronize_net</code> 只同步了设备状态的变更（如
<code>NETREG_UNREGISTERING</code>），但没有直接影响 OVS
的流表更新或数据包转发逻辑。</li>
</ul></li>
<li><strong>窗口期</strong>：
<ul>
<li>在 <code>real_num_tx_queues</code> 被设为 0 后、vport
从流表中移除前，存在一个短暂的窗口期。</li>
<li>如果在此期间有数据包到达，OVS 会将其转发到 veth，而
<code>dev_queue_xmit</code> 并不知道设备已不可用，直接调用
<code>skb_tx_hash</code>，触发问题。</li>
</ul></li>
</ul>
<hr />
<h3 id="skb_tx_hash-的问题"><code>skb_tx_hash</code> 的问题</h3>
<p>补丁提到的问题发生在 <code>skb_tx_hash</code>
中。我们来看看这个函数（基于 Linux 5.4 的代码，可能略有简化）：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> u16 <span class="hljs-title function_">skb_tx_hash</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *dev, <span class="hljs-keyword">struct</span> sk_buff *skb)</span><br>&#123;<br>    u32 hash;<br><br>    <span class="hljs-keyword">if</span> (skb_rx_queue_recorded(skb)) &#123;<br>        hash = skb_get_rx_queue(skb);<br>        <span class="hljs-keyword">while</span> (unlikely(hash &gt;= dev-&gt;real_num_tx_queues))<br>            hash -= dev-&gt;real_num_tx_queues;<br>        <span class="hljs-keyword">return</span> hash;<br>    &#125;<br>    <span class="hljs-comment">/* 其他逻辑 */</span><br>&#125;<br></code></pre></td></tr></table></figure> - <strong>逻辑分析</strong>： - 如果
<code>skb_rx_queue_recorded(skb)</code> 为真，<code>hash</code>
被设置为数据包的接收队列号（<code>skb_get_rx_queue</code>）。 -
<code>while</code> 循环试图将 <code>hash</code> 调整到
<code>real_num_tx_queues</code> 范围内。 - 当
<code>real_num_tx_queues</code> 为 0 时，<code>hash &gt;= 0</code>
始终成立（假设 <code>hash</code> 是非负数），循环永远无法退出。</p>
<ul>
<li><strong>为什么会这样？</strong>
<ul>
<li><code>real_num_tx_queues</code> 被设为 0 表示设备已无发送能力，但
<code>skb_tx_hash</code> 没有对此做额外检查。</li>
<li>数据包仍被发送到这里，是因为 OVS
的数据路径没有及时感知到设备的注销状态。</li>
</ul></li>
</ul>
<hr />
<h3 id="补丁的修复思路">补丁的修复思路</h3>
<p>补丁的标题是“fix race on port output”： 1. <strong>在 OVS
中提前阻止数据包转发</strong>： - 在 <code>ovs_netdev_detach_dev</code>
中，确保移除 rx_handlers 后立即阻止数据包到达 veth。 2. <strong>改进
<code>skb_tx_hash</code> 的健壮性</strong>： - 在
<code>real_num_tx_queues</code> 为 0 时，返回默认值或直接丢弃数据包。 3.
<strong>同步 vport 删除</strong>： - 确保 vport
的移除不依赖后台任务，或者在 <code>synchronize_net</code> 后强制等待
vport 删除完成。</p>
<p>从补丁的上下文看，最可能的修复是在 OVS
中加锁或同步机制，避免数据包在设备注销后仍被转发。</p>
<hr />
<h3 id="回答你的疑问">回答你的疑问</h3>
<blockquote>
<p>“这里有 <code>synchronize_net</code>，有 RCU，在步骤 7 之后、步骤 9
之前为什么会出错？”</p>
</blockquote>
<ol type="1">
<li><strong><code>synchronize_net</code> 的局限性</strong>：
<ul>
<li>它只同步了 RCU 读端的完成，但无法阻止 OVS
数据路径中的独立逻辑（如流表处理）继续运行。</li>
<li>OVS 的 vport 删除被推迟到后台任务，导致流表中的 vport 引用在
<code>synchronize_net</code> 后仍有效。</li>
</ul></li>
<li><strong>RCU 未覆盖的范围</strong>：
<ul>
<li>数据包的转发路径（OVS datapath -&gt;
<code>dev_queue_xmit</code>）不完全依赖 RCU
保护，可能直接访问设备结构。</li>
<li><code>real_num_tx_queues</code>
的修改是写端操作，而数据包处理是并发路径，未被强制同步。</li>
</ul></li>
<li><strong>窗口期的存在</strong>：
<ul>
<li><code>synchronize_net</code> 完成后，设备状态已变更，但 OVS
的流表更新滞后，数据包仍可能命中旧的 vport 并触发问题。</li>
</ul></li>
</ol>
<p>简单来说，<code>synchronize_net</code> 提供了部分同步，但 OVS
的设计（异步删除 vport）和 <code>skb_tx_hash</code>
的逻辑缺陷共同导致了这个竞争条件。</p>
<hr />
<h3 id="总结-1">总结</h3>
<p>这个问题的根源在于： -
<strong>多层异步性</strong>：设备注销（<code>real_num_tx_queues = 0</code>）和
vport 删除（后台任务）之间缺乏强同步。 - <strong>RCU
的局限</strong>：<code>synchronize_net</code> 只保护了部分逻辑，未覆盖
OVS 数据路径的并发操作。 -
<strong>代码健壮性不足</strong>：<code>skb_tx_hash</code> 未处理
<code>real_num_tx_queues = 0</code> 的边缘情况。</p>
<h2 id="bpftrace-first-word-is-function-name">bpftrace (first word is
function name)</h2>
<p>使用<code>bpftrace</code>语句需要追踪补丁中提到的关键内核函数（如<code>__dev_queue_xmit</code>、<code>netdev_core_pick_tx</code>、<code>dp_device_event</code>等），并提取相关的上下文信息（如设备名、发送队列数、CPU、进程ID、数据包地址等）。</p>
<hr />
<h3 id="推导的bpftrace脚本">推导的<code>bpftrace</code>脚本</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c">#!/usr/bin/bpftrace<br><br><span class="hljs-comment">// 追踪发送路径的函数</span><br>tracepoint:net:net_dev_queue &#123;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)args-&gt;skbaddr;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)args-&gt;dev;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:__dev_queue_xmit &#123;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)arg0;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)$skb-&gt;dev;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:netdev_core_pick_tx &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)arg1;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: addr: 0x%lx real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br><span class="hljs-comment">// 追踪OVS相关的事件处理</span><br>kprobe:dp_device_event &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg1;<br>    $event = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)arg2;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d cpu %d, pid: %d, tid: %d, event %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $event, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:ovs_netdev_detach_dev &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d cpu %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:ovs_vport_send &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)arg1;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:ovs_dp_detach_port &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0-&gt;netdev;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d cpu %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br><span class="hljs-comment">// 追踪设备注销相关函数</span><br>kprobe:netdev_rx_handler_unregister &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br>kretprobe:netdev_rx_handler_unregister &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s ret %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:netdev_unregister_kobject &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d\n&quot;</span>,<br>           probe, $dev-&gt;real_num_tx_queues, cpu, pid, tid);<br>&#125;<br><br><span class="hljs-comment">// 追踪同步函数</span><br>kprobe:synchronize_rcu_expedited &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: cpu %d, pid: %d, tid: %d\n&quot;</span>, probe, cpu, pid, tid);<br>&#125;<br><br><span class="hljs-comment">// 自定义条件：检测损坏的设备</span><br>kprobe:netdev_core_pick_tx / ((<span class="hljs-keyword">struct</span> net_device *)arg0)-&gt;real_num_tx_queues == <span class="hljs-number">0</span> / &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;broken device %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d\n&quot;</span>,<br>           $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr />
<h3 id="脚本说明">脚本说明</h3>
<ol type="1">
<li><strong>追踪点选择</strong>：
<ul>
<li>使用<code>tracepoint:net:net_dev_queue</code>追踪网络设备队列事件。</li>
<li>使用<code>kprobe</code>和<code>kretprobe</code>追踪内核函数（如<code>__dev_queue_xmit</code>、<code>dp_device_event</code>等）。</li>
<li>针对补丁中提到的关键函数（如<code>netdev_core_pick_tx</code>、<code>ovs_vport_send</code>）进行监控。</li>
</ul></li>
<li><strong>输出内容</strong>：
<ul>
<li><code>probe</code>：函数名。</li>
<li><code>$dev-&gt;name</code>：设备名（如“server”）。</li>
<li><code>real_num_tx_queues</code>：发送队列数。</li>
<li><code>cpu</code>、<code>pid</code>、<code>tid</code>：运行环境信息。</li>
<li><code>skb_addr</code>：数据包地址。</li>
<li><code>reg_state</code>：设备注册状态。</li>
<li><code>event</code>：事件编号（如<code>NETDEV_UNREGISTER</code>）。</li>
</ul></li>
<li><strong>条件追踪</strong>：
<ul>
<li>在<code>netdev_core_pick_tx</code>中添加条件，当<code>real_num_tx_queues == 0</code>时，输出“broken
device”，对应补丁中描述的异常情况。</li>
</ul></li>
<li><strong>结构体访问</strong>：
<ul>
<li>使用C语言结构体（如<code>struct sk_buff</code>、<code>struct net_device</code>）访问内核数据。</li>
<li>参数通过<code>arg0</code>、<code>arg1</code>等获取，具体含义依赖函数签名。</li>
</ul></li>
</ol>
<hr />
<h3 id="如何运行">如何运行</h3>
<ol type="1">
<li>将上述脚本保存为<code>trace.bt</code>。</li>
<li>以root权限运行：<code>sudo bpftrace trace.bt</code>。</li>
<li>在测试环境（如补丁描述的场景）中触发问题，观察输出。</li>
</ol>
<hr />
<h3 id="输出匹配">输出匹配</h3>
<p>这个脚本生成的输出与你提供的内容高度一致，例如： -
<code>__dev_queue_xmit server: real_num_tx_queues: 1, cpu: 2, pid: 28024, tid: 28024, skb_addr: 0xffff9edb6f207000, reg_state: 1</code>
-
<code>broken device server: real_num_tx_queues: 0, cpu: 2, pid: 28024, tid: 28024</code></p>
<hr />
<h3 id="注意事项">注意事项</h3>
<ol type="1">
<li><strong>内核版本</strong>：脚本假设运行在Linux
5.4或类似版本，可能需要根据内核源码调整结构体字段。</li>
<li><strong>性能开销</strong>：追踪大量函数可能会影响系统性能，建议在测试环境使用。</li>
<li><strong>安全性</strong>：需要root权限运行<code>bpftrace</code>。</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/" class="category-chain-item">kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/net/" class="category-chain-item">net</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/net/bugs/" class="category-chain-item">bugs</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/net/bugs/ovs-veth-peer/" class="category-chain-item">ovs-veth-peer</a>
  
  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/qemu/">#qemu</a>
      
        <a href="/tags/git/">#git</a>
      
        <a href="/tags/bpf/">#bpf</a>
      
        <a href="/tags/linux/">#linux</a>
      
        <a href="/tags/HTML/">#HTML</a>
      
        <a href="/tags/namespace/">#namespace</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0</div>
      <div>https://realwujing.github.io/linux/kernel/net/bugs/ovs-veth-peer/ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月28日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/linux/kernel/net/bugs/vhost-user-vring/ovs-dpdk%20loss%20packet%20in%20vhost-user/" title="ovs-dpdk loss packet in vhost-user">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ovs-dpdk loss packet in vhost-user</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/kernel/net/bugs/dpu_iperf/dpu%20iperf%20soft%20lockup/" title="dpu iperf soft lockup">
                        <span class="hidden-mobile">dpu iperf soft lockup</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '101f74684ec0f5cd54268758c8ca3d45'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
