

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="3d, Linux-0.11-yuan-xy, ThreadPool, acpi, algorithm, architect, assembly, baohua, binary-analysis, books, boot, bpf, bugs, cmake-objdump, console, container, cpp, dbus, deb, debug, deepin, develop, disk, distro, docker, drivers, extern, fluid, fs, gdb, git, go, gpu, grtrace, grub, hello_world, hexo, irq, java, javascript, jenkins, k8s, kdump, kernel, kickstart, kms, kvm, linux, linux-0.11-debug, log, ltp, markdown, minifs, mm, modules, monitoring, mutex, my-project, net, nginx, patent, perf, perf-event, performance, phytium, pkg, power, proc, protobuf, protobuf_example, proxy, pthread, pulseaudio, python, qemu, qprocess_wget, qt-learning, rcu, redis, rpm-ostree, runoob-vue3-test, security, shell, sound, sources, stanford-cs336, stap, struct, svn, sync, sysrq_trigger, task, testing, thread, tick, todolist, tools, udl, unixbench, uts_namespace, valgrind, vim, virsh, virt, xisai">
  
    <meta name="description" content="rcu hard lockup问题信息 故障时间：2025-05-11-23:11:38 故障节点：内蒙古呼和浩特IT上云1 10.141.181.26 故障现象：PANIC: “Kernel panic - not syncing: Hard LOCKUP” 操作系统：4.19.90-2102.2.0.0062.ctl2.aarch64 cpu: Kunpeng-920  问题分析vmcore-">
<meta property="og:type" content="article">
<meta property="og:title" content="rcu hard lockup">
<meta property="og:url" content="https://realwujing.github.io/linux/kernel/mutex/rcu/bugs/rcu_process_callbacks/rcu%20hard%20lockup/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="rcu hard lockup问题信息 故障时间：2025-05-11-23:11:38 故障节点：内蒙古呼和浩特IT上云1 10.141.181.26 故障现象：PANIC: “Kernel panic - not syncing: Hard LOCKUP” 操作系统：4.19.90-2102.2.0.0062.ctl2.aarch64 cpu: Kunpeng-920  问题分析vmcore-">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-06-01T17:06:52.000Z">
<meta property="article:modified_time" content="2025-06-17T19:26:08.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="3d">
<meta property="article:tag" content="deb">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="fs">
<meta property="article:tag" content="kdump">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="log">
<meta property="article:tag" content="perf">
<meta property="article:tag" content="task">
<meta property="article:tag" content="vim">
<meta property="article:tag" content="mm">
<meta property="article:tag" content="net">
<meta property="article:tag" content="struct">
<meta property="article:tag" content="mutex">
<meta property="article:tag" content="thread">
<meta property="article:tag" content="proc">
<meta property="article:tag" content="modules">
<meta property="article:tag" content="proxy">
<meta property="article:tag" content="sync">
<meta property="article:tag" content="rcu">
<meta property="article:tag" content="power">
<meta property="article:tag" content="container">
<meta property="article:tag" content="irq">
<meta property="article:tag" content="tick">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>rcu hard lockup - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="rcu hard lockup"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-06-01 17:06" pubdate>
          2025年6月1日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          50k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          413 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">rcu hard lockup</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2025年6月17日 晚上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="rcu-hard-lockup"><a href="#rcu-hard-lockup" class="headerlink" title="rcu hard lockup"></a>rcu hard lockup</h1><h2 id="问题信息"><a href="#问题信息" class="headerlink" title="问题信息"></a>问题信息</h2><ol>
<li>故障时间：2025-05-11-23:11:38</li>
<li>故障节点：内蒙古呼和浩特IT上云1 10.141.181.26</li>
<li>故障现象：PANIC: “Kernel panic - not syncing: Hard LOCKUP”</li>
<li>操作系统：4.19.90-2102.2.0.0062.ctl2.aarch64</li>
<li>cpu: Kunpeng-920</li>
</ol>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><h3 id="vmcore-dmesg-txt"><a href="#vmcore-dmesg-txt" class="headerlink" title="vmcore-dmesg.txt"></a>vmcore-dmesg.txt</h3><h4 id="Kernel-panic-not-syncing-Hard-LOCKUP"><a href="#Kernel-panic-not-syncing-Hard-LOCKUP" class="headerlink" title="Kernel panic - not syncing: Hard LOCKUP"></a>Kernel panic - not syncing: Hard LOCKUP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash">1762 [  929.239675] NMI watchdog: Watchdog detected hard LOCKUP on cpu 11<br>1763 [  929.239675] Modules linked <span class="hljs-keyword">in</span>: tcp_diag inet_diag binfmt_misc bonding ipt_REJECT nf_reject_ipv4 iptable_filter rfkill ip6t_REJECT nf_reject_ipv6 xt_state xt_conntrack nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 ip6table_fi     lter ip6_tables hns_roce_hw_v2 hns_roce ib_core sunrpc vfat fat ext4 mbcache jbd2 hclge aes_ce_blk crypto_simd cryptd ses aes_ce_cipher enclosure ghash_ce sha2_ce sha256_arm64 sha1_ce ofpart hisi_sas_v3_hw sbsa_gwdt hns3 cmd     linepart hisi_sas_main ipmi_ssif sg libsas hi_sfc hnae3 ipmi_devintf scsi_transport_sas nfit i2c_designware_platform mtd ipmi_msghandler i2c_designware_core libnvdimm spi_dw_mmio sch_fq_codel ip_tables xfs libcrc32c dm_multi     path sd_mod mlx5_core(OE) mlxfw(OE) tls strparser psample mlxdevm(OE) auxiliary(OE) ahci libahci libata megaraid_sas(OE) mlx_compat(OE) devlink<br>1764 [  929.239691]  dm_mirror dm_region_hash dm_log dm_mod<br>1765 [  929.239693] CPU: 11 PID: 0 Comm: swapper/11 Kdump: loaded Tainted: G           OE     4.19.90-2102.2.0.0062.ctl2.aarch64 <span class="hljs-comment">#1</span><br>1766 [  929.239693] Hardware name: RCSIT TG225 B1/BC82AMDQ, BIOS 5.25 09/14/2022<br>1767 [  929.239693] pstate: 80400089 (Nzcv daIf +PAN -UAO)<br>1768 [  929.239694] pc : queued_spin_lock_slowpath+0x1d8/0x320<br>1769 [  929.239694] lr : rcu_process_callbacks+0x544/0x5c0<br>1770 [  929.239694] sp : ffff00000816fe00<br>1771 [  929.239695] x29: ffff00000816fe00 x28: ffff3eb87f209280<br>1772 [  929.239695] x27: 000080ad00d40000 x26: ffff3eb87f1d5000<br>1773 [  929.239696] x25: ffffbf657fbfe280 x24: ffff3eb87f1d3000<br>1774 [  929.239697] x23: ffff3eb87eea0000 x22: ffff3eb87f1fe000<br>1775 [  929.239698] x21: ffff3eb87eebe280 x20: 0000000000380101<br>1776 [  929.239698] x19: ffff3eb87f209280 x18: ffff3eb87f1d1000<br>1777 [  929.239699] x17: 0000000000000000 x16: 0000000000000000<br>1778 [  929.239700] x15: 0000000000000001 x14: 0000000000000000<br>1779 [  929.239701] x13: 0000000000000004 x12: 0000000000000000<br>1780 [  929.239701] x11: ffff3eb87e9ee348 x10: 0000000000000000<br>1781 [  929.239702] x9 : 0000000000000000 x8 : 0000000000000000<br>1782 [  929.239703] x7 : ffff3eb87f1d37c8 x6 : ffffbf657fbfe240<br>1783 [  929.239704] x5 : 0000000000000000 x4 : ffffbf657fbfe240<br>1784 [  929.239704] x3 : ffff3eb87eebe000 x2 : 0000000000300000<br>1785 [  929.239705] x1 : 0000000000000000 x0 : ffffbf657fbfe248<br>1786 [  929.239706] Call trace:<br>1787 [  929.239706]  queued_spin_lock_slowpath+0x1d8/0x320<br>1788 [  929.239706]  rcu_process_callbacks+0x544/0x5c0<br>1789 [  929.239707]  __do_softirq+0x11c/0x33c<br>1790 [  929.239707]  irq_exit+0x11c/0x128<br>1791 [  929.239708]  __handle_domain_irq+0x6c/0xc0<br>1792 [  929.239708]  gic_handle_irq+0x6c/0x170<br>1793 [  929.239708]  el1_irq+0xb8/0x140<br>1794 [  929.239709]  arch_cpu_idle+0x38/0x1d0<br>1795 [  929.239709]  default_idle_call+0x24/0x58<br>1796 [  929.239709]  do_idle+0x1d4/0x2b0<br>1797 [  929.239710]  cpu_startup_entry+0x28/0x78<br>1798 [  929.239710]  secondary_start_kernel+0x17c/0x1c8<br>1799 [  929.239711] Kernel panic - not syncing: Hard LOCKUP<br>1800 [  929.239711] CPU: 11 PID: 0 Comm: swapper/11 Kdump: loaded Tainted: G           OE     4.19.90-2102.2.0.0062.ctl2.aarch64 <span class="hljs-comment">#1</span><br>1801 [  929.239712] Hardware name: RCSIT TG225 B1/BC82AMDQ, BIOS 5.25 09/14/2022<br>1802 [  929.239712] Call trace:<br>1803 [  929.239712]  dump_backtrace+0x0/0x198<br>1804 [  929.239713]  show_stack+0x24/0x30<br>1805 [  929.239713]  dump_stack+0xa4/0xe8<br>1806 [  929.239713]  panic+0x130/0x318<br>1807 [  929.239713]  __stack_chk_fail+0x0/0x28<br>1808 [  929.239714]  watchdog_hardlockup_check+0x138/0x158<br>1809 [  929.239714]  sdei_watchdog_callback+0x64/0x98<br>1810 [  929.239715]  sdei_event_handler+0x50/0xf0<br>1811 [  929.239715]  __sdei_handler+0xe0/0x240<br>1812 [  929.239715]  __sdei_asm_handler+0xbc/0x154<br>1813 [  929.239716]  queued_spin_lock_slowpath+0x1d8/0x320<br>1814 [  929.239716]  rcu_process_callbacks+0x544/0x5c0<br>1815 [  929.239716]  __do_softirq+0x11c/0x33c<br>1816 [  929.239717]  irq_exit+0x11c/0x128<br>1817 [  929.239717]  __handle_domain_irq+0x6c/0xc0<br>1818 [  929.239717]  gic_handle_irq+0x6c/0x170<br>1819 [  929.239718]  el1_irq+0xb8/0x140<br>1820 [  929.239718]  arch_cpu_idle+0x38/0x1d0<br>1821 [  929.239718]  default_idle_call+0x24/0x58<br>1822 [  929.239719]  do_idle+0x1d4/0x2b0<br>1823 [  929.239719]  cpu_startup_entry+0x28/0x78<br>1824 [  929.239719]  secondary_start_kernel+0x17c/0x1c8<br></code></pre></td></tr></table></figure>

<h4 id="NMI-watchdog"><a href="#NMI-watchdog" class="headerlink" title="NMI watchdog"></a>NMI watchdog</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@obs-arm-worker-01 127.0.0.1-2025-05-11-23:11:38]<span class="hljs-comment"># grep &#x27;NMI watchdog:&#x27; -inr vmcore-dmesg.txt --color</span><br>1208:[    9.230149] SDEI NMI watchdog: SDEI Watchdog registered successfully<br>1688:[  929.239598] NMI watchdog: Watchdog detected hard LOCKUP on cpu 5<br>1725:[  929.239638] NMI watchdog: Watchdog detected hard LOCKUP on cpu 9<br>1762:[  929.239675] NMI watchdog: Watchdog detected hard LOCKUP on cpu 11<br>1825:[  929.239720] NMI watchdog: Watchdog detected hard LOCKUP on cpu 13<br>1915:[  936.855640] NMI watchdog: Watchdog detected hard LOCKUP on cpu 60<br>1946:[  949.303293] NMI watchdog: Watchdog detected hard LOCKUP on cpu 2<br>1983:[  949.303334] NMI watchdog: Watchdog detected hard LOCKUP on cpu 6<br>2020:[  949.303374] NMI watchdog: Watchdog detected hard LOCKUP on cpu 7<br>2057:[  949.303413] NMI watchdog: Watchdog detected hard LOCKUP on cpu 12<br>2094:[  949.303456] NMI watchdog: Watchdog detected hard LOCKUP on cpu 23<br></code></pre></td></tr></table></figure>

<p>首先发生在5号CPU的NMI watchdog，5号cpu的x19: ffff3eb87f209280，和11号CPU的x19是一样的。</p>
<h4 id="RCU-Stall-日志中-idle-XXX-0-0x1-标志位解析"><a href="#RCU-Stall-日志中-idle-XXX-0-0x1-标志位解析" class="headerlink" title="RCU Stall 日志中 idle=XXX/0/0x1 标志位解析"></a>RCU Stall 日志中 <code>idle=XXX/0/0x1</code> 标志位解析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;idle=&#x27;</span> . -inr --include=<span class="hljs-string">&quot;vmcore-dmesg.txt&quot;</span><br><br>./127.0.0.1-2025-05-11-23:11:38/vmcore-dmesg.txt:1585:[  916.158850] rcu:       44-...!: (1 ticks this GP) idle=4ca/0/0x1 softirq=1046/1046 fqs=0 <br>./127.0.0.1-2025-05-11-18:26:08/vmcore-dmesg.txt:1584:[887136.218705] rcu:      5-...!: (1 GPs behind) idle=e32/0/0x1 softirq=2547154/2547154 fqs=1 <br>./127.0.0.1-2025-05-11-18:26:08/vmcore-dmesg.txt:1645:[1622263.640745] rcu:     47-...!: (1 ticks this GP) idle=a36/0/0x1 softirq=2425136/2425136 fqs=0 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:1585:[ 3885.234398] rcu:       29-...!: (6 GPs behind) idle=a6a/0/0x1 softirq=11528/11528 fqs=1 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:1617:[15488.588605] rcu:       58-...!: (3 GPs behind) idle=e52/0/0x1 softirq=72598/72598 fqs=1 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:1736:[49506.456605] rcu:       53-...!: (1 ticks this GP) idle=70e/0/0x1 softirq=164776/164776 fqs=0 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:2475:[190935.928694] rcu:      35-...!: (1 ticks this GP) idle=576/0/0x1 softirq=680003/680003 fqs=0 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:3132:[223980.504804] rcu:      47-...!: (2 ticks this GP) idle=d5e/0/0x1 softirq=893065/893066 fqs=1 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:3164:[230566.588728] rcu:      18-...!: (1 GPs behind) idle=9e6/1/0x4000000000000002 softirq=730680/730682 fqs=1 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:3308:[320459.544436] rcu:      55-...!: (1 ticks this GP) idle=39e/0/0x1 softirq=1181112/1181112 fqs=1 <br>./127.0.0.1-2025-05-26-02:29:07/vmcore-dmesg.txt:3340:[601083.460709] rcu:      59-...!: (1 ticks this GP) idle=436/0/0x1 softirq=5886999/5886999 fqs=0<br></code></pre></td></tr></table></figure>

<p>idle陷入深度睡眠后未能被唤醒，无法响应时钟中断，进而引发 RCU Stall、调度停滞等问题？</p>
<h5 id="定时器停止的底层原理"><a href="#定时器停止的底层原理" class="headerlink" title="定时器停止的底层原理"></a>定时器停止的底层原理</h5><h6 id="1-硬件行为"><a href="#1-硬件行为" class="headerlink" title="1. 硬件行为"></a>1. 硬件行为</h6><ul>
<li><p><strong>时钟源停摆</strong>：</p>
<ul>
<li>在深度 idle 状态（如 ARM 的 WFI 或 x86 的 C3）下，为节省功耗，CPU 可能关闭本地时钟（如 <code>arch_timer</code> 或 TSC）。</li>
<li>本地定时器中断（如 <code>tick_sched_timer</code>）不再触发。</li>
<li><code>jiffies</code> 停止更新（依赖时钟中断递增）。</li>
</ul>
</li>
<li><p><strong>唤醒依赖</strong>：</p>
<ul>
<li>需依赖外部中断唤醒 CPU，包括：<ul>
<li>处理器间中断（IPI）：其他 CPU 通过 <code>smp_call_function()</code> 发送。</li>
<li>设备中断：如网卡、磁盘等外设触发的中断。</li>
<li>全局时钟中断：部分架构的全局定时器（如 ARM sp804）可能仍运行。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6 id="2-软件配置"><a href="#2-软件配置" class="headerlink" title="2. 软件配置"></a>2. 软件配置</h6><ul>
<li><p><strong>内核控制</strong>：</p>
<ul>
<li>通过 <code>cpuidle</code> 驱动决定是否允许定时器停止：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpuidle_state</span> <span class="hljs-title">states</span>[] =</span> &#123;<br>    &#123;<br>        .name = <span class="hljs-string">&quot;C2&quot;</span>,<br>        .flags = CPUIDLE_FLAG_TIMER_STOP, <span class="hljs-comment">// 关键标志位</span><br>        .enter = arm_cpuidle_enter,<br>    &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>唤醒路径</strong>：</p>
<ul>
<li>若定时器停止，内核需确保至少一个唤醒源有效：<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">外部中断 → GIC/APIC → <span class="hljs-meta">CPU</span> 退出 idle → 恢复定时器 → 处理中断<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h5 id="唤醒失败的常见原因"><a href="#唤醒失败的常见原因" class="headerlink" title="唤醒失败的常见原因"></a>唤醒失败的常见原因</h5><h6 id="1-中断控制器故障"><a href="#1-中断控制器故障" class="headerlink" title="1. 中断控制器故障"></a>1. 中断控制器故障</h6><table>
<thead>
<tr>
<th>问题</th>
<th>检测方法</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>GIC 未路由中断</td>
<td><code>cat /proc/interrupts</code> 查看目标 CPU 的中断计数是否增长</td>
<td>调整 <code>smp_affinity</code> 绑定中断</td>
</tr>
<tr>
<td>APIC 配置错误</td>
<td>&#96;dmesg</td>
<td>grep -i “apic\ irq”&#96; 检查日志错误</td>
</tr>
<tr>
<td>中断优先级过低</td>
<td>检查 GIC 的 <code>GICD_IPRIORITYRn</code> 寄存器（需 JTAG）</td>
<td>提高中断优先级</td>
</tr>
</tbody></table>
<h6 id="2-电源管理缺陷"><a href="#2-电源管理缺陷" class="headerlink" title="2. 电源管理缺陷"></a>2. 电源管理缺陷</h6><table>
<thead>
<tr>
<th>问题</th>
<th>检测方法</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>PSCI 调用失败</td>
<td>&#96;dmesg</td>
<td>grep -i “psci”&#96; 查看 CPU_ON&#x2F;CPU_OFF 错误</td>
</tr>
<tr>
<td>SoC 时钟未恢复</td>
<td>读取 SoC 寄存器（如 <code>CNTCTLBase.CNTCR</code>）确认时钟使能</td>
<td>联系厂商提供固件补丁</td>
</tr>
<tr>
<td>电压域未退出</td>
<td>检查 PMIC 寄存器（需厂商工具）</td>
<td>调整电源管理配置</td>
</tr>
</tbody></table>
<h6 id="3-内核配置问题"><a href="#3-内核配置问题" class="headerlink" title="3. 内核配置问题"></a>3. 内核配置问题</h6><table>
<thead>
<tr>
<th>问题</th>
<th>检测方法</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>NO_HZ 配置冲突</td>
<td><code>cat /sys/kernel/debug/tracing/events/timer/timer_stop/enable</code> 追踪停钟事件</td>
<td>禁用 <code>CONFIG_NO_HZ_FULL</code></td>
</tr>
<tr>
<td>cpuidle 驱动缺陷</td>
<td><code>perf probe -L arm_cpuidle_enter</code> 检查驱动逻辑</td>
<td>升级或回退内核版本</td>
</tr>
<tr>
<td>RCU 回调阻塞</td>
<td><code>ftrace</code> 追踪 <code>rcu_core</code> 和 <code>irq_enter</code> 的延迟</td>
<td>修复长时间关中断的代码</td>
</tr>
</tbody></table>
<h5 id="诊断工具与方法"><a href="#诊断工具与方法" class="headerlink" title="诊断工具与方法"></a>诊断工具与方法</h5><h6 id="1-硬件层诊断"><a href="#1-硬件层诊断" class="headerlink" title="1. 硬件层诊断"></a>1. 硬件层诊断</h6><ul>
<li><p><strong>检查 ARM 定时器状态（需 root）</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">devmem2 0x&lt;CNTCTLBase.CNTCR&gt;  <span class="hljs-comment"># 读时钟控制寄存器</span><br>devmem2 0x&lt;GICD_ISENABLER&gt;    <span class="hljs-comment"># 读中断使能状态</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 JTAG 调试器验证 CPU 唤醒信号</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">openocd -f &lt;soc_config.cfg&gt; -c <span class="hljs-string">&quot;halt&quot;</span> -c <span class="hljs-string">&quot;reg cpsr&quot;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="2-内核层诊断"><a href="#2-内核层诊断" class="headerlink" title="2. 内核层诊断"></a>2. 内核层诊断</h6><ul>
<li><p><strong>监控 idle 状态切换</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/power/cpu_idle/enable<br><span class="hljs-built_in">cat</span> /sys/kernel/debug/tracing/trace_pipe<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>追踪中断唤醒路径</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">perf probe -a <span class="hljs-string">&#x27;gic_handle_irq&#x27;</span> -a <span class="hljs-string">&#x27;arch_cpu_idle_enter&#x27;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="3-日志分析重点"><a href="#3-日志分析重点" class="headerlink" title="3. 日志分析重点"></a>3. 日志分析重点</h6><ul>
<li><p><strong>关键错误</strong>：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">arch_timer:</span> IRQ <span class="hljs-number">30</span> missed      <span class="hljs-meta"># 时钟中断丢失</span><br><span class="hljs-symbol">PSCI:</span> CPU29 on failed (<span class="hljs-number">-5</span>)     <span class="hljs-meta"># 电源管理调用失败</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>唤醒成功日志</strong>：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">cpu_idle: <span class="hljs-keyword">state</span>=<span class="hljs-number">2</span> -&gt; <span class="hljs-keyword">state</span>=<span class="hljs-number">0</span>    <span class="hljs-comment"># 退出深度 idle</span><br>irq_enter: irq=<span class="hljs-number">30</span>              <span class="hljs-comment"># 中断处理开始</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h5 id="解决方案总结"><a href="#解决方案总结" class="headerlink" title="解决方案总结"></a>解决方案总结</h5><h6 id="临时措施"><a href="#临时措施" class="headerlink" title="临时措施"></a>临时措施</h6><ul>
<li><p><strong>强制禁用深度 idle（所有 CPU）</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> cpu <span class="hljs-keyword">in</span> /sys/devices/system/cpu/cpu*/cpuidle/state[2-9]; <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">echo</span> 1 &gt; <span class="hljs-variable">$cpu</span>/disable<br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>关闭动态 tick</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/timer/timer_stop/enable<br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="长期修复"><a href="#长期修复" class="headerlink" title="长期修复"></a>长期修复</h6><ul>
<li><p><strong>硬件</strong>：更新微码&#x2F;BIOS，修复时钟和中断控制器缺陷。</p>
</li>
<li><p><strong>内核</strong>：升级到修复版本（如 Linux 5.10+ 的 ARM idle 驱动补丁）。</p>
</li>
<li><p><strong>配置</strong>：调整内核启动参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">idle=poll                   <span class="hljs-comment"># 完全禁用 idle</span><br>clocksource=arch_sys_counter <span class="hljs-comment"># 强制使用可靠时钟源</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h6 id="厂商协作"><a href="#厂商协作" class="headerlink" title="厂商协作"></a>厂商协作</h6><ul>
<li><strong>华为”..鹏</strong>：提交 <code>hisi_cpufreq</code> 驱动日志给厂商。</li>
<li><strong>Intel</strong>：收集 <code>pmc_core</code> 和 <code>intel_idle</code> 模块日志。</li>
</ul>
<h5 id="深度-idle-唤醒流程图解"><a href="#深度-idle-唤醒流程图解" class="headerlink" title="深度 idle 唤醒流程图解"></a>深度 idle 唤醒流程图解</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">+-------------------+     +-------------------+     +-------------------+<br>| 进入深度 idle     |     | 定时器停止         |     | 等待外部中断       |<br>| (WFI/C3)         | --&gt; | (CPUIDLE_FLAG_     | --&gt; | (IPI/设备中断)     |<br>|                  |     | TIMER_STOP)        |     |                   |<br>+-------------------+     +-------------------+     +-------------------+<br>                                                    |<br>+-------------------+     +-------------------+     +-------------------+<br>| 中断控制器接收     | --&gt; | CPU 退出 idle     | --&gt; | 恢复定时器并       |<br>| (GIC/APIC)        |     | (PSCI_CPU_ON)      |     | 处理中断           |<br>+-------------------+     +-------------------+     +-------------------+<br></code></pre></td></tr></table></figure>

<h3 id="crash"><a href="#crash" class="headerlink" title="crash"></a>crash</h3><h4 id="queued-spin-lock-slowpath-0x1d8"><a href="#queued-spin-lock-slowpath-0x1d8" class="headerlink" title="queued_spin_lock_slowpath+0x1d8"></a>queued_spin_lock_slowpath+0x1d8</h4><p><code>pc : queued_spin_lock_slowpath+0x1d8/0x320</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -sx queued_spin_lock_slowpath+0x1d8<br>FILE: kernel/locking/qspinlock.c<br>LINE: 507<br><br>dis: queued_spin_lock_slowpath+0x1d8: <span class="hljs-built_in">source</span> code is not available<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -flx rcu_process_callbacks | grep -i 0x544 -C10<br>0xffff3eb87e0a8d4c &lt;rcu_process_callbacks+0x524&gt;:       nop<br>/usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/rcu/tree_plugin.h: 1381<br>0xffff3eb87e0a8d50 &lt;rcu_process_callbacks+0x528&gt;:       brk     <span class="hljs-comment">#0x800</span><br>0xffff3eb87e0a8d54 &lt;rcu_process_callbacks+0x52c&gt;:       b       0xffff3eb87e0a88e8<br>/usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/./include/asm-generic/qspinlock.h: 88<br>0xffff3eb87e0a8d58 &lt;rcu_process_callbacks+0x530&gt;:       mov     w1, w0<br>0xffff3eb87e0a8d5c &lt;rcu_process_callbacks+0x534&gt;:       str     x4, [x29,<span class="hljs-comment">#112]</span><br>0xffff3eb87e0a8d60 &lt;rcu_process_callbacks+0x538&gt;:       mov     x0, x6<br>0xffff3eb87e0a8d64 &lt;rcu_process_callbacks+0x53c&gt;:       str     x6, [x29,<span class="hljs-comment">#128]</span><br>0xffff3eb87e0a8d68 &lt;rcu_process_callbacks+0x540&gt;:       bl      0xffff3eb87e07e558<br>0xffff3eb87e0a8d6c &lt;rcu_process_callbacks+0x544&gt;:       ldr     x4, [x29,<span class="hljs-comment">#112]</span><br>0xffff3eb87e0a8d70 &lt;rcu_process_callbacks+0x548&gt;:       ldr     x6, [x29,<span class="hljs-comment">#128]</span><br>0xffff3eb87e0a8d74 &lt;rcu_process_callbacks+0x54c&gt;:       b       0xffff3eb87e0a8c64<br>/usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/rcu/tree.c: 2621<br>0xffff3eb87e0a8d78 &lt;rcu_process_callbacks+0x550&gt;:       brk     <span class="hljs-comment">#0x800</span><br>0xffff3eb87e0a8d7c &lt;rcu_process_callbacks+0x554&gt;:       b       0xffff3eb87e0a8b0c<br>/usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/rcu/tree.c: 2572<br>0xffff3eb87e0a8d80 &lt;rcu_process_callbacks+0x558&gt;:       brk     <span class="hljs-comment">#0x800</span><br>0xffff3eb87e0a8d84 &lt;rcu_process_callbacks+0x55c&gt;:       b       0xffff3eb87e0a8a2c<br>/usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/rcu/tree.c: 2415<br>0xffff3eb87e0a8d88 &lt;rcu_process_callbacks+0x560&gt;:       strb    wzr, [x25,<span class="hljs-comment">#26]</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; sym 0xffff3eb87e0a8c64<br>ffff3eb87e0a8c64 (t) rcu_process_callbacks+1084 /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/rcu/tree.c: 2397<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree.c +2397</span><br><br><span class="hljs-number">2387</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-number">2388</span> rcu_report_qs_rdp(<span class="hljs-type">int</span> cpu, <span class="hljs-keyword">struct</span> rcu_state *rsp, <span class="hljs-keyword">struct</span> rcu_data *rdp)<br><span class="hljs-number">2389</span> &#123;<br><span class="hljs-number">2390</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-number">2391</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mask;<br><span class="hljs-number">2392</span>     <span class="hljs-type">bool</span> needwake;<br><span class="hljs-number">2393</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_node</span> *<span class="hljs-title">rnp</span>;</span><br><span class="hljs-number">2394</span><br><span class="hljs-number">2395</span>     rnp = rdp-&gt;mynode;<br><span class="hljs-number">2396</span>     raw_spin_lock_irqsave_rcu_node(rnp, flags);    <span class="hljs-comment">// queued_spin_lock_slowpath+0x1d8入口在这</span><br><span class="hljs-number">2397</span>     <span class="hljs-keyword">if</span> (rdp-&gt;cpu_no_qs.b.norm || rdp-&gt;gp_seq != rnp-&gt;gp_seq ||<br><span class="hljs-number">2398</span>     ¦   rdp-&gt;gpwrap) &#123;<br></code></pre></td></tr></table></figure>

<p>回溯一下调用链路：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree.c +2427</span><br><br><span class="hljs-number">2436</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-number">2437</span> rcu_check_quiescent_state(<span class="hljs-keyword">struct</span> rcu_state *rsp, <span class="hljs-keyword">struct</span> rcu_data *rdp)<br><span class="hljs-number">2438</span> &#123;<br><span class="hljs-number">2439</span>     <span class="hljs-comment">/* Check for grace-period ends and beginnings. */</span><br><span class="hljs-number">2440</span>     note_gp_changes(rsp, rdp);<br><span class="hljs-number">2441</span><br><span class="hljs-number">2442</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2443     ¦* Does this CPU still need to do its part for current grace period?</span><br><span class="hljs-comment">2444     ¦* If no, return and let the other CPUs do their part as well.</span><br><span class="hljs-comment">2445     ¦*/</span><br><span class="hljs-number">2446</span>     <span class="hljs-keyword">if</span> (!rdp-&gt;core_needs_qs)<br><span class="hljs-number">2447</span>         <span class="hljs-keyword">return</span>;<br><span class="hljs-number">2448</span><br><span class="hljs-number">2449</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2450     ¦* Was there a quiescent state since the beginning of the grace</span><br><span class="hljs-comment">2451     ¦* period? If no, then exit and wait for the next call.</span><br><span class="hljs-comment">2452     ¦*/</span><br><span class="hljs-number">2453</span>     <span class="hljs-keyword">if</span> (rdp-&gt;cpu_no_qs.b.norm)<br><span class="hljs-number">2454</span>         <span class="hljs-keyword">return</span>;<br><span class="hljs-number">2455</span><br><span class="hljs-number">2456</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2457     ¦* Tell RCU we are done (but rcu_report_qs_rdp() will be the</span><br><span class="hljs-comment">2458     ¦* judge of that).</span><br><span class="hljs-comment">2459     ¦*/</span><br><span class="hljs-number">2460</span>     rcu_report_qs_rdp(rdp-&gt;cpu, rsp, rdp);<br><span class="hljs-number">2461</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree.c +2839</span><br><br><span class="hljs-number">2838</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-number">2839</span> __rcu_process_callbacks(<span class="hljs-keyword">struct</span> rcu_state *rsp)<br><span class="hljs-number">2840</span> &#123;<br><span class="hljs-number">2841</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-number">2842</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_data</span> *<span class="hljs-title">rdp</span> =</span> raw_cpu_ptr(rsp-&gt;rda);<br><span class="hljs-number">2843</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_node</span> *<span class="hljs-title">rnp</span> =</span> rdp-&gt;mynode;<br><span class="hljs-number">2844</span><br><span class="hljs-number">2845</span>     WARN_ON_ONCE(!rdp-&gt;beenonline);<br><span class="hljs-number">2846</span><br><span class="hljs-number">2847</span>     <span class="hljs-comment">/* Update RCU state based on any recent quiescent states. */</span><br><span class="hljs-number">2848</span>     rcu_check_quiescent_state(rsp, rdp);<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree.c +2872</span><br><br><span class="hljs-number">2872</span> <span class="hljs-type">static</span> __latent_entropy <span class="hljs-type">void</span> <span class="hljs-title function_">rcu_process_callbacks</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> softirq_action *unused)</span><br>2873 &#123;<br><span class="hljs-number">2874</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_state</span> *<span class="hljs-title">rsp</span>;</span><br><span class="hljs-number">2875</span><br><span class="hljs-number">2876</span>     <span class="hljs-keyword">if</span> (cpu_is_offline(smp_processor_id()))<br><span class="hljs-number">2877</span>         <span class="hljs-keyword">return</span>;<br><span class="hljs-number">2878</span>     trace_rcu_utilization(TPS(<span class="hljs-string">&quot;Start RCU core&quot;</span>));<br><span class="hljs-number">2879</span>     for_each_rcu_flavor(rsp)<br><span class="hljs-number">2880</span>         __rcu_process_callbacks(rsp);<br><span class="hljs-number">2881</span>     trace_rcu_utilization(TPS(<span class="hljs-string">&quot;End RCU core&quot;</span>));<br><span class="hljs-number">2882</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">rcu_process_callbacks<br>    __rcu_process_callbacks<br>        rcu_check_quiescent_state<br>            rcu_report_qs_rdp<br>                raw_spin_lock_irqsave_rcu_node<br>                    queued_spin_lock_slowpath<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim -t raw_spin_lock_irqsave_rcu_node</span><br><span class="hljs-comment">// vim kernel/rcu/rcu.h +415</span><br><br><span class="hljs-number">415</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> raw_spin_lock_irqsave_rcu_node(p, flags)            \</span><br><span class="hljs-meta">416 do &#123;                                    \</span><br><span class="hljs-meta">417     raw_spin_lock_irqsave(&amp;ACCESS_PRIVATE(p, lock), flags); \     <span class="hljs-comment">// 访问p-&gt;lock</span></span><br><span class="hljs-number">418</span>     smp_mb__after_unlock_lock();                    \<br><span class="hljs-number">419</span> &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<p>raw_spin_lock_irqsave()、queued_spin_lock_slowpath()调用关系图：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">raw_spin_lock_irqsave()<br> └── __raw_spin_lock_irqsave()<br>      └── __raw_spin_lock()<br>           └── arch_spin_lock()<br>                └── queued_spin_lock()       <span class="hljs-comment">// fastpath</span><br>                     └── ... fallback ...<br>                          └── queued_spin_lock_slowpath() <span class="hljs-comment">// 如果 fastpath 失败</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">// vim kernel/locking/qspinlock.c +507</span><br><span class="hljs-number">354</span> <span class="hljs-type">void</span> <span class="hljs-title function_">queued_spin_lock_slowpath</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> qspinlock *lock, u32 val)</span><br>355 &#123;<br><span class="hljs-number">356</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mcs_spinlock</span> *<span class="hljs-title">prev</span>, *<span class="hljs-title">next</span>, *<span class="hljs-title">node</span>;</span><br><span class="hljs-number">357</span>     u32 old, tail;<br><span class="hljs-number">358</span>     <span class="hljs-type">int</span> idx;<br>...<br><span class="hljs-number">432</span> pv_queue:<br><span class="hljs-number">433</span>     node = this_cpu_ptr(&amp;qnodes[<span class="hljs-number">0</span>].mcs);<br>...<br><span class="hljs-number">506</span>         pv_wait_node(node, prev);<br><span class="hljs-number">507</span>         arch_mcs_spin_lock_contended(&amp;node-&gt;locked);<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -lx queued_spin_lock_slowpath | <span class="hljs-built_in">head</span> -n8<br>/usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/locking/qspinlock.c: 355<br>0xffff3eb87e07e558 &lt;queued_spin_lock_slowpath&gt;: stp     x29, x30, [sp,<span class="hljs-comment">#-32]!</span><br>0xffff3eb87e07e55c &lt;queued_spin_lock_slowpath+0x4&gt;:     mov     x29, sp<br>0xffff3eb87e07e560 &lt;queued_spin_lock_slowpath+0x8&gt;:     stp     x19, x20, [sp,<span class="hljs-comment">#16]</span><br>0xffff3eb87e07e564 &lt;queued_spin_lock_slowpath+0xc&gt;:     mov     w20, w1<br>0xffff3eb87e07e568 &lt;queued_spin_lock_slowpath+0x10&gt;:    mov     x19, x0     // x0是qspinlock地址，原始地址保存在x19<br>0xffff3eb87e07e56c &lt;queued_spin_lock_slowpath+0x14&gt;:    mov     x0, x30<br>0xffff3eb87e07e570 &lt;queued_spin_lock_slowpath+0x18&gt;:    nop<br></code></pre></td></tr></table></figure>

<p>从vmcore-dmesg.txt中可以看到发生panic的11号cpu，11号cpu的x19: ffff3eb87f209280:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; qspinlock ffff3eb87f209280<br>struct qspinlock &#123;<br>  &#123;<br>    val = &#123;<br>      counter = 6291713<br>    &#125;,<br>    &#123;<br>      locked = 1 <span class="hljs-string">&#x27;\001&#x27;</span>,    // 锁被持有<br>      pending = 1 <span class="hljs-string">&#x27;\001&#x27;</span>    // 有1位等待者<br>    &#125;,<br>    &#123;<br>      locked_pending = 257,<br>      <span class="hljs-built_in">tail</span> = 96<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct -o qspinlock<br>struct qspinlock &#123;<br>      union &#123;<br>  [0]     atomic_t val;<br>          struct &#123;<br>  [0]         u8 locked;<br>  [1]         u8 pending;<br>          &#125;;<br>          struct &#123;<br>  [0]         u16 locked_pending;<br>  [2]         u16 <span class="hljs-built_in">tail</span>;<br>          &#125;;<br>      &#125;;<br>&#125;<br>SIZE: 4<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim include/asm-generic/qspinlock_types.h +76</span><br><br> <span class="hljs-number">68</span> <span class="hljs-comment">/*</span><br><span class="hljs-comment"> 69  * Bitfields in the atomic value:</span><br><span class="hljs-comment"> 70  *</span><br><span class="hljs-comment"> 71  * When NR_CPUS &lt; 16K</span><br><span class="hljs-comment"> 72  *  0- 7: locked byte</span><br><span class="hljs-comment"> 73  *     8: pending</span><br><span class="hljs-comment"> 74  *  9-15: not used</span><br><span class="hljs-comment"> 75  * 16-17: tail index</span><br><span class="hljs-comment"> 76  * 18-31: tail cpu (+1)</span><br><span class="hljs-comment"> 77  *</span><br><span class="hljs-comment"> 78  * When NR_CPUS &gt;= 16K</span><br><span class="hljs-comment"> 79  *  0- 7: locked byte</span><br><span class="hljs-comment"> 80  *     8: pending</span><br><span class="hljs-comment"> 81  *  9-10: tail index</span><br><span class="hljs-comment"> 82  * 11-31: tail cpu (+1)</span><br><span class="hljs-comment"> 83  */</span><br></code></pre></td></tr></table></figure>

<p>根据提供的结构体定义和注释，<code>tail</code> 字段的编码方式如下（假设 <code>NR_CPUS &lt; 16K</code>，即常见场景）：</p>
<ul>
<li><code>tail</code>（16位）由高位的 CPU 编号和低位的队列索引组成：<ul>
<li><strong>高位</strong>：<code>tail cpu (+1)</code>，位于第 18-31 位（16-17 位是 tail index，18-31 位是 tail cpu+1）</li>
<li><strong>低 2 位</strong>：<code>tail index</code>，即每CPU队列节点索引</li>
<li><strong>tail &#x3D; (cpu+1) &lt;&lt; 2 | idx&#96;</strong></li>
</ul>
</li>
</ul>
<p>这里 <code>tail = 96</code>，即二进制 <code>0b00000000_01100000</code>。</p>
<hr>
<h5 id="计算过程"><a href="#计算过程" class="headerlink" title="计算过程"></a>计算过程</h5><ol>
<li><p><strong>tail &#x3D; 96 &#x3D; 0x60 &#x3D; 0b0110_0000</strong></p>
</li>
<li><p><strong>低 2 位</strong>（<code>idx</code>）：<code>tail &amp; 0x3</code><br><code>96 &amp; 0x3 = 0</code><br>所以 <code>idx = 0</code></p>
</li>
<li><p><strong>高位</strong>（<code>cpu+1</code>）：<code>tail &gt;&gt; 2</code><br><code>96 &gt;&gt; 2 = 24</code><br>所以 <code>cpu + 1 = 24</code>，即 <code>cpu = 23</code></p>
</li>
</ol>
<hr>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p><strong>等待者的 CPU 编号是 23。</strong></p>
<p><strong>只能确定23号CPU正在等待这把锁，不能确定它就是锁的持有者。</strong></p>
<ul>
<li>qspinlock 的 tail 字段（这里为 96，解码为 cpu 23）<strong>只表示当前等待队列的队尾是谁</strong>，即最后一个排队等锁的 CPU 是 23。</li>
<li><code>locked = 1</code> 说明锁被某个 CPU 持有，但 qspinlock 结构本身<strong>并不记录锁主是谁</strong>。<br> 11 号 CPU 卡在 <code>queued_spin_lock_slowpath</code>，它可能是正在尝试获取锁的等待者之一，也可能是因为死锁等原因卡住，但不能据此断定 11 号 CPU 就是锁主。</li>
<li>23 号 CPU 作为队尾，<strong>一定还没有拿到锁，只是在排队</strong>。</li>
</ul>
<hr>
<h4 id="cpu-23在干啥？"><a href="#cpu-23在干啥？" class="headerlink" title="cpu 23在干啥？"></a>cpu 23在干啥？</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -c 23<br>PID: 6214   TASK: ffffbf655d94d900  CPU: 23  COMMAND: <span class="hljs-string">&quot;kworker/23:0&quot;</span><br>bt: WARNING: cannot determine starting stack frame <span class="hljs-keyword">for</span> task ffffbf655d94d900<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vmcore-dmesg.txt</span><br><br><span class="hljs-number">2094</span> [  <span class="hljs-number">949.303456</span>] NMI watchdog: Watchdog detected hard LOCKUP on cpu <span class="hljs-number">23</span><br><span class="hljs-number">2095</span> [  <span class="hljs-number">949.303457</span>] Modules linked in: tcp_diag inet_diag binfmt_misc bonding ipt_REJECT nf_reject_ipv4 iptable_filter rfkill ip6t_REJECT nf_reject_ipv6 xt_state xt_conntrack nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 i     p6table_filter ip6_tables hns_roce_hw_v2 hns_roce ib_core sunrpc vfat fat ext4 mbcache jbd2 hclge aes_ce_blk crypto_simd cryptd ses aes_ce_cipher enclosure ghash_ce sha2_ce sha256_arm64 sha1_ce ofpart hisi_sas_v3_h     w sbsa_gwdt hns3 cmdlinepart hisi_sas_main ipmi_ssif sg libsas hi_sfc hnae3 ipmi_devintf scsi_transport_sas nfit i2c_designware_platform mtd ipmi_msghandler i2c_designware_core libnvdimm spi_dw_mmio sch_fq_codel ip     _tables xfs libcrc32c dm_multipath sd_mod <span class="hljs-title function_">mlx5_core</span><span class="hljs-params">(OE)</span> <span class="hljs-title function_">mlxfw</span><span class="hljs-params">(OE)</span> tls strparser psample <span class="hljs-title function_">mlxdevm</span><span class="hljs-params">(OE)</span> <span class="hljs-title function_">auxiliary</span><span class="hljs-params">(OE)</span> ahci libahci libata <span class="hljs-title function_">megaraid_sas</span><span class="hljs-params">(OE)</span> <span class="hljs-title function_">mlx_compat</span><span class="hljs-params">(OE)</span> devlink<br>2096 [  949.303474]  dm_mirror dm_region_hash dm_log dm_mod<br>2097 [  949.303476] CPU: 23 PID: 6214 Comm: kworker/23:0 Kdump: loaded Tainted: G        W  OE     4.19.90-2102.2.0.0062.ctl2.aarch64 #1<br>2098 [  949.303477] Hardware name: RCSIT TG225 B1/BC82AMDQ, BIOS 5.25 09/14/2022<br>2099 [  949.303477] Workqueue: rcu_gp wait_rcu_exp_gp<br>2100 [  949.303478] pstate: 80<span class="hljs-title function_">c00089</span> <span class="hljs-params">(Nzcv daIf +PAN +UAO)</span><br>2101 [  949.303478] pc : queued_spin_lock_slowpath+0x1d8/0x320<br>2102 [  949.303479] lr : sync_rcu_exp_select_cpus+0x25c/0x3a8<br>2103 [  949.303479] sp : ffff000064bcfd10<br>2104 [  949.303479] x29: ffff000064bcfd10 x28: 0000000000000000<br>2105 [  949.303480] x27: 0000000000000060 x26: ffff3eb87f1d5adc<br>2106 [  949.303481] x25: 0000000000000000 x24: 0000000000000280<br>2107 [  949.303482] x23: ffff3eb87f209000 x22: ffff3eb87e0a61c8<br>2108 [  949.303483] x21: ffff3eb87f1d5000 x20: 0000000000340101<br>2109 [  949.303484] x19: ffff3eb87f209280 x18: ffff3eb87ec30518<br>2110 [  949.303485] x17: 0000000000000000 x16: 0000000000000000<br>2111 [  949.303485] x15: 0000000000000001 x14: ffffbf657fe22408<br>2112 [  949.303486] x13: 0000000000000004 x12: 0000000000000228<br>2113 [  949.303487] x11: 0000000000000020 x10: 0000000000000b90<br>2114 [  949.303488] x9 : ffff000064bcfd40 x8 : 0000000000000000<br>2115 [  949.303489] x7 : ffff3eb87f1d37c8 x6 : ffffbf657fe3e240<br>2116 [  949.303490] x5 : 0000000000000000 x4 : ffffbf657fe3e240<br>2117 [  949.303491] x3 : ffff3eb87eebe000 x2 : 0000000000600000<br>2118 [  949.303491] x1 : 0000000000000000 x0 : ffffbf657fe3e248<br>2119 [  949.303492] Call trace:<br>2120 [  949.303493]  queued_spin_lock_slowpath+0x1d8/0x320<br>2121 [  949.303493]  sync_rcu_exp_select_cpus+0x25c/0x3a8<br>2122 [  949.303494]  wait_rcu_exp_gp+0x28/0x40<br>2123 [  949.303494]  process_one_work+0x1b0/0x450<br>2124 [  949.303494]  worker_thread+0x54/0x468<br>2125 [  949.303495]  kthread+0x134/0x138<br>2126 [  949.303495]  ret_from_fork+0x10/0x18<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; foreach bt &gt; foreach_bt.log<br><br>12152 PID: 8564   TASK: ffffbf63ca351700  CPU: 23  COMMAND: <span class="hljs-string">&quot;systemd-hostnam&quot;</span><br>12153  <span class="hljs-comment">#0 [ffff00006188fad0] __switch_to at ffff3eb87dfa8e0c</span><br>12154  <span class="hljs-comment">#1 [ffff00006188faf0] __schedule at ffff3eb87e971438</span><br>12155  <span class="hljs-comment">#2 [ffff00006188fb80] schedule at ffff3eb87e971b28</span><br>12156  <span class="hljs-comment">#3 [ffff00006188fb90] _synchronize_rcu_expedited.constprop.49 at ffff3eb87e0aab98</span><br>12157  <span class="hljs-comment">#4 [ffff00006188fca0] synchronize_sched_expedited at ffff3eb87e0aacac</span><br>12158  <span class="hljs-comment">#5 [ffff00006188fcb0] synchronize_rcu_expedited at ffff3eb87e0aae88</span><br>12159  <span class="hljs-comment">#6 [ffff00006188fcc0] namespace_unlock at ffff3eb87e2a4f78</span><br>12160  <span class="hljs-comment">#7 [ffff00006188fcf0] drop_collected_mounts at ffff3eb87e2a7ee0</span><br>12161  <span class="hljs-comment">#8 [ffff00006188fd20] put_mnt_ns at ffff3eb87e2aa1b0</span><br>12162  <span class="hljs-comment">#9 [ffff00006188fd40] free_nsproxy at ffff3eb87e03dd30</span><br>12163 <span class="hljs-comment">#10 [ffff00006188fd60] switch_task_namespaces at ffff3eb87e03df04</span><br>12164 <span class="hljs-comment">#11 [ffff00006188fd80] exit_task_namespaces at ffff3eb87e03df48</span><br>12165 <span class="hljs-comment">#12 [ffff00006188fda0] do_exit at ffff3eb87e017614</span><br>12166 <span class="hljs-comment">#13 [ffff00006188fe10] do_group_exit at ffff3eb87e017968</span><br>12167 <span class="hljs-comment">#14 [ffff00006188fe40] __arm64_sys_exit_group at ffff3eb87e017a28</span><br>12168 <span class="hljs-comment">#15 [ffff00006188fe60] el0_svc_common at ffff3eb87dfb91ec</span><br>12169 <span class="hljs-comment">#16 [ffff00006188fea0] el0_svc_handler at ffff3eb87dfb92e4</span><br>12170 <span class="hljs-comment">#17 [ffff00006188fff0] el0_svc at ffff3eb87dfa4184</span><br>12171      PC: 0000fffd16566b4c   LR: 0000fffd164f9060   SP: 0000ffffd7e6d440<br>12172     X29: 0000ffffd7e6d440  X28: 0000fffd16635000  X27: 0000000000000000<br>12173     X26: 0000000000000002  X25: 0000fffd1669f708  X24: 0000fffd16630588<br>12174     X23: 0000fffd1662f000  X22: 0000000000000000  X21: 0000fffd16632308<br>12175     X20: 0000000000000008  X19: 0000000000000008  X18: 0000000000000001<br>12176     X17: 0000fffd164f93c8  X16: 0000fffd161afea0  X15: 0000000000000000<br>12177     X14: 0000fffd164c7208  X13: 0000fffd164d4960  X12: 0000fffd166a82b0<br>12178     X11: 0000000000000008  X10: 0000000000000000   X9: 0000fffd166a7150<br>12179      X8: 000000000000005e   X7: 0000000000000001   X6: 0000000000000000<br>12180      X5: 0000000000000000   X4: 0000000000000020   X3: 0000fffd151d0710<br>12181      X2: 0000000000000000   X1: 0000000000000000   X0: 0000000000000000<br>12182     ORIG_X0: 0000000000000000  SYSCALLNO: 5e  PSTATE: 60001000<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; sym ffff3eb87e0aab98<br>ffff3eb87e0aab98 (t) _synchronize_rcu_expedited.constprop.49+728 /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/rcu/tree_exp.h: 686<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree_exp.h +686</span><br><br><span class="hljs-number">674</span>     &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">675</span>         <span class="hljs-comment">/* Marshall arguments &amp; schedule the expedited grace period. */</span><br><span class="hljs-number">676</span>         rew.rew_func = func;<br><span class="hljs-number">677</span>         rew.rew_rsp = rsp;<br><span class="hljs-number">678</span>         rew.rew_s = s;<br><span class="hljs-number">679</span>         INIT_WORK_ONSTACK(&amp;rew.rew_work, wait_rcu_exp_gp);<br><span class="hljs-number">680</span>         queue_work(rcu_gp_wq, &amp;rew.rew_work);<br><span class="hljs-number">681</span>     &#125;<br><span class="hljs-number">682</span><br><span class="hljs-number">683</span>     <span class="hljs-comment">/* Wait for expedited grace period to complete. */</span><br><span class="hljs-number">684</span>     rdp = per_cpu_ptr(rsp-&gt;rda, raw_smp_processor_id());<br><span class="hljs-number">685</span>     rnp = rcu_get_root(rsp);<br><span class="hljs-number">686</span>     wait_event(rnp-&gt;exp_wq[rcu_seq_ctr(s) &amp; <span class="hljs-number">0x3</span>],<br><span class="hljs-number">687</span>         ¦  sync_exp_work_done(rsp, s));<br><span class="hljs-number">688</span>     smp_mb(); <span class="hljs-comment">/* Workqueue actions happen before return. */</span><br><span class="hljs-number">689</span><br><span class="hljs-number">690</span>     <span class="hljs-comment">/* Let the next expedited grace period start. */</span><br><span class="hljs-number">691</span>     mutex_unlock(&amp;rsp-&gt;exp_mutex);<br><span class="hljs-number">692</span> &#125;<br></code></pre></td></tr></table></figure>

<p>从<code>foreach_bt.log</code>中可以看到之前在cpu 23上的进程<code>systemd-hostnam</code>触发了<code>_synchronize_rcu_expedited.constprop.49</code>，它在等待一个加速的RCU回调完成。<code>systemd-hostnam</code>在等待rcu的加速回调完成时主动schedule了一个工作队列<code>rcu_gp_wq</code>，这个工作队列的回调函数是<code>wait_rcu_exp_gp</code>。从<code>vmcore-dmesg.txt</code>中可以看到<code>kworker/23:0</code>线程在执行<code>wait_rcu_exp_gp</code>时卡在了<code>queued_spin_lock_slowpath+0x1d8</code>，即在等待一个qspinlock。</p>
<h5 id="wait-rcu-exp-gp"><a href="#wait-rcu-exp-gp" class="headerlink" title="wait_rcu_exp_gp"></a>wait_rcu_exp_gp</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree_exp.h +636</span><br><br><span class="hljs-number">636</span> <span class="hljs-comment">/*</span><br><span class="hljs-comment">637  * Work-queue handler to drive an expedited grace period forward.</span><br><span class="hljs-comment">638  */</span><br><span class="hljs-number">639</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">wait_rcu_exp_gp</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> work_struct *wp)</span><br>640 &#123;<br><span class="hljs-number">641</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_exp_work</span> *<span class="hljs-title">rewp</span>;</span><br><span class="hljs-number">642</span><br><span class="hljs-number">643</span>     rewp = container_of(wp, <span class="hljs-keyword">struct</span> rcu_exp_work, rew_work);<br><span class="hljs-number">644</span>     rcu_exp_sel_wait_wake(rewp-&gt;rew_rsp, rewp-&gt;rew_func, rewp-&gt;rew_s);<br><span class="hljs-number">645</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree_exp.h +626</span><br><br><span class="hljs-number">626</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">rcu_exp_sel_wait_wake</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rcu_state *rsp,</span><br><span class="hljs-params"><span class="hljs-number">627</span>                 ¦ <span class="hljs-type">smp_call_func_t</span> func, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> s)</span><br>628 &#123;<br><span class="hljs-number">629</span>     <span class="hljs-comment">/* Initialize the rcu_node tree in preparation for the wait. */</span><br><span class="hljs-number">630</span>     sync_rcu_exp_select_cpus(rsp, func);<br><span class="hljs-number">631</span><br><span class="hljs-number">632</span>     <span class="hljs-comment">/* Wait and clean up, including waking everyone. */</span><br><span class="hljs-number">633</span>     rcu_exp_wait_wake(rsp, s);<br><span class="hljs-number">634</span> &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到<code>wait_rcu_exp_gp</code>函数会调用<code>rcu_exp_sel_wait_wake</code>，而<code>rcu_exp_sel_wait_wake</code>又会通过ipi中断调用<code>sync_rcu_exp_select_cpus</code>让所有cpu主动检查静默期状态。</p>
<h4 id="rcu-node与qspinlock关系"><a href="#rcu-node与qspinlock关系" class="headerlink" title="rcu_node与qspinlock关系"></a>rcu_node与qspinlock关系</h4><p>结合前文</p>
<p><code>2396     raw_spin_lock_irqsave_rcu_node(rnp, flags);    // queued_spin_lock_slowpath+0x1d8入口在这</code></p>
<p><code>417     raw_spin_lock_irqsave(&amp;ACCESS_PRIVATE(p, lock), flags); \     // 访问p-&gt;lock</code></p>
<p>来看一下<code>rcu_node</code>与<code>qspinlock</code>的关系：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct -o rcu_node<br>struct rcu_node &#123;<br>    [0] raw_spinlock_t lock;<br>    [8] unsigned long gp_seq;<br>   [16] unsigned long gp_seq_needed;<br>   [24] unsigned long completedqs;<br>   [32] unsigned long qsmask;<br>   [40] unsigned long rcu_gp_init_mask;<br>   [48] unsigned long qsmaskinit;<br>   [56] unsigned long qsmaskinitnext;<br>   [64] unsigned long expmask;<br>   [72] unsigned long expmaskinit;<br>   [80] unsigned long expmaskinitnext;<br>   [88] unsigned long ffmask;<br>   [96] unsigned long grpmask;<br>  [104] int grplo;<br>  [108] int grphi;<br>  [112] u8 grpnum;<br>  [113] u8 level;<br>  [114] bool wait_blkd_tasks;<br>  [120] struct rcu_node *parent;<br>  [128] struct list_head blkd_tasks;<br>  [144] struct list_head *gp_tasks;<br>  [152] struct list_head *exp_tasks;<br>  [160] struct list_head *boost_tasks;<br>  [168] struct rt_mutex boost_mtx;<br>  [200] unsigned long boost_time;<br>  [208] struct task_struct *boost_kthread_task;<br>  [216] unsigned int boost_kthread_status;<br>  [224] struct swait_queue_head nocb_gp_wq[2];<br>  [320] raw_spinlock_t fqslock;<br>  [384] spinlock_t exp_lock;<br>  [392] unsigned long exp_seq_rq;<br>  [400] wait_queue_head_t exp_wq[4];<br>  [496] struct rcu_exp_work rew;<br>  [584] bool exp_need_flush;<br>&#125;<br>SIZE: 640<br></code></pre></td></tr></table></figure>

<p>从<code>struct rcu_node</code>中可以看到<code>lock</code>成员是一个<code>raw_spinlock_t</code>类型的锁。且是第一个成员，意味着qspinlock地址即rcu_node地址。</p>
<p>调用栈回溯：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim 127.0.0.1-2025-05-11-18:26:08/vmcore-dmesg.txt +1580</span><br><br><span class="hljs-number">1583</span> [<span class="hljs-number">887136.212952</span>] rcu: INFO: rcu_sched self-detected stall on CPU<br><span class="hljs-number">1584</span> [<span class="hljs-number">887136.218705</span>] rcu:    <span class="hljs-number">5</span>-...!: (<span class="hljs-number">1</span> GPs behind) idle=e32/<span class="hljs-number">0</span>/<span class="hljs-number">0x1</span> softirq=<span class="hljs-number">2547154</span>/<span class="hljs-number">2547154</span> fqs=<span class="hljs-number">1</span><br><span class="hljs-number">1585</span> [<span class="hljs-number">887136.226836</span>] rcu:     (t=<span class="hljs-number">69795</span> jiffies g=<span class="hljs-number">60317529</span> q=<span class="hljs-number">32</span>)<br><span class="hljs-number">1586</span> [<span class="hljs-number">887136.231966</span>] NMI backtrace <span class="hljs-keyword">for</span> cpu <span class="hljs-number">5</span><br><span class="hljs-number">1587</span> [<span class="hljs-number">887136.235591</span>] CPU: <span class="hljs-number">5</span> PID: <span class="hljs-number">0</span> Comm: swapper/<span class="hljs-number">5</span> Kdump: loaded Tainted: G           OE     <span class="hljs-number">4.19</span><span class="hljs-number">.90</span><span class="hljs-number">-2102.2</span><span class="hljs-number">.0</span><span class="hljs-number">.0062</span>.ctl2.aarch64 #<span class="hljs-number">1</span><br><span class="hljs-number">1588</span> [<span class="hljs-number">887136.246811</span>] Hardware name: RCSIT TG225 B1/BC82AMDQ, BIOS <span class="hljs-number">5.25</span> <span class="hljs-number">09</span>/<span class="hljs-number">14</span>/<span class="hljs-number">2022</span><br><span class="hljs-number">1589</span> [<span class="hljs-number">887136.253702</span>] Call trace:  # 调用栈跟踪<br><span class="hljs-number">1590</span> [<span class="hljs-number">887136.256267</span>]  dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x198</span>  # 打印当前CPU的回溯信息<br><span class="hljs-number">1591</span> [<span class="hljs-number">887136.260066</span>]  show_stack+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x30</span>  # 显示内核堆栈<br><span class="hljs-number">1592</span> [<span class="hljs-number">887136.263516</span>]  dump_stack+<span class="hljs-number">0xa4</span>/<span class="hljs-number">0xe8</span>  # 打印完整堆栈信息<br><span class="hljs-number">1593</span> [<span class="hljs-number">887136.266963</span>]  nmi_cpu_backtrace+<span class="hljs-number">0xf4</span>/<span class="hljs-number">0xf8</span>  # NMI下打印CPU回溯<br><span class="hljs-number">1594</span> [<span class="hljs-number">887136.271026</span>]  nmi_trigger_cpumask_backtrace+<span class="hljs-number">0x170</span>/<span class="hljs-number">0x1c0</span>  # 触发指定CPU集合的NMI回溯<br><span class="hljs-number">1595</span> [<span class="hljs-number">887136.276328</span>]  arch_trigger_cpumask_backtrace+<span class="hljs-number">0x30</span>/<span class="hljs-number">0xd8</span>  # 架构相关的NMI回溯触发<br><span class="hljs-number">1596</span> [<span class="hljs-number">887136.281543</span>]  rcu_dump_cpu_stacks+<span class="hljs-number">0xf4</span>/<span class="hljs-number">0x134</span>  # RCU打印所有stall CPU的堆栈<br><span class="hljs-number">1597</span> [<span class="hljs-number">887136.285872</span>]  print_cpu_stall+<span class="hljs-number">0x16c</span>/<span class="hljs-number">0x228</span>  # 打印CPU卡死（stall）信息<br><span class="hljs-number">1598</span> [<span class="hljs-number">887136.289937</span>]  rcu_check_callbacks+<span class="hljs-number">0x590</span>/<span class="hljs-number">0x7a8</span>  # 检查RCU回调，检测stall<br><span class="hljs-number">1599</span> [<span class="hljs-number">887136.297318</span>]  update_process_times+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x60</span>  # 更新进程时间（时钟中断处理）<br><span class="hljs-number">1600</span> [<span class="hljs-number">887136.304678</span>]  tick_sched_handle.isra<span class="hljs-number">.4</span>+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x70</span>  # 定时器调度处理<br><span class="hljs-number">1601</span> [<span class="hljs-number">887136.312346</span>]  tick_sched_timer+<span class="hljs-number">0x50</span>/<span class="hljs-number">0xa0</span>  # 定时器中断处理主函数<br><span class="hljs-number">1602</span> [<span class="hljs-number">887136.319222</span>]  __hrtimer_run_queues+<span class="hljs-number">0x114</span>/<span class="hljs-number">0x368</span>  # 高精度定时器队列处理<br><span class="hljs-number">1603</span> [<span class="hljs-number">887136.326551</span>]  hrtimer_interrupt+<span class="hljs-number">0xf8</span>/<span class="hljs-number">0x2d0</span>  # 高精度定时器中断入口<br><span class="hljs-number">1604</span> [<span class="hljs-number">887136.333458</span>]  arch_timer_handler_phys+<span class="hljs-number">0x38</span>/<span class="hljs-number">0x58</span>  # 架构相关物理定时器中断处理<br><span class="hljs-number">1605</span> [<span class="hljs-number">887136.340774</span>]  handle_percpu_devid_irq+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x248</span>  # 处理per-cpu设备中断<br><span class="hljs-number">1606</span> [<span class="hljs-number">887136.348161</span>]  generic_handle_irq+<span class="hljs-number">0x3c</span>/<span class="hljs-number">0x58</span>  # 通用中断处理<br><span class="hljs-number">1607</span> [<span class="hljs-number">887136.354969</span>]  __handle_domain_irq+<span class="hljs-number">0x68</span>/<span class="hljs-number">0xc0</span>  # 处理中断域<br><span class="hljs-number">1608</span> [<span class="hljs-number">887136.361812</span>]  gic_handle_irq+<span class="hljs-number">0x6c</span>/<span class="hljs-number">0x170</span>  # ARM GIC中断控制器处理<br><span class="hljs-number">1609</span> [<span class="hljs-number">887136.368233</span>]  el1_irq+<span class="hljs-number">0xb8</span>/<span class="hljs-number">0x140</span>  # EL1异常级别的IRQ入口<br><span class="hljs-number">1610</span> [<span class="hljs-number">887136.373961</span>]  arch_cpu_idle+<span class="hljs-number">0x38</span>/<span class="hljs-number">0x1d0</span>  # 架构相关CPU空闲处理<br><span class="hljs-number">1611</span> [<span class="hljs-number">887136.380163</span>]  default_idle_call+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x58</span>  # 默认CPU空闲调用<br><span class="hljs-number">1612</span> [<span class="hljs-number">887136.386580</span>]  do_idle+<span class="hljs-number">0x1d4</span>/<span class="hljs-number">0x2b0</span>  # CPU空闲主循环<br><span class="hljs-number">1613</span> [<span class="hljs-number">887136.392193</span>]  cpu_startup_entry+<span class="hljs-number">0x28</span>/<span class="hljs-number">0x78</span>  # CPU启动入口<br><span class="hljs-number">1614</span> [<span class="hljs-number">887136.398475</span>]  secondary_start_kernel+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x1c8</span>  # 次级CPU启动内核<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/tree.c +1336</span><br><br><span class="hljs-number">1330</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">rcu_dump_cpu_stacks</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rcu_state *rsp)</span><br>1331 &#123;<br><span class="hljs-number">1332</span>     <span class="hljs-type">int</span> cpu;<br><span class="hljs-number">1333</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-number">1334</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_node</span> *<span class="hljs-title">rnp</span>;</span><br><span class="hljs-number">1335</span><br><span class="hljs-number">1336</span>     rcu_for_each_leaf_node(rsp, rnp) &#123;<br><span class="hljs-number">1337</span>         raw_spin_lock_irqsave_rcu_node(rnp, flags);<br><span class="hljs-number">1338</span>         for_each_leaf_node_possible_cpu(rnp, cpu)<br><span class="hljs-number">1339</span>             <span class="hljs-keyword">if</span> (rnp-&gt;qsmask &amp; leaf_node_cpu_bit(rnp, cpu))<br><span class="hljs-number">1340</span> +-----  <span class="hljs-number">2</span> lines: <span class="hljs-keyword">if</span> (!trigger_single_cpu_backtrace(cpu))-----------------------------------------------------------------------------------<br><span class="hljs-number">1342</span>         raw_spin_unlock_irqrestore_rcu_node(rnp, flags);<br><span class="hljs-number">1343</span>     &#125;<br><span class="hljs-number">1344</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/rcu/rcu.h +362</span><br><br><span class="hljs-number">362</span> <span class="hljs-meta">#<span class="hljs-keyword">define</span> rcu_for_each_leaf_node(rsp, rnp) \</span><br><span class="hljs-meta">363     for ((rnp) = rcu_first_leaf_node(rsp); \</span><br><span class="hljs-meta">364     ¦   ¦(rnp) <span class="hljs-string">&lt; &amp;(rsp)-&gt;</span>node[rcu_num_nodes]; (rnp)++)</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">// vim kernel/rcu/rcu.h +332<br><br>331 /* Returns first leaf rcu_node of the specified RCU flavor. */<br>332 <span class="hljs-comment">#define rcu_first_leaf_node(rsp) ((rsp)-&gt;level[rcu_num_lvls - 1])  </span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_num_lvls<br>rcu_num_lvls = <span class="hljs-variable">$83</span> = 2<br></code></pre></td></tr></table></figure>

<p>从<code>#define rcu_first_leaf_node(rsp) ((rsp)-&gt;level[rcu_num_lvls - 1])</code>可以得到<code>rsp-&gt;level[1]</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct rcu_state.level<br>struct rcu_state &#123;<br>  [41600] struct rcu_node *level[3];<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p rcu_sched_state.level<br><span class="hljs-variable">$87</span> = &#123;0xffff3eb87f209000, 0xffff3eb87f209280, 0x0&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p rcu_sched_state.level[1]<br><span class="hljs-variable">$88</span> = (struct rcu_node *) 0xffff3eb87f209280<br></code></pre></td></tr></table></figure>

<p>到这里44号cpu通过rcu_dump_cpu_stacks中的raw_spin_lock_irqsave_rcu_node函数持有的rcu_node-&gt;lock就很清晰了。</p>
<p>5号cpu 等待的就是44号cpu的锁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_node ffff3eb87f209280<br>struct rcu_node &#123;<br>  lock = &#123;<br>    raw_lock = &#123;<br>      &#123;<br>        val = &#123;<br>          counter = 6291713<br>        &#125;,<br>        &#123;<br>          locked = 1 <span class="hljs-string">&#x27;\001&#x27;</span>,<br>          pending = 1 <span class="hljs-string">&#x27;\001&#x27;</span><br>        &#125;,<br>        &#123;<br>          locked_pending = 257,<br>          <span class="hljs-built_in">tail</span> = 96<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  gp_seq = 65421,<br>  gp_seq_needed = 65428,<br>  completedqs = 65417,<br>  qsmask = 49141,   // qsmask 是 rcu_node 结构体中的一个掩码字段，表示本节点下哪些 CPU 还没有报告“静止状态（quiescent state）”。<br>  rcu_gp_init_mask = 0,<br>  qsmaskinit = 65535,<br>  qsmaskinitnext = 65535,<br>  expmask = 0,<br>  expmaskinit = 65535,<br>  expmaskinitnext = 65535,<br>  ffmask = 65535,<br>  grpmask = 1,<br>  grplo = 0,<br>  grphi = 15,<br>  grpnum = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>  level = 1 <span class="hljs-string">&#x27;\001&#x27;</span>,<br>  wait_blkd_tasks = <span class="hljs-literal">false</span>,<br>  parent = 0xffff3eb87f209000,<br>  blkd_tasks = &#123;<br>    next = 0xffff3eb87f209300,<br>    prev = 0xffff3eb87f209300<br>  &#125;,<br>  gp_tasks = 0x0,<br>  exp_tasks = 0x0,<br>  boost_tasks = 0x0,<br>  boost_mtx = &#123;<br>    wait_lock = &#123;<br>      raw_lock = &#123;<br>        &#123;<br>          val = &#123;<br>            counter = 0<br>          &#125;,<br>          &#123;<br>            locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>            pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>          &#125;,<br>          &#123;<br>            locked_pending = 0,<br>            <span class="hljs-built_in">tail</span> = 0<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;,<br>    waiters = &#123;<br>      rb_root = &#123;<br>        rb_node = 0x0<br>      &#125;,<br>      rb_leftmost = 0x0<br>    &#125;,<br>    owner = 0x0<br>  &#125;,<br>  boost_time = 0,<br>  boost_kthread_task = 0x0,<br>  boost_kthread_status = 0,<br>  nocb_gp_wq = &#123;&#123;<br>      lock = &#123;<br>        raw_lock = &#123;<br>          &#123;<br>            val = &#123;<br>              counter = 0<br>            &#125;,<br>            &#123;<br>              locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>              pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>            &#125;,<br>            &#123;<br>              locked_pending = 0,<br>              <span class="hljs-built_in">tail</span> = 0<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      task_list = &#123;<br>        next = 0xffff3eb87f209368,<br>        prev = 0xffff3eb87f209368<br>      &#125;<br>    &#125;, &#123;<br>      lock = &#123;<br>        raw_lock = &#123;<br>          &#123;<br>            val = &#123;<br>              counter = 0<br>            &#125;,<br>            &#123;<br>              locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>              pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>            &#125;,<br>            &#123;<br>              locked_pending = 0,<br>              <span class="hljs-built_in">tail</span> = 0<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      task_list = &#123;<br>        next = 0xffff3eb87f209380,<br>        prev = 0xffff3eb87f209380<br>      &#125;<br>    &#125;&#125;,<br>  fqslock = &#123;<br>    raw_lock = &#123;<br>      &#123;<br>        val = &#123;<br>          counter = 0<br>        &#125;,<br>        &#123;<br>          locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>          pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>        &#125;,<br>        &#123;<br>          locked_pending = 0,<br>          <span class="hljs-built_in">tail</span> = 0<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  exp_lock = &#123;<br>    &#123;<br>      rlock = &#123;<br>        raw_lock = &#123;<br>          &#123;<br>            val = &#123;<br>              counter = 0<br>            &#125;,<br>            &#123;<br>              locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>              pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>            &#125;,<br>            &#123;<br>              locked_pending = 0,<br>              <span class="hljs-built_in">tail</span> = 0<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  exp_seq_rq = 764,<br>  exp_wq = &#123;&#123;<br>      lock = &#123;<br>        &#123;<br>          rlock = &#123;<br>            raw_lock = &#123;<br>              &#123;<br>                val = &#123;<br>                  counter = 0<br>                &#125;,<br>                &#123;<br>                  locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>                  pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>                &#125;,<br>                &#123;<br>                  locked_pending = 0,<br>                  <span class="hljs-built_in">tail</span> = 0<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-built_in">head</span> = &#123;<br>        next = 0xffff3eb87f209418,<br>        prev = 0xffff3eb87f209418<br>      &#125;<br>    &#125;, &#123;<br>      lock = &#123;<br>        &#123;<br>          rlock = &#123;<br>            raw_lock = &#123;<br>              &#123;<br>                val = &#123;<br>                  counter = 0<br>                &#125;,<br>                &#123;<br>                  locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>                  pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>                &#125;,<br>                &#123;<br>                  locked_pending = 0,<br>                  <span class="hljs-built_in">tail</span> = 0<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-built_in">head</span> = &#123;<br>        next = 0xffff3eb87f209430,<br>        prev = 0xffff3eb87f209430<br>      &#125;<br>    &#125;, &#123;<br>      lock = &#123;<br>        &#123;<br>          rlock = &#123;<br>            raw_lock = &#123;<br>              &#123;<br>                val = &#123;<br>                  counter = 0<br>                &#125;,<br>                &#123;<br>                  locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>                  pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>                &#125;,<br>                &#123;<br>                  locked_pending = 0,<br>                  <span class="hljs-built_in">tail</span> = 0<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-built_in">head</span> = &#123;<br>        next = 0xffff3eb87f209448,<br>        prev = 0xffff3eb87f209448<br>      &#125;<br>    &#125;, &#123;<br>      lock = &#123;<br>        &#123;<br>          rlock = &#123;<br>            raw_lock = &#123;<br>              &#123;<br>                val = &#123;<br>                  counter = 0<br>                &#125;,<br>                &#123;<br>                  locked = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>                  pending = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>                &#125;,<br>                &#123;<br>                  locked_pending = 0,<br>                  <span class="hljs-built_in">tail</span> = 0<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-built_in">head</span> = &#123;<br>        next = 0xffff3eb87f209460,<br>        prev = 0xffff3eb87f209460<br>      &#125;<br>    &#125;&#125;,<br>  rew = &#123;<br>    rew_func = 0xffff3eb87e0a61c8,<br>    rew_rsp = 0xffff3eb87f209000,<br>    rew_s = 0,<br>    rew_work = &#123;<br>      data = &#123;<br>        counter = 0<br>      &#125;,<br>      entry = &#123;<br>        next = 0xffff3eb87f209490,<br>        prev = 0xffff3eb87f209490<br>      &#125;,<br>      func = 0xffff3eb87e0aa180,<br>      kabi_reserved1 = 0,<br>      kabi_reserved2 = 0,<br>      kabi_reserved3 = 0,<br>      kabi_reserved4 = 0<br>    &#125;<br>  &#125;,<br>  exp_need_flush = <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="rcu-node-qsmask-ffff3eb87f209280"><a href="#rcu-node-qsmask-ffff3eb87f209280" class="headerlink" title="rcu_node.qsmask ffff3eb87f209280"></a>rcu_node.qsmask ffff3eb87f209280</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_node.qsmask ffff3eb87f209280<br>  qsmask = 49141<br>crash&gt; <span class="hljs-built_in">eval</span> 49141<br>hexadecimal: bff5<br>    decimal: 49141<br>      octal: 137765<br>     binary: 0000000000000000000000000000000000000000000000001011111111110101<br></code></pre></td></tr></table></figure>

<h4 id="rcu-state"><a href="#rcu-state" class="headerlink" title="rcu_state"></a>rcu_state</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_node.parent ffff3eb87f209280<br>  parent = 0xffff3eb87f209000<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct -o rcu_state<br>struct rcu_state &#123;<br>      [0] struct rcu_node node[65];<br>  [41600] struct rcu_node *level[3];<br>  [41624] struct rcu_data *rda;<br>  [41632] call_rcu_func_t call;<br>  [41640] int ncpus;<br>  [41664] u8 boost;<br>  [41672] unsigned long gp_seq;<br>  [41680] struct task_struct *gp_kthread;<br>  [41688] struct swait_queue_head gp_wq;<br>  [41712] short gp_flags;<br>  [41714] short gp_state;<br>  [41720] struct mutex barrier_mutex;<br>  [41752] atomic_t barrier_cpu_count;<br>  [41760] struct completion barrier_completion;<br>  [41792] unsigned long barrier_sequence;<br>  [41800] struct mutex exp_mutex;<br>  [41832] struct mutex exp_wake_mutex;<br>  [41864] unsigned long expedited_sequence;<br>  [41872] atomic_t expedited_need_qs;<br>  [41880] struct swait_queue_head expedited_wq;<br>  [41904] int ncpus_snap;<br>  [41912] unsigned long jiffies_force_qs;<br>  [41920] unsigned long jiffies_kick_kthreads;<br>  [41928] unsigned long n_force_qs;<br>  [41936] unsigned long gp_start;<br>  [41944] unsigned long gp_activity;<br>  [41952] unsigned long gp_req_activity;<br>  [41960] unsigned long jiffies_stall;<br>  [41968] unsigned long jiffies_resched;<br>  [41976] unsigned long n_force_qs_gpstart;<br>  [41984] unsigned long gp_max;<br>  [41992] const char *name;<br>  [42000] char abbr;<br>  [42008] struct list_head flavors;<br>  [42048] spinlock_t ofl_lock;<br>&#125;<br>SIZE: 42112<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rcu_state 0xffff3eb87f209000 &gt; rcu_state_0xffff3eb87f209000.log<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># include/linux/swait.h</span><br><span class="hljs-comment"># 知道swait_queue_head地址，crash中怎么用list命令得到第62行的task地址</span><br><br>crash&gt; p &amp;(rcu_sched_state.gp_wq)<br><span class="hljs-variable">$96</span> = (struct swait_queue_head *) 0xffff3eb87f2132d8<br><br>crash&gt; list -o swait_queue.task_list -s task_struct.pid,<span class="hljs-built_in">comm</span> -O swait_queue_head.task_list -h 0xffff3eb87f2132d8<br>list: invalid option -- <span class="hljs-string">&#x27;O&#x27;</span><br>Usage:<br>  list [[-o] offset][-e end][-[s|S] struct[.member[,member] [-l offset]] -[x|d]]<br>       [-r|-B] [-h|-H] start<br>Enter <span class="hljs-string">&quot;help list&quot;</span> <span class="hljs-keyword">for</span> details.<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@obs-arm-worker-01 127.0.0.1-2025-05-11-23:11:38]<span class="hljs-comment"># crash --version</span><br><br>crash 7.2.8-5.ctl2<br></code></pre></td></tr></table></figure>

<p>crash版本太低，改用<code>-o</code>选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p &amp;(rcu_sched_state.gp_wq.task_list)<br><span class="hljs-variable">$98</span> = (struct list_head *) 0xffff3eb87f2132e0<br><br>crash&gt; list -o swait_queue.task -s task_struct.pid,<span class="hljs-built_in">comm</span> -H 0xffff3eb87f2132e0<br>(empty)<br></code></pre></td></tr></table></figure>

<p>可以看到rcu_sched_state.gp_wq.task_list是空的，说明rcu_sched_state.gp_wq中没有等待的任务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; task_struct.on_cpu,cpu,recent_used_cpu,wake_cpu ffffbf6546fae880<br>  on_cpu = 1<br>  cpu = 60<br>  recent_used_cpu = 44<br>  wake_cpu = 60<br>crash&gt; bt -c 60<br>PID: 11     TASK: ffffbf6546fae880  CPU: 60  COMMAND: <span class="hljs-string">&quot;rcu_sched&quot;</span><br>bt: WARNING: cannot determine starting stack frame <span class="hljs-keyword">for</span> task ffffbf6546fae880<br>crash&gt;<br>crash&gt; task_struct.on_cpu,cpu,recent_used_cpu,wake_cpu ffffbf6546fae880<br>  on_cpu = 1<br>  cpu = 60<br>  recent_used_cpu = 44<br>  wake_cpu = 60<br></code></pre></td></tr></table></figure>

<p>rcu_sched最近一次使用44号cpu，当前运行在60号cpu上。</p>
<h4 id="rcu-node"><a href="#rcu-node" class="headerlink" title="rcu_node"></a>rcu_node</h4><p>从rcu_state中可以得到所有的rcu_node信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">rcu_node[0]：grplo=0, grphi=15, qsmask=49141<br>rcu_node[1]：grplo=16, grphi=31, qsmask=32384<br>rcu_node[2]：grplo=32, grphi=47, qsmask=64435<br>rcu_node[3]：grplo=48, grphi=63, qsmask=32636<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; <span class="hljs-built_in">eval</span> 49141<br>hexadecimal: bff5<br>    decimal: 49141<br>      octal: 137765<br>     binary: 0000000000000000000000000000000000000000000000001011111111110101<br>crash&gt;<br>crash&gt; <span class="hljs-built_in">eval</span> 32384<br>hexadecimal: 7e80<br>    decimal: 32384<br>      octal: 77200<br>     binary: 0000000000000000000000000000000000000000000000000111111010000000<br>crash&gt;<br>crash&gt; <span class="hljs-built_in">eval</span> 64435<br>hexadecimal: fbb3<br>    decimal: 64435<br>      octal: 175663<br>     binary: 0000000000000000000000000000000000000000000000001111101110110011<br>crash&gt;<br>crash&gt; <span class="hljs-built_in">eval</span> 32636<br>hexadecimal: 7f7c<br>    decimal: 32636<br>      octal: 77574<br>     binary: 0000000000000000000000000000000000000000000000000111111101111100<br>crash&gt;<br></code></pre></td></tr></table></figure>

<p>根据crash输出的二进制结果<strong>重新给出准确的四张表</strong>：</p>
<hr>
<h5 id="rcu-node-0-：grplo-0-grphi-15-qsmask-49141"><a href="#rcu-node-0-：grplo-0-grphi-15-qsmask-49141" class="headerlink" title="rcu_node[0]：grplo&#x3D;0, grphi&#x3D;15, qsmask&#x3D;49141"></a>rcu_node[0]：grplo&#x3D;0, grphi&#x3D;15, qsmask&#x3D;49141</h5><p>49141 &#x3D; 0b1011111111110101</p>
<table>
<thead>
<tr>
<th>bit编号</th>
<th>15</th>
<th>14</th>
<th>13</th>
<th>12</th>
<th>11</th>
<th>10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody><tr>
<td>bit值</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>CPU号</td>
<td>15</td>
<td>14</td>
<td>13</td>
<td>12</td>
<td>11</td>
<td>10</td>
<td>9</td>
<td>8</td>
<td>7</td>
<td>6</td>
<td>5</td>
<td>4</td>
<td>3</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>未QS的CPU号：0,2,4,5,6,7,8,9,10,11,12,13,15</strong></p>
<hr>
<h5 id="rcu-node-1-：grplo-16-grphi-31-qsmask-32384"><a href="#rcu-node-1-：grplo-16-grphi-31-qsmask-32384" class="headerlink" title="rcu_node[1]：grplo&#x3D;16, grphi&#x3D;31, qsmask&#x3D;32384"></a>rcu_node[1]：grplo&#x3D;16, grphi&#x3D;31, qsmask&#x3D;32384</h5><p>32384 &#x3D; 0b0111111010000000</p>
<table>
<thead>
<tr>
<th>bit编号</th>
<th>15</th>
<th>14</th>
<th>13</th>
<th>12</th>
<th>11</th>
<th>10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody><tr>
<td>bit值</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>CPU号</td>
<td>31</td>
<td>30</td>
<td>29</td>
<td>28</td>
<td>27</td>
<td>26</td>
<td>25</td>
<td>24</td>
<td>23</td>
<td>22</td>
<td>21</td>
<td>20</td>
<td>19</td>
<td>18</td>
<td>17</td>
<td>16</td>
</tr>
</tbody></table>
<p><strong>未QS的CPU号：23,25,26,27,28,29,30</strong></p>
<hr>
<h5 id="rcu-node-2-：grplo-32-grphi-47-qsmask-64435"><a href="#rcu-node-2-：grplo-32-grphi-47-qsmask-64435" class="headerlink" title="rcu_node[2]：grplo&#x3D;32, grphi&#x3D;47, qsmask&#x3D;64435"></a>rcu_node[2]：grplo&#x3D;32, grphi&#x3D;47, qsmask&#x3D;64435</h5><p>64435 &#x3D; 0b1111101110110011</p>
<table>
<thead>
<tr>
<th>bit编号</th>
<th>15</th>
<th>14</th>
<th>13</th>
<th>12</th>
<th>11</th>
<th>10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody><tr>
<td>bit值</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>CPU号</td>
<td>47</td>
<td>46</td>
<td>45</td>
<td>44</td>
<td>43</td>
<td>42</td>
<td>41</td>
<td>40</td>
<td>39</td>
<td>38</td>
<td>37</td>
<td>36</td>
<td>35</td>
<td>34</td>
<td>33</td>
<td>32</td>
</tr>
</tbody></table>
<p><strong>未QS的CPU号：32,33,35,36,38,39,40,41,43,44,45,46,47</strong></p>
<hr>
<h5 id="rcu-node-3-：grplo-48-grphi-63-qsmask-32636"><a href="#rcu-node-3-：grplo-48-grphi-63-qsmask-32636" class="headerlink" title="rcu_node[3]：grplo&#x3D;48, grphi&#x3D;63, qsmask&#x3D;32636"></a>rcu_node[3]：grplo&#x3D;48, grphi&#x3D;63, qsmask&#x3D;32636</h5><p>32636 &#x3D; 0b0111111101111100</p>
<table>
<thead>
<tr>
<th>bit编号</th>
<th>15</th>
<th>14</th>
<th>13</th>
<th>12</th>
<th>11</th>
<th>10</th>
<th>9</th>
<th>8</th>
<th>7</th>
<th>6</th>
<th>5</th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody><tr>
<td>bit值</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>CPU号</td>
<td>63</td>
<td>62</td>
<td>61</td>
<td>60</td>
<td>59</td>
<td>58</td>
<td>57</td>
<td>56</td>
<td>55</td>
<td>54</td>
<td>53</td>
<td>52</td>
<td>51</td>
<td>50</td>
<td>49</td>
<td>48</td>
</tr>
</tbody></table>
<p><strong>未QS的CPU号：50,51,53,54,55,56,57,58,59,60,61,62</strong></p>
<hr>
<h4 id="rcu-data"><a href="#rcu-data" class="headerlink" title="rcu_data"></a>rcu_data</h4><h5 id="rcu-state-rda"><a href="#rcu-state-rda" class="headerlink" title="rcu_state.rda"></a>rcu_state.rda</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/locking/rcu.h +317</span><br><br><span class="hljs-number">312</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_state</span> &#123;</span><br><span class="hljs-number">313</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_node</span> <span class="hljs-title">node</span>[<span class="hljs-title">NUM_RCU_NODES</span>];</span>    <span class="hljs-comment">/* Hierarchy. */</span><br><span class="hljs-number">314</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_node</span> *<span class="hljs-title">level</span>[<span class="hljs-title">RCU_NUM_LVLS</span> + 1];</span><br><span class="hljs-number">315</span> +-----  <span class="hljs-number">2</span> lines: Hierarchy <span class="hljs-title function_">levels</span> <span class="hljs-params">(+<span class="hljs-number">1</span> to -------------------------------------------------------------------</span><br><span class="hljs-params"><span class="hljs-number">317</span>     <span class="hljs-keyword">struct</span> rcu_data __percpu *rda;      <span class="hljs-comment">/* pointer of percu rcu_data. */</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_state.rda ffff3eb87f209000<br>  rda = 0xffff3eb87eebe280<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; sym 0xffff3eb87eebe280<br>ffff3eb87eebe280 (d) rcu_sched_data<br></code></pre></td></tr></table></figure>

<p>d 表示 rcu_sched_data 是一个全局变量（数据段符号），不是函数。</p>
<p>rcu_sched_data 是一个 per-CPU 变量:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_sched_data &gt; rcu_sched_data.log<br><br>PER-CPU DATA TYPE:<br>  struct rcu_data rcu_sched_data;<br>PER-CPU ADDRESSES:<br>  [0]: ffffbf657f9ee280<br>  [1]: ffffbf657fa1e280<br>  [2]: ffffbf657fa4e280<br>  [3]: ffffbf657fa7e280<br>  [4]: ffffbf657faae280<br>  [5]: ffffbf657fade280<br>  [6]: ffffbf657fb0e280<br>  [7]: ffffbf657fb3e280<br>  [8]: ffffbf657fb6e280<br>  [9]: ffffbf657fb9e280<br>  [10]: ffffbf657fbce280<br>  [11]: ffffbf657fbfe280<br>  [12]: ffffbf657fc2e280<br>  [13]: ffffbf657fc5e280<br>  [14]: ffffbf657fc8e280<br>  [15]: ffffbf657fcbe280<br>  [16]: ffffbf657fcee280<br>  [17]: ffffbf657fd1e280<br>  [18]: ffffbf657fd4e280<br>  [19]: ffffbf657fd7e280<br>  [20]: ffffbf657fdae280<br>  [21]: ffffbf657fdde280<br>  [22]: ffffbf657fe0e280<br>  [23]: ffffbf657fe3e280<br>  [24]: ffffbf657fe6e280<br>  [25]: ffffbf657fe9e280<br>  [26]: ffffbf657fece280<br>  [27]: ffffbf657fefe280<br>  [28]: ffffbf657ff2e280<br>  [29]: ffffbf657ff5e280<br>  [30]: ffffbf657ff8e280<br>  [31]: ffffbf657ffbe280<br>  [32]: ffffdf653f92e280<br>  [33]: ffffdf653f95e280<br>  [34]: ffffdf653f98e280<br>  [35]: ffffdf653f9be280<br>  [36]: ffffdf653f9ee280<br>  [37]: ffffdf653fa1e280<br>  [38]: ffffdf653fa4e280<br>  [39]: ffffdf653fa7e280<br>  [40]: ffffdf653faae280<br>  [41]: ffffdf653fade280<br>  [42]: ffffdf653fb0e280<br>  [43]: ffffdf653fb3e280<br>  [44]: ffffdf653fb6e280<br>  [45]: ffffdf653fb9e280<br>  [46]: ffffdf653fbce280<br>  [47]: ffffdf653fbfe280<br>  [48]: ffffdf653fc2e280<br>  [49]: ffffdf653fc5e280<br>  [50]: ffffdf653fc8e280<br>  [51]: ffffdf653fcbe280<br>  [52]: ffffdf653fcee280<br>  [53]: ffffdf653fd1e280<br>  [54]: ffffdf653fd4e280<br>  [55]: ffffdf653fd7e280<br>  [56]: ffffdf653fdae280<br>  [57]: ffffdf653fdde280<br>  [58]: ffffdf653fe0e280<br>  [59]: ffffdf653fe3e280<br>  [60]: ffffdf653fe6e280<br>  [61]: ffffdf653fe9e280<br>  [62]: ffffdf653fece280<br>  [63]: ffffdf653fefe280<br></code></pre></td></tr></table></figure>

<h5 id="cpu-44-rcu-data"><a href="#cpu-44-rcu-data" class="headerlink" title="cpu 44 rcu_data"></a>cpu 44 rcu_data</h5><p>44号cpu 没有msc 锁的父节点，msc.locked &#x3D; 1, 表明44号cpu是持有rcu_node锁的。</p>
<p>查看per_cpu变量有两种方法。</p>
<h6 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; kmem -o &gt; kmem_o.log<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; kmem -o | grep <span class="hljs-string">&#x27;CPU 44&#x27;</span><br> CPU 44: a0acc0cb0000<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; <span class="hljs-built_in">eval</span> 0xa0acc0cb0000 + 0xffff3eb87eebe280<br>hexadecimal: ffffdf653fb6e280<br>    decimal: 18446708224686482048  (-35849023069568)<br>      octal: 1777776766247755561200<br>     binary: 1111111111111111110111110110010100111111101101101110001010000000<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_data ffffdf653fb6e280 &gt; rcu_data_ffffdf653fb6e280_cpu_44.log<br><br>struct rcu_data &#123;<br>  gp_seq = 65421,<br>  gp_seq_needed = 65420,<br>  rcu_qs_ctr_snap = 0,<br>  cpu_no_qs = &#123;<br>    b = &#123;<br>      norm = 0 <span class="hljs-string">&#x27;\000&#x27;</span>,<br>      exp = 0 <span class="hljs-string">&#x27;\000&#x27;</span><br>    &#125;,<br>    s = 0<br>  &#125;,<br>  core_needs_qs = <span class="hljs-literal">true</span>,<br>  beenonline = <span class="hljs-literal">true</span>,<br>  gpwrap = <span class="hljs-literal">false</span>,<br>  mynode = 0xffff3eb87f209780,<br>  grpmask = 4096,<br>  ticks_this_gp = 1,<br>  cblist = &#123;<br>    <span class="hljs-built_in">head</span> = 0x0,<br>    tails = &#123;0xffffdf653fb6e2b8, 0xffffdf653fb6e2b8, 0xffffdf653fb6e2b8, 0xffffdf653fb6e2b8&#125;,<br>...<br></code></pre></td></tr></table></figure>

<h6 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p rcu_sched_data:44 &gt; p_rcu_sched_data_44.log<br></code></pre></td></tr></table></figure>

<p>两种方法都可以查看到44号CPU的<code>rcu_data</code>结构体数据，内容是一样的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p rcu_data:44 &gt; p_rcu_data_44.log<br></code></pre></td></tr></table></figure>

<p>core_needs_qs &#x3D; true ← 需要静默点（QS），说明本CPU还没上报QS。</p>
<p>gp_seq 表示当前全局RCU宽限期（Grace Period）的序列号，即系统推进到的最新RCU同步序号。</p>
<p>gp_seq_needed 表示本CPU上次需要参与的RCU宽限期序列号。</p>
<p>当 gp_seq &gt; gp_seq_needed 时，说明全局RCU宽限期已经推进到新的阶段，而本CPU上次需要参与的宽限期已经被推进过去。</p>
<p>也就是说，本CPU已经不再需要为旧的gp_seq_needed参与QS（静默点）上报，但如果本CPU还未上报QS，可能会影响新的宽限期推进。</p>
<p>本CPU（如44号）落后于全局RCU进度，还没有完成上一次宽限期的静默点上报，导致RCU同步推进受阻。<br>这也是RCU卡住、死锁的常见根因之一。</p>
<h5 id="cpu-5-rcu-data"><a href="#cpu-5-rcu-data" class="headerlink" title="cpu 5 rcu_data"></a>cpu 5 rcu_data</h5><h6 id="方法一-1"><a href="#方法一-1" class="headerlink" title="方法一"></a>方法一</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; kmem -o | grep -w <span class="hljs-string">&#x27;CPU 5&#x27;</span><br>  CPU 5: 80ad00c20000<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; <span class="hljs-built_in">eval</span> 0x80ad00c20000 + 0xffff3eb87eebe280<br>hexadecimal: ffffbf657fade280<br>    decimal: 18446673041387545216  (-71032322006400)<br>      octal: 1777775766257753361200<br>     binary: 1111111111111111101111110110010101111111101011011110001010000000<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; rcu_data ffffbf657fade280 &gt; rcu_data_fffbf657fade280_cpu_5.log<br></code></pre></td></tr></table></figure>

<h6 id="方法二-1"><a href="#方法二-1" class="headerlink" title="方法二"></a>方法二</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p rcu_sched_data:5 &gt; p_rcu_sched_data_5.log<br></code></pre></td></tr></table></figure>

<p>前文查看了cpu 44和cpu 5的<code>rcu_data</code>，太慢了，将所有cpu上的rcu_data导出来看看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p rcu_sched_data:0-63 &gt; p_rcu_sched_data_0-63.log<br></code></pre></td></tr></table></figure>

<h5 id="查找core-needs-qs-true"><a href="#查找core-needs-qs-true" class="headerlink" title="查找core_needs_qs &#x3D; true"></a>查找core_needs_qs &#x3D; true</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># filepath: find_core_needs_qs_true.sh</span><br><br>awk <span class="hljs-string">&#x27;</span><br><span class="hljs-string">BEGIN &#123; RS=&quot;per_cpu\\(rcu_sched_data,&quot;; ORS=&quot;&quot;; &#125;</span><br><span class="hljs-string">/core_needs_qs = true/ &amp;&amp; NR&gt;1 &#123;</span><br><span class="hljs-string">    print &quot;per_cpu(rcu_sched_data,&quot; $0 &quot;\n----------------------------------------\n&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#x27;</span> p_rcu_sched_data_0-63.log | <span class="hljs-built_in">tee</span> core_needs_qs_true.log<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&#x27;per_cpu(rcu_sched_data&#x27;</span> core_needs_qs_true.log | awk -F <span class="hljs-string">&#x27;[, )]+&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="hljs-built_in">paste</span> -sd,<br><br>0,2,5,6,7,9,11,12,13,15,23,25,26,28,30,32,33,36,37,40,41,44,45,46,47,50,51,53,54,56,58,60,61<br></code></pre></td></tr></table></figure>

<h5 id="查看core-needs-qs-true的CPU栈"><a href="#查看core-needs-qs-true的CPU栈" class="headerlink" title="查看core_needs_qs &#x3D; true的CPU栈"></a>查看core_needs_qs &#x3D; true的CPU栈</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -c 0,2,5,6,7,9,11,12,13,15,23,25,26,28,30,32,33,36,37,40,41,44,45,46,47,50,51,53,54,56,58,60,61 &gt; bt_c_rcu_sched_data_core_needs_qs_true.log<br></code></pre></td></tr></table></figure>

<h5 id="23号cpu是否关中断？"><a href="#23号cpu是否关中断？" class="headerlink" title="23号cpu是否关中断？"></a>23号cpu是否关中断？</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; task_struct.thread_info ffffbf655d94d900<br>  thread_info = &#123;<br>    flags = 552,<br>    addr_limit = 281474976710655,<br>    preempt_count = 1114112<br>  &#125;<br>crash&gt; <span class="hljs-built_in">eval</span> 552<br>hexadecimal: 228<br>    decimal: 552<br>      octal: 1050<br>     binary: 0000000000000000000000000000000000000000000000000000001000101000<br>crash&gt; <span class="hljs-built_in">eval</span> 1114112<br>hexadecimal: 110000  (1088KB)<br>    decimal: 1114112<br>      octal: 4200000<br>     binary: 0000000000000000000000000000000000000000000100010000000000000000<br>crash&gt; bt -c 23<br>PID: 6214   TASK: ffffbf655d94d900  CPU: 23  COMMAND: <span class="hljs-string">&quot;kworker/23:0&quot;</span><br>bt: WARNING: cannot determine starting stack frame <span class="hljs-keyword">for</span> task ffffbf655d94d900<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">list callback_head.next -s callback_head  0xffffbf6521b07e68 &gt; cblist_head_cpu_5.log<br></code></pre></td></tr></table></figure>

<h5 id="rcu-callback-head-next不为0的情况"><a href="#rcu-callback-head-next不为0的情况" class="headerlink" title="rcu_callback_head.next不为0的情况"></a>rcu_callback_head.next不为0的情况</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># find_rcu_sched_data_len_not_zero.sh</span><br><br>awk <span class="hljs-string">&#x27;</span><br><span class="hljs-string">BEGIN &#123; RS=&quot;per_cpu\\(rcu_sched_data,&quot;; ORS=&quot;&quot;; &#125;</span><br><span class="hljs-string">/len *= *[1-9][0-9]*/ &amp;&amp; NR&gt;1 &#123;</span><br><span class="hljs-string">    print &quot;per_cpu(rcu_sched_data,&quot; $0 &quot;\n----------------------------------------\n&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#x27;</span> p_rcu_sched_data_0-63.log &gt; rcu_sched_data_len_not_zero.log<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; list callback_head.next -s callback_head.func 0xffffbf6556214c00 | grep func | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span><br>0x28<br>0xffff3eb87e1dd6a0<br>0xffff3eb87e27c128<br>0xffff3eb87e2986d8<br>crash&gt; sym 0xffff3eb87e1dd6a0<br>ffff3eb87e1dd6a0 (t) shmem_destroy_callback /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/mm/shmem.c: 3635<br>crash&gt; sym 0xffff3eb87e27c128<br>ffff3eb87e27c128 (t) file_free_rcu /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/fs/file_table.c: 45<br>crash&gt; sym 0xffff3eb87e2986d8<br>ffff3eb87e2986d8 (t) __d_free /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/fs/dcache.c: 254<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; list callback_head.next -s callback_head.func 0xffffbf657fa4e2b8 | grep func | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span><br><br>0xffff3eb87e2986d8<br>0xffffbf657fa4e2b8<br>crash&gt;<br>crash&gt; sym 0xffff3eb87e2986d8<br>ffff3eb87e2986d8 (t) __d_free /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/fs/dcache.c: 254<br>crash&gt; sym 0xffffbf657fa4e2b8<br>sym: invalid address: 0xffffbf657fa4e2b8<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; list callback_head.next -s callback_head.func 0xffffbf657faae2b8 | grep func | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span><br>0xffff3eb87e014d18<br>0xffff3eb87e038970<br>0xffff3eb87e2986d8<br>0xffff3eb87e30fdc0<br>0xffffbf657faae2b8<br>crash&gt; sym 0xffff3eb87e014d18<br>ffff3eb87e014d18 (t) delayed_put_task_struct /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/exit.c: 176<br>crash&gt; sym 0xffff3eb87e038970<br>ffff3eb87e038970 (t) delayed_put_pid /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/kernel/pid.c: 118<br>crash&gt; sym 0xffff3eb87e2986d8<br>ffff3eb87e2986d8 (t) __d_free /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/fs/dcache.c: 254<br>crash&gt; sym 0xffffbf657faae2b8<br>sym: invalid address: 0xffffbf657faae2b8<br></code></pre></td></tr></table></figure>

<p>cpu 5:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; list callback_head.next -s callback_head.func 0xffffbf657fade2b8 | grep func | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span><br>0xffff3eb87e2986d8<br>0xffff3eb87e2db538<br>0xffffbf657fade2b8<br>crash&gt; sym 0xffff3eb87e2986d8<br>ffff3eb87e2986d8 (t) __d_free /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/fs/dcache.c: 254<br>crash&gt; sym 0xffff3eb87e2db538<br>ffff3eb87e2db538 (t) epi_rcu_free /usr/src/debug/kernel-4.19.90-2102.2.0.0062.ctl2.aarch64/linux-4.19.90-2102.2.0.0062.ctl2.aarch64/fs/eventpoll.c: 763<br>crash&gt; sym 0xffffbf657fade2b8<br>sym: invalid address: 0xffffbf657fade2b8<br></code></pre></td></tr></table></figure>

<h4 id="per-cpu-qnodes"><a href="#per-cpu-qnodes" class="headerlink" title="per_cpu(qnodes)"></a>per_cpu(qnodes)</h4><p>qspinlock的qnodes是一个per-CPU变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/locking/qspinlock.c +119</span><br><span class="hljs-number">119</span> <span class="hljs-type">static</span> <span class="hljs-title function_">DEFINE_PER_CPU_ALIGNED</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> qnode, qnodes[MAX_NODES])</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; qnodes &gt; qnodes.log<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; p qnodes:0-63 &gt; p_qnodes.log<br></code></pre></td></tr></table></figure>

<h5 id="find-unused-qnodes-sh"><a href="#find-unused-qnodes-sh" class="headerlink" title="find_unused_qnodes.sh"></a>find_unused_qnodes.sh</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># 文件名：find_unused_qnodes.sh</span><br><br><span class="hljs-comment"># 先清理旧结果</span><br><span class="hljs-built_in">rm</span> -f used_addr.txt unused_qnodes.txt<br><br><span class="hljs-comment"># 1. 提取 p_qndoes.log 中所有出现过的地址</span><br>grep -oE <span class="hljs-string">&#x27;ffff[0-9a-f]&#123;12&#125;&#x27;</span> p_qndoes.log &gt; used_addr.txt<br><br><span class="hljs-comment"># 2. 遍历 qnodes.log 里的地址和CPU编号，输出未被指向的</span><br>grep -oP <span class="hljs-string">&#x27;\[\d+\]: ffff[0-9a-f]+&#x27;</span> qnodes.log | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line; <span class="hljs-keyword">do</span><br>    cpu=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$line</span>&quot;</span> | grep -oP <span class="hljs-string">&#x27;\[\d+\]&#x27;</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">&#x27;[]&#x27;</span>)<br>    addr=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$line</span>&quot;</span> | grep -oP <span class="hljs-string">&#x27;ffff[0-9a-f]+&#x27;</span>)<br>    <span class="hljs-keyword">if</span> ! grep -q <span class="hljs-string">&quot;<span class="hljs-variable">$addr</span>&quot;</span> used_addr.txt; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CPU <span class="hljs-variable">$cpu</span>: <span class="hljs-variable">$addr</span>&quot;</span> &gt;&gt; unused_qnodes.txt<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># 3. 打印结果</span><br><span class="hljs-built_in">cat</span> unused_qnodes.txt<br></code></pre></td></tr></table></figure>

<p>没有父节点的qnode cpu编号:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cat unused_qnodes.txt</span><br><br>CPU 3: ffffbf657fa7e240<br>CPU 4: ffffbf657faae240<br>CPU 5: ffffbf657fade240<br>CPU 22: ffffbf657fe0e240<br>CPU 27: ffffbf657fefe240<br>CPU 31: ffffbf657ffbe240<br>CPU 37: ffffdf653fa1e240<br>CPU 44: ffffdf653fb6e240<br>CPU 48: ffffdf653fc2e240<br>CPU 60: ffffdf653fe6e240<br></code></pre></td></tr></table></figure>

<p>根据cpu msc锁看到没有父节点的qnode cpu编号大致分类两类，bt -c <cpuid> 栈正常的如下，正常的栈内容基本一样：</cpuid></p>
<ul>
<li><code>bt -c 3</code></li>
<li><code>bt -c 4</code></li>
<li><code>bt -c 22</code></li>
<li><code>bt -c 27</code></li>
<li><code>bt -c 31</code></li>
<li><code>bt -c 37</code></li>
<li><code>bt -c 48</code></li>
</ul>
<p>异常的栈如下：</p>
<ul>
<li><code>bt -c 5</code></li>
<li><code>bt -c 44</code></li>
<li><code>bt -c 60</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -c 5<br>PID: 0      TASK: ffffbf6546fa2e80  CPU: 5   COMMAND: <span class="hljs-string">&quot;swapper/5&quot;</span><br>bt: WARNING: cannot determine starting stack frame <span class="hljs-keyword">for</span> task ffffbf6546fa2e80<br>crash&gt;<br>crash&gt; bt -c 44<br>PID: 0      TASK: ffffdf64e643f000  CPU: 44  COMMAND: <span class="hljs-string">&quot;swapper/44&quot;</span><br>bt: WARNING: cannot determine starting stack frame <span class="hljs-keyword">for</span> task ffffdf64e643f000<br>crash&gt;<br>crash&gt; bt -c 60<br>PID: 11     TASK: ffffbf6546fae880  CPU: 60  COMMAND: <span class="hljs-string">&quot;rcu_sched&quot;</span><br>bt: WARNING: cannot determine starting stack frame <span class="hljs-keyword">for</span> task ffffbf6546fae880<br></code></pre></td></tr></table></figure>

<h5 id="find-duplicate-next-cpu-fixed-sh"><a href="#find-duplicate-next-cpu-fixed-sh" class="headerlink" title="find_duplicate_next_cpu_fixed.sh"></a>find_duplicate_next_cpu_fixed.sh</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># 文件名：find_duplicate_next_cpu_fixed.sh</span><br><br><span class="hljs-comment"># 1. 找出被多个节点指向的 next 地址（去掉0x前缀）</span><br>grep -oP <span class="hljs-string">&#x27;next = 0x[0-9a-f]+&#x27;</span> p_qndoes.log | grep -v <span class="hljs-string">&#x27;next = 0x0&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span> | sed <span class="hljs-string">&#x27;s/^0x//&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | awk <span class="hljs-string">&#x27;$1 &gt; 1 &#123;print $2&#125;&#x27;</span> &gt; dup_next.txt<br><br><span class="hljs-comment"># 2. 建立地址到CPU编号的映射表</span><br>awk <span class="hljs-string">&#x27;/\[[0-9]+\]: ffff/ &#123;</span><br><span class="hljs-string">    match($0, /\[([0-9]+)\]: (ffff[0-9a-f]+)/, arr);</span><br><span class="hljs-string">    if (arr[1] &amp;&amp; arr[2]) print arr[2] &quot; &quot; arr[1];</span><br><span class="hljs-string">&#125;&#x27;</span> qnodes.log &gt; addr2cpu.txt<br><br><span class="hljs-comment"># 3. 查找每个重复next对应的CPU编号</span><br><span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> addr; <span class="hljs-keyword">do</span><br>    cpu=$(grep -i <span class="hljs-string">&quot;^<span class="hljs-variable">$addr</span> &quot;</span> addr2cpu.txt | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$cpu</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$addr</span> 对应的CPU编号: <span class="hljs-variable">$cpu</span>&quot;</span> &gt;&gt; dup_next_cpu.txt<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$addr</span> 未找到对应CPU&quot;</span><br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span> &lt; dup_next.txt<br></code></pre></td></tr></table></figure>

<p>多个qnode指向同一个next的cpu：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cat dup_next_cpu.txt</span><br><br>ffffbf657fe3e240 对应的CPU编号: 23<br>ffffbf657ff5e240 对应的CPU编号: 29<br>ffffdf653fa7e240 对应的CPU编号: 39<br>ffffdf653fb3e240 对应的CPU编号: 43<br>ffffdf653fece240 对应的CPU编号: 62<br></code></pre></td></tr></table></figure>

<p>观察一下cpu mcs:</p>
<p>cpu mcs：5 2 9 13 11 6 7 12 23 null</p>
<p>cpu mcs：48 21 23 null</p>
<p>cpu mcs: 44 62</p>
<p>cpu mcs: 60 39 32 40 51 33 36 41 24 52 0 53 54 55 42 59 56 57 62 47 26 46 45 null</p>
<p>cpu mcs: 20 35 30 10 50 61 39</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 44 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>          CPU44<br>  4:       2183    GICv3 arch_timer<br>147:         81  ITS-MSI megasas0-msix12<br>164:         18  ITS-MSI megasas0-msix29<br>166:          3  ITS-MSI megasas0-msix31<br>325:          3  ITS-MSI ens1-43<br>390:          1  ITS-MSI eth1-43<br>412:        448  ITS-MSI ens0-1<br>413:        585  ITS-MSI ens0-2<br>422:          8  ITS-MSI ens0-11<br>486:          1  ITS-MSI eth3-11<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 5 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>           CPU5<br>  4:       8155    GICv3 arch_timer<br>148:        250  ITS-MSI megasas0-msix13<br>286:          3  ITS-MSI ens1-4<br>351:          1  ITS-MSI eth1-4<br>447:          3  ITS-MSI ens0-36<br>511:          1  ITS-MSI eth3-36<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 9 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>           CPU9<br>  4:       7024    GICv3 arch_timer<br>152:        141  ITS-MSI megasas0-msix17<br>290:          3  ITS-MSI ens1-8<br>355:          1  ITS-MSI eth1-8<br>451:         10  ITS-MSI ens0-40<br>515:          1  ITS-MSI eth3-40<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 13 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>          CPU13<br>  4:      12107    GICv3 arch_timer<br>156:         24  ITS-MSI megasas0-msix21<br>230:         58  ITS-MSI megasas5-msix21<br>294:          8  ITS-MSI ens1-12<br>359:          1  ITS-MSI eth1-12<br>455:          5  ITS-MSI ens0-44<br>519:          1  ITS-MSI eth3-44<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 11 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>          CPU11<br>  4:       8495    GICv3 arch_timer<br>154:         71  ITS-MSI megasas0-msix19<br>228:          2  ITS-MSI megasas5-msix19<br>292:          8  ITS-MSI ens1-10<br>357:          1  ITS-MSI eth1-10<br>409:         20  ITS-MSI mlx5_async63@pci:0000:01:00.1<br>453:         18  ITS-MSI ens0-42<br>517:          1  ITS-MSI eth3-42<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 2 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>           CPU2<br>  4:       6420    GICv3 arch_timer<br>145:         75  ITS-MSI megasas0-msix10<br>219:        102  ITS-MSI megasas5-msix10<br>283:          3  ITS-MSI ens1-1<br>348:          1  ITS-MSI eth1-1<br>444:          3  ITS-MSI ens0-33<br>508:          1  ITS-MSI eth3-33<br>733:          1  ITS-MSI hclge-misc-0000:7d:00.2<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; irq -s -c 0 | awk <span class="hljs-string">&#x27;$2 != 0&#x27;</span><br>           CPU0<br>  4:      13484    GICv3 arch_timer<br> 15:          7    GICv3 ttyS0<br> 75:         33    GICv3 ehci_hcd:usb1,ehci_hcd:usb2,ohci_hcd:usb3,ohci_hcd:usb4<br> 76:        921  ITS-MSI hibmc<br> 77:         76  ITS-MSI xhci_hcd<br>143:         41  ITS-MSI megasas0-msix8<br>281:          4  ITS-MSI ens1--1<br>344:       5084  ITS-MSI mlx5_async63@pci:0000:01:00.0<br>346:          1  ITS-MSI eth1--1<br>409:       2908  ITS-MSI mlx5_async63@pci:0000:01:00.1<br>442:          3  ITS-MSI ens0-31<br>473:       5100  ITS-MSI mlx5_async63@pci:0000:82:00.0<br>506:          1  ITS-MSI eth3-31<br>537:       2908  ITS-MSI mlx5_async63@pci:0000:82:00.1<br>538:          1  ITS-MSI hclge-misc-0000:7d:00.0<br></code></pre></td></tr></table></figure>

<h2 id="问题结果"><a href="#问题结果" class="headerlink" title="问题结果"></a>问题结果</h2><p>疑点：时钟中断上报有问题或某段代码中长时间关中断，导致rcu_sched无法被调度，rcu回调函数无法被执行。</p>
<p>同一批鲲鹏920机器，都是装的4.19 62内核，只有一台机器开机后放着不动出现了这个问题。</p>
<p>硬件侧排查时钟中断未上报问题。</p>
<p>内核测观察是否有长时间关中断的代码，当前并没有观察到有长时间关中断行为。</p>
<p>idle状态下cpu陷入深度睡眠，htimer无法上报中断？</p>
<p>更换主板后，问题不再修复。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/" class="category-chain-item">kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/mutex/" class="category-chain-item">mutex</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/mutex/rcu/" class="category-chain-item">rcu</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/mutex/rcu/bugs/" class="category-chain-item">bugs</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/mutex/rcu/bugs/rcu-process-callbacks/" class="category-chain-item">rcu_process_callbacks</a>
  
  

  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/3d/">#3d</a>
      
        <a href="/tags/deb/">#deb</a>
      
        <a href="/tags/debug/">#debug</a>
      
        <a href="/tags/fs/">#fs</a>
      
        <a href="/tags/kdump/">#kdump</a>
      
        <a href="/tags/kernel/">#kernel</a>
      
        <a href="/tags/linux/">#linux</a>
      
        <a href="/tags/log/">#log</a>
      
        <a href="/tags/perf/">#perf</a>
      
        <a href="/tags/task/">#task</a>
      
        <a href="/tags/vim/">#vim</a>
      
        <a href="/tags/mm/">#mm</a>
      
        <a href="/tags/net/">#net</a>
      
        <a href="/tags/struct/">#struct</a>
      
        <a href="/tags/mutex/">#mutex</a>
      
        <a href="/tags/thread/">#thread</a>
      
        <a href="/tags/proc/">#proc</a>
      
        <a href="/tags/modules/">#modules</a>
      
        <a href="/tags/proxy/">#proxy</a>
      
        <a href="/tags/sync/">#sync</a>
      
        <a href="/tags/rcu/">#rcu</a>
      
        <a href="/tags/power/">#power</a>
      
        <a href="/tags/container/">#container</a>
      
        <a href="/tags/irq/">#irq</a>
      
        <a href="/tags/tick/">#tick</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>rcu hard lockup</div>
      <div>https://realwujing.github.io/linux/kernel/mutex/rcu/bugs/rcu_process_callbacks/rcu hard lockup/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年6月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/linux/kernel/sources/linux-0.11-debug/linux-0.11%E8%B0%83%E8%AF%95/" title="linux-0.11调试">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">linux-0.11调试</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/kernel/mutex/spin_lock%E5%8F%98%E4%BD%93%E5%AF%B9%E6%AF%94/" title="spin_lock变体对比">
                        <span class="hidden-mobile">spin_lock变体对比</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '432553e7f4d8ffb88fa98735e44bfeb4'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
