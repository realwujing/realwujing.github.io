

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="HTML, JavaScript, Hexo, Linux, qemu, C++, namespace, git, bcc, bpf, initramfs, k8s, architect, strings, assembly, linux">
  
    <meta name="description" content="内存管理  内存是怎样一步步被分配出来的？ [务必收藏] Linux用户空间和内核空间所有15种内存分配方法总结 linux内存管理笔记(三十）----进程虚拟地址 [内核内存] 用户态进程虚拟内存管理 task_struct 结构，mm_struct 结构， vm_area_struct 结构 linux内核编程之二：vm_area_struct结构体 内核页表共享 随笔分类 - Linux内存">
<meta property="og:type" content="article">
<meta property="og:title" content="内存管理">
<meta property="og:url" content="https://realwujing.github.io/linux/kernel/mm/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="内存管理  内存是怎样一步步被分配出来的？ [务必收藏] Linux用户空间和内核空间所有15种内存分配方法总结 linux内存管理笔记(三十）----进程虚拟地址 [内核内存] 用户态进程虚拟内存管理 task_struct 结构，mm_struct 结构， vm_area_struct 结构 linux内核编程之二：vm_area_struct结构体 内核页表共享 随笔分类 - Linux内存">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-28T21:53:17.000Z">
<meta property="article:modified_time" content="2025-06-20T09:11:35.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="qemu">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="git">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="HTML">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>内存管理 - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="内存管理"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-28 21:53" pubdate>
          2025年3月28日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          41k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          339 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">内存管理</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2025年6月20日 上午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="内存管理">内存管理</h1>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/DrsPES_6iY6-QeMHame4zw">内存是怎样一步步被分配出来的？</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/_RUTm6AZQT3GMQ61k8HQDQ">[务必收藏]
Linux用户空间和内核空间所有15种内存分配方法总结</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/u012489236/article/details/108838504">linux内存管理笔记(三十）----进程虚拟地址</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/u010923083/article/details/116937668">[内核内存]
用户态进程虚拟内存管理</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/FF_programming/article/details/120963212">task_struct
结构，mm_struct 结构， vm_area_struct 结构</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/Windgs_YF/article/details/114587330">linux内核编程之二：vm_area_struct结构体</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wREZkRCaFcCTy9Mtk3xCGQ">内核页表共享</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/LoyenWang/category/1533753.html"><font color=Red>随笔分类
- Linux内存管理</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg2MzU3Mjc3Ng==&amp;scene=1&amp;album_id=2559805446807928833&amp;count=3#wechat_redirect"><font color=Red>聊聊Linux内核</font></a>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SLQXuEGHIFoHI-_w9nVMJg">从
Linux 内核角度探秘 JDK NIO 文件读写本质</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/zAh1yD5IfwuoYdrZ1tGf5Q">聊聊Netty那些事儿之从内核角度看IO模型</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/uWadcBxEgctnrgyu32T8sQ"><font color=Red>一步一图带你深入理解
Linux 虚拟内存管理</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Cn-oX0W5DrI2PivaWLDpPw"><font color=Red>一步一图带你深入理解
Linux 物理内存管理</font></a></p>
<p>4.4 NUMA 节点中的内存规整与回收</p>
<p>内存可以说是计算机系统中最为宝贵的资源了，再怎么多也不够用，当系统运行时间长了之后，难免会遇到内存紧张的时候，这时候就需要内核将那些不经常使用的内存页面回收起来，或者将那些可以迁移的页面进行内存规整，从而可以腾出连续的物理内存页面供内核分配。</p>
<p>内核会为每个 NUMA 节点分配一个 kswapd
进程用于回收不经常使用的页面，还会为每个 NUMA 节点分配一个 kcompactd
进程用于内存的规整避免内存碎片。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> &#123;</span><br>        .........<br>    <span class="hljs-comment">// 页面回收进程</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">kswapd</span>;</span><br>    <span class="hljs-type">wait_queue_head_t</span> kswapd_wait;<br>    <span class="hljs-comment">// 内存规整进程</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">kcompactd</span>;</span><br>    <span class="hljs-type">wait_queue_head_t</span> kcompactd_wait;<br><br>        ..........<br>&#125; <span class="hljs-type">pg_data_t</span>;<br></code></pre></td></tr></table></figure>
<p>NUMA 节点描述符 struct pglist_data 结构中的 struct task_struct
*kswapd 属性用于指向内核为 NUMA 节点分配的 kswapd 进程。</p>
<p>kswapd_wait 用于 kswapd 进程周期性回收页面时使用到的等待队列。</p>
<p>同理 struct task_struct *kcompactd 用于指向内核为 NUMA 节点分配的
kcompactd 进程。</p>
<p>kcompactd_wait 用于 kcompactd
进程周期性规整内存时使用到的等待队列。</p>
<p>5.3 水位线的计算</p>
<p>通常情况下 WMARK_LOW 的值是 WMARK_MIN 的 1.25 倍，WMARK_HIGH 的值是
WMARK_LOW 的 1.5 倍。而 WMARK_MIN 的数值就是由这个内核参数
min_free_kbytes 来决定的。</p>
<p>5.5 setup_per_zone_wmarks 计算水位线</p>
<p>为了避免内核的直接内存回收 direct reclaim
阻塞进程影响系统的性能，所以我们需要尽量保持内存区域中的剩余内存容量尽量在
WMARK_MIN
水位线之上，但是有一些极端情况，比如突然遇到网络流量增大，需要短时间内申请大量的内存来存放网络请求数据，此时
kswapd 回收内存的速度可能赶不上内存分配的速度，从而造成直接内存回收
direct reclaim，影响系统性能。</p>
<p>在内存分配过程中，剩余内存容量处于 WMARK_MIN 与 WMARK_LOW
水位线之间会唤醒 kswapd 进程来回收内存，直到内存容量恢复到 WMARK_HIGH
水位线之上。</p>
<p>剩余内存容量低于 WMARK_MIN 水位线时就会触发直接内存回收 direct
reclaim。</p>
<p>而剩余内存容量高于 WMARK_LOW 水位线又不会唤醒 kswapd 进程，因此
kswapd 进程活动的关键范围在 WMARK_MIN 与 WMARK_LOW
之间，而为了应对这种突发的网络流量暴增，我们需要保证 kswapd
进程活动的范围大一些，这样内核就能够时刻进行内存回收使得剩余内存容量较长时间的保持在
WMARK_HIGH 水位线之上。</p>
<p>这样一来就要求 WMARK_MIN 与 WMARK_LOW 水位线之间的间距不能太小，因为
WMARK_LOW 水位线之上就不会唤醒 kswapd 进程了。</p>
<p>因此内核引入了 /proc/sys/vm/watermark_scale_factor
参数来调节水位线之间的间距。该内核参数默认值为 10，最大值为
3000。</p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/llZXDRG99NUXoMyIAf00ig">深入理解 Linux
物理内存分配全链路实现</a></p>
<p>4.3 retry</p>
<p>内核也不会直接开始
OOM，而是进入到重试流程，在重试流程开始之前内核需要调用
should_reclaim_retry 判断是否应该进行重试，重试标准：</p>
<p>如果内核已经重试了 MAX_RECLAIM_RETRIES (16)
次仍然失败，则放弃重试执行后续 OOM。</p>
<p>如果内核将所有可选内存区域中的所有可回收页面全部回收之后，仍然无法满足内存的分配，那么放弃重试执行后续
OOM。</p>
<p>如果 should_reclaim_retry = false，后面会进一步判断是否应该进行
direct_compact 的重试。</p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/e28oT6vE7cOD5M8pukn_jw">深度剖析 Linux
伙伴系统的设计与实现</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yHF5xBm5yMXDAHmE_noeCg"><font color=Red>（图片清晰版）细节拉满，80
张图带你一步一步推演 slab 内存池的设计与实现</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/CcPUAeHY0i2XAVerAWCmLA">从内核源码看
slab 内存池的创建初始化流程</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/bNAQmzeBLx2HObSNySmB-Q">深入理解 slab
cache 内存分配全链路实现</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dHLqT6KtAPZWzq_SmQZVFA"><font color=Red>深度解析
slab 内存池回收内存以及销毁全流程</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/atHXeXxx0L63w99RW7bMHg">深度解读 Linux
内核级通用内存池 —— kmalloc 体系</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FzTBx32ABR0Vtpq50pwNSA">一步一图带你构建
Linux 页表体系 —— 详解虚拟内存如何与物理内存进行映射</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/AUsgFOaePwVsPozC3F6Wjw">从内核世界透视
mmap 内存映射的本质（原理篇）</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BY3OZ6rkYYyQil_webt7Xg">从内核世界透视
mmap 内存映射的本质（源码实现篇）</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/zyLSQehjr0zQ5WemjMqluw"><font color=Red>一文聊透
Linux 缺页异常的处理 —— 图解 Page Faults</font></a></p></li>
</ul></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/i7DzYKVZZ_4C4NmIPK1gFg">linux内核-内存统计</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/kKPsZKh8q5PyAS1z4F4CCw"><font color=Red>linux内存浅析3-内存的监控</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yLM5FlYxT06axDoyTeECKg">Linux内存管理中锁使用分析及典型优化案例总结</a></li>
</ul>
<h2 id="分段与分页">分段与分页</h2>
<ul>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/cl_linux/article/details/80328608"><font color=Red>Linux进程地址空间和进程的内存分布</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qqGk1LBVDWpQP89RlLboGQ"><font color=Red>写给新手的MMU工作原理</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Vv2t-xHi9L20uGga3rjeBA">详细讲解MMU——为什么嵌入式linux没他不行？</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Q9sUNGFGrswuRYadfL2aiw">存储管理
-地址空间与重定位</a></li>
<li><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/90004914">逻辑地址、线性地址、物理地址区别</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.zhihu.com/question/420128789">Linux内存管理中，代码段和数据段映射成的线性地址重叠，不会冲突吗？</a></li>
<li><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/324210723">x86段寄存器和分段机制</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/q2wU9IbX54t_GAuc9V5r7A"><font color=Red>第九回
| Intel 内存管理两板斧：分段与分页</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7188065325198524961">从根儿上理解linux虚拟内存</a></li>
<li><a
target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008125006">Linux内存管理</a></li>
</ul>
<h3 id="缺页异常">缺页异常</h3>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/RPS_QernHHgBBKBlFJksHA"><font color=Red>这是你了解的空指针吗？</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/zyLSQehjr0zQ5WemjMqluw"><font color=Red>一文聊透
Linux 缺页异常的处理 —— 图解 Page Faults</font></a></li>
</ul>
<h2 id="内核空间">内核空间</h2>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/6658437313359512072">Linux用户空间与内核空间（理解高端内存）</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/huaerbushi521/article/details/118610996"><font color=Red>内核空间:kmalloc
vmalloc 用户空间:malloc ptmalloc</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HaYn0EoHKdY5psi3MHDpdg">详解Linux内存管理之vmalloc原理及源码实现</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ts9-sl2xQcG3nWvkNsuGeg">万字整理，肝翻Linux内存管理所有知识点</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/OQVClhh7J-u2Cui27jF7cg"><font color=Red>五万字|深入理解Linux内存管理</font></a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/5qk6VYlyEKrNFNEY7fiqvQ">Linux
实现原理 — 内存分配算法</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/kNHys4p2sXFV6wwV7VDFqQ">CMA技术原理分析</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7132761153645888004/">面试题：Linux是如何避免内存碎片的</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7132381214107353632/">Linux内存管理：NUMA技术详解（非一致内存访问架构）</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xLZRygjfjZwibmEyD7o-WA"><font color=Red>Linux中内存管理详解</font></a></li>
</ul>
<h3 id="percpu变量分配器">PERCPU变量分配器</h3>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/PNFxJuFa1PVqA9d2yklbxw">Linux内存管理系统（十）PERCPU变量分配器</a></li>
</ul>
<h3 id="slub">slub</h3>
<ul>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/u012489236/article/details/107966849">linux内存管理笔记(二十七）----slub分配器概述</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yHF5xBm5yMXDAHmE_noeCg"><font color=Red>（图片清晰版）细节拉满，80
张图带你一步一步推演 slab 内存池的设计与实现</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/dHLqT6KtAPZWzq_SmQZVFA"><font color=Red>深度解析
slab 内存池回收内存以及销毁全流程</font></a></li>
</ul>
<h3 id="overcommit_memory">overcommit_memory</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_memory<br></code></pre></td></tr></table></figure>
<p>输出的值有以下几种可能：</p>
<ul>
<li>0 – Heuristic overcommit handling.
这是缺省值，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。Heuristic的意思是“试
探式的”，内核利用某种算法猜测你的内存申请是否合理，它认为不合理就会拒绝overcommit。</li>
<li>1 – Always overcommit.
允许overcommit，对内存申请来者不拒。内核执行无内存过量使用处理。使用这个设置会增大内存超载的可能性，但也可以增强大量使用内存任务的性能。</li>
<li>2 – Don’t overcommit. 禁止overcommit。 内存拒绝等于或者大于总可用
swap 大小以及overcommit_ratio 指定的物理 RAM
比例的内存请求。如果希望减小内存过度使用的风险，这个设置就是最好的。</li>
</ul>
<h4 id="overcommit_ratio">overcommit_ratio</h4>
<p>overcommit_ratio、overcommit_kbytes在overcommit_memory=2时才有用，overcommit_kbytes非0时，overcommit_ratio无效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_ratio<br></code></pre></td></tr></table></figure>
<h4 id="overcommit_kbytes">overcommit_kbytes</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_kbytes<br></code></pre></td></tr></table></figure>
<h4
id="当前机器overcommit_memory配置">当前机器overcommit_memory配置</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_memory<br>0<br><span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_ratio<br>50<br><span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_kbytes<br>0<br></code></pre></td></tr></table></figure>
<p>单次申请的内存大小不能超过以下值，否则本次申请就会失败。</p>
<p>free memory + free swap + pagecache的大小 + SLAB</p>
<p>Linux对大部分申请内存的请求都回复"yes"，以便能跑更多更大的程序。因为申请内存后，并不会马上使用内存。这种技术叫做Overcommit。当linux发现内存不足时，会发生OOM
killer(OOM=out-of-memory)。它会选择杀死一些进程(用户态进程，不是内核线程)，以便释放内存。</p>
<p>当oom-killer发生时，linux会选择杀死哪些进程？选择进程的函数是oom_badness函数(在mm/oom_kill.c中)，该函数会计算每个进程的点数(0~1000)。点数越高，这个进程越有可能被杀死。每个进程的点数跟oom_score_adj有关，而且oom_score_adj可以被设置(-1000最低，1000最高)。</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BY3OZ6rkYYyQil_webt7Xg">从内核世界透视
mmap 内存映射的本质（源码实现篇）</a></li>
<li><a
target="_blank" rel="noopener" href="https://zhangzhuo.ltd/articles/2021/08/10/1628565705959.html"><font color=Red>内存不足：OOM</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/xsxb_yl/article/details/121412094"><font color=Red>内存分配策略：overcommit_memory</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/zyqash/article/details/122860393">Overcommitting
Memory （过度使用内存）</a></li>
</ul>
<h3 id="oom">OOM</h3>
<h4 id="min_free_kbytes">min_free_kbytes</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/sys/vm/min_free_kbytes<br>67584<br></code></pre></td></tr></table></figure>
<p>当剩余内存容量低于 WMARK_MIN 会触发下方操作：</p>
<ul>
<li>直接内存回收</li>
<li>直接内存规整</li>
<li>产生 OOM</li>
</ul>
<p>内核也不会直接开始
OOM，而是进入到重试流程，在重试流程开始之前内核需要调用
should_reclaim_retry 判断是否应该进行重试，重试标准：</p>
<p>如果内核已经重试了 MAX_RECLAIM_RETRIES (16)
次仍然失败，则放弃重试执行后续 OOM。</p>
<p>如果内核将所有可选内存区域中的所有可回收页面全部回收之后，仍然无法满足内存的分配，那么放弃重试执行后续
OOM。</p>
<p>当前free memory等于112.5MB，在 WMARK_MIN 之上，故不会触发 OOM。</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7250472767483773455">深入了解Linux
OOM Killer：一次可怕的内核事件</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/I-LidNcK1vGm3fca20Tofw">细说｜Linux Out
Of Memory机制</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/duanxz/p/10185946.html">Linux进程被杀掉（OOM
killer），查看系统日志</a></li>
<li><a target="_blank" rel="noopener" href="https://www.toutiao.com/article/6936920990001676812/">Linux
OOM是怎么回事儿</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/M6TVtCni-4c1DLXBQy3vVQ"><font color=Red>记一次解决OTA死机重启bug，如何分析与解决措施？！</font></a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/25spS5KiuV_cJ_W3c9as3A">99%的人都不知道内存充足情况下也会触发OOM！</a></li>
</ul>
<h2 id="用户空间">用户空间</h2>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/5p8zXhrhddNBxy20-fBnHw"><font color=Red>一文读懂Linux内存分配策略</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/diegodu/p/9230280.html">Linux进程分配内存的两种方式brk()
和mmap()</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/7-qM_-AqG6-Zey58g0ysPg"><font color=Red>深入理解Linux内存子系统</font></a></p></li>
</ul>
<h3 id="mmap">mmap</h3>
<ul>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/dongzhongshu/article/details/2048619">linux-mmap函数的介绍</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/S41vjVMK4QHR_2qfazsznA">这样理解mmap，挺有意思！</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7148032464730997279/">虚拟内存
&amp; I/O &amp; 零拷贝总结</a></li>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0mjI6guTETi0WmuaUHpxAg">一文读懂计算机内核态、用户态和零拷贝技术</a></li>
</ul>
<h3 id="malloc">malloc</h3>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7144253310382440960/">「linux」如何实现一个malloc</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7143515497621897769/">glibc
malloc源码分析</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7138673151717753357/">glibc内存管理那些事儿</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7136170096816423465/">malloc底层原理剖析——ptmalloc内存池</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/m-fu3LvZJNvXkjlWpTkkuQ">深入理解 glibc
malloc：内存分配器实现原理</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.csdn.net/u011334536/article/details/106150555">malloc():
memory corruption 解决方案</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/NnxZqRrQGWDXqE4lYWcNvg">腾讯一面：malloc是如何分配内存的，free怎么知道该释放多少内存？</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Js9jjkHdApMxnKxvGS-OQA">比
tcmalloc 快 43%！mimalloc 高性能背后的 5 大核心技术揭秘</a></p></li>
</ul>
<h2 id="buffercache">Buffer、Cache</h2>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7097031826853708322/?app=news_article&amp;timestamp=1657673413&amp;use_new_style=1&amp;req_id=20220713085013010204050085051F5097&amp;group_id=7097031826853708322&amp;share_token=E52D4F54-EFFF-45EB-81AE-4DDDDC89DF6A&amp;tt_from=weixin&amp;utm_source=weixin&amp;utm_medium=toutiao_ios&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;source=m_redirect"><font color=Red>Linux
内存中的缓冲区（Buffer）与缓存（Cache）</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.51cto.com/u_14286115/5194187">Cache和Buffer的区别</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.junmajinlong.com/coding/buffer_cache/">彻底搞懂Buffer和Cache的区别</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/JyZN7TG02JkcemAHWbDUVA"><font color=Red>Linux
内存中的 Cache 真的能被回收么?</font></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches<br></code></pre></td></tr></table></figure></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.csdn.net/tugouxp/article/details/119077395">page
cache和buffer cache之间的关系以及验证</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7309863686699549220/"><font color=Red>处理Page
Cache缓存会影响系统性能？是真的吗？</font></a></p></li>
</ul>
<h2 id="内存池">内存池</h2>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7125330979035906568/">带你用纯C实现一个内存池（图文结合）</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7145002269132571172/">「项目实战」高并发内存池的实现</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7220429772361548344/">C++
使用deque来实现内存池</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/z6MSHiiZ-D2OLf1KTWxgAg">在 4G
内存的机器上，申请 8G 内存会怎么样？</a></p></li>
</ul>
<h2 id="内存检测">内存检测</h2>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/6824011491897770500/">Linux内核私闯进程地址空间并修改进程内存</a></li>
</ul>
<h3 id="内核虚拟空间">内核虚拟空间</h3>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/sky-heaven/p/15567664.html">如何诊断SLUB问题【转】</a></li>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/xqjcool/article/details/105151549">内存泄漏定位思路和方法</a>
<ul>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/xqjcool/article/details/123537588">[内存泄漏]kmalloc-128
slab内存泄漏定位过程</a></li>
</ul></li>
<li><a
target="_blank" rel="noopener" href="https://www.cnblogs.com/arnoldlu/p/8568090.html"><font color=Red>Linux内存管理
(22)内存检测技术(slub_debug/kmemleak/kasan)</font></a></li>
</ul>
<p>Linux常见的内存访问错误有：</p>
<ul>
<li>越界访问(out of bounds)</li>
<li>访问已经释放的内存(use after free)</li>
<li>重复释放</li>
<li>内存泄露(memory leak)</li>
<li>栈溢出(stack overflow)</li>
</ul>
<p>不同的工具有不同的侧重点，本章主要从slub_debug、kmemleak、kasan三个工具介绍。</p>
<p>kmemleak侧重于内存泄露问题发现。</p>
<p>slub_debug和kasan有一定的重复，部分slub_debug问题需要借助slabinfo去发现；kasan更快，所有问题独立上报，缺点是需要高版本GCC支持(gcc
4.9.2 or gcc 5.0)。</p>
<h4 id="测试环境准备">测试环境准备</h4>
<p>更新内核版本到Kernel v4.4，然后编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/arnoldlu/linux.git -b running_kernel_4.4<br><br><span class="hljs-built_in">export</span> ARCH=arm64<br><br><span class="hljs-built_in">export</span> CROSS_COMPILE=aarch64-linux-gnu-<br><br>make defconfig<br><br>make bzImage -j4 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-<br></code></pre></td></tr></table></figure>
<h4 id="slub_debug">slub_debug</h4>
<p>关键词：Red Zone、Padding、Object Layout。</p>
<p>Linux内核中，小块内存大量使用slab/slub分配器，slub_debug提供了内存检测小功能。</p>
<p>内存中比较容易出错的地方有：</p>
<ul>
<li>访问已经释放的内存</li>
<li>越界访问</li>
<li>重复释放内存</li>
</ul>
<p>关于slub_debug的两篇文章：《<a
target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/426.html">图解slub</a>》《<a
target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/427.html">SLUB
DEBUG原理</a>》</p>
<h5 id="编译支持slub_debug内核">编译支持slub_debug内核</h5>
<p>首先需要打开General setup -&gt; Enable SLUB debugging
support，然后再选择Kernel hacking -&gt; Memory Debugging -&gt; SLUB
debugging on by default。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">CONFIG_SLUB=y<br><br>CONFIG_SLUB_DEBUG=y<br><br>CONFIG_SLUB_DEBUG_ON=y<br><br>CONFIG_SLUB_STATS=y<br></code></pre></td></tr></table></figure>
<h5 id="测试环境slabinfoslub.ko">测试环境：slabinfo、slub.ko</h5>
<p>通过slub.ko模拟内存异常访问，有些可以直接显示，有些需要通过slabinfo
-v来查看。</p>
<p>在tools/vm目录下，执行如下命令，生成可执行文件slabinfo。放入_install目录，打包到zImage中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make slabinfo CFLAGS=-static ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-<br></code></pre></td></tr></table></figure>
<p>将编译好的slabinfo放入sbin。</p>
<p>下面三个测试代码：https://github.com/arnoldlu/linux/tree/running_kernel_4.4/test_code/slub_debug</p>
<p>在test_code/slub_debug目录下执行make.sh，将slub.ko/slub2.ko/slub3.ko放入data。</p>
<h5 id="进行测试">进行测试</h5>
<p>启动QEMU：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-aarch64 -machine virt -cpu cortex-a57 -machine <span class="hljs-built_in">type</span>=virt -smp 2 -m 2048 -kernel <span class="hljs-built_in">arch</span>/arm64/boot/Image --append <span class="hljs-string">&quot;rdinit=/linuxrc console=ttyAMA0 loglevel=8 slub_debug=UFPZ&quot;</span> -nographic<br></code></pre></td></tr></table></figure>
<p>F：在free的时候会执行检查。</p>
<p>Z：表示Red Zone的意思。</p>
<p>P：是Poison的意思。</p>
<p>U：会记录slab的使用者信息，如果打开，会会显示分配释放对象的栈回溯。</p>
<p>在slub_debug打开SLAB_STORE_USER选项后，可以清晰地看到问题点的backtrace。</p>
<h5 id="测试结果">测试结果</h5>
<p>内存越界访问包括Redzone overwritten和Object padding overwritten。</p>
<p>重复释放对应Object already free。访问已释放内存为Posion
overwritten。</p>
<h6 id="redzone-overwritten">Redzone overwritten</h6>
<p>执行insmod data/slub.ko，使用slabinfo -v查看结果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">create_slub_error</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  buf = kmalloc(<span class="hljs-number">32</span>, GFP_KERNEL);<br>  <span class="hljs-keyword">if</span>(buf) &#123;<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0x55</span>, <span class="hljs-number">80</span>);-----------------------------------虽然分配<span class="hljs-number">32</span>字节，但是对应分配了<span class="hljs-number">64</span>字节。所以设置为<span class="hljs-number">80</span>字节访问触发异常。从buf开始的<span class="hljs-number">80</span>个字节仍然被初始化成功。<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>虽然kmalloc申请了32字节的slab缓冲区，但是内核分配的是kmalloc-64。所以memset
36字节不会报错，将36改成大于64即可。</p>
<p>一个slub Debug输出包括四大部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c">=============================================================================<br><br>BUG kmalloc<span class="hljs-number">-64</span> (Tainted: G O ): Redzone overwritten------------------------------------------------------------<span class="hljs-number">-1.</span> 问题描述：slab名称-kmalloc<span class="hljs-number">-64</span>，什么错误-Redzone overwritten。<br>-----------------------------------------------------------------------------<br><br>Disabling lock debugging due to kernel taint<br>INFO: <span class="hljs-number">0xeddb3640</span><span class="hljs-number">-0xeddb3643</span>. First byte <span class="hljs-number">0x55</span> instead of <span class="hljs-number">0xcc</span>-----------------------------------------------<span class="hljs-number">-1.1</span> 问题起始和结束地址，这里一共<span class="hljs-number">4</span>字节。<br>INFO: Allocated in <span class="hljs-number">0x55555555</span> age=<span class="hljs-number">1766</span> cpu=<span class="hljs-number">0</span> pid=<span class="hljs-number">771</span>--------------------------------------------------------<span class="hljs-number">-1.2</span> slab的分配栈回溯<br><span class="hljs-number">0x55555555</span><br><span class="hljs-number">0xbf002014</span><br>do_one_initcall+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x1d8</span><br>do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x38c</span><br>load_module+<span class="hljs-number">0x1bac</span>/<span class="hljs-number">0x1e94</span><br>SyS_init_module+<span class="hljs-number">0x14c</span>/<span class="hljs-number">0x15c</span><br>ret_fast_syscall+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x3c</span><br>INFO: Freed in do_one_initcall+<span class="hljs-number">0x78</span>/<span class="hljs-number">0x1d8</span> age=<span class="hljs-number">1766</span> cpu=<span class="hljs-number">0</span> pid=<span class="hljs-number">771</span>----------------------------------------<span class="hljs-number">-1.3</span> slab的释放栈回溯<br>do_one_initcall+<span class="hljs-number">0x78</span>/<span class="hljs-number">0x1d8</span><br>do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x38c</span><br>load_module+<span class="hljs-number">0x1bac</span>/<span class="hljs-number">0x1e94</span><br>SyS_init_module+<span class="hljs-number">0x14c</span>/<span class="hljs-number">0x15c</span><br>ret_fast_syscall+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x3c</span><br>INFO: Slab <span class="hljs-number">0xefdb5660</span> objects=<span class="hljs-number">16</span> used=<span class="hljs-number">14</span> fp=<span class="hljs-number">0xeddb3700</span> flags=<span class="hljs-number">0x0081</span>----------------------------------<span class="hljs-number">-1.4</span> slab的地址，以及其它信息。<br>INFO: Object <span class="hljs-number">0xeddb3600</span> @offset=<span class="hljs-number">1536</span> fp=<span class="hljs-number">0x55555555</span>----------------------------------------------------------<span class="hljs-number">-1.5</span> 当前Object起始，及相关信息<br><br>Bytes b4 eddb35f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ-----------<span class="hljs-number">-2.</span> 问题slab对象内容。<span class="hljs-number">2.1</span> 打印问题slab对象内容之前一些字节。<br>Object eddb3600: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUUUUUUUUUUUUUU--------<span class="hljs-number">-2.2</span> slab对象内容，全部为<span class="hljs-number">0x55</span>。<br>Object eddb3610: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUUUUUUUUUUUUUU<br>Object eddb3620: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUUUUUUUUUUUUUU<br>Object eddb3630: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUUUUUUUUUUUUUU<br>Redzone eddb3640: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUU---------------------------------------------------------------------------------<span class="hljs-number">-2.3</span> Redzone内容，问题出在这里。<br>Padding eddb36e8: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ-----------<span class="hljs-number">-2.4</span> Padding内容，为了对象对齐而补充。<br>Padding eddb36f8: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZ<br>CPU: <span class="hljs-number">2</span> PID: <span class="hljs-number">773</span> Comm: slabinfo Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">93</span>-------------------------------------------------------<span class="hljs-number">-3.</span> 检查问题点的栈打印，这里是由于slabinfo找出来的。<br>Hardware name: ARM-Versatile Express<br>[&lt;c0016588&gt;] (unwind_backtrace) from [&lt;c0013070&gt;] (show_stack+<span class="hljs-number">0x10</span>/<span class="hljs-number">0x14</span>)<br>[&lt;c0013070&gt;] (show_stack) from [&lt;c0244130&gt;] (dump_stack+<span class="hljs-number">0x78</span>/<span class="hljs-number">0x88</span>)<br>[&lt;c0244130&gt;] (dump_stack) from [&lt;c00e1874&gt;] (check_bytes_and_report+<span class="hljs-number">0xd0</span>/<span class="hljs-number">0x10c</span>)<br>[&lt;c00e1874&gt;] (check_bytes_and_report) from [&lt;c00e1a14&gt;] (check_object+<span class="hljs-number">0x164</span>/<span class="hljs-number">0x234</span>)<br>[&lt;c00e1a14&gt;] (check_object) from [&lt;c00e29bc&gt;] (validate_slab_slab+<span class="hljs-number">0x198</span>/<span class="hljs-number">0x1bc</span>)<br>[&lt;c00e29bc&gt;] (validate_slab_slab) from [&lt;c00e578c&gt;] (validate_store+<span class="hljs-number">0xac</span>/<span class="hljs-number">0x190</span>)<br>[&lt;c00e578c&gt;] (validate_store) from [&lt;c0146780&gt;] (kernfs_fop_write+<span class="hljs-number">0xb8</span>/<span class="hljs-number">0x1b4</span>)<br>[&lt;c0146780&gt;] (kernfs_fop_write) from [&lt;c00ebfc4&gt;] (__vfs_write+<span class="hljs-number">0x1c</span>/<span class="hljs-number">0xd8</span>)<br>[&lt;c00ebfc4&gt;] (__vfs_write) from [&lt;c00ec808&gt;] (vfs_write+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x170</span>)<br>[&lt;c00ec808&gt;] (vfs_write) from [&lt;c00ed008&gt;] (SyS_write+<span class="hljs-number">0x3c</span>/<span class="hljs-number">0x90</span>)<br>[&lt;c00ed008&gt;] (SyS_write) from [&lt;c000f3c0&gt;] (ret_fast_syscall+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x3c</span>)<br>FIX kmalloc<span class="hljs-number">-64</span>: Restoring <span class="hljs-number">0xeddb3640</span><span class="hljs-number">-0xeddb3643</span>=<span class="hljs-number">0xcc</span>---------------------------------------------------------<span class="hljs-number">-4.</span> 问题点是如何被解决的，此处恢复<span class="hljs-number">4</span>个字节为<span class="hljs-number">0xcc</span>。<br></code></pre></td></tr></table></figure>
<h6 id="object-padding-overwritten">Object padding overwritten</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">create_slub_error</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">int</span> i;<br><br>  buf = kmalloc(<span class="hljs-number">32</span>, GFP_KERNEL);<br>  <span class="hljs-keyword">if</span>(buf) &#123;<br>    buf[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x55</span>;------------------------------------------------------------------------向左越界访问<br>    kfree(buf);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>执行insmod data/slub4.ko，结果如下。</p>
<p>这里的越界访问和之前有点不一样的是，这里向左越界。覆盖到了Padding区域。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c">al: slub error test init<br>=============================================================================<br>BUG kmalloc<span class="hljs-number">-128</span> (Tainted: G O ): Object padding overwritten------------------------------------------------------覆盖到Padding区域<br>-----------------------------------------------------------------------------<br><br>Disabling lock debugging due to kernel taint<br>INFO: <span class="hljs-number">0xffff80007767e9ff</span><span class="hljs-number">-0xffff80007767e9ff</span>. First byte <span class="hljs-number">0x55</span> instead of <span class="hljs-number">0x5a</span><br>INFO: Allocated in call_usermodehelper_setup+<span class="hljs-number">0x44</span>/<span class="hljs-number">0xb8</span> age=<span class="hljs-number">1</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">789</span><br>alloc_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x188</span><br>___slab_alloc.constprop<span class="hljs-number">.30</span>+<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x440</span><br>__slab_alloc.isra<span class="hljs-number">.27</span>.constprop<span class="hljs-number">.29</span>+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x38</span><br>kmem_cache_alloc+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x260</span><br>call_usermodehelper_setup+<span class="hljs-number">0x44</span>/<span class="hljs-number">0xb8</span><br>/ # kobject_uevent_env+<span class="hljs-number">0x494</span>/<span class="hljs-number">0x500</span><br>kobject_uevent+<span class="hljs-number">0x10</span>/<span class="hljs-number">0x18</span><br>load_module+<span class="hljs-number">0x18cc</span>/<span class="hljs-number">0x1d78</span><br>SyS_init_module+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x178</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Slab <span class="hljs-number">0xffff7bffc2dd9f80</span> objects=<span class="hljs-number">16</span> used=<span class="hljs-number">9</span> fp=<span class="hljs-number">0xffff80007767ea00</span> flags=<span class="hljs-number">0x4081</span><br>INFO: Object <span class="hljs-number">0xffff80007767e800</span> @offset=<span class="hljs-number">2048</span> fp=<span class="hljs-number">0xffff80007767ea00</span><br><br>Bytes b4 ffff80007767e7f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Object ffff80007767e800: <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> e8 <span class="hljs-number">67</span> <span class="hljs-number">77</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff ..........gw....<br>Object ffff80007767e810: <span class="hljs-number">08</span> e8 <span class="hljs-number">67</span> <span class="hljs-number">77</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff f8 <span class="hljs-number">83</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff ..gw............<br>Object ffff80007767e820: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">6</span>e aa <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff .........n......<br>Object ffff80007767e830: <span class="hljs-number">00</span> <span class="hljs-number">23</span> <span class="hljs-number">67</span> <span class="hljs-number">78</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">18</span> <span class="hljs-number">23</span> <span class="hljs-number">67</span> <span class="hljs-number">78</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff .<span class="hljs-meta">#gx.....#gx....</span><br>Object ffff80007767e840: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff80007767e850: b8 <span class="hljs-number">8</span>e <span class="hljs-number">32</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">00</span> <span class="hljs-number">23</span> <span class="hljs-number">67</span> <span class="hljs-number">78</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff .<span class="hljs-number">.2</span>......<span class="hljs-meta">#gx....</span><br>Object ffff80007767e860: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff80007767e870: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Redzone ffff80007767e880: cc cc cc cc cc cc cc cc ........<br>Padding ffff80007767e9c0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff80007767e9d0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff80007767e9e0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff80007767e9f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">55</span> ZZZZZZZZZZZZZZZU<br>CPU: <span class="hljs-number">0</span> PID: <span class="hljs-number">790</span> Comm: mdev Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">116</span><br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff800000089738&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x108</span><br>[&lt;ffff800000089854&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff8000003253c4&gt;] dump_stack+<span class="hljs-number">0x94</span>/<span class="hljs-number">0xd0</span><br>[&lt;ffff800000196460&gt;] print_trailer+<span class="hljs-number">0x128</span>/<span class="hljs-number">0x1b8</span><br>[&lt;ffff800000196848&gt;] check_bytes_and_report+<span class="hljs-number">0xd8</span>/<span class="hljs-number">0x118</span><br>[&lt;ffff800000196928&gt;] check_object+<span class="hljs-number">0xa0</span>/<span class="hljs-number">0x240</span><br>[&lt;ffff8000001987e0&gt;] free_debug_processing+<span class="hljs-number">0x128</span>/<span class="hljs-number">0x380</span><br>[&lt;ffff80000019a1cc&gt;] __slab_free+<span class="hljs-number">0x344</span>/<span class="hljs-number">0x4a0</span><br>[&lt;ffff80000019ab94&gt;] kfree+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x220</span><br>[&lt;ffff8000000c8278&gt;] umh_complete+<span class="hljs-number">0x58</span>/<span class="hljs-number">0x68</span><br>[&lt;ffff8000000c83d8&gt;] call_usermodehelper_exec_async+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x170</span><br>[&lt;ffff800000085c50&gt;] ret_from_fork+<span class="hljs-number">0x10</span>/<span class="hljs-number">0x40</span><br>FIX kmalloc<span class="hljs-number">-128</span>: Restoring <span class="hljs-number">0xffff80007767e9ff</span><span class="hljs-number">-0xffff80007767e9ff</span>=<span class="hljs-number">0x5a</span>---------------------------------------------------------问题处理是将对应字节恢复为<span class="hljs-number">0x5a</span>。<br></code></pre></td></tr></table></figure>
<h6 id="object-already-free">Object already free</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">create_slub_error</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  buf = kmalloc(<span class="hljs-number">32</span>, GFP_KERNEL);<br>  <span class="hljs-keyword">if</span>(buf) &#123;<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0x55</span>, <span class="hljs-number">32</span>);<br>    kfree(buf);<br>    printk(<span class="hljs-string">&quot;al: Object already freed&quot;</span>);<br>    kfree(buf);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>内核中free执行流程如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">kfree<br>  -&gt;slab_free<br>    -&gt;__slab_free<br>      -&gt;kmem_cache_debug<br>        -&gt;free_debug_processing         -&gt;on_freelist<br></code></pre></td></tr></table></figure>
<p>执行insmod data/slub2.ko，结果如下。</p>
<p>重复释放，是对同一个对象连续释放了多次。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c">al: slub error test init<br>al: Object already freed<br>=============================================================================<br>BUG kmalloc<span class="hljs-number">-128</span> (Tainted: G B O ): Object already <span class="hljs-built_in">free</span>------------------------------------------------------------------在<span class="hljs-number">64</span>位系统，<span class="hljs-number">32</span>字节的kmalloc变成了kmalloc<span class="hljs-number">-128</span>，问题类型是：Object already <span class="hljs-built_in">free</span>，也即重复释放。<br>-----------------------------------------------------------------------------<br><br>INFO: Allocated in create_slub_error+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x80</span> [slub2] age=<span class="hljs-number">0</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">791</span>------------------------------------内存分配点栈回溯<br>alloc_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x188</span><br>___slab_alloc.constprop<span class="hljs-number">.30</span>+<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x440</span><br>__slab_alloc.isra<span class="hljs-number">.27</span>.constprop<span class="hljs-number">.29</span>+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x38</span><br>kmem_cache_alloc+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x260</span><br>create_slub_error+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x80</span> [slub2]<br>my_test_init+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x28</span> [slub2]<br>do_one_initcall+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x1a0</span><br>do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x1cc</span><br>load_module+<span class="hljs-number">0x18dc</span>/<span class="hljs-number">0x1d78</span><br>SyS_init_module+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x178</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Freed in create_slub_error+<span class="hljs-number">0x50</span>/<span class="hljs-number">0x80</span> [slub2] age=<span class="hljs-number">0</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">791</span>------------------------------------------内存释放点栈回溯<br>free_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x380</span><br>__slab_free+<span class="hljs-number">0x344</span>/<span class="hljs-number">0x4a0</span><br>kfree+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x220</span><br>create_slub_error+<span class="hljs-number">0x50</span>/<span class="hljs-number">0x80</span> [slub2]<br>my_test_init+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x28</span> [slub2]<br>do_one_initcall+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x1a0</span><br>do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x1cc</span><br>load_module+<span class="hljs-number">0x18dc</span>/<span class="hljs-number">0x1d78</span><br>SyS_init_module+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x178</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Slab <span class="hljs-number">0xffff7bffc2dda800</span> objects=<span class="hljs-number">16</span> used=<span class="hljs-number">7</span> fp=<span class="hljs-number">0xffff8000776a0800</span> flags=<span class="hljs-number">0x4081</span><br>INFO: Object <span class="hljs-number">0xffff8000776a0800</span> @offset=<span class="hljs-number">2048</span> fp=<span class="hljs-number">0xffff8000776a0a00</span><br><br>Bytes b4 ffff8000776a07f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Object ffff8000776a0800: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk-----------------内存内容打印，供<span class="hljs-number">128</span>字节。<br>Object ffff8000776a0810: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff8000776a0820: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff8000776a0830: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff8000776a0840: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff8000776a0850: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff8000776a0860: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff8000776a0870: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> a5 kkkkkkkkkkkkkkk.<br>Redzone ffff8000776a0880: bb bb bb bb bb bb bb bb ........<br>Padding ffff8000776a09c0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff8000776a09d0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff8000776a09e0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff8000776a09f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>CPU: <span class="hljs-number">1</span> PID: <span class="hljs-number">791</span> Comm: insmod Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">116</span>--------------------------------------------------------------此处问题在insmod就发现了，所以检查出问题的进程就是insmod。<br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff800000089738&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x108</span><br>[&lt;ffff800000089854&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff8000003253c4&gt;] dump_stack+<span class="hljs-number">0x94</span>/<span class="hljs-number">0xd0</span><br>[&lt;ffff800000196460&gt;] print_trailer+<span class="hljs-number">0x128</span>/<span class="hljs-number">0x1b8</span><br>[&lt;ffff800000198954&gt;] free_debug_processing+<span class="hljs-number">0x29c</span>/<span class="hljs-number">0x380</span><br>[&lt;ffff80000019a1cc&gt;] __slab_free+<span class="hljs-number">0x344</span>/<span class="hljs-number">0x4a0</span><br>[&lt;ffff80000019ab94&gt;] kfree+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x220</span><br>[&lt;ffff7ffffc008060&gt;] create_slub_error+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x80</span> [slub2]<br>[&lt;ffff7ffffc00a014&gt;] my_test_init+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x28</span> [slub2]<br>[&lt;ffff800000082930&gt;] do_one_initcall+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x1a0</span><br>[&lt;ffff80000014647c&gt;] do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x1cc</span><br>[&lt;ffff800000120704&gt;] load_module+<span class="hljs-number">0x18dc</span>/<span class="hljs-number">0x1d78</span><br>[&lt;ffff800000120cf0&gt;] SyS_init_module+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x178</span><br>[&lt;ffff800000085cb0&gt;] el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>FIX kmalloc<span class="hljs-number">-128</span>: Object at <span class="hljs-number">0xffff8000776a0800</span> not freed------------------------------------------------------------------处理的结果是，此处slab 对象是没有被释放。<br></code></pre></td></tr></table></figure>
<h6 id="poison-overwritten">Poison overwritten</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">create_slub_error</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  buf = kmalloc(<span class="hljs-number">32</span>, GFP_KERNEL);-----------------------此时的buf内容都是<span class="hljs-number">0x6B</span><br>  <span class="hljs-keyword">if</span>(buf) &#123;<br>    kfree(buf);<br>    printk(<span class="hljs-string">&quot;al: Access after free&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0x55</span>, <span class="hljs-number">32</span>);-----------------------------虽然被释放，但是<span class="hljs-built_in">memset</span>仍然生效了变成了<span class="hljs-number">0x55</span>。<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>执行insmod data/slub3.ko ，使用slabinfo -v查看结果。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c">=============================================================================<br><br>BUG kmalloc<span class="hljs-number">-128</span> (Tainted: G B O ): Poison overwritten----------------------------------------------slab名称为kmalloc<span class="hljs-number">-64</span>，问题类型是：Poison overwritten，即访问已释放内存。<br>-----------------------------------------------------------------------------<br><br><br><br>INFO: <span class="hljs-number">0xffff800077692800</span><span class="hljs-number">-0xffff80007769281f</span>. First byte <span class="hljs-number">0x55</span> instead of <span class="hljs-number">0x6b</span><br>INFO: Allocated in create_slub_error+<span class="hljs-number">0x28</span>/<span class="hljs-number">0xf0</span> [slub3] age=<span class="hljs-number">1089</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">793</span>----------分配点的栈回溯<br>alloc_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x188</span><br>___slab_alloc.constprop<span class="hljs-number">.30</span>+<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x440</span><br>__slab_alloc.isra<span class="hljs-number">.27</span>.constprop<span class="hljs-number">.29</span>+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x38</span><br>kmem_cache_alloc+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x260</span><br>create_slub_error+<span class="hljs-number">0x28</span>/<span class="hljs-number">0xf0</span> [slub3]<br><span class="hljs-number">0xffff7ffffc00e014</span><br>do_one_initcall+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x1a0</span><br>do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x1cc</span><br>load_module+<span class="hljs-number">0x18dc</span>/<span class="hljs-number">0x1d78</span><br>SyS_init_module+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x178</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Freed in create_slub_error+<span class="hljs-number">0x80</span>/<span class="hljs-number">0xf0</span> [slub3] age=<span class="hljs-number">1089</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">793</span>--------------释放点的栈回溯<br>free_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x380</span><br>__slab_free+<span class="hljs-number">0x344</span>/<span class="hljs-number">0x4a0</span><br>kfree+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x220</span><br>create_slub_error+<span class="hljs-number">0x80</span>/<span class="hljs-number">0xf0</span> [slub3]<br><span class="hljs-number">0xffff7ffffc00e014</span><br>do_one_initcall+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x1a0</span><br>do_init_module+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x1cc</span><br>load_module+<span class="hljs-number">0x18dc</span>/<span class="hljs-number">0x1d78</span><br>SyS_init_module+<span class="hljs-number">0x150</span>/<span class="hljs-number">0x178</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Slab <span class="hljs-number">0xffff7bffc2dda480</span> objects=<span class="hljs-number">16</span> used=<span class="hljs-number">16</span> fp=<span class="hljs-number">0</span>x (null) flags=<span class="hljs-number">0x4080</span><br>INFO: Object <span class="hljs-number">0xffff800077692800</span> @offset=<span class="hljs-number">2048</span> fp=<span class="hljs-number">0xffff800077692400</span><br><br><br><br>Bytes b4 ffff8000776927f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Object ffff800077692800: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUUUUUUUUUUUUUU--------前<span class="hljs-number">32</span>字节仍然被修改成功。<br>Object ffff800077692810: <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> <span class="hljs-number">55</span> UUUUUUUUUUUUUUUU<br>Object ffff800077692820: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff800077692830: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff800077692840: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff800077692850: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff800077692860: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> kkkkkkkkkkkkkkkk<br>Object ffff800077692870: <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> <span class="hljs-number">6b</span> a5 kkkkkkkkkkkkkkk.<br>Redzone ffff800077692880: bb bb bb bb bb bb bb bb ........<br>Padding ffff8000776929c0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff8000776929d0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff8000776929e0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>Padding ffff8000776929f0: <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a <span class="hljs-number">5</span>a ZZZZZZZZZZZZZZZZ<br>CPU: <span class="hljs-number">0</span> PID: <span class="hljs-number">795</span> Comm: slabinfo Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">116</span><br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff800000089738&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x108</span><br>[&lt;ffff800000089854&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff8000003253c4&gt;] dump_stack+<span class="hljs-number">0x94</span>/<span class="hljs-number">0xd0</span><br>[&lt;ffff800000196460&gt;] print_trailer+<span class="hljs-number">0x128</span>/<span class="hljs-number">0x1b8</span><br>[&lt;ffff800000196848&gt;] check_bytes_and_report+<span class="hljs-number">0xd8</span>/<span class="hljs-number">0x118</span><br>[&lt;ffff800000196a54&gt;] check_object+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x240</span><br>[&lt;ffff800000197920&gt;] alloc_debug_processing+<span class="hljs-number">0x108</span>/<span class="hljs-number">0x188</span><br>[&lt;ffff800000199670&gt;] ___slab_alloc.constprop<span class="hljs-number">.30</span>+<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x440</span><br>[&lt;ffff8000001996dc&gt;] __slab_alloc.isra<span class="hljs-number">.27</span>.constprop<span class="hljs-number">.29</span>+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x38</span><br>[&lt;ffff8000001998dc&gt;] kmem_cache_alloc+<span class="hljs-number">0x1ec</span>/<span class="hljs-number">0x260</span><br>[&lt;ffff8000001d42fc&gt;] seq_open+<span class="hljs-number">0x34</span>/<span class="hljs-number">0x90</span><br>[&lt;ffff80000022059c&gt;] kernfs_fop_open+<span class="hljs-number">0x194</span>/<span class="hljs-number">0x370</span><br>[&lt;ffff8000001afb04&gt;] do_dentry_open+<span class="hljs-number">0x214</span>/<span class="hljs-number">0x318</span><br>[&lt;ffff8000001b0dc8&gt;] vfs_open+<span class="hljs-number">0x58</span>/<span class="hljs-number">0x68</span><br>[&lt;ffff8000001bf338&gt;] path_openat+<span class="hljs-number">0x460</span>/<span class="hljs-number">0xdf0</span><br>[&lt;ffff8000001c0ff0&gt;] do_filp_open+<span class="hljs-number">0x60</span>/<span class="hljs-number">0xe0</span><br>[&lt;ffff8000001b117c&gt;] do_sys_open+<span class="hljs-number">0x12c</span>/<span class="hljs-number">0x218</span><br>[&lt;ffff8000001fd53c&gt;] compat_SyS_open+<span class="hljs-number">0x1c</span>/<span class="hljs-number">0x28</span><br>[&lt;ffff800000085cb0&gt;] el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>FIX kmalloc<span class="hljs-number">-128</span>: Restoring <span class="hljs-number">0xffff800077692800</span><span class="hljs-number">-0xffff80007769281f</span>=<span class="hljs-number">0x6b</span><br><br><br><br>FIX kmalloc<span class="hljs-number">-128</span>: Marking all objects used<br>SLUB: kmalloc<span class="hljs-number">-128</span> <span class="hljs-number">210</span> slabs counted but counter=<span class="hljs-number">211</span><br>slabinfo (<span class="hljs-number">795</span>) used greatest <span class="hljs-built_in">stack</span> depth: <span class="hljs-number">12976</span> bytes left<br></code></pre></td></tr></table></figure>
<h5 id="slub-memkeak">slub-memkeak</h5>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/341356576">slab申请释放和追踪</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.csdn.net/bin_linux96/article/details/79496803">内存泄露调试分析(一)</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.csdn.net/Ivan804638781/article/details/112884838">【内存管理】【slab】/sys/kernel/slab/＜slab
name＞/trace解析</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.csdn.net/monkeyzh123/article/details/119840691"><font color=Red>SLAB内存泄露分析实践</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://blog.arstercz.com/what-to-do-when-linux-slab-memory-leak/"><font color=Red>发生
SLAB 内存泄漏该怎么办</font></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /sys/kernel/slab/amdgpu_fence/<br><span class="hljs-built_in">echo</span> 1 &gt; trace  &amp;&amp; <span class="hljs-built_in">sleep</span> 10 &amp;&amp; <span class="hljs-built_in">echo</span> 0 &gt; trace<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> alloc_calls<br>    173 amdgpu_fence_emit+0x38/0x168 [amdgpu] age=104/13966/19586 pid=41-279 cpus=0-2<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> free_calls<br>    117 &lt;not-available&gt; age=4294919470 pid=0 cpus=0<br>    56 amdgpu_fence_free+0x30/0x38 [amdgpu] age=169/10203/25074 pid=0-1419 cpus=0-2<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /var/log/kern.log<br><br>2024-01-10 13:39:15 wujing-PC kernel: [  166.228864] Hardware name: BXC BM6J80/TBD, BIOS KL4.23.TF.N.021.210510.R 05/10/21 15:33:37<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.237115] Call trace:<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.239550]  dump_backtrace+0x0/0x190<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.243200]  show_stack+0x14/0x20<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.246503]  dump_stack+0xa8/0xcc<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.249806]  free_debug_processing+0x19c/0x3a0<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.254237]  __slab_free+0x230/0x3f8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.257801]  kmem_cache_free+0x200/0x220<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.261801]  amdgpu_fence_free+0x30/0x38 [amdgpu]<br><br>2024-01-10 13:39:15 wujing-PC kernel: [  166.266493]  rcu_process_callbacks+0x2d8/0x500<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.270925]  __do_softirq+0x110/0x2e8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.274576]  irq_exit+0x9c/0xb8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.277706]  __handle_domain_irq+0x64/0xb8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.281790]  gic_handle_irq+0x7c/0x178<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.285526]  el1_irq+0xb0/0x140<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.288656]  arch_cpu_idle+0x2c/0x1b0<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.292305]  do_idle+0x1d4/0x238<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.295521]  cpu_startup_entry+0x24/0x28<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.299432]  secondary_start_kernel+0x158/0x168<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.304153] TRACE amdgpu_fence free 0x000000004f170f7a inuse=6 fp=0x00000000ef60c3a4<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.311886] Object 000000004f170f7a: 00 00 00 00 6b 6b 6b 6b 38 b9 e2 00 00 00 ff ff  ....kkkk8.......<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.321180] Object 00000000de513b7f: b0 7c d3 7e 20 80 ff ff f8 41 cc 00 00 00 ff ff  .|.~ ....A......<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.330473] Object 00000000dca91573: 60 aa db 87 20 80 ff ff 60 aa db 87 20 80 ff ff  `... ...`... ...<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.339767] Object 00000000cc2e4487: 04 4d 68 dc 20 80 ff ff 00 00 00 00 00 00 00 00  .Mh. ...........<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.349060] Object 00000000befbbd4b: 89 02 00 00 6b 6b 6b 6b 07 00 00 00 00 00 00 00  ....kkkk........<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.358353] Object 00000000a4cce3a9: d2 8a c4 b0 24 00 00 00 00 00 00 00 6b 6b 6b 6b  ....$.......kkkk<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.367646] Object 00000000e8ae45cf: 98 4c 68 dc 20 80 ff ff                          .Lh. ...<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.376247] CPU: 2 PID: 21 Comm: ksoftirqd/2 Kdump: loaded Tainted: G           O      4.19.0-arm64-desktop-tyy-5819-ext4-slub-debug-kmemleak <span class="hljs-comment">#5819</span><br>2024-01-10 13:39:15 wujing-PC kernel: [  166.389448] Hardware name: BXC BM6J80/TBD, BIOS KL4.23.TF.N.021.210510.R 05/10/21 15:33:37<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.397699] Call trace:<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.400136]  dump_backtrace+0x0/0x190<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.403786]  show_stack+0x14/0x20<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.407089]  dump_stack+0xa8/0xcc<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.410393]  free_debug_processing+0x19c/0x3a0<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.414824]  __slab_free+0x230/0x3f8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.418387]  kmem_cache_free+0x200/0x220<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.422410]  amdgpu_fence_free+0x30/0x38 [amdgpu]<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.427103]  rcu_process_callbacks+0x2d8/0x500<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.431535]  __do_softirq+0x110/0x2e8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.435186]  run_ksoftirqd+0x30/0x40<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.438751]  smpboot_thread_fn+0x160/0x1a8<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.442835]  kthread+0x128/0x130<br>2024-01-10 13:39:15 wujing-PC kernel: [  166.446052]  ret_from_fork+0x10/0x18<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="kmemleak">kmemleak</h4>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/fTBOd-lYViFNX0fV61mQyg">细说｜Linux内存泄漏检测实现原理与实现</a></li>
</ul>
<p>kmemleak是内核提供的一种检测内存泄露工具，启动一个内核线程扫描内存，并打印发现新的未引用对象数量。</p>
<h5 id="支持kmemleak内核选项">支持kmemleak内核选项</h5>
<p>要使用kmemlieak，需要打开如下内核选项。</p>
<p>Kernel hacking-&gt;Memory Debugging-&gt;Kernel memory leak
detector：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONFIG_HAVE_DEBUG_KMEMLEAK=y<br>CONFIG_DEBUG_KMEMLEAK=y<br>CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=400<br><span class="hljs-comment"># CONFIG_DEBUG_KMEMLEAK_TEST is not set</span><br>CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF=y---------或者关闭此选项，则不需要在命令行添加kmemleak=on。<br></code></pre></td></tr></table></figure>
<h5 id="构造测试环境">构造测试环境</h5>
<p>同时还需要在内核启动命令行中添加kmemleak=on。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-aarch64 -machine virt -cpu cortex-a57 -machine <span class="hljs-built_in">type</span>=virt -smp 2 -m 2048 -kernel <span class="hljs-built_in">arch</span>/arm64/boot/Image --append <span class="hljs-string">&quot;rdinit=/linuxrc console=ttyAMA0 loglevel=8 kmemleak=on&quot;</span> -nographic<br></code></pre></td></tr></table></figure>
<p>测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *buf;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_kmemleak</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  buf = kmalloc(<span class="hljs-number">120</span>, GFP_KERNEL);<br>  buf = vmalloc(<span class="hljs-number">4096</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="进行测试-1">进行测试</h5>
<p>进行kmemleak测试之前，需要写入scan触发扫描操作。</p>
<p>然后通过读kmemlean节点读取相关信息。</p>
<ul>
<li>打开kmemlean扫描功能：<code>echo scan &gt; /sys/kernel/debug/kmemleak</code></li>
<li>加载问题module：<code>insmod data/kmemleak.ko</code></li>
<li>等待问题发现：kmemleak: 2 new suspected memory leaks (see
/sys/kernel/debug/kmemleak)</li>
<li>查看kmemleak结果：<code>cat /sys/kernel/debug/kmemleak</code></li>
</ul>
<h5 id="分析测试结果">分析测试结果</h5>
<p>每处泄露，都标出泄露地址和大小；相关进程信息；内存内容dump；栈回溯。</p>
<p>kmemleak会提示内存泄露可疑对象的具体栈调用信息、可疑对象的大小、使用哪个函数分配、二进制打印。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">unreferenced object <span class="hljs-number">0xede22dc0</span> (size <span class="hljs-number">128</span>):-------------------------------------第一处可疑泄露<span class="hljs-number">128</span>字节<br>  comm <span class="hljs-string">&quot;insmod&quot;</span>, pid <span class="hljs-number">765</span>, jiffies <span class="hljs-number">4294941257</span> (age <span class="hljs-number">104.920</span>s)--------------------相关进程信息<br>  hex <span class="hljs-title function_">dump</span> <span class="hljs-params">(first <span class="hljs-number">32</span> bytes)</span>:---------------------------------------------------二进制打印<br>    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk<br>    6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk<br>  backtrace:-------------------------------------------------------------------栈回溯<br>    [&lt;bf002014&gt;] 0xbf002014<br>    [&lt;c000973c&gt;] do_one_initcall+0x90/0x1d8<br>    [&lt;c00a71f4&gt;] do_init_module+0x60/0x38c<br>    [&lt;c0086898&gt;] load_module+0x1bac/0x1e94<br>    [&lt;c0086ccc&gt;] SyS_init_module+0x14c/0x15c<br>    [&lt;c000f3c0&gt;] ret_fast_syscall+0x0/0x3c<br>    [&lt;ffffffff&gt;] 0xffffffff<br>unreferenced object 0<span class="hljs-title function_">xf12ba000</span> <span class="hljs-params">(size <span class="hljs-number">4096</span>)</span>:<br>  comm &quot;insmod&quot;, pid 765, jiffies 4294941257 <span class="hljs-params">(age <span class="hljs-number">104.920</span>s)</span><br>  hex <span class="hljs-title function_">dump</span> <span class="hljs-params">(first <span class="hljs-number">32</span> bytes)</span>:<br>    d8 21 00 00 02 18 00 00 e4 21 00 00 02 18 00 00  .!.......!......<br>    46 22 00 00 02 18 00 00 52 22 00 00 02 18 00 00  F&quot;......R&quot;......<br>  backtrace:<br>    [&lt;c00d77c8&gt;] vmalloc+0x2c/0x34<br>    [&lt;bf002014&gt;] 0xbf002014<br>    [&lt;c000973c&gt;] do_one_initcall+0x90/0x1d8<br>    [&lt;c00a71f4&gt;] do_init_module+0x60/0x38c<br>    [&lt;c0086898&gt;] load_module+0x1bac/0x1e94<br>    [&lt;c0086ccc&gt;] SyS_init_module+0x14c/0x15c<br>    [&lt;c000f3c0&gt;] ret_fast_syscall+0x0/0x3c<br>    [&lt;ffffffff&gt;] 0xffffffff<br></code></pre></td></tr></table></figure>
<h4 id="kasan">kasan</h4>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/VoxZEXnGQNzIx8STBcQzkQ">内核并发消杀器（KCSAN）技术分析</a></li>
</ul>
<p>相关文档阅读：《<a
target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/1608_tengr_kasan/index.html">Kasan
- Linux 内核的内存检测工具</a>》《<a
target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/424.html">KASAN实现原理</a>》。</p>
<p>kasan暂不支持32位ARM，支持ARM64和X86。</p>
<p>kasan是一个动态检查内存错误的工具，可以检查内存越界访问、使用已释放内存、重复释放以及栈溢出。</p>
<h5 id="使能kasan">使能kasan</h5>
<p>使用kasan，必须打开CONFIG_KASAN。</p>
<p>Kernel hacking-&gt;Memory debugging-&gt;KASan: runtime memory
debugger</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONFIG_SLUB_DEBUG=y <span class="hljs-comment"># 有些版本要求先开启 SLUB 分配器的调试配置宏 CONFIG_SLUB_DEBUG，才能看到 KASAN 的配置菜单项。最新版本已经不需要了，但是建议开启，因为可以打印更多有用的信息。</span><br>CONFIG_HAVE_ARCH_KASAN=y<br>CONFIG_KASAN=y<br><span class="hljs-comment"># CONFIG_KASAN_OUTLINE is not set</span><br>CONFIG_KASAN_INLINE=y<br>CONFIG_TEST_KASAN=m<br>CONFIG_STACKTRACE=y <span class="hljs-comment"># 为了更好地缺陷检查和报告</span><br></code></pre></td></tr></table></figure>
<h5 id="代码分析">代码分析</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">kasan_report<br><br>  -&gt;kasan_report_error<br><br>    -&gt;print_error_description<br><br>    -&gt;print_address_description<br><br>    -&gt;print_shadow_for_address<br></code></pre></td></tr></table></figure>
<h5 id="测试用及分析">测试用及分析</h5>
<p>kasan提供了一个测试程序test_kacan.c，将其编译成模块，加载到内核。可以模拟很多内存错误场景。</p>
<p>kasan可以检测到越界访问、访问已释放内存、重复释放等类型错误，其中重复释放借助于slub_debug。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">insmod data/kasan.ko<br></code></pre></td></tr></table></figure>
<p>越界访问包括slab越界、栈越界、全局变量越界；访问已释放内存use-after-free；重复释放可以被slub_debug识别。</p>
<h6 id="slab-out-of-bounds">slab-out-of-bounds</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span> __init <span class="hljs-title function_">kmalloc_oob_right</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">123</span>;<br><br>    pr_info(<span class="hljs-string">&quot;out-of-bounds to right\n&quot;</span>);<br>    ptr = kmalloc(size, GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (!ptr) &#123;<br>        pr_err(<span class="hljs-string">&quot;Allocation failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ptr[size] = <span class="hljs-string">&#x27;x&#x27;</span>;<br>    kfree(ptr);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此种错误类型是对slab的越界访问，包括左侧、右侧、扩大、缩小后越界访问。除了数组赋值，还包括memset、指针访问等等。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c">al: kasan error test init<br>kasan test: kmalloc_oob_right out-of-bounds to right<br>==================================================================<br>BUG: KASAN: slab-out-of-bounds in kmalloc_oob_right+<span class="hljs-number">0xa4</span>/<span class="hljs-number">0xe0</span> [kasan] at addr ffff800066539c7b----------------错误类型是slab-out-of-bounds，在kmalloc_oob_right中产生。<br>Write of size <span class="hljs-number">1</span> by task insmod/<span class="hljs-number">788</span><br>=============================================================================<br>BUG kmalloc<span class="hljs-number">-128</span> (Tainted: G O ): kasan: bad access detected-------------------------------------------------------------------slab非法非法访问<br>-----------------------------------------------------------------------------<br><br>Disabling lock debugging due to kernel taint<br>INFO: Allocated in kmalloc_oob_right+<span class="hljs-number">0x54</span>/<span class="hljs-number">0xe0</span> [kasan] age=<span class="hljs-number">0</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">788</span>--------------------------------------------问题点kmalloc_oob_right的栈回溯<br>alloc_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x188</span><br>___slab_alloc.constprop<span class="hljs-number">.30</span>+<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x440</span><br>__slab_alloc.isra<span class="hljs-number">.27</span>.constprop<span class="hljs-number">.29</span>+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x38</span><br>kmem_cache_alloc+<span class="hljs-number">0x220</span>/<span class="hljs-number">0x280</span><br>kmalloc_oob_right+<span class="hljs-number">0x54</span>/<span class="hljs-number">0xe0</span> [kasan]<br>kmalloc_tests_init+<span class="hljs-number">0x18</span>/<span class="hljs-number">0x70</span> [kasan]<br>do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Freed in do_one_initcall+<span class="hljs-number">0x10c</span>/<span class="hljs-number">0x310</span> age=<span class="hljs-number">0</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">788</span><br>free_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x368</span><br>__slab_free+<span class="hljs-number">0x344</span>/<span class="hljs-number">0x4a0</span><br>kfree+<span class="hljs-number">0x21c</span>/<span class="hljs-number">0x250</span><br>do_one_initcall+<span class="hljs-number">0x10c</span>/<span class="hljs-number">0x310</span><br>do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Slab <span class="hljs-number">0xffff7bffc2994e00</span> objects=<span class="hljs-number">16</span> used=<span class="hljs-number">2</span> fp=<span class="hljs-number">0xffff800066539e00</span> flags=<span class="hljs-number">0x4080</span><br>INFO: Object <span class="hljs-number">0xffff800066539c00</span> @offset=<span class="hljs-number">7168</span> fp=<span class="hljs-number">0xffff800066538200</span><br><br>Bytes b4 ffff800066539bf0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................------------------------------内存dump<br>Object ffff800066539c00: <span class="hljs-number">00</span> <span class="hljs-number">82</span> <span class="hljs-number">53</span> <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">73</span> <span class="hljs-number">5f</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e ..Sf....tests_in<br>Object ffff800066539c10: <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">20</span> <span class="hljs-number">5b</span> <span class="hljs-number">6b</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">5</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> it [kasan]......<br>Object ffff800066539c20: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539c30: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539c40: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539c50: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539c60: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539c70: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539db0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539dc0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539dd0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539de0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539df0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>CPU: <span class="hljs-number">1</span> PID: <span class="hljs-number">788</span> Comm: insmod Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">108</span>------------------------------------------------------------------打印此<span class="hljs-built_in">log</span>消息的栈回溯<br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff80000008e938&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x270</span><br>[&lt;ffff80000008ebbc&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff800000735bb0&gt;] dump_stack+<span class="hljs-number">0x100</span>/<span class="hljs-number">0x188</span><br>[&lt;ffff800000318f60&gt;] print_trailer+<span class="hljs-number">0xf8</span>/<span class="hljs-number">0x160</span><br>[&lt;ffff80000031ea8c&gt;] object_err+<span class="hljs-number">0x3c</span>/<span class="hljs-number">0x50</span><br>[&lt;ffff8000003209a0&gt;] kasan_report_error+<span class="hljs-number">0x240</span>/<span class="hljs-number">0x558</span><br>[&lt;ffff800000320e90&gt;] __asan_report_store1_noabort+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x50</span><br>[&lt;ffff7ffffc008324&gt;] kmalloc_oob_right+<span class="hljs-number">0xa4</span>/<span class="hljs-number">0xe0</span> [kasan]<br>[&lt;ffff7ffffc009070&gt;] kmalloc_tests_init+<span class="hljs-number">0x18</span>/<span class="hljs-number">0x70</span> [kasan]<br>[&lt;ffff80000008309c&gt;] do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>[&lt;ffff8000002648c4&gt;] do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>[&lt;ffff800000206724&gt;] load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>[&lt;ffff800000207dc0&gt;] SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>[&lt;ffff800000086cb0&gt;] el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>Memory state around the buggy address:<br>ffff800066539b00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>ffff800066539b80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>&gt;ffff800066539c00: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span><br>^<br>ffff800066539c80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>ffff800066539d00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>==================================================================<br></code></pre></td></tr></table></figure>
<h6 id="user-after-free">user-after-free</h6>
<p>user-after-free是释放后使用的意思。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span> __init <span class="hljs-title function_">kmalloc_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">size_t</span> size = <span class="hljs-number">10</span>;<br><br>    pr_info(<span class="hljs-string">&quot;use-after-free\n&quot;</span>);<br>    ptr = kmalloc(size, GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (!ptr) &#123;<br>        pr_err(<span class="hljs-string">&quot;Allocation failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    kfree(ptr);<br>    *(ptr + <span class="hljs-number">8</span>) = <span class="hljs-string">&#x27;x&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c">kasan test: kmalloc_uaf use-after-<span class="hljs-built_in">free</span><br>==================================================================<br>BUG: KASAN: use-after-<span class="hljs-built_in">free</span> in kmalloc_uaf+<span class="hljs-number">0xac</span>/<span class="hljs-number">0xe0</span> [kasan] at addr ffff800066539e08<br>Write of size <span class="hljs-number">1</span> by task insmod/<span class="hljs-number">788</span><br>=============================================================================<br>BUG kmalloc<span class="hljs-number">-128</span> (Tainted: G B O ): kasan: bad access detected<br>-----------------------------------------------------------------------------<br><br>INFO: Allocated in kmalloc_uaf+<span class="hljs-number">0x54</span>/<span class="hljs-number">0xe0</span> [kasan] age=<span class="hljs-number">0</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">788</span><br>alloc_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x188</span><br>___slab_alloc.constprop<span class="hljs-number">.30</span>+<span class="hljs-number">0x3f8</span>/<span class="hljs-number">0x440</span><br>__slab_alloc.isra<span class="hljs-number">.27</span>.constprop<span class="hljs-number">.29</span>+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x38</span><br>kmem_cache_alloc+<span class="hljs-number">0x220</span>/<span class="hljs-number">0x280</span><br>kmalloc_uaf+<span class="hljs-number">0x54</span>/<span class="hljs-number">0xe0</span> [kasan]<br>kmalloc_tests_init+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x70</span> [kasan]<br>do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Freed in kmalloc_uaf+<span class="hljs-number">0x84</span>/<span class="hljs-number">0xe0</span> [kasan] age=<span class="hljs-number">0</span> cpu=<span class="hljs-number">1</span> pid=<span class="hljs-number">788</span><br>free_debug_processing+<span class="hljs-number">0x17c</span>/<span class="hljs-number">0x368</span><br>__slab_free+<span class="hljs-number">0x344</span>/<span class="hljs-number">0x4a0</span><br>kfree+<span class="hljs-number">0x21c</span>/<span class="hljs-number">0x250</span><br>kmalloc_uaf+<span class="hljs-number">0x84</span>/<span class="hljs-number">0xe0</span> [kasan]<br>kmalloc_tests_init+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x70</span> [kasan]<br>do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>INFO: Slab <span class="hljs-number">0xffff7bffc2994e00</span> objects=<span class="hljs-number">16</span> used=<span class="hljs-number">1</span> fp=<span class="hljs-number">0xffff800066539e00</span> flags=<span class="hljs-number">0x4080</span><br>INFO: Object <span class="hljs-number">0xffff800066539e00</span> @offset=<span class="hljs-number">7680</span> fp=<span class="hljs-number">0xffff800066539800</span><br><br>Bytes b4 ffff800066539df0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539e00: <span class="hljs-number">00</span> <span class="hljs-number">98</span> <span class="hljs-number">53</span> <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ..Sf............<br>Object ffff800066539e10: <span class="hljs-number">00</span> <span class="hljs-number">9</span>e <span class="hljs-number">53</span> <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff d0 <span class="hljs-number">51</span> <span class="hljs-number">12</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff ..Sf.....Q......<br>Object ffff800066539e20: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> e0 <span class="hljs-number">14</span> <span class="hljs-number">6</span>d <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff ..........m.....<br>Object ffff800066539e30: <span class="hljs-number">00</span> <span class="hljs-number">69</span> a3 <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">18</span> <span class="hljs-number">69</span> a3 <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff .i.f.....i.f....<br>Object ffff800066539e40: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539e50: <span class="hljs-number">30</span> da <span class="hljs-number">73</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">00</span> <span class="hljs-number">69</span> a3 <span class="hljs-number">66</span> <span class="hljs-number">00</span> <span class="hljs-number">80</span> ff ff <span class="hljs-number">0.</span>s......i.f....<br>Object ffff800066539e60: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Object ffff800066539e70: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539fb0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539fc0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539fd0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539fe0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>Padding ffff800066539ff0: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ................<br>CPU: <span class="hljs-number">1</span> PID: <span class="hljs-number">788</span> Comm: insmod Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">108</span><br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff80000008e938&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x270</span><br>[&lt;ffff80000008ebbc&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff800000735bb0&gt;] dump_stack+<span class="hljs-number">0x100</span>/<span class="hljs-number">0x188</span><br>[&lt;ffff800000318f60&gt;] print_trailer+<span class="hljs-number">0xf8</span>/<span class="hljs-number">0x160</span><br>[&lt;ffff80000031ea8c&gt;] object_err+<span class="hljs-number">0x3c</span>/<span class="hljs-number">0x50</span><br>[&lt;ffff8000003209a0&gt;] kasan_report_error+<span class="hljs-number">0x240</span>/<span class="hljs-number">0x558</span><br>[&lt;ffff800000320e90&gt;] __asan_report_store1_noabort+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x50</span><br>[&lt;ffff7ffffc00874c&gt;] kmalloc_uaf+<span class="hljs-number">0xac</span>/<span class="hljs-number">0xe0</span> [kasan]<br>[&lt;ffff7ffffc0090a0&gt;] kmalloc_tests_init+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x70</span> [kasan]<br>[&lt;ffff80000008309c&gt;] do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>[&lt;ffff8000002648c4&gt;] do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>[&lt;ffff800000206724&gt;] load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>[&lt;ffff800000207dc0&gt;] SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>[&lt;ffff800000086cb0&gt;] el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>Memory state around the buggy address:<br>ffff800066539d00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>ffff800066539d80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>&gt;ffff800066539e00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb<br>^<br>ffff800066539e80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>ffff800066539f00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc<br>==================================================================<br></code></pre></td></tr></table></figure>
<h6 id="stack-out-of-bounds">stack-out-of-bounds</h6>
<p>栈越界访问是函数中数组越界，在实际工程中经常出现，问题难以发现。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span> __init <span class="hljs-title function_">kasan_stack_oob</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> stack_array[<span class="hljs-number">10</span>];<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> *p = &amp;stack_array[ARRAY_SIZE(stack_array) + i];<br><br>    pr_info(<span class="hljs-string">&quot;out-of-bounds on stack\n&quot;</span>);<br>    *(<span class="hljs-keyword">volatile</span> <span class="hljs-type">char</span> *)p;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">kasan test: kasan_stack_oob out-of-bounds on <span class="hljs-built_in">stack</span><br>==================================================================<br>BUG: KASAN: <span class="hljs-built_in">stack</span>-out-of-bounds in kasan_stack_oob+<span class="hljs-number">0xa8</span>/<span class="hljs-number">0xf0</span> [kasan] at addr ffff800066acb95a<br>Read of size <span class="hljs-number">1</span> by task insmod/<span class="hljs-number">788</span><br>page:ffff7bffc29ab2c0 count:<span class="hljs-number">0</span> mapcount:<span class="hljs-number">0</span> mapping: (null) index:<span class="hljs-number">0x0</span><br>flags: <span class="hljs-number">0x0</span>()<br>page dumped because: kasan: bad access detected<br>CPU: <span class="hljs-number">1</span> PID: <span class="hljs-number">788</span> Comm: insmod Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">108</span><br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff80000008e938&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x270</span><br>[&lt;ffff80000008ebbc&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff800000735bb0&gt;] dump_stack+<span class="hljs-number">0x100</span>/<span class="hljs-number">0x188</span><br>[&lt;ffff800000320c90&gt;] kasan_report_error+<span class="hljs-number">0x530</span>/<span class="hljs-number">0x558</span><br>[&lt;ffff800000320d00&gt;] __asan_report_load1_noabort+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x50</span><br>[&lt;ffff7ffffc0080a8&gt;] kasan_stack_oob+<span class="hljs-number">0xa8</span>/<span class="hljs-number">0xf0</span> [kasan]<br>[&lt;ffff7ffffc0090b0&gt;] kmalloc_tests_init+<span class="hljs-number">0x58</span>/<span class="hljs-number">0x70</span> [kasan]<br>[&lt;ffff80000008309c&gt;] do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>[&lt;ffff8000002648c4&gt;] do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>[&lt;ffff800000206724&gt;] load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>[&lt;ffff800000207dc0&gt;] SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>[&lt;ffff800000086cb0&gt;] el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>Memory state around the buggy address:<br>ffff800066acb800: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>ffff800066acb880: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> f1 f1<br>&gt;ffff800066acb900: f1 f1 <span class="hljs-number">04</span> f4 f4 f4 f2 f2 f2 f2 <span class="hljs-number">00</span> <span class="hljs-number">02</span> f4 f4 f3 f3<br>^<br>ffff800066acb980: f3 f3 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> f1 f1<br>ffff800066acba00: f1 f1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> f3 f3 f3 f3 <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>==================================================================<br></code></pre></td></tr></table></figure>
<h6 id="global-out-of-bounds">global-out-of-bounds</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> global_array[<span class="hljs-number">10</span>];<br><br><span class="hljs-type">static</span> noinline <span class="hljs-type">void</span> __init <span class="hljs-title function_">kasan_global_oob</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> i = <span class="hljs-number">3</span>;<br>    <span class="hljs-type">char</span> *p = &amp;global_array[ARRAY_SIZE(global_array) + i];<br><br>    pr_info(<span class="hljs-string">&quot;out-of-bounds global variable\n&quot;</span>);<br>    *(<span class="hljs-keyword">volatile</span> <span class="hljs-type">char</span> *)p;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c">kasan test: kasan_global_oob out-of-bounds global variable<br>==================================================================<br>BUG: KASAN: global-out-of-bounds in kasan_global_oob+<span class="hljs-number">0x9c</span>/<span class="hljs-number">0xe8</span> [kasan] at addr ffff7ffffc001c8d<br>Read of size <span class="hljs-number">1</span> by task insmod/<span class="hljs-number">788</span><br>Address belongs to variable global_array+<span class="hljs-number">0xd</span>/<span class="hljs-number">0xffffffffffffe3f8</span> [kasan]<br>CPU: <span class="hljs-number">1</span> PID: <span class="hljs-number">788</span> Comm: insmod Tainted: G B O <span class="hljs-number">4.4</span><span class="hljs-number">.0</span>+ #<span class="hljs-number">108</span><br>Hardware name: linux,dummy-virt (DT)<br>Call trace:<br>[&lt;ffff80000008e938&gt;] dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x270</span><br>[&lt;ffff80000008ebbc&gt;] show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>[&lt;ffff800000735bb0&gt;] dump_stack+<span class="hljs-number">0x100</span>/<span class="hljs-number">0x188</span><br>[&lt;ffff800000320c90&gt;] kasan_report_error+<span class="hljs-number">0x530</span>/<span class="hljs-number">0x558</span><br>[&lt;ffff800000320d00&gt;] __asan_report_load1_noabort+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x50</span><br>[&lt;ffff7ffffc00818c&gt;] kasan_global_oob+<span class="hljs-number">0x9c</span>/<span class="hljs-number">0xe8</span> [kasan]<br>[&lt;ffff7ffffc0090b4&gt;] kmalloc_tests_init+<span class="hljs-number">0x5c</span>/<span class="hljs-number">0x70</span> [kasan]<br>[&lt;ffff80000008309c&gt;] do_one_initcall+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x310</span><br>[&lt;ffff8000002648c4&gt;] do_init_module+<span class="hljs-number">0x1cc</span>/<span class="hljs-number">0x588</span><br>[&lt;ffff800000206724&gt;] load_module+<span class="hljs-number">0x48cc</span>/<span class="hljs-number">0x5dc0</span><br>[&lt;ffff800000207dc0&gt;] SyS_init_module+<span class="hljs-number">0x1a8</span>/<span class="hljs-number">0x1e0</span><br>[&lt;ffff800000086cb0&gt;] el0_svc_naked+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x28</span><br>Memory state around the buggy address:<br>ffff7ffffc001b80: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>ffff7ffffc001c00: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>&gt;ffff7ffffc001c80: <span class="hljs-number">00</span> <span class="hljs-number">02</span> fa fa fa fa fa fa <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>^<br>ffff7ffffc001d00: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>ffff7ffffc001d80: <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>==================================================================<br></code></pre></td></tr></table></figure>
<h4 id="小结">小结</h4>
<p>kmemleak检查内存泄露的独门绝技，让其有一定市场空间。但功能比较单一，专注于内存泄露问题。</p>
<p>对于非ARM64/x86平台，只能使用slub_debug进行内存问题分析；kasan更高效，但也需要更高的内核和GCC版本支持。</p>
<h4 id="memstacks-pgfaultstacks">memstacks pgfaultstacks</h4>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7208070738077614651">2个压箱底的方法和工具搞定内存泄漏</a></li>
</ul>
<h3 id="用户虚拟空间">用户虚拟空间</h3>
<h4 id="mtrace-valgrind">mtrace valgrind</h4>
<ul>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7185538936058479159"><font color=Red>实例分析Linux内存泄漏检测方法</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/article/7104560595789185539"><font color=Red>内存泄漏-原因、避免和定位</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/75416381"><font color=Red>内存泄漏检测工具valgrind神器</font></a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.guyuehome.com/34716">Valgrind对ROS程序的可视化分析</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.jianshu.com/p/6854085d54cd">利用Valgrind和gperftools解决内存问题</a></p></li>
<li><p><a target="_blank" rel="noopener" href="http://senlinzhan.github.io/2017/12/31/valgrind/">使用
Valgrind 检测 C++ 内存泄漏</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://www.toutiao.com/i7054082694740836895">彻底搞清楚内存泄漏的原因，如何避免内存泄漏，如何定位内存泄漏</a></p></li>
<li><p><a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/75416381"><font color=Red>内存泄漏检测工具valgrind神器</font></a></p></li>
</ul>
<h4 id="asan">asan</h4>
<ul>
<li><a
target="_blank" rel="noopener" href="http://www.cppblog.com/markqian86/archive/2018/06/14/215728.html">Linux下内存检测工具：asan</a></li>
</ul>
<h2 id="more">More</h2>
<ul>
<li><a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/-IiGz4lWXIqV-4kbgWeEcg">同一块内存，连续两次memset，耗时相差4倍！揪出隐藏的性能杀手！</a></li>
</ul>
<h3 id="内存硬件故障">内存硬件故障</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xzongblogs/p/14279433.html">Linux
内存错误诊断</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/" class="category-chain-item">kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/mm/" class="category-chain-item">mm</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/qemu/">#qemu</a>
      
        <a href="/tags/C/">#C++</a>
      
        <a href="/tags/git/">#git</a>
      
        <a href="/tags/linux/">#linux</a>
      
        <a href="/tags/HTML/">#HTML</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>内存管理</div>
      <div>https://realwujing.github.io/linux/kernel/mm/内存管理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月28日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/linux/kernel/fs/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" title="文件系统">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">文件系统</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/kernel/kvm/amd64%E4%B8%8B%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95arm64%E5%86%85%E6%A0%B8/" title="amd64下交叉编译调试arm64内核">
                        <span class="hidden-mobile">amd64下交叉编译调试arm64内核</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '1f840e641fe7e7b127c2137e1be310ad'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
