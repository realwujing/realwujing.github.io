

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="HTML, JavaScript, Hexo, Linux, qemu, C++, namespace, git, bcc, bpf, initramfs, k8s, architect, strings, assembly, linux">
  
    <meta name="description" content="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0  Linux 虚拟网络设备 veth-pair 详解，看这一篇就够了  测试环境 管理区新架构测试沟通 2022年-公有云-贵州-贵州4.0AZ1-测试 10.246.116.1 os">
<meta property="og:type" content="article">
<meta property="og:title" content="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0">
<meta property="og:url" content="https://realwujing.github.io/linux/kernel/bugs/network/ovs%20veth%20peer%20Soft%20Lockup%20on%20netdev_pick_tx%20due%20to%20zero%20real_num_tx_queues%20When%20Executing%20ip%20link%20del%20veth0/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0  Linux 虚拟网络设备 veth-pair 详解，看这一篇就够了  测试环境 管理区新架构测试沟通 2022年-公有云-贵州-贵州4.0AZ1-测试 10.246.116.1 os">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-21T10:14:37.000Z">
<meta property="article:modified_time" content="2025-03-21T10:14:37.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="qemu">
<meta property="article:tag" content="git">
<meta property="article:tag" content="bpf">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="HTML">
<meta property="article:tag" content="namespace">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0 - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-21 10:14" pubdate>
          2025年3月21日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          47k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          392 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0</h1>
            
            
              <div class="markdown-body">
                
                <h1
id="ovs-veth-peer-soft-lockup-on-netdev_pick_tx-due-to-zero-real_num_tx_queues-when-executing-ip-link-del-veth0">ovs
veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues
When Executing ip link del veth0</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bakari/p/10613710.html">Linux
虚拟网络设备 veth-pair 详解，看这一篇就够了</a></li>
</ul>
<h2 id="测试环境">测试环境</h2>
<p>管理区新架构测试沟通</p>
<p>2022年-公有云-贵州-贵州4.0AZ1-测试 10.246.116.1</p>
<p>os-deploy</p>
<p>10e63e7e11</p>
<p>sudo -s</p>
<p>10.63.2.11</p>
<p>10.63.2.12</p>
<p>10.63.2.13</p>
<p>ssh secure@10.63.2.11 -p 10000</p>
<p>scp -P 10000 kernel-5.10.0-136.12.0.88.f4e7ea49f7bd.ctl3.aarch64.rpm
secure@10.63.2.13:~/wujing</p>
<p>ctkernel-lts-5.10/yuanql9/bugfix-pr-veth-peer-soft-lockup</p>
<h2 id="复现步骤">复现步骤</h2>
<p>在13设备上复现了一下，创建完网桥，网桥上的流量越大复现概率越高：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ovs-vsctl add-br os_manage1<br>ovs-vsctl add-port os_manage1 bond0.151<br>ip <span class="hljs-built_in">link</span> add name veth0 <span class="hljs-built_in">type</span> veth peer name veth1<br>ovs-vsctl add-port os_manage1 veth0<br>ip <span class="hljs-built_in">link</span> del veth0<br>ovs-vsctl del-port os_manage1 veth0<br></code></pre></td></tr></table></figure>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/openvswitch_dmesg.png" srcset="/img/loading.gif" lazyload
alt="openvswitch_dmesg" />
<figcaption aria-hidden="true">openvswitch_dmesg</figcaption>
</figure>
<h2 id="根因定位">根因定位</h2>
<p>配置 Linux 内核在检测到任务挂起（hung task）或软锁死（soft
lockup）时触发系统崩溃（panic）:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sysctl -w kernel.hung_task_panic=1<br>sysctl -w kernel.softlockup_panic=1<br></code></pre></td></tr></table></figure>
<h3 id="vmcore-dmesg.txt">vmcore-dmesg.txt</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs bash">[ 4393.873711] watchdog: BUG: soft lockup - CPU<span class="hljs-comment">#21 stuck for 12s! [swapper/21:0]</span><br>[ 4393.882198] Modules linked <span class="hljs-keyword">in</span>: nft_nat nft_masq nft_counter nft_chain_nat vhost_net vhost vhost_iotlb tap xt_TPROXY nf_tproxy_ipv6 nf_tproxy_ipv4 cls_bpf vxlan ip6_udp_tunnel udp_tunnel veth xt_nat xt_socket nf_socket_ipv4 nf_socket_ipv6 ip6table_raw iptable_raw xt_CT nbd rbd ceph libceph dns_resolver ip6t_REJECT nf_reject_ipv6 xt_mark xt_set ip_set_hash_ipportnet ip_set_hash_ipportip ip_set_hash_ipport ip_set_hash_ip ip_set_bitmap_port ip_vs_rr ip_set ip_vs nf_tables dummy xt_comment binfmt_misc nf_conntrack_netlink nfnetlink xt_addrtype xt_CHECKSUM xt_MASQUERADE xt_conntrack ipt_REJECT nf_reject_ipv4 ip6table_mangle ip6table_nat iptable_mangle iptable_nat ebtable_filter ebtables ip6table_filter ip6_tables iptable_filter ip_tables tun sch_ingress bonding rfkill 8021q garp mrp openvswitch nsh nf_conncount nf_nat rpcrdma rdma_ucm ib_srpt ib_isert iscsi_target_mod sunrpc target_core_mod ib_iser rdma_cm iw_cm ib_cm libiscsi scsi_transport_iscsi hns_roce_hw_v2 ib_uverbs ib_core<br>[ 4393.882270]  ipmi_ssif realtek ses hibmc_drm enclosure hclge hisi_sas_v3_hw drm_vram_helper vfat fat acpi_ipmi ipmi_si hns3 hisi_sas_main drm_ttm_helper hnae3 libsas hinic nvme ipmi_devintf i2c_designware_platform ttm scsi_transport_sas host_edma_drv sg nvme_core ipmi_msghandler i2c_designware_core hisi_uncore_hha_pmu hisi_uncore_ddrc_pmu hisi_uncore_l3c_pmu hisi_uncore_pmu ext4 mbcache jbd2 sch_fq_codel overlay br_netfilter bridge stp llc nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 fuse xfs libcrc32c dm_multipath sd_mod t10_pi ghash_ce sha2_ce ahci sha256_arm64 libahci sha1_ce sbsa_gwdt libata megaraid_sas nfit libnvdimm dm_mirror dm_region_hash dm_log dm_mod aes_ce_blk crypto_simd cryptd aes_ce_cipher<br>[ 4394.041268] CPU: 21 PID: 0 Comm: swapper/21 Kdump: loaded Not tainted 5.10.0-136.12.0.88.ctl3.aarch64 <span class="hljs-comment">#1</span><br>[ 4394.052208] Hardware name: Huawei TaiShan 2280 V2/BC82AMDDA, BIOS 1.70 01/07/2021<br>[ 4394.061192] pstate: 60400009 (nZCv daif +PAN -UAO -TCO BTYPE=--)<br>[ 4394.068702] pc : netdev_pick_tx+0x27c/0x294<br>[ 4394.074385] lr : netdev_pick_tx+0xe8/0x294<br>[ 4394.079977] sp : ffff800012ab3540<br>[ 4394.084788] x29: ffff800012ab3540 x28: ffff800012ab3b90<br>[ 4394.091580] x27: ffff0021428bca00 x26: 0000000000000000<br>[ 4394.098377] x25: 0000000000000000 x24: 00000000ffffffff<br>[ 4394.105161] x23: 0000000000000000 x22: ffff20222543e000<br>[ 4394.111937] x21: ffff0021428bca00 x20: 0000000000000000<br>[ 4394.118713] x19: ffff20222543e000 x18: 0000000000000000<br>[ 4394.125479] x17: 0000000000000000 x16: 0000000000000000<br>[ 4394.132243] x15: 0000000000000001 x14: 0000000000004788<br>[ 4394.138998] x13: 000000000000a888 x12: 000000000000ca88<br>[ 4394.145741] x11: ffff800012ab3720 x10: 0000000000000188<br>[ 4394.152482] x9 : ffff800010adc558 x8 : ffff0020b064da10<br>[ 4394.159232] x7 : 0000000000000000 x6 : 00000069c6f1b488<br>[ 4394.165972] x5 : 0000000000000000 x4 : 0000000000000000<br>[ 4394.172693] x3 : 0000000000000000 x2 : 0000000000000000<br>[ 4394.179414] x1 : ffff0021428bca00 x0 : 0000000000000000<br>[ 4394.186133] Call trace:<br>[ 4394.189985]  netdev_pick_tx+0x27c/0x294<br>[ 4394.195220]  netdev_core_pick_tx+0xdc/0x10c<br>[ 4394.200796]  __dev_queue_xmit+0x104/0xac0<br>[ 4394.206192]  dev_queue_xmit+0x1c/0x30<br>[ 4394.211251]  ovs_vport_send+0xac/0x180 [openvswitch]<br>[ 4394.217599]  do_output+0x60/0x160 [openvswitch]<br>[ 4394.223509]  do_execute_actions+0x868/0x880 [openvswitch]<br>[ 4394.230277]  ovs_execute_actions+0x64/0xe0 [openvswitch]<br>[ 4394.236959]  ovs_dp_process_packet+0x9c/0x1e4 [openvswitch]<br>[ 4394.243899]  ovs_vport_receive+0x7c/0xec [openvswitch]<br>[ 4394.250412]  netdev_port_receive+0xbc/0x17c [openvswitch]<br>[ 4394.257183]  netdev_frame_hook+0x2c/0x44 [openvswitch]<br>[ 4394.263673]  __netif_receive_skb_core+0x294/0xdd4<br>[ 4394.269708]  __netif_receive_skb_list_core+0xa4/0x290<br>[ 4394.276067]  __netif_receive_skb_list+0x120/0x1a0<br>[ 4394.282053]  netif_receive_skb_list_internal+0xe4/0x1f0<br>[ 4394.288538]  napi_complete_done+0x70/0x1f0<br>[ 4394.293897]  hns3_nic_common_poll+0x104/0x220 [hns3]<br>[ 4394.300093]  napi_poll+0xcc/0x264<br>[ 4394.304618]  net_rx_action+0xd4/0x21c<br>[ 4394.309463]  __do_softirq+0x130/0x358<br>[ 4394.314284]  irq_exit+0x11c/0x13c<br>[ 4394.318740]  __handle_domain_irq+0x88/0xf0<br>[ 4394.323954]  gic_handle_irq+0x78/0x2c0<br>[ 4394.328804]  el1_irq+0xb8/0x140<br>[ 4394.333029]  arch_cpu_idle+0x18/0x40<br>[ 4394.337667]  default_idle_call+0x5c/0x1c0<br>[ 4394.342723]  cpuidle_idle_call+0x174/0x1b0<br>[ 4394.347853]  do_idle+0xc8/0x160<br>[ 4394.352025]  cpu_startup_entry+0x30/0xfc<br>[ 4394.356986]  secondary_start_kernel+0x158/0x1ec<br>[ 4394.362556] Kernel panic - not syncing: softlockup: hung tasks<br>[ 4394.369422] CPU: 21 PID: 0 Comm: swapper/21 Kdump: loaded Tainted: G             L    5.10.0-136.12.0.88.ctl3.aarch64 <span class="hljs-comment">#1</span><br>[ 4394.381711] Hardware name: Huawei TaiShan 2280 V2/BC82AMDDA, BIOS 1.70 01/07/2021<br>[ 4394.390268] Call trace:<br>[ 4394.393809]  dump_backtrace+0x0/0x1e4<br>[ 4394.398565]  show_stack+0x20/0x2c<br>[ 4394.402976]  dump_stack+0xd8/0x140<br>[ 4394.407475]  panic+0x168/0x390<br>[ 4394.411630]  watchdog_timer_fn+0x230/0x290<br>[ 4394.416825]  __run_hrtimer+0x98/0x2a0<br>[ 4394.421586]  __hrtimer_run_queues+0xb0/0x134<br>[ 4394.426953]  hrtimer_interrupt+0x13c/0x3c0<br>[ 4394.432151]  arch_timer_handler_phys+0x3c/0x50<br>[ 4394.437700]  handle_percpu_devid_irq+0x90/0x1f4<br>[ 4394.443336]  __handle_domain_irq+0x84/0xf0<br>[ 4394.448538]  gic_handle_irq+0x78/0x2c0<br>[ 4394.453397]  el1_irq+0xb8/0x140<br>[ 4394.457661]  netdev_pick_tx+0x27c/0x294<br>[ 4394.462625]  netdev_core_pick_tx+0xdc/0x10c<br>[ 4394.467920]  __dev_queue_xmit+0x104/0xac0<br>[ 4394.473034]  dev_queue_xmit+0x1c/0x30<br>[ 4394.477810]  ovs_vport_send+0xac/0x180 [openvswitch]<br>[ 4394.483885]  do_output+0x60/0x160 [openvswitch]<br>[ 4394.489517]  do_execute_actions+0x868/0x880 [openvswitch]<br>[ 4394.496018]  ovs_execute_actions+0x64/0xe0 [openvswitch]<br>[ 4394.502428]  ovs_dp_process_packet+0x9c/0x1e4 [openvswitch]<br>[ 4394.509102]  ovs_vport_receive+0x7c/0xec [openvswitch]<br>[ 4394.515344]  netdev_port_receive+0xbc/0x17c [openvswitch]<br>[ 4394.521845]  netdev_frame_hook+0x2c/0x44 [openvswitch]<br>[ 4394.528091]  __netif_receive_skb_core+0x294/0xdd4<br>[ 4394.533904]  __netif_receive_skb_list_core+0xa4/0x290<br>[ 4394.540061]  __netif_receive_skb_list+0x120/0x1a0<br>[ 4394.545867]  netif_receive_skb_list_internal+0xe4/0x1f0<br>[ 4394.552192]  napi_complete_done+0x70/0x1f0<br>[ 4394.557407]  hns3_nic_common_poll+0x104/0x220 [hns3]<br>[ 4394.563478]  napi_poll+0xcc/0x264<br>[ 4394.567904]  net_rx_action+0xd4/0x21c<br>[ 4394.572679]  __do_softirq+0x130/0x358<br>[ 4394.577453]  irq_exit+0x11c/0x13c<br>[ 4394.581875]  __handle_domain_irq+0x88/0xf0<br>[ 4394.587084]  gic_handle_irq+0x78/0x2c0<br>[ 4394.591944]  el1_irq+0xb8/0x140<br>[ 4394.596199]  arch_cpu_idle+0x18/0x40<br>[ 4394.600884]  default_idle_call+0x5c/0x1c0<br>[ 4394.606007]  cpuidle_idle_call+0x174/0x1b0<br>[ 4394.611213]  do_idle+0xc8/0x160<br>[ 4394.615465]  cpu_startup_entry+0x30/0xfc<br>[ 4394.620490]  secondary_start_kernel+0x158/0x1ec<br>[ 4394.626146] SMP: stopping secondary CPUs<br>[ 4394.632839] Starting crashdump kernel...<br>[ 4394.637846] Bye!<br></code></pre></td></tr></table></figure>
<h3 id="crash">crash</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@kvm-10e63e2e11 127.0.0.1-2025-02-27-18:19:00]<span class="hljs-comment"># ip a | grep -i 10.63.2.11</span><br>    inet 10.63.2.11/21 brd 10.63.7.255 scope global noprefixroute os_manage<br>[root@kvm-10e63e2e11 127.0.0.1-2025-02-27-18:19:00]<span class="hljs-comment">#</span><br>[root@kvm-10e63e2e11 127.0.0.1-2025-02-27-18:19:00]<span class="hljs-comment"># pwd</span><br>/var/crash/127.0.0.1-2025-02-27-18:19:00<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash /lib/debug/lib/modules/5.10.0-136.12.0.88.ctl3.aarch64/vmlinux vmcore<br></code></pre></td></tr></table></figure>
<h4 id="sys">sys</h4>
<p>sys查看panic原因： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; sys<br>      KERNEL: /lib/debug/lib/modules/5.10.0-136.12.0.88.ctl3.aarch64/vmlinux  [TAINTED]<br>    DUMPFILE: vmcore  [PARTIAL DUMP]<br>        CPUS: 96<br>        DATE: Thu Feb 27 18:17:42 CST 2025<br>      UPTIME: 01:13:14<br>LOAD AVERAGE: 24.54, 10.38, 8.03<br>       TASKS: 10764<br>    NODENAME: kvm-10e63e2e11<br>     RELEASE: 5.10.0-136.12.0.88.ctl3.aarch64<br>     VERSION: <span class="hljs-comment">#1 SMP Fri Jul 28 07:11:01 UTC 2023</span><br>     MACHINE: aarch64  (unknown Mhz)<br>      MEMORY: 192 GB<br>       PANIC: <span class="hljs-string">&quot;Kernel panic - not syncing: softlockup: hung tasks&quot;</span><br></code></pre></td></tr></table></figure></p>
<h4 id="bt">bt</h4>
<h5 id="bt-1">bt</h5>
<p>bt 查看堆栈回溯： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt<br>PID: 0        TASK: ffff00208d452680  CPU: 21   COMMAND: <span class="hljs-string">&quot;swapper/21&quot;</span><br> <span class="hljs-comment">#0 [ffff800012ab2f60] __crash_kexec at ffff8000101aafa0</span><br> <span class="hljs-comment">#1 [ffff800012ab30f0] panic at ffff800010cd72bc</span><br> <span class="hljs-comment">#2 [ffff800012ab31d0] watchdog_timer_fn at ffff8000101f25ac</span><br> <span class="hljs-comment">#3 [ffff800012ab3220] __run_hrtimer at ffff80001017d314</span><br> <span class="hljs-comment">#4 [ffff800012ab3270] __hrtimer_run_queues at ffff80001017d5cc</span><br> <span class="hljs-comment">#5 [ffff800012ab32d0] hrtimer_interrupt at ffff80001017dc18</span><br> <span class="hljs-comment">#6 [ffff800012ab3340] arch_timer_handler_phys at ffff800010a5ec88</span><br> <span class="hljs-comment">#7 [ffff800012ab3350] handle_percpu_devid_irq at ffff80001015011c</span><br> <span class="hljs-comment">#8 [ffff800012ab3380] __handle_domain_irq at ffff800010146fb0</span><br> <span class="hljs-comment">#9 [ffff800012ab33c0] gic_handle_irq at ffff800010010124</span><br><span class="hljs-comment">#10 [ffff800012ab3520] el1_irq at ffff800010012374</span><br><span class="hljs-comment">#11 [ffff800012ab3540] netdev_pick_tx at ffff800010adc6e8</span><br><span class="hljs-comment">#12 [ffff800012ab3590] netdev_core_pick_tx at ffff800010ae675c</span><br><span class="hljs-comment">#13 [ffff800012ab35c0] __dev_queue_xmit at ffff800010ae6890</span><br><span class="hljs-comment">#14 [ffff800012ab3630] dev_queue_xmit at ffff800010ae7268</span><br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send at ffff8000098f95b8 [openvswitch]</span><br><span class="hljs-comment">#16 [ffff800012ab3670] do_output at ffff8000098e47fc [openvswitch]</span><br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions at ffff8000098e66b4 [openvswitch]</span><br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions at ffff8000098e6b00 [openvswitch]</span><br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet at ffff8000098eaba8 [openvswitch]</span><br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive at ffff8000098f949c [openvswitch]</span><br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive at ffff8000098fa03c [openvswitch]</span><br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook at ffff8000098fa128 [openvswitch]</span><br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core at ffff800010ae77f0</span><br><span class="hljs-comment">#24 [ffff800012ab3bd0] __netif_receive_skb_list_core at ffff800010ae88d0</span><br><span class="hljs-comment">#25 [ffff800012ab3c60] __netif_receive_skb_list at ffff800010ae8bdc</span><br><span class="hljs-comment">#26 [ffff800012ab3cc0] netif_receive_skb_list_internal at ffff800010ae8d40</span><br><span class="hljs-comment">#27 [ffff800012ab3d40] napi_complete_done at ffff800010ae9aec</span><br><span class="hljs-comment">#28 [ffff800012ab3d70] hns3_nic_common_poll at ffff800009be7350 [hns3]</span><br><span class="hljs-comment">#29 [ffff800012ab3e10] napi_poll at ffff800010ae9d38</span><br><span class="hljs-comment">#30 [ffff800012ab3e50] net_rx_action at ffff800010ae9fa4</span><br><span class="hljs-comment">#31 [ffff800012ab3ed0] __do_softirq at ffff80001001075c</span><br><span class="hljs-comment">#32 [ffff800012ab3f70] irq_exit at ffff8000100b06cc</span><br><span class="hljs-comment">#33 [ffff800012ab3f90] __handle_domain_irq at ffff800010146fb4</span><br><span class="hljs-comment">#34 [ffff800012ab3fd0] gic_handle_irq at ffff800010010124</span><br>--- &lt;IRQ stack&gt; ---<br><span class="hljs-comment">#35 [ffff800013093f00] el1_irq at ffff800010012374</span><br><span class="hljs-comment">#36 [ffff800013093f20] arch_cpu_idle at ffff800010cedb84</span><br><span class="hljs-comment">#37 [ffff800013093f30] default_idle_call at ffff800010cf9c58</span><br><span class="hljs-comment">#38 [ffff800013093f50] cpuidle_idle_call at ffff8000100f7850</span><br><span class="hljs-comment">#39 [ffff800013093f90] do_idle at ffff8000100f7954</span><br><span class="hljs-comment">#40 [ffff800013093fc0] cpu_startup_entry at ffff8000100f7bc0</span><br><span class="hljs-comment">#41 [ffff800013093fe0] secondary_start_kernel at ffff80001002a498</span><br></code></pre></td></tr></table></figure></p>
<h5 id="bt--sx">bt -sx</h5>
<p>bt -sx:</p>
<ul>
<li><strong><code>bt</code></strong>：在 <code>crash</code>
工具中，显示当前任务的调用栈（函数调用顺序）。</li>
<li><strong><code>-s</code></strong>：把地址变成函数名，方便看。</li>
<li><strong><code>-x</code></strong>：用十六进制显示地址。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -sx<br>PID: 0        TASK: ffff00208d452680  CPU: 21   COMMAND: <span class="hljs-string">&quot;swapper/21&quot;</span><br> <span class="hljs-comment">#0 [ffff800012ab2f60] __crash_kexec+0x110 at ffff8000101aafa0</span><br> <span class="hljs-comment">#1 [ffff800012ab30f0] panic+0x17c at ffff800010cd72bc</span><br> <span class="hljs-comment">#2 [ffff800012ab31d0] watchdog_timer_fn+0x22c at ffff8000101f25ac</span><br> <span class="hljs-comment">#3 [ffff800012ab3220] __run_hrtimer+0x94 at ffff80001017d314</span><br> <span class="hljs-comment">#4 [ffff800012ab3270] __hrtimer_run_queues+0xac at ffff80001017d5cc</span><br> <span class="hljs-comment">#5 [ffff800012ab32d0] hrtimer_interrupt+0x138 at ffff80001017dc18</span><br> <span class="hljs-comment">#6 [ffff800012ab3340] arch_timer_handler_phys+0x38 at ffff800010a5ec88</span><br> <span class="hljs-comment">#7 [ffff800012ab3350] handle_percpu_devid_irq+0x8c at ffff80001015011c</span><br> <span class="hljs-comment">#8 [ffff800012ab3380] __handle_domain_irq+0x80 at ffff800010146fb0</span><br> <span class="hljs-comment">#9 [ffff800012ab33c0] gic_handle_irq+0x74 at ffff800010010124</span><br><span class="hljs-comment">#10 [ffff800012ab3520] el1_irq+0xb4 at ffff800010012374</span><br><span class="hljs-comment">#11 [ffff800012ab3540] netdev_pick_tx+0x278 at ffff800010adc6e8</span><br><span class="hljs-comment">#12 [ffff800012ab3590] netdev_core_pick_tx+0xd8 at ffff800010ae675c</span><br><span class="hljs-comment">#13 [ffff800012ab35c0] __dev_queue_xmit+0x100 at ffff800010ae6890</span><br><span class="hljs-comment">#14 [ffff800012ab3630] dev_queue_xmit+0x18 at ffff800010ae7268</span><br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send+0xa8 at ffff8000098f95b8 [openvswitch]</span><br><span class="hljs-comment">#16 [ffff800012ab3670] do_output+0x5c at ffff8000098e47fc [openvswitch]</span><br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions+0x864 at ffff8000098e66b4 [openvswitch]</span><br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions+0x60 at ffff8000098e6b00 [openvswitch]</span><br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet+0x98 at ffff8000098eaba8 [openvswitch]</span><br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive+0x78 at ffff8000098f949c [openvswitch]</span><br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive+0xb8 at ffff8000098fa03c [openvswitch]</span><br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook+0x28 at ffff8000098fa128 [openvswitch]</span><br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core+0x290 at ffff800010ae77f0</span><br><span class="hljs-comment">#24 [ffff800012ab3bd0] __netif_receive_skb_list_core+0xa0 at ffff800010ae88d0</span><br><span class="hljs-comment">#25 [ffff800012ab3c60] __netif_receive_skb_list+0x11c at ffff800010ae8bdc</span><br><span class="hljs-comment">#26 [ffff800012ab3cc0] netif_receive_skb_list_internal+0xe0 at ffff800010ae8d40</span><br><span class="hljs-comment">#27 [ffff800012ab3d40] napi_complete_done+0x6c at ffff800010ae9aec</span><br><span class="hljs-comment">#28 [ffff800012ab3d70] hns3_nic_common_poll+0x100 at ffff800009be7350 [hns3]</span><br><span class="hljs-comment">#29 [ffff800012ab3e10] napi_poll+0xc8 at ffff800010ae9d38</span><br><span class="hljs-comment">#30 [ffff800012ab3e50] net_rx_action+0xd0 at ffff800010ae9fa4</span><br><span class="hljs-comment">#31 [ffff800012ab3ed0] __do_softirq+0x12c at ffff80001001075c</span><br><span class="hljs-comment">#32 [ffff800012ab3f70] irq_exit+0x118 at ffff8000100b06cc</span><br><span class="hljs-comment">#33 [ffff800012ab3f90] __handle_domain_irq+0x84 at ffff800010146fb4</span><br><span class="hljs-comment">#34 [ffff800012ab3fd0] gic_handle_irq+0x74 at ffff800010010124</span><br>--- &lt;IRQ stack&gt; ---<br><span class="hljs-comment">#35 [ffff800013093f00] el1_irq+0xb4 at ffff800010012374</span><br><span class="hljs-comment">#36 [ffff800013093f20] arch_cpu_idle+0x14 at ffff800010cedb84</span><br><span class="hljs-comment">#37 [ffff800013093f30] default_idle_call+0x58 at ffff800010cf9c58</span><br><span class="hljs-comment">#38 [ffff800013093f50] cpuidle_idle_call+0x170 at ffff8000100f7850</span><br><span class="hljs-comment">#39 [ffff800013093f90] do_idle+0xc4 at ffff8000100f7954</span><br><span class="hljs-comment">#40 [ffff800013093fc0] cpu_startup_entry+0x2c at ffff8000100f7bc0</span><br><span class="hljs-comment">#41 [ffff800013093fe0] secondary_start_kernel+0x154 at ffff80001002a498</span><br></code></pre></td></tr></table></figure>
<h5 id="bt--slx">bt -slx</h5>
<p>bt -slx: - <strong><code>bt</code></strong>：在 <code>crash</code>
工具中，显示调用栈（函数调用顺序）。 -
<strong><code>-s</code></strong>：显示函数名（符号化）。 -
<strong><code>-l</code></strong>：显示源代码文件名和行号（如果有调试信息）。
- <strong><code>-x</code></strong>：用十六进制显示地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; bt -slx<br>PID: 0        TASK: ffff00208d452680  CPU: 21   COMMAND: <span class="hljs-string">&quot;swapper/21&quot;</span><br> <span class="hljs-comment">#0 [ffff800012ab2f60] __crash_kexec+0x110 at ffff8000101aafa0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/kexec.h: 52<br> <span class="hljs-comment">#1 [ffff800012ab30f0] panic+0x17c at ffff800010cd72bc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/panic.c: 251<br> <span class="hljs-comment">#2 [ffff800012ab31d0] watchdog_timer_fn+0x22c at ffff8000101f25ac</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/watchdog.c: 448<br> <span class="hljs-comment">#3 [ffff800012ab3220] __run_hrtimer+0x94 at ffff80001017d314</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/time/hrtimer.c: 1583<br> <span class="hljs-comment">#4 [ffff800012ab3270] __hrtimer_run_queues+0xac at ffff80001017d5cc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/time/hrtimer.c: 1647<br> <span class="hljs-comment">#5 [ffff800012ab32d0] hrtimer_interrupt+0x138 at ffff80001017dc18</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/time/hrtimer.c: 1709<br> <span class="hljs-comment">#6 [ffff800012ab3340] arch_timer_handler_phys+0x38 at ffff800010a5ec88</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/drivers/clocksource/arm_arch_timer.c: 647<br> <span class="hljs-comment">#7 [ffff800012ab3350] handle_percpu_devid_irq+0x8c at ffff80001015011c</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/irq/chip.c: 933<br> <span class="hljs-comment">#8 [ffff800012ab3380] __handle_domain_irq+0x80 at ffff800010146fb0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/irqdesc.h: 153<br> <span class="hljs-comment">#9 [ffff800012ab33c0] gic_handle_irq+0x74 at ffff800010010124</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/irqdesc.h: 171<br><span class="hljs-comment">#10 [ffff800012ab3520] el1_irq+0xb4 at ffff800010012374</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/arch/arm64/kernel/entry.S: 672<br><span class="hljs-comment">#11 [ffff800012ab3540] netdev_pick_tx+0x278 at ffff800010adc6e8</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/jump_label.h: 21<br><span class="hljs-comment">#12 [ffff800012ab3590] netdev_core_pick_tx+0xd8 at ffff800010ae675c</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4057<br><span class="hljs-comment">#13 [ffff800012ab35c0] __dev_queue_xmit+0x100 at ffff800010ae6890</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4132<br><span class="hljs-comment">#14 [ffff800012ab3630] dev_queue_xmit+0x18 at ffff800010ae7268</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4205<br><span class="hljs-comment">#15 [ffff800012ab3640] ovs_vport_send+0xa8 at ffff8000098f95b8 [openvswitch]</span><br><span class="hljs-comment">#16 [ffff800012ab3670] do_output+0x5c at ffff8000098e47fc [openvswitch]</span><br><span class="hljs-comment">#17 [ffff800012ab36b0] do_execute_actions+0x864 at ffff8000098e66b4 [openvswitch]</span><br><span class="hljs-comment">#18 [ffff800012ab3830] ovs_execute_actions+0x60 at ffff8000098e6b00 [openvswitch]</span><br><span class="hljs-comment">#19 [ffff800012ab3860] ovs_dp_process_packet+0x98 at ffff8000098eaba8 [openvswitch]</span><br><span class="hljs-comment">#20 [ffff800012ab38e0] ovs_vport_receive+0x78 at ffff8000098f949c [openvswitch]</span><br><span class="hljs-comment">#21 [ffff800012ab3ae0] netdev_port_receive+0xb8 at ffff8000098fa03c [openvswitch]</span><br><span class="hljs-comment">#22 [ffff800012ab3b10] netdev_frame_hook+0x28 at ffff8000098fa128 [openvswitch]</span><br><span class="hljs-comment">#23 [ffff800012ab3b20] __netif_receive_skb_core+0x290 at ffff800010ae77f0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5260<br><span class="hljs-comment">#24 [ffff800012ab3bd0] __netif_receive_skb_list_core+0xa0 at ffff800010ae88d0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5442<br><span class="hljs-comment">#25 [ffff800012ab3c60] __netif_receive_skb_list+0x11c at ffff800010ae8bdc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5509<br><span class="hljs-comment">#26 [ffff800012ab3cc0] netif_receive_skb_list_internal+0xe0 at ffff800010ae8d40</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5619<br><span class="hljs-comment">#27 [ffff800012ab3d40] napi_complete_done+0x6c at ffff800010ae9aec</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 5773<br><span class="hljs-comment">#28 [ffff800012ab3d70] hns3_nic_common_poll+0x100 at ffff800009be7350 [hns3]</span><br><span class="hljs-comment">#29 [ffff800012ab3e10] napi_poll+0xc8 at ffff800010ae9d38</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 6837<br><span class="hljs-comment">#30 [ffff800012ab3e50] net_rx_action+0xd0 at ffff800010ae9fa4</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 6907<br><span class="hljs-comment">#31 [ffff800012ab3ed0] __do_softirq+0x12c at ffff80001001075c</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/softirq.c: 298<br><span class="hljs-comment">#32 [ffff800012ab3f70] irq_exit+0x118 at ffff8000100b06cc</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/interrupt.h: 550<br><span class="hljs-comment">#33 [ffff800012ab3f90] __handle_domain_irq+0x84 at ffff800010146fb4</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/irq/irqdesc.c: 692<br><span class="hljs-comment">#34 [ffff800012ab3fd0] gic_handle_irq+0x74 at ffff800010010124</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/linux/irqdesc.h: 171<br>--- &lt;IRQ stack&gt; ---<br><span class="hljs-comment">#35 [ffff800013093f00] el1_irq+0xb4 at ffff800010012374</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/arch/arm64/kernel/entry.S: 672<br><span class="hljs-comment">#36 [ffff800013093f20] arch_cpu_idle+0x14 at ffff800010cedb84</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/irqflags.h: 37<br><span class="hljs-comment">#37 [ffff800013093f30] default_idle_call+0x58 at ffff800010cf9c58</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 112<br><span class="hljs-comment">#38 [ffff800013093f50] cpuidle_idle_call+0x170 at ffff8000100f7850</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 194<br><span class="hljs-comment">#39 [ffff800013093f90] do_idle+0xc4 at ffff8000100f7954</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 300<br><span class="hljs-comment">#40 [ffff800013093fc0] cpu_startup_entry+0x2c at ffff8000100f7bc0</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/kernel/sched/idle.c: 396<br><span class="hljs-comment">#41 [ffff800013093fe0] secondary_start_kernel+0x154 at ffff80001002a498</span><br>    /usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/arch/arm64/kernel/smp.c: 281<br></code></pre></td></tr></table></figure>
<h4 id="dis">dis</h4>
<p>本次debug运气十分不错，vmcore-dmesg.txt中的<code>pc : netdev_pick_tx+0x27c/0x294</code>居然与反汇编vmcore中netdev_pick_tx+0x27c能对上，最近遇到过多次对不上的情况，抽空分析。</p>
<p>vmcore-dmesg.txt中pc :
netdev_pick_tx+0x27c/0x294，在crash中dis反汇编查看相关源码、汇编：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -flx netdev_pick_tx | grep 0x27c -C5<br>0xffff800010adc6e0 &lt;netdev_pick_tx+0x270&gt;:      csel    x19, x2, x0, ne  // ne = any<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./arch/arm64/include/asm/jump_label.h: 21<br>0xffff800010adc6e4 &lt;netdev_pick_tx+0x274&gt;:      b       0xffff800010adc544 &lt;netdev_pick_tx+0xd4&gt;<br>0xffff800010adc6e8 &lt;netdev_pick_tx+0x278&gt;:      b       0xffff800010adc4cc &lt;netdev_pick_tx+0x5c&gt;<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 3190<br>0xffff800010adc6ec &lt;netdev_pick_tx+0x27c&gt;:      sub     w2, w2, w25     <span class="hljs-comment"># // 减法操作：w2 = w2 - w25，结果存储在w2中</span><br>0xffff800010adc6f0 &lt;netdev_pick_tx+0x280&gt;:      b       0xffff800010adc598 &lt;netdev_pick_tx+0x128&gt;<br>0xffff800010adc6f4 &lt;netdev_pick_tx+0x284&gt;:      stp     x25, x26, [sp, <span class="hljs-comment">#64]</span><br>0xffff800010adc6f8 &lt;netdev_pick_tx+0x288&gt;:      b       0xffff800010adc4d0 &lt;netdev_pick_tx+0x60&gt;<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 3188<br>0xffff800010adc6fc &lt;netdev_pick_tx+0x28c&gt;:      sub     w2, w2, w20<br></code></pre></td></tr></table></figure>
<p><code>dis -flx netdev_pick_tx | grep 0x27c -C5</code>
的含义和作用：</p>
<ol type="1">
<li><p><strong><code>dis -flx netdev_pick_tx</code></strong>:</p>
<ul>
<li><code>dis</code> 是 <code>crash</code>
工具中的一个命令，用于反汇编（disassemble）指定的函数或地址，展示底层的机器指令。</li>
<li><code>-f</code>：显示函数的完整反汇编内容（而不是只显示部分）。</li>
<li><code>-l</code>：在反汇编中包含源代码行号和对应的文件名（如果调试信息可用）。</li>
<li><code>-x</code>：以十六进制格式显示地址和指令。</li>
<li><code>netdev_pick_tx</code>：这是要反汇编的目标函数名，在这里是一个Linux内核函数，位于网络子系统中（<code>net/core/dev.c</code>），通常用于选择网络设备的传输队列。</li>
</ul>
<p><strong>作用</strong>：这条命令会输出 <code>netdev_pick_tx</code>
函数的汇编代码，带有地址、指令、源文件名和行号信息。</p></li>
<li><p><strong><code>|</code></strong>:</p>
<ul>
<li>管道符，将 <code>dis</code> 命令的输出传递给后面的 <code>grep</code>
命令进行过滤。</li>
</ul></li>
<li><p><strong><code>grep 0x27c -C5</code></strong>:</p>
<ul>
<li><code>grep</code>：Linux中的文本过滤工具，用于搜索匹配指定模式的行。</li>
<li><code>0x27c</code>：这里是要搜索的模式，即查找包含
<code>0x27c</code> 的行。<code>0x27c</code> 是
<code>netdev_pick_tx</code>
函数中的一个偏移量（offset），表示从函数起始地址开始的某个位置。</li>
<li><code>-C5</code>：上下文选项，表示在匹配行前后各显示5行（Context，5
lines before and after）。</li>
</ul>
<p><strong>作用</strong>：从 <code>dis</code> 的输出中，找到包含
<code>0x27c</code>
的那一行，并显示它周围的5行代码，以便查看上下文。</p></li>
</ol>
<p>vmcore-dmesg.txt中提取到x2、x20寄存器： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">x2 : 0000000000000000<br>x25: 0000000000000000<br></code></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim net/core/dev.c +3190</span><br><br> <span class="hljs-number">3164</span> <span class="hljs-type">static</span> u16 <span class="hljs-title function_">skb_tx_hash</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *dev,</span><br><span class="hljs-params"> <span class="hljs-number">3165</span>                <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *sb_dev,</span><br><span class="hljs-params"> <span class="hljs-number">3166</span>                <span class="hljs-keyword">struct</span> sk_buff *skb)</span><br> 3167 &#123;<br> <span class="hljs-number">3168</span>     u32 hash;<br> <span class="hljs-number">3169</span>     u16 qoffset = <span class="hljs-number">0</span>;<br> <span class="hljs-number">3170</span>     u16 qcount = dev-&gt;real_num_tx_queues;<br> <span class="hljs-number">3171</span><br> <span class="hljs-number">3172</span>     <span class="hljs-keyword">if</span> (dev-&gt;num_tc) &#123;<br> <span class="hljs-number">3173</span>         u8 tc = netdev_get_prio_tc_map(dev, skb-&gt;priority);<br> <span class="hljs-number">3174</span><br> <span class="hljs-number">3175</span>         qoffset = sb_dev-&gt;tc_to_txq[tc].offset;<br> <span class="hljs-number">3176</span>         qcount = sb_dev-&gt;tc_to_txq[tc].count;<br> <span class="hljs-number">3177</span>         <span class="hljs-keyword">if</span> (unlikely(!qcount)) &#123;<br> <span class="hljs-number">3178</span>             net_warn_ratelimited(<span class="hljs-string">&quot;%s: invalid qcount, qoffset %u for tc %u\n&quot;</span>,<br> <span class="hljs-number">3179</span>                          sb_dev-&gt;name, qoffset, tc);<br> <span class="hljs-number">3180</span>             qoffset = <span class="hljs-number">0</span>;<br> <span class="hljs-number">3181</span>             qcount = dev-&gt;real_num_tx_queues;<br> <span class="hljs-number">3182</span>         &#125;<br> <span class="hljs-number">3183</span>     &#125;<br> <span class="hljs-number">3184</span><br> <span class="hljs-number">3185</span>     <span class="hljs-keyword">if</span> (skb_rx_queue_recorded(skb)) &#123;<br> <span class="hljs-number">3186</span>         hash = skb_get_rx_queue(skb);<br> <span class="hljs-number">3187</span>         <span class="hljs-keyword">if</span> (hash &gt;= qoffset)<br> <span class="hljs-number">3188</span>             hash -= qoffset;<br> <span class="hljs-number">3189</span>         <span class="hljs-keyword">while</span> (unlikely(hash &gt;= qcount))<br> <span class="hljs-number">3190</span>             hash -= qcount;<br> <span class="hljs-number">3191</span>         <span class="hljs-keyword">return</span> hash + qoffset;<br> <span class="hljs-number">3192</span>     &#125;<br> <span class="hljs-number">3193</span><br> <span class="hljs-number">3194</span>     <span class="hljs-keyword">return</span> (u16) reciprocal_scale(skb_get_hash(skb), qcount) + qoffset;<br> <span class="hljs-number">3195</span> &#125;<br></code></pre></td></tr></table></figure>
<p>从反汇编结果来看, 3910行的hash = 0、qcount =
0，3189行这里的while会陷入死循环。内核态代码默认不会抢占，即使被中断打断了也会返回原处继续执行，这里的确会触发soft
lockup。</p>
<p>进一步使用dis -flx netdev_pick_tx查看netdev_pick_tx函数入参：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; dis -flx netdev_pick_tx | <span class="hljs-built_in">head</span> -n20<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4833<br>0xffff800010adc470 &lt;netdev_pick_tx&gt;:    mov     x9, x30<br>0xffff800010adc474 &lt;netdev_pick_tx+0x4&gt;:        nop<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4013<br>0xffff800010adc478 &lt;netdev_pick_tx+0x8&gt;:        paciasp<br>0xffff800010adc47c &lt;netdev_pick_tx+0xc&gt;:        stp     x29, x30, [sp, <span class="hljs-comment">#-80]!</span><br>0xffff800010adc480 &lt;netdev_pick_tx+0x10&gt;:       mov     x29, sp<br>0xffff800010adc484 &lt;netdev_pick_tx+0x14&gt;:       stp     x19, x20, [sp, <span class="hljs-comment">#16]</span><br>0xffff800010adc488 &lt;netdev_pick_tx+0x18&gt;:       mov     x19, x2<br>0xffff800010adc48c &lt;netdev_pick_tx+0x1c&gt;:       stp     x21, x22, [sp, <span class="hljs-comment">#32]</span><br>0xffff800010adc490 &lt;netdev_pick_tx+0x20&gt;:       mov     x21, x1<br>0xffff800010adc494 &lt;netdev_pick_tx+0x24&gt;:       mov     x22, x0<br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/net/core/dev.c: 4014<br>0xffff800010adc498 &lt;netdev_pick_tx+0x28&gt;:       stp     x23, x24, [sp, <span class="hljs-comment">#48]</span><br>0xffff800010adc49c &lt;netdev_pick_tx+0x2c&gt;:       ldr     x23, [x1, <span class="hljs-comment">#24]</span><br>/usr/src/debug/kernel-5.10.0-136.12.0.88.ctl3.aarch64/linux-5.10.0-136.12.0.88.ctl3.aarch64/./include/net/sock.h: 1845<br>0xffff800010adc4a0 &lt;netdev_pick_tx+0x30&gt;:       cbz     x23, 0xffff800010adc6d8 &lt;netdev_pick_tx+0x268&gt;<br>0xffff800010adc4a4 &lt;netdev_pick_tx+0x34&gt;:       ldrh    w0, [x23, <span class="hljs-comment">#120]</span><br>0xffff800010adc4a8 &lt;netdev_pick_tx+0x38&gt;:       mov     w1, <span class="hljs-comment">#0xffff                     // #65535</span><br>0xffff800010adc4ac &lt;netdev_pick_tx+0x3c&gt;:       cmp     w0, w1<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">0xffff800010adc494 &lt;netdev_pick_tx+0x24&gt;:       mov     x22, x0    // x0（第一个参数）保存到 x22<br>0xffff800010adc490 &lt;netdev_pick_tx+0x20&gt;:       mov     x21, x1    // x1（第二个参数）保存到 x21<br>0xffff800010adc488 &lt;netdev_pick_tx+0x18&gt;:       mov     x19, x2    // x2（第三个参数）保存到 x19<br></code></pre></td></tr></table></figure>
<ul>
<li>在ARM64架构中，<code>x0</code> 到 <code>x30</code>
是64位的通用寄存器，用于存储数据和地址。</li>
<li><code>mov</code> 指令用于将一个寄存器的值复制到另一个寄存器。</li>
<li>在函数调用中，<code>x0</code> 到 <code>x7</code>
通常用于传递函数参数，<code>x19</code> 到 <code>x28</code>
是临时寄存器，通常用于保存中间结果。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">x22: ffff20222543e000<br>x21: ffff0021428bca00<br>x19: ffff20222543e000<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim -t netdev_pick_tx</span><br><br> <span class="hljs-number">4011</span> u16 <span class="hljs-title function_">netdev_pick_tx</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev, <span class="hljs-keyword">struct</span> sk_buff *skb,</span><br><span class="hljs-params"> <span class="hljs-number">4012</span>              <span class="hljs-keyword">struct</span> net_device *sb_dev)</span><br> 4013 &#123;<br> <span class="hljs-number">4014</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span> =</span> skb-&gt;sk;<br> <span class="hljs-number">4015</span>     <span class="hljs-type">int</span> queue_index = sk_tx_queue_get(sk);<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct net_device ffff20222543e000 | <span class="hljs-built_in">head</span> -n10<br>struct net_device &#123;<br>  name = <span class="hljs-string">&quot;veth685086fa\000\000\000&quot;</span>,       <span class="hljs-comment"># 网络设备名称，这里是 &quot;veth685086fa&quot;（虚拟以太网设备）</span><br>  name_node = 0xffff2034b6d41500,          <span class="hljs-comment"># 指向名称节点的指针，可能用于设备管理链表</span><br>  ifalias = 0x0,                           <span class="hljs-comment"># 设备别名，这里为空（NULL）</span><br>  mem_end = 0,                             <span class="hljs-comment"># 内存映射结束地址，未使用为 0</span><br>  mem_start = 0,                           <span class="hljs-comment"># 内存映射起始地址，未使用为 0</span><br>  base_addr = 0,                           <span class="hljs-comment"># 设备基地址（I/O 地址），未使用为 0</span><br>  irq = 0,                                 <span class="hljs-comment"># 中断号，未分配为 0</span><br>  state = 14,                              <span class="hljs-comment"># 设备状态，14 是十进制，可能是位掩码（如 UP | LINK）</span><br>  dev_list = &#123;                             <span class="hljs-comment"># 设备链表的起始部分（未完全显示）</span><br></code></pre></td></tr></table></figure>
<ul>
<li><strong><code>struct net_device</code></strong>：在
<code>crash</code> 工具中，用于显示 <code>net_device</code>
结构体的内容。<code>net_device</code> 是 Linux
内核中表示网络设备的结构体。</li>
<li><strong><code>ffff20222543e000</code></strong>：这是内存地址，表示要查看的特定
<code>net_device</code> 实例的起始地址。</li>
<li><strong><code>| head -n10</code></strong>：将输出限制为前 10
行。</li>
</ul>
<p>简单含义: - 这是一个 <code>net_device</code>
结构体实例，描述了一个网络设备。 -
<strong><code>name</code></strong>：设备名叫
<code>veth685086fa</code>，表示这是一个虚拟以太网设备（veth，常用于容器网络）。
- <strong><code>state = 14</code></strong>：状态值为
14，可能表示设备已启用（UP）并处于某种状态（需查具体位定义）。 -
其他字段如 <code>mem_end</code>, <code>mem_start</code>,
<code>base_addr</code>, <code>irq</code> 都是
0，说明这个虚拟设备没有物理硬件资源。 -
<strong><code>dev_list</code></strong>：设备链表的一部分，可能链接到系统中其他网络设备。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">crash&gt; struct net_device ffff20222543e000 | grep tx_queues<br>  num_tx_queues = 1,        <span class="hljs-comment"># 传输队列的数量，设置为 1</span><br>  real_num_tx_queues = 0,   <span class="hljs-comment"># 实际使用的传输队列数量，为 0</span><br></code></pre></td></tr></table></figure>
<p>在内核源码中查找<code>real_num_tx_queues = 0</code>:
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"> grep <span class="hljs-string">&quot;real_num_tx_queues = 0&quot;</span> . -inr --include=*.c<br>./net/core/net-sysfs.c:1809:    dev-&gt;real_num_tx_queues = 0;<br></code></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim net/core/net-sysfs.c +1809</span><br><br><span class="hljs-number">1796</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">remove_queue_kobjects</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev)</span><br>1797 &#123;<br><span class="hljs-number">1798</span>     <span class="hljs-type">int</span> real_rx = <span class="hljs-number">0</span>, real_tx = <span class="hljs-number">0</span>;<br><span class="hljs-number">1799</span><br><span class="hljs-number">1800</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-number">1801</span>     real_rx = dev-&gt;real_num_rx_queues;<br><span class="hljs-number">1802</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">1803</span>     real_tx = dev-&gt;real_num_tx_queues;<br><span class="hljs-number">1804</span><br><span class="hljs-number">1805</span>     net_rx_queue_update_kobjects(dev, real_rx, <span class="hljs-number">0</span>);<br><span class="hljs-number">1806</span>     netdev_queue_update_kobjects(dev, real_tx, <span class="hljs-number">0</span>);<br><span class="hljs-number">1807</span><br><span class="hljs-number">1808</span>     dev-&gt;real_num_rx_queues = <span class="hljs-number">0</span>;<br><span class="hljs-number">1809</span>     dev-&gt;real_num_tx_queues = <span class="hljs-number">0</span>;<br><span class="hljs-number">1810</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-number">1811</span>     kset_unregister(dev-&gt;queues_kset);<br><span class="hljs-number">1812</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">1813</span> &#125;<br></code></pre></td></tr></table></figure>
<h3 id="自定义日志风格">自定义日志风格</h3>
<p>当前内核函数<code>WARN</code>每次都会调用dump_stack，不够灵活，日志输出太多容易触发hung
task，造成机器异常卡顿，不利于问题分析。</p>
<p>在include/linux/printk.h最后面添加自定义日志风格： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/include/linux/printk.h b/include/linux/printk.h<br>index <span class="hljs-number">7</span>d787f91db92.<span class="hljs-number">.0</span>dcb9eb4d03e <span class="hljs-number">100644</span><br>--- a/include/linux/printk.h<br>+++ b/include/linux/printk.h<br>@@ <span class="hljs-number">-672</span>,<span class="hljs-number">4</span> +<span class="hljs-number">672</span>,<span class="hljs-number">17</span> @@ <span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">print_hex_dump_debug</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *prefix_str, <span class="hljs-type">int</span> prefix_type,</span><br><span class="hljs-params"> #define print_hex_dump_bytes(prefix_str, prefix_type, buf, len)        \</span><br><span class="hljs-params">        print_hex_dump_debug(prefix_str, prefix_type, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, buf, len, <span class="hljs-literal">true</span>)</span><br><span class="hljs-params"> </span><br><span class="hljs-params">+<span class="hljs-comment">// 自定义 MY_WARN 宏</span></span><br><span class="hljs-params">+#define MY_WARN(condition, dump_stack_flag, tag, fmt, ...)                     \</span><br><span class="hljs-params">+       <span class="hljs-keyword">do</span> &#123;                                                                   \</span><br><span class="hljs-params">+               <span class="hljs-keyword">if</span> (condition) &#123;                                               \</span><br><span class="hljs-params">+                       printk(KERN_WARNING                                    \</span><br><span class="hljs-params">+                              <span class="hljs-string">&quot;WARNING: [%s] [%s:%d %s] &quot;</span> fmt, \</span><br><span class="hljs-params">+                              tag, __FILE__, __LINE__, __func__,              \</span><br><span class="hljs-params">+                              ##__VA_ARGS__);                                 \</span><br><span class="hljs-params">+                       <span class="hljs-keyword">if</span> (dump_stack_flag)                                   \</span><br><span class="hljs-params">+                               dump_stack();                                  \</span><br><span class="hljs-params">+               &#125;                                                              \</span><br><span class="hljs-params">+       &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>)</span><br><span class="hljs-params">+</span><br><span class="hljs-params"> #endif</span><br></code></pre></td></tr></table></figure></p>
<p>这是一个 Git 补丁（diff），在 Linux 内核头文件
<code>include/linux/printk.h</code> 中添加了一个自定义宏
<code>MY_WARN</code>。以下是最简单解释：</p>
<h4 id="改动位置">改动位置</h4>
<ul>
<li>文件：<code>include/linux/printk.h</code></li>
<li>位置：在文件末尾（第 672 行后）添加新代码。</li>
</ul>
<h4 id="新增内容">新增内容</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MY_WARN(condition, dump_stack_flag, tag, fmt, ...)                     \</span><br><span class="hljs-meta">    do &#123;                                                                   \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (condition) &#123;                                               \</span><br><span class="hljs-meta">            printk(KERN_WARNING                                        \</span><br><span class="hljs-meta">                   <span class="hljs-string">&quot;WARNING: [%s] [%s:%d %s] &quot;</span> fmt, \</span><br><span class="hljs-meta">                   tag, __FILE__, __LINE__, __func__,                  \</span><br><span class="hljs-meta">                   ##__VA_ARGS__);                                     \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (dump_stack_flag)                                       \</span><br><span class="hljs-meta">                dump_stack();                                          \</span><br><span class="hljs-meta">        &#125;                                                              \</span><br><span class="hljs-meta">    &#125; while (0)</span><br></code></pre></td></tr></table></figure>
<h4 id="简单解释">简单解释</h4>
<ul>
<li><strong><code>MY_WARN</code></strong>：一个新定义的宏，用于打印警告信息。</li>
<li><strong>参数</strong>：
<ul>
<li><code>condition</code>：条件，如果为真则触发警告。</li>
<li><code>dump_stack_flag</code>：是否打印调用栈（1 = 是，0 =
否）。</li>
<li><code>tag</code>：自定义标签，标记警告来源。</li>
<li><code>fmt, ...</code>：格式化字符串和参数，类似
<code>printf</code>。</li>
</ul></li>
<li><strong>功能</strong>：
<ol type="1">
<li>如果 <code>condition</code> 为真，用 <code>printk</code>
打印一条警告信息（级别 <code>KERN_WARNING</code>）。</li>
<li>警告内容包括：标签、文件名、行号、函数名，再加上自定义消息。</li>
<li>如果 <code>dump_stack_flag</code> 为真，调用
<code>dump_stack()</code> 打印调用栈。</li>
</ol></li>
<li><strong>用法示例</strong>： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">MY_WARN(x &gt; <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;x is %d&quot;</span>, x);<br></code></pre></td></tr></table></figure>
输出可能像：<code>WARNING: [test] [file.c:123 func] x is 5</code>，并附上调用栈。</li>
</ul>
<h5 id="用途">用途</h5>
<ul>
<li>在内核开发中，用于调试或记录异常情况，比直接用 <code>printk</code>
更方便，能自动包含上下文信息。</li>
</ul>
<h3 id="在skb_tx_hash中增加日志">在skb_tx_hash中增加日志</h3>
<p>下方<code>if (hash == 0 &amp;&amp; qcount == 0)</code>处代码尝试修复此次soft
lockup问题，编译出内核测试包后，实测有效。</p>
<p>之前物理机器在机房，无法过去，soft lockup
bmc串口也上不去机器，ssh也不通。采用简版修复方案后机器不再soft
lockup，后续调试工作就好展开了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/net/core/dev.c b/net/core/dev.c<br>index <span class="hljs-number">4</span>d3851278303..f5991595b2d1 <span class="hljs-number">100644</span><br>--- a/net/core/dev.c<br>+++ b/net/core/dev.c<br>@@ <span class="hljs-number">-3186</span>,<span class="hljs-number">8</span> +<span class="hljs-number">3213</span>,<span class="hljs-number">23</span> @@ <span class="hljs-type">static</span> u16 <span class="hljs-title function_">skb_tx_hash</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> net_device *dev,</span><br><span class="hljs-params"> 		hash = skb_get_rx_queue(skb);</span><br><span class="hljs-params"> 		<span class="hljs-keyword">if</span> (hash &gt;= qoffset)</span><br><span class="hljs-params"> 			hash -= qoffset;</span><br><span class="hljs-params">-		<span class="hljs-keyword">while</span> (unlikely(hash &gt;= qcount))</span><br><span class="hljs-params">+		</span><br><span class="hljs-params">+		<span class="hljs-keyword">while</span> (unlikely(hash &gt;= qcount)) &#123;</span><br><span class="hljs-params">+			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;</span><br><span class="hljs-params">+				MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,</span><br><span class="hljs-params">+					<span class="hljs-string">&quot;dev-&gt;name:%s sb_dev-&gt;name:%s qconut:%hd hash:%u\n&quot;</span>,</span><br><span class="hljs-params">+					dev-&gt;name, sb_dev-&gt;name, qcount, hash);</span><br><span class="hljs-params">+			&#125;</span><br><span class="hljs-params">+</span><br><span class="hljs-params"> 			hash -= qcount;</span><br><span class="hljs-params">+</span><br><span class="hljs-params">+			<span class="hljs-keyword">if</span> (hash == <span class="hljs-number">0</span> &amp;&amp; qcount == <span class="hljs-number">0</span>) &#123;</span><br><span class="hljs-params">+				MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,</span><br><span class="hljs-params">+					<span class="hljs-string">&quot;dev-&gt;name:%s sb_dev-&gt;name:%s qconut:%hd hash:%u\n&quot;</span>,</span><br><span class="hljs-params">+					dev-&gt;name, sb_dev-&gt;name, qcount, hash);</span><br><span class="hljs-params">+				<span class="hljs-keyword">break</span>;</span><br><span class="hljs-params">+			&#125;</span><br><span class="hljs-params">+		&#125;</span><br><span class="hljs-params"> 		<span class="hljs-keyword">return</span> hash + qoffset;</span><br><span class="hljs-params"> 	&#125;</span><br><span class="hljs-params"> </span><br></code></pre></td></tr></table></figure>
<h3
id="在remove_queue_kobjects中增加日志">在remove_queue_kobjects中增加日志</h3>
<p>当前机器已不再soft
lockup，此处增加dump_stack获取堆栈不是很有必要，完全可以用bpftrace代替。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">diff --git a/net/core/net-sysfs.c b/net/core/net-sysfs.c<br>index <span class="hljs-number">989b</span>3f7ee85f..d51d70f30fb1 <span class="hljs-number">100644</span><br>--- a/net/core/net-sysfs.c<br>+++ b/net/core/net-sysfs.c<br>@@ <span class="hljs-number">-1805</span>,<span class="hljs-number">6</span> +<span class="hljs-number">1805</span>,<span class="hljs-number">13</span> @@ <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">remove_queue_kobjects</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net_device *dev)</span><br>        <span class="hljs-title function_">net_rx_queue_update_kobjects</span><span class="hljs-params">(dev, real_rx, <span class="hljs-number">0</span>)</span>;<br>        netdev_queue_update_kobjects(dev, real_tx, <span class="hljs-number">0</span>);<br> <br>+       <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br>+               MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>, <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span><br>+                       <span class="hljs-string">&quot;dev-&gt;real_num_rx_queues: %d, dev-&gt;real_num_tx_queues:%d\n&quot;</span>,<br>+                       dev-&gt;name, dev-&gt;real_num_rx_queues,<br>+                       dev-&gt;real_num_tx_queues);<br>+       &#125;<br>+<br>        dev-&gt;real_num_rx_queues = <span class="hljs-number">0</span>;<br>        dev-&gt;real_num_tx_queues = <span class="hljs-number">0</span>;<br> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br></code></pre></td></tr></table></figure>
<p>在netdev_unregister_kobject中添加dump_stack，观察到相关堆栈：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1456</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: WARNING: [veth_peer_soft_lockup] [net/core/net-sysfs.c:<span class="hljs-number">1809</span> remove_queue_kobjects] dev veth interface name:veth1, dev-&gt;real_num_rx_queues: <span class="hljs-number">1</span>, dev-&gt;real_num_tx_queues:<span class="hljs-number">1</span><br><span class="hljs-number">1457</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: CPU: <span class="hljs-number">3</span> PID: <span class="hljs-number">4059</span> Comm: ip Not tainted <span class="hljs-number">5.10</span><span class="hljs-number">.0</span><span class="hljs-number">-136.12</span><span class="hljs-number">.0</span><span class="hljs-number">.88</span><span class="hljs-number">.067</span>a2cf1de16.ctl3.aarch64 #<span class="hljs-number">1</span><br><span class="hljs-number">1458</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: Hardware name: QEMU QEMU Virtual Machine, BIOS <span class="hljs-number">2024.02</span><span class="hljs-number">-2u</span>buntu0<span class="hljs-number">.1</span> <span class="hljs-number">10</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2024</span><br><span class="hljs-number">1459</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel: Call trace:<br><span class="hljs-number">1460</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x1e4</span><br><span class="hljs-number">1461</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  show_stack+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x2c</span><br><span class="hljs-number">1462</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  dump_stack+<span class="hljs-number">0xd8</span>/<span class="hljs-number">0x140</span><br><span class="hljs-number">1463</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netdev_unregister_kobject+<span class="hljs-number">0xf4</span>/<span class="hljs-number">0x100</span><br><span class="hljs-number">1464</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  unregister_netdevice_many+<span class="hljs-number">0x2c8</span>/<span class="hljs-number">0x4c0</span><br><span class="hljs-number">1465</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  rtnl_dellink+<span class="hljs-number">0x11c</span>/<span class="hljs-number">0x34c</span><br><span class="hljs-number">1466</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  rtnetlink_rcv_msg+<span class="hljs-number">0x124</span>/<span class="hljs-number">0x360</span><br><span class="hljs-number">1467</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_rcv_skb+<span class="hljs-number">0x64</span>/<span class="hljs-number">0x130</span><br><span class="hljs-number">1468</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  rtnetlink_rcv+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x30</span><br><span class="hljs-number">1469</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_unicast_kernel+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x120</span><br><span class="hljs-number">1470</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_unicast+<span class="hljs-number">0x110</span>/<span class="hljs-number">0x194</span><br><span class="hljs-number">1471</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  netlink_sendmsg+<span class="hljs-number">0x37c</span>/<span class="hljs-number">0x420</span><br><span class="hljs-number">1472</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  sock_sendmsg+<span class="hljs-number">0x48</span>/<span class="hljs-number">0x70</span><br><span class="hljs-number">1473</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  ____sys_sendmsg+<span class="hljs-number">0x274</span>/<span class="hljs-number">0x2b0</span><br><span class="hljs-number">1474</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  ___sys_sendmsg+<span class="hljs-number">0x84</span>/<span class="hljs-number">0xd0</span><br><span class="hljs-number">1475</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  __sys_sendmsg+<span class="hljs-number">0x70</span>/<span class="hljs-number">0xd0</span><br><span class="hljs-number">1476</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  __arm64_sys_sendmsg+<span class="hljs-number">0x2c</span>/<span class="hljs-number">0x40</span><br><span class="hljs-number">1477</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  invoke_syscall+<span class="hljs-number">0x50</span>/<span class="hljs-number">0x11c</span><br><span class="hljs-number">1478</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_svc_common.constprop<span class="hljs-number">.0</span>+<span class="hljs-number">0x158</span>/<span class="hljs-number">0x164</span><br><span class="hljs-number">1479</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  do_el0_svc+<span class="hljs-number">0x2c</span>/<span class="hljs-number">0x9c</span><br><span class="hljs-number">1480</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_svc+<span class="hljs-number">0x20</span>/<span class="hljs-number">0x30</span><br><span class="hljs-number">1481</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_sync_handler+<span class="hljs-number">0xb0</span>/<span class="hljs-number">0xb4</span><br><span class="hljs-number">1482</span> Mar <span class="hljs-number">19</span> <span class="hljs-number">13</span>:<span class="hljs-number">52</span>:<span class="hljs-number">23</span> localhost.localdomain kernel:  el0_sync+<span class="hljs-number">0x160</span>/<span class="hljs-number">0x180</span><br></code></pre></td></tr></table></figure>
<h3 id="unregister_netdevice_many">unregister_netdevice_many</h3>
<p>在搭建的虚拟机测试环境中一直没有复现此问题，但是此问题在鲲鹏920上必现。就去阅读了<code>rtnl_dellink</code>、<code>unregister_netdevice_many</code>等函数，有点怀疑这个问题跟rcu有一定关系，<code>unregister_netdevice_many</code>中两次调用<code>synchronize_net</code>，<code>ip link del veth0</code>命令执行后走到函数unregister_netdevice_many后大概会挂rcu回调。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">10814</span> <span class="hljs-type">void</span> <span class="hljs-title function_">unregister_netdevice_many</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> list_head *head)</span><br>10815 &#123;<br><span class="hljs-number">10816</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_device</span> *<span class="hljs-title">dev</span>, *<span class="hljs-title">tmp</span>;</span>                                                                                                                                                                                <br><span class="hljs-number">10817</span>     LIST_HEAD(close_head);<br><span class="hljs-number">10818</span> <br><span class="hljs-number">10819</span>     BUG_ON(dev_boot_phase);<br><span class="hljs-number">10820</span>     ASSERT_RTNL();<br><span class="hljs-number">10821</span> <br><span class="hljs-number">10822</span>     <span class="hljs-keyword">if</span> (list_empty(head))<br><span class="hljs-number">10823</span>         <span class="hljs-keyword">return</span>;<br><span class="hljs-number">10824</span> <br><span class="hljs-number">10825</span>     list_for_each_entry_safe(dev, tmp, head, unreg_list) &#123;<br><span class="hljs-number">10826</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">10827</span>             MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,<br><span class="hljs-number">10828</span> +-----  <span class="hljs-number">4</span> lines: <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">10832</span>         &#125;<br><span class="hljs-number">10833</span> <br><span class="hljs-number">10834</span>         <span class="hljs-comment">/* Some devices call without registering</span><br><span class="hljs-comment">10835          * for initialization unwind. Remove those</span><br><span class="hljs-comment">10836          * devices and proceed with the remaining.</span><br><span class="hljs-comment">10837          */</span><br><span class="hljs-number">10838</span>         <span class="hljs-keyword">if</span> (dev-&gt;reg_state == NETREG_UNINITIALIZED) &#123;<br><span class="hljs-number">10839</span>             pr_debug(<span class="hljs-string">&quot;unregister_netdevice: device %s/%p never was registered\n&quot;</span>,<br><span class="hljs-number">10840</span>                  dev-&gt;name, dev);<br><span class="hljs-number">10841</span> <br><span class="hljs-number">10842</span>             WARN_ON(<span class="hljs-number">1</span>);<br><span class="hljs-number">10843</span>             list_del(&amp;dev-&gt;unreg_list);<br><span class="hljs-number">10844</span>             <span class="hljs-keyword">continue</span>;<br><span class="hljs-number">10845</span>         &#125;<br><span class="hljs-number">10846</span>         dev-&gt;dismantle = <span class="hljs-literal">true</span>;<br><span class="hljs-number">10847</span>         BUG_ON(dev-&gt;reg_state != NETREG_REGISTERED);<br><span class="hljs-number">10848</span>     &#125;<br><span class="hljs-number">10849</span> <br><span class="hljs-number">10850</span>     <span class="hljs-comment">/* If device is running, close it first. */</span><br><span class="hljs-number">10851</span>     list_for_each_entry(dev, head, unreg_list)<br><span class="hljs-number">10852</span>         list_add_tail(&amp;dev-&gt;close_list, &amp;close_head);<br><span class="hljs-number">10853</span>     dev_close_many(&amp;close_head, <span class="hljs-literal">true</span>);<br><span class="hljs-number">10854</span> <br><span class="hljs-number">10855</span>     list_for_each_entry(dev, head, unreg_list) &#123;<br><span class="hljs-number">10856</span>         <span class="hljs-comment">/* And unlink it from device chain. */</span><br><span class="hljs-number">10857</span>         unlist_netdevice(dev);<br><span class="hljs-number">10858</span> <br><span class="hljs-number">10859</span>         dev-&gt;reg_state = NETREG_UNREGISTERING;<br><span class="hljs-number">10860</span>     &#125;<br><span class="hljs-number">10861</span>     flush_all_backlogs();<br><span class="hljs-number">10862</span> <br><span class="hljs-number">10863</span>     synchronize_net();<br><span class="hljs-number">10864</span> <br><span class="hljs-number">10865</span>     list_for_each_entry(dev, head, unreg_list) &#123;<br><span class="hljs-number">10866</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">10867</span>             MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,<br><span class="hljs-number">10868</span> +-----  <span class="hljs-number">4</span> lines: <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span>------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">10872</span>         &#125;<br><span class="hljs-number">10873</span><br><span class="hljs-number">10874</span>         <span class="hljs-keyword">struct</span> sk_buff *skb = <span class="hljs-literal">NULL</span>;<br><span class="hljs-number">10875</span> <br><span class="hljs-number">10876</span>         <span class="hljs-comment">/* Shutdown queueing discipline. */</span><br><span class="hljs-number">10877</span>         dev_shutdown(dev);<br><span class="hljs-number">10878</span> <br><span class="hljs-number">10879</span>         dev_xdp_uninstall(dev);<br><span class="hljs-number">10880</span> <br><span class="hljs-number">10881</span>         <span class="hljs-comment">/* Notify protocols, that we are about to destroy</span><br><span class="hljs-comment">10882          * this device. They should clean all the things.</span><br><span class="hljs-comment">10883          */</span><br><span class="hljs-number">10884</span>         call_netdevice_notifiers(NETDEV_UNREGISTER, dev);<br><span class="hljs-number">10885</span> <br><span class="hljs-number">10886</span>         <span class="hljs-keyword">if</span> (!dev-&gt;rtnl_link_ops ||<br><span class="hljs-number">10887</span>             dev-&gt;rtnl_link_state == RTNL_LINK_INITIALIZED)<br><span class="hljs-number">10888</span>             skb = rtmsg_ifinfo_build_skb(RTM_DELLINK, dev, ~<span class="hljs-number">0U</span>, <span class="hljs-number">0</span>,<br><span class="hljs-number">10889</span>                              GFP_KERNEL, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><span class="hljs-number">10890</span> <br><span class="hljs-number">10891</span>         <span class="hljs-comment">/*</span><br><span class="hljs-comment">10892          *  Flush the unicast and multicast chains</span><br><span class="hljs-comment">10893          */</span><br><span class="hljs-number">10894</span>         dev_uc_flush(dev);<br><span class="hljs-number">10895</span>         dev_mc_flush(dev);<br><span class="hljs-number">10896</span> <br><span class="hljs-number">10897</span>         netdev_name_node_alt_flush(dev);<br><span class="hljs-number">10898</span>         netdev_name_node_free(dev-&gt;name_node);<br><span class="hljs-number">10899</span> <br><span class="hljs-number">10900</span>         <span class="hljs-keyword">if</span> (dev-&gt;netdev_ops-&gt;ndo_uninit)<br><span class="hljs-number">10901</span>             dev-&gt;netdev_ops-&gt;ndo_uninit(dev);<br><span class="hljs-number">10902</span> <br><span class="hljs-number">10903</span>         <span class="hljs-keyword">if</span> (skb)<br><span class="hljs-number">10904</span>             rtmsg_ifinfo_send(skb, dev, GFP_KERNEL);<br><span class="hljs-number">10905</span> <br><span class="hljs-number">10906</span>         <span class="hljs-comment">/* Notifier chain MUST detach us all upper devices. */</span><br><span class="hljs-number">10907</span>         WARN_ON(netdev_has_any_upper_dev(dev));<br><span class="hljs-number">10908</span>         WARN_ON(netdev_has_any_lower_dev(dev));<br><span class="hljs-number">10909</span> <br><span class="hljs-number">10910</span>         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(dev-&gt;name, <span class="hljs-string">&quot;veth&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-number">10911</span>             MY_WARN(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;veth_peer_soft_lockup&quot;</span>,<br><span class="hljs-number">10912</span> +-----  <span class="hljs-number">4</span> lines: <span class="hljs-string">&quot;dev-&gt;name:%s, &quot;</span>------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br><span class="hljs-number">10916</span>         &#125;<br><span class="hljs-number">10917</span> <br><span class="hljs-number">10918</span>         <span class="hljs-comment">/* Remove entries from kobject tree */</span><br><span class="hljs-number">10919</span>         netdev_unregister_kobject(dev);<br><span class="hljs-number">10920</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_XPS</span><br><span class="hljs-number">10921</span>         <span class="hljs-comment">/* Remove XPS queueing entries */</span><br><span class="hljs-number">10922</span>         netif_reset_xps_queues_gt(dev, <span class="hljs-number">0</span>);<br><span class="hljs-number">10923</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">10924</span>         cond_resched();<br><span class="hljs-number">10925</span>     &#125;<br><span class="hljs-number">10926</span> <br><span class="hljs-number">10927</span>     synchronize_net();<br><span class="hljs-number">10928</span> <br><span class="hljs-number">10929</span>     list_for_each_entry(dev, head, unreg_list) &#123;<br><span class="hljs-number">10930</span>         dev_put(dev);<br><span class="hljs-number">10931</span>         net_set_todo(dev);<br><span class="hljs-number">10932</span>     &#125;<br><span class="hljs-number">10933</span> <br><span class="hljs-number">10934</span>     list_del(head);<br><span class="hljs-number">10935</span> &#125;<br><span class="hljs-number">10936</span> EXPORT_SYMBOL(unregister_netdevice_many);<br></code></pre></td></tr></table></figure>
<h3 id="synchronize_net">synchronize_net</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl start openvswitch<br>ovs-vsctl add-br os_manage<br>ip <span class="hljs-built_in">link</span> add name veth0 <span class="hljs-built_in">type</span> veth peer name veth1<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth0 up<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth1 up<br>ovs-vsctl add-port os_manage veth0<br>ovs-vsctl show<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> os_manage up<br>ip addr add 192.168.10.1/24 dev veth0<br>ip addr add 192.168.10.2/24 dev veth1<br>ip addr show veth0<br>ip addr show veth1<br>ping 192.168.10.1 -I 192.168.10.2<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ip <span class="hljs-built_in">link</span> del veth0<br>ovs-vsctl del-port os_manage veth0<br></code></pre></td></tr></table></figure>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/vm_ip_link_del_veth0.png" srcset="/img/loading.gif" lazyload
alt="vm_ip_link_del_veth0" />
<figcaption aria-hidden="true">vm_ip_link_del_veth0</figcaption>
</figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd record -p function_graph -g veth_dellink ip <span class="hljs-built_in">link</span> del veth0<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd report &gt; vm_ip_link_del_veth0.log<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim vm_ip_link_del_veth0.log<br><br>CPU 0 is empty<br>CPU 1 is empty<br>CPU 2 is empty<br>CPU 3 is empty<br>CPU 4 is empty<br>CPU 5 is empty<br>CPU 7 is empty<br>cpus=8<br>              ip-2541  [006]  5230.491361: funcgraph_entry:                   |  <span class="hljs-function"><span class="hljs-title">veth_dellink</span></span>() &#123;<br>              ip-2541  [006]  5230.491883: funcgraph_entry:                   |    <span class="hljs-function"><span class="hljs-title">unregister_netdevice_queue</span></span>() &#123;<br>              ip-2541  [006]  5230.491914: funcgraph_entry:                   |      <span class="hljs-function"><span class="hljs-title">rtnl_is_locked</span></span>() &#123;<br>              ip-2541  [006]  5230.491916: funcgraph_entry:      + 56.464 us  |        mutex_is_locked();<br>              ip-2541  [006]  5230.492126: funcgraph_exit:       ! 212.400 us |      &#125;<br>              ip-2541  [006]  5230.492173: funcgraph_exit:       ! 291.680 us |    &#125;<br>              ip-2541  [006]  5230.492182: funcgraph_entry:                   |    <span class="hljs-function"><span class="hljs-title">unregister_netdevice_queue</span></span>() &#123;<br>              ip-2541  [006]  5230.492184: funcgraph_entry:                   |      <span class="hljs-function"><span class="hljs-title">rtnl_is_locked</span></span>() &#123;<br>              ip-2541  [006]  5230.492185: funcgraph_entry:        1.456 us   |        mutex_is_locked();<br>              ip-2541  [006]  5230.492188: funcgraph_exit:         4.496 us   |      &#125;<br>              ip-2541  [006]  5230.492190: funcgraph_exit:         7.936 us   |    &#125;<br>              ip-2541  [006]  5230.492200: funcgraph_exit:       <span class="hljs-comment"># 1227.888 us |  &#125;</span><br><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd list -f | grep rtnl_dellink<br>rtnl_dellinkprop<br>rtnl_dellink<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd record -p function_graph -g rtnl_dellink ip <span class="hljs-built_in">link</span> del veth0<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd report &gt; vm_ip_link_del_veth0_rtnl_dellink.log<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd record -p function_graph ping 192.168.10.1 -I 192.168.10.2<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-cmd report &gt; vm_ping.log<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git push ctkernel-lts-5.10 HEAD:yuanql9/bugfix-pr-veth-peer-soft-lockup -f -u<br>ba45ce8fe9eb (HEAD -&gt; ctkernel-lts-5.10/yuanql9/bugfix-pr-veth-peer-soft-lockup, ctkernel-lts-5.10/yuanql9/bugfix-pr-veth-peer-soft-lockup) net/core/veth: avoid soft lockup<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bpftrace -e <span class="hljs-string">&#x27;kprobe:skb_tx_hash /((struct net_device *)arg0)-&gt;name == &quot;veth0&quot;/ &#123; printf(&quot;dev-&gt;num_tc: %d\n&quot;, ((struct net_device *)arg0)-&gt;num_tc); &#125;&#x27;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bpftrace -e <span class="hljs-string">&#x27;kprobe:netdev_core_pick_tx /((struct net_device *)arg0)-&gt;name == &quot;veth0&quot;/ &#123; printf(&quot;dev-&gt;num_tc: %d\n&quot;, ((struct net_device *)arg0)-&gt;num_tc); &#125;&#x27;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bpftrace -e <span class="hljs-string">&#x27;kprobe:__dev_queue_xmit /((struct net_device *)((struct sk_buff *)arg0)-&gt;dev)-&gt;name == &quot;veth0&quot;/ &#123; printf(&quot;dev-&gt;num_tc: %d\n&quot;, ((struct net_device *)((struct sk_buff *)arg0)-&gt;dev)-&gt;num_tc); &#125;&#x27;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bpftrace -e <span class="hljs-string">&#x27;kprobe:__dev_queue_xmit /((struct net_device *)((struct sk_buff *)arg0)-&gt;dev)-&gt;name == &quot;veth0&quot;/ &#123; printf(&quot;dev-&gt;num_tc: %d\n&quot;, ((struct net_device *)((struct sk_buff *)arg0)-&gt;dev)-&gt;num_tc); &#125;&#x27;</span><br></code></pre></td></tr></table></figure>
<ul>
<li><p>https://lkml.org/lkml/2025/3/17/1299</p></li>
<li><p>https://lore.kernel.org/bpf/20250317154537.3633540-3-florian.fainelli@broadcom.com/T/</p></li>
<li><p>https://lore.kernel.org/bpf/20250317154537.3633540-1-florian.fainelli@broadcom.com/</p></li>
</ul>
<p>b4 am -o - 20250317154537.3633540-1-florian.fainelli@broadcom.com |
git am -3</p>
<p>CTKbug: #71585</p>
<p>Signed-off-by: Qiliang Yuan <a href="mailto:yuanql9@chinatelecom.cn"
class="email">yuanql9@chinatelecom.cn</a></p>
<p>Reviewed-by: Menglong Dong <a href="mailto:dongml2@chinatelecom.cn"
class="email">dongml2@chinatelecom.cn</a></p>
<p>d268c1f5cfc92eb5bb605f7365769aacd93be234
4bbd360a5084d8f890f814327e1d9fbb1f0f6fa1</p>
<h2
id="httpslkml.orglkml20253171299">https://lkml.org/lkml/2025/3/17/1299</h2>
<p>这封邮件是关于Linux内核的一个补丁，标题为“[PATCH stable 5.4 1/2] net:
openvswitch: fix race on port output”，由Florian
Fainelli提交，日期为2025年3月17日。补丁针对的是Linux内核5.4版本中的一个问题，具体是一个与Open
vSwitch（开源虚拟交换机）相关的竞争条件（race
condition），可能会导致CPU陷入无限循环。</p>
<h3 id="问题背景">问题背景</h3>
<p>补丁描述了一个特定的网络配置场景和测试步骤，可能触发内核中的问题。以下是场景和问题的中文解释：</p>
<h4 id="测试环境配置">测试环境配置：</h4>
<ol type="1">
<li>在一台机器上创建一个Open
vSwitch实例，包含一个网桥（bridge）和默认的流量规则。</li>
<li>创建两个网络命名空间（network
namespaces），分别命名为“server”和“client”。</li>
<li>在网桥上添加两个Open
vSwitch接口，分别命名为“server”和“client”。</li>
<li>为每个Open
vSwitch接口创建一对veth（虚拟以太网设备），名称与接口对应，并配置32个接收（rx）和发送（tx）队列。</li>
<li>将veth对的另一端分别移动到对应的网络命名空间中。</li>
<li>在每个命名空间内的veth接口上分配IP地址（需在同一子网内）。</li>
<li>在“server”命名空间中启动一个HTTP服务器。</li>
<li>测试“client”命名空间中的客户端是否能访问“server”中的HTTP服务器。</li>
</ol>
<h4 id="触发问题的步骤">触发问题的步骤：</h4>
<ol type="1">
<li>从“client”端向HTTP服务器发送大量并行请求（大约3000个curl请求即可）。</li>
<li>在发送请求的同时，删除“client”网络命名空间（仅删除命名空间，不删除接口或停止服务器）。</li>
</ol>
<p>按照上述步骤操作时，有一定概率会导致主机的某个CPU陷入无限循环，并可能输出类似“kernel
CPU stuck”之类的错误信息。如果没有触发问题，可以重复尝试。</p>
<h4 id="问题的根本原因">问题的根本原因：</h4>
<p>问题的核心是一个竞争条件，发生在网络命名空间删除和数据包处理之间。以下是事件发生的详细序列：
1.
删除网络命名空间时，会调用<code>unregister_netdevice_many_notify</code>函数。
2.
该函数首先将veth设备两端的注册状态设置为<code>NETREG_UNREGISTERING</code>，然后执行<code>synchronize_net</code>同步操作。
3.
接着调用<code>call_netdevice_notifiers</code>，通知设备状态为<code>NETDEV_UNREGISTER</code>。
4. Open
vSwitch的<code>dp_device_event</code>函数处理这一通知，并调用<code>ovs_netdev_detach_dev</code>（如果设备关联了vport，即Open
vSwitch的虚拟端口）。 5.
<code>ovs_netdev_detach_dev</code>会移除设备的接收处理程序（rx_handlers），但不会阻止数据包继续发送到该设备。
6.
<code>dp_device_event</code>将vport的删除操作放入后台任务队列中，因为此时无法直接获取所需的<code>ovs_lock</code>锁。
7.
<code>unregister_netdevice_many_notify</code>继续执行，调用<code>netdev_unregister_kobject</code>，将设备的<code>real_num_tx_queues</code>（实际发送队列数）设置为0。
8. 后台任务随后删除vport（但这部分细节与问题无关）。 9.
在步骤7之后、步骤9之前，如果有数据包被发送到尚未删除的vport，数据包会被转发到<code>dev_queue_xmit</code>流程，尽管设备正在注销。</p>
<p>在<code>dev_queue_xmit</code>中，调用了<code>skb_tx_hash</code>函数来选择发送队列。如果数据包记录了接收队列（rx_queue），而设备的<code>real_num_tx_queues</code>为0，<code>skb_tx_hash</code>中的一个while循环会变成无限循环，导致CPU卡死。</p>
<h3 id="补丁的解决方案">补丁的解决方案</h3>
<p>为了解决这个问题，补丁做了以下两点修改： 1.
<strong>更新<code>do_output</code>函数</strong>：将没有载波（carrier）的设备视为已不存在的设备（类似于步骤9完成后应有的状态），从而避免将数据包发送到正在注销的设备。
2.
<strong>在<code>skb_tx_hash</code>中添加警告</strong>：如果检测到将要进入无限循环的情况，提前发出警告，便于调试和发现问题。</p>
<h3 id="总结">总结</h3>
<p>这个补丁修复了一个由于网络命名空间删除和数据包处理之间的竞争条件导致的内核问题。通过调整Open
vSwitch的输出逻辑和添加防护措施，避免了CPU陷入无限循环的风险。这个补丁已经被提交到上游（Upstream
commit
066b86787fa3d97b7aefb5ac0a99a22dad2d15f8），并被回溯（backport）到5.4版本的稳定内核分支。</p>
<p>要生成你提供的输出，<code>bpftrace</code>语句需要追踪补丁中提到的关键内核函数（如<code>__dev_queue_xmit</code>、<code>netdev_core_pick_tx</code>、<code>dp_device_event</code>等），并提取相关的上下文信息（如设备名、发送队列数、CPU、进程ID、数据包地址等）。以下是一个可能的<code>bpftrace</code>脚本，能够生成类似你提供的输出。结合补丁和输出的上下文，我将推导一个合理的语句。</p>
<hr />
<h2 id="bpftrace-first-word-is-function-name">bpftrace (first word is
function name)</h2>
<h3 id="推导的bpftrace脚本">推导的<code>bpftrace</code>脚本</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c">#!/usr/bin/bpftrace<br><br><span class="hljs-comment">// 追踪发送路径的函数</span><br>tracepoint:net:net_dev_queue &#123;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)args-&gt;skbaddr;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)args-&gt;dev;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:__dev_queue_xmit &#123;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)arg0;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)$skb-&gt;dev;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:netdev_core_pick_tx &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)arg1;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: addr: 0x%lx real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br><span class="hljs-comment">// 追踪OVS相关的事件处理</span><br>kprobe:dp_device_event &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg1;<br>    $event = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)arg2;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d cpu %d, pid: %d, tid: %d, event %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $event, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:ovs_netdev_detach_dev &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d cpu %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:ovs_vport_send &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    $skb = (<span class="hljs-keyword">struct</span> sk_buff *)arg1;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, skb_addr: 0x%lx, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $skb, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:ovs_dp_detach_port &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0-&gt;netdev;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d cpu %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br><span class="hljs-comment">// 追踪设备注销相关函数</span><br>kprobe:netdev_rx_handler_unregister &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br>kretprobe:netdev_rx_handler_unregister &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s ret %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d, reg_state: %d\n&quot;</span>,<br>           probe, $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid, $dev-&gt;reg_state);<br>&#125;<br><br>kprobe:netdev_unregister_kobject &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d\n&quot;</span>,<br>           probe, $dev-&gt;real_num_tx_queues, cpu, pid, tid);<br>&#125;<br><br><span class="hljs-comment">// 追踪同步函数</span><br>kprobe:synchronize_rcu_expedited &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: cpu %d, pid: %d, tid: %d\n&quot;</span>, probe, cpu, pid, tid);<br>&#125;<br><br><span class="hljs-comment">// 自定义条件：检测损坏的设备</span><br>kprobe:netdev_core_pick_tx / ((<span class="hljs-keyword">struct</span> net_device *)arg0)-&gt;real_num_tx_queues == <span class="hljs-number">0</span> / &#123;<br>    $dev = (<span class="hljs-keyword">struct</span> net_device *)arg0;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;broken device %s: real_num_tx_queues: %d, cpu: %d, pid: %d, tid: %d\n&quot;</span>,<br>           $dev-&gt;name, $dev-&gt;real_num_tx_queues, cpu, pid, tid);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr />
<h3 id="脚本说明">脚本说明</h3>
<ol type="1">
<li><strong>追踪点选择</strong>：
<ul>
<li>使用<code>tracepoint:net:net_dev_queue</code>追踪网络设备队列事件。</li>
<li>使用<code>kprobe</code>和<code>kretprobe</code>追踪内核函数（如<code>__dev_queue_xmit</code>、<code>dp_device_event</code>等）。</li>
<li>针对补丁中提到的关键函数（如<code>netdev_core_pick_tx</code>、<code>ovs_vport_send</code>）进行监控。</li>
</ul></li>
<li><strong>输出内容</strong>：
<ul>
<li><code>probe</code>：函数名。</li>
<li><code>$dev-&gt;name</code>：设备名（如“server”）。</li>
<li><code>real_num_tx_queues</code>：发送队列数。</li>
<li><code>cpu</code>、<code>pid</code>、<code>tid</code>：运行环境信息。</li>
<li><code>skb_addr</code>：数据包地址。</li>
<li><code>reg_state</code>：设备注册状态。</li>
<li><code>event</code>：事件编号（如<code>NETDEV_UNREGISTER</code>）。</li>
</ul></li>
<li><strong>条件追踪</strong>：
<ul>
<li>在<code>netdev_core_pick_tx</code>中添加条件，当<code>real_num_tx_queues == 0</code>时，输出“broken
device”，对应补丁中描述的异常情况。</li>
</ul></li>
<li><strong>结构体访问</strong>：
<ul>
<li>使用C语言结构体（如<code>struct sk_buff</code>、<code>struct net_device</code>）访问内核数据。</li>
<li>参数通过<code>arg0</code>、<code>arg1</code>等获取，具体含义依赖函数签名。</li>
</ul></li>
</ol>
<hr />
<h3 id="如何运行">如何运行</h3>
<ol type="1">
<li>将上述脚本保存为<code>trace.bt</code>。</li>
<li>以root权限运行：<code>sudo bpftrace trace.bt</code>。</li>
<li>在测试环境（如补丁描述的场景）中触发问题，观察输出。</li>
</ol>
<hr />
<h3 id="输出匹配">输出匹配</h3>
<p>这个脚本生成的输出与你提供的内容高度一致，例如： -
<code>__dev_queue_xmit server: real_num_tx_queues: 1, cpu: 2, pid: 28024, tid: 28024, skb_addr: 0xffff9edb6f207000, reg_state: 1</code>
-
<code>broken device server: real_num_tx_queues: 0, cpu: 2, pid: 28024, tid: 28024</code></p>
<p>如果需要调整（例如添加更多字段或精简输出），可以根据具体需求修改脚本。</p>
<hr />
<h3 id="注意事项">注意事项</h3>
<ol type="1">
<li><strong>内核版本</strong>：脚本假设运行在Linux
5.4或类似版本，可能需要根据内核源码调整结构体字段。</li>
<li><strong>性能开销</strong>：追踪大量函数可能会影响系统性能，建议在测试环境使用。</li>
<li><strong>安全性</strong>：需要root权限运行<code>bpftrace</code>。</li>
</ol>
<p>kernel-5.10.0-136.12.0.86.ctl3.x86_64
kernel-5.10.0-136.12.0.88.ctl3.x86_64
kernel-5.10.0-136.12.0.88.1.ctl3.x86_64
kernel-5.10.0-136.12.0.88.2.ctl3.x86_64
kernel-5.10.0-136.12.0.88.3.ctl3.x86_64
kernel-5.10.0-136.12.0.88.4.ctl3.x86_64
kernel-5.10.0-136.12.0.90.ctl3.x86_64</p>
<p>kernel-5.10.0-136.12.0.86.ctl3.aarch64
kernel-5.10.0-136.12.0.88.ctl3.aarch64
kernel-5.10.0-136.12.0.88.1.ctl3.aarch64
kernel-5.10.0-136.12.0.88.2.ctl3.aarch64
kernel-5.10.0-136.12.0.88.3.ctl3.aarch64
kernel-5.10.0-136.12.0.88.4.ctl3.aarch64
kernel-5.10.0-136.12.0.90.ctl3.aarch64</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/" class="category-chain-item">kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/bugs/" class="category-chain-item">bugs</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/bugs/network/" class="category-chain-item">network</a>
  
  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/qemu/">#qemu</a>
      
        <a href="/tags/git/">#git</a>
      
        <a href="/tags/bpf/">#bpf</a>
      
        <a href="/tags/linux/">#linux</a>
      
        <a href="/tags/HTML/">#HTML</a>
      
        <a href="/tags/namespace/">#namespace</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0</div>
      <div>https://realwujing.github.io/linux/kernel/bugs/network/ovs veth peer Soft Lockup on netdev_pick_tx due to zero real_num_tx_queues When Executing ip link del veth0/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/debug/hard%20lockup%E4%B8%8Esoft%20locup%E7%9A%84%E5%8C%BA%E5%88%AB/" title="hard lockup与soft locup的区别">
                        <span class="hidden-mobile">hard lockup与soft locup的区别</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'f27c14e340ce4f13094e9aa92da24635'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
