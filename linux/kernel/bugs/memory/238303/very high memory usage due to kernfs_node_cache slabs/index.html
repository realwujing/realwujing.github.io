

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="HTML, JavaScript, Hexo, Linux, qemu, C++, namespace, git, bcc, bpf, initramfs, k8s, architect, strings, assembly, linux">
  
    <meta name="description" content="very high memory usage due to kernfs_node_cache slabs https:&#x2F;&#x2F;pms.uniontech.com&#x2F;bug-view-238303.html bug环境 12uname -aLinux 0000000g-A8cUta6pu5 4.19.0-arm64-desktop-tyy-5819-ext4-slub-debug-kmemleak #5">
<meta property="og:type" content="article">
<meta property="og:title" content="very high memory usage due to kernfs_node_cache slabs">
<meta property="og:url" content="https://realwujing.github.io/linux/kernel/bugs/memory/238303/very%20high%20memory%20usage%20due%20to%20kernfs_node_cache%20slabs/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="very high memory usage due to kernfs_node_cache slabs https:&#x2F;&#x2F;pms.uniontech.com&#x2F;bug-view-238303.html bug环境 12uname -aLinux 0000000g-A8cUta6pu5 4.19.0-arm64-desktop-tyy-5819-ext4-slub-debug-kmemleak #5">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-07-26T18:35:29.000Z">
<meta property="article:modified_time" content="2024-07-26T18:35:29.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="git">
<meta property="article:tag" content="bpf">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="HTML">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>very high memory usage due to kernfs_node_cache slabs - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="very high memory usage due to kernfs_node_cache slabs"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-07-26 18:35" pubdate>
          2024年7月26日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          45k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          372 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">very high memory usage due to kernfs_node_cache slabs</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="very-high-memory-usage-due-to-kernfs_node_cache-slabs">very high
memory usage due to kernfs_node_cache slabs</h1>
<p><a target="_blank" rel="noopener" href="https://pms.uniontech.com/bug-view-238303.html"
class="uri">https://pms.uniontech.com/bug-view-238303.html</a></p>
<h2 id="bug环境">bug环境</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uname</span> -a<br>Linux 0000000g-A8cUta6pu5 4.19.0-arm64-desktop-tyy-5819-ext4-slub-debug-kmemleak <span class="hljs-comment">#5819 SMP Fri Jan 5 12:27:47 CST 2024 aarch64 GNU/Linux</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt policy systemd<br>systemd:<br>  已安装：241.61-deepin1<br>  候选： 241.61-deepin1<br>  版本列表：<br> *** 241.61-deepin1 500<br>        500 http://pools.uniontech.com/ppa/dde-eagle eagle/1070/main arm64 Packages<br>        100 /var/lib/dpkg/status<br></code></pre></td></tr></table></figure>
<p>查看当前用户密码，方便切root：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /var/log/cloud-init.log | grep ctyun<br></code></pre></td></tr></table></figure>
<h2 id="初步分析">初步分析</h2>
<h3 id="slab">Slab</h3>
<h4 id="procmeminfo">/proc/meminfo</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/meminfo | grep Slab: -A2<br>Slab:             913952 kB<br>SReclaimable:     175568 kB<br>SUnreclaim:       738384 kB<br></code></pre></td></tr></table></figure>
<h4 id="slabtop">slabtop</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">slabtop -s c -o | <span class="hljs-built_in">head</span> -n20<br> Active / Total Objects (% used)    : 924058 / 1039323 (88.9%)<br> Active / Total Slabs (% used)      : 43496 / 43496 (100.0%)<br> Active / Total Caches (% used)     : 121 / 187 (64.7%)<br> Active / Total Size (% used)       : 815879.95K / 908598.60K (89.8%)<br> Minimum / Average / Maximum Object : 0.36K / 0.87K / 16.81K<br><br>  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   <br> 55251  52846  95%    4.44K   7893        7    252576K names_cache            <br>229119 223856  97%    0.48K   6943       33    111088K kernfs_node_cache      <br>141850 137390  96%    0.62K   5674       25     90784K kmalloc-128            <br> 13776  12659  91%    4.50K   1968        7     62976K kmalloc-4096           <br>104670  87963  84%    0.53K   3489       30     55824K dentry                 <br> 63020  52097  82%    0.69K   2740       23     43840K filp                   <br> 72090  59483  82%    0.53K   2403       30     38448K vm_area_struct         <br> 21142  19921  94%    1.41K    961       22     30752K ext4_inode_cache       <br> 58555  55044  94%    0.45K   1673       35     26768K buffer_head            <br> 38775  34343  88%    0.62K   1551       25     24816K skbuff_head_cache      <br> 23256  21205  91%    0.94K    684       34     21888K inode_cache            <br> 21248  17845  83%    1.00K    664       32     21248K kmalloc-512            <br> 47502  40866  86%    0.41K   1218       39     19488K anon_vma_chain       <br></code></pre></td></tr></table></figure>
<h4 id="slub_debug">slub_debug</h4>
<p>打开下方slub_debug相关内核编译选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">CONFIG_SLUB=y<br><br>CONFIG_SLUB_DEBUG=y<br><br>CONFIG_SLUB_DEBUG_ON=y<br><br>CONFIG_SLUB_STATS=y<br></code></pre></td></tr></table></figure>
<p>在grub中增加参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">slub_debug=UFPZ<br></code></pre></td></tr></table></figure>
<p>追踪kernfs_node_cache分配释放：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/slab/kernfs_node_cache/trace  &amp;&amp; <span class="hljs-built_in">sleep</span> 60 &amp;&amp; <span class="hljs-built_in">echo</span> 0 &gt; /sys/kernel/slab/kernfs_node_cache/trace<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/sys/kernel/slab/kernfs_node_cache/group<br></code></pre></td></tr></table></figure>
<p>在/var/log/kern.log中查看kernfs_node_cache alloc:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">1673 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.452633] TRACE kernfs_node_cache alloc 0x00000000a05f4917 inuse=35 fp=0x          (null)<br>1674 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.454989] CPU: 7 PID: 1 Comm: systemd Tainted: G           O      4.19.0-arm64-desktop-tyy-5819-ext4-slub-debug-kmemleak <span class="hljs-comment">#5819</span><br>1675 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.457735] Hardware name: RDO OpenStack Compute, BIOS 0.0.0 02/06/2015<br>1676 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.459811] Call trace:<br>1677 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.460466]  dump_backtrace+0x0/0x190<br>1678 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.461368]  show_stack+0x14/0x20<br>1679 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.462291]  dump_stack+0xa8/0xcc<br>1680 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.463168]  alloc_debug_processing+0x58/0x188<br>1681 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.464272]  ___slab_alloc.constprop.34+0x31c/0x388<br>1682 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.465491]  kmem_cache_alloc+0x210/0x278<br>1683 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.466538]  __kernfs_new_node+0x60/0x1f8<br>1684 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.467553]  kernfs_new_node+0x24/0x48<br>1685 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.468508]  kernfs_create_dir_ns+0x30/0x88<br>1686 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.469584]  cgroup_mkdir+0x2f0/0x4e8<br>1687 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.470516]  kernfs_iop_mkdir+0x58/0x88<br>1688 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.471497]  vfs_mkdir+0xfc/0x1c0<br>1689 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.472328]  do_mkdirat+0xec/0x100<br>1690 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.473172]  __arm64_sys_mkdirat+0x1c/0x28<br>1691 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.474210]  el0_svc_common+0x90/0x178<br>1692 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.475125]  el0_svc_handler+0x9c/0xa8<br>1693 2024-01-24 12:40:55 0000000g-A8cUta6pu5 kernel: [  201.476049]  el0_svc+0x8/0xc<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&quot;kernfs_node_cache alloc&quot;</span> kern.log | <span class="hljs-built_in">wc</span> -l<br>7239<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux vfs_mkdir+0xfc/0x1c0<br>vfs_mkdir+0xfc/0x1c0:<br>vfs_mkdir 于 fs/namei.c:3820<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux kernfs_iop_mkdir+0x58/0x88<br>kernfs_iop_mkdir+0x58/0x88:<br>kernfs_iop_mkdir 于 fs/kernfs/dir.c:1120<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux cgroup_mkdir+0x2f0/0x4e8<br>cgroup_mkdir+0x2f0/0x4e8:<br>kernfs_create_dir 于 include/linux/kernfs.h:507<br>(已内连入)cgroup_mkdir 于 kernel/cgroup/cgroup.c:5032<br></code></pre></td></tr></table></figure>
<p>在/var/log/kern.log中查看kernfs_node_cache free:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">3106 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.212900] TRACE kernfs_node_cache free 0x00000000e2ea365c inuse=34 fp=0x00000000a8805aea<br>3107 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.215538] Object 00000000e2ea365c: 00 00 00 00 01 00 00 80 78 a2 37 a6 03 80 ff ff  ........x.7.....<br>3108 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.218656] Object 000000003a5b5659: 00 52 45 de 03 80 ff ff 40 92 37 a6 03 80 ff ff  .RE.....@.7.....<br>3109 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.221710] Object 000000007229340d: 80 b6 37 a6 03 80 ff ff 00 00 00 00 00 00 00 00  ..7.............<br>3110 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.224824] Object 00000000cc138d0e: 00 00 00 00 00 00 00 00 7e 16 88 71 00 00 00 00  ........~..q....<br>3111 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.227947] Object 000000001cecdc04: b0 e4 a2 09 00 00 ff ff 00 00 00 00 00 00 00 00  ................<br>3112 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.231088] Object 00000000c3ac2227: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................<br>3113 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.234279] Object 00000000737356c8: 98 dc a2 09 00 00 ff ff 14 09 00 00 01 00 00 00  ................<br>3114 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.237384] Object 00000000ba78c59c: 52 20 a4 81 00 00 00 00 00 00 00 00 00 00 00 00  R ..............<br>3115 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.240508] CPU: 3 PID: 1 Comm: systemd Tainted: G           O      4.19.0-arm64-desktop-tyy-5819-ext4-slub-debug-kmemleak <span class="hljs-comment">#5819</span><br>3116 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.244280] Hardware name: RDO OpenStack Compute, BIOS 0.0.0 02/06/2015<br>3117 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.246454] Call trace:<br>3118 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.247264]  dump_backtrace+0x0/0x190<br>3119 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.248512]  show_stack+0x14/0x20<br>3120 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.249584]  dump_stack+0xa8/0xcc<br>3121 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.250672]  free_debug_processing+0x19c/0x3a0<br>3122 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.252143]  __slab_free+0x230/0x3f8<br>3123 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.253321]  kmem_cache_free+0x200/0x220<br>3124 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.254657]  kernfs_put+0x100/0x238<br>3125 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.255806]  kernfs_evict_inode+0x2c/0x38<br>3126 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.257119]  evict+0xc0/0x1c0<br>3127 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.258067]  iput+0x1c8/0x288<br>3128 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.259371]  dentry_unlink_inode+0xb0/0xe8<br>3129 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.260600]  __dentry_kill+0xc4/0x1d0<br>3130 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.261434]  shrink_dentry_list+0x1ac/0x2c0<br>3131 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.262413]  shrink_dcache_parent+0x78/0x80<br>3132 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.263336]  vfs_rmdir+0xf0/0x190<br>3133 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.264066]  do_rmdir+0x1c0/0x1f8<br>3134 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.264791]  __arm64_sys_unlinkat+0x4c/0x60<br>3135 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.265710]  el0_svc_common+0x90/0x178<br>3136 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.266968]  el0_svc_handler+0x9c/0xa8<br>3137 2024-01-24 12:40:56 0000000g-A8cUta6pu5 kernel: [  203.267828]  el0_svc+0x8/0xc<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep <span class="hljs-string">&quot;kernfs_node_cache free&quot;</span> kern.log | <span class="hljs-built_in">wc</span> -l<br>5034<br></code></pre></td></tr></table></figure>
<h3 id="trace-bpfcc">trace-bpfcc</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt install systemd-dbgsym<br>apt <span class="hljs-built_in">source</span> systemd=241.61-deepin1<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-bpfcc -tKU <span class="hljs-string">&#x27;r::kernfs_new_node &quot;%llx&quot;, retval&#x27;</span><br></code></pre></td></tr></table></figure>
<p>从kernfs_new_node.log内容来看，主要有内核线程kworker和systemd在调用kernfs_new_node。</p>
<h4 id="kworker">kworker</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">3.796820 47      47      kworker/3:1     kernfs_new_node  <br>        kernfs_new_node+0x0 [kernel]<br>        sysfs_add_file_mode_ns+0x9c [kernel]<br>        internal_create_group+0x104 [kernel]<br>        sysfs_create_group+0x14 [kernel]  <span class="hljs-comment"># 上游4.19.306这里没走到</span><br>        sysfs_slab_add+0xb8 [kernel]      <span class="hljs-comment"># 上游4.19.306这里走到了</span><br>        __kmem_cache_create+0x128 [kernel]<br>        create_cache+0xcc [kernel]<br>        memcg_create_kmem_cache+0xf8 [kernel]<br>        memcg_kmem_cache_create_func+0x1c [kernel]<br>        process_one_work+0x1e8 [kernel]<br>        worker_thread+0x48 [kernel]<br>        kthread+0x128 [kernel]<br>        ret_from_fork+0x10 [kernel]<br>        -14<br></code></pre></td></tr></table></figure>
<p>在 Linux 内核中，错误代码 -14 对应的含义是
EFAULT，表示发生了“无效地址”（Bad address）错误。通常情况下，EFAULT
错误表示系统调用中传递的参数指针指向的地址无效，无法访问或者无法写入。</p>
<h5 id="sysfs_slab_add">sysfs_slab_add</h5>
<p>tyy-1053 sysfs_slab_add 参数追踪：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">trace-bpfcc -t -Ilinux/slab.h -Ilinux/slub_def.h <span class="hljs-string">&#x27;sysfs_slab_add(struct kmem_cache *s) &quot;%llx&quot; s-&gt;memcg_params.root_cache&#x27;</span><br>TIME     PID     TID     COMM            FUNC             -<br><span class="hljs-number">96.61296</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f10d0780<br><span class="hljs-number">96.61350</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f10d0400<br><span class="hljs-number">96.61372</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f10d3880<br><span class="hljs-number">96.61390</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f10d2e00<br><span class="hljs-number">96.61434</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f131b500<br><span class="hljs-number">96.61457</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f0a3a700<br><span class="hljs-number">96.61485</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f131b880<br><span class="hljs-number">96.61504</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff684780<br><span class="hljs-number">96.61535</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff7d4b00<br><span class="hljs-number">96.61571</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff7d5580<br><span class="hljs-number">96.61589</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff7d6700<br><span class="hljs-number">96.61608</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff7d7500<br><span class="hljs-number">96.61624</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff7d4780<br><span class="hljs-number">96.61962</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001f10d2a80<br><span class="hljs-number">96.61981</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff684400<br><span class="hljs-number">96.62001</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff687180<br><span class="hljs-number">96.62299</span> <span class="hljs-number">23371</span>   <span class="hljs-number">23371</span>   kworker/<span class="hljs-number">2</span>:<span class="hljs-number">1</span>     sysfs_slab_add   ffff8001ff687500<br></code></pre></td></tr></table></figure>
<p>可以看到root_cache不是null。</p>
<h5 id="ret_from_fork0x10">ret_from_fork+0x10</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux ret_from_fork+0x10<br>ret_from_fork+0x10/0x18:<br>ret_from_fork 于 <span class="hljs-built_in">arch</span>/arm64/kernel/entry.S:1063<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>vim arch/arm64/kernel/entry.S +1063</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1055</span> <span class="hljs-comment">/*</span><br><span class="hljs-comment">1056  * This is how we return from a fork.</span><br><span class="hljs-comment">1057  */</span><br><span class="hljs-number">1058</span> ENTRY(ret_from_fork)<br><span class="hljs-number">1059</span>     bl  schedule_tail                       <span class="hljs-comment">// 调用 schedule_tail 函数，执行内核线程的调度</span><br><span class="hljs-number">1060</span>     cbz x19, <span class="hljs-number">1f</span>                            <span class="hljs-comment">// 如果 x19 为零，则跳转到标签 1f，表示不是内核线程</span><br><span class="hljs-number">1061</span>     mov x0, x20                            <span class="hljs-comment">// 将 x20 的值移动到 x0 寄存器中，作为返回值</span><br><span class="hljs-number">1062</span>     blr x19                                <span class="hljs-comment">// 通过 blr 指令跳转到 x19 寄存器中存储的地址，返回到 fork 调用的位置</span><br><span class="hljs-number">1063</span> <span class="hljs-number">1</span>:  get_thread_info tsk                    <span class="hljs-comment">// 获取当前线程的线程信息，并存储在 tsk 中</span><br><span class="hljs-number">1064</span>     b   ret_to_user                        <span class="hljs-comment">// 跳转到 ret_to_user 标签，返回到用户空间</span><br><span class="hljs-number">1065</span> ENDPROC(ret_from_fork)                     <span class="hljs-comment">// 结束 ret_from_fork 过程</span><br><span class="hljs-number">1066</span> NOKPROBE(ret_from_fork)                    <span class="hljs-comment">// 禁用对 ret_from_fork 过程的探查（probing）</span><br></code></pre></td></tr></table></figure>
<h5 id="kthread0x128">kthread+0x128</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux kthread+0x128<br>kthread+0x128/0x130:<br>kthread 于 kernel/kthread.c:246<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>// vim kernel/kthread.c +246</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">205</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kthread</span><span class="hljs-params">(<span class="hljs-type">void</span> *_create)</span><br>206 &#123;<br><span class="hljs-number">207</span>     <span class="hljs-comment">/* Copy data: it&#x27;s on kthread&#x27;s stack */</span><br><span class="hljs-number">208</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kthread_create_info</span> *<span class="hljs-title">create</span> =</span> _create;    <span class="hljs-comment">// 复制数据：它位于 kthread 的堆栈上</span><br><span class="hljs-number">209</span>     <span class="hljs-type">int</span> (*threadfn)(<span class="hljs-type">void</span> *data) = create-&gt;threadfn; <span class="hljs-comment">// 获取线程函数指针</span><br><span class="hljs-number">210</span>     <span class="hljs-type">void</span> *data = create-&gt;data;                      <span class="hljs-comment">// 获取线程函数的参数</span><br><span class="hljs-number">211</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">completion</span> *<span class="hljs-title">done</span>;</span>                        <span class="hljs-comment">// 完成标志</span><br><span class="hljs-number">212</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kthread</span> *<span class="hljs-title">self</span>;</span>                           <span class="hljs-comment">// 当前线程结构指针</span><br><span class="hljs-number">213</span>     <span class="hljs-type">int</span> ret;                                        <span class="hljs-comment">// 返回值</span><br><span class="hljs-number">214</span> <br><span class="hljs-number">215</span>     self = kzalloc(<span class="hljs-keyword">sizeof</span>(*self), GFP_KERNEL);      <span class="hljs-comment">// 分配 kthread 结构内存</span><br><span class="hljs-number">216</span>     set_kthread_struct(self);                       <span class="hljs-comment">// 设置线程结构</span><br><span class="hljs-number">217</span> <br><span class="hljs-number">218</span>     <span class="hljs-comment">/* If user was SIGKILLed, I release the structure. */</span><br><span class="hljs-number">219</span>     done = xchg(&amp;create-&gt;done, <span class="hljs-literal">NULL</span>);               <span class="hljs-comment">// 交换完成标志</span><br><span class="hljs-number">220</span>     <span class="hljs-keyword">if</span> (!done) &#123;                                    <span class="hljs-comment">// 如果完成标志为空</span><br><span class="hljs-number">221</span>         kfree(create);                              <span class="hljs-comment">// 释放线程结构内存</span><br><span class="hljs-number">222</span>         do_exit(-EINTR);                            <span class="hljs-comment">// 退出线程</span><br><span class="hljs-number">223</span>     &#125;<br><span class="hljs-number">224</span> <br><span class="hljs-number">225</span>     <span class="hljs-keyword">if</span> (!self) &#123;                                    <span class="hljs-comment">// 如果线程结构为空</span><br><span class="hljs-number">226</span>         create-&gt;result = ERR_PTR(-ENOMEM);          <span class="hljs-comment">// 设置返回结果为内存分配错误</span><br><span class="hljs-number">227</span>         complete(done);                             <span class="hljs-comment">// 标记完成</span><br><span class="hljs-number">228</span>         do_exit(-ENOMEM);                           <span class="hljs-comment">// 退出线程</span><br><span class="hljs-number">229</span>     &#125;<br><span class="hljs-number">230</span> <br><span class="hljs-number">231</span>     self-&gt;data = data;                              <span class="hljs-comment">// 设置线程结构中的参数</span><br><span class="hljs-number">232</span>     init_completion(&amp;self-&gt;exited);                 <span class="hljs-comment">// 初始化完成标志</span><br><span class="hljs-number">233</span>     init_completion(&amp;self-&gt;parked);                 <span class="hljs-comment">// 初始化完成标志</span><br><span class="hljs-number">234</span>     current-&gt;vfork_done = &amp;self-&gt;exited;            <span class="hljs-comment">// 设置 vfork 完成标志</span><br><span class="hljs-number">235</span> <br><span class="hljs-number">236</span>     <span class="hljs-comment">/* OK, tell user we&#x27;re spawned, wait for stop or wakeup */</span><br><span class="hljs-number">237</span>     __set_current_state(TASK_UNINTERRUPTIBLE);      <span class="hljs-comment">// 设置当前线程状态为不可中断</span><br><span class="hljs-number">238</span>     create-&gt;result = current;                       <span class="hljs-comment">// 设置返回结果为当前线程</span><br><span class="hljs-number">239</span>     complete(done);                                 <span class="hljs-comment">// 标记完成</span><br><span class="hljs-number">240</span>     schedule();                                     <span class="hljs-comment">// 进行调度</span><br><span class="hljs-number">241</span> <br><span class="hljs-number">242</span>     ret = -EINTR;                                   <span class="hljs-comment">// 设置返回值为中断错误</span><br><span class="hljs-number">243</span>     <span class="hljs-keyword">if</span> (!test_bit(KTHREAD_SHOULD_STOP, &amp;self-&gt;flags)) &#123; <span class="hljs-comment">// 如果线程未被停止</span><br><span class="hljs-number">244</span>         cgroup_kthread_ready();                     <span class="hljs-comment">// 准备 cgroup 线程</span><br><span class="hljs-number">245</span>         __kthread_parkme(self);                     <span class="hljs-comment">// 将当前线程挂起</span><br><span class="hljs-number">246</span>         ret = threadfn(data);                       <span class="hljs-comment">// 执行线程函数</span><br><span class="hljs-number">247</span>     &#125;<br><span class="hljs-number">248</span>     do_exit(ret);                                   <span class="hljs-comment">// 退出线程</span><br><span class="hljs-number">249</span> &#125;<br></code></pre></td></tr></table></figure>
<h6 id="worker_thread0x48">worker_thread+0x48</h6>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux worker_thread+0x48<br>worker_thread+0x48/0x4c8:<br>__read_once_size 于 include/linux/compiler.h:193<br>(已内连入)list_empty 于 include/linux/list.h:203<br>(已内连入)worker_thread 于 kernel/workqueue.c:2297<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>// vim kernel/workqueue.c +2297</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">2226</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment">2227  * worker_thread - the worker thread function</span><br><span class="hljs-comment">2228  * @__worker: self</span><br><span class="hljs-comment">2229  *</span><br><span class="hljs-comment">2230  * 工作线程函数。所有的工作线程都属于一个工作池 - 无论是每个 CPU 的一个还是动态的无绑定的一个。</span><br><span class="hljs-comment">2231  * 这些工作线程处理所有的工作项，而不管它们具体的目标工作队列是什么。唯一的例外是属于具有救援者的工作队列的工作项，</span><br><span class="hljs-comment">2232  * 这将在 rescuer_thread() 中解释。</span><br><span class="hljs-comment">2233  *</span><br><span class="hljs-comment">2234  * 返回值: 0</span><br><span class="hljs-comment">2235  */</span><br><span class="hljs-number">2236</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *__worker)</span><br>2237 &#123;<br><span class="hljs-number">2238</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">worker</span> *<span class="hljs-title">worker</span> =</span> __worker;           <span class="hljs-comment">// 获取工作线程结构指针</span><br><span class="hljs-number">2239</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">worker_pool</span> *<span class="hljs-title">pool</span> =</span> worker-&gt;pool;    <span class="hljs-comment">// 获取工作池指针</span><br><span class="hljs-number">2240</span> <br><span class="hljs-number">2241</span>     <span class="hljs-comment">/* 告诉调度程序这是一个工作队列工作者 */</span><br><span class="hljs-number">2242</span>     set_pf_worker(<span class="hljs-literal">true</span>);<br><span class="hljs-number">2243</span> woke_up:<br><span class="hljs-number">2244</span>     spin_lock_irq(&amp;pool-&gt;lock);                 <span class="hljs-comment">// 获取工作池的自旋锁</span><br><span class="hljs-number">2245</span> <br><span class="hljs-number">2246</span>     <span class="hljs-comment">/* 我是否要死了？ */</span><br><span class="hljs-number">2247</span>     <span class="hljs-keyword">if</span> (unlikely(worker-&gt;flags &amp; WORKER_DIE)) &#123;<br><span class="hljs-number">2248</span>         spin_unlock_irq(&amp;pool-&gt;lock);           <span class="hljs-comment">// 释放工作池的自旋锁</span><br><span class="hljs-number">2249</span>         WARN_ON_ONCE(!list_empty(&amp;worker-&gt;entry));<br><span class="hljs-number">2250</span>         set_pf_worker(<span class="hljs-literal">false</span>);<br><span class="hljs-number">2251</span> <br><span class="hljs-number">2252</span>         set_task_comm(worker-&gt;task, <span class="hljs-string">&quot;kworker/dying&quot;</span>);<br><span class="hljs-number">2253</span>         ida_simple_remove(&amp;pool-&gt;worker_ida, worker-&gt;id);<br><span class="hljs-number">2254</span>         worker_detach_from_pool(worker);<br><span class="hljs-number">2255</span>         kfree(worker);<br><span class="hljs-number">2256</span>         <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">2257</span>     &#125;<br><span class="hljs-number">2258</span> <br><span class="hljs-number">2259</span>     worker_leave_idle(worker);                  <span class="hljs-comment">// 离开空闲状态</span><br><span class="hljs-number">2260</span> recheck:<br><span class="hljs-number">2261</span>     <span class="hljs-comment">/* 不再需要更多的工作线程？ */</span><br><span class="hljs-number">2262</span>     <span class="hljs-keyword">if</span> (!need_more_worker(pool))                <span class="hljs-comment">// 如果不再需要更多的工作线程</span><br><span class="hljs-number">2263</span>         <span class="hljs-keyword">goto</span> sleep;                             <span class="hljs-comment">// 跳转到休眠状态</span><br><span class="hljs-number">2264</span> <br><span class="hljs-number">2265</span>     <span class="hljs-comment">/* 我们需要管理吗？ */</span><br><span class="hljs-number">2266</span>     <span class="hljs-keyword">if</span> (unlikely(!may_start_working(pool)) &amp;&amp; manage_workers(worker)) <span class="hljs-comment">// 如果不可能开始工作并且需要管理工作线程</span><br><span class="hljs-number">2267</span>         <span class="hljs-keyword">goto</span> recheck;                           <span class="hljs-comment">// 重新检查</span><br><span class="hljs-number">2268</span> <br><span class="hljs-number">2269</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2270      * -&gt;scheduled 列表只能在工作线程准备处理工作或实际处理工作时填充。</span><br><span class="hljs-comment">2271      * 确保我在睡眠时没有人捣乱。</span><br><span class="hljs-comment">2272      */</span><br><span class="hljs-number">2273</span>     WARN_ON_ONCE(!list_empty(&amp;worker-&gt;scheduled));<br><span class="hljs-number">2274</span> <br><span class="hljs-number">2275</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2276      * 完成 PREP 阶段。我们保证至少有一个空闲的工作线程或其他人已经承担了管理者的角色。</span><br><span class="hljs-comment">2277      * 这是 @worker 开始参与并发管理的地方（如果适用），并且在重新绑定后恢复并发管理。有关详细信息，请参见 rebind_workers()。</span><br><span class="hljs-comment">2278      */</span><br><span class="hljs-number">2279</span>     worker_clr_flags(worker, WORKER_PREP | WORKER_REBOUND);<br><span class="hljs-number">2280</span> <br><span class="hljs-number">2281</span>     <span class="hljs-keyword">do</span> &#123;<br><span class="hljs-number">2282</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> *<span class="hljs-title">work</span> =</span><br><span class="hljs-number">2283</span>             list_first_entry(&amp;pool-&gt;worklist,<br><span class="hljs-number">2284</span>                      <span class="hljs-keyword">struct</span> work_struct, entry);<br><span class="hljs-number">2285</span> <br><span class="hljs-number">2286</span>         pool-&gt;watchdog_ts = jiffies;<br><span class="hljs-number">2287</span> <br><span class="hljs-number">2288</span>         <span class="hljs-keyword">if</span> (likely(!(*work_data_bits(work) &amp; WORK_STRUCT_LINKED))) &#123;<br><span class="hljs-number">2289</span>             <span class="hljs-comment">/* 优化路径，不是严格必要的 */</span><br><span class="hljs-number">2290</span>             process_one_work(worker, work);<br><span class="hljs-number">2291</span>             <span class="hljs-keyword">if</span> (unlikely(!list_empty(&amp;worker-&gt;scheduled)))<br><span class="hljs-number">2292</span>                 process_scheduled_works(worker);<br><span class="hljs-number">2293</span>         &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-number">2294</span>             move_linked_works(work, &amp;worker-&gt;scheduled, <span class="hljs-literal">NULL</span>);<br><span class="hljs-number">2295</span>             process_scheduled_works(worker);<br><span class="hljs-number">2296</span>         &#125;<br><span class="hljs-number">2297</span>     &#125; <span class="hljs-keyword">while</span> (keep_working(pool));<br><span class="hljs-number">2298</span> <br><span class="hljs-number">2299</span>     worker_set_flags(worker, WORKER_PREP);<br><span class="hljs-number">2300</span> sleep:<br><span class="hljs-number">2301</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2302      * 持有 pool-&gt;lock，并且没有要处理的工作，也没有需要管理，就休眠。</span><br><span class="hljs-comment">2303      * 只有在持有 pool-&gt;lock 或者从本地 CPU 上唤醒工作线程时，才会唤醒工作线程，因此在释放 pool-&gt;lock 前设置当前状态就足以防止丢失任何事件。</span><br><span class="hljs-comment">2304      */</span><br><span class="hljs-number">2305</span>     worker_enter_idle(worker);                   <span class="hljs-comment">// 进入空闲状态</span><br><span class="hljs-number">2306</span>     __set_current_state(TASK_IDLE);              <span class="hljs-comment">// 设置当前线程状态为空闲</span><br><span class="hljs-number">2307</span>     spin_unlock_irq(&amp;pool-&gt;lock);                <span class="hljs-comment">// 释放工作池的自旋锁</span><br><span class="hljs-number">2308</span>     schedule();                                  <span class="hljs-comment">// 进行调度</span><br><span class="hljs-number">2309</span>     <span class="hljs-keyword">goto</span> woke_up;                                <span class="hljs-comment">// 回到唤醒状态</span><br><span class="hljs-number">2310</span> &#125;<br></code></pre></td></tr></table></figure>
<h6 id="create_worker">create_worker</h6>
<figure class="highlight c"><figcaption><span>// vim kernel/workqueue.c +1813</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1779</span>  * create_worker - 创建一个新的工作队列工作者                                                                                           <br><span class="hljs-number">1780</span>  * @pool: 新工作者将属于的工作池                                                                                              <br><span class="hljs-number">1781</span>  *                                                                                                                                         <br><span class="hljs-number">1782</span>  * 创建并启动一个新的工作者，它附加到 @pool。                                                                               <br><span class="hljs-number">1783</span>  *                                                                                                                                         <br><span class="hljs-number">1784</span>  * 上下文：                                                                                                                                <br><span class="hljs-number">1785</span>  * 可能睡眠。进行 GFP_KERNEL 分配。                                                                                              <br><span class="hljs-number">1786</span>  *                                                                                                                                         <br><span class="hljs-number">1787</span>  * 返回值：                                                                                                                                 <br><span class="hljs-number">1788</span>  * 指向新创建的工作者的指针。                                                                                                    <br><span class="hljs-number">1789</span>  */                                                                                                                                        <br><span class="hljs-number">1790</span> <span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> worker *<span class="hljs-title function_">create_worker</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> worker_pool *pool)</span>                                                                              <br>1791 &#123;                                                                                                                                          <br><span class="hljs-number">1792</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">worker</span> *<span class="hljs-title">worker</span> =</span> <span class="hljs-literal">NULL</span>;                                                                                                          <br><span class="hljs-number">1793</span>     <span class="hljs-type">int</span> id = <span class="hljs-number">-1</span>;                                                                                                                           <br><span class="hljs-number">1794</span>     <span class="hljs-type">char</span> id_buf[<span class="hljs-number">16</span>];                                                                                                                       <br><span class="hljs-number">1795</span>                                                                                                                                            <br><span class="hljs-number">1796</span>     <span class="hljs-comment">/* 需要ID来确定 kthread 的名称 */</span>                                                                                           <br><span class="hljs-number">1797</span>     id = ida_simple_get(&amp;pool-&gt;worker_ida, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, GFP_KERNEL);                                                                              <br><span class="hljs-number">1798</span>     <span class="hljs-keyword">if</span> (id &lt; <span class="hljs-number">0</span>)                                                                                                                            <br><span class="hljs-number">1799</span>         <span class="hljs-keyword">goto</span> fail;                                                                                                                         <br><span class="hljs-number">1800</span>                                                                                                                                            <br><span class="hljs-number">1801</span>     worker = alloc_worker(pool-&gt;node);                                                                                                     <br><span class="hljs-number">1802</span>     <span class="hljs-keyword">if</span> (!worker)                                                                                                                           <br><span class="hljs-number">1803</span>         <span class="hljs-keyword">goto</span> fail;                                                                                                                         <br><span class="hljs-number">1804</span>                                                                                                                                            <br><span class="hljs-number">1805</span>     worker-&gt;id = id;                                                                                                                       <br><span class="hljs-number">1806</span>                                                                                                                                            <br><span class="hljs-number">1807</span>     <span class="hljs-keyword">if</span> (pool-&gt;cpu &gt;= <span class="hljs-number">0</span>)                                                                                                                    <br><span class="hljs-number">1808</span>         <span class="hljs-built_in">snprintf</span>(id_buf, <span class="hljs-keyword">sizeof</span>(id_buf), <span class="hljs-string">&quot;%d:%d%s&quot;</span>, pool-&gt;cpu, id,                                                                         <br><span class="hljs-number">1809</span>              pool-&gt;attrs-&gt;nice &lt; <span class="hljs-number">0</span>  ? <span class="hljs-string">&quot;H&quot;</span> : <span class="hljs-string">&quot;&quot;</span>);                                                                                           <br><span class="hljs-number">1810</span>     <span class="hljs-keyword">else</span>                                                                                                                                   <br><span class="hljs-number">1811</span>         <span class="hljs-built_in">snprintf</span>(id_buf, <span class="hljs-keyword">sizeof</span>(id_buf), <span class="hljs-string">&quot;u%d:%d&quot;</span>, pool-&gt;id, id);                                                                          <br><span class="hljs-number">1812</span>                                                                                                                                            <br><span class="hljs-number">1813</span>     worker-&gt;task = kthread_create_on_node(worker_thread, worker, pool-&gt;node,<br><span class="hljs-number">1814</span>                           <span class="hljs-string">&quot;kworker/%s&quot;</span>, id_buf); <span class="hljs-comment">/* 创建内核线程 */</span><br><span class="hljs-number">1815</span>     <span class="hljs-keyword">if</span> (IS_ERR(worker-&gt;task)) <span class="hljs-comment">/* 如果创建失败 */</span><br><span class="hljs-number">1816</span>         <span class="hljs-keyword">goto</span> fail; <span class="hljs-comment">/* 跳转到 fail 标签 */</span><br><span class="hljs-number">1817</span> <br><span class="hljs-number">1818</span>     set_user_nice(worker-&gt;task, pool-&gt;attrs-&gt;nice); <span class="hljs-comment">/* 设置内核线程的优先级 */</span><br><span class="hljs-number">1819</span>     kthread_bind_mask(worker-&gt;task, pool-&gt;attrs-&gt;cpumask); <span class="hljs-comment">/* 绑定内核线程到指定的 CPU 掩码 */</span><br><span class="hljs-number">1820</span>                                                                                                                                                                           <br><span class="hljs-number">1821</span>     <span class="hljs-comment">/* 成功，将工作者附加到工作池 */</span>                                                                                        <br><span class="hljs-number">1822</span>     worker_attach_to_pool(worker, pool);                                                                                                   <br><span class="hljs-number">1823</span>                                                                                                                                            <br><span class="hljs-number">1824</span>     <span class="hljs-comment">/* 启动新创建的工作者 */</span>                                                                                                   <br><span class="hljs-number">1825</span>     spin_lock_irq(&amp;pool-&gt;lock);                                                                                                            <br><span class="hljs-number">1826</span>     worker-&gt;pool-&gt;nr_workers++;                                                                                                            <br><span class="hljs-number">1827</span>     worker_enter_idle(worker);                                                                                                             <br><span class="hljs-number">1828</span>     wake_up_process(worker-&gt;task);                                                                                                         <br><span class="hljs-number">1829</span>     spin_unlock_irq(&amp;pool-&gt;lock);                                                                                                          <br><span class="hljs-number">1830</span>                                  <br><span class="hljs-number">1831</span>     <span class="hljs-keyword">return</span> worker; <span class="hljs-comment">/* 返回创建的工作者 */</span><br><span class="hljs-number">1832</span> <br><span class="hljs-number">1833</span> fail:<br><span class="hljs-number">1834</span>     <span class="hljs-keyword">if</span> (id &gt;= <span class="hljs-number">0</span>)<br><span class="hljs-number">1835</span>         ida_simple_remove(&amp;pool-&gt;worker_ida, id); <span class="hljs-comment">/* 移除已经获取的 ID */</span><br><span class="hljs-number">1836</span>     kfree(worker); <span class="hljs-comment">/* 释放已经分配的工作者 */</span><br><span class="hljs-number">1837</span>     <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* 返回 NULL */</span><br><span class="hljs-number">1838</span> &#125;<br></code></pre></td></tr></table></figure>
<h6 id="kthread_create_on_node">kthread_create_on_node</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/kthread.c +370</span><br><br><span class="hljs-number">347</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment"> 348  * kthread_create_on_node - 创建一个内核线程。</span><br><span class="hljs-comment"> 349  * @threadfn: 要运行的函数，直到 signal_pending(current)。</span><br><span class="hljs-comment"> 350  * @data: @threadfn 的数据指针。</span><br><span class="hljs-comment"> 351  * @node: 为线程分配任务和线程结构的节点。</span><br><span class="hljs-comment"> 352  * @namefmt: 线程的 printf 格式名称。</span><br><span class="hljs-comment"> 353  *                                                                                                                                         </span><br><span class="hljs-comment"> 354  * 描述：这个辅助函数创建并命名一个内核线程。</span><br><span class="hljs-comment"> 355  * 线程将会被停止：使用 wake_up_process() 来启动它。</span><br><span class="hljs-comment"> 356  * 也可以参见 kthread_run()。</span><br><span class="hljs-comment"> 357  * 新线程具有 SCHED_NORMAL 策略，并且与所有 CPU 有亲和性。</span><br><span class="hljs-comment"> 358  *                                                                                                                                         </span><br><span class="hljs-comment"> 359  * 如果线程将绑定到特定的 CPU，请在 @node 中给出它的节点，</span><br><span class="hljs-comment"> 360  * 以获取 kthread 堆栈的 NUMA 亲和性，否则给出 NUMA_NO_NODE。</span><br><span class="hljs-comment"> 361  * 在唤醒时，线程将以 @data 作为其参数运行 @threadfn()。</span><br><span class="hljs-comment"> 362  * @threadfn() 可以直接调用 do_exit()，如果它是一个独立的线程，</span><br><span class="hljs-comment"> 363  * 没有人会调用 kthread_stop()，或者当 &#x27;kthread_should_stop()&#x27; 为真时返回</span><br><span class="hljs-comment"> 364  * （这意味着已经调用了 kthread_stop()）。</span><br><span class="hljs-comment"> 365  * 返回值应该是零或负的错误号码；它将传递给 kthread_stop()。</span><br><span class="hljs-comment"> 366  *                                                                                                                                         </span><br><span class="hljs-comment"> 367  * 返回一个 task_struct 或 ERR_PTR(-ENOMEM) 或 ERR_PTR(-EINTR)。</span><br><span class="hljs-comment"> 368  */</span>                                                                                                                                        <br> <span class="hljs-number">369</span> <span class="hljs-keyword">struct</span> task_struct *<span class="hljs-title function_">kthread_create_on_node</span><span class="hljs-params">(<span class="hljs-type">int</span> (*threadfn)(<span class="hljs-type">void</span> *data),                                                                    </span><br><span class="hljs-params"> <span class="hljs-number">370</span>                        <span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> node,                                                                                               </span><br><span class="hljs-params"> <span class="hljs-number">371</span>                        <span class="hljs-type">const</span> <span class="hljs-type">char</span> namefmt[],                                                                                               </span><br><span class="hljs-params"> <span class="hljs-number">372</span>                        ...)</span>                                                                                                                <br> 373 &#123;                                                                                                                                          <br> <span class="hljs-number">374</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">task</span>;</span>                                                                                                              <br> <span class="hljs-number">375</span>     va_list args;                                                                                                                          <br> <span class="hljs-number">376</span>                                                                                                                                            <br> <span class="hljs-number">377</span>     va_start(args, namefmt);                                                                                                               <br> <span class="hljs-number">378</span>     task = __kthread_create_on_node(threadfn, data, node, namefmt, args);                                                                  <br> <span class="hljs-number">379</span>     va_end(args);                                                                                                                          <br> <span class="hljs-number">380</span>                                                                                                                                            <br> <span class="hljs-number">381</span>     <span class="hljs-keyword">return</span> task;                                                                                                                           <br> <span class="hljs-number">382</span> &#125;                                                                                                                                          <br> <span class="hljs-number">383</span> EXPORT_SYMBOL(kthread_create_on_node);  <br><br></code></pre></td></tr></table></figure>
<h6 id="maybe_create_worker">maybe_create_worker</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/workqueue.c +1972</span><br><br><span class="hljs-number">1943</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment">1944  * maybe_create_worker - 如果需要，创建一个新的工作线程</span><br><span class="hljs-comment">1945  * @pool: 用于创建新工作线程的线程池</span><br><span class="hljs-comment">1946  *</span><br><span class="hljs-comment">1947  * 如果需要，为 @pool 创建一个新的工作线程。函数返回时，保证 @pool 至少有一个空闲的工作线程。</span><br><span class="hljs-comment">1948  * 如果创建一个新的工作线程花费的时间超过 MAYDAY_INTERVAL，可能会向所有在 @pool 上计划工作的救援者发送求助信号，</span><br><span class="hljs-comment">1949  * 以解决可能的分配死锁。</span><br><span class="hljs-comment">1950  *</span><br><span class="hljs-comment">1951  * 返回时，need_to_create_worker() 保证为 %false，may_start_working() 保证为 %true。</span><br><span class="hljs-comment">1952  *</span><br><span class="hljs-comment">1953  * 锁定：</span><br><span class="hljs-comment">1954  * spin_lock_irq(pool-&gt;lock) 可能会释放和重新获取多次。</span><br><span class="hljs-comment">1955  * 执行 GFP_KERNEL 分配。</span><br><span class="hljs-comment">1956  * 仅从管理器调用。</span><br><span class="hljs-comment">1957  */</span><br><span class="hljs-number">1958</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">maybe_create_worker</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> worker_pool *pool)</span><br>1959 __<span class="hljs-title function_">releases</span><span class="hljs-params">(&amp;pool-&gt;lock)</span><br>1960 __<span class="hljs-title function_">acquires</span><span class="hljs-params">(&amp;pool-&gt;lock)</span><br>1961 &#123;<br><span class="hljs-number">1962</span> restart:<br><span class="hljs-number">1963</span>     spin_unlock_irq(&amp;pool-&gt;lock); <span class="hljs-comment">/* 解锁线程池 */</span><br><span class="hljs-number">1964</span> <br><span class="hljs-number">1965</span>     <span class="hljs-comment">/* 如果在 MAYDAY_INITIAL_TIMEOUT 内没有取得进展，请求帮助 */</span><br><span class="hljs-number">1966</span>     mod_timer(&amp;pool-&gt;mayday_timer, jiffies + MAYDAY_INITIAL_TIMEOUT);<br><span class="hljs-number">1967</span> <br><span class="hljs-number">1968</span>     <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br><span class="hljs-number">1969</span>         <span class="hljs-keyword">if</span> (create_worker(pool) || !need_to_create_worker(pool)) <span class="hljs-comment">/* 创建一个工作线程或者不需要创建工作线程 */</span><br><span class="hljs-number">1970</span>             <span class="hljs-keyword">break</span>;<br><span class="hljs-number">1971</span> <br><span class="hljs-number">1972</span>         schedule_timeout_interruptible(CREATE_COOLDOWN); <span class="hljs-comment">/* 在指定的时间内休眠 */</span><br><span class="hljs-number">1973</span> <br><span class="hljs-number">1974</span>         <span class="hljs-keyword">if</span> (!need_to_create_worker(pool)) <span class="hljs-comment">/* 如果不需要创建工作线程 */</span><br><span class="hljs-number">1975</span>             <span class="hljs-keyword">break</span>;<br><span class="hljs-number">1976</span>     &#125;<br><span class="hljs-number">1977</span> <br><span class="hljs-number">1978</span>     del_timer_sync(&amp;pool-&gt;mayday_timer); <span class="hljs-comment">/* 删除计时器 */</span><br><span class="hljs-number">1979</span>     spin_lock_irq(&amp;pool-&gt;lock); <span class="hljs-comment">/* 重新加锁线程池 */</span><br><span class="hljs-number">1980</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">1981      * 即使刚刚成功创建了一个新的工作线程，也需要这样做，</span><br><span class="hljs-comment">1982      * 因为 @pool-&gt;lock 已经被释放，新的工作线程可能已经变得繁忙。</span><br><span class="hljs-comment">1983      */</span><br><span class="hljs-number">1984</span>     <span class="hljs-keyword">if</span> (need_to_create_worker(pool)) <span class="hljs-comment">/* 如果需要创建工作线程 */</span><br><span class="hljs-number">1985</span>         <span class="hljs-keyword">goto</span> restart; <span class="hljs-comment">/* 重新开始 */</span><br><span class="hljs-number">1986</span> &#125;<br></code></pre></td></tr></table></figure>
<h5 id="process_one_work0x1e8">process_one_work+0x1e8</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux process_one_work+0x1e8<br>process_one_work+0x1e8/0x438:<br>arch_static_branch 于 <span class="hljs-built_in">arch</span>/arm64/include/asm/jump_label.h:20<br>(已内连入)static_key_false 于 include/linux/jump_label.h:138<br>(已内连入)trace_workqueue_execute_end 于 include/trace/events/workqueue.h:114<br>(已内连入)process_one_work 于 kernel/workqueue.c:2158<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim kernel/workqueue.c +2158</span><br><span class="hljs-comment">// 2158行对应下方代码2133行</span><br><br><span class="hljs-number">2032</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment">2033  * process_one_work - 处理单个工作项</span><br><span class="hljs-comment">2034  * @worker: 自身</span><br><span class="hljs-comment">2035  * @work: 要处理的工作项</span><br><span class="hljs-comment">2036  *</span><br><span class="hljs-comment">2037  * 处理 @work。此函数包含处理单个工作项所需的所有逻辑，包括与同一 CPU 上的其他工作线程同步和交互、排队和刷新。只要满足上下文要求，任何工作线程都可以调用此函数来处理工作项。</span><br><span class="hljs-comment">2038  *</span><br><span class="hljs-comment">2039  * 上下文：</span><br><span class="hljs-comment">2040  * spin_lock_irq(pool-&gt;lock) 在释放并重新获取。</span><br><span class="hljs-comment">2041  */</span><br><span class="hljs-number">2042</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_one_work</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> worker *worker, <span class="hljs-keyword">struct</span> work_struct *work)</span><br>2043 __<span class="hljs-title function_">releases</span><span class="hljs-params">(&amp;pool-&gt;lock)</span> <span class="hljs-comment">/* 释放锁 */</span><br>2044 __<span class="hljs-title function_">acquires</span><span class="hljs-params">(&amp;pool-&gt;lock)</span> <span class="hljs-comment">/* 获取锁 */</span><br>2045 &#123;<br><span class="hljs-number">2046</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pool_workqueue</span> *<span class="hljs-title">pwq</span> =</span> get_work_pwq(work); <span class="hljs-comment">/* 获取工作项所属的 pool_workqueue 结构 */</span><br><span class="hljs-number">2047</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">worker_pool</span> *<span class="hljs-title">pool</span> =</span> worker-&gt;pool; <span class="hljs-comment">/* 获取工作线程所属的 worker_pool 结构 */</span><br><span class="hljs-number">2048</span>     <span class="hljs-type">bool</span> cpu_intensive = pwq-&gt;wq-&gt;flags &amp; WQ_CPU_INTENSIVE; <span class="hljs-comment">/* 判断工作队列是否为 CPU 密集型 */</span><br><span class="hljs-number">2049</span>     <span class="hljs-type">int</span> work_color;<br><span class="hljs-number">2050</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">worker</span> *<span class="hljs-title">collision</span>;</span><br><span class="hljs-number">2051</span> <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_LOCKDEP</span><br><span class="hljs-number">2052</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2053      * 在调用它的函数中释放 struct work_struct 是允许的，因此我们也需要考虑 lockdep。</span><br><span class="hljs-comment">2054      * 为了避免错误的“持有的锁被释放”警告以及在查看 work-&gt;lockdep_map 时出现问题，我们在这里复制并使用。</span><br><span class="hljs-comment">2055      */</span><br><span class="hljs-number">2056</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lockdep_map</span> <span class="hljs-title">lockdep_map</span>;</span><br><span class="hljs-number">2057</span> <br><span class="hljs-number">2058</span>     lockdep_copy_map(&amp;lockdep_map, &amp;work-&gt;lockdep_map);<br><span class="hljs-number">2059</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-number">2060</span>     <span class="hljs-comment">/* 确保我们在正确的 CPU 上 */</span><br><span class="hljs-number">2061</span>     WARN_ON_ONCE(!(pool-&gt;flags &amp; POOL_DISASSOCIATED) &amp;&amp;<br><span class="hljs-number">2062</span>              raw_smp_processor_id() != pool-&gt;cpu);<br><span class="hljs-number">2063</span> <br><span class="hljs-number">2064</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2065      * 单个工作项不应该由单个 CPU 上的多个工作线程并发执行。</span><br><span class="hljs-comment">2066      * 检查是否有任何人已经在处理工作项。如果是，则推迟工作项到当前正在执行的工作线程。</span><br><span class="hljs-comment">2067      */</span><br><span class="hljs-number">2068</span>     collision = find_worker_executing_work(pool, work);<br><span class="hljs-number">2069</span>     <span class="hljs-keyword">if</span> (unlikely(collision)) &#123;<br><span class="hljs-number">2070</span>         move_linked_works(work, &amp;collision-&gt;scheduled, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">/* 移动链接的工作项 */</span><br><span class="hljs-number">2071</span>         <span class="hljs-keyword">return</span>;<br><span class="hljs-number">2072</span>     &#125;<br><span class="hljs-number">2073</span> <br><span class="hljs-number">2074</span>     <span class="hljs-comment">/* 立即声明和出队 */</span><br><span class="hljs-number">2075</span>     debug_work_deactivate(work); <span class="hljs-comment">/* 调试：取消激活工作项 */</span><br><span class="hljs-number">2076</span>     hash_add(pool-&gt;busy_hash, &amp;worker-&gt;hentry, (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)work); <span class="hljs-comment">/* 将工作项添加到 busy_hash 中 */</span><br><span class="hljs-number">2077</span>     worker-&gt;current_work = work; <span class="hljs-comment">/* 设置当前正在处理的工作项 */</span><br><span class="hljs-number">2078</span>     worker-&gt;current_func = work-&gt;func; <span class="hljs-comment">/* 设置当前正在处理的函数 */</span><br><span class="hljs-number">2079</span>     worker-&gt;current_pwq = pwq; <span class="hljs-comment">/* 设置当前工作线程的 pool_workqueue 结构 */</span><br><span class="hljs-number">2080</span>     work_color = get_work_color(work); <span class="hljs-comment">/* 获取工作项颜色 */</span><br><span class="hljs-number">2081</span> <br><span class="hljs-number">2082</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2083      * 记录工作队列名称以用于命令行和调试报告，可能通过 set_worker_desc() 被覆盖。</span><br><span class="hljs-comment">2084      */</span><br><span class="hljs-number">2085</span>     strscpy(worker-&gt;desc, pwq-&gt;wq-&gt;name, WORKER_DESC_LEN); <span class="hljs-comment">/* 复制工作队列名称 */</span><br><span class="hljs-number">2086</span> <br><span class="hljs-number">2087</span>     list_del_init(&amp;work-&gt;entry); <span class="hljs-comment">/* 从队列中移除工作项 */</span><br><span class="hljs-number">2088</span> <br><span class="hljs-number">2089</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2090      * CPU 密集型工作不参与并发管理。</span><br><span class="hljs-comment">2091      * 它们是调度器的责任。这将把 @worker 从并发管理中移除，下一个代码块将链式执行挂起的工作项。</span><br><span class="hljs-comment">2092      */</span><br><span class="hljs-number">2093</span>     <span class="hljs-keyword">if</span> (unlikely(cpu_intensive))<br><span class="hljs-number">2094</span>         worker_set_flags(worker, WORKER_CPU_INTENSIVE); <span class="hljs-comment">/* 设置工作线程标志为 CPU 密集型 */</span><br><span class="hljs-number">2095</span> <br><span class="hljs-number">2096</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2097      * 如果需要，唤醒另一个工作线程。对于普通的 per-cpu 工作线程，此条件始终为 false，因为此时 nr_running 通常为 &gt;= 1。</span><br><span class="hljs-comment">2098      * 这用于链式执行挂起的工作项，对于 WORKER_NOT_RUNNING 工作线程（例如 UNBOUND 和 CPU_INTENSIVE），此条件始终为 true。</span><br><span class="hljs-comment">2099      */</span><br><span class="hljs-number">2100</span>     <span class="hljs-keyword">if</span> (need_more_worker(pool))<br><span class="hljs-number">2101</span>         wake_up_worker(pool); <span class="hljs-comment">/* 唤醒另一个工作线程 */</span><br><span class="hljs-number">2102</span> <br><span class="hljs-number">2103</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2104      * 记录最后的 pool 并清除 PENDING，这应该是 @work 的最后更新。</span><br><span class="hljs-comment">2105      * 此外，在 @pool-&gt;lock 中执行此操作，以便在禁用 IRQ 时同时进行 PENDING 和队列状态的更改。</span><br><span class="hljs-comment">2106      */</span><br><span class="hljs-number">2107</span>     set_work_pool_and_clear_pending(work, pool-&gt;id); <span class="hljs-comment">/* 设置工作项所属的 pool 并清除 PENDING */</span><br><span class="hljs-number">2108</span> <br><span class="hljs-number">2109</span>     spin_unlock_irq(&amp;pool-&gt;lock); <span class="hljs-comment">/* 解锁 */</span><br><span class="hljs-number">2110</span> <br><span class="hljs-number">2111</span>     lock_map_acquire(&amp;pwq-&gt;wq-&gt;lockdep_map); <span class="hljs-comment">/* 获取工作队列的 lockdep_map */</span><br><span class="hljs-number">2112</span>     lock_map_acquire(&amp;lockdep_map); <span class="hljs-comment">/* 获取 lockdep_map */</span><br><span class="hljs-number">2113</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2114      * 严格来说，我们应该在不持有任何锁的情况下标记不变状态，也就是说，在这两个 lock_map_acquire() 之前。</span><br><span class="hljs-comment">2115      *</span><br><span class="hljs-comment">2116      * 然而，这会导致：</span><br><span class="hljs-comment">2117      *</span><br><span class="hljs-comment">2118      *   A(W1)</span><br><span class="hljs-comment">2119      *   WFC(C)</span><br><span class="hljs-comment">2120      *      A(W1)</span><br><span class="hljs-comment">2121      *      C(C)</span><br><span class="hljs-comment">2122      *</span><br><span class="hljs-comment">2123      * 这将创建 W1-&gt;C-&gt;W1 依赖关系，即使实际上不存在死锁问题。有两种解决方案，一种是在工作（队列）&#x27;锁&#x27;上使用读递归获取，但是这将击中递归锁的 lockdep 限制，或者简单地丢弃这些锁。</span><br><span class="hljs-comment">2124      *</span><br><span class="hljs-comment">2125      * 据我所知，在 flush_work() 和 complete() 原语之间不存在可能的死锁场景（单线程工作队列除外），因此隐藏它们不是问题。</span><br><span class="hljs-comment">2126      */</span><br><span class="hljs-number">2127</span>     lockdep_invariant_state(<span class="hljs-literal">true</span>); <span class="hljs-comment">/* 锁定状态 */</span><br><span class="hljs-number">2128</span>     trace_workqueue_execute_start(work); <span class="hljs-comment">/* 跟踪工作项执行的开始 */</span><br><span class="hljs-number">2129</span>     worker-&gt;current_func(work); <span class="hljs-comment">/* 执行工作项的函数 */</span><br><span class="hljs-number">2130</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2131      * 虽然我们必须小心在此之后不要使用 &quot;work&quot;，但跟踪点仅记录其地址。</span><br><span class="hljs-comment">2132      */</span><br><span class="hljs-number">2133</span>     trace_workqueue_execute_end(work); <span class="hljs-comment">/* 跟踪工作项执行的结束 */</span><br><span class="hljs-number">2134</span>     lock_map_release(&amp;lockdep_map); <span class="hljs-comment">/* 释放 lockdep_map */</span><br><span class="hljs-number">2135</span>     lock_map_release(&amp;pwq-&gt;wq-&gt;lockdep_map); <span class="hljs-comment">/* 释放工作队列的 lockdep_map */</span><br><span class="hljs-number">2136</span> <br><span class="hljs-number">2137</span>     <span class="hljs-keyword">if</span> (unlikely(in_atomic() || lockdep_depth(current) &gt; <span class="hljs-number">0</span>)) &#123;<br><span class="hljs-number">2138</span>         pr_err(<span class="hljs-string">&quot;BUG: workqueue leaked lock or atomic: %s/0x%08x/%d\n&quot;</span><br><span class="hljs-number">2139</span>                <span class="hljs-string">&quot;     last function: %pf\n&quot;</span>,<br><span class="hljs-number">2140</span>                current-&gt;comm, preempt_count(), task_pid_nr(current),<br><span class="hljs-number">2141</span>                worker-&gt;current_func);<br><span class="hljs-number">2142</span>         debug_show_held_locks(current);<br><span class="hljs-number">2143</span>         dump_stack();<br><span class="hljs-number">2144</span>     &#125;<br><span class="hljs-number">2145</span> <br><span class="hljs-number">2146</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2147      * 以下防止 kworker 在 !PREEMPT 内核中独占 CPU，在此情况下，等待某些事情发生的重新排队工作项可能会与 stop_machine 死锁，因为这样的工作项可能会无限期地重新排队，而所有其他 CPU 都被困在 stop_machine 中。同时，报告一个静态的 RCU 状态，因此相同的条件不会冻结 RCU。</span><br><span class="hljs-comment">2148      */</span><br><span class="hljs-number">2149</span>     cond_resched(); <span class="hljs-comment">/* 条件调度 */</span><br><span class="hljs-number">2150</span> <br><span class="hljs-number">2151</span>     spin_lock_irq(&amp;pool-&gt;lock); <span class="hljs-comment">/* 加锁 */</span><br><span class="hljs-number">2152</span> <br><span class="hljs-number">2153</span>     <span class="hljs-comment">/* 清除 CPU 密集型状态 */</span><br><span class="hljs-number">2154</span>     <span class="hljs-keyword">if</span> (unlikely(cpu_intensive))<br><span class="hljs-number">2155</span>         worker_clr_flags(worker, WORKER_CPU_INTENSIVE); <span class="hljs-comment">/* 清除工作线程标志为 CPU 密集型 */</span><br><span class="hljs-number">2156</span> <br><span class="hljs-number">2157</span>     <span class="hljs-comment">/* 完成，释放 */</span><br><span class="hljs-number">2158</span>     hash_del(&amp;worker-&gt;hentry); <span class="hljs-comment">/* 从 busy_hash 中删除 */</span><br><span class="hljs-number">2159</span>     worker-&gt;current_work = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* 清除当前工作项 */</span><br><span class="hljs-number">2160</span>     worker-&gt;current_func = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* 清除当前函数 */</span><br><span class="hljs-number">2161</span>     worker-&gt;current_pwq = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* 清除当前 pool_workqueue 结构 */</span><br><span class="hljs-number">2162</span>     pwq_dec_nr_in_flight(pwq, work_color); <span class="hljs-comment">/* 减少在飞行中的工作项数量 */</span><br><span class="hljs-number">2163</span> &#125;<br></code></pre></td></tr></table></figure>
<h5
id="memcg_kmem_cache_create_func0x1c">memcg_kmem_cache_create_func+0x1c</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">./scripts/faddr2line vmlinux memcg_kmem_cache_create_func+0x1c<br>memcg_kmem_cache_create_func+0x1c/0x90:<br>css_put 于 include/linux/cgroup.h:391<br>(已内连入)memcg_kmem_cache_create_func 于 mm/memcontrol.c:2509<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">2500</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">memcg_kmem_cache_create_func</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> work_struct *w)</span><br>2501 &#123;<br><span class="hljs-number">2502</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">memcg_kmem_cache_create_work</span> *<span class="hljs-title">cw</span> =</span><br><span class="hljs-number">2503</span>         container_of(w, <span class="hljs-keyword">struct</span> memcg_kmem_cache_create_work, work); <span class="hljs-comment">/* 将结构体指针从工作项指针中获取 */</span><br><span class="hljs-number">2504</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span> =</span> cw-&gt;memcg; <span class="hljs-comment">/* 获取内存控制组指针 */</span><br><span class="hljs-number">2505</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">cachep</span> =</span> cw-&gt;cachep; <span class="hljs-comment">/* 获取内核内存高速缓存指针 */</span><br><span class="hljs-number">2506</span> <br><span class="hljs-number">2507</span>     memcg_create_kmem_cache(memcg, cachep); <span class="hljs-comment">/* 创建内存控制组的内核内存高速缓存 */</span><br><span class="hljs-number">2508</span> <br><span class="hljs-number">2509</span>     css_put(&amp;memcg-&gt;css); <span class="hljs-comment">/* 减少内存控制组引用计数 */</span><br><span class="hljs-number">2510</span>     kfree(cw); <span class="hljs-comment">/* 释放内存控制组的 kmem_cache 创建工作项 */</span><br><span class="hljs-number">2511</span> &#125;<br></code></pre></td></tr></table></figure>
<h6
id="memcg_schedule_kmem_cache_create">__memcg_schedule_kmem_cache_create</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim mm/memcontrol.c +2529</span><br><br><span class="hljs-number">2513</span> <span class="hljs-comment">/*</span><br><span class="hljs-comment">2514  * Enqueue the creation of a per-memcg kmem_cache.</span><br><span class="hljs-comment">2515  * 将一个针对每个内存控制组的内核内存高速缓存的创建任务加入队列。</span><br><span class="hljs-comment">2516  */</span><br><span class="hljs-number">2517</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> __memcg_schedule_kmem_cache_create(<span class="hljs-keyword">struct</span> mem_cgroup *memcg,<br><span class="hljs-number">2518</span>                            <span class="hljs-keyword">struct</span> kmem_cache *cachep)<br><span class="hljs-number">2519</span> &#123;<br><span class="hljs-number">2520</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">memcg_kmem_cache_create_work</span> *<span class="hljs-title">cw</span>;</span> <span class="hljs-comment">/* 声明一个内存控制组 kmem_cache 创建工作项指针 */</span><br><span class="hljs-number">2521</span> <br><span class="hljs-number">2522</span>     cw = kmalloc(<span class="hljs-keyword">sizeof</span>(*cw), GFP_NOWAIT | __GFP_NOWARN); <span class="hljs-comment">/* 分配内存控制组 kmem_cache 创建工作项 */</span><br><span class="hljs-number">2523</span>     <span class="hljs-keyword">if</span> (!cw) <span class="hljs-comment">/* 如果分配失败 */</span><br><span class="hljs-number">2524</span>         <span class="hljs-keyword">return</span>; <span class="hljs-comment">/* 直接返回 */</span><br><span class="hljs-number">2525</span> <br><span class="hljs-number">2526</span>     css_get(&amp;memcg-&gt;css); <span class="hljs-comment">/* 增加内存控制组的引用计数 */</span><br><span class="hljs-number">2527</span> <br><span class="hljs-number">2528</span>     cw-&gt;memcg = memcg; <span class="hljs-comment">/* 设置内存控制组指针 */</span><br><span class="hljs-number">2529</span>     cw-&gt;cachep = cachep; <span class="hljs-comment">/* 设置内核内存高速缓存指针 */</span><br><span class="hljs-number">2530</span>     INIT_WORK(&amp;cw-&gt;work, memcg_kmem_cache_create_func); <span class="hljs-comment">/* 初始化工作项 */</span><br><span class="hljs-number">2531</span> <br><span class="hljs-number">2532</span>     queue_work(memcg_kmem_cache_wq, &amp;cw-&gt;work); <span class="hljs-comment">/* 将工作项加入工作队列 */</span><br><span class="hljs-number">2533</span> &#125;<br></code></pre></td></tr></table></figure>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/20240409164020.png" srcset="/img/loading.gif" lazyload
alt="__memcg_schedule_kmem_cache_create" />
<figcaption
aria-hidden="true">__memcg_schedule_kmem_cache_create</figcaption>
</figure>
<h6
id="memcg_schedule_kmem_cache_create-1">memcg_schedule_kmem_cache_create</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim mm/memcontrol.c +2534</span><br><span class="hljs-number">2534</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">memcg_schedule_kmem_cache_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mem_cgroup *memcg,</span><br><span class="hljs-params"><span class="hljs-number">2535</span>                          <span class="hljs-keyword">struct</span> kmem_cache *cachep)</span><br>2536 &#123;<br><span class="hljs-number">2537</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2538      * We need to stop accounting when we kmalloc, because if the</span><br><span class="hljs-comment">2539      * corresponding kmalloc cache is not yet created, the first allocation</span><br><span class="hljs-comment">2540      * in __memcg_schedule_kmem_cache_create will recurse.</span><br><span class="hljs-comment">2541      * 我们需要在进行 kmalloc 时停止计费，因为如果对应的 kmalloc 缓存尚未创建，</span><br><span class="hljs-comment">2542      * 那么 __memcg_schedule_kmem_cache_create 中的第一个分配会递归调用。</span><br><span class="hljs-comment">2543      *</span><br><span class="hljs-comment">2544      * However, it is better to enclose the whole function. Depending on</span><br><span class="hljs-comment">2545      * the debugging options enabled, INIT_WORK(), for instance, can</span><br><span class="hljs-comment">2546      * trigger an allocation. This too, will make us recurse. Because at</span><br><span class="hljs-comment">2547      * this point we can&#x27;t allow ourselves back into memcg_kmem_get_cache,</span><br><span class="hljs-comment">2548      * the safest choice is to do it like this, wrapping the whole function.</span><br><span class="hljs-comment">2549      * 但是，最好将整个函数封装起来。取决于启用的调试选项，例如 INIT_WORK() 可能</span><br><span class="hljs-comment">2550      * 会触发一个分配。这也会导致我们递归调用。因为此时我们不能再允许自己回到</span><br><span class="hljs-comment">2551      * memcg_kmem_get_cache 中，所以最安全的选择是这样做，将整个函数封装起来。</span><br><span class="hljs-comment">2552      */</span><br><span class="hljs-number">2553</span>     current-&gt;memcg_kmem_skip_account = <span class="hljs-number">1</span>; <span class="hljs-comment">/* 设置当前进程 memcg_kmem_skip_account 为 1 */</span><br><span class="hljs-number">2554</span>     __memcg_schedule_kmem_cache_create(memcg, cachep); <span class="hljs-comment">/* 调用内部函数以创建 kmem_cache */</span><br><span class="hljs-number">2555</span>     current-&gt;memcg_kmem_skip_account = <span class="hljs-number">0</span>; <span class="hljs-comment">/* 恢复当前进程 memcg_kmem_skip_account 为 0 */</span><br><span class="hljs-number">2556</span> &#125;<br></code></pre></td></tr></table></figure>
<h6 id="memcg_kmem_get_cache">memcg_kmem_get_cache</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim mm/memcontrol.c +2621</span><br><br><span class="hljs-number">2560</span> <span class="hljs-comment">/**</span><br><span class="hljs-comment">2561  * memcg_kmem_get_cache: 选择正确的每个内存控制组（memcg）缓存进行分配</span><br><span class="hljs-comment">2562  * @cachep: 原始的全局 kmem 缓存</span><br><span class="hljs-comment">2563  *</span><br><span class="hljs-comment">2564  * 返回我们应该用于 slab 分配的 kmem_cache。</span><br><span class="hljs-comment">2565  * 我们尝试使用当前 memcg 的缓存版本。</span><br><span class="hljs-comment">2566  *</span><br><span class="hljs-comment">2567  * 如果缓存尚不存在，如果我们是其第一个用户，我们会在工作队列中异步创建它，并让当前分配通过原始缓存。</span><br><span class="hljs-comment">2568  *</span><br><span class="hljs-comment">2569  * 此函数对返回的缓存进行引用以确保在使用过程中不会被销毁。一旦调用者完成使用，必须调用 memcg_kmem_put_cache() 来释放引用。</span><br><span class="hljs-comment">2570  */</span><br><span class="hljs-number">2571</span> <span class="hljs-keyword">struct</span> kmem_cache *<span class="hljs-title function_">memcg_kmem_get_cache</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *cachep)</span><br>2572 &#123;<br><span class="hljs-number">2573</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mem_cgroup</span> *<span class="hljs-title">memcg</span>;</span> <span class="hljs-comment">/* 内存控制组 */</span><br><span class="hljs-number">2574</span>     <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">memcg_cachep</span>;</span> <span class="hljs-comment">/* 内存控制组缓存 */</span><br><span class="hljs-number">2575</span>     <span class="hljs-type">int</span> kmemcg_id; <span class="hljs-comment">/* 内存控制组 ID */</span><br><span class="hljs-number">2576</span> <br><span class="hljs-number">2577</span>     VM_BUG_ON(!is_root_cache(cachep)); <span class="hljs-comment">/* 确保传入的缓存是根缓存 */</span><br><span class="hljs-number">2578</span> <br><span class="hljs-number">2579</span>     <span class="hljs-keyword">if</span> (memcg_kmem_bypass()) <span class="hljs-comment">/* 如果绕过 memcg_kmem */</span><br><span class="hljs-number">2580</span>         <span class="hljs-keyword">return</span> cachep; <span class="hljs-comment">/* 直接返回原始缓存 */</span><br><span class="hljs-number">2581</span> <br><span class="hljs-number">2582</span>     <span class="hljs-keyword">if</span> (current-&gt;memcg_kmem_skip_account) <span class="hljs-comment">/* 如果当前线程不用进行记账 */</span><br><span class="hljs-number">2583</span>         <span class="hljs-keyword">return</span> cachep; <span class="hljs-comment">/* 直接返回原始缓存 */</span><br><span class="hljs-number">2584</span> <br><span class="hljs-number">2585</span>     memcg = get_mem_cgroup_from_current(); <span class="hljs-comment">/* 从当前线程获取内存控制组 */</span><br><span class="hljs-number">2586</span>     kmemcg_id = READ_ONCE(memcg-&gt;kmemcg_id); <span class="hljs-comment">/* 读取内存控制组的 ID */</span><br><span class="hljs-number">2587</span>     <span class="hljs-keyword">if</span> (kmemcg_id &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* 如果内存控制组 ID 小于 0 */</span><br><span class="hljs-number">2588</span>         <span class="hljs-keyword">goto</span> out; <span class="hljs-comment">/* 跳转到 out 标签 */</span><br><span class="hljs-number">2589</span> <br><span class="hljs-number">2590</span>     memcg_cachep = cache_from_memcg_idx(cachep, kmemcg_id); <span class="hljs-comment">/* 根据内存控制组 ID 获取缓存 */</span><br><span class="hljs-number">2591</span>     <span class="hljs-keyword">if</span> (likely(memcg_cachep)) <span class="hljs-comment">/* 如果成功获取到内存控制组缓存 */</span><br><span class="hljs-number">2592</span>         <span class="hljs-keyword">return</span> memcg_cachep; <span class="hljs-comment">/* 返回内存控制组缓存 */</span><br><span class="hljs-number">2593</span> <br><span class="hljs-number">2594</span>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">2595      * 如果我们在安全的上下文中（可以等待，且不在中断上下文中），我们可以预测并立即返回。</span><br><span class="hljs-comment">2596      * 这将确保正在执行的分配已经属于新缓存。</span><br><span class="hljs-comment">2597      *</span><br><span class="hljs-comment">2598      * 但是，有些锁可能会引发冲突。</span><br><span class="hljs-comment">2599      * 例如，因为我们在执行 memcg_create_kmem_cache 时会获取 slab_mutex，这意味着在持有 slab_mutex 时不能进行进一步的分配。</span><br><span class="hljs-comment">2600      * 因此，最好推迟一切。</span><br><span class="hljs-comment">2601      */</span><br><span class="hljs-number">2602</span>     memcg_schedule_kmem_cache_create(memcg, cachep); <span class="hljs-comment">/* 调度创建内存控制组缓存 */</span><br><span class="hljs-number">2603</span> out:<br><span class="hljs-number">2604</span>     css_put(&amp;memcg-&gt;css); <span class="hljs-comment">/* 释放内存控制组的引用 */</span><br><span class="hljs-number">2605</span>     <span class="hljs-keyword">return</span> cachep; <span class="hljs-comment">/* 返回原始缓存 */</span><br><span class="hljs-number">2606</span> &#125;<br></code></pre></td></tr></table></figure>
<p>用bpf追踪一下哪些进程会调用memcg_kmem_get_cache：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-bpfcc -t memcg_kmem_get_cache | <span class="hljs-built_in">tee</span> memcg_kmem_get_cache1.log<br></code></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">TIME     PID     TID     COMM            FUNC             <br>1.620114 935     935     redis-server    memcg_kmem_get_cache <br>1.620177 935     935     redis-server    memcg_kmem_get_cache <br>1.620193 935     935     redis-server    memcg_kmem_get_cache <br>1.620216 935     935     redis-server    memcg_kmem_get_cache <br>1.720512 935     935     redis-server    memcg_kmem_get_cache <br>1.720576 935     935     redis-server    memcg_kmem_get_cache <br>1.720591 935     935     redis-server    memcg_kmem_get_cache <br>1.720620 935     935     redis-server    memcg_kmem_get_cache <br>1.787920 895     954     QDBusConnection memcg_kmem_get_cache <br>1.787975 895     954     QDBusConnection memcg_kmem_get_cache <br>1.788464 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788496 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788512 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788527 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788538 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788678 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788694 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788705 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788715 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788737 2975    2975    deepin-system-m memcg_kmem_get_cache <br>1.788440 895     963     QThread         memcg_kmem_get_cache <br>1.789300 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.789335 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.789422 895     965     QThread         memcg_kmem_get_cache <br>1.789467 895     965     QThread         memcg_kmem_get_cache <br>1.789586 895     965     QThread         memcg_kmem_get_cache <br>1.789426 1205    1205    Xorg            memcg_kmem_get_cache <br>1.789465 1205    1205    Xorg            memcg_kmem_get_cache <br>1.789734 895     965     QThread         memcg_kmem_get_cache <br>1.797259 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.797301 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.797425 1205    1205    Xorg            memcg_kmem_get_cache <br>1.797450 1205    1205    Xorg            memcg_kmem_get_cache <br>1.797629 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.797657 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.797735 1205    1205    Xorg            memcg_kmem_get_cache <br>1.797751 1205    1205    Xorg            memcg_kmem_get_cache <br>1.798109 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.798136 4405    4405    deepin-terminal memcg_kmem_get_cache <br>1.803705 895     965     QThread         memcg_kmem_get_cache <br>1.803754 895     965     QThread         memcg_kmem_get_cache <br>1.803770 895     965     QThread         memcg_kmem_get_cache <br></code></pre></td></tr></table></figure>
<p>貌似每个进程都会调用memcg_kmem_get_cache函数，也就意味着每次分配都会在内存控制组缓存中创建一个新的缓存。</p>
<h6 id="slab_pre_alloc_hook">slab_pre_alloc_hook</h6>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vim mm/slab.h +429</span><br><br><span class="hljs-number">414</span> <span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> kmem_cache *<span class="hljs-title function_">slab_pre_alloc_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params"><span class="hljs-number">415</span>                              <span class="hljs-type">gfp_t</span> flags)</span><br>416 &#123;<br><span class="hljs-number">417</span>     flags &amp;= gfp_allowed_mask; <span class="hljs-comment">/* 仅保留与允许的标志位相匹配的标志位 */</span><br><span class="hljs-number">418</span> <br><span class="hljs-number">419</span>     fs_reclaim_acquire(flags); <span class="hljs-comment">/* 获取文件系统回收锁 */</span><br><span class="hljs-number">420</span>     fs_reclaim_release(flags); <span class="hljs-comment">/* 释放文件系统回收锁 */</span><br><span class="hljs-number">421</span> <br><span class="hljs-number">422</span>     might_sleep_if(gfpflags_allow_blocking(flags)); <span class="hljs-comment">/* 如果允许阻塞，则可能会休眠 */</span><br><span class="hljs-number">423</span> <br><span class="hljs-number">424</span>     <span class="hljs-keyword">if</span> (should_failslab(s, flags)) <span class="hljs-comment">/* 如果应该失败分配 slab */</span><br><span class="hljs-number">425</span>         <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">/* 返回空指针 */</span><br><span class="hljs-number">426</span> <br><span class="hljs-number">427</span>     <span class="hljs-keyword">if</span> (memcg_kmem_enabled() &amp;&amp; <span class="hljs-comment">/* 如果启用了 memcg_kmem */</span><br><span class="hljs-number">428</span>         ((flags &amp; __GFP_ACCOUNT) || (s-&gt;flags &amp; SLAB_ACCOUNT))) <span class="hljs-comment">/* 如果分配需要记账 */</span><br><span class="hljs-number">429</span>         <span class="hljs-keyword">return</span> memcg_kmem_get_cache(s); <span class="hljs-comment">/* 返回 memcg_kmem 获取的缓存 */</span><br><span class="hljs-number">430</span> <br><span class="hljs-number">431</span>     <span class="hljs-keyword">return</span> s; <span class="hljs-comment">/* 返回原始的 kmem_cache */</span><br><span class="hljs-number">432</span> &#125; <br><br></code></pre></td></tr></table></figure>
<p>此处好像有个递归？？？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">slab_pre_alloc_hook               <span class="hljs-comment">// mm/slab.h +414</span><br>  memcg_kmem_get_cache            <span class="hljs-comment">// mm/slab.h +429</span><br>    kmem_cache_alloc              <span class="hljs-comment">// mm/slub.c +2719</span><br>      slab_alloc_node             <span class="hljs-comment">// mm/slub.c +2714</span><br>        slab_pre_alloc_hook       <span class="hljs-comment">// mm/slub.c +2632</span><br></code></pre></td></tr></table></figure>
<p>这个递归解释了memcg_schedule_kmem_cache_create函数注释中提到的可能存在递归的原因。</p>
<h5 id="修复方案">修复方案</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c">From dfd4043beff95e15bad4207cc9db9b29940e20d4 Mon Sep <span class="hljs-number">17</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">2001</span><br>From: yuanqiliang &lt;yuanqiliang@uniontech.com&gt;<br>Date: Tue, <span class="hljs-number">16</span> Apr <span class="hljs-number">2024</span> <span class="hljs-number">11</span>:<span class="hljs-number">12</span>:<span class="hljs-number">58</span> +<span class="hljs-number">0800</span><br>Subject: [PATCH] mm/memcg: very high memory usage due to kernfs_node_cache slabs<br><br>Bug: https:<span class="hljs-comment">//pms.uniontech.com/bug-view-238303.html</span><br><br>Log:<br>use command <span class="hljs-string">&quot;slabtop -s c -o&quot;</span>, kernfs_node_cache is ranked first<br>and continues to grow. SUnreclaim is also continuously increasing.<br><br>The current memory management code has significant differences from<br>upstream. This issue does not exist in upstream linux<span class="hljs-number">-4.19</span>.y. Although<br>this commit fixes the problem, it is still recommended to sync with the<br>upstream code.<br><br>Check kernfs_node_cache allocation in /var/<span class="hljs-built_in">log</span>/kern.<span class="hljs-built_in">log</span>:<br><br>all trace:<br>dump_backtrace+<span class="hljs-number">0x0</span>/<span class="hljs-number">0x190</span><br>show_stack+<span class="hljs-number">0x14</span>/<span class="hljs-number">0x20</span><br>dump_stack+<span class="hljs-number">0xa8</span>/<span class="hljs-number">0xcc</span><br>alloc_debug_processing+<span class="hljs-number">0x58</span>/<span class="hljs-number">0x188</span><br>___slab_alloc.constprop<span class="hljs-number">.34</span>+<span class="hljs-number">0x31c</span>/<span class="hljs-number">0x388</span><br>kmem_cache_alloc+<span class="hljs-number">0x210</span>/<span class="hljs-number">0x278</span><br>__kernfs_new_node+<span class="hljs-number">0x60</span>/<span class="hljs-number">0x1f8</span><br>kernfs_new_node+<span class="hljs-number">0x24</span>/<span class="hljs-number">0x48</span><br>kernfs_create_dir_ns+<span class="hljs-number">0x30</span>/<span class="hljs-number">0x88</span><br>cgroup_mkdir+<span class="hljs-number">0x2f0</span>/<span class="hljs-number">0x4e8</span><br>kernfs_iop_mkdir+<span class="hljs-number">0x58</span>/<span class="hljs-number">0x88</span><br>vfs_mkdir+<span class="hljs-number">0xfc</span>/<span class="hljs-number">0x1c0</span><br>do_mkdirat+<span class="hljs-number">0xec</span>/<span class="hljs-number">0x100</span><br>__arm64_sys_mkdirat+<span class="hljs-number">0x1c</span>/<span class="hljs-number">0x28</span><br>el0_svc_common+<span class="hljs-number">0x90</span>/<span class="hljs-number">0x178</span><br>el0_svc_handler+<span class="hljs-number">0x9c</span>/<span class="hljs-number">0xa8</span><br>el0_svc+<span class="hljs-number">0x8</span>/<span class="hljs-number">0xc</span><br><br>To trace kernfs_new_node using BPF:<br><br>trace-bpfcc -tKU kernfs_new_node<br><span class="hljs-number">3.796820</span> <span class="hljs-number">47</span>      <span class="hljs-number">47</span>      kworker/<span class="hljs-number">3</span>:<span class="hljs-number">1</span>     kernfs_new_node<br>kernfs_new_node+<span class="hljs-number">0x0</span> [kernel]<br>sysfs_add_file_mode_ns+<span class="hljs-number">0x9c</span> [kernel]<br>internal_create_group+<span class="hljs-number">0x104</span> [kernel]<br>sysfs_create_group+<span class="hljs-number">0x14</span> [kernel]  # 上游<span class="hljs-number">4.19</span><span class="hljs-number">.306</span>这里没走到<br>sysfs_slab_add+<span class="hljs-number">0xb8</span> [kernel]      # 上游<span class="hljs-number">4.19</span><span class="hljs-number">.306</span>这里走到了<br>__kmem_cache_create+<span class="hljs-number">0x128</span> [kernel]<br>create_cache+<span class="hljs-number">0xcc</span> [kernel]<br>memcg_create_kmem_cache+<span class="hljs-number">0xf8</span> [kernel]<br>memcg_kmem_cache_create_func+<span class="hljs-number">0x1c</span> [kernel]<br>process_one_work+<span class="hljs-number">0x1e8</span> [kernel]<br>worker_thread+<span class="hljs-number">0x48</span> [kernel]<br>kthread+<span class="hljs-number">0x128</span> [kernel]<br>ret_from_fork+<span class="hljs-number">0x10</span> [kernel]<br><span class="hljs-number">-14</span><br><br>Signed-off-by: yuanqiliang &lt;yuanqiliang@uniontech.com&gt;<br>Change-Id: Ia13f72f6a0b8e9944fd8dafb6f68c7170081a591<br>---<br><br>diff --git a/mm/slab_common.c b/mm/slab_common.c<br>index <span class="hljs-number">1519956.</span><span class="hljs-number">.93343e5</span> <span class="hljs-number">100644</span><br>--- a/mm/slab_common.c<br>+++ b/mm/slab_common.c<br>@@ <span class="hljs-number">-147</span>,<span class="hljs-number">6</span> +<span class="hljs-number">147</span>,<span class="hljs-number">7</span> @@<br> <br> 	<span class="hljs-keyword">if</span> (root_cache) &#123;<br> 		s-&gt;memcg_params.root_cache = root_cache;<br>+		s-&gt;memcg_params.root_cache-&gt;memcg_kset = <span class="hljs-literal">NULL</span>;<br> 		s-&gt;memcg_params.memcg = memcg;<br> 		INIT_LIST_HEAD(&amp;s-&gt;memcg_params.children_node);<br> 		INIT_LIST_HEAD(&amp;s-&gt;memcg_params.kmem_caches_node);<br></code></pre></td></tr></table></figure>
<p>linux-4.19.y上<code>*(s-&gt;memcg_params.root_cache-&gt;memcg_kset) = 0</code>，
uos-arm-kernel-1053-tyy上<code>*(s-&gt;memcg_params.root_cache-&gt;memcg_kset)</code>是个随机值。</p>
<p>kmem_cache通过双向链表管理，kmem_cache父节点的memcg_kset会传导给子节点，故第一个非根节点的kset需要初始化为null。</p>
<p>本次问题虽然修复了，但是感觉uos-arm-kernel-1053-tyy上存在一个CVE。</p>
<figure>
<img
src="https://cdn.jsdelivr.net/gh/realwujing/picture-bed/企业微信截图_17132357917855.png" srcset="/img/loading.gif" lazyload
alt="修复后跟上游对比" />
<figcaption aria-hidden="true">修复后跟上游对比</figcaption>
</figure>
<h4 id="systemd">systemd</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash">TIME     PID     TID     COMM            FUNC             <br>3.781989 1       1       systemd         kernfs_new_node  <br>        kernfs_new_node+0x0 [kernel]<br>        cgroup_mkdir+0x2f0 [kernel]<br>        kernfs_iop_mkdir+0x58 [kernel]<br>        vfs_mkdir+0xfc [kernel]<br>        do_mkdirat+0xec [kernel]<br>        __arm64_sys_mkdirat+0x1c [kernel]<br>        el0_svc_common+0x90 [kernel]<br>        el0_svc_handler+0x9c [kernel]<br>        el0_svc+0x8 [kernel]<br>        <span class="hljs-built_in">mkdir</span>+0x14 [libc-2.28.so]<br>        [unknown] [libsystemd-shared-241.so (deleted)]<br>        [unknown] [libsystemd-shared-241.so (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [libsystemd-shared-241.so (deleted)]<br>        [unknown] [libsystemd-shared-241.so (deleted)]<br>        [unknown] [libsystemd-shared-241.so (deleted)]<br>        [unknown] [systemd (deleted)]<br>        [unknown] [systemd (deleted)]<br>        __libc_start_main+0xe4 [libc-2.28.so]<br>        [unknown] [systemd (deleted)]<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">bpftrace -l | grep cgroup_mkdir<br>tracepoint:cgroup:cgroup_mkdir<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">trace-bpfcc -tKU cgroup_mkdir | <span class="hljs-built_in">tee</span> cgroup_mkdir.log<br></code></pre></td></tr></table></figure>
<p>vim cgroup_mkdir.log:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs bash">TIME     PID     TID     COMM            FUNC             <br>11.08041 1       1       systemd         cgroup_mkdir     <br>        cgroup_mkdir+0x0 [kernel]<br>        vfs_mkdir+0xfc [kernel]<br>        do_mkdirat+0xec [kernel]<br>        __arm64_sys_mkdirat+0x1c [kernel]<br>        el0_svc_common+0x90 [kernel]<br>        el0_svc_handler+0x9c [kernel]<br>        el0_svc+0x8 [kernel]<br>        [unknown] [libc-2.28.so (deleted)]<br>        cg_create.localalias.13+0x64 [libsystemd-shared-241.so]<br>        cg_create_everywhere+0x30 [libsystemd-shared-241.so]<br>        unit_create_cgroup+0xb4 [systemd]<br>        unit_realize_cgroup_now.lto_priv.665+0xa8 [systemd]<br>        unit_realize_cgroup+0x16c [systemd]<br>        unit_prepare_exec+0x18 [systemd]<br>        service_spawn.lto_priv.382+0x80 [systemd]<br>        service_start.lto_priv.56+0x144 [systemd]<br>        job_perform_on_unit.lto_priv.422+0x6b4 [systemd]<br>        manager_dispatch_run_queue.lto_priv.589+0x358 [systemd]<br>        source_dispatch+0x118 [libsystemd-shared-241.so]<br>        sd_event_dispatch+0x150 [libsystemd-shared-241.so]<br>        sd_event_run+0x90 [libsystemd-shared-241.so]<br>        invoke_main_loop+0xff4 [systemd]<br>        main+0x1660 [systemd]<br>        [unknown] [libc-2.28.so (deleted)]<br>        [unknown] [systemd]<br><br>11.08056 1       1       systemd         cgroup_mkdir     <br>        cgroup_mkdir+0x0 [kernel]<br>        vfs_mkdir+0xfc [kernel]<br>        do_mkdirat+0xec [kernel]<br>        __arm64_sys_mkdirat+0x1c [kernel]<br>        el0_svc_common+0x90 [kernel]<br>        el0_svc_handler+0x9c [kernel]<br>        el0_svc+0x8 [kernel]<br>        [unknown] [libc-2.28.so (deleted)]<br>        cg_create.localalias.13+0x64 [libsystemd-shared-241.so]<br>        cg_create.localalias.13+0xe8 [libsystemd-shared-241.so]<br>        cg_create_everywhere+0x30 [libsystemd-shared-241.so]<br>        unit_create_cgroup+0xb4 [systemd]<br>        unit_realize_cgroup_now.lto_priv.665+0xa8 [systemd]<br>        unit_realize_cgroup+0x16c [systemd]<br>        unit_prepare_exec+0x18 [systemd]<br>        service_spawn.lto_priv.382+0x80 [systemd]<br>        service_start.lto_priv.56+0x144 [systemd]<br>        job_perform_on_unit.lto_priv.422+0x6b4 [systemd]<br>        manager_dispatch_run_queue.lto_priv.589+0x358 [systemd]<br>        source_dispatch+0x118 [libsystemd-shared-241.so]<br>        sd_event_dispatch+0x150 [libsystemd-shared-241.so]<br>        sd_event_run+0x90 [libsystemd-shared-241.so]<br>        invoke_main_loop+0xff4 [systemd]<br>        main+0x1660 [systemd]<br>        [unknown] [libc-2.28.so (deleted)]<br>        [unknown] [systemd]<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">1626</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">unit_create_cgroup</span><span class="hljs-params">( <span class="hljs-comment">// vim src/core/cgroup.c +1626</span></span><br><span class="hljs-params"><span class="hljs-number">1627</span>                 Unit *u,</span><br><span class="hljs-params"><span class="hljs-number">1628</span>                 CGroupMask target_mask,</span><br><span class="hljs-params"><span class="hljs-number">1629</span>                 CGroupMask enable_mask,</span><br><span class="hljs-params"><span class="hljs-number">1630</span>                 ManagerState state)</span> &#123;<br><span class="hljs-number">1631</span> <br><span class="hljs-number">1632</span>         <span class="hljs-type">bool</span> created;<br><span class="hljs-number">1633</span>         <span class="hljs-type">int</span> r;<br><span class="hljs-number">1634</span> <br><span class="hljs-number">1635</span>         assert(u);<br><span class="hljs-number">1636</span> <br><span class="hljs-number">1637</span>         <span class="hljs-keyword">if</span> (!UNIT_HAS_CGROUP_CONTEXT(u))<br><span class="hljs-number">1638</span>                 <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-number">1639</span> <br><span class="hljs-number">1640</span>         <span class="hljs-comment">/* Figure out our cgroup path */</span><br><span class="hljs-number">1641</span>         r = unit_pick_cgroup_path(u);<br><span class="hljs-number">1642</span>         <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br><span class="hljs-number">1643</span>                 <span class="hljs-keyword">return</span> r;<br><span class="hljs-number">1644</span> <br><span class="hljs-number">1645</span>         <span class="hljs-comment">/* First, create our own group */</span><br><span class="hljs-number">1646</span>         r = cg_create_everywhere(u-&gt;manager-&gt;cgroup_supported, target_mask, u-&gt;cgroup_path);<br><span class="hljs-number">1647</span>         <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>)<br><span class="hljs-number">1648</span>                 <span class="hljs-keyword">return</span> log_unit_error_errno(u, r, <span class="hljs-string">&quot;Failed to create cgroup %s: %m&quot;</span>, u-&gt;cgroup_path);<br><span class="hljs-number">1649</span>         created = r;<br></code></pre></td></tr></table></figure>
<h3 id="systemd-log">systemd log</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep -i failed syslog | grep systemd | <span class="hljs-built_in">wc</span> -l<br>146225<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep -i failed syslog | grep systemd | grep .service | grep -v <span class="hljs-string">&quot;Failed to start&quot;</span> &gt; systemd.log<br></code></pre></td></tr></table></figure>
<h4
id="deepin-anything-monitor.service">deepin-anything-monitor.service</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep deepin-anything-monitor.service systemd.log | <span class="hljs-built_in">wc</span> -l<br>835<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl status deepin-anything-monitor.service<br>● deepin-anything-monitor.service - Deepin anything service<br>   Loaded: loaded (/lib/systemd/system/deepin-anything-monitor.service; enabled; vendor preset: enabled)<br>   Active: activating (auto-restart) (Result: exit-code) since Thu 2024-01-25 10:24:27 CST; 2s ago<br>  Process: 19672 ExecStartPre=/usr/sbin/modprobe vfs_monitor (code=exited, status=1/FAILURE)<br>  Process: 19674 ExecStopPost=/usr/sbin/rmmod vfs_monitor (code=exited, status=1/FAILURE)<br></code></pre></td></tr></table></figure>
<h4 id="logrotate.service">logrotate.service</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep logrotate.service systemd.log | <span class="hljs-built_in">wc</span> -l<br>568<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">2024-01-01 00:00:12 0000000g-A8cUta6pu5 systemd[1]:  logrotate.service: Failed with result <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br>2024-01-01 01:00:01 0000000g-A8cUta6pu5 systemd[1]:  logrotate.service: Failed with result <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br>2024-01-01 02:00:01 0000000g-A8cUta6pu5 systemd[1]:  logrotate.service: Failed with result <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br>2024-01-01 03:00:21 0000000g-A8cUta6pu5 systemd[1]:  logrotate.service: Failed with result <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br>2024-01-01 04:00:31 0000000g-A8cUta6pu5 systemd[1]:  logrotate.service: Failed with result <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl status logrotate.service<br>● logrotate.service - Rotate <span class="hljs-built_in">log</span> files<br>   Loaded: loaded (/lib/systemd/system/logrotate.service; static; vendor preset: enabled)<br>   Active: failed (Result: exit-code) since Thu 2024-01-25 09:00:05 CST; 53min ago<br>     Docs: man:logrotate(8)<br>           man:logrotate.conf(5)<br>  Process: 7067 ExecStart=/usr/sbin/logrotate /etc/logrotate.conf (code=exited, status=1/FAILURE)<br> Main PID: 7067 (code=exited, status=1/FAILURE)<br><br>1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: clink-agent:8, unexpected text after &#125;<br>1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: skipping <span class="hljs-string">&quot;/var/log/apt/term.log&quot;</span> because parent directory has insecure permissions (It<span class="hljs-string">&#x27;s world writable or writable by group which is not &quot;root&quot;) Set &quot;su</span><br><span class="hljs-string">1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: skipping &quot;/var/log/apt/history.log&quot; because parent directory has insecure permissions (It&#x27;</span>s world writable or writable by group <span class="hljs-built_in">which</span> is not <span class="hljs-string">&quot;root&quot;</span>) Set <br>1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: skipping <span class="hljs-string">&quot;/var/log/mirror/printer/printer.log&quot;</span> because parent directory has insecure permissions (It<span class="hljs-string">&#x27;s world writable or writable by group which is not &quot;</span><br><span class="hljs-string">1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: skipping &quot;/var/log/cups/access_log&quot; because parent directory has insecure permissions (It&#x27;</span>s world writable or writable by group <span class="hljs-built_in">which</span> is not <span class="hljs-string">&quot;root&quot;</span>) Set <br>1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: skipping <span class="hljs-string">&quot;/var/log/cups/error_log&quot;</span> because parent directory has insecure permissions (It<span class="hljs-string">&#x27;s world writable or writable by group which is not &quot;root&quot;) Set &quot;</span><br><span class="hljs-string">1月 25 09:00:04 0000000g-A8cUta6pu5 logrotate[7067]: error: skipping &quot;/var/log/mirror/ctyunInstall/ctyunInstall.log&quot; because parent directory has insecure permissions (It&#x27;</span>s world writable or writable by group whic<br>1月 25 09:00:05 0000000g-A8cUta6pu5 systemd[1]: logrotate.service: Main process exited, code=exited, status=1/FAILURE<br>1月 25 09:00:05 0000000g-A8cUta6pu5 systemd[1]: logrotate.service: Failed with result <span class="hljs-string">&#x27;exit-code&#x27;</span>.<br>1月 25 09:00:05 0000000g-A8cUta6pu5 systemd[1]: Failed to start Rotate <span class="hljs-built_in">log</span> files.<br></code></pre></td></tr></table></figure>
<h4 id="avahi-daemon.service">avahi-daemon.service</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uptime</span> <br> 10:36:02 up 18:29,  1 user,  load average: 0.18, 0.27, 0.25<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep dbus-org.freedesktop.Avahi.service systemd.log | <span class="hljs-built_in">wc</span> -l<br>143146<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">2024-01-16 05:45:03 0000000g-A8cUta6pu5 dbus-daemon[539]:  [system] Activation via systemd failed <span class="hljs-keyword">for</span> unit <span class="hljs-string">&#x27;dbus-org.freedesktop.Avahi.service&#x27;</span>: Unit dbus-org.freedesktop.Avahi.service not found.<br>2024-01-16 05:45:08 0000000g-A8cUta6pu5 dbus-daemon[539]:  [system] Activation via systemd failed <span class="hljs-keyword">for</span> unit <span class="hljs-string">&#x27;dbus-org.freedesktop.Avahi.service&#x27;</span>: Unit dbus-org.freedesktop.Avahi.service not found.<br>2024-01-16 05:45:13 0000000g-A8cUta6pu5 dbus-daemon[539]:  [system] Activation via systemd failed <span class="hljs-keyword">for</span> unit <span class="hljs-string">&#x27;dbus-org.freedesktop.Avahi.service&#x27;</span>: Unit dbus-org.freedesktop.Avahi.service not found.<br>2024-01-16 05:45:18 0000000g-A8cUta6pu5 dbus-daemon[539]:  [system] Activation via systemd failed <span class="hljs-keyword">for</span> unit <span class="hljs-string">&#x27;dbus-org.freedesktop.Avahi.service&#x27;</span>: Unit dbus-org.freedesktop.Avahi.service not found.<br></code></pre></td></tr></table></figure>
<p>5S重启一次，本次系统启动也就18个半钟头，跑了143146次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">cat</span> avahi-daemon.service<br><span class="hljs-comment"># /lib/systemd/system/avahi-daemon.service</span><br><span class="hljs-comment"># This file is part of avahi.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># avahi is free software; you can redistribute it and/or modify it</span><br><span class="hljs-comment"># under the terms of the GNU Lesser General Public License as</span><br><span class="hljs-comment"># published by the Free Software Foundation; either version 2 of the</span><br><span class="hljs-comment"># License, or (at your option) any later version.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># avahi is distributed in the hope that it will be useful, but WITHOUT</span><br><span class="hljs-comment"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span><br><span class="hljs-comment"># or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public</span><br><span class="hljs-comment"># License for more details.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># You should have received a copy of the GNU Lesser General Public</span><br><span class="hljs-comment"># License along with avahi; if not, write to the Free Software</span><br><span class="hljs-comment"># Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307</span><br><span class="hljs-comment"># USA.</span><br><br>[Unit]<br>Description=Avahi mDNS/DNS-SD Stack<br>Requires=avahi-daemon.socket<br><br>[Service]<br>Type=dbus<br>BusName=org.freedesktop.Avahi<br>ExecStart=/usr/sbin/avahi-daemon -s<br>ExecReload=/usr/sbin/avahi-daemon -r<br>NotifyAccess=main<br><br>[Install]<br>WantedBy=multi-user.target<br>Also=avahi-daemon.socket<br>Alias=dbus-org.freedesktop.Avahi.service<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt show avahi-daemon<br>Package: avahi-daemon<br>Version: 0.7.6-1+dde<br>Priority: optional<br>Section: net<br>Source: avahi<br>Maintainer: Utopia Maintenance Team &lt;pkg-utopia-maintainers@lists.alioth.debian.org&gt;<br>Installed-Size: 263 kB<br>Depends: libavahi-common3 (&gt;= 0.6.16), libavahi-core7 (&gt;= 0.6.24), libc6 (&gt;= 2.27), libcap2 (&gt;= 1:2.10), libdaemon0 (&gt;= 0.14), libdbus-1-3 (&gt;= 1.9.14), libexpat1 (&gt;= 2.0.1), adduser, dbus (&gt;= 0.60), lsb-base (&gt;= 3.0-6), bind9-host | host<br>Recommends: libnss-mdns (&gt;= 0.11)<br>Suggests: avahi-autoipd<br>Homepage: http://avahi.org/<br>Download-Size: 89.4 kB<br>APT-Manual-Installed: no<br>APT-Sources: https://professional-packages.chinauos.com/desktop-professional eagle/main arm64 Packages<br>Description: Avahi mDNS/DNS-SD daemon<br> Avahi is a fully LGPL framework <span class="hljs-keyword">for</span> Multicast DNS Service Discovery.<br> It allows programs to publish and discover services and hosts<br> running on a <span class="hljs-built_in">local</span> network with no specific configuration. For<br> example you can plug into a network and instantly find printers to<br> <span class="hljs-built_in">print</span> to, files to look at and people to talk to.<br> .<br> This package contains the Avahi Daemon <span class="hljs-built_in">which</span> represents your machine<br> on the network and allows other applications to publish and resolve<br> mDNS/DNS-SD records.<br></code></pre></td></tr></table></figure>
<h3 id="解决方案">解决方案</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt reinstall avahi-daemon<br>sudo systemctl daemon-reload<br>sudo systemctl restart avahi-daemon<br></code></pre></td></tr></table></figure>
<h2 id="more">More</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/coreos/bugs/issues/1927">very high
memory usage due to kernfs_node_cache slabs #1927</a>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/systemd/systemd/issues/6567">socket
activation: dentry slab cache keeps increasing #6567</a></li>
</ul></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cae1525ffe5a">cgroup
内存泄露问题排查记录</a>
<ul>
<li><a target="_blank" rel="noopener" href="https://bugzilla.redhat.com/show_bug.cgi?id=1507149">Bug
1507149 - [LLNL 7.5 Bug] slab leak causing a crash when using kmem
control group</a></li>
</ul></li>
<li><a
target="_blank" rel="noopener" href="https://lore.kernel.org/linux-mm/CA+CK2bCQcnTpzq2wGFa3D50PtKwBoWbDBm56S9y8c+j+pD+KSw@mail.gmail.com/t/"
class="uri">https://lore.kernel.org/linux-mm/CA+CK2bCQcnTpzq2wGFa3D50PtKwBoWbDBm56S9y8c+j+pD+KSw@mail.gmail.com/t/</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.archlinux.org/viewtopic.php?id=261924">[Solved]
dbus-org.freedesktop.Avahi.service missing from distribution?</a></li>
</ul>
<h3 id="patch">patch</h3>
<ul>
<li><a
target="_blank" rel="noopener" href="https://blog.csdn.net/kaka__55/article/details/124063773">一个疑似slab泄漏问题排查</a></li>
<li><a
target="_blank" rel="noopener" href="https://lore.kernel.org/lkml/20200422204708.2176080-1-guro@fb.com/t/">[PATCH
v3 01/19] mm: memcg: factor out memcg- and lruvec-level changes out of
__mod_lruvec_state() Roman Gushchin</a></li>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/824216/">The new cgroup slab
memory controller</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg2206757.html">[PATCH
v7 12/19] mm: memcg/slab: use a single set of kmem_caches for all
accounted allocations</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/" class="category-chain-item">kernel</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/bugs/" class="category-chain-item">bugs</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/bugs/memory/" class="category-chain-item">memory</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/kernel/bugs/memory/238303/" class="category-chain-item">238303</a>
  
  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/git/">#git</a>
      
        <a href="/tags/bpf/">#bpf</a>
      
        <a href="/tags/linux/">#linux</a>
      
        <a href="/tags/HTML/">#HTML</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>very high memory usage due to kernfs_node_cache slabs</div>
      <div>https://realwujing.github.io/linux/kernel/bugs/memory/238303/very high memory usage due to kernfs_node_cache slabs/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年7月26日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/linux/kernel/bugs/memory/down_read_trylock/oops%20on%20down_read_trylock%20when%20inode%20use-after-free/" title="oops on down_read_trylock when inode use-after-free">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">oops on down_read_trylock when inode use-after-free</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/kernel/bugs/gpu/234167/Desktop%20Freeze%20on%20UNIS%20D3812%20D2000/" title="Desktop Freeze on UNIS D3812 D2000">
                        <span class="hidden-mobile">Desktop Freeze on UNIS D3812 D2000</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '340df118d54ca06bd1aa74f3763abd3f'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
