

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.jpg">
  <link rel="icon" href="/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wu Jing">
  <meta name="keywords" content="3d, Linux-0.11-yuan-xy, ThreadPool, acpi, algorithm, architect, assembly, baohua, binary-analysis, books, boot, bpf, bugs, ceph, cmake-objdump, console, container, cpp, dbus, deb, debug, deepin, develop, disk, distro, docker, drivers, extern, fluid, fs, gdb, git, go, gpu, grtrace, grub, hello_world, hexo, irq, java, javascript, jenkins, k8s, kdump, kernel, kickstart, kms, kvm, linux, linux-0.11-debug, log, ltp, markdown, minifs, mm, modules, monitoring, mutex, my-project, net, nginx, patent, perf, perf-event, performance, phytium, pkg, port-forward, power, proc, protobuf, protobuf_example, proxy, pthread, pulseaudio, python, qemu, qprocess_wget, qt-learning, rcu, redis, rpm-ostree, runoob-vue3-test, security, shell, sound, sources, stanford-cs336, stap, struct, svn, sync, sysrq_trigger, task, testing, thread, tick, todolist, tools, udl, unixbench, uts_namespace, valgrind, vim, virsh, virt, xisai">
  
    <meta name="description" content="grtrace - GPU Ring Tracegrtrace æ˜¯ GPU Ring Trace çš„ç®€å†™ï¼Œä¸€ä¸ªè½»é‡çº§ GPU è°ƒåº¦è¿½è¸ªæ¡†æ¶ï¼ˆrelayfs + debugfsï¼‰ï¼Œæä¾› submit&#x2F;commit&#x2F;start&#x2F;end&#x2F;complete äº‹ä»¶æµä¸åŸºæœ¬è¿‡æ»¤&#x2F;é™é€Ÿ&#x2F;ç»Ÿè®¡èƒ½åŠ›ï¼›å¯é€šè¿‡ DRM scheduler æ¡¥æ¥è·å¾—é€šç”¨è¦†ç›–ï¼Œä¹Ÿ">
<meta property="og:type" content="article">
<meta property="og:title" content="grtrace - GPU Ring Trace">
<meta property="og:url" content="https://realwujing.github.io/linux/drivers/gpu/grtrace/docs/README/index.html">
<meta property="og:site_name" content="WuJing&#39;s Blog">
<meta property="og:description" content="grtrace - GPU Ring Tracegrtrace æ˜¯ GPU Ring Trace çš„ç®€å†™ï¼Œä¸€ä¸ªè½»é‡çº§ GPU è°ƒåº¦è¿½è¸ªæ¡†æ¶ï¼ˆrelayfs + debugfsï¼‰ï¼Œæä¾› submit&#x2F;commit&#x2F;start&#x2F;end&#x2F;complete äº‹ä»¶æµä¸åŸºæœ¬è¿‡æ»¤&#x2F;é™é€Ÿ&#x2F;ç»Ÿè®¡èƒ½åŠ›ï¼›å¯é€šè¿‡ DRM scheduler æ¡¥æ¥è·å¾—é€šç”¨è¦†ç›–ï¼Œä¹Ÿ">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-12-18T16:59:58.000Z">
<meta property="article:modified_time" content="2025-12-18T16:59:58.000Z">
<meta property="article:author" content="Wu Jing">
<meta property="article:tag" content="3d">
<meta property="article:tag" content="architect">
<meta property="article:tag" content="boot">
<meta property="article:tag" content="bpf">
<meta property="article:tag" content="deb">
<meta property="article:tag" content="debug">
<meta property="article:tag" content="drivers">
<meta property="article:tag" content="fs">
<meta property="article:tag" content="git">
<meta property="article:tag" content="gpu">
<meta property="article:tag" content="kernel">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="log">
<meta property="article:tag" content="perf">
<meta property="article:tag" content="python">
<meta property="article:tag" content="shell">
<meta property="article:tag" content="testing">
<meta property="article:tag" content="tools">
<meta property="article:tag" content="virt">
<meta property="article:tag" content="mm">
<meta property="article:tag" content="struct">
<meta property="article:tag" content="extern">
<meta property="article:tag" content="proc">
<meta property="article:tag" content="modules">
<meta property="article:tag" content="sync">
<meta property="article:tag" content="irq">
<meta property="article:tag" content="grtrace">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>grtrace - GPU Ring Trace - WuJing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"realwujing.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"6b5123e146041483d13bdfaeb6e42a76","google":"UA-265632133-1","gtag":"G-E7BV6T4RCW","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6b5123e146041483d13bdfaeb6e42a76";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-265632133-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  
    <!-- Google gtag.js -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.googletagmanager.com/gtag/js?id=G-E7BV6T4RCW', function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-E7BV6T4RCW');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WuJing&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="grtrace - GPU Ring Trace"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-18 16:59" pubdate>
          2025å¹´12æœˆ18æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          32k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          270 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">grtrace - GPU Ring Trace</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="grtrace-GPU-Ring-Trace"><a href="#grtrace-GPU-Ring-Trace" class="headerlink" title="grtrace - GPU Ring Trace"></a>grtrace - GPU Ring Trace</h1><p><strong>grtrace</strong> æ˜¯ <strong>GPU Ring Trace</strong> çš„ç®€å†™ï¼Œä¸€ä¸ªè½»é‡çº§ GPU è°ƒåº¦è¿½è¸ªæ¡†æ¶ï¼ˆrelayfs + debugfsï¼‰ï¼Œæä¾› submit&#x2F;commit&#x2F;start&#x2F;end&#x2F;complete äº‹ä»¶æµä¸åŸºæœ¬è¿‡æ»¤&#x2F;é™é€Ÿ&#x2F;ç»Ÿè®¡èƒ½åŠ›ï¼›å¯é€šè¿‡ DRM scheduler æ¡¥æ¥è·å¾—é€šç”¨è¦†ç›–ï¼Œä¹Ÿå¯å¯ç”¨å‚å•†é€‚é…ä»¥è·å–æ›´ç²¾ç»†æŒ‡æ ‡ã€‚</p>
<hr>
<h2 id="ğŸš€-å¿«é€Ÿå¼€å§‹"><a href="#ğŸš€-å¿«é€Ÿå¼€å§‹" class="headerlink" title="ğŸš€ å¿«é€Ÿå¼€å§‹"></a>ğŸš€ å¿«é€Ÿå¼€å§‹</h2><h3 id="ç³»ç»Ÿè¦æ±‚"><a href="#ç³»ç»Ÿè¦æ±‚" class="headerlink" title="ç³»ç»Ÿè¦æ±‚"></a>ç³»ç»Ÿè¦æ±‚</h3><p><strong>å†…æ ¸é…ç½®</strong>:</p>
<ul>
<li><code>CONFIG_RELAY=y</code> - Relay æ–‡ä»¶ç³»ç»Ÿ</li>
<li><code>CONFIG_DEBUG_FS=y</code> - Debugfs æ”¯æŒ</li>
<li><code>CONFIG_TRACEPOINTS=y</code> - å†…æ ¸ tracepoint</li>
</ul>
<p><strong>æ”¯æŒçš„ GPU</strong>:</p>
<ul>
<li><strong>Intel</strong>: i915 (<code>CONFIG_GRTRACE_I915</code>)</li>
<li><strong>AMD</strong>: amdgpu (<code>CONFIG_GRTRACE_AMDGPU</code>)</li>
<li><strong>Nouveau</strong>: nouveau (<code>CONFIG_GRTRACE_NOUVEAU</code>)</li>
<li><strong>virtio-gpu</strong>: è™šæ‹ŸGPU (<code>CONFIG_GRTRACE_VIRTIO_GPU</code>)</li>
<li><strong>Generic</strong>: ä»»ä½• DRM scheduler é©±åŠ¨ (<code>CONFIG_GRTRACE_DRM_BRIDGE</code>)</li>
</ul>
<p><strong>æ€§èƒ½å¼€é”€</strong>:</p>
<ul>
<li>ç©ºé—²: ~0% | æ´»è·ƒ: &lt; 1% CPU | å†…å­˜: æ¯CPU ~4MB | å»¶è¿Ÿ: &lt; 1Î¼s&#x2F;äº‹ä»¶</li>
</ul>
<h3 id="æ¨¡å—åˆ—è¡¨"><a href="#æ¨¡å—åˆ—è¡¨" class="headerlink" title="æ¨¡å—åˆ—è¡¨"></a>æ¨¡å—åˆ—è¡¨</h3><table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>æ¨¡å—å</th>
<th>è¯´æ˜</th>
<th>æ˜¯å¦å¿…éœ€</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ ¸å¿ƒ</strong></td>
<td><code>grtrace.ko</code></td>
<td>æ ¸å¿ƒæ¡†æ¶ã€relay bufferã€debugfs æ¥å£</td>
<td>âœ… å¿…éœ€</td>
</tr>
<tr>
<td><strong>GPUé€‚é…å™¨</strong></td>
<td><code>grtrace_drm_bridge.ko</code></td>
<td>DRM scheduler é€šç”¨æ¡¥æ¥ (æ¨è)</td>
<td>â­ æ¨è</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_amdgpu.ko</code></td>
<td>AMD GPU ä¸“ç”¨é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_i915.ko</code></td>
<td>Intel i915 ä¸“ç”¨é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_nouveau.ko</code></td>
<td>Nouveau é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_virtio_gpu.ko</code></td>
<td>VirtIO GPU é€‚é…å™¨ (è™šæ‹ŸåŒ–)</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><strong>å¢å¼ºæ¨¡å—</strong></td>
<td><code>grtrace_aggregator.ko</code></td>
<td>æ—¶é—´çª—å£äº‹ä»¶èšåˆ</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_sampling.ko</code></td>
<td>æ™ºèƒ½é‡‡æ ·é™ä½å¼€é”€</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_filter.ko</code></td>
<td>å¤šç»´åº¦äº‹ä»¶è¿‡æ»¤</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td></td>
<td><code>grtrace_perf_mon.ko</code></td>
<td>æ€§èƒ½ç›‘æ§ç»Ÿè®¡</td>
<td>å¯é€‰</td>
</tr>
</tbody></table>
<h3 id="æ„å»ºã€åŠ è½½ä¸ä½¿ç”¨"><a href="#æ„å»ºã€åŠ è½½ä¸ä½¿ç”¨" class="headerlink" title="æ„å»ºã€åŠ è½½ä¸ä½¿ç”¨"></a>æ„å»ºã€åŠ è½½ä¸ä½¿ç”¨</h3><h4 id="å®Œæ•´å†…æ ¸æºç æ ‘æ„å»º"><a href="#å®Œæ•´å†…æ ¸æºç æ ‘æ„å»º" class="headerlink" title="å®Œæ•´å†…æ ¸æºç æ ‘æ„å»º"></a>å®Œæ•´å†…æ ¸æºç æ ‘æ„å»º</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. é…ç½®å†…æ ¸</span><br><span class="hljs-built_in">cd</span> /path/to/kernel<br>make menuconfig<br><span class="hljs-comment"># å¯¼èˆª: Device Drivers â†’ Graphics support â†’ GPU ring trace (grtrace)</span><br><span class="hljs-comment"># å¯ç”¨: CONFIG_GRTRACE=m, CONFIG_GRTRACE_DRM_BRIDGE=m ç­‰</span><br><br><span class="hljs-comment"># 2. æ„å»ºå¹¶å®‰è£…</span><br>make M=drivers/gpu/grtrace<br>sudo make M=drivers/gpu/grtrace modules_install<br>sudo depmod -a<br><br><span class="hljs-comment"># 3. åŠ è½½æ¨¡å—</span><br>sudo modprobe grtrace  <span class="hljs-comment"># è‡ªåŠ¨åŠ è½½æ‰€æœ‰ä¾èµ–æ¨¡å—</span><br>lsmod | grep grtrace   <span class="hljs-comment"># éªŒè¯</span><br></code></pre></td></tr></table></figure>

<h4 id="kernel-devel-ç‹¬ç«‹æ„å»ºï¼ˆå¼€å‘è°ƒè¯•ï¼‰"><a href="#kernel-devel-ç‹¬ç«‹æ„å»ºï¼ˆå¼€å‘è°ƒè¯•ï¼‰" class="headerlink" title="kernel-devel ç‹¬ç«‹æ„å»ºï¼ˆå¼€å‘è°ƒè¯•ï¼‰"></a>kernel-devel ç‹¬ç«‹æ„å»ºï¼ˆå¼€å‘è°ƒè¯•ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. æ„å»º (ä¸åŒ…æ‹¬ GPU é€‚é…å™¨)</span><br>make -C /lib/modules/$(<span class="hljs-built_in">uname</span> -r)/build M=<span class="hljs-variable">$PWD</span>/drivers/gpu/grtrace<br><br><span class="hljs-comment"># 2. æ¸…ç†æ—§æ¨¡å—ï¼ˆé¿å…å†²çªï¼‰</span><br>sudo find /lib/modules/$(<span class="hljs-built_in">uname</span> -r)/ -name <span class="hljs-string">&quot;grtrace*.ko&quot;</span> -delete<br><br><span class="hljs-comment"># 3. å®‰è£…åˆ° updates ç›®å½•ï¼ˆä¼˜å…ˆçº§é«˜äº kernel ç›®å½•ï¼‰</span><br>sudo make -C /lib/modules/$(<span class="hljs-built_in">uname</span> -r)/build M=<span class="hljs-variable">$PWD</span>/drivers/gpu/grtrace INSTALL_MOD_DIR=updates modules_install<br><br>sudo depmod -a<br><br><span class="hljs-comment"># 4. éªŒè¯å®‰è£…ä½ç½®</span><br>find /lib/modules/$(<span class="hljs-built_in">uname</span> -r)/updates/ -name <span class="hljs-string">&quot;grtrace*.ko&quot;</span> -<span class="hljs-built_in">type</span> f<br><br><span class="hljs-comment"># 5a. ä½¿ç”¨ modprobe åŠ è½½ (æ¨è)</span><br>sudo modprobe grtrace<br><br><span class="hljs-comment"># 5b. æˆ–æ‰‹åŠ¨æŒ‰é¡ºåºåŠ è½½ (å¼€å‘è°ƒè¯•)</span><br>sudo insmod drivers/gpu/grtrace/grtrace.ko<br>sudo insmod drivers/gpu/grtrace/grtrace_aggregator.ko<br>sudo insmod drivers/gpu/grtrace/grtrace_sampling.ko<br>sudo insmod drivers/gpu/grtrace/grtrace_filter.ko<br>sudo insmod drivers/gpu/grtrace/grtrace_perf_mon.ko<br>sudo insmod drivers/gpu/grtrace/grtrace_drm_bridge.ko<br></code></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong>: </p>
<ul>
<li>GPU é€‚é…å™¨éœ€è¦å®Œæ•´å†…æ ¸æºç æ ‘ (ä¾èµ– GPU é©±åŠ¨ tracepoint å¤´æ–‡ä»¶)</li>
<li><code>INSTALL_MOD_DIR=updates</code> å°†æ¨¡å—å®‰è£…åˆ° <code>updates/</code> ç›®å½•ï¼Œè¯¥ç›®å½•ä¼˜å…ˆçº§æœ€é«˜</li>
<li>æ¨¡å—æœç´¢ä¼˜å…ˆçº§: <code>updates/ &gt; extra/ &gt; external/ &gt; built-in/ &gt; weak-updates/</code>ï¼ˆè§ <code>/etc/depmod.d/dist.conf</code>ï¼‰</li>
<li>å®‰è£…å‰å…ˆåˆ é™¤æ—§æ¨¡å—é¿å…å†²çªï¼ˆç³»ç»Ÿå¯èƒ½åŒæ—¶å­˜åœ¨ <code>kernel/</code> å’Œ <code>updates/</code> ä¸¤ä»½ï¼‰</li>
</ul>
<h4 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h4><p><strong>æ–¹å¼ä¸€ï¼šä½¿ç”¨ç”¨æˆ·ç©ºé—´å·¥å…·ï¼ˆæ¨èï¼‰</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /home/wujing/code/ctkernel-lts-6.6-yuanql9-feature-grtrace/tools/grtrace<br><br><span class="hljs-comment"># ç¼–è¯‘å·¥å…·</span><br>make<br><br><span class="hljs-comment"># æµ‹è¯•åŸºæœ¬åŠŸèƒ½</span><br>sudo -s<br><br>./grtrace start<br>./grtrace status<br><br><span class="hljs-comment"># ç”Ÿæˆ GPU äº‹ä»¶</span><br>glxgears &amp;  <span class="hljs-comment"># å¦‚æœæ²¡å®‰è£…: sudo yum install glx-utils</span><br><span class="hljs-built_in">sleep</span> 5<br><br><span class="hljs-comment"># é‡‡é›†å¹¶åˆ†æ</span><br>./grtrace record -o /tmp/trace.dat &amp;<br>RECORD_PID=$!<br><span class="hljs-built_in">sleep</span> 10<br><span class="hljs-built_in">kill</span> <span class="hljs-variable">$RECORD_PID</span><br><br><span class="hljs-comment"># ç”ŸæˆæŠ¥å‘Š</span><br>./grtrace report -i /tmp/trace.dat<br><br><span class="hljs-comment"># æˆ–å®æ—¶åˆ†æ</span><br>./grtrace report  <span class="hljs-comment"># ä» debugfs å®æ—¶è¯»å–</span><br><br><span class="hljs-comment"># åœæ­¢è¿½è¸ª</span><br>./grtrace stop<br></code></pre></td></tr></table></figure>

<p><strong>æ–¹å¼äºŒï¼šç›´æ¥ä½¿ç”¨ debugfs æ¥å£</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /sys/kernel/debug/grtrace/<br><br><span class="hljs-comment"># 1. å¯åŠ¨è¿½è¸ª</span><br><span class="hljs-built_in">echo</span> start &gt; control<br><br><span class="hljs-comment"># 2. é…ç½®å¢å¼ºæ¨¡å—ï¼ˆå¯é€‰ï¼‰</span><br><span class="hljs-built_in">echo</span> 1 &gt; aggregator_enable       <span class="hljs-comment"># å¯ç”¨èšåˆå™¨</span><br><span class="hljs-built_in">echo</span> 1000 &gt; aggregator_window    <span class="hljs-comment"># 1ç§’èšåˆçª—å£</span><br><span class="hljs-built_in">echo</span> static &gt; sampling_mode      <span class="hljs-comment"># é™æ€é‡‡æ ·</span><br><span class="hljs-built_in">echo</span> 25 &gt; sampling_rate          <span class="hljs-comment"># 25% é‡‡æ ·ç‡</span><br><br><span class="hljs-comment"># 3. ç”Ÿæˆ GPU æ´»åŠ¨</span><br>glxgears &amp;<br>GLXGEARS_PID=$!<br><span class="hljs-built_in">sleep</span> 5<br><br><span class="hljs-comment"># 4. æŸ¥çœ‹ç»Ÿè®¡</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=== æ ¸å¿ƒç»Ÿè®¡ ===&quot;</span><br><span class="hljs-built_in">cat</span> stats | <span class="hljs-built_in">head</span> -20<br><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n=== æŒ‰ç±»å‹ç»Ÿè®¡ ===&quot;</span><br><span class="hljs-built_in">cat</span> events_by_type | <span class="hljs-built_in">head</span> -20<br><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n=== èšåˆç»Ÿè®¡ ===&quot;</span><br><span class="hljs-built_in">cat</span> aggregator_stats<br><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n=== é‡‡æ ·ç»Ÿè®¡ ===&quot;</span><br><span class="hljs-built_in">cat</span> sampling_stats<br><br><span class="hljs-comment"># 5. æ¸…ç†</span><br><span class="hljs-built_in">kill</span> <span class="hljs-variable">$GLXGEARS_PID</span><br><span class="hljs-built_in">echo</span> stop &gt; control<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ“–-æ¥å£è¯´æ˜"><a href="#ğŸ“–-æ¥å£è¯´æ˜" class="headerlink" title="ğŸ“– æ¥å£è¯´æ˜"></a>ğŸ“– æ¥å£è¯´æ˜</h2><h3 id="debugfs-æ¥å£"><a href="#debugfs-æ¥å£" class="headerlink" title="debugfs æ¥å£"></a>debugfs æ¥å£</h3><p>æ‰€æœ‰æ§åˆ¶æ¥å£ä½äº <code>/sys/kernel/debug/grtrace/</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># === åŸºæœ¬æ§åˆ¶ ===</span><br><span class="hljs-built_in">echo</span> start &gt; control         <span class="hljs-comment"># å¯ç”¨è¿½è¸ª</span><br><span class="hljs-built_in">echo</span> stop &gt; control          <span class="hljs-comment"># ç¦ç”¨è¿½è¸ª</span><br><span class="hljs-built_in">cat</span> stats                    <span class="hljs-comment"># æŸ¥çœ‹è¿½è¸ªçŠ¶æ€ (enabled=0/1)</span><br><br><span class="hljs-comment"># === é…ç½®å‚æ•° (config æ–‡ä»¶) ===</span><br><span class="hljs-built_in">cat</span> config                   <span class="hljs-comment"># æŸ¥çœ‹æ‰€æœ‰é…ç½®å‚æ•°</span><br><span class="hljs-comment"># é…ç½®å‚æ•°åŒ…æ‹¬:</span><br><span class="hljs-comment">#   level=off|normal|verbose</span><br><span class="hljs-comment">#   sample=0-100 (é‡‡æ ·ç‡ç™¾åˆ†æ¯”)</span><br><span class="hljs-comment">#   max_events_per_sec=N (é€Ÿç‡é™åˆ¶)</span><br><span class="hljs-comment">#   filter_engine_mask=0xN</span><br><span class="hljs-comment">#   filter_ring_id=N</span><br><span class="hljs-comment">#   filter_type_mask=0xN</span><br><span class="hljs-comment">#   watch_count=N (context ç›‘æ§åˆ—è¡¨æ•°é‡)</span><br><span class="hljs-comment">#   watch_ring_count=N (ring ç›‘æ§åˆ—è¡¨æ•°é‡)</span><br><br><span class="hljs-comment"># === é…ç½®ä¿®æ”¹ç¤ºä¾‹ ===</span><br><span class="hljs-comment"># ä¿®æ”¹é‡‡æ ·ç‡</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;sample=50&quot;</span> &gt; config    <span class="hljs-comment"># 50% é‡‡æ ·ç‡</span><br><br><span class="hljs-comment"># ä¿®æ”¹é€Ÿç‡é™åˆ¶</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;max_events_per_sec=1000&quot;</span> &gt; config<br><br><span class="hljs-comment"># ä¿®æ”¹è¿½è¸ªçº§åˆ«</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;level=verbose&quot;</span> &gt; config<br><br><span class="hljs-comment"># === ç»Ÿè®¡ä¿¡æ¯ ===</span><br><span class="hljs-built_in">cat</span> stats                    <span class="hljs-comment"># æŸ¥çœ‹ç»Ÿè®¡ (æ€»äº‹ä»¶æ•°, ä¸¢å¤±æ•°ç­‰)</span><br><span class="hljs-built_in">cat</span> events_by_type           <span class="hljs-comment"># æŒ‰ç±»å‹ç»Ÿè®¡äº‹ä»¶</span><br><span class="hljs-built_in">cat</span> rings                    <span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰å¯ç”¨ rings (å¦‚æœå­˜åœ¨)</span><br><br><span class="hljs-comment"># === äº‹ä»¶è¯»å– (relay buffer, per-CPU) ===</span><br><span class="hljs-comment"># æ³¨æ„: `/sys/kernel/debug/grtrace/events*` æ˜¯äºŒè¿›åˆ¶çš„ relay bufferï¼ˆSTREAM_INFO / METADATA / äº‹ä»¶æµï¼‰ï¼Œ</span><br><span class="hljs-comment"># ä¸æ˜¯å¯ç›´æ¥é˜…è¯»çš„æ–‡æœ¬æ–‡ä»¶ã€‚ç›´æ¥ `cat` ä¼šè¾“å‡ºä¸å¯è¯»çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆçœ‹èµ·æ¥åƒä¹±ç ï¼‰ã€‚</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># æŸ¥çœ‹æˆ–è§£æè¿™äº›æ–‡ä»¶çš„å¸¸ç”¨æ–¹æ³•ï¼š</span><br><br>```bash<br><span class="hljs-comment"># åå…­è¿›åˆ¶/åŸå§‹æŸ¥çœ‹ï¼ˆæ— éœ€è§£æç»“æ„ï¼‰</span><br>xxd /sys/kernel/debug/grtrace/events0 | <span class="hljs-built_in">head</span> -40<br>hexdump -C /sys/kernel/debug/grtrace/events0 | <span class="hljs-built_in">head</span> -40<br><br><span class="hljs-comment"># ä½¿ç”¨å®˜æ–¹/é¡¹ç›®è§£æè„šæœ¬ï¼ˆæ¨èï¼‰ï¼Œå‡è®¾é¡¹ç›®æä¾›äº†è§£æå·¥å…· `tools/grtrace/parse_events.py`</span><br>python3 tools/grtrace/parse_events.py /sys/kernel/debug/grtrace/events0 | <span class="hljs-built_in">head</span> -100<br><br><span class="hljs-comment"># æ³¨æ„ï¼šåœ¨è¿½è¸ªå¤„äºå¯ç”¨çŠ¶æ€æ—¶ï¼Œç›´æ¥è¯»å– per-CPU relay bufferï¼ˆä¾‹å¦‚ `cat events0`ï¼‰ä¼šä»¥é˜»å¡æ¨¡å¼ç­‰å¾…æ•°æ®ï¼Œ</span><br><span class="hljs-comment"># å¦‚æœåªæƒ³å¿«é€ŸæŸ¥çœ‹å½“å‰å†…å®¹ï¼Œå¯å…ˆåœæ­¢è¿½è¸ªå†è¯»å–ï¼Œæˆ–ä½¿ç”¨ `timeout` é™åˆ¶è¯»å–æ—¶é—´ï¼š</span><br><span class="hljs-built_in">timeout</span> 5 <span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events0<br><br><span class="hljs-comment"># è‹¥åªéœ€è¦æ–‡æœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ä½¿ç”¨é¡¹ç›®æä¾›çš„æ±‡æ€»è§†å›¾ï¼š</span><br><span class="hljs-built_in">cat</span> events_by_type    <span class="hljs-comment"># æŒ‰ç±»å‹çš„ç»Ÿè®¡ï¼ˆæ–‡æœ¬ï¼‰</span><br></code></pre></td></tr></table></figure>

<p><strong>é‡è¦æç¤º</strong>: å¦‚æœåˆšå¯åŠ¨è¿½è¸ªè¿˜æœªç”Ÿæˆä»»ä½• GPU äº‹ä»¶,åˆ™:</p>
<ul>
<li><code>events*</code> æ–‡ä»¶å¯èƒ½ä¸ºç©ºæˆ–åªåŒ…å« relay å¤´éƒ¨</li>
<li><code>events_by_type</code> ä¼šè¾“å‡ºç©ºè¡¨  </li>
<li>å„ç»Ÿè®¡æ–‡ä»¶ (<code>stats</code>, <code>aggregator_stats</code>, <code>sampling_stats</code>) ä¼šæ˜¾ç¤ºå…¨ 0 æˆ–ç©ºè¡Œ</li>
</ul>
<p>éœ€è¦è¿è¡Œ GPU åº”ç”¨ï¼ˆå¦‚ <code>glxgears</code>, <code>glmark2</code>, 3D æ¸¸æˆç­‰ï¼‰æ‰èƒ½æ•è·å®é™…äº‹ä»¶ã€‚</p>
<hr>
<h3 id="v1-0-å¢å¼ºæ¨¡å—"><a href="#v1-0-å¢å¼ºæ¨¡å—" class="headerlink" title="v1.0 å¢å¼ºæ¨¡å—"></a>v1.0 å¢å¼ºæ¨¡å—</h3><h4 id="èšåˆå™¨-aggregator"><a href="#èšåˆå™¨-aggregator" class="headerlink" title="èšåˆå™¨ (aggregator)"></a>èšåˆå™¨ (aggregator)</h4><p>æ—¶é—´çª—å£å†…èšåˆäº‹ä»¶ï¼Œå‡å°‘æ•°æ®é‡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /sys/kernel/debug/grtrace/<br><br><span class="hljs-comment"># å¯ç”¨èšåˆ</span><br><span class="hljs-built_in">echo</span> 1 &gt; aggregator_enable<br><br><span class="hljs-comment"># è®¾ç½®æ—¶é—´çª—å£ (100-60000 æ¯«ç§’)</span><br><span class="hljs-built_in">echo</span> 1000 &gt; aggregator_window     <span class="hljs-comment"># 1ç§’çª—å£</span><br><br><span class="hljs-comment"># æŸ¥çœ‹èšåˆç»Ÿè®¡ï¼ˆper-ring è¡¨æ ¼æ ¼å¼ï¼‰</span><br><span class="hljs-built_in">cat</span> aggregator_stats<br><span class="hljs-comment"># è¾“å‡ºæ ¼å¼:</span><br><span class="hljs-comment"># Aggregation Window: 1000 ms</span><br><span class="hljs-comment"># Status: enabled</span><br><span class="hljs-comment"># Ring | Events | Avg Latency | Min Latency | Max Latency | Avg Depth | Peak Depth</span><br><span class="hljs-comment"># </span><br><span class="hljs-comment"># æ³¨æ„: å¦‚æœæ²¡æœ‰ GPU æ´»åŠ¨ï¼Œè¡¨æ ¼ä¸ºç©ºã€‚éœ€è¦å…ˆå¯åŠ¨ grtrace å¹¶ç”Ÿæˆ GPU äº‹ä»¶åæ‰æœ‰æ•°æ®ã€‚</span><br></code></pre></td></tr></table></figure>

<h4 id="é‡‡æ ·å™¨-sampling"><a href="#é‡‡æ ·å™¨-sampling" class="headerlink" title="é‡‡æ ·å™¨ (sampling)"></a>é‡‡æ ·å™¨ (sampling)</h4><p>æ™ºèƒ½é‡‡æ ·ï¼Œé™ä½å¼€é”€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /sys/kernel/debug/grtrace/<br><br><span class="hljs-comment"># è®¾ç½®é‡‡æ ·æ¨¡å¼</span><br><span class="hljs-built_in">echo</span> static &gt; sampling_mode        <span class="hljs-comment"># static/adaptive/threshold</span><br><span class="hljs-built_in">echo</span> adaptive &gt; sampling_mode      <span class="hljs-comment"># æ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªåŠ¨è°ƒæ•´</span><br><br><span class="hljs-comment"># é™æ€é‡‡æ ·ç‡ (ç™¾åˆ†æ¯”)</span><br><span class="hljs-built_in">echo</span> 25 &gt; sampling_rate            <span class="hljs-comment"># é‡‡æ · 25% äº‹ä»¶</span><br><br><span class="hljs-comment"># é˜ˆå€¼é‡‡æ · (åªé‡‡æ ·æ…¢äº‹ä»¶, çº³ç§’)</span><br><span class="hljs-built_in">echo</span> 1000000 &gt; sampling_threshold  <span class="hljs-comment"># åªè¿½è¸ªå»¶è¿Ÿ &gt; 1ms çš„äº‹ä»¶</span><br><br><span class="hljs-comment"># æŸ¥çœ‹é‡‡æ ·ç»Ÿè®¡</span><br><span class="hljs-built_in">cat</span> sampling_stats<br><span class="hljs-comment"># è¾“å‡ºæ ¼å¼:</span><br><span class="hljs-comment"># Sampler mode: static (rate=25%)</span><br><span class="hljs-comment"># Per-ring statistics:</span><br><span class="hljs-comment"># Ring  Total Events  Sampled Events  Sample Rate</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># æ³¨æ„: å¦‚æœæ²¡æœ‰ GPU æ´»åŠ¨ï¼Œç»Ÿè®¡ä¸ºç©ºã€‚éœ€è¦å…ˆå¯åŠ¨ grtrace å¹¶ç”Ÿæˆ GPU äº‹ä»¶åæ‰æœ‰æ•°æ®ã€‚</span><br></code></pre></td></tr></table></figure>

<h4 id="è¿‡æ»¤å™¨-filter"><a href="#è¿‡æ»¤å™¨-filter" class="headerlink" title="è¿‡æ»¤å™¨ (filter)"></a>è¿‡æ»¤å™¨ (filter)</h4><p>å¤šç»´åº¦äº‹ä»¶è¿‡æ»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /sys/kernel/debug/grtrace/<br><br><span class="hljs-comment"># å¯ç”¨è¿‡æ»¤</span><br><span class="hljs-built_in">echo</span> 1 &gt; filter_enabled<br><br><span class="hljs-comment"># PID è¿‡æ»¤ (ç™½åå•)</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1234,5678&quot;</span> &gt; filter_pid     <span class="hljs-comment"># åªè¿½è¸ªè¿™äº›è¿›ç¨‹</span><br><br><span class="hljs-comment"># UID è¿‡æ»¤</span><br><span class="hljs-built_in">echo</span> 1000 &gt; filter_uid            <span class="hljs-comment"># åªè¿½è¸ªæ­¤ç”¨æˆ·</span><br><br><span class="hljs-comment"># å»¶è¿Ÿè¿‡æ»¤ (å¾®ç§’)</span><br><span class="hljs-built_in">echo</span> 500 &gt; filter_latency         <span class="hljs-comment"># åªè¿½è¸ª &gt; 500Î¼s çš„äº‹ä»¶</span><br><br><span class="hljs-comment"># äº‹ä»¶ç±»å‹è¿‡æ»¤ (ä½¿ç”¨åå…­è¿›åˆ¶ä½æ©ç )</span><br><span class="hljs-comment"># æ¯ä¸ªäº‹ä»¶ç±»å‹å¯¹åº”ä¸€ä¸ªä½: SUBMIT=bit0, COMPLETE=bit1, CTX_SWITCH=bit2, ç­‰ç­‰</span><br><span class="hljs-comment"># ä¾‹å¦‚: 0x3 = äºŒè¿›åˆ¶ 11 = SUBMIT + COMPLETE</span><br><span class="hljs-built_in">echo</span> 0x3 &gt; filter_events          <span class="hljs-comment"># åªè¿½è¸ª SUBMIT å’Œ COMPLETE äº‹ä»¶</span><br><span class="hljs-built_in">echo</span> 0xFFFFFFFF &gt; filter_events   <span class="hljs-comment"># è¿½è¸ªæ‰€æœ‰äº‹ä»¶ç±»å‹</span><br><span class="hljs-built_in">cat</span> filter_events                 <span class="hljs-comment"># æŸ¥çœ‹å½“å‰æ©ç </span><br><br><span class="hljs-comment"># æŸ¥çœ‹ç»Ÿè®¡ï¼ˆè¿‡æ»¤ç»Ÿè®¡åœ¨ä¸» stats æ–‡ä»¶ä¸­ï¼‰</span><br><span class="hljs-built_in">cat</span> stats<br></code></pre></td></tr></table></figure>

<h4 id="æ€§èƒ½ç›‘æ§-perf-mon"><a href="#æ€§èƒ½ç›‘æ§-perf-mon" class="headerlink" title="æ€§èƒ½ç›‘æ§ (perf_mon)"></a>æ€§èƒ½ç›‘æ§ (perf_mon)</h4><p>ç³»ç»Ÿçº§æ€§èƒ½æŒ‡æ ‡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹æ€§èƒ½ç›‘æ§æ•°æ®ï¼ˆé€šè¿‡ /proc æ¥å£ï¼‰</span><br><span class="hljs-built_in">cat</span> /proc/grtrace_stats<br><br><span class="hljs-comment"># è¾“å‡ºæ ¼å¼:</span><br><span class="hljs-comment"># ring_id, utilization%, drop_rate%, avg_latency_us</span><br><br><span class="hljs-comment"># æ³¨æ„ï¼šéœ€è¦åŠ è½½ grtrace_perf_mon.ko æ¨¡å—åæ‰ä¼šåˆ›å»ºæ­¤æ–‡ä»¶</span><br></code></pre></td></tr></table></figure>

<h3 id="æ•°æ®è¾“å‡ºæ ¼å¼"><a href="#æ•°æ®è¾“å‡ºæ ¼å¼" class="headerlink" title="æ•°æ®è¾“å‡ºæ ¼å¼"></a>æ•°æ®è¾“å‡ºæ ¼å¼</h3><p><strong>relay buffer</strong> (äºŒè¿›åˆ¶):</p>
<ul>
<li>è·¯å¾„: <code>/sys/kernel/debug/grtrace/events0</code>, <code>events1</code>, â€¦ (per-CPU æ–‡ä»¶)</li>
<li>æ ¼å¼: äºŒè¿›åˆ¶äº‹ä»¶æµ</li>
<li>å·¥å…·: é…åˆ <code>tools/grtrace/</code> è§£æå·¥å…·ä½¿ç”¨</li>
</ul>
<p><strong>events_by_type æ–‡ä»¶</strong> (æ–‡æœ¬):</p>
<ul>
<li>è·¯å¾„: <code>/sys/kernel/debug/grtrace/events_by_type</code></li>
<li>æ ¼å¼: äººç±»å¯è¯»çš„äº‹ä»¶ç»Ÿè®¡è¾“å‡º</li>
<li>ç”¨é€”: å¿«é€ŸæŸ¥çœ‹äº‹ä»¶ç±»å‹åˆ†å¸ƒå’Œè°ƒè¯•</li>
</ul>
<hr>
<h2 id="ğŸ—ï¸-ç³»ç»Ÿæ¶æ„"><a href="#ğŸ—ï¸-ç³»ç»Ÿæ¶æ„" class="headerlink" title="ğŸ—ï¸ ç³»ç»Ÿæ¶æ„"></a>ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</h2><h3 id="æ•´ä½“æ¶æ„æ¦‚è§ˆ"><a href="#æ•´ä½“æ¶æ„æ¦‚è§ˆ" class="headerlink" title="æ•´ä½“æ¶æ„æ¦‚è§ˆ"></a>æ•´ä½“æ¶æ„æ¦‚è§ˆ</h3><p>grtrace é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œç”±<strong>æ ¸å¿ƒæ¨¡å—</strong>ã€<strong>å¢å¼ºæ¨¡å—</strong>å’Œ<strong>GPUé€‚é…å™¨</strong>ä¸‰éƒ¨åˆ†ç»„æˆã€‚</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs tcl">ç”¨æˆ·ç©ºé—´<br>   â”œâ”€â”€ relay buffer è¯»å– (/sys/kernel/debug/grtrace/trace0)<br>   â”œâ”€â”€ æ€§èƒ½ç›‘æ§æŸ¥çœ‹ (/<span class="hljs-keyword">proc</span>/grtrace_stats)<br>   â””â”€â”€ é…ç½®æ¥å£ (debugfs:<span class="hljs-title"> enable/level/sampling/filter/...)</span><br>                              â†“<br>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br>                              â†“<br>å†…æ ¸ç©ºé—´<br>   â”œâ”€â”€ æ ¸å¿ƒæ¨¡å— (grtrace.ko)<br>   â”‚   â”œâ”€â”€ å¯¼å‡ºæ ¸å¿ƒ<span class="hljs-title"> API</span> (EXPORT_SYMBOL_GPL)<br>   â”‚   â”œâ”€â”€<span class="hljs-title"> relay</span> buffer ç®¡ç†<br>   â”‚   â”œâ”€â”€<span class="hljs-title"> debugfs</span> æ¥å£<br>   â”‚   â””â”€â”€ äº‹ä»¶åºåˆ—åŒ–<br>   â”‚<br>   â”œâ”€â”€ å¢å¼ºæ¨¡å— (å¯é€‰)<br>   â”‚   â”œâ”€â”€<span class="hljs-title"> grtrace_aggregator.ko</span>  - æ—¶é—´çª—å£èšåˆ<br>   â”‚   â”œâ”€â”€<span class="hljs-title"> grtrace_sampling.ko</span>    - æ™ºèƒ½é‡‡æ ·<br>   â”‚   â”œâ”€â”€<span class="hljs-title"> grtrace_filter.ko</span>      - å¤šç»´è¿‡æ»¤<br>   â”‚   â””â”€â”€<span class="hljs-title"> grtrace_perf_mon.ko</span>    - æ€§èƒ½ç›‘æ§<br>   â”‚<br>   â””â”€â”€<span class="hljs-title"> GPU</span> é€‚é…å™¨ (æŒ‰éœ€åŠ è½½)<br>       â”œâ”€â”€<span class="hljs-title"> grtrace_drm_bridge.ko</span>  - é€šç”¨<span class="hljs-title"> DRM</span> scheduler (æ¨è)<br>       â”œâ”€â”€<span class="hljs-title"> grtrace_amdgpu.ko</span>      -<span class="hljs-title"> AMD</span> GPU<br>       â”œâ”€â”€<span class="hljs-title"> grtrace_i915.ko</span>        -<span class="hljs-title"> Intel</span> GPU<br>       â”œâ”€â”€<span class="hljs-title"> grtrace_nouveau.ko</span>     -<span class="hljs-title"> Nouveau</span> GPU<br>       â””â”€â”€<span class="hljs-title"> grtrace_virtio_gpu.ko</span>  -<span class="hljs-title"> VirtIO</span> GPU<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="æ ¸å¿ƒæ¨¡å—-grtrace-ko"><a href="#æ ¸å¿ƒæ¨¡å—-grtrace-ko" class="headerlink" title="æ ¸å¿ƒæ¨¡å— (grtrace.ko)"></a>æ ¸å¿ƒæ¨¡å— (grtrace.ko)</h3><p><strong>èŒè´£</strong>: æä¾›åŸºç¡€è¿½è¸ªæ¡†æ¶å’Œæ•°æ®ä¼ è¾“é€šé“</p>
<p><strong>å¯¼å‡ºçš„æ ¸å¿ƒ API</strong> (EXPORT_SYMBOL_GPL):</p>
<ul>
<li><code>grtrace_submit()</code> - ä»»åŠ¡æäº¤äº‹ä»¶</li>
<li><code>grtrace_commit()</code> - ä»»åŠ¡æäº¤åˆ°ç¡¬ä»¶</li>
<li><code>grtrace_start()</code> - ä»»åŠ¡å¼€å§‹æ‰§è¡Œ</li>
<li><code>grtrace_end()</code> - ä»»åŠ¡æ‰§è¡Œç»“æŸ</li>
<li><code>grtrace_complete()</code> - ä»»åŠ¡å®Œæˆ(å«çŠ¶æ€)</li>
<li><code>grtrace_ctx_switch()</code> - ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li><code>grtrace_irq()</code> - ä¸­æ–­äº‹ä»¶</li>
<li><code>grtrace_sync_wait_enter/exit()</code> - åŒæ­¥ç­‰å¾…</li>
<li><code>grtrace_error()</code> - é”™è¯¯äº‹ä»¶</li>
</ul>
<p><strong>æ ¸å¿ƒåŠŸèƒ½</strong>:</p>
<ul>
<li><strong>relay buffer ç®¡ç†</strong>: é€šè¿‡ relayfs ä¼ è¾“æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´</li>
<li><strong>debugfs æ¥å£</strong>: é…ç½®å‚æ•° (enable&#x2F;level&#x2F;trace_ctx&#x2F;â€¦)</li>
<li><strong>äº‹ä»¶åºåˆ—åŒ–</strong>: å°†è¿½è¸ªäº‹ä»¶æ‰“åŒ…ä¸ºäºŒè¿›åˆ¶æµ</li>
<li><strong>Ring buffer ç®¡ç†</strong>: ç®¡ç† GPU ring buffer å…ƒæ•°æ®</li>
<li><strong>ç»Ÿè®¡ä¿¡æ¯</strong>: ç»´æŠ¤è¿½è¸ªç»Ÿè®¡ (<code>/sys/kernel/debug/grtrace/stats</code>)</li>
</ul>
<hr>
<h3 id="å¢å¼ºæ¨¡å—"><a href="#å¢å¼ºæ¨¡å—" class="headerlink" title="å¢å¼ºæ¨¡å—"></a>å¢å¼ºæ¨¡å—</h3><h4 id="1-èšåˆå™¨-grtrace-aggregator-ko"><a href="#1-èšåˆå™¨-grtrace-aggregator-ko" class="headerlink" title="1. èšåˆå™¨ (grtrace_aggregator.ko)"></a>1. èšåˆå™¨ (grtrace_aggregator.ko)</h4><p><strong>åŠŸèƒ½</strong>: æ—¶é—´çª—å£å†…èšåˆäº‹ä»¶ï¼Œå‡å°‘æ•°æ®é‡</p>
<p><strong>é…ç½®</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/debug/grtrace/aggregator_enable      <span class="hljs-comment"># å¯ç”¨èšåˆ</span><br><span class="hljs-built_in">echo</span> 1000 &gt; /sys/kernel/debug/grtrace/aggregator_window   <span class="hljs-comment"># æ—¶é—´çª—å£ (100-60000 ms)</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/stats                       <span class="hljs-comment"># æŸ¥çœ‹èšåˆç»Ÿè®¡</span><br></code></pre></td></tr></table></figure>

<p><strong>è¾“å‡º</strong>: ring_id, event_count, latency(min&#x2F;max&#x2F;avg)_ns, queue_depth</p>
<hr>
<h4 id="2-é‡‡æ ·å™¨-grtrace-sampling-ko"><a href="#2-é‡‡æ ·å™¨-grtrace-sampling-ko" class="headerlink" title="2. é‡‡æ ·å™¨ (grtrace_sampling.ko)"></a>2. é‡‡æ ·å™¨ (grtrace_sampling.ko)</h4><p><strong>åŠŸèƒ½</strong>: æ™ºèƒ½é‡‡æ ·é™ä½è¿½è¸ªå¼€é”€</p>
<p><strong>é‡‡æ ·æ¨¡å¼</strong>:</p>
<ul>
<li><strong>static</strong>: å›ºå®šé‡‡æ ·ç‡</li>
<li><strong>adaptive</strong>: æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´</li>
<li><strong>threshold</strong>: åªè¿½è¸ªè¶…è¿‡é˜ˆå€¼çš„æ…¢äº‹ä»¶</li>
</ul>
<p><strong>é…ç½®</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> static &gt; /sys/kernel/debug/grtrace/sampling_mode        <span class="hljs-comment"># è®¾ç½®æ¨¡å¼</span><br><span class="hljs-built_in">echo</span> 25 &gt; /sys/kernel/debug/grtrace/sampling_rate            <span class="hljs-comment"># é™æ€é‡‡æ ·ç‡ 25%</span><br><span class="hljs-built_in">echo</span> 1000000 &gt; /sys/kernel/debug/grtrace/sampling_threshold  <span class="hljs-comment"># é˜ˆå€¼ 1ms</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/sampling_stats                 <span class="hljs-comment"># æŸ¥çœ‹ç»Ÿè®¡</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="3-è¿‡æ»¤å™¨-grtrace-filter-ko"><a href="#3-è¿‡æ»¤å™¨-grtrace-filter-ko" class="headerlink" title="3. è¿‡æ»¤å™¨ (grtrace_filter.ko)"></a>3. è¿‡æ»¤å™¨ (grtrace_filter.ko)</h4><p><strong>åŠŸèƒ½</strong>: å¤šç»´åº¦äº‹ä»¶è¿‡æ»¤</p>
<p><strong>è¿‡æ»¤ç»´åº¦</strong>:</p>
<ul>
<li>PID ç™½åå•</li>
<li>UID è¿‡æ»¤</li>
<li>å»¶è¿Ÿé˜ˆå€¼</li>
<li>äº‹ä»¶ç±»å‹æ©ç </li>
</ul>
<p><strong>é…ç½®</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/debug/grtrace/filter_enabled               <span class="hljs-comment"># å¯ç”¨è¿‡æ»¤</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1234,5678&quot;</span> &gt; /sys/kernel/debug/grtrace/filter_pid         <span class="hljs-comment"># PID ç™½åå•</span><br><span class="hljs-built_in">echo</span> 1000 &gt; /sys/kernel/debug/grtrace/filter_uid                <span class="hljs-comment"># UID è¿‡æ»¤</span><br><span class="hljs-built_in">echo</span> 500 &gt; /sys/kernel/debug/grtrace/filter_latency             <span class="hljs-comment"># å»¶è¿Ÿé˜ˆå€¼ (Î¼s)</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/filter_stats                      <span class="hljs-comment"># æŸ¥çœ‹ç»Ÿè®¡</span><br></code></pre></td></tr></table></figure>

<hr>
<h4 id="4-æ€§èƒ½ç›‘æ§-grtrace-perf-mon-ko"><a href="#4-æ€§èƒ½ç›‘æ§-grtrace-perf-mon-ko" class="headerlink" title="4. æ€§èƒ½ç›‘æ§ (grtrace_perf_mon.ko)"></a>4. æ€§èƒ½ç›‘æ§ (grtrace_perf_mon.ko)</h4><p><strong>åŠŸèƒ½</strong>: ç³»ç»Ÿçº§æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡</p>
<p><strong>ç›‘æ§æŒ‡æ ‡</strong>:</p>
<ul>
<li>Per-ring åˆ©ç”¨ç‡ (%)</li>
<li>ä¸¢åŒ…ç‡ (%)</li>
<li>å¹³å‡å»¶è¿Ÿ (Î¼s)</li>
</ul>
<p><strong>æŸ¥çœ‹æ–¹å¼</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/grtrace_stats<br><span class="hljs-comment"># è¾“å‡ºæ ¼å¼: ring_id, utilization%, drop_rate%, avg_latency_us</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="GPU-é€‚é…å™¨"><a href="#GPU-é€‚é…å™¨" class="headerlink" title="GPU é€‚é…å™¨"></a>GPU é€‚é…å™¨</h3><h4 id="grtrace-drm-bridge-ko-æ¨è"><a href="#grtrace-drm-bridge-ko-æ¨è" class="headerlink" title="grtrace_drm_bridge.ko (æ¨è)"></a>grtrace_drm_bridge.ko (æ¨è)</h4><p><strong>åŠŸèƒ½</strong>: é€šç”¨ DRM scheduler æ¡¥æ¥é€‚é…å™¨</p>
<p><strong>æ”¯æŒèŒƒå›´</strong>: æ‰€æœ‰ä½¿ç”¨ DRM scheduler çš„ GPU é©±åŠ¨</p>
<p><strong>å®ç°æœºåˆ¶</strong>:</p>
<ul>
<li>é’©ä½ 3 ä¸ª DRM scheduler tracepoint:<ul>
<li><code>drm_sched_job_queue()</code> - ä»»åŠ¡å…¥é˜Ÿ</li>
<li><code>drm_sched_job_run()</code> - ä»»åŠ¡æ‰§è¡Œ</li>
<li><code>drm_sched_job_done()</code> - ä»»åŠ¡å®Œæˆ</li>
</ul>
</li>
<li>æ™ºèƒ½å»é‡é€»è¾‘ (é¿å…ä¸å‚å•†é€‚é…å™¨é‡å¤è¿½è¸ª)</li>
<li>å¼•æ“ç±»å‹æ¨æ–­ (ä» scheduler åç§°)</li>
</ul>
<hr>
<h4 id="grtrace-amdgpu-ko"><a href="#grtrace-amdgpu-ko" class="headerlink" title="grtrace_amdgpu.ko"></a>grtrace_amdgpu.ko</h4><p><strong>ç›®æ ‡</strong>: AMD GPU (amdgpu é©±åŠ¨)</p>
<p><strong>å®ç°</strong>: é’©ä½ <code>amdgpu_sched_run_job</code> tracepoint</p>
<p><strong>è°ƒç”¨ API</strong>: <code>grtrace_start()</code></p>
<hr>
<h4 id="grtrace-i915-ko"><a href="#grtrace-i915-ko" class="headerlink" title="grtrace_i915.ko"></a>grtrace_i915.ko</h4><p><strong>ç›®æ ‡</strong>: Intel GPU (i915 é©±åŠ¨)</p>
<p><strong>å®ç°</strong>: é’©ä½ <code>i915_request_in/out</code> tracepoint</p>
<p><strong>è°ƒç”¨ API</strong>: <code>grtrace_start()</code>, <code>grtrace_end()</code></p>
<hr>
<h4 id="grtrace-nouveau-ko"><a href="#grtrace-nouveau-ko" class="headerlink" title="grtrace_nouveau.ko"></a>grtrace_nouveau.ko</h4><p><strong>ç›®æ ‡</strong>: NVIDIA GPU (nouveau é©±åŠ¨)</p>
<p><strong>å®ç°</strong>: é’©ä½ nouveau fence æœºåˆ¶</p>
<p><strong>è°ƒç”¨ API</strong>: <code>grtrace_submit()</code>, <code>grtrace_complete()</code></p>
<hr>
<h4 id="grtrace-virtio-gpu-ko"><a href="#grtrace-virtio-gpu-ko" class="headerlink" title="grtrace_virtio_gpu.ko"></a>grtrace_virtio_gpu.ko</h4><p><strong>ç›®æ ‡</strong>: VirtIO GPU</p>
<p><strong>å®ç°</strong>: é’©ä½ virtio-gpu cmd queue å’Œ response tracepoint</p>
<p><strong>è°ƒç”¨ API</strong>: <code>grtrace_submit()</code>, <code>grtrace_complete()</code></p>
<hr>
<h3 id="æ•°æ®æµå‘"><a href="#æ•°æ®æµå‘" class="headerlink" title="æ•°æ®æµå‘"></a>æ•°æ®æµå‘</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs scss">GPU ç¡¬ä»¶äº‹ä»¶<br>      â†“<br>GPU é©±åŠ¨ tracepoint<br>      â†“<br>GPU é€‚é…å™¨ (è°ƒç”¨æ ¸å¿ƒ API)<br>      â†“<br>grtrace æ ¸å¿ƒæ¨¡å—<br>      â†“<br>  â”Œâ”€â”€â”€â”´â”€â”€â”€â”<br>  â†“       â†“<br>å¢å¼ºæ¨¡å—   relay buffer<br>(å¯é€‰)      â†“<br>  â†“    ç”¨æˆ·ç©ºé—´å·¥å…·<br>  â””â”€â”€â”€â”€â”€â”€â”€â”˜<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="æ¨¡å—åŠ è½½é¡ºåº"><a href="#æ¨¡å—åŠ è½½é¡ºåº" class="headerlink" title="æ¨¡å—åŠ è½½é¡ºåº"></a>æ¨¡å—åŠ è½½é¡ºåº</h3><h4 id="1-åŠ è½½æ ¸å¿ƒæ¨¡å—"><a href="#1-åŠ è½½æ ¸å¿ƒæ¨¡å—" class="headerlink" title="1. åŠ è½½æ ¸å¿ƒæ¨¡å—"></a>1. åŠ è½½æ ¸å¿ƒæ¨¡å—</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">modprobe grtrace<br><span class="hljs-comment"># æˆ–</span><br>insmod grtrace.ko<br></code></pre></td></tr></table></figure>

<p>åˆ›å»º:</p>
<ul>
<li><code>/sys/kernel/debug/grtrace/</code> (debugfs æ¥å£)</li>
<li>relay buffer (per-CPU)</li>
<li>å¯¼å‡ºæ ¸å¿ƒ API</li>
</ul>
<h4 id="2-å¯é€‰-åŠ è½½å¢å¼ºæ¨¡å—"><a href="#2-å¯é€‰-åŠ è½½å¢å¼ºæ¨¡å—" class="headerlink" title="2. (å¯é€‰) åŠ è½½å¢å¼ºæ¨¡å—"></a>2. (å¯é€‰) åŠ è½½å¢å¼ºæ¨¡å—</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">modprobe grtrace_aggregator  <span class="hljs-comment"># æ—¶é—´çª—å£èšåˆ</span><br>modprobe grtrace_sampling    <span class="hljs-comment"># æ™ºèƒ½é‡‡æ ·</span><br>modprobe grtrace_filter      <span class="hljs-comment"># åŠ¨æ€è¿‡æ»¤</span><br>modprobe grtrace_perf_mon    <span class="hljs-comment"># æ€§èƒ½ç›‘æ§</span><br></code></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ MODULE_SOFTDEP è‡ªåŠ¨åŠ è½½</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">modprobe grtrace  <span class="hljs-comment"># è‡ªåŠ¨åŠ è½½æ‰€æœ‰å¢å¼ºæ¨¡å—</span><br></code></pre></td></tr></table></figure>

<h4 id="3-æŒ‰éœ€-åŠ è½½-GPU-é€‚é…å™¨"><a href="#3-æŒ‰éœ€-åŠ è½½-GPU-é€‚é…å™¨" class="headerlink" title="3. (æŒ‰éœ€) åŠ è½½ GPU é€‚é…å™¨"></a>3. (æŒ‰éœ€) åŠ è½½ GPU é€‚é…å™¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">modprobe grtrace_drm_bridge   <span class="hljs-comment"># é€šç”¨é€‚é…å™¨ (æ¨è)</span><br><span class="hljs-comment"># æˆ–å‚å•†ç‰¹å®šé€‚é…å™¨:</span><br>modprobe grtrace_amdgpu       <span class="hljs-comment"># AMD (éœ€è¦ amdgpu é©±åŠ¨)</span><br>modprobe grtrace_i915         <span class="hljs-comment"># Intel (éœ€è¦ i915 é©±åŠ¨)</span><br>modprobe grtrace_nouveau      <span class="hljs-comment"># Nouveau (éœ€è¦ nouveau é©±åŠ¨)</span><br>modprobe grtrace_virtio_gpu   <span class="hljs-comment"># VirtIO (éœ€è¦ virtio-gpu é©±åŠ¨)</span><br></code></pre></td></tr></table></figure>

<hr>
<h3 id="ç¼–è¯‘é…ç½®é€‰é¡¹"><a href="#ç¼–è¯‘é…ç½®é€‰é¡¹" class="headerlink" title="ç¼–è¯‘é…ç½®é€‰é¡¹"></a>ç¼–è¯‘é…ç½®é€‰é¡¹</h3><table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>è¯´æ˜</th>
<th>æ¨è</th>
</tr>
</thead>
<tbody><tr>
<td><code>CONFIG_GRTRACE=m</code></td>
<td>æ ¸å¿ƒæ¨¡å—</td>
<td>âœ… å¿…éœ€</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_AGGREGATOR=m</code></td>
<td>èšåˆå™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_SAMPLING=m</code></td>
<td>é‡‡æ ·å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_FILTER=m</code></td>
<td>è¿‡æ»¤å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_PERF_MON=m</code></td>
<td>æ€§èƒ½ç›‘æ§</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_DRM_BRIDGE=m</code></td>
<td>DRM æ¡¥æ¥é€‚é…å™¨</td>
<td>â­ æ¨è</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_AMDGPU=m</code></td>
<td>AMD GPU é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_I915=m</code></td>
<td>Intel GPU é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_NOUVEAU=m</code></td>
<td>Nouveau é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>CONFIG_GRTRACE_VIRTIO_GPU=m</code></td>
<td>VirtIO é€‚é…å™¨</td>
<td>å¯é€‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ› ï¸-ç”¨æˆ·ç©ºé—´å·¥å…·"><a href="#ğŸ› ï¸-ç”¨æˆ·ç©ºé—´å·¥å…·" class="headerlink" title="ğŸ› ï¸ ç”¨æˆ·ç©ºé—´å·¥å…·"></a>ğŸ› ï¸ ç”¨æˆ·ç©ºé—´å·¥å…·</h2><p>grtrace æä¾›äº†ä¸€å¥—ç”¨æˆ·ç©ºé—´å·¥å…·ç”¨äºäº‹ä»¶åˆ†æå’Œå¯è§†åŒ–ã€‚ä½äº <code>tools/grtrace/</code> ç›®å½•ã€‚</p>
<h3 id="å·¥å…·æ¦‚è§ˆ"><a href="#å·¥å…·æ¦‚è§ˆ" class="headerlink" title="å·¥å…·æ¦‚è§ˆ"></a>å·¥å…·æ¦‚è§ˆ</h3><h4 id="1-merge-timeline-py-Timeline-Merger-v0-8"><a href="#1-merge-timeline-py-Timeline-Merger-v0-8" class="headerlink" title="1. merge_timeline.py - Timeline Merger (v0.8)"></a>1. merge_timeline.py - Timeline Merger (v0.8)</h4><p><strong>åŠŸèƒ½</strong>:</p>
<ul>
<li><strong>äºŒè¿›åˆ¶ GPU äº‹ä»¶è§£æ</strong>: è§£æ grtrace relay buffer æ ¼å¼çš„æ‰€æœ‰äº‹ä»¶ç±»å‹</li>
<li><strong>æ–‡æœ¬ CPU äº‹ä»¶è§£æ</strong>: è§£æ eBPF annotator æ–‡æœ¬è¾“å‡º</li>
<li><strong>æ—¶é—´çº¿åˆå¹¶</strong>: æŒ‰æ—¶é—´æˆ³æ’åºäº‹ä»¶ï¼Œç”¨äºæ—¶åºåˆ†æ</li>
<li><strong>æ—¶é’Ÿåç§»æ ¡æ­£</strong>: è°ƒæ•´ CPU å’Œ GPU æ—¶é—´æˆ³ä¹‹é—´çš„æ—¶é’Ÿåå·®</li>
<li><strong>ç»Ÿè®¡ä¿¡æ¯</strong>: æä¾›äº‹ä»¶è®¡æ•°ã€æ—¶é—´çº¿æŒç»­æ—¶é—´å’Œäº‹ä»¶é€Ÿç‡</li>
<li><strong>çµæ´»è¾“å‡º</strong>: æ”¯æŒæ ‡å‡†è¾“å‡ºæˆ–æ–‡ä»¶è¾“å‡º</li>
</ul>
<p><strong>åŸºç¡€ç”¨æ³•</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆå¹¶ CPU å’Œ GPU äº‹ä»¶</span><br>python3 merge_timeline.py --cpu cpu_events.txt --gpu gpu_events.bin --output merged.txt<br><br><span class="hljs-comment"># åœ¨æ ‡å‡†è¾“å‡ºæŸ¥çœ‹åˆå¹¶çš„æ—¶é—´çº¿</span><br>python3 merge_timeline.py --cpu cpu_events.txt --gpu gpu_events.bin<br><br><span class="hljs-comment"># ä»…æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</span><br>python3 merge_timeline.py --cpu cpu_events.txt --gpu gpu_events.bin --stats-only<br></code></pre></td></tr></table></figure>

<p><strong>æ—¶é’Ÿåç§»æ ¡æ­£</strong>:<br>å¦‚æœ CPU å’Œ GPU æ—¶é—´æˆ³ä¹‹é—´å­˜åœ¨åå·®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># GPU æ—¶é’Ÿæ¯” CPU æ—¶é’Ÿå¿« 1ms</span><br>python3 merge_timeline.py --cpu cpu_events.txt --gpu gpu_events.bin --clock-offset -1000000<br></code></pre></td></tr></table></figure>

<p><strong>è¾“å…¥æ ¼å¼</strong>:</p>
<p><em>CPU äº‹ä»¶</em> (æ–‡æœ¬æ ¼å¼ï¼Œæ¥è‡ª <code>grtrace-bpf-annotate</code>):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[1234567.123456] IOCTL_ENTER <span class="hljs-attribute">pid</span>=5678 <span class="hljs-attribute">tid</span>=5679 <span class="hljs-attribute">comm</span>=glxgears <span class="hljs-attribute">cmd</span>=0xc0106444 <span class="hljs-attribute">arg</span>=0x7ffc12345678<br>[1234567.123789] IOCTL_EXIT <span class="hljs-attribute">pid</span>=5678 <span class="hljs-attribute">tid</span>=5679 <span class="hljs-attribute">comm</span>=glxgears <span class="hljs-attribute">ret</span>=0 <span class="hljs-attribute">duration_ns</span>=333000<br></code></pre></td></tr></table></figure>

<p><em>GPU äº‹ä»¶</em> (äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¥è‡ª grtrace relay buffer):</p>
<ul>
<li>SUBMIT: ä½œä¸šæäº¤åˆ° GPU</li>
<li>START: ä½œä¸šåœ¨ GPU ä¸Šå¼€å§‹æ‰§è¡Œ</li>
<li>END: ä½œä¸šåœ¨ GPU ä¸Šå®Œæˆæ‰§è¡Œ</li>
<li>COMPLETE: ä½œä¸šå®Œæˆé€šçŸ¥</li>
<li>IRQ: GPU ä¸­æ–­</li>
<li>CTX_SWITCH: GPU ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>SYNC_WAIT_ENTER&#x2F;EXIT: åŒæ­¥ç­‰å¾…</li>
<li>ERROR: GPU é”™è¯¯äº‹ä»¶</li>
</ul>
<p><strong>è¾“å‡ºæ ¼å¼</strong>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># åˆå¹¶çš„ CPU+GPU æ—¶é—´çº¿</span><br><span class="hljs-comment"># æ ¼å¼: [timestamp_sec] SOURCE EVENT_TYPE details...</span><br>[1234567.123456] CPU IOCTL_ENTER          <span class="hljs-attribute">cmd</span>=0xc0106444, <span class="hljs-attribute">arg</span>=0x7ffc12345678<br>[1234567.123789] CPU IOCTL_EXIT           <span class="hljs-attribute">ret</span>=0, <span class="hljs-attribute">duration_ns</span>=333000<br>[1234567.124012] GPU SUBMIT               <span class="hljs-attribute">ctx_id</span>=0x1234, <span class="hljs-attribute">engine</span>=GRAPHICS, <span class="hljs-attribute">ring</span>=0, <span class="hljs-attribute">seqno</span>=42<br>[1234567.124156] GPU START                <span class="hljs-attribute">ctx_id</span>=0x1234, <span class="hljs-attribute">engine</span>=GRAPHICS, <span class="hljs-attribute">ring</span>=0, <span class="hljs-attribute">seqno</span>=42<br>[1234567.125789] GPU END                  <span class="hljs-attribute">ctx_id</span>=0x1234, <span class="hljs-attribute">engine</span>=GRAPHICS, <span class="hljs-attribute">ring</span>=0, <span class="hljs-attribute">seqno</span>=42<br>[1234567.125890] GPU COMPLETE             <span class="hljs-attribute">ctx_id</span>=0x1234, <span class="hljs-attribute">engine</span>=GRAPHICS, <span class="hljs-attribute">ring</span>=0, <span class="hljs-attribute">seqno</span>=42, <span class="hljs-attribute">status</span>=0<br></code></pre></td></tr></table></figure>

<p><strong>æ€§èƒ½æŒ‡æ ‡</strong>:</p>
<ul>
<li>è§£æé€Ÿåº¦: äºŒè¿›åˆ¶ GPU äº‹ä»¶ ~100MB&#x2F;sï¼Œæ–‡æœ¬ CPU äº‹ä»¶ ~50MB&#x2F;s</li>
<li>å†…å­˜ä½¿ç”¨: æ¯ä¸ªäº‹ä»¶ ~1KB (Python å¯¹è±¡å¼€é”€)</li>
<li>æ’åº: O(n log n)ï¼Œå…¶ä¸­ n &#x3D; æ€»äº‹ä»¶æ•°</li>
</ul>
<p><strong>å®Œæ•´å·¥ä½œæµ</strong>:</p>
<ol>
<li><p>æ•è·äº‹ä»¶:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Terminal 1 - å¯åŠ¨ CPU äº‹ä»¶æ•è·</span><br><span class="hljs-built_in">cd</span> tools/grtrace/bpf<br>sudo ./grtrace-bpf-annotate -o cpu_events.txt &amp;<br><br><span class="hljs-comment"># Terminal 2 - å¯åŠ¨ GPU äº‹ä»¶æ•è·</span><br>sudo sh -c <span class="hljs-string">&#x27;echo 1 &gt; /sys/kernel/debug/grtrace/enabled&#x27;</span><br>sudo <span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/trace_pipe &gt; gpu_events.bin &amp;<br><br><span class="hljs-comment"># Terminal 3 - è¿è¡Œå·¥ä½œè´Ÿè½½</span><br>glxgears &amp;<br>GLXGEARS_PID=$!<br><span class="hljs-built_in">sleep</span> 5<br><br><span class="hljs-comment"># åœæ­¢æ•è·</span><br>sudo sh -c <span class="hljs-string">&#x27;echo 0 &gt; /sys/kernel/debug/grtrace/enabled&#x27;</span><br>killall grtrace-bpf-annotate<br>killall <span class="hljs-built_in">cat</span><br><span class="hljs-built_in">kill</span> <span class="hljs-variable">$GLXGEARS_PID</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>åˆå¹¶å’Œåˆ†æ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> tools/grtrace<br><br><span class="hljs-comment"># åˆå¹¶äº‹ä»¶</span><br>python3 merge_timeline.py \<br>    --cpu bpf/cpu_events.txt \<br>    --gpu gpu_events.bin \<br>    --output merged_timeline.txt \<br>    --verbose<br><br><span class="hljs-comment"># æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</span><br>python3 merge_timeline.py \<br>    --cpu bpf/cpu_events.txt \<br>    --gpu gpu_events.bin \<br>    --stats-only<br><br><span class="hljs-comment"># åˆ†æç‰¹å®šæ—¶é—´çª—å£</span><br>awk <span class="hljs-string">&#x27;$1 &gt;= &quot;[1234567.123]&quot; &amp;&amp; $1 &lt;= &quot;[1234567.125]&quot;&#x27;</span> merged_timeline.txt<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-visualize-timeline-py-v0-8-1"><a href="#2-visualize-timeline-py-v0-8-1" class="headerlink" title="2. visualize_timeline.py (v0.8.1)"></a>2. visualize_timeline.py (v0.8.1)</h4><p>æ–‡æœ¬æ¨¡å¼çš„æ—¶é—´çº¿å¯è§†åŒ–å·¥å…·ï¼Œä¸“ä¸ºå†…æ ¸å¼€å‘åœºæ™¯è®¾è®¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®Œæ•´å¯è§†åŒ–</span><br>./visualize_timeline.py merged.txt<br><br><span class="hljs-comment"># ä»…å»¶è¿Ÿåˆ†æ</span><br>./visualize_timeline.py --latency-only merged.txt<br></code></pre></td></tr></table></figure>

<h4 id="3-grtrace-CLI-v0-4-Legacy"><a href="#3-grtrace-CLI-v0-4-Legacy" class="headerlink" title="3. grtrace CLI (v0.4 - Legacy)"></a>3. grtrace CLI (v0.4 - Legacy)</h4><p>åŸºç¡€è¿½è¸ªæ§åˆ¶å’ŒæŠ¥å‘Šå·¥å…·ã€‚</p>
<p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>å¯åŠ¨è¿½è¸ª: <code>grtrace start</code></li>
<li>åœæ­¢è¿½è¸ª: <code>grtrace stop</code></li>
<li>æ˜¾ç¤ºçŠ¶æ€: <code>grtrace status</code></li>
<li>è®°å½•åŸå§‹æµåˆ°æ–‡ä»¶: <code>grtrace record -o data.bin</code> (Ctrl+C åœæ­¢)</li>
<li>ä»æ´»åŠ¨ relay ç”Ÿæˆé˜»å¡æŠ¥å‘Š: <code>grtrace report</code></li>
<li>ä»æ–‡ä»¶ç”ŸæˆæŠ¥å‘Š: <code>grtrace report -i data.bin</code></li>
</ul>
<p>æŠ¥å‘Šåˆ—ï¼ˆæ¯ä¸ªä½œä¸šï¼‰ï¼š</p>
<ul>
<li>ctx, engine, ring, seq</li>
<li>t_queue(ns) &#x3D; START - COMMIT</li>
<li>t_exec(ns) &#x3D; END - START</li>
<li>t_gpu_wait(ns) &#x3D; sum(SYNC_WAIT_EXIT - ENTER)</li>
<li>t_complete(ns) &#x3D; COMPLETE - END</li>
</ul>
<h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul>
<li>éœ€è¦å†…æ ¸ grtrace v0.3+ å’Œ debugfs æŒ‚è½½åœ¨ <code>/sys/kernel/debug</code></li>
<li>è¿™æ˜¯åŸå‹å·¥å…·ï¼›æ¨¡å¼å¯èƒ½åœ¨ v1.0 ä¹‹å‰æ¼”è¿›</li>
</ul>
<h3 id="ç›¸å…³å·¥å…·"><a href="#ç›¸å…³å·¥å…·" class="headerlink" title="ç›¸å…³å·¥å…·"></a>ç›¸å…³å·¥å…·</h3><ul>
<li><strong>grtrace-bpf-annotate</strong>: æ•è· CPU ä¾§ DRM ioctl äº‹ä»¶ï¼ˆè§ <code>tools/grtrace/bpf/</code>ï¼‰</li>
<li><strong>grtrace å†…æ ¸æ¨¡å—</strong>: æ•è· GPU ä¾§äº‹ä»¶ï¼ˆè§ <code>drivers/gpu/grtrace/</code>ï¼‰</li>
<li><strong>perf</strong>: å¯ç”¨äºé¢å¤–çš„ CPU åˆ†æ</li>
<li><strong>trace-cmd</strong>: ftrace å‰ç«¯ï¼Œç”¨äºå†…æ ¸è¿½è¸ª</li>
</ul>
<hr>
<h2 id="ğŸ”¬-eBPF-æ³¨è§£å·¥å…·"><a href="#ğŸ”¬-eBPF-æ³¨è§£å·¥å…·" class="headerlink" title="ğŸ”¬ eBPF æ³¨è§£å·¥å…·"></a>ğŸ”¬ eBPF æ³¨è§£å·¥å…·</h2><p>ä½äº <code>tools/grtrace/bpf/</code> ç›®å½•ï¼Œæä¾› eBPF ç¨‹åºç”¨äºæ³¨è§£ grtrace GPU äº‹ä»¶ä¸è¿›ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<h3 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>eBPF å·¥å…·è§£å†³â€è°æäº¤äº†è¿™ä¸ª GPU ä½œä¸šï¼Ÿâ€çš„é—®é¢˜ï¼š</p>
<ul>
<li>æ•è·å¸¦æ—¶é—´æˆ³çš„ DRM ioctl ç³»ç»Ÿè°ƒç”¨</li>
<li>è®°å½•è¿›ç¨‹ä¿¡æ¯ (PID, TID, è¿›ç¨‹å)</li>
<li>æµ‹é‡ ioctl å»¶è¿Ÿ (ä»ç³»ç»Ÿè°ƒç”¨åˆ° GPU æäº¤çš„æ—¶é—´)</li>
<li>å¯ç”¨ CPU äº‹ä»¶ä¸ GPU äº‹ä»¶çš„å…³è”</li>
</ul>
<h3 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h3><ol>
<li><p><strong>grtrace_annotate.bpf.c</strong> - eBPF å†…æ ¸ç¨‹åº</p>
<ul>
<li>é’©å…¥ <code>sys_enter_ioctl</code> å’Œ <code>sys_exit_ioctl</code> tracepoints</li>
<li>è¿‡æ»¤ DRM ç‰¹å®šçš„ ioctls (å‘½ä»¤ç±»å‹ â€˜dâ€™)</li>
<li>é€šè¿‡ BPF ringbuffer å¯¼å‡ºäº‹ä»¶</li>
</ul>
</li>
<li><p><strong>grtrace_bpf_loader.c</strong> - ç”¨æˆ·ç©ºé—´åŠ è½½å™¨å’Œæ¶ˆè´¹è€…</p>
<ul>
<li>åŠ è½½å¹¶é™„åŠ  eBPF ç¨‹åº</li>
<li>ä» BPF ringbuffer æ¶ˆè´¹äº‹ä»¶</li>
<li>è¾“å‡ºæ³¨è§£æ—¶é—´çº¿ç”¨äºå…³è”</li>
</ul>
</li>
<li><p><strong>Makefile</strong> - æ„å»ºç³»ç»Ÿ</p>
<ul>
<li>ä½¿ç”¨ clang ç¼–è¯‘ eBPF å­—èŠ‚ç </li>
<li>ä½¿ç”¨ libbpf é“¾æ¥ç”¨æˆ·ç©ºé—´åŠ è½½å™¨</li>
</ul>
</li>
</ol>
<h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p><strong>å‰ç½®æ¡ä»¶</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Ubuntu/Debian</span><br>sudo apt-get install clang llvm libbpf-dev linux-headers-$(<span class="hljs-built_in">uname</span> -r)<br><br><span class="hljs-comment"># RHEL/CentOS</span><br>sudo yum install clang llvm libbpf-devel kernel-devel<br></code></pre></td></tr></table></figure>

<p><strong>ç¼–è¯‘</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> tools/grtrace/bpf<br>make check-deps  <span class="hljs-comment"># éªŒè¯ä¾èµ–</span><br>make             <span class="hljs-comment"># æ„å»ºæ‰€æœ‰å†…å®¹</span><br>make install     <span class="hljs-comment"># å¤åˆ¶åˆ° tools/grtrace/</span><br></code></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p><strong>åŸºç¡€ä½¿ç”¨</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo ./grtrace-bpf-annotate<br></code></pre></td></tr></table></figure>

<p><strong>æŒ‰è¿›ç¨‹è¿‡æ»¤</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo ./grtrace-bpf-annotate -p $(pidof glxgears)<br></code></pre></td></tr></table></figure>

<p><strong>ä¿å­˜åˆ°æ–‡ä»¶</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo ./grtrace-bpf-annotate -o drm_events.txt<br></code></pre></td></tr></table></figure>

<h3 id="ä¸-grtrace-é›†æˆ"><a href="#ä¸-grtrace-é›†æˆ" class="headerlink" title="ä¸ grtrace é›†æˆ"></a>ä¸ grtrace é›†æˆ</h3><p><strong>å…³è”å·¥ä½œæµ</strong>:</p>
<ol>
<li><p>å¯åŠ¨ eBPF æ³¨è§£ (æ•è· DRM ioctls):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo ./grtrace-bpf-annotate -o cpu_events.txt &amp;<br></code></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ grtrace (æ•è· GPU äº‹ä»¶):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo grtrace record -o gpu_events.bin &amp;<br></code></pre></td></tr></table></figure>
</li>
<li><p>è¿è¡Œå·¥ä½œè´Ÿè½½:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">glxgears -info<br></code></pre></td></tr></table></figure>
</li>
<li><p>åœæ­¢ä¸¤ä¸ªå·¥å…· (Ctrl-C)</p>
</li>
<li><p>å…³è”äº‹ä»¶:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 merge_timeline.py \<br>    --cpu cpu_events.txt \<br>    --gpu gpu_events.bin \<br>    --output merged_timeline.txt<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="äº‹ä»¶å…³è”"><a href="#äº‹ä»¶å…³è”" class="headerlink" title="äº‹ä»¶å…³è”"></a>äº‹ä»¶å…³è”</h3><p><strong>CPU äº‹ä»¶</strong> (æ¥è‡ª eBPF):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[12.345678900] IOCTL_ENTER <span class="hljs-attribute">pid</span>=1234 <span class="hljs-attribute">tid</span>=1234 <span class="hljs-attribute">comm</span>=glxgears<br></code></pre></td></tr></table></figure>

<p><strong>GPU äº‹ä»¶</strong> (æ¥è‡ª grtrace):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[12.345800000] SUBMIT <span class="hljs-attribute">ctx</span>=0x1234 <span class="hljs-attribute">engine</span>=GRAPHICS <span class="hljs-attribute">ring</span>=0 <span class="hljs-attribute">seq</span>=100<br>[12.345850000] START  <span class="hljs-attribute">ctx</span>=0x1234 <span class="hljs-attribute">engine</span>=GRAPHICS <span class="hljs-attribute">ring</span>=0 <span class="hljs-attribute">seq</span>=100<br>[12.356000000] END    <span class="hljs-attribute">ctx</span>=0x1234 <span class="hljs-attribute">engine</span>=GRAPHICS <span class="hljs-attribute">ring</span>=0 <span class="hljs-attribute">seq</span>=100<br></code></pre></td></tr></table></figure>

<p><strong>åˆå¹¶æ—¶é—´çº¿</strong> (è¾“å‡º):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">12.345678900  [CPU]  glxgears(1234) ioctl_enter<br>12.345800000  [GPU]  <span class="hljs-attribute">ctx</span>=0x1234 submit <span class="hljs-attribute">seq</span>=100  â† 121Î¼s after ioctl<br>12.345850000  [GPU]  <span class="hljs-attribute">ctx</span>=0x1234 start <span class="hljs-attribute">seq</span>=100   â† 50Î¼s<span class="hljs-built_in"> queue </span>wait<br>12.356000000  [GPU]  <span class="hljs-attribute">ctx</span>=0x1234 end <span class="hljs-attribute">seq</span>=100     â† 10.15ms GPU exec<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§ª-æµ‹è¯•æ¡†æ¶"><a href="#ğŸ§ª-æµ‹è¯•æ¡†æ¶" class="headerlink" title="ğŸ§ª æµ‹è¯•æ¡†æ¶"></a>ğŸ§ª æµ‹è¯•æ¡†æ¶</h2><p>Linux å†…æ ¸ selftests ä½äº <code>tools/testing/selftests/grtrace/</code>ã€‚</p>
<h3 id="æµ‹è¯•æ¦‚è§ˆ"><a href="#æµ‹è¯•æ¦‚è§ˆ" class="headerlink" title="æµ‹è¯•æ¦‚è§ˆ"></a>æµ‹è¯•æ¦‚è§ˆ</h3><p>éªŒè¯ grtrace åŠŸèƒ½åŒ…æ‹¬:</p>
<ul>
<li>åŸºç¡€å†’çƒŸæµ‹è¯• (æ¨¡å—åŠ è½½&#x2F;å¸è½½, debugfs æ¥å£)</li>
<li>äº‹ä»¶é‡‡æ ·æœºåˆ¶</li>
<li>é€Ÿç‡é™åˆ¶ (çª—å£å¼å’Œä»¤ç‰Œæ¡¶)</li>
<li>ç›‘è§†åˆ—è¡¨è¿‡æ»¤</li>
</ul>
<h3 id="å‰ç½®æ¡ä»¶"><a href="#å‰ç½®æ¡ä»¶" class="headerlink" title="å‰ç½®æ¡ä»¶"></a>å‰ç½®æ¡ä»¶</h3><p><strong>å†…æ ¸è¦æ±‚</strong>:</p>
<ul>
<li><code>CONFIG_GRTRACE=m</code> æˆ– <code>CONFIG_GRTRACE=y</code></li>
<li><code>CONFIG_DEBUG_FS=y</code></li>
<li><code>CONFIG_RELAY=y</code></li>
<li>Debugfs æŒ‚è½½åœ¨ <code>/sys/kernel/debug</code></li>
</ul>
<p><strong>æ„å»ºè¦æ±‚</strong>:</p>
<ul>
<li>GCC ç¼–è¯‘å™¨</li>
<li>Linux å†…æ ¸å¤´æ–‡ä»¶</li>
<li>Make</li>
</ul>
<h3 id="æ„å»ºæµ‹è¯•"><a href="#æ„å»ºæµ‹è¯•" class="headerlink" title="æ„å»ºæµ‹è¯•"></a>æ„å»ºæµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> tools/testing/selftests/grtrace<br>make<br></code></pre></td></tr></table></figure>

<h3 id="è¿è¡Œæµ‹è¯•"><a href="#è¿è¡Œæµ‹è¯•" class="headerlink" title="è¿è¡Œæµ‹è¯•"></a>è¿è¡Œæµ‹è¯•</h3><p><strong>ç¼–è¯‘æµ‹è¯•</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> tools/testing/selftests/grtrace<br>make<br></code></pre></td></tr></table></figure>

<p><strong>è¿è¡Œæ‰€æœ‰æµ‹è¯•</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># éœ€è¦ root æƒé™ï¼ˆæ¨¡å—æ“ä½œéœ€è¦ï¼‰</span><br>sudo ./grtrace_smoke.sh<br></code></pre></td></tr></table></figure>

<p><strong>è¿è¡Œå•ç‹¬æµ‹è¯•</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å†’çƒŸæµ‹è¯•</span><br>sudo ./grtrace_smoke          <span class="hljs-comment"># åŸºç¡€åŠŸèƒ½éªŒè¯ - åº”è¯¥å®Œå…¨é€šè¿‡</span><br>sudo ./grtrace_smoke.sh       <span class="hljs-comment"># Shell è„šæœ¬éªŒè¯ - åº”è¯¥å®Œå…¨é€šè¿‡</span><br><br><span class="hljs-comment"># é‡‡æ ·æµ‹è¯•</span><br>sudo ./grtrace_sampling       <span class="hljs-comment"># é‡‡æ ·åŠŸèƒ½éªŒè¯ - åº”è¯¥å®Œå…¨é€šè¿‡</span><br><br><span class="hljs-comment"># é€Ÿç‡é™åˆ¶æµ‹è¯•</span><br>sudo ./grtrace_rate_limit     <span class="hljs-comment"># é™é€ŸåŠŸèƒ½éªŒè¯ - é€šè¿‡ä½†æœ‰åŠŸèƒ½æ€§è­¦å‘Š</span><br>sudo ./grtrace_token_bucket   <span class="hljs-comment"># ä»¤ç‰Œæ¡¶éªŒè¯ - é€šè¿‡ä½†æœ‰åŠŸèƒ½æ€§è­¦å‘Š</span><br><br><span class="hljs-comment"># ç›‘è§†åˆ—è¡¨æµ‹è¯•</span><br>sudo ./grtrace_watchlist      <span class="hljs-comment"># è¿‡æ»¤åŠŸèƒ½éªŒè¯ - é€šè¿‡ä½†äº‹ä»¶æ•°å¯èƒ½è¾ƒå°‘</span><br></code></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•ç»“æœè¯´æ˜"><a href="#æµ‹è¯•ç»“æœè¯´æ˜" class="headerlink" title="æµ‹è¯•ç»“æœè¯´æ˜"></a>æµ‹è¯•ç»“æœè¯´æ˜</h3><p>å½“å‰æ‰€æœ‰æµ‹è¯•å‡é€šè¿‡,ä½†éƒ¨åˆ†æµ‹è¯•ä¼šæ˜¾ç¤ºåŠŸèƒ½æ€§è­¦å‘Šä¿¡æ¯:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">âœ… grtrace_smoke         - PASSED (å®Œå…¨é€šè¿‡)<br>âœ… grtrace_smoke.sh      - PASSED (å®Œå…¨é€šè¿‡)<br>âœ… grtrace_sampling      - PASSED (<span class="hljs-keyword">exit</span> <span class="hljs-number">0</span>)<br>âš ï¸  grtrace_rate_limit   - PASSED (åŠŸèƒ½æ€§è­¦å‘Š: <span class="hljs-string">&quot;Rate limiting may not work with emit interface&quot;</span>)<br>âš ï¸  grtrace_token_bucket - PASSED (åŠŸèƒ½æ€§è­¦å‘Š: <span class="hljs-string">&quot;Token bucket may not work with emit interface&quot;</span>)<br>âš ï¸  grtrace_watchlist    - PASSED (äº‹ä»¶æ•°å¯èƒ½ä½äºé¢„æœŸ,emit æ¥å£é™åˆ¶)<br></code></pre></td></tr></table></figure>

<p><strong>å…³äºåŠŸèƒ½æ€§è­¦å‘Šçš„è¯´æ˜</strong>:</p>
<p>è¿™äº›è­¦å‘Šæ˜¯é¢„æœŸçš„,å› ä¸º:</p>
<ol>
<li><strong>Emit æ¥å£é™åˆ¶</strong>: æµ‹è¯•ä½¿ç”¨ <code>debugfs emit</code> æ¥å£ç›´æ¥å†™å…¥äº‹ä»¶,è¯¥æ¥å£ç®€åŒ–äº†äº‹ä»¶æµ,ä¸ä¼šå®Œå…¨ç»è¿‡ç”Ÿäº§ç¯å¢ƒçš„æ‰€æœ‰ä»£ç è·¯å¾„</li>
<li><strong>çœŸå®ç¯å¢ƒä¿è¯</strong>: åœ¨çœŸå®çš„ GPU é©±åŠ¨é›†æˆä¸­(virtio-gpu, i915, amdgpu ç­‰),é€Ÿç‡é™åˆ¶ã€ä»¤ç‰Œæ¡¶å’Œè¿‡æ»¤åŠŸèƒ½éƒ½ä¼šæ­£å¸¸å·¥ä½œ</li>
<li><strong>æµ‹è¯•ç›®çš„</strong>: è¿™äº›æµ‹è¯•ä¸»è¦éªŒè¯æ¥å£å¯ç”¨æ€§å’ŒåŸºç¡€é€»è¾‘,è€Œéå®Œæ•´çš„ç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯</li>
</ol>
<p>å¦‚éœ€å®Œæ•´çš„åŠŸèƒ½éªŒè¯,åº”è¯¥:</p>
<ul>
<li>é›†æˆçœŸå®çš„ GPU é©±åŠ¨äº‹ä»¶æº</li>
<li>è¿è¡Œå®é™…çš„ GPU å·¥ä½œè´Ÿè½½(æ¸²æŸ“ã€è®¡ç®—ç­‰)</li>
<li>éªŒè¯ grtrace æŠ¥å‘Šä¸­çš„äº‹ä»¶ç±»å‹ã€é€Ÿç‡æ§åˆ¶å’Œè¿‡æ»¤æ•ˆæœ</li>
</ul>
<h3 id="æµ‹è¯•æè¿°"><a href="#æµ‹è¯•æè¿°" class="headerlink" title="æµ‹è¯•æè¿°"></a>æµ‹è¯•æè¿°</h3><p><strong>grtrace_smoke</strong>: åŸºç¡€å†’çƒŸæµ‹è¯•éªŒè¯</p>
<ul>
<li>âœ… æ¨¡å—åŠ è½½å’Œå¸è½½</li>
<li>âœ… Debugfs æ¥å£åˆ›å»º (<code>/sys/kernel/debug/grtrace/</code>)</li>
<li>âœ… åŸºæœ¬å¯åŠ¨&#x2F;åœæ­¢æ“ä½œ</li>
<li>âœ… Relay buffer è®¿é—®</li>
<li><strong>çŠ¶æ€</strong>: é€šè¿‡</li>
</ul>
<p><strong>grtrace_smoke.sh</strong>: Shell è„šæœ¬å†’çƒŸæµ‹è¯•</p>
<ul>
<li>âœ… æ§åˆ¶æ¥å£ (start&#x2F;stop)</li>
<li>âœ… Emit æ¥å£åŸºç¡€åŠŸèƒ½</li>
<li>âœ… ç»Ÿè®¡è®¡æ•°å™¨æ›´æ–°</li>
<li><strong>çŠ¶æ€</strong>: é€šè¿‡</li>
</ul>
<p><strong>grtrace_sampling</strong>: æµ‹è¯•äº‹ä»¶é‡‡æ ·æœºåˆ¶</p>
<ul>
<li>âœ… é‡‡æ ·ç‡é…ç½® (sample&#x3D;N)</li>
<li>âœ… äº‹ä»¶é‡‡æ ·éªŒè¯</li>
<li>âœ… ç»Ÿè®¡è®¡æ•°å™¨å‡†ç¡®æ€§</li>
<li><strong>çŠ¶æ€</strong>: é€šè¿‡</li>
</ul>
<p><strong>grtrace_rate_limit</strong>: æµ‹è¯•çª—å£å¼é€Ÿç‡é™åˆ¶</p>
<ul>
<li>âš ï¸ æ¯æ—¶é—´çª—å£çš„äº‹ä»¶é™åˆ¶</li>
<li>âš ï¸ é€Ÿç‡é™åˆ¶è®¡æ•°å™¨</li>
<li><strong>çŠ¶æ€</strong>: é€šè¿‡ (emit æ¥å£é™åˆ¶,åŠŸèƒ½æ€§è­¦å‘Š)</li>
<li><strong>æ³¨æ„</strong>: Emit æ¥å£å¯èƒ½ä¸ä¼šå®Œå…¨è§¦å‘é™é€Ÿé€»è¾‘,çœŸå® GPU é©±åŠ¨ä¼šæ­£å¸¸å·¥ä½œ</li>
</ul>
<p><strong>grtrace_token_bucket</strong>: æµ‹è¯•ä»¤ç‰Œæ¡¶é€Ÿç‡é™åˆ¶</p>
<ul>
<li>âš ï¸ ä»¤ç‰Œæ¡¶ç®—æ³•</li>
<li>âš ï¸ ä»¤ç‰Œé‡å¡«æœºåˆ¶</li>
<li><strong>çŠ¶æ€</strong>: é€šè¿‡ (emit æ¥å£é™åˆ¶,åŠŸèƒ½æ€§è­¦å‘Š)</li>
<li><strong>æ³¨æ„</strong>: Emit æ¥å£å¯èƒ½ä¸ä¼šå®Œå…¨è§¦å‘é™é€Ÿé€»è¾‘,çœŸå® GPU é©±åŠ¨ä¼šæ­£å¸¸å·¥ä½œ</li>
</ul>
<p><strong>grtrace_watchlist</strong>: æµ‹è¯• ring&#x2F;ä½œä¸šè¿‡æ»¤</p>
<ul>
<li>âš ï¸ ç™½åå•&#x2F;é»‘åå•æ¨¡å¼</li>
<li>âš ï¸ Context&#x2F;Ring è¿‡æ»¤</li>
<li><strong>çŠ¶æ€</strong>: é€šè¿‡ (emit æ¥å£é™åˆ¶)</li>
<li><strong>æ³¨æ„</strong>: Emit æ¥å£ç®€åŒ–äº†äº‹ä»¶æµ,çœŸå® GPU é©±åŠ¨ä¼šæä¾›å®Œæ•´çš„è¿‡æ»¤èƒ½åŠ›</li>
</ul>
<h3 id="æµ‹è¯•è¾“å‡ºæ ¼å¼"><a href="#æµ‹è¯•è¾“å‡ºæ ¼å¼" class="headerlink" title="æµ‹è¯•è¾“å‡ºæ ¼å¼"></a>æµ‹è¯•è¾“å‡ºæ ¼å¼</h3><p>æµ‹è¯•ä½¿ç”¨ TAP (Test Anything Protocol) æ ¼å¼:</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap"><span class="hljs-meta">TAP version 13</span><br>1..N<br><span class="hljs-symbol">ok</span><span class="hljs-number"> 1 </span>test_description<br><span class="hljs-symbol">ok</span><span class="hljs-number"> 2 </span>another_test<br><span class="hljs-symbol">not ok</span><span class="hljs-number"> 3 </span>failed_test <span class="hljs-comment"># TODO fix issue</span><br></code></pre></td></tr></table></figure>

<h3 id="å¸¸è§æµ‹è¯•é—®é¢˜"><a href="#å¸¸è§æµ‹è¯•é—®é¢˜" class="headerlink" title="å¸¸è§æµ‹è¯•é—®é¢˜"></a>å¸¸è§æµ‹è¯•é—®é¢˜</h3><p><strong>â€œmodule not foundâ€</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ„å»º grtrace æ¨¡å—</span><br><span class="hljs-built_in">cd</span> /path/to/kernel<br>make M=drivers/gpu/grtrace<br><br><span class="hljs-comment"># å®‰è£…æ¨¡å—</span><br>sudo insmod drivers/gpu/grtrace/grtrace.ko<br></code></pre></td></tr></table></figure>

<p><strong>â€œdebugfs not mountedâ€</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŒ‚è½½ debugfs</span><br>sudo mount -t debugfs none /sys/kernel/debug<br></code></pre></td></tr></table></figure>

<p><strong>â€œPermission deniedâ€</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æµ‹è¯•éœ€è¦ root æƒé™</span><br>sudo ./grtrace_smoke.sh<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="â“-å¸¸è§é—®é¢˜"><a href="#â“-å¸¸è§é—®é¢˜" class="headerlink" title="â“ å¸¸è§é—®é¢˜"></a>â“ å¸¸è§é—®é¢˜</h2><h3 id="é€šç”¨é—®é¢˜"><a href="#é€šç”¨é—®é¢˜" class="headerlink" title="é€šç”¨é—®é¢˜"></a>é€šç”¨é—®é¢˜</h3><p><strong>Q: grtrace æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>A: grtrace æ˜¯ Linux å†…æ ¸çš„è½»é‡çº§ GPU ring è¿½è¸ªå™¨ã€‚è¿½è¸ª GPU ä½œä¸šçš„æäº¤ã€æ‰§è¡Œå’Œå®Œæˆäº‹ä»¶ï¼Œå¼€é”€æå°ï¼Œæä¾› GPU å·¥ä½œè´Ÿè½½è¡Œä¸ºçš„æ´å¯Ÿã€‚</p>
<p><strong>Q: æ”¯æŒå“ªäº› GPUï¼Ÿ</strong></p>
<p>A: grtrace æ”¯æŒå¤šä¸ª GPU å‚å•†ï¼š</p>
<ul>
<li><strong>Intel</strong>: i915 driver (é€šè¿‡ <code>GRTRACE_I915</code>)</li>
<li><strong>AMD</strong>: amdgpu driver (é€šè¿‡ <code>GRTRACE_AMDGPU</code>)</li>
<li><strong>Nouveau</strong>: nouveau driver (é€šè¿‡ <code>GRTRACE_NOUVEAU</code>)</li>
<li><strong>virtio-gpu</strong>: Virtual GPU (é€šè¿‡ <code>GRTRACE_VIRTIO_GPU</code>)</li>
<li><strong>Generic</strong>: ä»»ä½•åŸºäº DRM scheduler çš„é©±åŠ¨ (é€šè¿‡ <code>GRTRACE_DRM_BRIDGE</code>)</li>
</ul>
<p><strong>Q: æ€§èƒ½å¼€é”€æ˜¯å¤šå°‘ï¼Ÿ</strong></p>
<p>A: å¯ç”¨æ—¶å¼€é”€æå°ï¼š</p>
<ul>
<li><strong>ç©ºé—²</strong>: ~0% (æ— äº‹ä»¶ç”Ÿæˆ)</li>
<li><strong>æ´»è·ƒè¿½è¸ª</strong>: &lt; 1% CPU å¼€é”€</li>
<li><strong>å†…å­˜</strong>: æ¯ CPU ~4MB relay buffers (å¯é…ç½®)</li>
<li><strong>å»¶è¿Ÿ</strong>: æ¯äº‹ä»¶ &lt; 1Î¼s</li>
</ul>
<p>ä½¿ç”¨é‡‡æ ·å’Œé€Ÿç‡é™åˆ¶å¯è¿›ä¸€æ­¥é™ä½å¼€é”€ã€‚</p>
<p><strong>Q: å¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ</strong></p>
<p>A: æ˜¯çš„ï¼Œgrtrace ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡ï¼š</p>
<ul>
<li>æ„å»ºä¸ºå†…æ ¸æ¨¡å— (æ— éœ€é‡å»ºå†…æ ¸)</li>
<li>è¿è¡Œæ—¶å¯ç”¨&#x2F;ç¦ç”¨ï¼Œæ— éœ€é‡å¯</li>
<li>å¯é…ç½®é‡‡æ ·å’Œé€Ÿç‡é™åˆ¶</li>
<li>æ€§èƒ½å½±å“æå° (&lt; 1% CPU)</li>
<li>æ— éœ€ä¿®æ”¹ GPU é©±åŠ¨</li>
</ul>
<p><strong>Q: grtrace ä¸ perf&#x2F;ftrace çš„åŒºåˆ«ï¼Ÿ</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>grtrace</th>
<th>perf&#x2F;ftrace</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç„¦ç‚¹</strong></td>
<td>GPU ç‰¹å®šäº‹ä»¶</td>
<td>é€šç”¨è¿½è¸ª</td>
</tr>
<tr>
<td><strong>å¼€é”€</strong></td>
<td>GPU ä¼˜åŒ–</td>
<td>é€šç”¨ç›®çš„</td>
</tr>
<tr>
<td><strong>äº‹ä»¶æ ¼å¼</strong></td>
<td>GPU ä½œä¸šç”Ÿå‘½å‘¨æœŸ</td>
<td>é€šç”¨äº‹ä»¶</td>
</tr>
<tr>
<td><strong>é›†æˆ</strong></td>
<td>ä¸ perf&#x2F;ftrace ååŒ</td>
<td>ç‹¬ç«‹ä½¿ç”¨</td>
</tr>
<tr>
<td><strong>ç”¨ä¾‹</strong></td>
<td>GPU æ€§èƒ½åˆ†æ</td>
<td>ç³»ç»Ÿçº§è¿½è¸ª</td>
</tr>
</tbody></table>
<p>ä½¿ç”¨ grtrace è¿›è¡Œ GPU èšç„¦åˆ†æï¼Œç»“åˆ perf è¿›è¡Œ CPU+GPU å…³è”ã€‚</p>
<h3 id="ä½¿ç”¨æŠ€å·§"><a href="#ä½¿ç”¨æŠ€å·§" class="headerlink" title="ä½¿ç”¨æŠ€å·§"></a>ä½¿ç”¨æŠ€å·§</h3><p><strong>Q: å¦‚ä½•å‡å°‘å¼€é”€ï¼Ÿ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é‡‡æ · 10% çš„äº‹ä»¶</span><br><span class="hljs-built_in">echo</span> 10 &gt; /sys/kernel/debug/grtrace/sampling<br><br><span class="hljs-comment"># é€Ÿç‡é™åˆ¶åˆ° 1000 events/sec</span><br><span class="hljs-built_in">echo</span> 1000 &gt; /sys/kernel/debug/grtrace/rate_limit<br><br><span class="hljs-comment"># ä½¿ç”¨ token bucket å®¹å¿çªå‘</span><br><span class="hljs-built_in">echo</span> token_bucket &gt; /sys/kernel/debug/grtrace/rate_limit_mode<br><span class="hljs-built_in">echo</span> 5000 &gt; /sys/kernel/debug/grtrace/rate_limit<br><span class="hljs-built_in">echo</span> 10000 &gt; /sys/kernel/debug/grtrace/rate_limit_burst<br></code></pre></td></tr></table></figure>

<p><strong>Q: åªè¿½è¸ªç‰¹å®š GPU ringï¼Ÿ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ—å‡ºå¯ç”¨ rings</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/rings<br><br><span class="hljs-comment"># ç™½åå•: åªè¿½è¸ª ring 0,1</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;0,1&quot;</span> &gt; /sys/kernel/debug/grtrace/watchlist<br><br><span class="hljs-comment"># é»‘åå•: æ’é™¤ ring 2</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;!2&quot;</span> &gt; /sys/kernel/debug/grtrace/watchlist<br></code></pre></td></tr></table></figure>

<p><strong>Q: grtrace ä½¿ç”¨å¤šå°‘å†…å­˜ï¼Ÿ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ buffer å¤§å° (per-CPU)</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/buffer_size<br><span class="hljs-comment"># å…¸å‹: 4194304 (4MB)</span><br><br><span class="hljs-comment"># è°ƒæ•´å¤§å°</span><br><span class="hljs-built_in">echo</span> 1048576 &gt; /sys/kernel/debug/grtrace/buffer_size  <span class="hljs-comment"># 1MB per CPU</span><br><br><span class="hljs-comment"># æ€»å†…å­˜ = buffer_size Ã— num_CPUs</span><br></code></pre></td></tr></table></figure>

<p><strong>Q: å½±å“ GPU æ€§èƒ½å—ï¼Ÿ</strong></p>
<p>A: ä¸å½±å“ GPU æ‰§è¡Œï¼š</p>
<ul>
<li>äº‹ä»¶åœ¨å†…æ ¸ä¸­æ•è·ï¼Œé GPU</li>
<li>æ—  GPU å¯„å­˜å™¨è®¿é—®æˆ–ä¸­æ–­</li>
<li>GPU ä½œä¸šæ­£å¸¸æ‰§è¡Œ</li>
<li>ä»… CPU ç«¯ç°¿è®°å¼€é”€</li>
</ul>
<hr>
<h2 id="ğŸ”-æ•…éšœæ’æŸ¥"><a href="#ğŸ”-æ•…éšœæ’æŸ¥" class="headerlink" title="ğŸ” æ•…éšœæ’æŸ¥"></a>ğŸ” æ•…éšœæ’æŸ¥</h2><h3 id="å®‰è£…é—®é¢˜"><a href="#å®‰è£…é—®é¢˜" class="headerlink" title="å®‰è£…é—®é¢˜"></a>å®‰è£…é—®é¢˜</h3><p><strong>é—®é¢˜: <code>make: *** No rule to make target &#39;grtrace&#39;</code></strong></p>
<p><em>åŸå› </em>: grtrace æœªåœ¨å†…æ ¸ä¸­é…ç½®ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åœ¨å†…æ ¸é…ç½®ä¸­å¯ç”¨ grtrace</span><br><span class="hljs-built_in">cd</span> /path/to/kernel<br>make menuconfig<br><br><span class="hljs-comment"># å¯¼èˆªåˆ°:</span><br><span class="hljs-comment"># Device Drivers â†’ Graphics support â†’ GPU ring trace (grtrace)</span><br><span class="hljs-comment"># å¯ç”¨: GRTRACE, GRTRACE_DRM_BRIDGE, GRTRACE_&lt;vendor&gt;</span><br><br><span class="hljs-comment"># æ„å»ºæ¨¡å—</span><br>make M=drivers/gpu/grtrace<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: <code>ERROR: modpost: missing MODULE_LICENSE()</code></strong></p>
<p><em>åŸå› </em>: å†…æ ¸ç‰ˆæœ¬ä¸åŒ¹é…æˆ–æ„å»ºç³»ç»Ÿé—®é¢˜ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ¸…ç†æ„å»º</span><br>make M=drivers/gpu/grtrace clean<br>make M=drivers/gpu/grtrace<br><br><span class="hljs-comment"># éªŒè¯æ¨¡å—ä¿¡æ¯</span><br>modinfo drivers/gpu/grtrace/grtrace.ko<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: <code>insmod: ERROR: could not insert module: Invalid parameters</code></strong></p>
<p><em>åŸå› </em>: ç¼ºå°‘æ¨¡å—ä¾èµ– (relay, debugfs)ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥å†…æ ¸é…ç½®</span><br>grep -E <span class="hljs-string">&quot;CONFIG_(RELAY|DEBUG_FS)&quot;</span> /boot/config-$(<span class="hljs-built_in">uname</span> -r)<br><br><span class="hljs-comment"># åº”è¯¥çœ‹åˆ°:</span><br><span class="hljs-comment"># CONFIG_RELAY=y</span><br><span class="hljs-comment"># CONFIG_DEBUG_FS=y</span><br><br><span class="hljs-comment"># å¦‚æ²¡æœ‰ï¼Œéœ€é‡å»ºå†…æ ¸å¯ç”¨è¿™äº›é€‰é¡¹</span><br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: <code>modprobe: FATAL: Module grtrace not found</code></strong></p>
<p><em>åŸå› </em>: æ¨¡å—æœªå®‰è£…åœ¨ <code>/lib/modules/</code>ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…æ¨¡å—</span><br>sudo make M=drivers/gpu/grtrace modules_install<br>sudo depmod -a<br><br><span class="hljs-comment"># æˆ–ç›´æ¥åŠ è½½</span><br>sudo insmod drivers/gpu/grtrace/grtrace.ko<br></code></pre></td></tr></table></figure>

<h3 id="è¿è¡Œæ—¶é—®é¢˜"><a href="#è¿è¡Œæ—¶é—®é¢˜" class="headerlink" title="è¿è¡Œæ—¶é—®é¢˜"></a>è¿è¡Œæ—¶é—®é¢˜</h3><p><strong>é—®é¢˜: <code>/sys/kernel/debug/grtrace</code> ä¸å­˜åœ¨</strong></p>
<p><em>åŸå› </em>: debugfs æœªæŒ‚è½½æˆ– grtrace æ¨¡å—æœªåŠ è½½ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ debugfs æŒ‚è½½</span><br>mount | grep debugfs<br><span class="hljs-comment"># å¦‚æœªæŒ‚è½½:</span><br>sudo mount -t debugfs none /sys/kernel/debug<br><br><span class="hljs-comment"># åŠ è½½ grtrace æ¨¡å—</span><br>sudo modprobe grtrace<br><br><span class="hljs-comment"># éªŒè¯</span><br><span class="hljs-built_in">ls</span> /sys/kernel/debug/grtrace/<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: <code>echo start &gt; control</code> å¤±è´¥ï¼ŒæŠ¥ â€œPermission deniedâ€</strong></p>
<p><em>åŸå› </em>: æœªä»¥ root è¿è¡Œæˆ– SELinux ç­–ç•¥é˜»æ­¢ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä½¿ç”¨ sudo</span><br>sudo sh -c <span class="hljs-string">&#x27;echo start &gt; /sys/kernel/debug/grtrace/control&#x27;</span><br><br><span class="hljs-comment"># æˆ–ä¸´æ—¶ç¦ç”¨ SELinuxï¼ˆä¸æ¨èç”¨äºç”Ÿäº§ï¼‰</span><br>sudo setenforce 0<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: å°½ç®¡æœ‰ GPU æ´»åŠ¨ä½†æ²¡æœ‰æ•è·äº‹ä»¶</strong></p>
<p><em>å¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆ</em>:</p>
<p><strong>1. å‚å•†é€‚é…å™¨æœªåŠ è½½</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥å·²åŠ è½½æ¨¡å—</span><br>lsmod | grep grtrace<br><br><span class="hljs-comment"># åº”çœ‹åˆ°å‚å•†ç‰¹å®šæ¨¡å—:</span><br><span class="hljs-comment"># grtrace_i915, grtrace_amdgpu, grtrace_nouveau, æˆ– grtrace_virtio_gpu</span><br><br><span class="hljs-comment"># åŠ è½½å‚å•†é€‚é…å™¨</span><br>sudo modprobe grtrace_i915  <span class="hljs-comment"># æˆ– grtrace_amdgpu ç­‰</span><br></code></pre></td></tr></table></figure>

<p><strong>2. Tracepoints æœªå¯¼å‡º</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ tracepoints æ˜¯å¦å¯ç”¨</span><br>perf list | grep -E <span class="hljs-string">&quot;drm:|i915:|amdgpu:&quot;</span><br><br><span class="hljs-comment"># å¦‚ç¼ºå¤±ï¼Œå‚å•†é©±åŠ¨å¯èƒ½æœªå¯¼å‡º tracepoints</span><br><span class="hljs-comment"># ä½¿ç”¨ GRTRACE_DRM_BRIDGE ä½œä¸ºåå¤‡</span><br>sudo modprobe grtrace_drm_bridge<br></code></pre></td></tr></table></figure>

<p><strong>3. GPU æœªæ¿€æ´»</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç”Ÿæˆ GPU æ´»åŠ¨</span><br>glxgears &amp;<br><span class="hljs-built_in">sleep</span> 5<br><br><span class="hljs-comment"># æ£€æŸ¥äº‹ä»¶ (per-CPU relay buffer)</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events0 | <span class="hljs-built_in">head</span> -20<br><span class="hljs-comment"># æˆ–æŸ¥çœ‹äº‹ä»¶ç»Ÿè®¡</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events_by_type<br></code></pre></td></tr></table></figure>

<p><strong>4. é‡‡æ ·ç‡è¿‡ä½</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥é‡‡æ ·ç‡</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/sampling<br><br><span class="hljs-comment"># å¢åŠ åˆ° 100% (æ— é‡‡æ ·)</span><br><span class="hljs-built_in">echo</span> 100 &gt; /sys/kernel/debug/grtrace/sampling<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: <code>cat /sys/kernel/debug/grtrace/events0</code> æŒ‚èµ·</strong></p>
<p><em>åŸå› </em>: ä»¥é˜»å¡æ¨¡å¼ä»æ´»åŠ¨ relay buffer è¯»å–ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å…ˆåœæ­¢è¿½è¸ª</span><br><span class="hljs-built_in">echo</span> stop &gt; /sys/kernel/debug/grtrace/control<br><br><span class="hljs-comment"># ç„¶åè¯»å–äº‹ä»¶</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events0<br><br><span class="hljs-comment"># æˆ–ä½¿ç”¨éé˜»å¡è¯»å–</span><br><span class="hljs-built_in">timeout</span> 5 <span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events0<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: äº‹ä»¶æ˜¾ç¤º â€œUNKNOWNâ€ ring åç§°</strong></p>
<p><em>åŸå› </em>: å‚å•†çš„ ring åç§°æ˜ å°„ä¸å¯ç”¨ã€‚</p>
<p><em>å½±å“</em>: äº‹ä»¶æ­£ç¡®æ•è·ï¼Œä½† ring åç§°æ˜¾ç¤ºä¸ºæ•°å­— IDã€‚</p>
<p><em>è§£å†³æ–¹æ¡ˆ</em>: ä½¿ç”¨ <code>grtrace_drm_bridge</code> (åŒ…å« ring åç§°è§£æ) æˆ–å‘å‚å•†é€‚é…å™¨æ·»åŠ æ˜ å°„ã€‚</p>
<h3 id="é›†æˆé—®é¢˜"><a href="#é›†æˆé—®é¢˜" class="headerlink" title="é›†æˆé—®é¢˜"></a>é›†æˆé—®é¢˜</h3><p><strong>é—®é¢˜: perf ä¸æ˜¾ç¤º grtrace äº‹ä»¶</strong></p>
<p><em>åŸå› </em>: Tracepoints æœªæ­£ç¡®å¯¼å‡ºã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># éªŒè¯ tracepoint å¯¼å‡º</span><br>perf list | grep drm<br><br><span class="hljs-comment"># åº”è¯¥çœ‹åˆ°:</span><br><span class="hljs-comment">#   drm:drm_sched_job</span><br><span class="hljs-comment">#   drm:drm_run_job</span><br><span class="hljs-comment">#   drm:drm_sched_process_job</span><br><br><span class="hljs-comment"># å¦‚ç¼ºå¤±ï¼Œæ£€æŸ¥å†…æ ¸æ¨¡å—</span><br>dmesg | grep <span class="hljs-string">&quot;EXPORT_TRACEPOINT_SYMBOL_GPL&quot;</span><br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: ç»“åˆ grtrace å’Œ eBPF å·¥å…·å¤±è´¥</strong></p>
<p><em>åŸå› </em>: eBPF ç¨‹åºé™„åŠ æ—¶åºé—®é¢˜ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å…ˆåŠ è½½ grtrace</span><br>sudo modprobe grtrace<br>sudo modprobe grtrace_drm_bridge<br><br><span class="hljs-comment"># ç­‰å¾…åˆå§‹åŒ–</span><br><span class="hljs-built_in">sleep</span> 1<br><br><span class="hljs-comment"># ç„¶åé™„åŠ  eBPF ç¨‹åº</span><br>sudo ./grtrace_bpf_loader<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: äº‹ä»¶æ—¶é—´æˆ³ä¸ perf æ—¶é—´æˆ³ä¸åŒ¹é…</strong></p>
<p><em>åŸå› </em>: ä¸åŒçš„æ—¶é’Ÿæº (CLOCK_MONOTONIC vs. CLOCK_BOOTTIME)ã€‚</p>
<p><em>è§£å†³</em>: ä½¿ç”¨ä¸€è‡´çš„æ—¶é’Ÿæº:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># grtrace é»˜è®¤ä½¿ç”¨ CLOCK_MONOTONIC</span><br><span class="hljs-comment"># å°† perf åŒ¹é…åˆ°åŒä¸€æ—¶é’Ÿ</span><br>perf record --clockid monotonic -e drm:drm_sched_job<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: <code>merge_timeline.py</code> å¤±è´¥ï¼ŒæŠ¥ â€œformat mismatchâ€</strong></p>
<p><em>åŸå› </em>: äº‹ä»¶æ ¼å¼ç‰ˆæœ¬ä¸å…¼å®¹ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ grtrace ç‰ˆæœ¬</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/version<br><br><span class="hljs-comment"># æ›´æ–°å·¥å…·ä»¥åŒ¹é…å†…æ ¸ç‰ˆæœ¬</span><br><span class="hljs-built_in">cd</span> tools/grtrace<br>git pull  <span class="hljs-comment"># æˆ–å¤åˆ¶æœ€æ–°ç‰ˆæœ¬</span><br></code></pre></td></tr></table></figure>

<h3 id="æ€§èƒ½é—®é¢˜"><a href="#æ€§èƒ½é—®é¢˜" class="headerlink" title="æ€§èƒ½é—®é¢˜"></a>æ€§èƒ½é—®é¢˜</h3><p><strong>é—®é¢˜: grtrace å¯¼è‡´æ˜æ˜¾çš„æ€§èƒ½ä¸‹é™</strong></p>
<p><em>è¯Šæ–­</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ†æ grtrace å¼€é”€</span><br>perf record -e cpu-clock -g ./workload<br>perf report | grep grtrace<br><br><span class="hljs-comment"># å¦‚å¼€é”€ &gt; 1%ï¼Œæ£€æŸ¥:</span><br><span class="hljs-comment"># - é‡‡æ ·ç‡ (å¦‚æœè¿‡é«˜åˆ™é™ä½)</span><br><span class="hljs-comment"># - é€Ÿç‡é™åˆ¶ (å¦‚æœç¦ç”¨åˆ™å¯ç”¨)</span><br><span class="hljs-comment"># - äº‹ä»¶é‡ (ä½¿ç”¨ watchlist è¿‡æ»¤)</span><br></code></pre></td></tr></table></figure>

<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é™ä½é‡‡æ ·ç‡</span><br><span class="hljs-built_in">echo</span> 10 &gt; /sys/kernel/debug/grtrace/sampling  <span class="hljs-comment"># 10% é‡‡æ ·</span><br><br><span class="hljs-comment"># å¯ç”¨é€Ÿç‡é™åˆ¶</span><br><span class="hljs-built_in">echo</span> 1000 &gt; /sys/kernel/debug/grtrace/rate_limit  <span class="hljs-comment"># 1000 events/s</span><br><br><span class="hljs-comment"># è¿‡æ»¤ç‰¹å®š rings</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;0,1&quot;</span> &gt; /sys/kernel/debug/grtrace/watchlist  <span class="hljs-comment"># åªè¿½è¸ªå…³é”® rings</span><br><br><span class="hljs-comment"># å¯ç”¨èšåˆ</span><br><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/debug/grtrace/aggregator_enable<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: Buffer æº¢å‡º&#x2F;äº‹ä»¶ä¸¢å¤±</strong></p>
<p><em>è¯Šæ–­</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ relay buffer ç»Ÿè®¡</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/stats<br><br><span class="hljs-comment"># å…³æ³¨æŒ‡æ ‡:</span><br><span class="hljs-comment"># - overruns: Buffer æ»¡ï¼Œäº‹ä»¶ä¸¢å¼ƒ</span><br><span class="hljs-comment"># - lost_events: ä¸¢å¤±äº‹ä»¶è®¡æ•°</span><br><span class="hljs-comment"># - subbufs_consumed: æˆåŠŸè¯»å–çš„ buffers</span><br></code></pre></td></tr></table></figure>

<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¦‚ overruns &gt; 0ï¼Œå¢åŠ  buffer</span><br><span class="hljs-built_in">echo</span> 8388608 &gt; /sys/kernel/debug/grtrace/buffer_size  <span class="hljs-comment"># 8MB</span><br><br><span class="hljs-comment"># æˆ–å¢åŠ é‡‡æ ·/é€Ÿç‡é™åˆ¶</span><br><span class="hljs-built_in">echo</span> 50 &gt; /sys/kernel/debug/grtrace/sampling<br><span class="hljs-built_in">echo</span> 5000 &gt; /sys/kernel/debug/grtrace/rate_limit<br></code></pre></td></tr></table></figure>

<h3 id="ç”¨æˆ·ç©ºé—´å·¥å…·é—®é¢˜"><a href="#ç”¨æˆ·ç©ºé—´å·¥å…·é—®é¢˜" class="headerlink" title="ç”¨æˆ·ç©ºé—´å·¥å…·é—®é¢˜"></a>ç”¨æˆ·ç©ºé—´å·¥å…·é—®é¢˜</h3><p><strong>é—®é¢˜: â€œError reading CPU&#x2F;GPU eventsâ€ (merge_timeline.py)</strong></p>
<p><em>åŸå› </em>: æ–‡ä»¶è·¯å¾„æˆ–æƒé™é”™è¯¯ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™</span><br><span class="hljs-built_in">ls</span> -l cpu_events.txt gpu_events.bin<br><br><span class="hljs-comment"># ç¡®ä¿æ–‡ä»¶å¯è¯»</span><br><span class="hljs-built_in">chmod</span> 644 cpu_events.txt gpu_events.bin<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: â€œWarning: Failed to parse lineâ€</strong></p>
<p><em>åŸå› </em>: CPU äº‹ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚</p>
<p><em>è§£å†³</em>:<br>æ£€æŸ¥ CPU äº‹ä»¶æ ¼å¼ï¼ŒæœŸæœ›æ ¼å¼ä¸º:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[timestamp] EVENT_TYPE <span class="hljs-attribute">key</span>=value <span class="hljs-attribute">key</span>=value <span class="hljs-built_in">..</span>.<br></code></pre></td></tr></table></figure>

<p>ç¤ºä¾‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># éªŒè¯ CPU äº‹ä»¶æ ¼å¼</span><br><span class="hljs-built_in">head</span> -5 cpu_events.txt<br><br><span class="hljs-comment"># åº”è¯¥ç±»ä¼¼:</span><br><span class="hljs-comment"># [1234567.123456] IOCTL_ENTER pid=5678 tid=5679 comm=glxgears</span><br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: â€œWarning: Invalid event sizeâ€</strong></p>
<p><em>åŸå› </em>: GPU äºŒè¿›åˆ¶æ–‡ä»¶æŸåã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># éªŒè¯æ–‡ä»¶éç©º</span><br><span class="hljs-built_in">ls</span> -lh gpu_events.bin<br><br><span class="hljs-comment"># æ£€æŸ¥å‰å‡ ä¸ªå­—èŠ‚ (åº”è¯¥æœ‰äº‹ä»¶å¤´)</span><br>hexdump -C gpu_events.bin | <span class="hljs-built_in">head</span><br><br><span class="hljs-comment"># å¦‚æœæ–‡ä»¶æŸåï¼Œé‡æ–°æ•è·:</span><br>sudo <span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/trace_pipe &gt; gpu_events.bin<br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: æ²¡æœ‰è§£æåˆ° GPU äº‹ä»¶</strong></p>
<p><em>åŸå› </em>: æ•è·æœŸé—´ grtrace æœªå¯ç”¨ã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ grtrace æ˜¯å¦å¯ç”¨</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/enabled<br><br><span class="hljs-comment"># å¦‚æœä¸º 0ï¼Œå¯ç”¨å®ƒ:</span><br>sudo sh -c <span class="hljs-string">&#x27;echo 1 &gt; /sys/kernel/debug/grtrace/enabled&#x27;</span><br><br><span class="hljs-comment"># é‡æ–°æ•è·äº‹ä»¶</span><br></code></pre></td></tr></table></figure>

<p><strong>é—®é¢˜: merge_timeline.py æ—¶é’Ÿåç§»è¿‡å¤§</strong></p>
<p><em>åŸå› </em>: CPU å’Œ GPU æ—¶é—´æˆ³æ¥æºä¸åŒã€‚</p>
<p><em>è§£å†³</em>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># CPU å’Œ GPU äº‹ä»¶éƒ½ä½¿ç”¨ ktime_get_ns() (å•è°ƒæ—¶é’Ÿ)ï¼Œåº”è¯¥åŒæ­¥</span><br><span class="hljs-comment"># å¦‚æœè§‚å¯Ÿåˆ°åå·®:</span><br><br><span class="hljs-comment"># 1. æ‰¾åˆ°å…±åŒäº‹ä»¶ (å¦‚ IRQ) åœ¨ä¸¤ä¸ªæµä¸­</span><br><span class="hljs-comment"># 2. è®¡ç®—å·®å€¼: offset = gpu_timestamp - cpu_timestamp</span><br><span class="hljs-comment"># 3. åº”ç”¨æ ¡æ­£:</span><br>python3 merge_timeline.py \<br>    --cpu cpu_events.txt \<br>    --gpu gpu_events.bin \<br>    --clock-offset &lt;offset_ns&gt;<br></code></pre></td></tr></table></figure>

<h3 id="é«˜çº§æ•…éšœæ’æŸ¥"><a href="#é«˜çº§æ•…éšœæ’æŸ¥" class="headerlink" title="é«˜çº§æ•…éšœæ’æŸ¥"></a>é«˜çº§æ•…éšœæ’æŸ¥</h3><p><strong>å¯ç”¨è°ƒè¯•æ—¥å¿—</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯ç”¨ grtrace è°ƒè¯•æ¶ˆæ¯</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;module grtrace +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control<br><br><span class="hljs-comment"># ç›‘è§†å†…æ ¸æ—¥å¿—</span><br>dmesg -w | grep grtrace<br></code></pre></td></tr></table></figure>

<p><strong>æ£€æŸ¥æ¨¡å—ä¾èµ–</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ˜¾ç¤ºæ¨¡å—ä¾èµ–</span><br>modinfo grtrace | grep depends<br><br><span class="hljs-comment"># æ˜¾ç¤ºå·²åŠ è½½æ¨¡å—ä¿¡æ¯</span><br>lsmod | grep grtrace<br><br><span class="hljs-comment"># æ˜¾ç¤ºæ¨¡å—å‚æ•°</span><br>modinfo -p grtrace<br></code></pre></td></tr></table></figure>

<p><strong>åˆ†æäº‹ä»¶ä¸¢å¤±</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ relay buffer ç»Ÿè®¡</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/stats<br><br><span class="hljs-comment"># æŸ¥æ‰¾:</span><br><span class="hljs-comment"># - overruns: Buffer æ»¡ï¼Œäº‹ä»¶è¢«ä¸¢å¼ƒ</span><br><span class="hljs-comment"># - lost_events: äº‹ä»¶ä¸¢å¤±è®¡æ•°å™¨</span><br><span class="hljs-comment"># - subbufs_consumed: æˆåŠŸè¯»å–çš„ buffers</span><br><br><span class="hljs-comment"># å¦‚ overruns &gt; 0ï¼Œå¢åŠ  buffer å¤§å°</span><br><span class="hljs-built_in">echo</span> 8388608 &gt; /sys/kernel/debug/grtrace/buffer_size  <span class="hljs-comment"># 8MB</span><br></code></pre></td></tr></table></figure>

<h3 id="è·å–å¸®åŠ©"><a href="#è·å–å¸®åŠ©" class="headerlink" title="è·å–å¸®åŠ©"></a>è·å–å¸®åŠ©</h3><p><strong>ç¤¾åŒºæ”¯æŒ</strong>:</p>
<ul>
<li><strong>é‚®ä»¶åˆ—è¡¨</strong>: <a href="mailto:&#100;&#x72;&#x69;&#x2d;&#100;&#x65;&#118;&#x65;&#x6c;&#64;&#x6c;&#105;&#115;&#x74;&#115;&#x2e;&#x66;&#114;&#101;&#x65;&#x64;&#x65;&#x73;&#107;&#x74;&#111;&#x70;&#x2e;&#x6f;&#x72;&#x67;">&#100;&#x72;&#x69;&#x2d;&#100;&#x65;&#118;&#x65;&#x6c;&#64;&#x6c;&#105;&#115;&#x74;&#115;&#x2e;&#x66;&#114;&#101;&#x65;&#x64;&#x65;&#x73;&#107;&#x74;&#111;&#x70;&#x2e;&#x6f;&#x72;&#x67;</a></li>
<li><strong>IRC</strong>: #dri-devel on OFTC</li>
<li><strong>Bug æŠ¥å‘Š</strong>: <a target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/drm">https://gitlab.freedesktop.org/drm</a></li>
</ul>
<p><strong>æŠ¥å‘Š Bug æ—¶è¯·åŒ…å«</strong>:</p>
<ol>
<li><strong>å†…æ ¸ç‰ˆæœ¬</strong>: <code>uname -r</code></li>
<li><strong>grtrace ç‰ˆæœ¬</strong>: <code>modinfo grtrace</code></li>
<li><strong>GPU ä¿¡æ¯</strong>: <code>lspci | grep VGA</code></li>
<li><strong>å†…æ ¸é…ç½®</strong>: <code>grep GRTRACE /boot/config-$(uname -r)</code></li>
<li><strong>å†…æ ¸æ—¥å¿—</strong>: <code>dmesg | grep -i grtrace</code></li>
<li><strong>é‡ç°æ­¥éª¤</strong>: è§¦å‘é—®é¢˜çš„ç¡®åˆ‡å‘½ä»¤</li>
</ol>
<p><strong>Bug æŠ¥å‘Šç¤ºä¾‹</strong>:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Subject</span>: grtrace: No events captured <span class="hljs-literal">on</span> AMD RX <span class="hljs-number">6800</span><br><br><span class="hljs-attribute">Kernel</span>: <span class="hljs-number">6</span>.<span class="hljs-number">6</span>.<span class="hljs-number">0</span>-ctkernel-lts<br><span class="hljs-attribute">grtrace</span>: <span class="hljs-number">0</span>.<span class="hljs-number">9</span>.<span class="hljs-number">0</span> (commit <span class="hljs-number">92</span>df6d6)<br><span class="hljs-attribute">GPU</span>: AMD Radeon RX <span class="hljs-number">6800</span> (amdgpu driver)<br><br><span class="hljs-attribute">Config</span>:<br><span class="hljs-attribute">CONFIG_GRTRACE</span>=m<br><span class="hljs-attribute">CONFIG_GRTRACE_AMDGPU</span>=m<br><span class="hljs-attribute">CONFIG_TRACEPOINTS</span>=y<br><br><span class="hljs-attribute">Steps</span> to reproduce:<br><span class="hljs-attribute">1</span>. sudo modprobe grtrace<br><span class="hljs-attribute">2</span>. sudo modprobe grtrace_amdgpu<br><span class="hljs-attribute">3</span>. echo <span class="hljs-number">1</span> &gt; /sys/kernel/debug/grtrace/enable<br><span class="hljs-attribute">4</span>. glxgears (GPU active, confirmed with radeontop)<br><span class="hljs-attribute">5</span>. cat /sys/kernel/debug/grtrace/events<br><br><span class="hljs-attribute">Expected</span>: Events from GPU jobs<br><span class="hljs-attribute">Actual</span>: Empty output (<span class="hljs-number">0</span> events)<br><br><span class="hljs-attribute">dmesg</span> output:<span class="hljs-meta"></span><br><span class="hljs-meta">[attached dmesg.log]</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="âš¡-æ€§èƒ½ä¼˜åŒ–"><a href="#âš¡-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="âš¡ æ€§èƒ½ä¼˜åŒ–"></a>âš¡ æ€§èƒ½ä¼˜åŒ–</h2><h3 id="å¯ç”¨è°ƒè¯•æ—¥å¿—"><a href="#å¯ç”¨è°ƒè¯•æ—¥å¿—" class="headerlink" title="å¯ç”¨è°ƒè¯•æ—¥å¿—"></a>å¯ç”¨è°ƒè¯•æ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯ç”¨ grtrace è°ƒè¯•æ¶ˆæ¯</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;module grtrace +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control<br><br><span class="hljs-comment"># ç›‘è§†å†…æ ¸æ—¥å¿—</span><br>dmesg -w | grep grtrace<br></code></pre></td></tr></table></figure>

<h3 id="æ£€æŸ¥æ¨¡å—çŠ¶æ€"><a href="#æ£€æŸ¥æ¨¡å—çŠ¶æ€" class="headerlink" title="æ£€æŸ¥æ¨¡å—çŠ¶æ€"></a>æ£€æŸ¥æ¨¡å—çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ˜¾ç¤ºæ¨¡å—ä¾èµ–</span><br>modinfo grtrace | grep depends<br><br><span class="hljs-comment"># æ˜¾ç¤ºå·²åŠ è½½æ¨¡å—</span><br>lsmod | grep grtrace<br><br><span class="hljs-comment"># æ˜¾ç¤ºæ¨¡å—å‚æ•°</span><br>modinfo -p grtrace<br></code></pre></td></tr></table></figure>

<h3 id="åˆ†æäº‹ä»¶ä¸¢å¤±"><a href="#åˆ†æäº‹ä»¶ä¸¢å¤±" class="headerlink" title="åˆ†æäº‹ä»¶ä¸¢å¤±"></a>åˆ†æäº‹ä»¶ä¸¢å¤±</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ relay buffer ç»Ÿè®¡</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/stats<br><br><span class="hljs-comment"># å…³æ³¨æŒ‡æ ‡:</span><br><span class="hljs-comment"># - overruns: Buffer æ»¡ï¼Œäº‹ä»¶ä¸¢å¼ƒ</span><br><span class="hljs-comment"># - lost_events: ä¸¢å¤±äº‹ä»¶è®¡æ•°</span><br><span class="hljs-comment"># - subbufs_consumed: æˆåŠŸè¯»å–çš„ buffers</span><br><br><span class="hljs-comment"># å¦‚ overruns &gt; 0ï¼Œå¢åŠ  buffer</span><br><span class="hljs-built_in">echo</span> 8388608 &gt; /sys/kernel/debug/grtrace/buffer_size  <span class="hljs-comment"># 8MB</span><br></code></pre></td></tr></table></figure>

<h3 id="æ€§èƒ½åˆ†æ"><a href="#æ€§èƒ½åˆ†æ" class="headerlink" title="æ€§èƒ½åˆ†æ"></a>æ€§èƒ½åˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ†æ grtrace å¼€é”€</span><br>perf record -e cpu-clock -g ./workload<br>perf report | grep grtrace<br><br><span class="hljs-comment"># å¦‚å¼€é”€ &gt; 1%ï¼Œæ£€æŸ¥:</span><br><span class="hljs-comment"># - é‡‡æ ·ç‡ (å‡å°‘)</span><br><span class="hljs-comment"># - é€Ÿç‡é™åˆ¶ (å¯ç”¨)</span><br><span class="hljs-comment"># - äº‹ä»¶é‡ (ä½¿ç”¨ watchlist è¿‡æ»¤)</span><br></code></pre></td></tr></table></figure>

<h3 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h3><p><strong>ç”Ÿäº§ç¯å¢ƒ</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 10 &gt; sampling              <span class="hljs-comment"># 10% é‡‡æ ·</span><br><span class="hljs-built_in">echo</span> 1000 &gt; rate_limit          <span class="hljs-comment"># 1000 events/s</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;0,1&quot;</span> &gt; watchlist          <span class="hljs-comment"># åªè¿½è¸ªå…³é”® rings</span><br><span class="hljs-built_in">echo</span> 1 &gt; aggregator_enable      <span class="hljs-comment"># å¯ç”¨èšåˆ</span><br></code></pre></td></tr></table></figure>

<p><strong>å¼€å‘&#x2F;è°ƒè¯•</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> 100 &gt; sampling             <span class="hljs-comment"># 100% æ— é‡‡æ ·</span><br><span class="hljs-built_in">echo</span> 0 &gt; rate_limit             <span class="hljs-comment"># æ— é€Ÿç‡é™åˆ¶</span><br><span class="hljs-built_in">echo</span> 3 &gt; level                  <span class="hljs-comment"># è¯¦ç»†æ—¥å¿—</span><br></code></pre></td></tr></table></figure>

<p><strong>æ€§èƒ½åˆ†æ</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> threshold &gt; sampling_mode   <span class="hljs-comment"># é˜ˆå€¼é‡‡æ ·</span><br><span class="hljs-built_in">echo</span> 1000000 &gt; sampling_threshold <span class="hljs-comment"># åªè¿½è¸ª &gt; 1ms</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1234&quot;</span> &gt; filter_pid        <span class="hljs-comment"># åªè¿½è¸ªç‰¹å®šè¿›ç¨‹</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ› ï¸-å¼€å‘æŒ‡å—"><a href="#ğŸ› ï¸-å¼€å‘æŒ‡å—" class="headerlink" title="ğŸ› ï¸ å¼€å‘æŒ‡å—"></a>ğŸ› ï¸ å¼€å‘æŒ‡å—</h2><h3 id="æ·»åŠ æ–°-GPU-å‚å•†"><a href="#æ·»åŠ æ–°-GPU-å‚å•†" class="headerlink" title="æ·»åŠ æ–° GPU å‚å•†"></a>æ·»åŠ æ–° GPU å‚å•†</h3><p><strong>1. å¤åˆ¶æ¨¡æ¿</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> drivers/gpu/grtrace<br><span class="hljs-built_in">cp</span> grtrace_i915.c grtrace_mygpu.c<br></code></pre></td></tr></table></figure>

<p><strong>2. æ›´æ–° Kconfig</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config GRTRACE_MYGPU<br>    tristate &quot;grtrace vendor adapter for MyGPU&quot;<br>    depends on GRTRACE &amp;&amp; TRACEPOINTS &amp;&amp; DRM_MYGPU<br>    help<br>      Enable grtrace support for MyGPU devices.<br></code></pre></td></tr></table></figure>

<p><strong>3. æ›´æ–° Makefile</strong>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">obj-<span class="hljs-variable">$(CONFIG_GRTRACE_MYGPU)</span> += grtrace_mygpu.o<br></code></pre></td></tr></table></figure>

<p><strong>4. å®ç°é’©å­</strong>: å°†å‚å•† tracepoints é’©åˆ° <code>grtrace_emit_event()</code></p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">probe_mygpu_job_submit</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-keyword">struct</span> drm_sched_job *job)</span><br>&#123;<br>    grtrace_submit(job-&gt;entity-&gt;rq-&gt;sched-&gt;name, <br>                   job-&gt;id, <br>                   job-&gt;entity-&gt;fence_context);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">grtrace_mygpu_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ret = register_trace_mygpu_job_submit(probe_mygpu_job_submit, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">// ... register other tracepoints</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>5. æµ‹è¯•</strong>: æ„å»ºå¹¶æµ‹è¯•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">make M=drivers/gpu/grtrace<br>sudo insmod grtrace.ko<br>sudo insmod grtrace_mygpu.ko<br><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/debug/grtrace/enable<br><span class="hljs-comment"># è¿è¡Œ GPU å·¥ä½œè´Ÿè½½</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events<br></code></pre></td></tr></table></figure>

<h3 id="å¯¼å‡º-Tracepoints"><a href="#å¯¼å‡º-Tracepoints" class="headerlink" title="å¯¼å‡º Tracepoints"></a>å¯¼å‡º Tracepoints</h3><p>åœ¨ GPU é©±åŠ¨ä¸­æ·»åŠ :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// åœ¨ mygpu_trace_points.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CREATE_TRACE_POINTS</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mygpu_trace.h&quot;</span></span><br><br><span class="hljs-comment">// å¯¼å‡º tracepoints ä¾›å¤–éƒ¨æ¨¡å—ä½¿ç”¨</span><br>EXPORT_TRACEPOINT_SYMBOL_GPL(mygpu_job_submit);<br>EXPORT_TRACEPOINT_SYMBOL_GPL(mygpu_job_run);<br>EXPORT_TRACEPOINT_SYMBOL_GPL(mygpu_job_done);<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>mygpu_trace.h</code> ä¸­å®šä¹‰ tracepoints:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">TRACE_EVENT(mygpu_job_submit,<br>    TP_PROTO(<span class="hljs-keyword">struct</span> drm_sched_job *job),<br>    TP_ARGS(job),<br>    TP_STRUCT__entry(<br>        __field(u64, fence_ctx)<br>        __field(u64, fence_seqno)<br>        __string(sched_name, job-&gt;entity-&gt;rq-&gt;sched-&gt;name)<br>    ),<br>    TP_fast_assign(<br>        __entry-&gt;fence_ctx = job-&gt;entity-&gt;fence_context;<br>        __entry-&gt;fence_seqno = job-&gt;entity-&gt;fence_seqno;<br>        __assign_str(sched_name, job-&gt;entity-&gt;rq-&gt;sched-&gt;name);<br>    ),<br>    TP_printk(<span class="hljs-string">&quot;sched_name=%s ctx=%llu seqno=%llu&quot;</span>,<br>              __get_str(sched_name),<br>              __entry-&gt;fence_ctx,<br>              __entry-&gt;fence_seqno)<br>);<br></code></pre></td></tr></table></figure>

<h3 id="æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç±»å‹"><a href="#æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç±»å‹" class="headerlink" title="æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç±»å‹"></a>æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç±»å‹</h3><p><strong>1. æ‰©å±•äº‹ä»¶ç±»å‹æšä¸¾</strong> (<code>grtrace_core.h</code>):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">grtrace_event_type</span> &#123;</span><br>    GRTRACE_EVENT_SUBMIT = <span class="hljs-number">0</span>,<br>    GRTRACE_EVENT_COMMIT,<br>    GRTRACE_EVENT_START,<br>    GRTRACE_EVENT_END,<br>    GRTRACE_EVENT_COMPLETE,<br>    GRTRACE_EVENT_CUSTOM,      <span class="hljs-comment">// æ–°å¢è‡ªå®šä¹‰ç±»å‹</span><br>    GRTRACE_EVENT_MAX<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>2. å®ç°äº‹ä»¶å¤„ç†å™¨</strong> (<code>grtrace.c</code>):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">grtrace_custom_event</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *engine, u32 ring_id,</span><br><span class="hljs-params">                          u64 custom_data)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">grtrace_event</span> <span class="hljs-title">event</span>;</span><br>    <br>    <span class="hljs-keyword">if</span> (!grtrace_enabled())<br>        <span class="hljs-keyword">return</span>;<br>    <br>    event.hdr.type = GRTRACE_EVENT_CUSTOM;<br>    event.hdr.size = <span class="hljs-keyword">sizeof</span>(event);<br>    event.hdr.timestamp = ktime_get_ns();<br>    <br>    strscpy(event.engine, engine, <span class="hljs-keyword">sizeof</span>(event.engine));<br>    event.ring_id = ring_id;<br>    event.custom_data = custom_data;<br>    <br>    grtrace_emit_event(&amp;event);<br>&#125;<br>EXPORT_SYMBOL_GPL(grtrace_custom_event);<br></code></pre></td></tr></table></figure>

<p><strong>3. æ›´æ–°ç”¨æˆ·ç©ºé—´å·¥å…·</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># åœ¨ grtrace CLI ä¸­æ·»åŠ è§£ææ”¯æŒ</span><br>EVENT_TYPES = &#123;<br>    <span class="hljs-number">0</span>: <span class="hljs-string">&quot;SUBMIT&quot;</span>,<br>    <span class="hljs-number">1</span>: <span class="hljs-string">&quot;COMMIT&quot;</span>,<br>    <span class="hljs-number">2</span>: <span class="hljs-string">&quot;START&quot;</span>,<br>    <span class="hljs-number">3</span>: <span class="hljs-string">&quot;END&quot;</span>,<br>    <span class="hljs-number">4</span>: <span class="hljs-string">&quot;COMPLETE&quot;</span>,<br>    <span class="hljs-number">5</span>: <span class="hljs-string">&quot;CUSTOM&quot;</span>,   <span class="hljs-comment"># æ–°å¢</span><br>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_custom_event</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-comment"># è§£æè‡ªå®šä¹‰äº‹ä»¶æ•°æ®</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure>

<p><strong>4. ä¿æŒå‘åå…¼å®¹</strong>:</p>
<ul>
<li>ä½¿ç”¨ä¿ç•™å­—æ®µè€Œéä¿®æ”¹ç°æœ‰ç»“æ„</li>
<li>æ›´æ–°ç‰ˆæœ¬å·</li>
<li>åœ¨æ—§å·¥å…·ä¸­ä¼˜é›…å¤„ç†æœªçŸ¥äº‹ä»¶ç±»å‹</li>
</ul>
<h3 id="è´¡çŒ®ä»£ç "><a href="#è´¡çŒ®ä»£ç " class="headerlink" title="è´¡çŒ®ä»£ç "></a>è´¡çŒ®ä»£ç </h3><p><strong>éµå¾ª Linux å†…æ ¸è´¡çŒ®æŒ‡å—</strong>:</p>
<ol>
<li><p><strong>é˜…è¯»æ–‡æ¡£</strong>: <code>Documentation/process/submitting-patches.rst</code></p>
</li>
<li><p><strong>ç¼–å†™æ•´æ´ã€æœ‰æ–‡æ¡£çš„ä»£ç </strong>:</p>
<ul>
<li>éµå¾ªå†…æ ¸ç¼–ç é£æ ¼</li>
<li>æ·»åŠ å¿…è¦çš„æ³¨é‡Š</li>
<li>æ›´æ–°æ–‡æ¡£</li>
</ul>
</li>
<li><p><strong>æ·»åŠ æµ‹è¯•</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸ºæ–°åŠŸèƒ½æ·»åŠ  selftests</span><br><span class="hljs-built_in">cd</span> tools/testing/selftests/grtrace<br><span class="hljs-comment"># åˆ›å»ºæµ‹è¯•ç”¨ä¾‹</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>è¿è¡Œæ£€æŸ¥</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥ä»£ç é£æ ¼</span><br>./scripts/checkpatch.pl --strict drivers/gpu/grtrace/*.c<br><br><span class="hljs-comment"># ä¿®å¤æ‰€æœ‰è­¦å‘Šå’Œé”™è¯¯</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>æäº¤è¡¥ä¸</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git format-patch -1<br>./scripts/get_maintainer.pl 0001-*.patch<br>git send-email --to dri-devel@lists.freedesktop.org 0001-*.patch<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>CC grtrace ç»´æŠ¤è€…</strong></p>
</li>
</ol>
<h3 id="å¼€å‘æŠ€å·§"><a href="#å¼€å‘æŠ€å·§" class="headerlink" title="å¼€å‘æŠ€å·§"></a>å¼€å‘æŠ€å·§</h3><p><strong>è°ƒè¯•æŠ€å·§</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯ç”¨è¯¦ç»†è°ƒè¯•è¾“å‡º</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;module grtrace +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control<br><br><span class="hljs-comment"># ç›‘è§†å†…æ ¸æ—¥å¿—</span><br>dmesg -w | grep grtrace<br><br><span class="hljs-comment"># è¿½è¸ªå‡½æ•°è°ƒç”¨</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;grtrace_*&#x27;</span> &gt; /sys/kernel/debug/tracing/set_ftrace_filter<br><span class="hljs-built_in">echo</span> <span class="hljs-keyword">function</span> &gt; /sys/kernel/debug/tracing/current_tracer<br><span class="hljs-built_in">cat</span> /sys/kernel/debug/tracing/trace<br></code></pre></td></tr></table></figure>

<p><strong>æ€§èƒ½åˆ†æ</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä½¿ç”¨ perf åˆ†æ</span><br>perf record -e cpu-clock -g -a <span class="hljs-built_in">sleep</span> 10<br>perf report | grep grtrace<br><br><span class="hljs-comment"># æ£€æŸ¥äº‹ä»¶å»¶è¿Ÿ</span><br>perf trace -e grtrace:* ./workload<br></code></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•æœ€ä½³å®è·µ</strong>:</p>
<ul>
<li>åœ¨æ·»åŠ æ–°åŠŸèƒ½æ—¶ç¼–å†™ selftests</li>
<li>æµ‹è¯•é”™è¯¯è·¯å¾„å’Œè¾¹ç•Œæ¡ä»¶</li>
<li>åœ¨å¤šä¸ª GPU å¹³å°ä¸ŠéªŒè¯</li>
<li>æ£€æŸ¥æ€§èƒ½å½±å“</li>
<li>éªŒè¯å‘åå…¼å®¹æ€§</li>
</ul>
<h3 id="æ¶æ„æ³¨æ„äº‹é¡¹"><a href="#æ¶æ„æ³¨æ„äº‹é¡¹" class="headerlink" title="æ¶æ„æ³¨æ„äº‹é¡¹"></a>æ¶æ„æ³¨æ„äº‹é¡¹</h3><p><strong>æ¨¡å—åŒ–è®¾è®¡</strong>:</p>
<ul>
<li>æ ¸å¿ƒåŠŸèƒ½åœ¨ <code>grtrace.c</code></li>
<li>å‚å•†ç‰¹å®šä»£ç åœ¨å•ç‹¬çš„é€‚é…å™¨ä¸­</li>
<li>å¢å¼ºåŠŸèƒ½ä½œä¸ºå¯é€‰æ¨¡å— (aggregator, sampling, filter)</li>
</ul>
<p><strong>æ€§èƒ½è€ƒè™‘</strong>:</p>
<ul>
<li>æœ€å°åŒ–é”ç«äº‰</li>
<li>ä½¿ç”¨æ¯ CPU æ•°æ®ç»“æ„</li>
<li>é¿å…åœ¨çƒ­è·¯å¾„ä¸­åˆ†é…</li>
<li>ä¼˜å…ˆä½¿ç”¨æ— é”ç®—æ³•</li>
</ul>
<p><strong>å…¼å®¹æ€§</strong>:</p>
<ul>
<li>ç»´æŠ¤ç¨³å®šçš„äº‹ä»¶æ ¼å¼</li>
<li>ç‰ˆæœ¬åŒ–æ›´æ”¹</li>
<li>æ”¯æŒæ—§å·¥å…·</li>
<li>æ¸…æ™°è®°å½• API æ›´æ”¹</li>
</ul>
<h3 id="æœªæ¥å¢å¼º"><a href="#æœªæ¥å¢å¼º" class="headerlink" title="æœªæ¥å¢å¼º"></a>æœªæ¥å¢å¼º</h3><p>è®¡åˆ’ä¸­çš„åŠŸèƒ½:</p>
<ul>
<li><input disabled type="checkbox"> å›¾å½¢åŒ–æ—¶é—´çº¿å¯è§†åŒ–ï¼ˆmatplotlibï¼‰</li>
<li><input disabled type="checkbox"> JSON è¾“å‡ºæ ¼å¼</li>
<li><input disabled type="checkbox"> å®æ—¶æµå¼æ¨¡å¼ï¼ˆå®æ—¶å¤„ç†äº‹ä»¶ï¼‰</li>
<li><input disabled type="checkbox"> æŒ‰è¿›ç¨‹&#x2F;ä¸Šä¸‹æ–‡è¿‡æ»¤å¢å¼º</li>
<li><input disabled type="checkbox"> GPU åŠŸè€—&#x2F;é¢‘ç‡å…³è”</li>
<li><input disabled type="checkbox"> æ›´ä¸°å¯Œçš„å…ƒæ•°æ®æ•è·</li>
<li><input disabled type="checkbox"> é›†æˆåˆ° trace-cmd&#x2F;perf</li>
</ul>
<hr>
<h2 id="ğŸ“‹-é…ç½®é€‰é¡¹"><a href="#ğŸ“‹-é…ç½®é€‰é¡¹" class="headerlink" title="ğŸ“‹ é…ç½®é€‰é¡¹"></a>ğŸ“‹ é…ç½®é€‰é¡¹</h2><h3 id="å†…æ ¸é…ç½®"><a href="#å†…æ ¸é…ç½®" class="headerlink" title="å†…æ ¸é…ç½®"></a>å†…æ ¸é…ç½®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">CONFIG_GRTRACE=m                 # æ ¸å¿ƒæ¨¡å— (å¿…éœ€)<br>CONFIG_GRTRACE_AGGREGATOR=m      # èšåˆå™¨ (å¯é€‰)<br>CONFIG_GRTRACE_SAMPLER=m         # é‡‡æ ·å™¨ (å¯é€‰)<br>CONFIG_GRTRACE_FILTER=m          # è¿‡æ»¤å™¨ (å¯é€‰)<br>CONFIG_GRTRACE_PERF_MON=m        # æ€§èƒ½ç›‘æ§ (å¯é€‰)<br>CONFIG_GRTRACE_DRM_BRIDGE=m      # DRM æ¡¥æ¥ (æ¨èï¼Œé€šç”¨)<br>CONFIG_GRTRACE_AMDGPU=m          # AMD é€‚é…å™¨ (å¯é€‰)<br>CONFIG_GRTRACE_I915=m            # Intel é€‚é…å™¨ (å¯é€‰)<br>CONFIG_GRTRACE_NOUVEAU=m         # Nouveau é€‚é…å™¨ (å¯é€‰)<br>CONFIG_GRTRACE_VIRTIO_GPU=m      # VirtIO é€‚é…å™¨ (å¯é€‰)<br></code></pre></td></tr></table></figure>

<h3 id="ä¾èµ–é¡¹"><a href="#ä¾èµ–é¡¹" class="headerlink" title="ä¾èµ–é¡¹"></a>ä¾èµ–é¡¹</h3><p><strong>å¿…éœ€</strong>:</p>
<ul>
<li><code>CONFIG_RELAY=y</code> - Relay æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ</li>
<li><code>CONFIG_DEBUG_FS=y</code> - debugfs æ”¯æŒ</li>
<li><code>CONFIG_TRACEPOINTS=y</code> - å†…æ ¸ tracepoint æ”¯æŒ</li>
</ul>
<p><strong>å¯é€‰</strong>:</p>
<ul>
<li><code>CONFIG_PERF_EVENTS=y</code> - perf äº‹ä»¶æ”¯æŒ</li>
<li><code>CONFIG_BPF=y</code> - eBPF æ”¯æŒ (ç”¨äº CPU å…³è”)</li>
</ul>
<hr>
<h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£"><a href="#ğŸ“š-ç›¸å…³æ–‡æ¡£" class="headerlink" title="ğŸ“š ç›¸å…³æ–‡æ¡£"></a>ğŸ“š ç›¸å…³æ–‡æ¡£</h2><h3 id="å†…æ ¸æ–‡æ¡£"><a href="#å†…æ ¸æ–‡æ¡£" class="headerlink" title="å†…æ ¸æ–‡æ¡£"></a>å†…æ ¸æ–‡æ¡£</h3><ul>
<li><strong>ä¸»æ–‡æ¡£</strong>: <code>drivers/gpu/grtrace/README.md</code> (æœ¬æ–‡ä»¶)</li>
<li><strong>æ¶æ„å›¾</strong>: <code>drivers/gpu/grtrace/architecture.txt</code></li>
<li><strong>å¸¸è§é—®é¢˜</strong>: <code>drivers/gpu/grtrace/FAQ.md</code></li>
</ul>
<h3 id="å·¥å…·æ–‡æ¡£"><a href="#å·¥å…·æ–‡æ¡£" class="headerlink" title="å·¥å…·æ–‡æ¡£"></a>å·¥å…·æ–‡æ¡£</h3><ul>
<li><strong>å·¥å…·é›†</strong>: <code>tools/grtrace/README.md</code></li>
<li><strong>eBPF æ³¨è§£</strong>: <code>tools/grtrace/bpf/README.md</code></li>
<li><strong>æµ‹è¯•å¥—ä»¶</strong>: <code>tools/testing/selftests/grtrace/README.md</code></li>
</ul>
<h3 id="åœ¨çº¿èµ„æº"><a href="#åœ¨çº¿èµ„æº" class="headerlink" title="åœ¨çº¿èµ„æº"></a>åœ¨çº¿èµ„æº</h3><ul>
<li><strong>DRM é‚®ä»¶åˆ—è¡¨</strong>: <a href="mailto:&#100;&#114;&#x69;&#45;&#x64;&#x65;&#x76;&#101;&#x6c;&#x40;&#108;&#105;&#x73;&#116;&#x73;&#x2e;&#102;&#x72;&#x65;&#x65;&#x64;&#x65;&#x73;&#107;&#x74;&#x6f;&#112;&#46;&#x6f;&#114;&#x67;">&#100;&#114;&#x69;&#45;&#x64;&#x65;&#x76;&#101;&#x6c;&#x40;&#108;&#105;&#x73;&#116;&#x73;&#x2e;&#102;&#x72;&#x65;&#x65;&#x64;&#x65;&#x73;&#107;&#x74;&#x6f;&#112;&#46;&#x6f;&#114;&#x67;</a></li>
<li><strong>IRC</strong>: #dri-devel on OFTC</li>
<li><strong>Bug è¿½è¸ª</strong>: <a target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/drm">https://gitlab.freedesktop.org/drm</a></li>
</ul>
<hr>
<h2 id="ğŸ¯-ç‰ˆæœ¬å†å²"><a href="#ğŸ¯-ç‰ˆæœ¬å†å²" class="headerlink" title="ğŸ¯ ç‰ˆæœ¬å†å²"></a>ğŸ¯ ç‰ˆæœ¬å†å²</h2><h3 id="v1-0-å½“å‰"><a href="#v1-0-å½“å‰" class="headerlink" title="v1.0 (å½“å‰)"></a>v1.0 (å½“å‰)</h3><ul>
<li>âœ… æ ¸å¿ƒæ¡†æ¶å®Œæˆ</li>
<li>âœ… å¤šå‚å•†æ”¯æŒ (Intel, AMD, Nouveau, virtio-gpu)</li>
<li>âœ… DRM scheduler é€šç”¨æ¡¥æ¥</li>
<li>âœ… v1.0 å¢å¼ºæ¨¡å— (aggregator, sampling, filter, perf_mon)</li>
<li>âœ… ç”¨æˆ·ç©ºé—´å·¥å…·</li>
<li>âœ… eBPF CPU å…³è”å·¥å…·</li>
<li>âœ… å†…æ ¸ selftests</li>
<li>âœ… å®Œæ•´æ–‡æ¡£</li>
</ul>
<h3 id="v0-9"><a href="#v0-9" class="headerlink" title="v0.9"></a>v0.9</h3><ul>
<li>ç¨³å®šåŒ–é˜¶æ®µ</li>
<li>Bug ä¿®å¤å’Œæ€§èƒ½ä¼˜åŒ–</li>
<li>æ–‡æ¡£å®Œå–„</li>
</ul>
<h3 id="v0-8"><a href="#v0-8" class="headerlink" title="v0.8"></a>v0.8</h3><ul>
<li>æ·»åŠ  DRM scheduler æ¡¥æ¥</li>
<li>å®ç°æ™ºèƒ½å»é‡</li>
<li>æ—¶é—´çº¿åˆå¹¶å·¥å…·</li>
</ul>
<h3 id="v0-7"><a href="#v0-7" class="headerlink" title="v0.7"></a>v0.7</h3><ul>
<li>å‚å•†é€‚é…å™¨é‡æ„</li>
<li>æ·»åŠ  v1.0 å¢å¼ºæ¨¡å—</li>
</ul>
<h3 id="v0-6"><a href="#v0-6" class="headerlink" title="v0.6"></a>v0.6</h3><ul>
<li>åˆå§‹å…¬å¼€å‘å¸ƒ</li>
<li>åŸºç¡€ relay buffer å’Œ debugfs æ¥å£</li>
</ul>
<hr>
<h2 id="ğŸ¤-è´¡çŒ®è€…"><a href="#ğŸ¤-è´¡çŒ®è€…" class="headerlink" title="ğŸ¤ è´¡çŒ®è€…"></a>ğŸ¤ è´¡çŒ®è€…</h2><p>æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…ï¼</p>
<p>å¦‚éœ€è´¡çŒ®ï¼Œè¯·å‚é˜… <a href="#%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">å¼€å‘æŒ‡å—</a> éƒ¨åˆ†ã€‚</p>
<hr>
<h2 id="ğŸ“„-è®¸å¯è¯"><a href="#ğŸ“„-è®¸å¯è¯" class="headerlink" title="ğŸ“„ è®¸å¯è¯"></a>ğŸ“„ è®¸å¯è¯</h2><p><strong>SPDX-License-Identifier</strong>: GPL-2.0</p>
<p>grtrace é‡‡ç”¨ GPL-2.0 è®¸å¯è¯ï¼ˆä¸ Linux å†…æ ¸ç›¸åŒï¼‰ã€‚</p>
<hr>
<h2 id="ğŸ“®-è”ç³»æ–¹å¼"><a href="#ğŸ“®-è”ç³»æ–¹å¼" class="headerlink" title="ğŸ“® è”ç³»æ–¹å¼"></a>ğŸ“® è”ç³»æ–¹å¼</h2><ul>
<li><strong>é‚®ä»¶åˆ—è¡¨</strong>: <a href="mailto:&#100;&#x72;&#105;&#x2d;&#x64;&#x65;&#118;&#101;&#108;&#64;&#x6c;&#x69;&#115;&#x74;&#x73;&#x2e;&#x66;&#114;&#x65;&#x65;&#x64;&#x65;&#115;&#107;&#x74;&#111;&#x70;&#46;&#x6f;&#114;&#x67;">&#100;&#x72;&#105;&#x2d;&#x64;&#x65;&#118;&#101;&#108;&#64;&#x6c;&#x69;&#115;&#x74;&#x73;&#x2e;&#x66;&#114;&#x65;&#x65;&#x64;&#x65;&#115;&#107;&#x74;&#111;&#x70;&#46;&#x6f;&#114;&#x67;</a></li>
<li><strong>IRC</strong>: #dri-devel on OFTC</li>
<li><strong>Bug æŠ¥å‘Š</strong>: <a target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/drm">https://gitlab.freedesktop.org/drm</a></li>
</ul>
<hr>
<p><strong>æ–‡æ¡£ç‰ˆæœ¬</strong>: v1.0.0<br><strong>æœ€åæ›´æ–°</strong>: 2024-12-03<br><strong>ç»´æŠ¤è€…</strong>: grtrace å¼€å‘å›¢é˜Ÿ<br><strong>çŠ¶æ€</strong>: ç¨³å®šç‰ˆ</p>
<hr>
<h2 id="å¿«é€Ÿå‚è€ƒå¡"><a href="#å¿«é€Ÿå‚è€ƒå¡" class="headerlink" title="å¿«é€Ÿå‚è€ƒå¡"></a>å¿«é€Ÿå‚è€ƒå¡</h2><h3 id="æœ€å¸¸ç”¨å‘½ä»¤"><a href="#æœ€å¸¸ç”¨å‘½ä»¤" class="headerlink" title="æœ€å¸¸ç”¨å‘½ä»¤"></a>æœ€å¸¸ç”¨å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åŠ è½½æ¨¡å—</span><br>sudo modprobe grtrace grtrace_drm_bridge<br><br><span class="hljs-comment"># å¯ç”¨è¿½è¸ª</span><br><span class="hljs-built_in">echo</span> 1 | sudo <span class="hljs-built_in">tee</span> /sys/kernel/debug/grtrace/enable<br><br><span class="hljs-comment"># æŸ¥çœ‹äº‹ä»¶ (per-CPU relay buffer)</span><br>sudo <span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events0<br><span class="hljs-comment"># æˆ–æŸ¥çœ‹äº‹ä»¶ç»Ÿè®¡</span><br>sudo <span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/events_by_type<br><br><span class="hljs-comment"># åœæ­¢è¿½è¸ª</span><br><span class="hljs-built_in">echo</span> stop | sudo <span class="hljs-built_in">tee</span> /sys/kernel/debug/grtrace/control<br><br><span class="hljs-comment"># æ£€æŸ¥çŠ¶æ€</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/stats<br></code></pre></td></tr></table></figure>

<h3 id="æ•…éšœæ’æŸ¥å¿«é€Ÿæ£€æŸ¥"><a href="#æ•…éšœæ’æŸ¥å¿«é€Ÿæ£€æŸ¥" class="headerlink" title="æ•…éšœæ’æŸ¥å¿«é€Ÿæ£€æŸ¥"></a>æ•…éšœæ’æŸ¥å¿«é€Ÿæ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. æ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½</span><br>lsmod | grep grtrace<br><br><span class="hljs-comment"># 2. æ£€æŸ¥ debugfs</span><br>mount | grep debugfs<br><span class="hljs-built_in">ls</span> /sys/kernel/debug/grtrace/<br><br><span class="hljs-comment"># 3. æ£€æŸ¥è¿½è¸ªçŠ¶æ€</span><br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/enable<br><br><span class="hljs-comment"># 4. æŸ¥çœ‹å†…æ ¸æ—¥å¿—</span><br>dmesg | grep -i grtrace<br><br><span class="hljs-comment"># 5. æµ‹è¯• GPU æ´»åŠ¨</span><br>glxgears &amp;<br><span class="hljs-built_in">sleep</span> 5<br><span class="hljs-built_in">cat</span> /sys/kernel/debug/grtrace/stats<br></code></pre></td></tr></table></figure>

<h3 id="æ€§èƒ½è°ƒä¼˜å¿«é€Ÿè®¾ç½®"><a href="#æ€§èƒ½è°ƒä¼˜å¿«é€Ÿè®¾ç½®" class="headerlink" title="æ€§èƒ½è°ƒä¼˜å¿«é€Ÿè®¾ç½®"></a>æ€§èƒ½è°ƒä¼˜å¿«é€Ÿè®¾ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒï¼ˆä½å¼€é”€ï¼‰</span><br><span class="hljs-built_in">echo</span> 10 &gt; /sys/kernel/debug/grtrace/sampling<br><span class="hljs-built_in">echo</span> 1000 &gt; /sys/kernel/debug/grtrace/rate_limit<br><span class="hljs-built_in">echo</span> 1 &gt; /sys/kernel/debug/grtrace/aggregator_enable<br><br><span class="hljs-comment"># å¼€å‘ç¯å¢ƒï¼ˆå®Œæ•´è¿½è¸ªï¼‰</span><br><span class="hljs-built_in">echo</span> 100 &gt; /sys/kernel/debug/grtrace/sampling<br><span class="hljs-built_in">echo</span> 0 &gt; /sys/kernel/debug/grtrace/rate_limit<br><span class="hljs-built_in">echo</span> 3 &gt; /sys/kernel/debug/grtrace/level<br><br><span class="hljs-comment"># æ€§èƒ½åˆ†æï¼ˆé˜ˆå€¼é‡‡æ ·ï¼‰</span><br><span class="hljs-built_in">echo</span> threshold &gt; /sys/kernel/debug/grtrace/sampling_mode<br><span class="hljs-built_in">echo</span> 1000000 &gt; /sys/kernel/debug/grtrace/sampling_threshold<br></code></pre></td></tr></table></figure>

<hr>
<p><strong>ğŸ‰ æ„Ÿè°¢ä½¿ç”¨ grtraceï¼</strong></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/linux/" class="category-chain-item">linux</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/drivers/" class="category-chain-item">drivers</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/drivers/gpu/" class="category-chain-item">gpu</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/drivers/gpu/grtrace/" class="category-chain-item">grtrace</a>
  
  
    <span>></span>
    
  <a href="/categories/linux/drivers/gpu/grtrace/docs/" class="category-chain-item">docs</a>
  
  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/3d/">#3d</a>
      
        <a href="/tags/architect/">#architect</a>
      
        <a href="/tags/boot/">#boot</a>
      
        <a href="/tags/bpf/">#bpf</a>
      
        <a href="/tags/deb/">#deb</a>
      
        <a href="/tags/debug/">#debug</a>
      
        <a href="/tags/drivers/">#drivers</a>
      
        <a href="/tags/fs/">#fs</a>
      
        <a href="/tags/git/">#git</a>
      
        <a href="/tags/gpu/">#gpu</a>
      
        <a href="/tags/kernel/">#kernel</a>
      
        <a href="/tags/linux/">#linux</a>
      
        <a href="/tags/log/">#log</a>
      
        <a href="/tags/perf/">#perf</a>
      
        <a href="/tags/python/">#python</a>
      
        <a href="/tags/shell/">#shell</a>
      
        <a href="/tags/testing/">#testing</a>
      
        <a href="/tags/tools/">#tools</a>
      
        <a href="/tags/virt/">#virt</a>
      
        <a href="/tags/mm/">#mm</a>
      
        <a href="/tags/struct/">#struct</a>
      
        <a href="/tags/extern/">#extern</a>
      
        <a href="/tags/proc/">#proc</a>
      
        <a href="/tags/modules/">#modules</a>
      
        <a href="/tags/sync/">#sync</a>
      
        <a href="/tags/irq/">#irq</a>
      
        <a href="/tags/grtrace/">#grtrace</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>grtrace - GPU Ring Trace</div>
      <div>https://realwujing.github.io/linux/drivers/gpu/grtrace/docs/README/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Wu Jing</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2025å¹´12æœˆ18æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/linux/kernel/mm/bugs/insert_vmap_area_augment/insert_vmap_area_augment/" title="vmalloc_initåˆå§‹åŒ–å¤±è´¥å¯¼è‡´phtyiumæ— æ³•å¯åŠ¨">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">vmalloc_initåˆå§‹åŒ–å¤±è´¥å¯¼è‡´phtyiumæ— æ³•å¯åŠ¨</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/linux/kernel/net/port-forward/README/" title="KVM è™šæ‹Ÿæœºç«¯å£è½¬å‘é…ç½®">
                        <span class="hidden-mobile">KVM è™šæ‹Ÿæœºç«¯å£è½¬å‘é…ç½®</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c11f8471a6ae4d3eea12","clientSecret":"87bfa232882af2b005f4c3352132dd418bf6d113","repo":"realwujing.github.io","owner":"realwujing","admin":["realwujing"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '8b730cfdcb14b1da9c57c6f881714d9d'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
