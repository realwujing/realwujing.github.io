name: Pages

on:
  push:
    branches:
      - main # default branch
      - hexo

jobs:
  pages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Set up Git
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Replace with your desired Python version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Merge branch
        run: |
          set -aex
          git config --global user.email "178955347@qq.com"
          git config --global user.name "bot"
          git fetch origin
          git checkout main
          git pull origin main
          pwd
          ls -lah
          git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" README.md
          find . -name "*.md" -exec sh -c '
            file="{}";
            date=$(git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" "$file" | head -1);
            updated=$(git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" "$file" | tail -1);
            # 从文件名提取标题(去掉路径和.md扩展名)
            title=$(basename "$file" .md);
            # 插入front matter,包含title
            sed -i "1i---" "$file";
            sed -i "2ititle: $title" "$file";
            sed -i "3idate: $date" "$file";
            sed -i "4iupdated: $updated" "$file";
            sed -i "5i---" "$file";
            sed -i "6i\ " "$file";
          ' \;
          rm -rf ../hexo-site
          mkdir ../hexo-site
          cp -r ./* ../hexo-site
          git checkout -- .
          git checkout -b hexo origin/hexo
          rsync -avP  --delete --exclude='.git'--exclude='.github' --exclude='node_modules' --exclude='public' --exclude='source' --exclude='scaffolds' --exclude='themes' --include='*/' --include='*.md' --exclude='*' ../hexo-site/ ./source/_posts/
          rsync -avP ../hexo-site/README.md source/about/index.md
          # 修复文件名中的点号问题 - 重命名文件但保留title
          find source/_posts -name "*.md" -type f | while read file; do
            base=$(basename "$file" .md)
            # 如果文件名包含点号(Hexo会误认为扩展名分隔符)
            if [[ "$base" == *.* ]]; then
              dir=$(dirname "$file")
              # 文件名中的点号替换为短横线
              newbase=$(echo "$base" | sed 's/\./-/g')
              newfile="$dir/$newbase.md"
              if [[ "$file" != "$newfile" ]]; then
                mv "$file" "$newfile"
                echo "Renamed: $file -> $newfile (title preserved in front matter)"
              fi
            fi
          done
          # 修复所有markdown文件中的相对链接为GitHub绝对链接
          python3 scripts/fix_relative_links.py
          pwd
          git status
          git add -A .
          find source -name '*.md'
          git commit -m "feat: bot auto commit"
          git push origin HEAD:bot -u -f
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install pandoc
        run: sudo apt install pandoc
      - name: Install Dependencies
        run: |
          set -aex
          pwd
          npm install
          npm uninstall hexo-renderer-marked --save
          npm install hexo-renderer-pandoc --save
          npm install hexo-filter-plantuml --save
          find source -name '*.md'
      - name: Build
        run: |
          set -aex
          pwd
          git branch
          find source -name '*.md'
          pwd
          npm run clean
          pwd
          npm run build
          ls -la
          tree public
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public