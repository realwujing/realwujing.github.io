name: Pages

on:
  push:
    branches:
      - main # default branch
      - hexo

jobs:
  pages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Set up Git
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Replace with your desired Python version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Merge branch
        run: |
          set -aex
          git config --global user.email "178955347@qq.com"
          git config --global user.name "bot"
          git fetch origin
          git checkout main
          git pull origin main
          pwd
          ls -lah
          git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" README.md
          find . -name "*.md" -exec sh -c 'date=$(git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" "{}" | head -1); updated=$(git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" "{}" | tail -1); sed -i "1i---" "{}"; sed -i "2idate: $date" "{}"; sed -i "3iupdated: $updated" "{}"; sed -i "4i---" "{}"; sed -i "5i\ " "{}"' \;
          rm -rf ../hexo-site
          mkdir ../hexo-site
          cp -r ./* ../hexo-site
          git checkout -- .
          git checkout -b hexo origin/hexo
          rsync -avP  --delete --exclude='.git'--exclude='.github' --exclude='node_modules' --exclude='public' --exclude='source' --exclude='scaffolds' --exclude='themes' --include='*/' --include='*.md' --exclude='*' ../hexo-site/ ./source/_posts/
          rsync -avP ../hexo-site/README.md source/about/index.md
          # 修复所有markdown文件中的相对链接为GitHub绝对链接
          # 使用find+perl处理source目录下所有.md文件
          find source -name "*.md" -type f -exec perl -pi -e '
            # 获取当前文件相对于source的路径,计算其在main分支的绝对路径
            BEGIN { 
              $file = $ARGV[0]; 
              $file =~ s/^source\/_posts\///;  # 移除source/_posts/前缀
              $file =~ s/^source\/about\/index\.md$/README.md/;  # about/index.md对应README.md
              ($basedir) = $file =~ m{^(.*?)/[^/]+$};  # 提取文件所在目录
              $basedir //= "";  # 如果在根目录则为空
            }
            # 1. 文档文件相对链接 -> GitHub raw链接(下载)
            s/\]\(\.\/(.*?)\.(pdf|pptx|docx|epub|mobi)\)/](__GITHUB_RAW__\/$1.$2)/g;
            # 2. Markdown文件相对链接 -> GitHub blob链接(查看)
            s/\]\(\.\/(.*?)\.md\)/](__GITHUB_BLOB__\/$1.md)/g;
            # 3. 目录相对链接 -> GitHub tree链接(浏览)
            s/\]\(\.\/(.*?)\/\)/](__GITHUB_TREE__\/$1)/g;
            # 最后统一替换占位符为完整URL
            s/__GITHUB_RAW__/https:\/\/github.com\/realwujing\/realwujing.github.io\/raw\/main\/$basedir/g;
            s/__GITHUB_BLOB__/https:\/\/github.com\/realwujing\/realwujing.github.io\/blob\/main\/$basedir/g;
            s/__GITHUB_TREE__/https:\/\/github.com\/realwujing\/realwujing.github.io\/tree\/main\/$basedir/g;
          ' {} \;
          pwd
          git status
          git add -A .
          find source -name '*.md'
          git commit -m "feat: bot auto commit"
          git push origin HEAD:bot -u -f
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install pandoc
        run: sudo apt install pandoc
      - name: Install Dependencies
        run: |
          set -aex
          pwd
          npm install
          npm uninstall hexo-renderer-marked --save
          npm install hexo-renderer-pandoc --save
          npm install hexo-filter-plantuml --save
          find source -name '*.md'
      - name: Build
        run: |
          set -aex
          pwd
          git branch
          find source -name '*.md'
          pwd
          npm run clean
          pwd
          npm run build
          ls -la
          tree public
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public