name: Pages

on:
  push:
    branches:
      - main # default branch
      - hexo

jobs:
  pages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Set up Git
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Replace with your desired Python version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Merge branch
        run: |
          set -aex
          git config --global user.email "178955347@qq.com"
          git config --global user.name "bot"
          git fetch origin
          git checkout main
          git pull origin main
          pwd
          ls -lah
          git log --reverse --pretty=format:"%cd" --date=format:"%Y/%m/%d %H:%M:%S" README.md
          # 从 hexo 分支获取 front_matter.sh
          git show origin/hexo:front_matter.sh > front_matter.sh
          chmod +x front_matter.sh
          # 为所有 markdown 文件添加 front matter
          find . -name "*.md" -type f -exec bash front_matter.sh {} \;
          # 清理临时文件
          rm -f front_matter.sh
          rm -rf ../hexo-site
          mkdir ../hexo-site
          cp -r ./* ../hexo-site
          git checkout -- .
          git checkout -b hexo origin/hexo
          # 同步markdown文件到 hexo 分支
          rsync -avP --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='public' \
            --exclude='source' \
            --exclude='scaffolds' \
            --exclude='themes' \
            --include='*/' \
            --include='*.md' \
            --exclude='*' \
            ../hexo-site/ ./source/_posts/
          
          # 同步图片文件到 source/images (Hexo会自动复制到public)
          rsync -avP --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='public' \
            --exclude='source' \
            --exclude='scaffolds' \
            --exclude='themes' \
            --include='*/' \
            --include='*.png' \
            --include='*.jpg' \
            --include='*.jpeg' \
            --include='*.gif' \
            --include='*.svg' \
            --include='*.webp' \
            --exclude='*' \
            ../hexo-site/ ./source/images/
          
          rsync -avP ../hexo-site/README.md source/about/index.md
          
          # 修复所有markdown文件中的相对链接
          # - 图片链接转换为/images/路径
          # - 文档链接转换为GitHub绝对链接
          python3 ./fix_relative_links.py
          pwd
          git status
          git add -A .
          find source -name '*.md'
          git commit -m "feat: bot auto commit"
          git push origin HEAD:bot -u -f
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-cache
          restore-keys: |
            ${{ runner.OS }}-npm-cache
      - name: Install Dependencies
        run: |
          set -aex
          pwd
          npm install
          npm install hexo-renderer-marked --save
          npm install hexo-filter-plantuml --save
          find source -name '*.md'
      - name: Build
        run: |
          set -aex
          pwd
          git branch
          find source -name '*.md'
          pwd
          npm run clean
          pwd
          npm run build
          ls -la
          tree public
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public